{"version":3,"file":"module.js","sources":["../src/utils/logger.ts","../src/core/StreamingPlayer.ts","../src/utils/time.ts","../src/utils/uuid.ts","../src/utils/audio-validation.ts","../src/core/effects/AudioEffect.ts","../src/core/effects/ReverbEffect.ts","../src/core/effects/DelayEffect.ts","../src/core/effects/FilterEffect.ts","../src/core/effects/CompressorEffect.ts","../src/core/effects/DistortionEffect.ts","../src/core/AudioEngine.ts","../src/core/PlayerAudioEngine.ts","../src/sync/SocketManager.ts","../src/ui/PlayerVolumePanel.ts","../src/ui/LocalLibraryApp.ts","../src/ui/SoundMixerApp.ts","../src/storage/GlobalStorage.ts","../src/ui/SoundEffectsApp.ts","../src/ui/AdvancedSoundEngineApp.ts","../src/utils/throttle.ts","../src/library/PlaylistManager.ts","../src/library/LibraryManager.ts","../src/queue/PlaybackQueueManager.ts","../src/core/PlaybackScheduler.ts","../src/main.ts"],"sourcesContent":["const PREFIX = 'ASE';\n\nexport const Logger = {\n  info: (message: string, ...args: unknown[]) => {\n    console.log(`${PREFIX} | ${message}`, ...args);\n  },\n  \n  warn: (message: string, ...args: unknown[]) => {\n    console.warn(`${PREFIX} | ${message}`, ...args);\n  },\n  \n  error: (message: string, ...args: unknown[]) => {\n    console.error(`${PREFIX} | ${message}`, ...args);\n  },\n  \n  debug: (message: string, ...args: unknown[]) => {\n    if (CONFIG?.debug?.audio) {\n      console.debug(`${PREFIX} | ${message}`, ...args);\n    }\n  }\n};","import type { TrackGroup, PlaybackState } from '@t/audio';\nimport { Logger } from '@utils/logger';\n\nexport class StreamingPlayer {\n  readonly id: string;\n  private ctx: AudioContext;\n  private _group: TrackGroup;\n  private _url: string = '';\n\n  private audio: HTMLAudioElement;\n  private sourceNode: MediaElementAudioSourceNode | null = null;\n  private gainNode: GainNode;\n  private outputNode: GainNode;\n\n  private _state: PlaybackState = 'stopped';\n  private _volume: number = 1;\n  private _ready: boolean = false;\n  private _stopRequested: boolean = false;\n\n  public onEnded?: () => void;\n\n  constructor(\n    id: string,\n    ctx: AudioContext,\n    channelOutput: GainNode,\n    group: TrackGroup = 'music'\n  ) {\n    this.id = id;\n    this.ctx = ctx;\n    this._group = group;\n\n    this.audio = new Audio();\n    this.audio.crossOrigin = 'anonymous';\n    this.audio.preload = 'auto';\n\n    this.gainNode = ctx.createGain();\n    this.outputNode = ctx.createGain();\n\n    this.gainNode.connect(this.outputNode);\n    this.outputNode.connect(channelOutput);\n\n    this.setupAudioEvents();\n  }\n\n  private setupAudioEvents(): void {\n    this.audio.addEventListener('canplay', () => {\n      this._ready = true;\n      if (this._state === 'loading') {\n        this._state = 'stopped';\n      }\n      Logger.debug(`Track ${this.id} ready to play`);\n    });\n\n    this.audio.addEventListener('ended', () => {\n      // PlaybackScheduler handles track progression based on playbackMode\n      this._state = 'stopped';\n      Logger.debug(`Track ${this.id} ended`);\n      this.onEnded?.();\n    });\n\n    this.audio.addEventListener('error', (e) => {\n      // Ignore errors if we are disposing (src cleared)\n      if (this.audio.getAttribute('src') === '' || !this.audio.src) return;\n\n      Logger.error(`Track ${this.id} error:`, this.audio.error);\n      this._state = 'stopped';\n    });\n  }\n\n  get state(): PlaybackState {\n    return this._state;\n  }\n\n  get group(): TrackGroup {\n    return this._group;\n  }\n\n  get url(): string {\n    return this._url;\n  }\n\n  get volume(): number {\n    return this._volume;\n  }\n\n  get ready(): boolean {\n    return this._ready;\n  }\n\n  async load(url: string): Promise<void> {\n    this._state = 'loading';\n    this._url = url;\n    this._ready = false;\n\n    return new Promise((resolve, reject) => {\n      const onCanPlay = () => {\n        this.audio.removeEventListener('canplay', onCanPlay);\n        this.audio.removeEventListener('error', onError);\n\n        // Connect to Web Audio\n        if (!this.sourceNode) {\n          this.sourceNode = this.ctx.createMediaElementSource(this.audio);\n          this.sourceNode.connect(this.gainNode);\n        }\n\n        this._ready = true;\n        this._state = 'stopped';\n        Logger.debug(`Track loaded: ${this.id}`);\n        resolve();\n      };\n\n      const onError = () => {\n        this.audio.removeEventListener('canplay', onCanPlay);\n        this.audio.removeEventListener('error', onError);\n        this._state = 'stopped';\n        reject(new Error(`Failed to load: ${url}`));\n      };\n\n      this.audio.addEventListener('canplay', onCanPlay, { once: true });\n      this.audio.addEventListener('error', onError, { once: true });\n\n      this.audio.src = url;\n      this.audio.load();\n    });\n  }\n\n  async play(offset: number = 0): Promise<void> {\n    if (!this._ready) {\n      Logger.warn(`Track ${this.id} not ready`);\n      return;\n    }\n\n    // Reset stop flag at the start of play\n    this._stopRequested = false;\n\n    try {\n      this.audio.currentTime = Math.max(0, Math.min(offset, this.audio.duration || 0));\n      // Loop is disabled - PlaybackScheduler handles progression\n      this.audio.loop = false;\n      await this.audio.play();\n\n      // Guard: if stop() was called during the async play(), don't overwrite state\n      if (this._stopRequested) {\n        Logger.debug(`Track ${this.id} play resolved but stop was requested — staying stopped`);\n        return;\n      }\n\n      this._state = 'playing';\n      Logger.debug(`Track ${this.id} playing from ${offset.toFixed(2)}s`);\n    } catch (error) {\n      // AbortError is expected when stop() interrupts play()\n      if ((error as DOMException)?.name === 'AbortError') {\n        Logger.debug(`Track ${this.id} play aborted (stop was called)`);\n        return;\n      }\n      Logger.error(`Failed to play ${this.id}:`, error);\n    }\n  }\n\n  pause(): void {\n    if (this._state !== 'playing') return;\n\n    this.audio.pause();\n    this._state = 'paused';\n    Logger.debug(`Track ${this.id} paused at ${this.audio.currentTime.toFixed(2)}s`);\n  }\n\n  stop(): void {\n    // Set flag BEFORE pause — prevents pending play() promise from overwriting state\n    this._stopRequested = true;\n    this.audio.pause();\n    this.audio.currentTime = 0;\n    this._state = 'stopped';\n    Logger.debug(`Track ${this.id} stopped`);\n  }\n\n  seek(time: number): void {\n    const safeTime = Math.max(0, Math.min(time, this.audio.duration || 0));\n    this.audio.currentTime = safeTime;\n  }\n\n  setVolume(value: number): void {\n    this._volume = Math.max(0, Math.min(1, value));\n    this.gainNode.gain.setValueAtTime(this._volume, this.ctx.currentTime);\n  }\n\n\n  setChannel(newGroup: TrackGroup, newOutput: GainNode): void {\n    this._group = newGroup;\n    this.outputNode.disconnect();\n    this.outputNode.connect(newOutput);\n  }\n\n  getCurrentTime(): number {\n    return this.audio.currentTime;\n  }\n\n  getDuration(): number {\n    return this.audio.duration || 0;\n  }\n\n  getState() {\n    return {\n      id: this.id,\n      url: this._url,\n      group: this._group,\n      playbackState: this._state,\n      volume: this._volume,\n      currentTime: this.getCurrentTime(),\n      duration: this.getDuration()\n    };\n  }\n\n  dispose(): void {\n    this._stopRequested = true;\n    this.audio.pause();\n    this.audio.src = '';\n    this.onEnded = undefined;\n    this.sourceNode?.disconnect();\n    this.gainNode.disconnect();\n    this.outputNode.disconnect();\n    Logger.debug(`Track ${this.id} disposed`);\n  }\n}","/**\n * Get current server time (for sync calculations).\n * Uses Date.now() since Foundry VTT's game.time.serverTime\n * represents world time in seconds, not real-time clock.\n * For audio sync, all participants use Date.now() and\n * compensate for network latency via startTimestamp.\n */\nexport function getServerTime(): number {\n  return Date.now();\n}\n\n/**\n * Calculate playback offset based on start time\n */\nexport function calculateOffset(startedAt: number, pausedAt: number = 0): number {\n  if (pausedAt > 0) {\n    return pausedAt;\n  }\n  return (getServerTime() - startedAt) / 1000;\n}\n\n/**\n * Format seconds to mm:ss\n */\nexport function formatTime(seconds: number): string {\n  if (!isFinite(seconds) || seconds < 0) return '0:00';\n  \n  const mins = Math.floor(seconds / 60);\n  const secs = Math.floor(seconds % 60);\n  return `${mins}:${secs.toString().padStart(2, '0')}`;\n}","/**\n * Generate a UUID v4\n * Based on RFC 4122 standard\n */\nexport function generateUUID(): string {\n  // Use crypto.randomUUID if available (modern browsers/Node 19+)\n  if (typeof crypto !== 'undefined' && crypto.randomUUID) {\n    return crypto.randomUUID();\n  }\n\n  // Fallback: manual UUID v4 generation\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {\n    const r = Math.random() * 16 | 0;\n    const v = c === 'x' ? r : (r & 0x3 | 0x8);\n    return v.toString(16);\n  });\n}\n\n/**\n * Validate UUID format\n */\nexport function isValidUUID(uuid: string): boolean {\n  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;\n  return uuidRegex.test(uuid);\n}\n","/**\n * Поддерживаемые аудио форматы\n */\nexport const SUPPORTED_AUDIO_FORMATS = [\n  '.mp3',\n  '.ogg',\n  '.wav',\n  '.webm',\n  '.m4a',\n  '.aac',\n  '.flac',\n  '.opus'\n] as const;\n\nexport type SupportedAudioFormat = typeof SUPPORTED_AUDIO_FORMATS[number];\n\n/**\n * MIME типы для поддерживаемых форматов\n */\nexport const AUDIO_MIME_TYPES: Record<string, string> = {\n  '.mp3': 'audio/mpeg',\n  '.ogg': 'audio/ogg',\n  '.wav': 'audio/wav',\n  '.webm': 'audio/webm',\n  '.m4a': 'audio/mp4',\n  '.aac': 'audio/aac',\n  '.flac': 'audio/flac',\n  '.opus': 'audio/opus'\n};\n\n/**\n * Проверка, является ли файл поддерживаемым аудио форматом\n */\nexport function isValidAudioFormat(url: string): boolean {\n  const extension = getFileExtension(url);\n  return SUPPORTED_AUDIO_FORMATS.includes(extension as SupportedAudioFormat);\n}\n\n/**\n * Получить расширение файла из URL\n */\nexport function getFileExtension(url: string): string {\n  try {\n    // Decode URL first\n    const decoded = decodeURIComponent(url);\n\n    // Remove query parameters and hash\n    const cleanUrl = decoded.split('?')[0].split('#')[0];\n\n    // Extract extension\n    const match = cleanUrl.match(/\\.([a-z0-9]+)$/i);\n    return match ? `.${match[1].toLowerCase()}` : '';\n  } catch {\n    return '';\n  }\n}\n\n/**\n * Получить MIME тип для аудио файла\n */\nexport function getAudioMimeType(url: string): string | null {\n  const extension = getFileExtension(url);\n  return AUDIO_MIME_TYPES[extension] || null;\n}\n\n/**\n * Валидация результата с деталями ошибки\n */\nexport interface AudioValidationResult {\n  valid: boolean;\n  error?: string;\n  extension?: string;\n  mimeType?: string;\n}\n\n/**\n * Полная валидация аудио файла\n */\nexport function validateAudioFile(url: string): AudioValidationResult {\n  if (!url || typeof url !== 'string') {\n    return {\n      valid: false,\n      error: 'URL is required and must be a string'\n    };\n  }\n\n  const extension = getFileExtension(url);\n\n  if (!extension) {\n    return {\n      valid: false,\n      error: 'Could not extract file extension from URL'\n    };\n  }\n\n  if (!isValidAudioFormat(url)) {\n    return {\n      valid: false,\n      error: `Unsupported audio format: ${extension}. Supported formats: ${SUPPORTED_AUDIO_FORMATS.join(', ')}`,\n      extension\n    };\n  }\n\n  const mimeType = getAudioMimeType(url);\n\n  return {\n    valid: true,\n    extension,\n    mimeType: mimeType || undefined\n  };\n}\n\n/**\n * Проверка поддержки формата браузером\n */\nexport function isBrowserAudioSupported(extension: string): boolean {\n  if (typeof Audio === 'undefined') {\n    return false;\n  }\n\n  const mimeType = AUDIO_MIME_TYPES[extension];\n  if (!mimeType) {\n    return false;\n  }\n\n  const audio = new Audio();\n  const canPlay = audio.canPlayType(mimeType);\n\n  // Returns: '' (no support), 'maybe', 'probably'\n  return canPlay === 'probably' || canPlay === 'maybe';\n}\n","import type { EffectState, EffectType, EffectParam } from '@t/effects';\nimport { generateUUID } from '@utils/uuid';\nimport { Logger } from '@utils/logger';\n\nexport abstract class AudioEffect {\n    public readonly id: string;\n    public readonly type: EffectType;\n    public enabled: boolean = false;\n\n    protected ctx: AudioContext;\n    public inputNode: GainNode;\n    public outputNode: GainNode;\n    protected wetNode: GainNode;\n    protected dryNode: GainNode;\n\n    protected params: Map<string, EffectParam> = new Map();\n\n    constructor(ctx: AudioContext, type: EffectType, id?: string) {\n        this.ctx = ctx;\n        this.type = type;\n        // CRITICAL FIX: Use type as ID by default instead of UUID for sync compatibility\n        this.id = id || type;\n\n        // Create nodes\n        this.inputNode = ctx.createGain();\n        this.outputNode = ctx.createGain();\n        this.wetNode = ctx.createGain();\n        this.dryNode = ctx.createGain();\n\n        // Default Routing:\n        // Input -> Split to Dry/Wet\n        // Dry -> Output\n        // Wet -> [Effect Processing] -> Output\n\n        this.inputNode.connect(this.dryNode);\n        this.dryNode.connect(this.outputNode);\n\n        // CRITICAL FIX: Connect wet to output (was missing!)\n        // Subclasses connect: inputNode -> [EffectNodes] -> wetNode\n        // Then we route: wetNode -> outputNode -> masterGain\n        this.wetNode.connect(this.outputNode);\n\n        // Add generic Output Level parameter\n        this.addParam({\n            id: 'level',\n            name: 'Output Level',\n            type: 'float',\n            value: 1.0,\n            defaultValue: 1.0,\n            min: 0,\n            max: 2.0,\n            step: 0.01,\n            suffix: ''\n        });\n\n        // Ensure enabled state is applied (sets wetNode gain to 1)\n        this.setEnabled(this.enabled);\n    }\n\n    /**\n     * Set a parameter value\n     */\n    public setParam(key: string, value: any): void {\n        const param = this.params.get(key);\n        if (!param) {\n            Logger.warn(`Effect ${this.type} has no parameter '${key}'`);\n            return;\n        }\n\n        Logger.debug(`Effect ${this.type} (${this.id}) setting ${key} to`, value);\n        param.value = value;\n\n        // Handle base parameters\n        if (key === 'level') {\n            this.outputNode.gain.setTargetAtTime(value as number, this.ctx.currentTime, 0.05);\n        } else {\n            this.applyParam(key, value);\n        }\n    }\n\n    /**\n     * Get current state\n     */\n    public getState(): EffectState {\n        const paramsObj: Record<string, any> = {};\n        for (const [key, param] of this.params) {\n            paramsObj[key] = param.value;\n        }\n\n        return {\n            id: this.id,\n            type: this.type,\n            enabled: this.enabled,\n            params: paramsObj,\n            routing: {\n                music: false,\n                ambience: false,\n                sfx: false\n            } // Routing is managed by AudioEngine, this is just a placeholder or could be updated by engine\n        };\n    }\n\n    /**\n     * Initialize parameters (called by subclass)\n     */\n    protected addParam(param: EffectParam): void {\n        this.params.set(param.id, param);\n    }\n\n    /**\n     * Apply parameter to internal audio nodes (implemented by subclass)\n     */\n    protected abstract applyParam(key: string, value: any): void;\n\n    /**\n     * Connect internal nodes (implemented by subclass)\n     * Should connect this.inputNode -> [Effect] -> this.wetNode\n     */\n    protected abstract buildGraph(): void;\n\n    /**\n     * Enable/Disable effect processing\n     */\n    public setEnabled(enabled: boolean): void {\n        this.enabled = enabled;\n        // When disabled, we might want to bypass processing to save CPU\n        // For now, we assume implicit bypass \n        if (enabled) {\n            this.wetNode.gain.setTargetAtTime(1, this.ctx.currentTime, 0.05);\n            // We might want to lower dry signal if it's an insert effect, \n            // but since we are using Send architecture, effects are usually 100% wet\n            // and we mix them in. \n            // WAIT! If we use Send architecture (Aux Send), the effect should output ONLY Wet signal.\n            // The Dry signal comes from the original channel.\n            this.dryNode.gain.value = 0;\n        } else {\n            // Disabled = Mute effect output\n            this.wetNode.gain.setTargetAtTime(0, this.ctx.currentTime, 0.05);\n            this.dryNode.gain.value = 0;\n        }\n    }\n\n    public setDryWet(mix: number) {\n        // only relevant if used as insert\n    }\n\n    public dispose(): void {\n        this.inputNode.disconnect();\n        this.outputNode.disconnect();\n        this.wetNode.disconnect();\n        this.dryNode.disconnect();\n    }\n}\n","import { AudioEffect } from './AudioEffect';\nimport { Logger } from '@utils/logger';\n\nexport class ReverbEffect extends AudioEffect {\n    private convolverNode: ConvolverNode;\n\n    constructor(ctx: AudioContext, id?: string) {\n        super(ctx, 'reverb', id);\n        this.convolverNode = ctx.createConvolver();\n        this.convolverNode.normalize = false; // Disable normalization to keep volume levels predictably high\n\n        this.addParam({\n            id: 'decay',\n            name: 'Decay Time',\n            type: 'float',\n            value: 2.0,\n            defaultValue: 2.0,\n            min: 0.1,\n            max: 10.0,\n            step: 0.1,\n            suffix: 's'\n        });\n\n        this.addParam({\n            id: 'size',\n            name: 'Room Size',\n            type: 'float',\n            value: 1.0,\n            defaultValue: 1.0,\n            min: 0.1,\n            max: 3.0,\n            step: 0.1,\n            suffix: 'x'\n        });\n\n        this.addParam({\n            id: 'tone',\n            name: 'Tone (Video)',\n            type: 'select',\n            value: 'default',\n            defaultValue: 'default',\n            options: [\n                { label: 'Standard', value: 'default' },\n                { label: 'Dark', value: 'dark' },\n                { label: 'Bright', value: 'bright' }\n            ]\n        });\n\n        this.buildGraph();\n        this.updateImpulse();\n    }\n\n    protected buildGraph(): void {\n        this.inputNode.connect(this.convolverNode);\n        this.convolverNode.connect(this.wetNode);\n    }\n\n    protected applyParam(key: string, value: any): void {\n        if (key === 'decay' || key === 'size' || key === 'tone') {\n            this.updateImpulse();\n        }\n    }\n\n    /**\n     * Re-generates global impulse based on current parameters\n     */\n    private updateImpulse(): void {\n        const decayTime = (this.params.get('decay')?.value as number) || 2.0;\n        const sizeMult = (this.params.get('size')?.value as number) || 1.0;\n        const tone = (this.params.get('tone')?.value as string) || 'default';\n\n        // Base duration = decay time * size multiplier (roughly)\n        const duration = decayTime * sizeMult;\n\n        // Tone affects the initial burst or the noise \"color\"\n        // For simple synthesis, we can affect how fast it decays initially vs late tail.\n        // Dark = faster high freq decay (simulated by decay curve power)\n        let decayCurvePower = 2.0;\n        if (tone === 'dark') decayCurvePower = 3.0; // Decay faster (perceptually)\n        if (tone === 'bright') decayCurvePower = 1.5; // Sustain noise longer\n\n        this.generateSimpleImpulse(duration, decayCurvePower);\n    }\n\n    /**\n     * Generates a simple synthetic impulse response (white noise with exponential decay)\n     */\n    private generateSimpleImpulse(duration: number, decayPower: number): void {\n        // Safety clamps\n        if (duration <= 0.01) duration = 0.01;\n\n        const rate = this.ctx.sampleRate;\n        const length = Math.floor(rate * duration);\n        const impulse = this.ctx.createBuffer(2, length, rate);\n        const left = impulse.getChannelData(0);\n        const right = impulse.getChannelData(1);\n\n        for (let i = 0; i < length; i++) {\n            const n = i / length;\n            // Exponential decay\n            const gain = Math.pow(1 - n, decayPower);\n\n            // SIGNIFICANTLY reduce gain to prevent volume boosting.\n            // A long reverb impulse sums up to a lot of energy.\n            // 0.05 seems conservative but safe for \"adding\" ambience without overpowering dry.\n            const volumeScale = 0.05;\n\n            left[i] = (Math.random() * 2 - 1) * gain * volumeScale;\n            right[i] = (Math.random() * 2 - 1) * gain * volumeScale;\n        }\n\n        this.convolverNode.buffer = impulse;\n    }\n}\n","import { AudioEffect } from './AudioEffect';\nimport { Logger } from '@utils/logger';\n\nexport class DelayEffect extends AudioEffect {\n    private delayNode: DelayNode;\n    private feedbackNode: GainNode;\n\n    constructor(ctx: AudioContext, id?: string) {\n        super(ctx, 'delay', id);\n        this.delayNode = ctx.createDelay(5.0); // Max delay 5s\n        this.feedbackNode = ctx.createGain();\n\n        this.addParam({\n            id: 'time',\n            name: 'Time',\n            type: 'float',\n            value: 0.3,\n            defaultValue: 0.3,\n            min: 0,\n            max: 2.0,\n            step: 0.01,\n            suffix: 's'\n        });\n\n        this.addParam({\n            id: 'feedback',\n            name: 'Feedback',\n            type: 'float',\n            value: 0.4,\n            defaultValue: 0.4,\n            min: 0,\n            max: 0.9,\n            step: 0.01,\n            suffix: ''\n        });\n\n        this.buildGraph();\n        this.applyParam('time', 0.3);\n        this.applyParam('feedback', 0.4);\n    }\n\n    protected buildGraph(): void {\n        // Input -> Delay -> Output\n        //      |-> Feedback -> Delay\n\n        // Connect Input to Delay\n        this.inputNode.connect(this.delayNode);\n\n        // Connect Delay to Wet Output\n        this.delayNode.connect(this.wetNode);\n\n        // Feedback Loop: Delay -> Feedback -> Delay\n        this.delayNode.connect(this.feedbackNode);\n        this.feedbackNode.connect(this.delayNode);\n    }\n\n    protected applyParam(key: string, value: any): void {\n        switch (key) {\n            case 'time':\n                this.delayNode.delayTime.setTargetAtTime(value as number, this.ctx.currentTime, 0.05);\n                break;\n            case 'feedback':\n                this.feedbackNode.gain.setTargetAtTime(value as number, this.ctx.currentTime, 0.05);\n                break;\n        }\n    }\n}\n","import { AudioEffect } from './AudioEffect';\n\nexport class FilterEffect extends AudioEffect {\n    private filterNode: BiquadFilterNode;\n\n    constructor(ctx: AudioContext, id?: string) {\n        super(ctx, 'filter', id);\n        this.filterNode = ctx.createBiquadFilter();\n\n        this.addParam({\n            id: 'type',\n            name: 'Type',\n            type: 'select',\n            value: 'lowpass',\n            defaultValue: 'lowpass',\n            options: [\n                { label: 'Lowpass', value: 'lowpass' },\n                { label: 'Highpass', value: 'highpass' },\n                { label: 'Bandpass', value: 'bandpass' },\n                { label: 'Peaking', value: 'peaking' }\n            ]\n        });\n\n        this.addParam({\n            id: 'frequency',\n            name: 'Frequency',\n            type: 'float',\n            value: 1000,\n            defaultValue: 1000,\n            min: 20,\n            max: 20000,\n            step: 10,\n            suffix: 'Hz'\n        });\n\n        this.addParam({\n            id: 'Q',\n            name: 'Resonance',\n            type: 'float',\n            value: 1,\n            defaultValue: 1,\n            min: 0.1,\n            max: 10,\n            step: 0.1,\n            suffix: ''\n        });\n\n        this.buildGraph();\n        this.applyParam('type', 'lowpass');\n        this.applyParam('frequency', 1000);\n    }\n\n    protected buildGraph(): void {\n        this.inputNode.connect(this.filterNode);\n        this.filterNode.connect(this.wetNode);\n    }\n\n    protected applyParam(key: string, value: any): void {\n        switch (key) {\n            case 'type':\n                this.filterNode.type = value as BiquadFilterType;\n                break;\n            case 'frequency':\n                this.filterNode.frequency.setTargetAtTime(value as number, this.ctx.currentTime, 0.05);\n                break;\n            case 'Q':\n                this.filterNode.Q.setTargetAtTime(value as number, this.ctx.currentTime, 0.05);\n                break;\n        }\n    }\n}\n","import { AudioEffect } from './AudioEffect';\n\nexport class CompressorEffect extends AudioEffect {\n    private compressorNode: DynamicsCompressorNode;\n    private makeupNode: GainNode;\n\n    constructor(ctx: AudioContext, id?: string) {\n        super(ctx, 'compressor', id);\n        this.compressorNode = ctx.createDynamicsCompressor();\n        this.makeupNode = ctx.createGain();\n\n        this.addParam({\n            id: 'threshold',\n            name: 'Threshold',\n            type: 'float',\n            value: -24,\n            defaultValue: -24,\n            min: -100,\n            max: 0,\n            step: 1,\n            suffix: 'dB'\n        });\n\n        this.addParam({\n            id: 'ratio',\n            name: 'Ratio',\n            type: 'float',\n            value: 12,\n            defaultValue: 12,\n            min: 1,\n            max: 20,\n            step: 0.5,\n            suffix: ''\n        });\n\n        this.buildGraph();\n        this.applyParam('threshold', -24);\n        this.applyParam('ratio', 12);\n    }\n\n    protected buildGraph(): void {\n        this.inputNode.connect(this.compressorNode);\n        this.compressorNode.connect(this.makeupNode);\n        this.makeupNode.connect(this.wetNode);\n    }\n\n    protected applyParam(key: string, value: any): void {\n        switch (key) {\n            case 'threshold':\n                this.compressorNode.threshold.setTargetAtTime(value as number, this.ctx.currentTime, 0.05);\n                this.updateMakeupGain();\n                break;\n            case 'ratio':\n                this.compressorNode.ratio.setTargetAtTime(value as number, this.ctx.currentTime, 0.05);\n                this.updateMakeupGain();\n                break;\n        }\n    }\n\n    private updateMakeupGain(): void {\n        // Simple auto-makeup gain logic\n        // Approximate gain reduction compensation\n        const threshold = this.compressorNode.threshold.value;\n        const ratio = this.compressorNode.ratio.value;\n\n        // If threshold is 0, no compression, gain should be 1.\n        // As threshold drops, we expect volume loss.\n        // We compensate roughly half of the potential reduction to be safe.\n        // Formula: Gain(dB) = -Threshold * 0.6 (tuned by ear usually)\n\n        let makeupDb = 0;\n        if (threshold < 0) {\n            makeupDb = -threshold * 0.5;\n        }\n\n        // Convert dB to linear gain: 10^(dB/20)\n        const makeupGain = Math.pow(10, makeupDb / 20);\n\n        this.makeupNode.gain.setTargetAtTime(makeupGain, this.ctx.currentTime, 0.05);\n    }\n}\n","import { AudioEffect } from './AudioEffect';\n\nexport class DistortionEffect extends AudioEffect {\n    private shaperNode: WaveShaperNode;\n    private preGain: GainNode;\n\n    constructor(ctx: AudioContext, id?: string) {\n        super(ctx, 'distortion', id);\n        this.shaperNode = ctx.createWaveShaper();\n        this.shaperNode.oversample = '4x';\n        this.preGain = ctx.createGain();\n\n        this.addParam({\n            id: 'drive',\n            name: 'Drive',\n            type: 'float',\n            value: 0,\n            defaultValue: 0,\n            min: 0,\n            max: 100,\n            step: 1,\n            suffix: '%'\n        });\n\n        this.buildGraph();\n        this.updateCurve(0);\n    }\n\n    protected buildGraph(): void {\n        // Input -> PreGain (Drive) -> WaveShaper -> WetNode\n        this.inputNode.connect(this.preGain);\n        this.preGain.connect(this.shaperNode);\n        this.shaperNode.connect(this.wetNode);\n    }\n\n    protected applyParam(key: string, value: any): void {\n        if (key === 'drive') {\n            const driveAmount = value as number;\n            this.updateCurve(driveAmount);\n\n            // Apply input gain (pre-drive)\n            // 0% -> 1.0 (0dB)\n            // 100% -> 20.0 (+26dB) - significant boost to force clipping\n            // Using exponential curve for more natural feel\n            const gain = 1 + (driveAmount / 5);\n            this.preGain.gain.setTargetAtTime(gain, this.ctx.currentTime, 0.05);\n        }\n    }\n\n    private updateCurve(amount: number): void {\n        const k = amount; // 0-100\n\n        if (k === 0) {\n            this.shaperNode.curve = null;\n            return;\n        }\n\n        const n_samples = 44100;\n        const curve = new Float32Array(n_samples);\n        const deg = Math.PI / 180;\n\n        // Improved output compensation - as we drive harder, we might want to normalize the curve\n        // slightly differently, but standard waveshaping usually stays within -1..1 range on Y axis.\n\n        for (let i = 0; i < n_samples; ++i) {\n            const x = (i * 2) / n_samples - 1;\n\n            // Sigmoid function: (1+k)*x / (1+k*|x|)\n            // k needs to be scaled up to make the curve sharper\n            // 0-100 is linear, let's map it to 0-1000 for the formula\n            const k_scaled = k * 2;\n\n            // Standard soft-clipping formula\n            curve[i] = ((k_scaled + 20) * x) / (20 + k_scaled * Math.abs(x));\n        }\n\n        this.shaperNode.curve = curve;\n    }\n}\n","import type { TrackConfig, TrackState, MixerState, TrackGroup, ChannelVolumes } from '@t/audio';\nimport type { EffectState, EffectType, EffectParam } from '@t/effects';\nimport { StreamingPlayer } from './StreamingPlayer';\nimport { Logger } from '@utils/logger';\nimport { getServerTime } from '@utils/time';\nimport { generateUUID } from '@utils/uuid';\nimport { validateAudioFile } from '@utils/audio-validation';\n// import { EventEmitter } from '@pixi/utils'; // REMOVED: Using global PIXI.utils.EventEmitter to fix build\nimport type { PlaybackContext } from './PlaybackScheduler';\nimport type { PlaybackScheduler } from './PlaybackScheduler';\nimport type { SocketManager } from '../sync/SocketManager';\n\n// Effects\nimport { AudioEffect } from './effects/AudioEffect';\nimport { ReverbEffect } from './effects/ReverbEffect';\nimport { DelayEffect } from './effects/DelayEffect';\nimport { FilterEffect } from './effects/FilterEffect';\nimport { CompressorEffect } from './effects/CompressorEffect';\nimport { DistortionEffect } from './effects/DistortionEffect';\n\nconst MODULE_ID = 'advanced-sound-engine';\n\nfunction getMaxSimultaneous(): number {\n  return ((game.settings as any).get(MODULE_ID, 'maxSimultaneousTracks') as number) || 8;\n}\n\n// Robust EventEmitter shim to avoid build/runtime dependency issues\nclass SimpleEventEmitter {\n  private listeners: Record<string, Function[]> = {};\n\n  on(event: string, fn: Function) {\n    (this.listeners[event] = this.listeners[event] || []).push(fn);\n    return this;\n  }\n\n  addListener(event: string, fn: Function) {\n    return this.on(event, fn);\n  }\n\n  once(event: string, fn: Function) {\n    const onceWrapper = (...args: any[]) => {\n      this.off(event, onceWrapper);\n      fn.apply(this, args);\n    };\n    // Store original fn to allow removal before triggering\n    (onceWrapper as any)._original = fn;\n    return this.on(event, onceWrapper);\n  }\n\n  emit(event: string, ...args: any[]) {\n    if (this.listeners[event]) {\n      // Clone to allow removal during emission\n      [...this.listeners[event]].forEach(fn => fn.apply(this, args));\n      return true;\n    }\n    return false;\n  }\n\n  off(event: string, fn: Function) {\n    if (this.listeners[event]) {\n      this.listeners[event] = this.listeners[event].filter(l =>\n        l !== fn && (l as any)._original !== fn\n      );\n    }\n    return this;\n  }\n\n  removeListener(event: string, fn: Function) {\n    return this.off(event, fn);\n  }\n\n  removeAllListeners(event?: string) {\n    if (event) {\n      delete this.listeners[event];\n    } else {\n      this.listeners = {};\n    }\n    return this;\n  }\n}\n\nexport class AudioEngine extends SimpleEventEmitter {\n  private ctx: AudioContext;\n  private masterGain: GainNode;\n  private localGain: GainNode; // Controls GM's local monitoring level\n  private channelGains: Record<TrackGroup, GainNode>;\n  private players: Map<string, StreamingPlayer> = new Map();\n  private _activeContext: PlaybackContext | null = null;\n  private _scheduler: PlaybackScheduler | null = null;\n  private _socketManager: SocketManager | null = null;\n\n  // Effects System\n  private effects: Map<string, AudioEffect> = new Map();\n  // Sends: Channel -> EffectId -> GainNode\n  private sends: Record<TrackGroup, Map<string, GainNode>> = {\n    music: new Map(),\n    ambience: new Map(),\n    sfx: new Map()\n  };\n  // Direct Gains: Channel -> Master (Control dry level)\n  private directGains: Record<TrackGroup, GainNode>;\n\n  private _volumes: ChannelVolumes = {\n    master: 1,\n    music: 1,\n    ambience: 1,\n    sfx: 1\n  };\n\n  private saveTimeout: ReturnType<typeof setTimeout> | null = null;\n\n  constructor() {\n    super(); // Init EventEmitter\n    this.ctx = new AudioContext();\n\n    this.masterGain = this.ctx.createGain();\n\n    // Create Local Gain (GM only)\n    this.localGain = this.ctx.createGain();\n    this.localGain.gain.value = 1; // Default to full volume\n\n    // Master -> Local -> Destination\n    this.masterGain.connect(this.localGain);\n    this.localGain.connect(this.ctx.destination);\n\n    this.channelGains = {\n      music: this.ctx.createGain(),\n      ambience: this.ctx.createGain(),\n      sfx: this.ctx.createGain()\n    };\n\n    // Initialize Direct Gains\n    this.directGains = {\n      music: this.ctx.createGain(),\n      ambience: this.ctx.createGain(),\n      sfx: this.ctx.createGain()\n    };\n\n    // Connect Channel -> DirectGain -> Master\n    // This replaces the direct connection so we can duck the dry signal\n    this.channelGains.music.connect(this.directGains.music);\n    this.directGains.music.connect(this.masterGain);\n\n    this.channelGains.ambience.connect(this.directGains.ambience);\n    this.directGains.ambience.connect(this.masterGain);\n\n    this.channelGains.sfx.connect(this.directGains.sfx);\n    this.directGains.sfx.connect(this.masterGain);\n\n    this.initializeEffects();\n\n    Logger.info('AudioEngine initialized');\n  }\n\n  private initializeEffects(): void {\n    // Create one instance of each effect\n    const effectClasses = [\n      ReverbEffect,\n      FilterEffect,\n      DelayEffect,\n      CompressorEffect,\n      DistortionEffect\n    ];\n\n    effectClasses.forEach(EffectClass => {\n      const effect = new EffectClass(this.ctx);\n      // CRITICAL FIX: Use effect type as ID instead of UUID for sync compatibility with PlayerAudioEngine\n      const effectId = effect.type; // 'reverb', 'delay', 'filter', etc.\n      this.effects.set(effectId, effect);\n\n      // Connect Effect Output to Master Gain\n      effect.outputNode.connect(this.masterGain);\n\n      // Create Send Gains for each channel\n      (['music', 'ambience', 'sfx'] as TrackGroup[]).forEach(group => {\n        const sendGain = this.ctx.createGain();\n        sendGain.gain.value = 0; // Default off\n\n        // Connect Channel -> SendGain -> Effect Input\n        this.channelGains[group].connect(sendGain);\n        sendGain.connect(effect.inputNode);\n\n        this.sends[group].set(effectId, sendGain);\n      });\n    });\n  }\n\n  /**\n   * Wire up references after construction to avoid circular dependencies.\n   * Called from main.ts after all managers are created.\n   */\n  setScheduler(scheduler: PlaybackScheduler): void {\n    this._scheduler = scheduler;\n  }\n\n  setSocketManager(socketManager: SocketManager): void {\n    this._socketManager = socketManager;\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Persistence (GM only)\n  // ─────────────────────────────────────────────────────────────\n\n  private scheduleSave(): void {\n    if (!game.user?.isGM) return;\n\n    if (this.saveTimeout) {\n      clearTimeout(this.saveTimeout);\n    }\n    this.saveTimeout = setTimeout(() => {\n      this.saveState();\n    }, 500);\n  }\n\n  private async saveState(): Promise<void> {\n    if (!game.ready || !game.user?.isGM) return;\n\n    const state = this.getState();\n\n    try {\n      await (game.settings as any).set(MODULE_ID, 'mixerState', JSON.stringify(state));\n      Logger.debug('Mixer state saved');\n    } catch (error) {\n      Logger.error('Failed to save mixer state:', error);\n    }\n  }\n\n  async loadSavedState(): Promise<void> {\n    if (!game.ready) return;\n\n    try {\n      const savedJson = (game.settings as any).get(MODULE_ID, 'mixerState') as string;\n      if (!savedJson) return;\n\n      const state = JSON.parse(savedJson) as MixerState;\n      await this.restoreState(state);\n\n      Logger.info('Mixer state restored');\n    } catch (error) {\n      Logger.error('Failed to load mixer state:', error);\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Track Management\n  // ─────────────────────────────────────────────────────────────\n\n  async createTrack(config: TrackConfig): Promise<StreamingPlayer> {\n    // Generate UUID if not provided\n    const trackId = config.id || generateUUID();\n\n    if (this.players.has(trackId)) {\n      return this.players.get(trackId)!;\n    }\n\n    // Validate audio file format\n    const validation = validateAudioFile(config.url);\n    if (!validation.valid) {\n      const error = new Error(validation.error || 'Invalid audio file');\n      Logger.error(`Track validation failed: ${validation.error}`);\n      throw error;\n    }\n\n    const channelOutput = this.channelGains[config.group];\n\n    const player = new StreamingPlayer(\n      trackId,\n      this.ctx,\n      channelOutput,\n      config.group\n    );\n\n    if (config.volume !== undefined) {\n      player.setVolume(config.volume);\n    }\n\n    await player.load(config.url);\n\n    this.players.set(trackId, player);\n\n    // Wire up events\n    player.onEnded = () => {\n      this.emit('trackEnded', trackId);\n      // Also remove from active players map if needed, but StreamingPlayer handles state.\n    };\n\n    this.scheduleSave();\n\n    Logger.info(`Track created: ${trackId} (${validation.extension})`);\n    return player;\n  }\n\n  getTrack(id: string): StreamingPlayer | undefined {\n    return this.players.get(id);\n  }\n\n  removeTrack(id: string): boolean {\n    const player = this.players.get(id);\n    if (!player) return false;\n\n    player.dispose();\n    this.players.delete(id);\n    this.scheduleSave();\n\n    Logger.info(`Track removed: ${id}`);\n    return true;\n  }\n\n  getAllTracks(): StreamingPlayer[] {\n    return Array.from(this.players.values());\n  }\n\n  getTracksByGroup(group: TrackGroup): StreamingPlayer[] {\n    return this.getAllTracks().filter(t => t.group === group);\n  }\n\n  setTrackChannel(id: string, newGroup: TrackGroup): void {\n    const player = this.players.get(id);\n    if (!player) return;\n\n    player.setChannel(newGroup, this.channelGains[newGroup]);\n    this.scheduleSave();\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Playback Control\n  // ─────────────────────────────────────────────────────────────\n\n  async playTrack(id: string, offset: number = 0, context?: PlaybackContext): Promise<void> {\n    const player = this.players.get(id);\n    if (!player) {\n      Logger.warn(`Track not found: ${id}`);\n      return;\n    }\n\n    const maxSimultaneous = getMaxSimultaneous();\n    const playingCount = this.getAllTracks().filter(t => t.state === 'playing').length;\n    const isCurrentlyPlaying = player.state === 'playing';\n\n    if (!isCurrentlyPlaying && playingCount >= maxSimultaneous) {\n      Logger.warn(`Maximum simultaneous tracks (${maxSimultaneous}) reached`);\n      ui.notifications?.warn(`Cannot play more than ${maxSimultaneous} tracks simultaneously`);\n      return;\n    }\n\n    if (context) {\n      this._activeContext = context;\n      this.emit('contextChanged', context);\n    }\n    await player.play(offset);\n  }\n\n  pauseTrack(id: string): void {\n    this.players.get(id)?.pause();\n  }\n\n  stopTrack(id: string): void {\n    this.players.get(id)?.stop();\n  }\n\n  seekTrack(id: string, time: number): void {\n    this.players.get(id)?.seek(time);\n  }\n\n  setTrackVolume(id: string, volume: number): void {\n    this.players.get(id)?.setVolume(volume);\n    this.scheduleSave();\n  }\n\n\n  stopAll(): void {\n    // 1. Clear scheduler context FIRST to prevent race conditions\n    //    where a late 'ended' event triggers the next track\n    this._scheduler?.clearContext();\n    this._activeContext = null;\n\n    // 2. Stop all local players\n    for (const player of this.players.values()) {\n      player.stop();\n    }\n\n    // 3. Broadcast to players — ALWAYS, regardless of syncEnabled.\n    //    Players must receive stop-all even if sync was just toggled off.\n    this._socketManager?.broadcastStopAll();\n\n    // 4. Persist state\n    this.scheduleSave();\n\n    Logger.info('All tracks stopped');\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Volume Control\n  // ─────────────────────────────────────────────────────────────\n\n  get volumes(): ChannelVolumes {\n    return { ...this._volumes };\n  }\n\n  setMasterVolume(value: number): void {\n    this._volumes.master = Math.max(0, Math.min(1, value));\n    this.masterGain.gain.linearRampToValueAtTime(\n      this._volumes.master,\n      this.ctx.currentTime + 0.01\n    );\n    this.scheduleSave();\n  }\n\n  setChannelVolume(channel: TrackGroup, value: number): void {\n    this._volumes[channel] = Math.max(0, Math.min(1, value));\n    this.channelGains[channel].gain.linearRampToValueAtTime(\n      this._volumes[channel],\n      this.ctx.currentTime + 0.01\n    );\n    this.scheduleSave();\n  }\n\n  getChannelVolume(channel: TrackGroup): number {\n    return this._volumes[channel];\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Local Volume (GM Monitor)\n  // ─────────────────────────────────────────────────────────────\n\n  setLocalVolume(value: number): void {\n    const val = Math.max(0, Math.min(1, value));\n    this.localGain.gain.linearRampToValueAtTime(val, this.ctx.currentTime + 0.05);\n  }\n\n  get localVolume(): number {\n    return this.localGain.gain.value;\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Effects Management\n  // ─────────────────────────────────────────────────────────────\n\n  getAllEffects(): AudioEffect[] {\n    return Array.from(this.effects.values());\n  }\n\n  setEffectParam(effectId: string, paramId: string, value: any): void {\n    const effect = this.effects.get(effectId);\n    if (!effect) return;\n\n    effect.setParam(paramId, value);\n    this.scheduleSave();\n  }\n\n  setEffectEnabled(effectId: string, enabled: boolean): void {\n    const effect = this.effects.get(effectId);\n    if (!effect) {\n      console.warn('[ASE GM] setEffectEnabled: Effect not found:', effectId);\n      return;\n    }\n\n    console.log('[ASE GM] setEffectEnabled:', effectId, enabled, 'effect.enabled before:', effect.enabled);\n    effect.setEnabled(enabled);\n    console.log('[ASE GM] effect.enabled after:', effect.enabled);\n    this.scheduleSave();\n\n    // Update dry levels for all channels that use this effect\n    (['music', 'ambience', 'sfx'] as TrackGroup[]).forEach(group => {\n      this.updateDryLevel(group);\n    });\n  }\n\n  /**\n   * Toggle routing from a channel to an effect\n   */\n  setEffectRouting(effectId: string, channel: TrackGroup, enabled: boolean): void {\n    const channelSends = this.sends[channel];\n    const sendNode = channelSends.get(effectId);\n\n    console.log('[ASE GM] setEffectRouting:', effectId, channel, enabled, 'sendNode exists:', !!sendNode);\n    if (sendNode) {\n      console.log('[ASE GM] Setting send gain from', sendNode.gain.value, 'to', enabled ? 1 : 0);\n      // Smooth transition\n      sendNode.gain.setTargetAtTime(enabled ? 1 : 0, this.ctx.currentTime, 0.05);\n      this.scheduleSave();\n\n      // Update dry level for this channel\n      this.updateDryLevel(channel);\n    } else {\n      console.warn('[ASE GM] Send node not found for:', effectId, channel);\n    }\n  }\n\n  /**\n   * Checks active effects for the channel and adjusts direct (dry) gain.\n   * If an INSERT effect (Filter, Distortion, Compressor) is active + routed, \n   * we duck the dry signal to 0.\n   */\n  private updateDryLevel(channel: TrackGroup): void {\n    let isInsertActive = false;\n    const insertTypes: EffectType[] = ['filter', 'distortion', 'compressor'];\n\n    for (const effect of this.effects.values()) {\n      // Check if effect is enabled globally\n      if (!effect.enabled) continue;\n\n      // Check if routed to this channel\n      const sendNode = this.sends[channel].get(effect.id);\n      const isRouted = (sendNode?.gain.value || 0) > 0.5; // Threshold check\n\n      if (isRouted && insertTypes.includes(effect.type)) {\n        isInsertActive = true;\n        break; // Found one, that's enough to mute dry\n      }\n    }\n\n    // If Insert is active, Dry = 0. Else Dry = 1.\n    const targetGain = isInsertActive ? 0 : 1;\n\n    // Smooth transition to avoid clicks\n    this.directGains[channel].gain.setTargetAtTime(targetGain, this.ctx.currentTime, 0.1);\n\n    Logger.debug(`Channel ${channel} dry level set to ${targetGain} (Insert Active: ${isInsertActive})`);\n  }\n\n  getEffectState(effectId: string): EffectState | undefined {\n    const effect = this.effects.get(effectId);\n    if (!effect) return undefined;\n\n    const state = effect.getState();\n\n    // Inject current routing state\n    (['music', 'ambience', 'sfx'] as TrackGroup[]).forEach(group => {\n      const sendGain = this.sends[group].get(effectId);\n      // We consider it enabled if gain > 0.1\n      state.routing[group] = (sendGain?.gain.value || 0) > 0.1;\n    });\n\n    return state;\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // State\n  // ─────────────────────────────────────────────────────────────\n\n  getState(): MixerState {\n    const tracks: TrackState[] = [];\n\n    for (const player of this.players.values()) {\n      tracks.push(player.getState());\n    }\n\n    return {\n      masterVolume: this._volumes.master,\n      channelVolumes: { ...this._volumes },\n      tracks,\n      effects: this.getAllEffects().map(e => this.getEffectState(e.type)!),\n      timestamp: getServerTime(),\n      syncEnabled: false\n    };\n  }\n\n  async restoreState(state: MixerState): Promise<void> {\n    // Restore volumes\n    this._volumes.master = state.masterVolume;\n    this.masterGain.gain.setValueAtTime(this._volumes.master, this.ctx.currentTime);\n\n    if (state.channelVolumes) {\n      for (const channel of ['music', 'ambience', 'sfx'] as TrackGroup[]) {\n        this._volumes[channel] = state.channelVolumes[channel];\n        this.channelGains[channel].gain.setValueAtTime(this._volumes[channel], this.ctx.currentTime);\n      }\n    }\n\n    // Restore Effects\n    if (state.effects) {\n      for (const fxState of state.effects) {\n        // Find by Type since IDs might be regenerated on reload if not persistent?\n        // Actually, IDs are persistent in state. But we initialized new effects with random IDs in constructor.\n        // We need to match by TYPE because we have exactly 1 of each type.\n\n        const effect = Array.from(this.effects.values()).find(e => e.type === fxState.type);\n        if (effect) {\n          // Restore Params\n          for (const [key, value] of Object.entries(fxState.params)) {\n            effect.setParam(key, value);\n          }\n\n          // Restore Routing\n          for (const [group, enabled] of Object.entries(fxState.routing)) {\n            this.setEffectRouting(effect.id, group as TrackGroup, enabled as boolean);\n          }\n        }\n      }\n    }\n\n    // Restore tracks (without playing)\n    for (const trackState of state.tracks) {\n      if (!this.players.has(trackState.id)) {\n        try {\n          await this.createTrack({\n            id: trackState.id,\n            url: trackState.url,\n            group: trackState.group,\n            volume: trackState.volume\n          });\n        } catch (error) {\n          Logger.error(`Failed to restore track ${trackState.id}:`, error);\n        }\n      }\n    }\n\n    // Remove tracks not in state\n    const stateTrackIds = new Set(state.tracks.map(t => t.id));\n    for (const [id] of this.players) {\n      if (!stateTrackIds.has(id)) {\n        this.removeTrack(id);\n      }\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Audio Context\n  // ─────────────────────────────────────────────────────────────\n\n  async resume(): Promise<void> {\n    if (this.ctx.state === 'suspended') {\n      await this.ctx.resume();\n      Logger.info('AudioContext resumed');\n    }\n  }\n\n  get contextState(): AudioContextState {\n    return this.ctx.state;\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Cleanup\n  // ─────────────────────────────────────────────────────────────\n\n  dispose(): void {\n    if (this.saveTimeout) {\n      clearTimeout(this.saveTimeout);\n    }\n    for (const player of this.players.values()) {\n      player.dispose();\n    }\n    this.players.clear();\n\n    for (const effect of this.effects.values()) {\n      effect.dispose();\n    }\n    this.effects.clear();\n\n    this.ctx.close();\n    Logger.info('AudioEngine disposed');\n  }\n}","import type { TrackGroup, ChannelVolumes, SyncTrackState, TrackPlayPayload } from '@t/audio';\nimport type { EffectState, EffectType, EffectParam } from '@t/effects';\nimport { StreamingPlayer } from './StreamingPlayer';\nimport { Logger } from '@utils/logger';\nimport { getServerTime } from '@utils/time';\n\n// Effects\nimport { AudioEffect } from './effects/AudioEffect';\nimport { ReverbEffect } from './effects/ReverbEffect';\nimport { DelayEffect } from './effects/DelayEffect';\nimport { FilterEffect } from './effects/FilterEffect';\nimport { CompressorEffect } from './effects/CompressorEffect';\nimport { DistortionEffect } from './effects/DistortionEffect';\n\n/**\n * Упрощенный движок для игроков — только получает команды\n */\nexport class PlayerAudioEngine {\n  private ctx: AudioContext;\n  private masterGain: GainNode;\n  private gmGain: GainNode; // Громкость от GM\n  private channelGains: Record<TrackGroup, GainNode>;\n  private players: Map<string, StreamingPlayer> = new Map();\n\n  // Effects System\n  private effects: Map<string, AudioEffect> = new Map();\n  // Sends: Channel -> EffectId -> GainNode\n  private sends: Record<TrackGroup, Map<string, GainNode>> = {\n    music: new Map(),\n    ambience: new Map(),\n    sfx: new Map()\n  };\n  // Direct Gains: Channel -> Master (Control dry level)\n  private directGains: Record<TrackGroup, GainNode>;\n\n  private _localVolume: number = 1; // Личная громкость игрока\n  private _gmVolumes: ChannelVolumes = {\n    master: 1,\n    music: 1,\n    ambience: 1,\n    sfx: 1\n  };\n\n  // Periodic sync verification\n  private lastSyncState: SyncTrackState[] = [];\n  private syncCheckInterval: number | null = null;\n  private socketManager: any; // Reference to SocketManager for requesting sync\n  private lastSyncRequestTime: number = 0;\n  private readonly SYNC_REQUEST_COOLDOWN = 10000; // 10 seconds\n  private syncRequestFailCount: number = 0;\n  private readonly MAX_SYNC_RETRIES = 3;\n\n  constructor(socketManager?: any) {\n    this.ctx = new AudioContext();\n    this.socketManager = socketManager;\n\n    // Start periodic sync verification (5 seconds)\n    this.startSyncVerification();\n\n    // Chain: tracks -> channels -> [direct/sends] -> gmGain -> masterGain -> destination\n    this.masterGain = this.ctx.createGain();\n    this.masterGain.connect(this.ctx.destination);\n\n    this.gmGain = this.ctx.createGain();\n    this.gmGain.connect(this.masterGain);\n\n    this.channelGains = {\n      music: this.ctx.createGain(),\n      ambience: this.ctx.createGain(),\n      sfx: this.ctx.createGain()\n    };\n\n    // Initialize Direct Gains\n    this.directGains = {\n      music: this.ctx.createGain(),\n      ambience: this.ctx.createGain(),\n      sfx: this.ctx.createGain()\n    };\n\n    // Connect Channel -> DirectGain -> GMGain\n    this.channelGains.music.connect(this.directGains.music);\n    this.directGains.music.connect(this.gmGain);\n\n    this.channelGains.ambience.connect(this.directGains.ambience);\n    this.directGains.ambience.connect(this.gmGain);\n\n    this.channelGains.sfx.connect(this.directGains.sfx);\n    this.directGains.sfx.connect(this.gmGain);\n\n    this.initializeEffects();\n\n    Logger.info('PlayerAudioEngine initialized');\n    console.log(\"%c ASE PLAYER ENGINE V3 (FIXED) LOADED \", \"background: #222; color: #bada55; font-size: 20px; font-weight: bold;\");\n  }\n\n  private startSyncVerification(): void {\n    this.syncCheckInterval = window.setInterval(() => {\n      this.verifySyncState();\n    }, 5000); // Check every 5 seconds\n  }\n\n  private verifySyncState(): void {\n    let needsResync = false;\n\n    // If sync state is empty, check if we have active (non-stopped) players\n    if (this.lastSyncState.length === 0) {\n      const hasActivePlayers = Array.from(this.players.values()).some(\n        p => p.state === 'playing' || p.state === 'paused'\n      );\n      if (hasActivePlayers) {\n        Logger.warn('Sync verification: Active players exist but sync state is empty');\n        needsResync = true;\n      } else {\n        // All players stopped + empty sync state = consistent, no resync needed\n        return;\n      }\n    }\n\n    if (!needsResync) {\n      // Check each expected track\n      for (const expectedTrack of this.lastSyncState) {\n        const player = this.players.get(expectedTrack.id);\n\n        if (!player) {\n          if (expectedTrack.isPlaying) {\n            Logger.warn(`Sync verification: Expected playing track not found: ${expectedTrack.id}`);\n            needsResync = true;\n            break;\n          }\n          continue;\n        }\n\n        const actuallyPlaying = player.state === 'playing';\n\n        if (expectedTrack.isPlaying && !actuallyPlaying) {\n          Logger.warn(`Sync verification: Track should be playing but is ${player.state}: ${expectedTrack.id}`);\n          needsResync = true;\n          break;\n        }\n\n        if (!expectedTrack.isPlaying && actuallyPlaying) {\n          Logger.warn(`Sync verification: Track should be stopped but is playing: ${expectedTrack.id}`);\n          needsResync = true;\n          break;\n        }\n      }\n    }\n\n    // Check for unexpected tracks not in sync state\n    if (!needsResync && this.lastSyncState.length > 0) {\n      const expectedIds = new Set(this.lastSyncState.map(t => t.id));\n      for (const [id, player] of this.players) {\n        if (!expectedIds.has(id) && player.state === 'playing') {\n          Logger.warn(`Sync verification: Unexpected playing track: ${id}`);\n          needsResync = true;\n          break;\n        }\n      }\n    }\n\n    if (needsResync) {\n      // Cooldown check\n      const now = Date.now();\n      if (now - this.lastSyncRequestTime < this.SYNC_REQUEST_COOLDOWN) {\n        return;\n      }\n\n      // Retry limit — stop requesting after MAX_SYNC_RETRIES consecutive failures\n      this.syncRequestFailCount++;\n      if (this.syncRequestFailCount > this.MAX_SYNC_RETRIES) {\n        Logger.warn(`Sync verification: Exceeded ${this.MAX_SYNC_RETRIES} retries, stopping requests`);\n        return;\n      }\n\n      Logger.info(`Sync verification failed — requesting full sync (attempt ${this.syncRequestFailCount}/${this.MAX_SYNC_RETRIES})`);\n      this.lastSyncRequestTime = now;\n\n      if (this.socketManager) {\n        this.socketManager.requestFullSync();\n      } else {\n        Logger.warn('Cannot request sync: socketManager not set');\n      }\n    } else {\n      // Reset fail counter on successful verification\n      this.syncRequestFailCount = 0;\n    }\n  }\n\n  dispose(): void {\n    // Clear interval on cleanup\n    if (this.syncCheckInterval !== null) {\n      window.clearInterval(this.syncCheckInterval);\n      this.syncCheckInterval = null;\n    }\n\n    // Dispose all players\n    this.clearAll();\n\n    // Dispose effects\n    for (const effect of this.effects.values()) {\n      effect.dispose();\n    }\n    this.effects.clear();\n\n    // Close audio context\n    this.ctx.close();\n    Logger.info('PlayerAudioEngine disposed');\n  }\n\n  private initializeEffects(): void {\n    // Create one instance of each effect\n    const effectClasses = [\n      ReverbEffect,\n      FilterEffect,\n      DelayEffect,\n      CompressorEffect,\n      DistortionEffect\n    ];\n\n    effectClasses.forEach(EffectClass => {\n      const effect = new EffectClass(this.ctx);\n      this.effects.set(effect.id, effect);\n\n      // Connect Effect Output to GM Gain (so it's controlled by GM master volume)\n      effect.outputNode.connect(this.gmGain);\n\n      // Create Send Gains for each channel\n      (['music', 'ambience', 'sfx'] as TrackGroup[]).forEach(group => {\n        const sendGain = this.ctx.createGain();\n        sendGain.gain.value = 0; // Default off\n\n        // Connect Channel -> SendGain -> Effect Input\n        this.channelGains[group].connect(sendGain);\n        sendGain.connect(effect.inputNode);\n\n        this.sends[group].set(effect.id, sendGain);\n      });\n    });\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Local Volume (Player's personal control)\n  // ─────────────────────────────────────────────────────────────\n\n  get localVolume(): number {\n    return this._localVolume;\n  }\n\n  setLocalVolume(value: number): void {\n    this._localVolume = Math.max(0, Math.min(1, value));\n    this.masterGain.gain.linearRampToValueAtTime(\n      this._localVolume,\n      this.ctx.currentTime + 0.01\n    );\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // GM Volume (from sync)\n  // ─────────────────────────────────────────────────────────────\n\n  setGMVolume(channel: TrackGroup | 'master', value: number): void {\n    const safeValue = Math.max(0, Math.min(1, value));\n\n    if (channel === 'master') {\n      this._gmVolumes.master = safeValue;\n      this.gmGain.gain.linearRampToValueAtTime(safeValue, this.ctx.currentTime + 0.01);\n    } else {\n      this._gmVolumes[channel] = safeValue;\n      this.channelGains[channel].gain.linearRampToValueAtTime(safeValue, this.ctx.currentTime + 0.01);\n    }\n  }\n\n  setAllGMVolumes(volumes: ChannelVolumes): void {\n    this._gmVolumes = { ...volumes };\n\n    this.gmGain.gain.setValueAtTime(volumes.master, this.ctx.currentTime);\n    this.channelGains.music.gain.setValueAtTime(volumes.music, this.ctx.currentTime);\n    this.channelGains.ambience.gain.setValueAtTime(volumes.ambience, this.ctx.currentTime);\n    this.channelGains.sfx.gain.setValueAtTime(volumes.sfx, this.ctx.currentTime);\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Effects Management (Called via Socket)\n  // ─────────────────────────────────────────────────────────────\n\n  setEffectParam(effectId: string, paramId: string, value: any): void {\n    console.log('[ASE PLAYER] setEffectParam received:', effectId, paramId, value);\n    const effect = this.effects.get(effectId);\n    if (!effect) {\n      console.warn('[ASE PLAYER] Effect not found:', effectId);\n      return;\n    }\n    effect.setParam(paramId, value);\n    console.log('[ASE PLAYER] Effect param set successfully');\n  }\n\n  setEffectEnabled(effectId: string, enabled: boolean): void {\n    console.log('[ASE PLAYER] setEffectEnabled received:', effectId, enabled);\n    const effect = this.effects.get(effectId);\n    if (!effect) {\n      console.warn('[ASE PLAYER] Effect not found:', effectId);\n      return;\n    }\n\n    effect.setEnabled(enabled);\n    console.log('[ASE PLAYER] Effect enabled set to:', enabled);\n\n    // Update dry levels\n    (['music', 'ambience', 'sfx'] as TrackGroup[]).forEach(group => {\n      this.updateDryLevel(group);\n    });\n  }\n\n  setEffectRouting(effectId: string, channel: TrackGroup, active: boolean): void {\n    console.log('[ASE PLAYER] setEffectRouting received:', effectId, channel, active);\n    const channelSends = this.sends[channel];\n    const sendNode = channelSends.get(effectId);\n\n    if (sendNode) {\n      sendNode.gain.setTargetAtTime(active ? 1 : 0, this.ctx.currentTime, 0.05);\n      this.updateDryLevel(channel);\n      console.log('[ASE PLAYER] Effect routing set successfully');\n    } else {\n      console.warn('[ASE PLAYER] Send node not found for:', effectId, channel);\n    }\n  }\n\n  private updateDryLevel(channel: TrackGroup): void {\n    let isInsertActive = false;\n    const insertTypes: EffectType[] = ['filter', 'distortion', 'compressor'];\n\n    for (const effect of this.effects.values()) {\n      if (!effect.enabled) continue;\n\n      const sendNode = this.sends[channel].get(effect.id);\n      const isRouted = (sendNode?.gain.value || 0) > 0.5;\n\n      if (isRouted && insertTypes.includes(effect.type)) {\n        isInsertActive = true;\n        break;\n      }\n    }\n\n    const targetGain = isInsertActive ? 0 : 1;\n    this.directGains[channel].gain.setTargetAtTime(targetGain, this.ctx.currentTime, 0.1);\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Local Playback Control (Interface Compliance)\n  // ─────────────────────────────────────────────────────────────\n\n  async playTrack(id: string, offset: number = 0): Promise<void> {\n    const player = this.players.get(id);\n    if (player) {\n      await player.play(offset);\n    } else {\n      Logger.warn(`PlayerAudioEngine: Track ${id} not found locally.`);\n    }\n  }\n\n  pauseTrack(id: string): void {\n    this.players.get(id)?.pause();\n  }\n\n  stopTrack(id: string): void {\n    this.players.get(id)?.stop();\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Track Commands (from GM via socket)\n  // ─────────────────────────────────────────────────────────────\n\n  async handlePlay(payload: TrackPlayPayload): Promise<void> {\n    let player = this.players.get(payload.trackId);\n\n    // If player exists with different URL, dispose it first\n    if (player && player.url !== payload.url) {\n      Logger.debug(`Player: Disposing existing track ${payload.trackId} (URL changed)`);\n      player.stop();\n      player.dispose();\n      this.players.delete(payload.trackId);\n      player = undefined;\n    }\n\n    // Create if doesn't exist\n    if (!player) {\n      player = new StreamingPlayer(\n        payload.trackId,\n        this.ctx,\n        this.channelGains[payload.group],\n        payload.group\n      );\n\n      await player.load(payload.url);\n      this.players.set(payload.trackId, player);\n    }\n\n    player.setVolume(payload.volume);\n\n    // Calculate offset based on time elapsed since GM started\n    const elapsed = (getServerTime() - payload.startTimestamp) / 1000;\n    const adjustedOffset = Math.max(0, payload.offset + elapsed);\n\n    Logger.debug(`Player: Handling Play. TrackId=${payload.trackId}, Vol=${payload.volume}, Offset=${adjustedOffset}s`);\n\n    await player.play(adjustedOffset);\n    Logger.debug(`Player: track ${payload.trackId} playing at ${adjustedOffset.toFixed(2)}s`);\n  }\n\n  handlePause(trackId: string): void {\n    this.players.get(trackId)?.pause();\n  }\n\n  handleStop(trackId: string): void {\n    this.players.get(trackId)?.stop();\n  }\n\n  handleSeek(trackId: string, time: number, isPlaying: boolean, seekTimestamp: number): void {\n    const player = this.players.get(trackId);\n    if (!player) return;\n\n    if (isPlaying) {\n      const elapsed = (getServerTime() - seekTimestamp) / 1000;\n      player.seek(time + elapsed);\n    } else {\n      player.seek(time);\n    }\n  }\n\n  handleTrackVolume(trackId: string, volume: number): void {\n    this.players.get(trackId)?.setVolume(volume);\n  }\n\n\n  // Sync State (full state from GM)\n  // ─────────────────────────────────────────────────────────────\n\n  async syncState(tracks: SyncTrackState[], volumes: ChannelVolumes, effectsState: EffectState[] = []): Promise<void> {\n    Logger.debug(`Player: Sync State Received. Tracks=${tracks.length}, Effects=${effectsState?.length || 0}`);\n\n    // Store last sync state and reset retry counter (GM responded)\n    this.lastSyncState = tracks;\n    this.syncRequestFailCount = 0;\n\n    // Set volumes\n    this.setAllGMVolumes(volumes);\n\n    // Check GM Gain after setting\n    Logger.debug(`Player: GM Gain set to ${this.gmGain.gain.value}`);\n\n    // Sync Effect States\n    if (effectsState && effectsState.length > 0) {\n      for (const effectState of effectsState) {\n        const effect = this.effects.get(effectState.id);\n        if (!effect) {\n          console.warn('[ASE PLAYER] Effect not found during sync:', effectState.id);\n          continue;\n        }\n\n        // Apply enabled state\n        this.setEffectEnabled(effectState.id, effectState.enabled);\n\n        // Apply routing\n        (['music', 'ambience', 'sfx'] as TrackGroup[]).forEach(group => {\n          const active = effectState.routing[group] || false;\n          this.setEffectRouting(effectState.id, group, active);\n        });\n\n        // Apply params\n        Object.entries(effectState.params).forEach(([paramId, value]) => {\n          this.setEffectParam(effectState.id, paramId, value);\n        });\n\n        Logger.debug(`Player: synced ${effect.type} state from GM`);\n      }\n    }\n\n    // Handle tracks\n    const newTrackIds = new Set(tracks.map(t => t.id));\n\n    // Remove tracks not in sync\n    for (const [id, player] of this.players) {\n      if (!newTrackIds.has(id)) {\n        player.dispose();\n        this.players.delete(id);\n      }\n    }\n\n    // Add/update tracks\n    for (const trackState of tracks) {\n      let player = this.players.get(trackState.id);\n\n      // CRITICAL FIX: Stop tracks that should not be playing\n      if (player && !trackState.isPlaying && player.state === 'playing') {\n        Logger.debug('Player: Stopping track that should not be playing:', trackState.id);\n        player.stop();\n        continue; // Skip further processing for this track as it's now stopped\n      }\n\n      if (!player) {\n        // Create if doesn't exist and should be playing\n        if (trackState.isPlaying) {\n          await this.handlePlay({\n            trackId: trackState.id,\n            url: trackState.url,\n            group: trackState.group,\n            volume: trackState.volume,\n            offset: trackState.currentTime,\n            startTimestamp: trackState.startTimestamp\n          });\n        }\n        continue; // If player was just created (and played) or doesn't need to be created, move to next track\n      }\n\n      // For existing players (that weren't stopped above)\n      player.setVolume(trackState.volume);\n\n      if (trackState.isPlaying) {\n        const elapsed = (getServerTime() - trackState.startTimestamp) / 1000;\n        const adjustedTime = trackState.currentTime + elapsed;\n\n        // Skip re-play if track is already playing at approximately the right position.\n        // This avoids audible glitches from restarting audio that's already correct.\n        if (player.state === 'playing') {\n          const drift = Math.abs(player.getCurrentTime() - adjustedTime);\n          if (drift < 2.0) {\n            Logger.debug(`Player: Track ${trackState.id} already playing, drift=${drift.toFixed(2)}s — skipping re-play`);\n            continue;\n          }\n          Logger.debug(`Player: Track ${trackState.id} drift=${drift.toFixed(2)}s — re-syncing`);\n        }\n\n        await player.play(adjustedTime);\n      } else {\n        player.stop();\n      }\n    }\n\n    Logger.info('Player: synced state from GM');\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Sync Off\n  // ─────────────────────────────────────────────────────────────\n\n  // Stop all tracks — full cleanup to prevent phantom sound and sync loops\n  stopAll(): void {\n    Logger.info('Player: Stopping all tracks');\n    for (const player of this.players.values()) {\n      player.stop();\n      player.dispose();\n    }\n    this.players.clear();\n    this.lastSyncState = [];\n    this.syncRequestFailCount = 0;\n    Logger.info('Player: All tracks stopped and cleared');\n  }\n\n  // Clear all tracks (stop + dispose) — used on sync-stop\n  clearAll(): void {\n    for (const player of this.players.values()) {\n      player.stop();\n      player.dispose();\n    }\n    this.players.clear();\n    this.lastSyncState = [];\n    this.syncRequestFailCount = 0;\n    Logger.info('Player: all tracks cleared');\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Audio Context\n  // ─────────────────────────────────────────────────────────────\n\n  async resume(): Promise<void> {\n    if (this.ctx.state === 'suspended') {\n      await this.ctx.resume();\n      Logger.info('PlayerAudioEngine: AudioContext resumed');\n    }\n  }\n}","import type {\n  SocketMessage,\n  SocketMessageType,\n  SyncStatePayload,\n  SyncTrackState,\n  TrackPlayPayload,\n  TrackPausePayload,\n  TrackStopPayload,\n  TrackSeekPayload,\n  TrackVolumePayload,\n  ChannelVolumePayload,\n  TrackGroup,\n  ChannelVolumes,\n  EffectParamPayload,\n  EffectRoutingPayload\n} from '@t/audio';\nimport { AudioEngine } from '@core/AudioEngine';\nimport { PlayerAudioEngine } from '@core/PlayerAudioEngine';\nimport { Logger } from '@utils/logger';\nimport { getServerTime } from '@utils/time';\n\nconst MODULE_ID = 'advanced-sound-engine';\nconst SOCKET_NAME = `module.${MODULE_ID}`;\n\nexport class SocketManager {\n  private gmEngine: AudioEngine | null = null;\n  private playerEngine: PlayerAudioEngine | null = null;\n  private socket: any = null;\n  private _syncEnabled: boolean = false;\n  private isGM: boolean = false;\n\n  // Protocol version — bump when message format changes\n  static readonly PROTOCOL_VERSION = 1;\n\n  // Rate limiting for high-frequency broadcasts\n  private static THROTTLE_MS = 150;\n  private throttleTimers: Map<string, ReturnType<typeof setTimeout>> = new Map();\n  private throttlePending: Map<string, () => void> = new Map();\n\n  constructor() { }\n\n  initializeAsGM(engine: AudioEngine): void {\n    this.isGM = true;\n    this.gmEngine = engine;\n    this.socket = game.socket;\n\n    this.socket?.on(SOCKET_NAME, (message: SocketMessage) => {\n      this.handleGMMessage(message);\n    });\n\n    Logger.info('SocketManager initialized as GM');\n  }\n\n  initializeAsPlayer(engine: PlayerAudioEngine): void {\n    this.isGM = false;\n    this.playerEngine = engine;\n    this.socket = game.socket;\n\n    this.socket?.on(SOCKET_NAME, (message: SocketMessage) => {\n      this.handlePlayerMessage(message);\n    });\n\n    // Request current state on join\n    setTimeout(() => {\n      this.send('player-ready', {});\n    }, 1000);\n\n    Logger.info('SocketManager initialized as Player');\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Sync Mode (GM)\n  // ─────────────────────────────────────────────────────────────\n\n  get syncEnabled(): boolean {\n    return this._syncEnabled;\n  }\n\n  setSyncEnabled(enabled: boolean): void {\n    if (!this.isGM) return;\n\n    this._syncEnabled = enabled;\n\n    if (enabled) {\n      this.broadcastSyncStart();\n    } else {\n      this.broadcastSyncStop();\n    }\n\n    Logger.info(`Sync mode: ${enabled ? 'ON' : 'OFF'}`);\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // GM Message Handling\n  // ─────────────────────────────────────────────────────────────\n\n  private handleGMMessage(message: SocketMessage): void {\n    if (message.senderId === game.user?.id) return;\n\n    if (message.version && message.version !== SocketManager.PROTOCOL_VERSION) {\n      Logger.warn(`Protocol mismatch: received v${message.version}, expected v${SocketManager.PROTOCOL_VERSION}. Player may need to refresh.`);\n    }\n\n    if (message.type === 'player-ready' && this._syncEnabled) {\n      // Send current state to newly joined player\n      this.sendStateTo(message.senderId);\n    }\n\n    if (message.type === 'sync-request' && this._syncEnabled) {\n      // Player is requesting full sync (likely due to detected mismatch)\n      Logger.debug('Received sync request from player:', message.senderId);\n      this.sendStateTo(message.senderId);\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Player Message Handling\n  // ─────────────────────────────────────────────────────────────\n\n  private async handlePlayerMessage(message: SocketMessage): Promise<void> {\n    if (message.senderId === game.user?.id) return;\n    if (!this.playerEngine) return;\n\n    if (message.version && message.version !== SocketManager.PROTOCOL_VERSION) {\n      Logger.warn(`Protocol mismatch: received v${message.version}, expected v${SocketManager.PROTOCOL_VERSION}. Try refreshing the page.`);\n    }\n\n    Logger.debug(`Player received: ${message.type}`, message.payload);\n\n    switch (message.type) {\n      case 'sync-start':\n        const startPayload = message.payload as SyncStatePayload;\n        await this.playerEngine.syncState(startPayload.tracks, startPayload.channelVolumes, startPayload.effects);\n        break;\n\n      case 'sync-stop':\n        this.playerEngine.clearAll();\n        break;\n\n      case 'sync-state':\n        const statePayload = message.payload as SyncStatePayload;\n        await this.playerEngine.syncState(statePayload.tracks, statePayload.channelVolumes, statePayload.effects);\n        break;\n\n      case 'track-play':\n        const playPayload = message.payload as TrackPlayPayload;\n        await this.playerEngine.handlePlay(playPayload);\n        break;\n\n      case 'track-pause':\n        const pausePayload = message.payload as TrackPausePayload;\n        this.playerEngine.handlePause(pausePayload.trackId);\n        break;\n\n      case 'track-stop':\n        const stopPayload = message.payload as TrackStopPayload;\n        this.playerEngine.handleStop(stopPayload.trackId);\n        break;\n\n      case 'track-seek':\n        const seekPayload = message.payload as TrackSeekPayload;\n        this.playerEngine.handleSeek(\n          seekPayload.trackId,\n          seekPayload.time,\n          seekPayload.isPlaying,\n          seekPayload.seekTimestamp\n        );\n        break;\n\n      case 'track-volume':\n        const volPayload = message.payload as TrackVolumePayload;\n        this.playerEngine.handleTrackVolume(volPayload.trackId, volPayload.volume);\n        break;\n\n\n\n      case 'channel-volume':\n        const chVolPayload = message.payload as ChannelVolumePayload;\n        this.playerEngine.setGMVolume(chVolPayload.channel, chVolPayload.volume);\n        break;\n\n      case 'stop-all':\n        this.playerEngine.stopAll();\n        break;\n\n      case 'effect-param':\n        const paramPayload = message.payload as EffectParamPayload;\n        (this.playerEngine as any).setEffectParam(paramPayload.effectId, paramPayload.paramId, paramPayload.value);\n        break;\n\n      case 'effect-routing':\n        const routingPayload = message.payload as EffectRoutingPayload;\n        (this.playerEngine as any).setEffectRouting(routingPayload.effectId, routingPayload.channel, routingPayload.active);\n        break;\n\n      case 'effect-enabled':\n        const enabledPayload = message.payload as any; // EffectEnabledPayload\n        (this.playerEngine as any).setEffectEnabled(enabledPayload.effectId, enabledPayload.enabled);\n        break;\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // GM Broadcast Methods\n  // ─────────────────────────────────────────────────────────────\n\n  private send(type: SocketMessageType, payload: unknown, targetUserId?: string): void {\n    if (!this.socket) return;\n\n    const message: SocketMessage = {\n      type,\n      payload,\n      senderId: game.user?.id ?? '',\n      timestamp: getServerTime(),\n      version: SocketManager.PROTOCOL_VERSION\n    };\n\n    if (targetUserId) {\n      this.socket.emit(SOCKET_NAME, message, { recipients: [targetUserId] });\n    } else {\n      this.socket.emit(SOCKET_NAME, message);\n    }\n\n    Logger.debug(`Sent: ${type}`, payload);\n  }\n\n  /**\n   * Throttle a send by key — ensures high-frequency broadcasts (seek, volume, effect params)\n   * don't flood the socket. The last value always gets sent.\n   */\n  private throttledSend(key: string, type: SocketMessageType, payload: unknown): void {\n    // Store the latest payload to send\n    this.throttlePending.set(key, () => this.send(type, payload));\n\n    // If already waiting, skip (the pending fn will fire with latest value)\n    if (this.throttleTimers.has(key)) return;\n\n    // Send immediately on first call\n    this.send(type, payload);\n    this.throttlePending.delete(key);\n\n    // Set cooldown timer\n    this.throttleTimers.set(key, setTimeout(() => {\n      this.throttleTimers.delete(key);\n      // If there's a pending update, send it now\n      const pending = this.throttlePending.get(key);\n      if (pending) {\n        this.throttlePending.delete(key);\n        pending();\n      }\n    }, SocketManager.THROTTLE_MS));\n  }\n\n  private getCurrentSyncState(): SyncStatePayload {\n    if (!this.gmEngine) {\n      return { tracks: [], channelVolumes: { master: 1, music: 1, ambience: 1, sfx: 1 }, effects: [] };\n    }\n\n    const now = getServerTime();\n    const tracks: SyncTrackState[] = [];\n\n    for (const player of this.gmEngine.getAllTracks()) {\n      const state = player.getState();\n      tracks.push({\n        id: state.id,\n        url: state.url,\n        group: state.group,\n        volume: state.volume,\n        isPlaying: state.playbackState === 'playing',\n        currentTime: player.getCurrentTime(),\n        startTimestamp: now\n      });\n    }\n\n    return {\n      tracks,\n      channelVolumes: this.gmEngine.volumes,\n      effects: this.gmEngine.getAllEffects().map(e => this.gmEngine!.getEffectState(e.id)!)\n    };\n  }\n\n  public broadcastFullState(): void {\n    if (!this._syncEnabled) return;\n    this.broadcastSyncStart(); // Re-uses sync-start or sync-state logic\n  }\n\n  private broadcastSyncStart(): void {\n    const state = this.getCurrentSyncState();\n    this.send('sync-start', state);\n  }\n\n  private broadcastSyncStop(): void {\n    this.send('sync-stop', {});\n  }\n\n  private sendStateTo(userId: string): void {\n    const state = this.getCurrentSyncState();\n    this.send('sync-state', state, userId);\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // GM Actions (called when GM interacts with mixer)\n  // ─────────────────────────────────────────────────────────────\n\n  broadcastTrackPlay(trackId: string, offset: number): void {\n    if (!this._syncEnabled || !this.gmEngine) return;\n\n    const player = this.gmEngine.getTrack(trackId);\n    if (!player) return;\n\n    const payload: TrackPlayPayload = {\n      trackId,\n      url: player.url,\n      group: player.group,\n      volume: player.volume,\n      offset,\n      startTimestamp: getServerTime()\n    };\n\n    this.send('track-play', payload);\n  }\n\n  broadcastTrackPause(trackId: string, pausedAt: number): void {\n    if (!this._syncEnabled) return;\n\n    const payload: TrackPausePayload = { trackId, pausedAt };\n    this.send('track-pause', payload);\n  }\n\n  broadcastTrackStop(trackId: string): void {\n    if (!this._syncEnabled) return;\n\n    const payload: TrackStopPayload = { trackId };\n    this.send('track-stop', payload);\n  }\n\n  broadcastTrackSeek(trackId: string, time: number, isPlaying: boolean): void {\n    if (!this._syncEnabled) return;\n\n    const payload: TrackSeekPayload = {\n      trackId,\n      time,\n      isPlaying,\n      seekTimestamp: getServerTime()\n    };\n    this.throttledSend(`seek:${trackId}`, 'track-seek', payload);\n  }\n\n  broadcastTrackVolume(trackId: string, volume: number): void {\n    if (!this._syncEnabled) return;\n\n    const payload: TrackVolumePayload = { trackId, volume };\n    this.throttledSend(`vol:${trackId}`, 'track-volume', payload);\n  }\n\n  broadcastChannelVolume(channel: TrackGroup | 'master', volume: number): void {\n    if (!this._syncEnabled) return;\n\n    const payload: ChannelVolumePayload = { channel, volume };\n    this.throttledSend(`chvol:${channel}`, 'channel-volume', payload);\n  }\n\n  broadcastStopAll(): void {\n    // No syncEnabled guard — stop-all MUST always reach players,\n    // even if sync was just toggled off. This prevents phantom sound.\n    this.send('stop-all', {});\n  }\n\n  dispose(): void {\n    // Clear all throttle timers\n    for (const timer of this.throttleTimers.values()) {\n      clearTimeout(timer);\n    }\n    this.throttleTimers.clear();\n    this.throttlePending.clear();\n\n    this.socket?.off(SOCKET_NAME);\n  }\n\n  // Effects\n\n  broadcastEffectParam(effectId: string, paramId: string, value: any): void {\n    if (!this._syncEnabled) return;\n    this.throttledSend(`fx:${effectId}:${paramId}`, 'effect-param', { effectId, paramId, value } as EffectParamPayload);\n  }\n\n  broadcastEffectRouting(effectId: string, channel: TrackGroup, active: boolean): void {\n    if (!this._syncEnabled) return;\n    this.send('effect-routing', { effectId, channel, active } as EffectRoutingPayload);\n  }\n\n  broadcastEffectEnabled(effectId: string, enabled: boolean): void {\n    if (!this._syncEnabled) return;\n    this.send('effect-enabled', { effectId, enabled } as any);\n  }\n  // ─────────────────────────────────────────────────────────────\n  // Player Methods (request sync from GM)\n  // ─────────────────────────────────────────────────────────────\n\n  requestFullSync(): void {\n    Logger.debug('Requesting full sync from GM');\n    this.send('sync-request', {});\n  }\n}","import { PlayerAudioEngine } from '@core/PlayerAudioEngine';\nimport { Logger } from '@utils/logger';\n\nconst MODULE_ID = 'advanced-sound-engine';\n\nexport class PlayerVolumePanel extends Application {\n  private engine: PlayerAudioEngine;\n\n  static override get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      id: 'ase-player-volume',\n      title: 'Sound Volume',\n      template: `modules/${MODULE_ID}/templates/player-volume.hbs`,\n      classes: ['ase-player-panel'],\n      width: 200,\n      height: 'auto',\n      resizable: false,\n      minimizable: true,\n      popOut: true\n    }) as any;\n  }\n\n  constructor(engine: PlayerAudioEngine, options?: any) {\n    super(options);\n    this.engine = engine;\n  }\n\n  override getData() {\n    return {\n      volume: Math.round(this.engine.localVolume * 100)\n    };\n  }\n\n  override activateListeners(html: JQuery): void {\n    super.activateListeners(html);\n\n    html.find('.ase-volume-slider').on('input', (event) => {\n      const value = parseFloat((event.target as HTMLInputElement).value) / 100;\n      this.engine.setLocalVolume(value);\n      html.find('.ase-volume-value').text(`${Math.round(value * 100)}%`);\n\n      // Save preference\n      this.saveVolume(value);\n    });\n  }\n\n  private saveVolume(value: number): void {\n    localStorage.setItem(`${MODULE_ID}-player-volume`, String(value));\n  }\n\n  static loadSavedVolume(): number {\n    const saved = localStorage.getItem(`${MODULE_ID}-player-volume`);\n    return saved ? parseFloat(saved) : 1;\n  }\n}","import type { LibraryItem, Playlist } from '@t/library';\nimport type { TrackGroup } from '@t/audio';\nimport { LibraryManager } from '@lib/LibraryManager';\nimport { Logger } from '@utils/logger';\nimport { formatTime } from '@utils/time';\n\nconst MODULE_ID = 'advanced-sound-engine';\n\ninterface FilterState {\n  searchQuery: string;\n  selectedChannels: Set<TrackGroup>;\n  selectedPlaylistId: string | null;\n  selectedTags: Set<string>;\n  sortBy: 'name-asc' | 'name-desc' | 'date-asc' | 'date-desc' | 'duration-asc' | 'duration-desc' | 'playable';\n}\n\ninterface LibraryData {\n  items: LibraryItemViewData[];\n  playlists: PlaylistViewData[];\n  favorites: FavoriteViewData[];\n  tags: TagViewData[];\n  stats: {\n    totalItems: number;\n    favoriteItems: number;\n    playlists: number;\n    tagCount: number;\n  };\n  searchQuery: string;\n  filters: {\n    music: boolean;\n    ambience: boolean;\n    sfx: boolean;\n  };\n  selectedPlaylistId: string | null;\n  sortBy: string;\n  hasActiveFilters: boolean;\n  sortOptions?: Array<{ value: string; label: string; }>; // Added for UI dropdown\n}\n\ninterface TagViewData {\n  name: string;\n  value: string;\n  selected: boolean;\n}\n\ninterface LibraryItemViewData {\n  id: string;\n  name: string;\n  url: string;\n  duration: string;\n  durationFormatted: string;\n  durationSeconds: number;\n  tags: string[];\n  favorite: boolean;\n  group: string;\n  inQueue: boolean;\n  isPlaying: boolean;\n  isPaused: boolean;\n  playbackMode?: string;\n}\n\ninterface PlaylistViewData {\n  id: string;\n  name: string;\n  itemCount: number;\n  trackCount: number; // Alias for template\n  favorite: boolean;\n  inQueue: boolean;\n  selected?: boolean;\n  playbackMode?: string;\n}\n\ninterface FavoriteViewData {\n  id: string;\n  name: string;\n  type: 'track' | 'playlist';\n  group?: string; // music/ambience/sfx for tracks\n  inQueue?: boolean;\n}\n\nexport class LocalLibraryApp extends Application {\n  private library: LibraryManager;\n  private filterState: FilterState;\n\n  static override get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      id: 'local-library',\n      template: 'modules/advanced-sound-engine/templates/library.hbs',\n      title: 'Sound Library',\n      width: 1100,\n      height: 700,\n      classes: ['advanced-sound-engine', 'library'],\n      resizable: true,\n      tabs: [{ navSelector: '.tabs', contentSelector: '.content', initial: 'library' }]\n    });\n  }\n\n  private parentApp: any; // Using any to avoid circular import issues for now, or use interface\n  private _queueListener: ((data: any) => void) | null = null;\n  private _listenersInitialized = false; // Track if we've initialized delegated listeners\n  private _renderDebounceTimer: number | null = null; // Debounce timer for renders\n\n  constructor(library: LibraryManager, parentApp: any, options = {}) {\n    super(options);\n    this.library = library;\n    this.parentApp = parentApp;\n    this.filterState = {\n      searchQuery: '',\n      selectedChannels: new Set(['music', 'ambience', 'sfx']),\n      selectedPlaylistId: null,\n      selectedTags: new Set(),\n      // Default sort\n      sortBy: 'date-desc'\n    } as any;\n  }\n\n  // Override render to delegate to main app\n  override render(force?: boolean, options?: any): any {\n    // Background update: Trigger parent app re-render\n    if (options?.renderContext === 'queue-update') {\n      if (this.parentApp && typeof this.parentApp.render === 'function') {\n        this.parentApp.captureScroll(); // Capture before background update\n        return this.parentApp.render({ parts: ['main'] });\n      }\n    }\n\n    // Default behavior: Delegate to openPanel (likely focuses tab)\n    if (window.ASE?.openPanel) {\n      // openPanel calls render, so we should capture if we are already open\n      if (this.parentApp) {\n        if (options?.resetScroll) {\n          this.parentApp.resetScroll('library');\n        } else {\n          this.parentApp.captureScroll();\n        }\n      }\n      window.ASE.openPanel('library', true);\n      return;\n    }\n    return super.render(force, options);\n  }\n\n  override async close(options?: any): Promise<void> {\n    // Clean up queue listener\n    if (this._queueListener && window.ASE?.queue) {\n      window.ASE.queue.off('change', this._queueListener);\n      this._queueListener = null;\n    }\n\n    // Clean up debounce timer\n    if (this._renderDebounceTimer) {\n      clearTimeout(this._renderDebounceTimer);\n      this._renderDebounceTimer = null;\n    }\n\n    // Clean up global delegated event handler\n    if (this._listenersInitialized) {\n      $(document).off('mousedown.ase-lib-global');\n      this._listenersInitialized = false;\n    }\n\n    return super.close(options);\n  }\n\n\n  override getData(): LibraryData {\n    let items = this.library.getAllItems();\n    const playlists = this.library.playlists.getAllPlaylists();\n    const allTags = this.library.getAllTags();\n\n    const stats = this.library.getStats();\n\n\n    // Trigger background scan for missing durations (run once per session)\n    this.library.scanMissingDurations().then(() => {\n      // If items were updated, we might want to re-render, but usually scheduleSave will trigger an event? \n      // For now, we rely on the next interaction or auto-refresh if we implement signals.\n      // Or we can force a render if updates happened. \n      // But scanMissingDurations is async and we don't await it here to avoid blocking UI.\n    });\n\n    // Apply filters\n    items = this.applyFilters(items);\n\n    // Apply sorting\n    items = this.applySorting(items);\n\n    // Build favorites list (tracks + playlists)\n    // Use the ordered list from LibraryManager\n    const orderedFavorites = this.library.getOrderedFavorites();\n\n    const favorites: FavoriteViewData[] = orderedFavorites.map((entry): FavoriteViewData | null => {\n      const inQueue = entry.type === 'track'\n        ? (window.ASE?.queue?.hasItem(entry.id) ?? false)\n        : (window.ASE?.queue?.getItems().some(q => q.playlistId === entry.id) ?? false);\n\n      if (entry.type === 'track') {\n        const item = this.library.getItem(entry.id);\n        if (!item) return null; // Should be handled by getOrderedFavorites cleanup\n\n        return {\n          id: item.id,\n          name: item.name,\n          type: 'track' as const,\n          group: this.inferGroupFromTags(item.tags),\n          inQueue\n        };\n      } else {\n        const playlist = this.library.playlists.getPlaylist(entry.id);\n        if (!playlist) return null;\n\n        return {\n          id: playlist.id,\n          name: playlist.name,\n          type: 'playlist' as const,\n          inQueue\n        };\n      }\n    }).filter((f): f is FavoriteViewData => f !== null);\n\n    // Build tags list with selection state, ensuring selected and recent tags are visible\n    const tagSet = new Set(allTags);\n    this.filterState.selectedTags.forEach(t => tagSet.add(t));\n\n    const tags: TagViewData[] = Array.from(tagSet).sort().map(tag => {\n      // Normalize: ensure no leading #\n      const normalizedTag = tag.startsWith('#') ? tag.substring(1) : tag;\n      const isSelected = this.filterState.selectedTags.has(tag) || this.filterState.selectedTags.has(normalizedTag);\n      return {\n        name: normalizedTag, // Display name (without #)\n        value: normalizedTag, // Data value (also normalized for consistency)\n        selected: isSelected\n      };\n    });\n\n    // Build playlists with selection state\n    const playlistsViewData = playlists.map(p => ({\n      ...this.getPlaylistViewData(p),\n      selected: p.id === this.filterState.selectedPlaylistId\n    }));\n\n    // Check if any filters are active (if NOT all channels are selected, or other filters exist)\n    const allChannelsSelected = this.filterState.selectedChannels.size === 3; // Assuming 3 channels\n    const hasActiveFilters = !!(\n      !allChannelsSelected ||\n      this.filterState.selectedPlaylistId ||\n      this.filterState.selectedTags.size > 0\n    );\n\n    // Map items to view data (adds inQueue, durationFormatted, etc.)\n    const itemsViewData = items.map(item => this.getItemViewData(item));\n\n    return {\n      items: itemsViewData,\n      playlists: playlistsViewData,\n      favorites,\n      tags,\n      stats: {\n        totalItems: stats.totalItems,\n        favoriteItems: stats.favoriteItems,\n        playlists: stats.totalPlaylists,\n        tagCount: stats.tagCount\n      },\n      searchQuery: this.filterState.searchQuery,\n      filters: {\n        music: this.filterState.selectedChannels.has('music'),\n        ambience: this.filterState.selectedChannels.has('ambience'),\n        sfx: this.filterState.selectedChannels.has('sfx')\n      },\n      selectedPlaylistId: this.filterState.selectedPlaylistId,\n      sortBy: this.filterState.sortBy,\n      hasActiveFilters,\n      sortOptions: [\n        { value: 'date-desc', label: 'Date Added (Newest)' },\n        { value: 'date-asc', label: 'Date Added (Oldest)' },\n        { value: 'name-asc', label: 'Name (A-Z)' },\n        { value: 'name-desc', label: 'Name (Z-A)' },\n        { value: 'duration-asc', label: 'Duration (Shortest)' },\n        { value: 'duration-desc', label: 'Duration (Longest)' }\n      ]\n    };\n  }\n\n  private getPlaylistViewData(playlist: Playlist): PlaylistViewData {\n    // Check if playlist is in queue\n    const inQueue = window.ASE?.queue?.getItems().some(\n      item => item.playlistId === playlist.id\n    ) ?? false;\n    console.log('ASE Debug: Playlist View Data:', { id: playlist.id, name: playlist.name, inQueue });\n\n    return {\n      id: playlist.id,\n      name: playlist.name,\n      itemCount: playlist.items.length,\n      trackCount: playlist.items.length, // Alias for template\n      favorite: playlist.favorite,\n      inQueue,\n      selected: false,\n      playbackMode: playlist.playbackMode\n    };\n  }\n\n  private getItemViewData(item: LibraryItem): LibraryItemViewData {\n    const inQueue = window.ASE?.queue?.hasItem(item.id) ?? false;\n    const durationFormatted = formatTime(item.duration);\n\n    // Get playback state from AudioEngine\n    const player = (window.ASE?.engine as any)?.getTrack?.(item.id);\n    const isPlaying = player?.state === 'playing';\n    const isPaused = player?.state === 'paused';\n\n    return {\n      id: item.id,\n      name: item.name,\n      url: item.url,\n      duration: durationFormatted,\n      durationFormatted,\n      durationSeconds: item.duration,\n      tags: item.tags,\n      favorite: item.favorite,\n      group: item.group || 'music',\n      inQueue,\n      isPlaying,\n      isPaused,\n      playbackMode: item.playbackMode\n    };\n  }\n\n  private inferGroupFromTags(tags: string[]): string {\n    // Try to infer group from tags if possible\n    const lowerTags = tags.map(t => t.toLowerCase());\n    if (lowerTags.some(t => t.includes('music'))) return 'music';\n    if (lowerTags.some(t => t.includes('ambient') || t.includes('ambience'))) return 'ambience';\n    if (lowerTags.some(t => t.includes('sfx') || t.includes('effect'))) return 'sfx';\n    return 'music'; // default\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Filtering & Sorting\n  // ─────────────────────────────────────────────────────────────\n\n  private applyFilters(items: LibraryItem[]): LibraryItem[] {\n    let filtered = items;\n\n    // Search filter\n    if (this.filterState.searchQuery) {\n      const query = this.filterState.searchQuery.toLowerCase();\n      filtered = filtered.filter(item =>\n        item.name.toLowerCase().includes(query) ||\n        item.tags.some(tag => tag.toLowerCase().includes(query))\n      );\n    }\n\n    // Channel filter (OR logic: Show item if its group is in selectedChannels)\n    // If no channels selected, show all items (default behavior)\n    if (this.filterState.selectedChannels.size > 0) {\n      filtered = filtered.filter(item => {\n        const group = (item.group || 'music') as TrackGroup;\n        return this.filterState.selectedChannels.has(group);\n      });\n    }\n    // If no channels selected, show all items (don't filter)\n\n    // Playlist filter\n    if (this.filterState.selectedPlaylistId) {\n      const playlist = this.library.playlists.getPlaylist(this.filterState.selectedPlaylistId);\n      if (playlist) {\n        const playlistItemIds = new Set(playlist.items.map(i => i.libraryItemId));\n        filtered = filtered.filter(item => playlistItemIds.has(item.id));\n      }\n    }\n\n    // Tags filter (AND logic - show items that have ALL selected tags)\n    if (this.filterState.selectedTags.size > 0) {\n      const selectedTagsArray = Array.from(this.filterState.selectedTags);\n      filtered = filtered.filter(item =>\n        selectedTagsArray.every(tag => item.tags.includes(tag))\n      );\n    }\n\n    return filtered;\n  }\n\n  private applySorting(items: LibraryItem[]): LibraryItem[] {\n    const sorted = [...items];\n\n    switch (this.filterState.sortBy) {\n      case 'playable': {\n        // Sort by playback state: playing first, paused second, rest by date\n        const viewDataCache = new Map<string, LibraryItemViewData>();\n        for (const item of sorted) {\n          viewDataCache.set(item.id, this.getItemViewData(item));\n        }\n\n        sorted.sort((a, b) => {\n          const aData = viewDataCache.get(a.id)!;\n          const bData = viewDataCache.get(b.id)!;\n\n          // Priority: playing > paused > stopped\n          const aPriority = aData.isPlaying ? 2 : (aData.isPaused ? 1 : 0);\n          const bPriority = bData.isPlaying ? 2 : (bData.isPaused ? 1 : 0);\n\n          if (aPriority !== bPriority) {\n            return bPriority - aPriority; // Higher priority first\n          }\n\n          // If same state, sort by date (newest first)\n          return b.addedAt - a.addedAt;\n        });\n        break;\n      }\n      case 'name-asc':\n        sorted.sort((a, b) => a.name.localeCompare(b.name));\n        break;\n      case 'name-desc':\n        sorted.sort((a, b) => b.name.localeCompare(a.name));\n        break;\n      case 'date-asc':\n        sorted.sort((a, b) => a.addedAt - b.addedAt);\n        break;\n      case 'date-desc':\n        sorted.sort((a, b) => b.addedAt - a.addedAt);\n        break;\n      case 'duration-asc':\n        sorted.sort((a, b) => a.duration - b.duration);\n        break;\n      case 'duration-desc':\n        sorted.sort((a, b) => b.duration - a.duration);\n        break;\n    }\n\n    return sorted;\n  }\n\n  override activateListeners(html: JQuery): void {\n    super.activateListeners(html);\n\n    // ═══════════════════════════════════════════════════════════════\n    // CRITICAL: Remove ALL namespaced event listeners to prevent memory leaks\n    // Using namespace ensures delegated handlers are also removed\n    // ═══════════════════════════════════════════════════════════════\n    html.off('.ase-library');\n\n    // ═══════════════════════════════════════════════════════════════\n    // Queue Change Listener - Register ONCE to update UI when queue changes\n    // ═══════════════════════════════════════════════════════════════\n    if (!this._queueListener && window.ASE?.queue) {\n      this._queueListener = () => {\n        // Debounce renders to prevent multiple rapid updates\n        if (this._renderDebounceTimer) {\n          clearTimeout(this._renderDebounceTimer);\n        }\n        this._renderDebounceTimer = window.setTimeout(() => {\n          this._renderDebounceTimer = null;\n          this.render(false, { renderContext: 'queue-update' });\n        }, 50); // 50ms debounce\n      };\n      window.ASE.queue.on('change', this._queueListener);\n    }\n\n    // ═══════════════════════════════════════════════════════════════\n    // GLOBAL delegated handlers - registered ONCE to prevent accumulation\n    // ═══════════════════════════════════════════════════════════════\n    if (!this._listenersInitialized) {\n      $(document).off('mousedown.ase-lib-global'); // Clean up any previous global handlers\n      $(document).on('mousedown.ase-lib-global', '#local-library [data-action]', (e) => {\n        console.log('ASE: Mousedown on action stopped propagation', e.currentTarget);\n        e.stopPropagation();\n      });\n      this._listenersInitialized = true;\n    }\n\n    // Toolbar actions\n    html.find('[data-action=\"add-track\"]').on('click.ase-library', this.onAddTrack.bind(this));\n    // Listen for KeyDown (Enter) for search execution\n    html.find('.ase-search-input').on('keydown.ase-library', this.onSearchKeydown.bind(this));\n    // Listen for 'input' to manage X button visibility and auto-reset on empty\n    html.find('.ase-search-input').on('input.ase-library', this.onSearchInput.bind(this));\n    html.find('.ase-search-clear').on('click.ase-library', this.onClearSearch.bind(this));\n    html.find('[data-action=\"filter-channel\"]').on('click.ase-library', this._onFilterChannel.bind(this));\n    html.find('[data-action=\"sort-change\"]').on('change.ase-library', this.onChangeSort.bind(this));\n    html.find('[data-action=\"clear-filters\"]').on('click.ase-library', this.onClearFilters.bind(this));\n\n    // Tag actions\n    html.find('[data-action=\"toggle-tag\"]').on('click.ase-library', this.onToggleTag.bind(this));\n    html.find('[data-action=\"add-tag\"]').on('click.ase-library', this.onAddTag.bind(this));\n\n    // Track actions\n    html.find('[data-action=\"play-track\"]').on('click.ase-library', this.onPlayTrack.bind(this));\n    html.find('[data-action=\"pause-track\"]').on('click.ase-library', this.onPauseTrack.bind(this));\n    html.find('[data-action=\"stop-track\"]').on('click.ase-library', this.onStopTrack.bind(this));\n    html.find('[data-action=\"add-to-queue\"]').on('click.ase-library', this.onAddToQueue.bind(this));\n    html.find('[data-action=\"toggle-favorite\"]').on('click.ase-library', this.onToggleFavorite.bind(this));\n    html.find('[data-action=\"add-to-playlist\"]').on('click.ase-library', this.onAddToPlaylist.bind(this));\n    html.find('[data-action=\"track-menu\"]').on('click.ase-library', this.onTrackMenu.bind(this));\n\n    // In-track tag management\n    html.find('[data-action=\"add-tag-to-track\"]').on('click.ase-library', this.onAddTagToTrack.bind(this));\n\n    // Channel dropdown\n    html.find('[data-action=\"channel-dropdown\"]').on('click.ase-library', this.onChannelDropdown.bind(this));\n\n    // Delete track\n    html.find('[data-action=\"delete-track\"]').on('click.ase-library', this.onDeleteTrack.bind(this));\n\n    // Track context menu (right-click)\n    html.find('.ase-track-player-item').on('contextmenu.ase-library', this.onTrackContext.bind(this));\n\n    // Tag context menu on track (right-click on tag)\n    html.find('.ase-track-tags .ase-tag').on('contextmenu.ase-library', this.onTrackTagContext.bind(this));\n\n    // Playlist actions\n    html.find('[data-action=\"select-playlist\"]').on('click.ase-library', this.onSelectPlaylist.bind(this));\n    html.find('[data-action=\"create-playlist\"]').on('click.ase-library', this.onCreatePlaylist.bind(this));\n    html.find('[data-action=\"toggle-playlist-favorite\"]').on('click.ase-library', this.onTogglePlaylistFavorite.bind(this));\n    html.find('[data-action=\"toggle-playlist-queue\"]').on('click.ase-library', this.onTogglePlaylistQueue.bind(this));\n    html.find('[data-action=\"play-playlist\"]').on('click.ase-library', this.onPlayPlaylist.bind(this)); // New handler\n\n    // Switch to direct binding for reliability\n    html.find('[data-action=\"playlist-mode-dropdown\"]').on('click.ase-library', this.onPlaylistModeClick.bind(this));\n    html.find('[data-action=\"track-mode-dropdown\"]').on('click.ase-library', this.onTrackModeClick.bind(this));\n\n    // NOTE: Moved mousedown handler to global delegation above to prevent accumulation\n\n    html.find('[data-action=\"playlist-menu\"]').on('click.ase-library', this.onPlaylistMenu.bind(this));\n    html.find('.ase-list-item[data-playlist-id]').on('contextmenu.ase-library', this.onPlaylistContext.bind(this));\n\n    // Favorite actions\n    html.find('[data-action=\"remove-from-favorites\"]').on('click.ase-library', this.onRemoveFromFavorites.bind(this));\n    html.find('[data-action=\"toggle-favorite-queue\"]').on('click.ase-library', this.onToggleFavoriteQueue.bind(this));\n\n    // Drag and drop\n    this.setupDragAndDrop(html);\n    this.setupFoundryDragDrop(html);\n\n    // Track hover highlighting for playlists\n    html.find('.ase-track-player-item').on('mouseenter.ase-library', (event: JQuery.MouseEnterEvent) => {\n      const trackId = $(event.currentTarget).data('item-id');\n      if (trackId) {\n        this.highlightPlaylistsContainingTrack(trackId);\n      }\n    });\n\n    html.find('.ase-track-player-item').on('mouseleave.ase-library', () => {\n      this.clearPlaylistHighlights();\n    });\n\n    // Custom Context Menu for GLOBAL tags only (in top panel)\n    html.find('.ase-tags-inline .ase-tag').on('contextmenu.ase-library', this.onTagContext.bind(this));\n\n    Logger.debug('LocalLibraryApp listeners activated');\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Event Handlers\n  // ─────────────────────────────────────────────────────────────\n\n  private async onAddTrack(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n\n    const fp = new FilePicker({\n      type: 'audio',\n      callback: async (path: string) => {\n        await this.addTrackFromPath(path);\n      }\n    });\n    fp.render(true);\n  }\n\n  private async addTrackFromPath(path: string, group: TrackGroup = 'music'): Promise<void> {\n    try {\n      // Get currently selected tags\n      const selectedTags = Array.from(this.filterState.selectedTags);\n\n      const item = await this.library.addItem(path, undefined, group, selectedTags);\n      if (this.parentApp) this.parentApp.captureScroll();\n      this.render();\n      ui.notifications?.info(`Added to library: ${item.name}`);\n    } catch (error) {\n      Logger.error('Failed to add track to library:', error);\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n      ui.notifications?.error(`Failed to add track: ${errorMessage}`);\n    }\n  }\n\n  private async onToggleFavorite(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const btn = $(event.currentTarget);\n    const itemId = btn.closest('[data-item-id]').data('item-id') as string;\n\n    try {\n      // Optimistic UI update for instant feedback\n      const icon = btn.find('i');\n      if (icon.hasClass('far')) {\n        icon.removeClass('far').addClass('fas active');\n        btn.addClass('active');\n      } else {\n        icon.removeClass('fas active').addClass('far');\n        btn.removeClass('active');\n      }\n\n      if (this.parentApp) this.parentApp.captureScroll();\n      const isFavorite = this.library.toggleFavorite(itemId);\n\n      // We still re-render to update the sidebar/state fully, but the button interaction felt instant\n      this.render();\n      ui.notifications?.info(isFavorite ? 'Added to favorites' : 'Removed from favorites');\n    } catch (error) {\n      Logger.error('Failed to toggle favorite:', error);\n      ui.notifications?.error('Failed to update favorite status');\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Playback Mode Handlers\n  // ─────────────────────────────────────────────────────────────\n\n  private onTrackModeClick(event: JQuery.ClickEvent): void {\n    event.preventDefault();\n    event.stopPropagation();\n    console.log('ASE: onTrackModeClick triggered', event.currentTarget);\n\n    const btn = $(event.currentTarget);\n    // Support both direct data on icon (new) and wrapper (legacy fallback)\n    let itemId = btn.data('item-id') as string;\n    if (!itemId) {\n      itemId = btn.closest('[data-item-id]').data('item-id') as string;\n    }\n    console.log('ASE: Resolved Item ID:', itemId);\n\n    const item = this.library.getItem(itemId);\n    if (!item) {\n      console.warn(`ASE: Track Mode Clicked: Item not found for ID ${itemId}`);\n      return;\n    }\n    console.log(`ASE: Found item ${item.name}`);\n\n    const modes: { label: string, value: string, icon: string }[] = [\n      { label: 'Inherit (Default)', value: 'inherit', icon: 'fa-arrow-turn-down' },\n      { label: 'Loop', value: 'loop', icon: 'fa-repeat' },\n      { label: 'Single', value: 'single', icon: 'fa-arrow-right-to-line' },\n      { label: 'Linear', value: 'linear', icon: 'fa-arrow-right' },\n      { label: 'Random', value: 'random', icon: 'fa-shuffle' }\n    ];\n\n    this.showModeContextMenu(event, modes, (mode) => {\n      this.library.updateItem(itemId, { playbackMode: mode as any });\n      this.render();\n    });\n  }\n\n  private onPlaylistModeClick(event: JQuery.ClickEvent): void {\n    event.preventDefault();\n    event.stopPropagation();\n    Logger.debug('Playlist Mode Clicked'); // Debug\n    const btn = $(event.currentTarget);\n    // Support both direct data on icon (new) and wrapper (legacy fallback)\n    let playlistId = btn.data('playlist-id') as string;\n    if (!playlistId) {\n      playlistId = btn.closest('[data-playlist-id]').data('playlist-id') as string;\n    }\n    const playlist = this.library.playlists.getPlaylist(playlistId);\n    if (!playlist) {\n      Logger.warn(`Playlist Mode Clicked: Playlist not found for ID ${playlistId}`);\n      return;\n    }\n    Logger.debug(`Playlist Mode Clicked: Found playlist ${playlist.name} (${playlist.id})`);\n\n    const modes: { label: string, value: string, icon: string }[] = [\n      { label: 'Loop (Default)', value: 'loop', icon: 'fa-repeat' },\n      { label: 'Linear', value: 'linear', icon: 'fa-arrow-right' },\n      { label: 'Random', value: 'random', icon: 'fa-shuffle' }\n    ];\n\n    this.showModeContextMenu(event, modes, (mode) => {\n      this.library.playlists.updatePlaylist(playlistId, { playbackMode: mode as any });\n      this.render();\n    });\n  }\n\n  private showModeContextMenu(event: JQuery.ClickEvent, modes: any[], callback: (mode: string) => void): void {\n    const menuHtml = `\n        <div id=\"ase-mode-menu\" class=\"ase-context-menu\">\n          ${modes.map(m => `\n            <div class=\"ase-ctx-item\" data-value=\"${m.value}\">\n                <i class=\"fa-solid ${m.icon}\"></i> \n                <span>${m.label}</span>\n            </div>\n          `).join('')}\n        </div>\n      `;\n\n    $('#ase-mode-menu').remove();\n    const menu = $(menuHtml);\n    $('body').append(menu);\n\n    menu.css({ top: event.clientY, left: event.clientX });\n\n    menu.find('.ase-ctx-item').on('click', (e) => {\n      e.stopPropagation(); // prevent body click from firing immediately\n      const val = $(e.currentTarget).data('value');\n      Logger.debug(`Mode Selected: ${val}`);\n      callback(val);\n      menu.remove();\n    });\n\n    // Close on click outside\n    setTimeout(() => {\n      $('body').one('click', () => {\n        Logger.debug('Mode Menu: Closed by outside click');\n        menu.remove();\n      });\n    }, 10);\n  }\n\n\n\n  private async onPlayPlaylist(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n    event.stopPropagation();\n    const playlistId = $(event.currentTarget).closest('[data-playlist-id]').data('playlist-id') as string;\n    const playlist = this.library.playlists.getPlaylist(playlistId);\n\n    if (playlist && playlist.items.length > 0) {\n\n      const queue = window.ASE?.queue;\n      if (queue) {\n        // 1. Add playlist items to queue (Append, do not clear)\n        const addedItems = queue.addPlaylist(playlistId, playlist.items);\n\n        // 2. Determine start track logic\n        if (addedItems.length > 0) {\n          let startItem = addedItems[0];\n\n          // Handle Random Start if mode is random\n          if (playlist.playbackMode === 'random' && addedItems.length > 1) {\n            const randomIndex = Math.floor(Math.random() * addedItems.length);\n            startItem = addedItems[randomIndex];\n          }\n\n          // 3. Play the track immediately\n          const libItem = this.library.getItem(startItem.libraryItemId);\n          if (libItem) {\n            await (window.ASE.engine as any).playTrack(libItem.id, 0, { type: 'playlist', id: playlistId });\n          }\n        }\n\n        ui.notifications?.info(`Playing playlist: ${playlist.name}`);\n        this.render();\n      } else {\n        console.warn(\"ASE: Queue Manager not available\");\n        let trackToPlay = playlist.items[0];\n        const libItem = this.library.getItem(trackToPlay.libraryItemId);\n        if (libItem) {\n          await (window.ASE.engine as any).playTrack(libItem.id, 0, { type: 'playlist', id: playlistId });\n        }\n      }\n    } else {\n      ui.notifications?.warn('Playlist is empty');\n    }\n  }\n\n\n\n\n  // ─────────────────────────────────────────────────────────────\n  // Playlist Event Handlers\n  // ─────────────────────────────────────────────────────────────\n\n  private async onCreatePlaylist(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n\n    const name = await this.promptPlaylistName();\n    if (!name) return;\n\n    try {\n      const playlist = this.library.playlists.createPlaylist(name);\n      // Create playlist -> might want to scroll to it? Or keep position?\n      // User: \"actions in zone of tracks\". Playlists are separate zone. \n      // But adding playlist shouldn't jump list to top? Let's persist.\n      if (this.parentApp) this.parentApp.captureScroll();\n      this.render();\n      ui.notifications?.info(`Created playlist: ${playlist.name}`);\n    } catch (error) {\n      Logger.error('Failed to create playlist:', error);\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n      ui.notifications?.error(`Failed to create playlist: ${errorMessage}`);\n    }\n  }\n\n  private async onTogglePlaylistFavorite(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const playlistId = $(event.currentTarget).closest('[data-playlist-id]').data('playlist-id') as string;\n\n    try {\n      if (this.parentApp) this.parentApp.captureScroll();\n      const isFavorite = this.library.playlists.togglePlaylistFavorite(playlistId);\n      this.render();\n      ui.notifications?.info(isFavorite ? 'Added to favorites' : 'Removed from favorites');\n    } catch (error) {\n      Logger.error('Failed to toggle playlist favorite:', error);\n      ui.notifications?.error('Failed to update favorite status');\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Toolbar Event Handlers\n  // ─────────────────────────────────────────────────────────────\n\n  private onSearchInput(event: JQuery.TriggeredEvent): void {\n    const val = ($(event.currentTarget).val() as string || '');\n    const trimmedVal = val.trim();\n\n    // If field becomes empty and search was active, reset search\n    if (!trimmedVal && this.filterState.searchQuery) {\n      this.filterState.searchQuery = '';\n      this.render(false, { resetScroll: true });\n    }\n  }\n\n  private onSearchKeydown(event: JQuery.KeyDownEvent): void {\n    if (event.key === 'Enter') {\n      event.preventDefault();\n      const query = ($(event.currentTarget).val() as string || '').trim().toLowerCase();\n      if (this.filterState.searchQuery !== query) {\n        this.filterState.searchQuery = query;\n        this.render(false, { resetScroll: true });\n      }\n    }\n  }\n\n  private onClearSearch(event: JQuery.ClickEvent): void {\n    event.preventDefault();\n    this.filterState.searchQuery = '';\n    const wrapper = $(event.currentTarget).closest('.ase-search-input-wrapper');\n    wrapper.find('.ase-search-input').val('');\n    wrapper.find('.ase-search-input').val('');\n    this.render(false, { resetScroll: true }); // Re-render to show all items\n  }\n\n  private _onFilterChannel(event: JQuery.ClickEvent): void {\n    event.preventDefault();\n    const btn = $(event.currentTarget);\n    const channel = btn.data('channel') as TrackGroup;\n\n    // Toggle logic: If clicked, toggle it.\n    if (this.filterState.selectedChannels.has(channel)) {\n      this.filterState.selectedChannels.delete(channel);\n      btn.removeClass('active');\n    } else {\n      this.filterState.selectedChannels.add(channel);\n      btn.addClass('active');\n    }\n\n    // Pass true to force render because complex logic might need re-evaluation of the list\n    // OR implement client-side hiding for this too if feeling brave. \n    // Given 3 checkboxes, re-render is safer to ensure correct combinatorics.\n    // Given 3 checkboxes, re-render is safer to ensure correct combinatorics.\n    this.render(false, { resetScroll: true });\n    Logger.debug('Filter channel toggled:', channel, this.filterState.selectedChannels);\n  }\n\n  private onChangeSort(event: JQuery.ChangeEvent): void {\n    const sortValue = $(event.currentTarget).val() as FilterState['sortBy'];\n    this.filterState.sortBy = sortValue;\n    this.render();\n    Logger.debug('Sort changed:', sortValue);\n  }\n\n  private onClearFilters(event: JQuery.ClickEvent): void {\n    event.preventDefault();\n\n    // Reset all filters except channels (as requested: \"clear button... resets all except sound channels\")\n    this.filterState.searchQuery = '';\n    this.filterState.selectedPlaylistId = null;\n    this.filterState.selectedTags.clear();\n\n    // channels remain as is? \"Kнопка clear... сбрасывает все фильтры кроме каналов звука\"\n    // \"All Tracks\" button usually means SHOW ALL. \n    // IF the button is named \"All Tracks\" (in template it is \"Clear Filters\" or similar?), let's verify.\n    // Template says: <button ... data-action=\"clear-filters\">All Tracks</button>\n    // So YES, it should reset eveything relative to \"viewing a slice\", but the user EXPLICITLY said:\n    // \"except sound channels... they work separately\".\n\n    // So we DO NOT reset selectedChannels.\n\n    this.render(false, { resetScroll: true });\n    ui.notifications?.info('Filters cleared (Channels preserved)');\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Tag Event Handlers\n  // ─────────────────────────────────────────────────────────────\n\n  private onToggleTag(event: JQuery.ClickEvent): void {\n    event.preventDefault();\n    // Use the right click context menu for edit/delete\n    // Left click just toggles filter\n    const tag = String($(event.currentTarget).data('tag')); // String() fixes numeric coercion\n\n    console.log('[ASE] onToggleTag called with tag:', tag);\n    console.log('[ASE] Current selectedTags:', Array.from(this.filterState.selectedTags));\n\n    if (this.filterState.selectedTags.has(tag)) {\n      this.filterState.selectedTags.delete(tag);\n      console.log('[ASE] Tag deselected');\n    } else {\n      this.filterState.selectedTags.add(tag);\n      console.log('[ASE] Tag selected');\n    }\n\n    this.render(false, { resetScroll: true });\n  }\n\n  private onTagContext(event: JQuery.ContextMenuEvent): void {\n    event.preventDefault();\n    event.stopPropagation();\n    const tag = String($(event.currentTarget).data('tag')); // String() fixes numeric coercion\n\n    // Create a custom context menu appended to body to avoid clipping\n    const menuHtml = `\n      <div id=\"ase-custom-context-menu\" style=\"position: fixed; z-index: 10000; background: #222; border: 1px solid #444; border-radius: 4px; padding: 5px 0;\">\n        <div class=\"ase-ctx-item\" data-action=\"edit\" style=\"padding: 5px 15px; cursor: pointer; color: white;\">\n            <i class=\"fas fa-edit\" style=\"margin-right: 5px;\"></i> Edit\n        </div>\n        <div class=\"ase-ctx-item\" data-action=\"delete\" style=\"padding: 5px 15px; cursor: pointer; color: #ff6666;\">\n            <i class=\"fas fa-trash\" style=\"margin-right: 5px;\"></i> Delete\n        </div>\n      </div>\n    `;\n\n    // Remove existing\n    $('#ase-custom-context-menu').remove();\n\n    const menu = $(menuHtml);\n    $('body').append(menu);\n\n    // Position\n    menu.css({\n      top: event.clientY,\n      left: event.clientX\n    });\n\n    // Handlers\n    menu.find('[data-action=\"edit\"]').on('click', () => {\n      this.renameTag(tag);\n      menu.remove();\n    });\n\n    menu.find('[data-action=\"delete\"]').on('click', () => {\n      this.deleteTag(tag);\n      menu.remove();\n    });\n\n    // Initial Hover effect\n    menu.find('.ase-ctx-item').hover(\n      function () { $(this).css('background', '#333'); },\n      function () { $(this).css('background', 'transparent'); }\n    );\n\n    // Close on click elsewhere\n    $(document).one('click', () => {\n      menu.remove();\n    });\n\n    console.log('Opened context menu for tag:', tag);\n  }\n\n  private async onAddTag(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n\n    const rawTagName = await this.promptTagName();\n    if (!rawTagName) return;\n\n    // Normalize: trim and remove leading # if user added it\n    const tagName = rawTagName.trim().replace(/^#/, '');\n    if (!tagName) return;\n\n    console.log('[ASE] onAddTag: normalized tagName =', tagName);\n\n    // Add to selectedTags for immediate visual feedback\n    this.filterState.selectedTags.add(tagName);\n\n    // Add to library persistent tags\n    this.library.addCustomTag(tagName);\n\n    console.log('[ASE] onAddTag: selectedTags now =', Array.from(this.filterState.selectedTags));\n    console.log('[ASE] onAddTag: allTags from library =', this.library.getAllTags());\n\n    this.render();\n    ui.notifications?.info(`Tag \"${tagName}\" added.`);\n  }\n\n  // Helper for Context Menu Callbacks to ensure `this` binding and argument passing\n  private _onRenameTag(header: JQuery): void {\n    const tag = header.data('tag');\n    this.renameTag(tag);\n  }\n\n  private _onDeleteTag(header: JQuery): void {\n    const tag = header.data('tag');\n    this.deleteTag(tag);\n  }\n\n  // Correcting selector/listener activation for Context Menu if needed\n  // Foundry ContextMenu usually works fine. If z-index issue, it's CSS.\n  // We will force high z-index via CSS injection or ensure fixed position.\n  // BUT: user said \"Buttons don't work\". \n  // This usually means the callback failed or `this` yielded undefined.\n  // The inline arrow functions `() => this.renameTag(tag)` in `activateListeners` SHOULD be fine if `this` is correct.\n  // Let's verify `activateListeners`.\n\n  // ─────────────────────────────────────────────────────────────\n  // Tag Management Logic\n  // ─────────────────────────────────────────────────────────────\n\n  private async renameTag(oldTag: string): Promise<void> {\n    const newTag = await this.promptTagName(oldTag);\n    if (!newTag || newTag === oldTag) return;\n\n    // Use LibraryManager's method\n    const count = this.library.renameTag(oldTag, newTag);\n\n    // Also update filter state if selected\n    if (this.filterState.selectedTags.has(oldTag)) {\n      this.filterState.selectedTags.delete(oldTag);\n      this.filterState.selectedTags.add(newTag);\n    }\n\n    if (count > 0) {\n      // Renaming tag does not necessarily keep scroll unless it was a tag list interaction?\n      // User said \"zone of tracks with tracks\". Tag list is separate. \n      // But renaming right from track context menu? Let's enabling it generally.\n      // Actually user said \"zone of tracks\". Let's persist.\n      if (this.parentApp) this.parentApp.captureScroll();\n      this.render();\n      ui.notifications?.info(`Renamed tag \"${oldTag}\" to \"${newTag}\" on ${count} tracks.`);\n    }\n  }\n\n  private async deleteTag(tag: string): Promise<void> {\n    const tagStr = String(tag); // Ensure string for numeric tags\n    console.log('[ASE] deleteTag called for:', tagStr);\n\n    const confirm = await Dialog.confirm({\n      title: \"Delete Tag\",\n      content: `Are you sure you want to delete tag \"${tagStr}\" from all tracks?`\n    });\n    if (!confirm) return;\n\n    // Use LibraryManager's method\n    const count = this.library.deleteTag(tagStr);\n\n    // Remove from filter\n    this.filterState.selectedTags.delete(tagStr);\n\n    // Always re-render\n    if (this.parentApp) this.parentApp.captureScroll();\n    this.render();\n    ui.notifications?.info(count > 0 ? `Deleted tag \"${tagStr}\" from ${count} tracks.` : `Deleted custom tag \"${tagStr}\".`);\n  }\n\n  private async promptTagName(current: string = \"\"): Promise<string | null> {\n    return new Promise((resolve) => {\n      new Dialog({\n        title: current ? \"Rename Tag\" : \"New Tag\",\n        content: `<input type=\"text\" id=\"tag-name\" value=\"${current}\" style=\"width:100%;box-sizing:border-box;\"/>`,\n        buttons: {\n          ok: {\n            label: \"OK\",\n            callback: (html: JQuery) => resolve(html.find('#tag-name').val() as string)\n          }\n        },\n        default: \"ok\",\n        close: () => resolve(null)\n      }).render(true);\n    });\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Track Event Handlers (Extended)\n  // ─────────────────────────────────────────────────────────────\n\n  private async onPlayTrack(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n    event.stopPropagation();\n    const itemId = $(event.currentTarget).data('item-id') as string;\n\n    // Determine context based on current view\n    let context: any = { type: 'track' };\n    if (this.filterState.selectedPlaylistId) {\n      context = { type: 'playlist', id: this.filterState.selectedPlaylistId };\n    }\n\n    // Pass 'track' context\n    // Using cast for engine to support optional context arg until types catch up if needed\n    await (window.ASE.engine as any).playTrack(itemId, 0, context);\n    this.render();\n\n    const item = this.library.getItem(itemId);\n    if (!item) {\n      Logger.warn('Track not found:', itemId);\n      return;\n    }\n\n    // Get engine and queue from window.ASE\n    const engine = window.ASE?.engine;\n    const queue = window.ASE?.queue;\n\n    if (!engine) {\n      Logger.warn('Audio engine not available');\n      return;\n    }\n\n    // Add to queue if not already there\n    if (queue && !queue.hasItem(itemId)) {\n      queue.addItem(itemId, {\n        group: item.group,\n        volume: 1\n      });\n    }\n\n    // Get or create player\n    let player = (engine as any).getTrack?.(itemId);\n    if (!player) {\n      player = await (engine as any).createTrack?.({\n        id: itemId,\n        url: item.url,\n        group: item.group,\n        volume: 1\n      });\n    }\n\n    // Check if track is paused and get current position\n    let offset = 0;\n    if (player && player.state === 'paused') {\n      offset = player.getCurrentTime();\n    }\n\n    // Play the track (resume from offset if paused)\n    await (engine as any).playTrack?.(itemId, offset);\n\n    // Sync if enabled\n    const socket = window.ASE?.socket;\n    if (socket && socket.syncEnabled) {\n      Logger.debug('LocalLibrary: Broadcasting Play for track', itemId);\n      socket.broadcastTrackPlay(itemId, offset);\n    }\n\n    if (this.parentApp) this.parentApp.captureScroll();\n    this.render();\n  }\n\n  private onStopTrack(event: JQuery.ClickEvent): void {\n    event.preventDefault();\n    event.stopPropagation();\n    const itemId = $(event.currentTarget).data('item-id') as string;\n\n    Logger.debug('Stop track:', itemId);\n\n    // Stop the track\n    window.ASE.engine?.stopTrack(itemId);\n\n    // Sync if enabled\n    const socket = window.ASE?.socket;\n    if (socket && socket.syncEnabled) {\n      socket.broadcastTrackStop(itemId);\n    }\n\n    // Remove from queue\n    if (window.ASE?.queue) {\n      window.ASE.queue.removeByLibraryItemId(itemId);\n    }\n\n    if (this.parentApp) this.parentApp.captureScroll();\n    this.render();\n  }\n\n  private onPauseTrack(event: JQuery.ClickEvent): void {\n    event.preventDefault();\n    event.stopPropagation();\n    const itemId = $(event.currentTarget).data('item-id') as string;\n    console.log('[ASE DEBUG] onPauseTrack called for:', itemId);\n\n    // Get current time before pausing for sync\n    const engine = window.ASE?.engine;\n    const player = (engine as any)?.getTrack?.(itemId);\n    const currentTime = player?.getCurrentTime() ?? 0;\n    console.log('[ASE DEBUG] Pause - currentTime:', currentTime, 'player state:', player?.state);\n\n    engine?.pauseTrack(itemId);\n\n    // Sync if enabled\n    const socket = window.ASE?.socket;\n    console.log('[ASE DEBUG] Socket syncEnabled:', socket?.syncEnabled);\n    if (socket && socket.syncEnabled) {\n      console.log('[ASE DEBUG] Broadcasting pause for', itemId);\n      socket.broadcastTrackPause(itemId, currentTime);\n    }\n\n    if (this.parentApp) this.parentApp.captureScroll();\n    this.render(); // Update UI and bottom panel indicators\n  }\n\n  private onAddToQueue(event: JQuery.ClickEvent): void {\n    event.preventDefault();\n    event.stopPropagation();\n    const itemId = String($(event.currentTarget).data('item-id'));\n\n    if (!window.ASE?.queue) {\n      Logger.warn('Queue manager not available');\n      return;\n    }\n\n    // Get item details to determine group\n    const item = this.library.getItem(itemId);\n    if (!item) {\n      Logger.warn('Item not found:', itemId);\n      return;\n    }\n\n    // Toggle: if already in queue, remove; otherwise add\n    if (window.ASE.queue.hasItem(itemId)) {\n      window.ASE.queue.removeByLibraryItemId(itemId);\n      Logger.debug('Removed from queue:', itemId);\n      ui.notifications?.info(`\"${item.name}\" removed from queue`);\n    } else {\n      window.ASE.queue.addItem(itemId, {\n        group: item.group || 'music',\n        volume: 1\n      });\n      Logger.debug('Added to queue:', itemId);\n      ui.notifications?.info(`\"${item.name}\" added to queue`);\n    }\n\n    if (this.parentApp) this.parentApp.captureScroll();\n    this.render();\n  }\n\n  private async onAddTagToTrack(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n    event.stopPropagation();\n    const itemId = $(event.currentTarget).data('item-id') as string;\n    Logger.debug('Add tag to track:', itemId);\n\n    // Open tag editor dialog\n    this.showTagEditor(itemId);\n  }\n\n  private async onAddToPlaylist(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n    event.stopPropagation();\n    const itemId = $(event.currentTarget).data('item-id') as string;\n    const item = this.library.getItem(itemId);\n\n    if (!item) {\n      ui.notifications?.error('Track not found');\n      return;\n    }\n\n    const playlists = this.library.playlists.getAllPlaylists();\n    if (playlists.length === 0) {\n      ui.notifications?.warn('No playlists available. Create one first.');\n      return;\n    }\n\n    // Show playlist selection dialog\n    const selectedPlaylistId = await this.promptPlaylistSelection(playlists);\n    if (!selectedPlaylistId) return;\n\n    try {\n      const group = this.inferGroupFromTags(item.tags) as TrackGroup;\n      this.library.playlists.addTrackToPlaylist(selectedPlaylistId, itemId, group);\n      this.render();\n      ui.notifications?.info(`Added \"${item.name}\" to playlist`);\n    } catch (error) {\n      Logger.error('Failed to add track to playlist:', error);\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n      ui.notifications?.error(`Failed to add to playlist: ${errorMessage}`);\n    }\n  }\n\n  private onTrackMenu(event: JQuery.ClickEvent): void {\n    event.preventDefault();\n    event.stopPropagation();\n    // Context menu is now handled by right-click\n    // This button can trigger the same menu programmatically\n    const itemId = $(event.currentTarget).data('item-id') as string;\n    const trackElement = $(event.currentTarget).closest('.ase-track-player-item');\n\n    // Trigger a contextmenu event on the track item\n    const contextMenuEvent = new MouseEvent('contextmenu', {\n      bubbles: true,\n      cancelable: true,\n      view: window,\n      clientX: event.clientX,\n      clientY: event.clientY\n    });\n    trackElement[0]?.dispatchEvent(contextMenuEvent);\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Favorites Event Handlers\n  // ─────────────────────────────────────────────────────────────\n\n  private onRemoveFromFavorites(event: JQuery.ClickEvent): void {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const favoriteId = String($(event.currentTarget).data('favorite-id'));\n    const favoriteType = String($(event.currentTarget).data('favorite-type'));\n\n    Logger.debug('Remove from favorites:', favoriteId, favoriteType);\n\n    if (favoriteType === 'playlist') {\n      const playlist = this.library.playlists.getPlaylist(favoriteId);\n      if (playlist) {\n        this.library.playlists.updatePlaylist(favoriteId, { favorite: false });\n        ui.notifications?.info(`Removed \"${playlist.name}\" from favorites`);\n      }\n    } else {\n      const item = this.library.getItem(favoriteId);\n      if (item) {\n        this.library.toggleFavorite(favoriteId);\n        ui.notifications?.info(`Removed \"${item.name}\" from favorites`);\n      }\n    }\n\n    if (this.parentApp) this.parentApp.captureScroll();\n    this.render();\n  }\n\n  private onToggleFavoriteQueue(event: JQuery.ClickEvent): void {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const favoriteId = String($(event.currentTarget).data('favorite-id'));\n    const favoriteType = String($(event.currentTarget).data('favorite-type'));\n\n    if (!window.ASE?.queue) {\n      Logger.warn('Queue manager not available');\n      return;\n    }\n\n    if (favoriteType === 'playlist') {\n      // Delegate to playlist queue handler\n      const playlist = this.library.playlists.getPlaylist(favoriteId);\n      if (!playlist) return;\n\n      const inQueue = window.ASE.queue.getItems().some(item => item.playlistId === favoriteId);\n\n      if (inQueue) {\n        const itemsToRemove = window.ASE.queue.getItems().filter(item => item.playlistId === favoriteId);\n        itemsToRemove.forEach(item => window.ASE!.queue!.removeItem(item.id));\n        ui.notifications?.info(`Removed \"${playlist.name}\" from queue`);\n      } else {\n        const playlistItems = playlist.items.map(pItem => ({\n          libraryItemId: pItem.libraryItemId,\n          group: pItem.group || 'music' as const,\n          volume: pItem.volume\n        }));\n        window.ASE.queue.addPlaylist(favoriteId, playlistItems);\n        ui.notifications?.info(`Added \"${playlist.name}\" to queue`);\n      }\n    } else {\n      // Track\n      const item = this.library.getItem(favoriteId);\n      if (!item) return;\n\n      const inQueue = window.ASE.queue.hasItem(favoriteId);\n\n      if (inQueue) {\n        const queueItems = window.ASE.queue.getItems().filter(q => q.libraryItemId === favoriteId);\n        queueItems.forEach(q => window.ASE!.queue!.removeItem(q.id));\n        ui.notifications?.info(`Removed \"${item.name}\" from queue`);\n      } else {\n        window.ASE.queue.addItem(favoriteId, {\n          group: this.inferGroupFromTags(item.tags) as any,\n          volume: 1\n        });\n        ui.notifications?.info(`Added \"${item.name}\" to queue`);\n      }\n    }\n\n    if (this.parentApp) this.parentApp.captureScroll();\n    this.render();\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Track Control Handlers\n  // ─────────────────────────────────────────────────────────────\n\n  private onChannelDropdown(event: JQuery.ClickEvent): void {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const itemId = String($(event.currentTarget).data('item-id'));\n    const item = this.library.getItem(itemId);\n    if (!item) return;\n\n    const currentGroup = item.group || 'music';\n    const channels = ['music', 'ambience', 'sfx'];\n\n    // Create dropdown menu\n    // Using .ase-dropdown-menu class defined in SCSS\n    const menu = $(`\n      <div class=\"ase-dropdown-menu\">\n        ${channels.map(ch => `\n          <div class=\"ase-dropdown-item ${ch === currentGroup ? 'active' : ''}\" data-channel=\"${ch}\">\n            ${ch.charAt(0).toUpperCase() + ch.slice(1)}\n          </div>\n        `).join('')}\n      </div>\n    `);\n\n    const rect = (event.currentTarget as HTMLElement).getBoundingClientRect();\n    menu.css({ top: rect.bottom + 2, left: rect.left });\n\n    $('body').append(menu);\n\n    menu.find('.ase-dropdown-item').on('click', (e) => {\n      const newChannel = $(e.currentTarget).data('channel') as string;\n      this.updateTrackChannel(itemId, newChannel);\n      menu.remove();\n    });\n\n    // Close on outside click\n    setTimeout(() => {\n      $(document).one('click', () => menu.remove());\n    }, 10);\n  }\n\n  private updateTrackChannel(itemId: string, channel: string): void {\n    const item = this.library.getItem(itemId);\n    if (!item) return;\n\n    // Update group field directly (not as a tag)\n    this.library.updateItem(itemId, { group: channel as TrackGroup });\n    if (this.parentApp) this.parentApp.captureScroll();\n    this.render();\n    ui.notifications?.info(`Channel set to ${channel}`);\n  }\n\n  private onDeleteTrack(event: JQuery.ClickEvent): void {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const itemId = String($(event.currentTarget).data('item-id'));\n    const item = this.library.getItem(itemId);\n    if (!item) return;\n\n    const isInPlaylist = !!this.filterState.selectedPlaylistId;\n\n    const dialogData: any = {\n      title: isInPlaylist ? 'Manage Track' : 'Delete Track',\n      content: `<p>${isInPlaylist ? `What would you like to do with \"${item.name}\"?` : `Are you sure you want to delete \"${item.name}\"?`}</p>`,\n      buttons: {},\n      default: 'cancel'\n    };\n\n    if (isInPlaylist) {\n      dialogData.buttons.removeFromPlaylist = {\n        icon: '<i class=\"fas fa-minus-circle\"></i>',\n        label: 'Remove from Playlist',\n        callback: () => {\n          if (this.filterState.selectedPlaylistId) {\n            this.removeTrackFromPlaylist(this.filterState.selectedPlaylistId, itemId);\n          }\n        }\n      };\n    }\n\n    dialogData.buttons.delete = {\n      icon: '<i class=\"fas fa-trash\"></i>',\n      label: isInPlaylist ? 'Delete Track (Global)' : 'Delete',\n      callback: () => {\n        this.library.removeItem(itemId);\n        if (this.parentApp) this.parentApp.captureScroll();\n        this.render();\n        ui.notifications?.info(`Deleted \"${item.name}\"`);\n      }\n    };\n\n    dialogData.buttons.cancel = {\n      icon: '<i class=\"fas fa-times\"></i>',\n      label: 'Cancel'\n    };\n\n    new Dialog(dialogData).render(true);\n  }\n\n  private onTrackContext(event: JQuery.ContextMenuEvent): void {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const itemId = String($(event.currentTarget).data('item-id'));\n    const item = this.library.getItem(itemId);\n    if (!item) return;\n\n    // Remove existing menus\n    $('.ase-context-menu').remove();\n\n    const isInPlaylist = !!this.filterState.selectedPlaylistId;\n    const deleteLabel = 'Delete Track';\n\n    let menuHtml = `\n      <div class=\"ase-context-menu\">\n        <div class=\"ase-menu-item\" data-action=\"rename\">\n          <i class=\"fa-solid fa-pen\"></i> Rename\n        </div>\n        <div class=\"ase-menu-item\" data-action=\"add-to-playlist\">\n          <i class=\"fa-solid fa-list\"></i> Add to Playlist\n        </div>`;\n\n    if (isInPlaylist) {\n      menuHtml += `\n        <div class=\"ase-menu-item\" data-action=\"remove-from-playlist\">\n          <i class=\"fa-solid fa-minus-circle\"></i> Remove from Playlist\n        </div>`;\n    }\n\n    menuHtml += `\n        <div class=\"ase-menu-item\" data-action=\"edit-tags\">\n          <i class=\"fa-solid fa-tags\"></i> Edit Tags\n        </div>\n        <div class=\"ase-menu-separator\"></div>\n        <div class=\"ase-menu-item\" data-action=\"delete\">\n          <i class=\"fa-solid fa-trash\"></i> ${deleteLabel}\n        </div>\n      </div>\n    `;\n\n    const menu = $(menuHtml);\n\n    menu.css({ top: event.clientY, left: event.clientX });\n    $('body').append(menu);\n\n    menu.find('[data-action=\"rename\"]').on('click', async () => {\n      menu.remove();\n      await this.renameTrack(itemId);\n    });\n\n    menu.find('[data-action=\"add-to-playlist\"]').on('click', async () => {\n      menu.remove();\n      await this.addTrackToPlaylistDialog(itemId);\n    });\n\n    if (isInPlaylist) {\n      menu.find('[data-action=\"remove-from-playlist\"]').on('click', async () => {\n        menu.remove();\n        if (this.filterState.selectedPlaylistId) {\n          await this.removeTrackFromPlaylist(this.filterState.selectedPlaylistId, itemId);\n        }\n      });\n    }\n\n    menu.find('[data-action=\"edit-tags\"]').on('click', () => {\n      menu.remove();\n      this.showTagEditor(itemId);\n    });\n\n    menu.find('[data-action=\"delete\"]').on('click', () => {\n      menu.remove();\n      this.onDeleteTrack({ preventDefault: () => { }, stopPropagation: () => { }, currentTarget: $(`<div data-item-id=\"${itemId}\">`)[0] } as any);\n    });\n\n    setTimeout(() => {\n      $(document).one('click', () => menu.remove());\n    }, 10);\n  }\n\n  private onTrackTagContext(event: JQuery.ContextMenuEvent): void {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const tagName = String($(event.currentTarget).data('tag'));\n    const itemId = String($(event.currentTarget).data('item-id'));\n\n    $('.ase-context-menu').remove();\n\n    const menu = $(`\n      <div class=\"ase-context-menu\" style=\"position: fixed; z-index: 9999; background: #1e283d; border: 1px solid #334155; border-radius: 4px; min-width: 120px; box-shadow: 0 4px 12px rgba(0,0,0,0.4);\">\n        <div class=\"ase-menu-item\" data-action=\"remove-tag\" style=\"padding: 8px 12px; cursor: pointer; color: #f87171; font-size: 12px;\">\n          <i class=\"fa-solid fa-times\" style=\"width: 16px;\"></i> Remove Tag\n        </div>\n      </div>\n    `);\n\n    menu.css({ top: event.clientY, left: event.clientX });\n    $('body').append(menu);\n\n    menu.find('.ase-menu-item').on('mouseenter', (e) => $(e.currentTarget).css('background', '#2d3a52'));\n    menu.find('.ase-menu-item').on('mouseleave', (e) => $(e.currentTarget).css('background', 'transparent'));\n\n    menu.find('[data-action=\"remove-tag\"]').on('click', () => {\n      menu.remove();\n      this.library.removeTagFromItem(itemId, tagName);\n      if (this.parentApp) this.parentApp.captureScroll();\n      this.render();\n      ui.notifications?.info(`Removed tag \"${tagName}\"`);\n    });\n\n    setTimeout(() => {\n      $(document).one('click', () => menu.remove());\n    }, 10);\n  }\n\n  private async renameTrack(itemId: string): Promise<void> {\n    const item = this.library.getItem(itemId);\n    if (!item) return;\n\n    const newName = await this.promptInput('Rename Track', 'Track Name:', item.name);\n    if (newName && newName !== item.name) {\n      this.library.updateItem(itemId, { name: newName });\n      if (this.parentApp) this.parentApp.captureScroll();\n      this.render();\n      ui.notifications?.info(`Renamed to \"${newName}\"`);\n    }\n  }\n\n  private async addTrackToPlaylistDialog(itemId: string): Promise<void> {\n    const playlists = this.library.playlists.getAllPlaylists();\n    if (playlists.length === 0) {\n      ui.notifications?.warn('No playlists available. Create one first.');\n      return;\n    }\n\n    const selectedPlaylistId = await this.promptPlaylistSelection(playlists);\n    if (!selectedPlaylistId) return;\n\n    const item = this.library.getItem(itemId);\n    if (!item) return;\n\n    const group = this.inferGroupFromTags(item.tags) as TrackGroup;\n    this.library.playlists.addTrackToPlaylist(selectedPlaylistId, itemId, group);\n    if (this.parentApp) this.parentApp.captureScroll();\n    this.render();\n    ui.notifications?.info(`Added \"${item.name}\" to playlist`);\n  }\n\n  private showTagEditor(itemId: string): void {\n    const item = this.library.getItem(itemId);\n    if (!item) return;\n\n    const allTags = this.library.getAllTags();\n    const currentTags = new Set(item.tags);\n\n    const content = `\n      <form>\n        <div style=\"max-height: 300px; overflow-y: auto;\">\n          ${allTags.map(tag => `\n            <div class=\"form-group\" style=\"margin: 5px 0;\">\n              <label style=\"display: flex; align-items: center; gap: 8px; cursor: pointer;\">\n                <input type=\"checkbox\" name=\"tag\" value=\"${tag}\" ${currentTags.has(tag) ? 'checked' : ''}>\n                <span>#${tag}</span>\n              </label>\n            </div>\n          `).join('')}\n        </div>\n        <div class=\"form-group\" style=\"margin-top: 10px;\">\n          <input type=\"text\" name=\"newTag\" placeholder=\"Add new tag...\" style=\"width: 100%;\">\n        </div>\n      </form>\n    `;\n\n    new Dialog({\n      title: `Edit Tags: ${item.name}`,\n      content,\n      buttons: {\n        save: {\n          icon: '<i class=\"fas fa-save\"></i>',\n          label: 'Save',\n          callback: (html: JQuery) => {\n            const selectedTags: string[] = [];\n            html.find('input[name=\"tag\"]:checked').each((_, el) => {\n              selectedTags.push($(el).val() as string);\n            });\n\n            const newTag = (html.find('input[name=\"newTag\"]').val() as string)?.trim();\n            if (newTag) {\n              selectedTags.push(newTag);\n              this.library.addCustomTag(newTag);\n            }\n\n            this.library.updateItem(itemId, { tags: selectedTags });\n            if (this.parentApp) this.parentApp.captureScroll();\n            this.render();\n          }\n        },\n        cancel: {\n          icon: '<i class=\"fas fa-times\"></i>',\n          label: 'Cancel'\n        }\n      },\n      default: 'save'\n    }).render(true);\n  }\n\n  private async promptInput(title: string, label: string, defaultValue: string = ''): Promise<string | null> {\n    return new Promise((resolve) => {\n      new Dialog({\n        title,\n        content: `\n          <form>\n            <div class=\"form-group\">\n              <label>${label}</label>\n              <input type=\"text\" name=\"input\" value=\"${defaultValue}\" autofocus style=\"width: 100%;\">\n            </div>\n          </form>\n        `,\n        buttons: {\n          ok: {\n            icon: '<i class=\"fas fa-check\"></i>',\n            label: 'OK',\n            callback: (html: JQuery) => {\n              const value = html.find('input[name=\"input\"]').val() as string;\n              resolve(value?.trim() || null);\n            }\n          },\n          cancel: {\n            icon: '<i class=\"fas fa-times\"></i>',\n            label: 'Cancel',\n            callback: () => resolve(null)\n          }\n        },\n        default: 'ok'\n      }).render(true);\n    });\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Playlist Event Handlers (Extended)\n  // ─────────────────────────────────────────────────────────────\n\n  private onSelectPlaylist(event: JQuery.ClickEvent): void {\n    event.preventDefault();\n    const playlistId = $(event.currentTarget).data('playlist-id') as string;\n\n    // Toggle playlist filter\n    if (this.filterState.selectedPlaylistId === playlistId) {\n      // Deselect if clicking the same playlist\n      this.filterState.selectedPlaylistId = null;\n    } else {\n      this.filterState.selectedPlaylistId = playlistId;\n    }\n\n    this.render(false, { resetScroll: true });\n    Logger.debug('Select playlist:', playlistId);\n  }\n\n  private onPlaylistMenu(event: JQuery.ClickEvent): void {\n    event.preventDefault();\n    event.stopPropagation();\n    // Context menu is now handled by right-click\n    // This button can trigger the same menu programmatically\n    const playlistId = $(event.currentTarget).data('playlist-id') as string;\n    const playlistElement = $(event.currentTarget).closest('.ase-list-item');\n\n    // Trigger a contextmenu event on the playlist item\n    const contextMenuEvent = new MouseEvent('contextmenu', {\n      bubbles: true,\n      cancelable: true,\n      view: window,\n      clientX: event.clientX,\n      clientY: event.clientY\n    });\n    playlistElement[0]?.dispatchEvent(contextMenuEvent);\n  }\n\n  private onTogglePlaylistQueue(event: JQuery.ClickEvent): void {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const playlistId = $(event.currentTarget).closest('[data-playlist-id]').data('playlist-id') as string;\n    const playlist = this.library.playlists.getPlaylist(playlistId);\n\n    if (!playlist || !window.ASE?.queue) {\n      Logger.warn('Cannot toggle playlist queue: playlist or queue not available');\n      return;\n    }\n\n    // Check if already in queue (by playlistId)\n    const inQueue = window.ASE.queue.getItems().some(item => item.playlistId === playlistId);\n\n    if (inQueue) {\n      // Remove all items from this playlist\n      const itemsToRemove = window.ASE.queue.getItems().filter(item => item.playlistId === playlistId);\n      itemsToRemove.forEach(item => window.ASE!.queue!.removeItem(item.id));\n      ui.notifications?.info(`Removed \"${playlist.name}\" from queue`);\n    } else {\n      // Add all playlist items to queue\n      const playlistItems = playlist.items.map(pItem => {\n        const libraryItem = this.library.getItem(pItem.libraryItemId);\n        return {\n          libraryItemId: pItem.libraryItemId,\n          group: pItem.group || 'music' as const,\n          volume: pItem.volume\n        };\n      }).filter(item => item.libraryItemId);\n\n      window.ASE.queue.addPlaylist(playlistId, playlistItems);\n      ui.notifications?.info(`Added \"${playlist.name}\" (${playlist.items.length} tracks) to queue`);\n    }\n  }\n\n  private onPlaylistContext(event: JQuery.ContextMenuEvent): void {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const playlistId = String($(event.currentTarget).data('playlist-id'));\n    const playlist = this.library.playlists.getPlaylist(playlistId);\n\n    if (!playlist) return;\n\n    // Create a custom context menu appended to body to avoid clipping\n\n    const menuHtml = `\n      <div id=\"ase-custom-context-menu\" style=\"position: fixed; z-index: 10000; background: #222; border: 1px solid #444; border-radius: 4px; padding: 5px 0;\">\n        <div class=\"ase-ctx-item\" data-action=\"edit\" style=\"padding: 5px 15px; cursor: pointer; color: white;\">\n            <i class=\"fas fa-edit\" style=\"margin-right: 5px;\"></i> Rename\n        </div>\n        <div class=\"ase-ctx-item\" data-action=\"delete\" style=\"padding: 5px 15px; cursor: pointer; color: #ff6666;\">\n            <i class=\"fas fa-trash\" style=\"margin-right: 5px;\"></i> Delete\n        </div>\n      </div>\n    `;\n\n    // Remove existing\n    $('#ase-custom-context-menu').remove();\n\n    const menu = $(menuHtml);\n    $('body').append(menu);\n\n    // Position\n    menu.css({\n      top: event.clientY,\n      left: event.clientX\n    });\n\n    // Hover effect\n    menu.find('.ase-ctx-item').on('mouseenter', function () {\n      $(this).css('background-color', '#333');\n    }).on('mouseleave', function () {\n      $(this).css('background-color', 'transparent');\n    });\n\n    // Handle clicks\n    menu.find('[data-action=\"edit\"]').on('click', () => {\n      menu.remove();\n      this.renamePlaylist(playlistId);\n    });\n\n    menu.find('[data-action=\"delete\"]').on('click', () => {\n      menu.remove();\n      this.deletePlaylist(playlistId);\n    });\n\n    // Close on click outside\n    setTimeout(() => {\n      $(document).one('click', () => menu.remove());\n    }, 50);\n  }\n\n  private async renamePlaylist(playlistId: string): Promise<void> {\n    const playlist = this.library.playlists.getPlaylist(playlistId);\n    if (!playlist) return;\n\n    const newName = await this.promptPlaylistName(playlist.name);\n    if (!newName || newName === playlist.name) return;\n\n    this.library.playlists.updatePlaylist(playlistId, { name: newName });\n    if (this.parentApp) this.parentApp.captureScroll();\n    this.render();\n    ui.notifications?.info(`Renamed playlist to \"${newName}\"`);\n  }\n\n  private async deletePlaylist(playlistId: string): Promise<void> {\n    const playlist = this.library.playlists.getPlaylist(playlistId);\n    if (!playlist) return;\n\n    const confirm = await Dialog.confirm({\n      title: \"Delete Playlist\",\n      content: `Are you sure you want to delete playlist \"${playlist.name}\"?`\n    });\n\n    if (!confirm) return;\n\n    this.library.playlists.deletePlaylist(playlistId);\n\n    // Clear selection if this was selected\n    if (this.filterState.selectedPlaylistId === playlistId) {\n      this.filterState.selectedPlaylistId = null;\n    }\n\n    this.render();\n    ui.notifications?.info(`Deleted playlist \"${playlist.name}\"`);\n  }\n\n  private async promptPlaylistName(current: string = \"\"): Promise<string | null> {\n    return new Promise((resolve) => {\n      new Dialog({\n        title: current ? \"Rename Playlist\" : \"New Playlist\",\n        content: `\n          <form>\n            <div class=\"form-group\">\n              <label>Playlist Name:</label>\n              <input type=\"text\" name=\"playlistName\" value=\"${current}\" autofocus style=\"width: 100%;\">\n            </div>\n          </form>\n        `,\n        buttons: {\n          ok: {\n            icon: '<i class=\"fas fa-check\"></i>',\n            label: \"OK\",\n            callback: (html: JQuery) => {\n              const name = html.find('[name=\"playlistName\"]').val() as string;\n              resolve(name?.trim() || null);\n            }\n          },\n          cancel: {\n            icon: '<i class=\"fas fa-times\"></i>',\n            label: \"Cancel\",\n            callback: () => resolve(null)\n          }\n        },\n        default: \"ok\"\n      }).render(true);\n    });\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Drag and Drop\n  // ─────────────────────────────────────────────────────────────\n\n  private setupDragAndDrop(html: JQuery): void {\n    // Drag start\n    html.find('.ase-track-player-item[draggable=\"true\"]').on('dragstart', (event: JQuery.DragStartEvent) => {\n      const itemId = $(event.currentTarget).find('[data-item-id]').data('item-id') as string || $(event.currentTarget).data('item-id') as string;\n      // Note: Data-item-id might be on the action button/icon, but for the row it should be on the row or accessible.\n      // In template: <div class=\"ase-track-player-item\"> doesn't have data-item-id directly? \n      // Let's check template.\n      // Template: <div class=\"ase-track-player-item\"> inside each item. \n      // Actually, my template rewrite in 751:\n      // {{#each items}} <div class=\"ase-track-player-item\"> ... <div class=\"ase-track-actions\"> <i ... data-item-id=\"{{this.id}}\">\n      // The row itself DOES NOT have data-item-id in the rewrite! \n      // I NEED TO ADD IT TO THE TEMPLATE OR FIND IT.\n      // I will assume I will fix the template to include data-item-id on the row, or find it inside.\n      // For now, let's find it inside.\n      const id = $(event.currentTarget).find('[data-item-id]').first().data('item-id') as string;\n\n      event.originalEvent!.dataTransfer!.effectAllowed = 'copy';\n      event.originalEvent!.dataTransfer!.setData('text/plain', id);\n      // Mark as internal ASE drag with custom type\n      event.originalEvent!.dataTransfer!.setData('application/x-ase-internal', 'true');\n      $(event.currentTarget).addClass('dragging');\n    });\n\n    // Drag end\n    html.find('.ase-track-player-item[draggable=\"true\"]').on('dragend', (event: JQuery.DragEndEvent) => {\n      $(event.currentTarget).removeClass('dragging');\n    });\n\n    // Drop zones (playlists)\n    html.find('.ase-list-item[data-playlist-id]').on('dragover', (event: JQuery.DragOverEvent) => {\n      event.preventDefault();\n      event.originalEvent!.dataTransfer!.dropEffect = 'copy';\n      // Show drag-over highlight when dragging tracks onto playlists\n      // Internal drags have 'application/x-ase-internal' marker\n      const isInternalDrag = event.originalEvent!.dataTransfer!.types.includes('application/x-ase-internal');\n      if (isInternalDrag) {\n        $(event.currentTarget).addClass('drag-over');\n      }\n    });\n\n    html.find('.ase-list-item[data-playlist-id]').on('dragleave', (event: JQuery.DragLeaveEvent) => {\n      $(event.currentTarget).removeClass('drag-over');\n    });\n\n    html.find('.ase-list-item[data-playlist-id]').on('drop', async (event: JQuery.DropEvent) => {\n      event.preventDefault();\n      const itemId = event.originalEvent!.dataTransfer!.getData('text/plain');\n      const playlistId = $(event.currentTarget).data('playlist-id') as string;\n      $(event.currentTarget).removeClass('drag-over');\n\n      // Check if this is a playlist reorder drop (dragging a playlist onto another)\n      const draggedPlaylistId = event.originalEvent!.dataTransfer!.getData('application/x-playlist-id');\n      if (draggedPlaylistId && draggedPlaylistId !== playlistId) {\n        await this.handlePlaylistReorder(draggedPlaylistId, playlistId);\n        return;\n      }\n\n      await this.handleDropTrackToPlaylist(itemId, playlistId);\n    });\n\n    // Playlist reordering - drag start\n    html.find('.ase-list-item[data-playlist-id][draggable=\"true\"]').on('dragstart', (event: JQuery.DragStartEvent) => {\n      const playlistId = String($(event.currentTarget).data('playlist-id'));\n      event.originalEvent!.dataTransfer!.effectAllowed = 'move';\n      event.originalEvent!.dataTransfer!.setData('application/x-playlist-id', playlistId);\n      $(event.currentTarget).addClass('dragging');\n    });\n\n    html.find('.ase-list-item[data-playlist-id][draggable=\"true\"]').on('dragend', (event: JQuery.DragEndEvent) => {\n      $(event.currentTarget).removeClass('dragging');\n      html.find('.ase-list-item').removeClass('drag-over drag-above drag-below');\n    });\n\n    // Favorites reordering - drag start\n    html.find('.ase-favorite-item[draggable=\"true\"]').on('dragstart', (event: JQuery.DragStartEvent) => {\n      const favoriteId = String($(event.currentTarget).data('favorite-id'));\n      const favoriteType = String($(event.currentTarget).data('favorite-type'));\n      event.originalEvent!.dataTransfer!.effectAllowed = 'move';\n      event.originalEvent!.dataTransfer!.setData('application/x-favorite-id', favoriteId);\n      event.originalEvent!.dataTransfer!.setData('application/x-favorite-type', favoriteType);\n      $(event.currentTarget).addClass('dragging');\n    });\n\n    html.find('.ase-favorite-item[draggable=\"true\"]').on('dragend', (event: JQuery.DragEndEvent) => {\n      $(event.currentTarget).removeClass('dragging');\n      html.find('.ase-favorite-item').removeClass('drag-over drag-above drag-below');\n    });\n\n    // Visual feedback for playlist insertion position\n    html.find('.ase-list-item[data-playlist-id]').on('dragover', (event: JQuery.DragOverEvent) => {\n      const draggedPlaylistId = event.originalEvent!.dataTransfer!.types.includes('application/x-playlist-id');\n      if (!draggedPlaylistId) return; // Not a playlist drag\n\n      event.preventDefault();\n      event.originalEvent!.dataTransfer!.dropEffect = 'move';\n\n      const rect = (event.currentTarget as HTMLElement).getBoundingClientRect();\n      const midY = rect.top + rect.height / 2;\n      const isAbove = event.clientY! < midY;\n\n      // Clear drag classes from ALL playlist items first\n      html.find('.ase-list-item[data-playlist-id]').removeClass('drag-above drag-below drag-over');\n      // Then add to current target\n      $(event.currentTarget).addClass(isAbove ? 'drag-above' : 'drag-below');\n    });\n\n    // Visual feedback for favorites insertion position\n    html.find('.ase-favorite-item').on('dragover', (event: JQuery.DragOverEvent) => {\n      const hasFavoriteId = event.originalEvent!.dataTransfer!.types.includes('application/x-favorite-id');\n      if (!hasFavoriteId) return; // Not a favorite drag\n\n      event.preventDefault();\n      event.originalEvent!.dataTransfer!.dropEffect = 'move';\n\n      const rect = (event.currentTarget as HTMLElement).getBoundingClientRect();\n      const midY = rect.top + rect.height / 2;\n      const isAbove = event.clientY! < midY;\n\n      // Clear drag classes from ALL favorite items first\n      html.find('.ase-favorite-item').removeClass('drag-above drag-below drag-over');\n      // Then add to current target\n      $(event.currentTarget).addClass(isAbove ? 'drag-above' : 'drag-below');\n    });\n\n    html.find('.ase-favorite-item').on('drop', async (event: JQuery.DropEvent) => {\n      event.preventDefault();\n      const favoriteId = String($(event.currentTarget).data('favorite-id'));\n      const favoriteType = String($(event.currentTarget).data('favorite-type'));\n\n      $(event.currentTarget).removeClass('drag-above drag-below dragging');\n\n      const draggedId = event.originalEvent!.dataTransfer!.getData('application/x-favorite-id');\n      const draggedType = event.originalEvent!.dataTransfer!.getData('application/x-favorite-type');\n\n      if (draggedId && draggedType && (draggedId !== favoriteId || draggedType !== favoriteType)) {\n        await this.handleFavoriteReorder(draggedId, draggedType as 'track' | 'playlist', favoriteId, favoriteType as 'track' | 'playlist');\n      }\n    });\n\n    // Drop zone from OS (Main Library Area)\n    html.find('.ase-content-area').on('dragover', (event: JQuery.DragOverEvent) => {\n      event.preventDefault();\n      $(event.currentTarget).addClass('drag-over-import');\n    });\n\n    html.find('.ase-content-area').on('dragleave', (event: JQuery.DragLeaveEvent) => {\n      $(event.currentTarget).removeClass('drag-over-import');\n    });\n\n    html.find('.ase-content-area').on('drop', async (event: JQuery.DropEvent) => {\n      event.preventDefault();\n      $(event.currentTarget).removeClass('drag-over-import');\n\n      // Handle files from OS\n      const files = event.originalEvent?.dataTransfer?.files;\n      if (files && files.length > 0) {\n        Logger.debug(`Dropped ${files.length} files from OS`);\n        // Processing files...\n        // Note: Foundry FilePicker/Upload API is needed here.\n        // For now, we simulate the drop if it's external, or handle internal drops logic separately.\n\n        // Check if it's an internal drag (track item)\n        // If dataTransfer has 'text/plain' equal to item ID, it's internal.\n        const internalId = event.originalEvent?.dataTransfer?.getData('text/plain');\n        if (internalId && !files.length) {\n          // Internal drop on main area -> Maybe remove from current playlist if we are in one? \n          // Currently do nothing.\n          return;\n        }\n\n        // Real file upload\n        await this.handleFileUpload(files);\n      }\n    });\n  }\n\n  private async handlePlaylistReorder(draggedId: string, targetId: string): Promise<void> {\n    // Get current playlists order\n    const playlists = this.library.playlists.getAllPlaylists();\n    const draggedIndex = playlists.findIndex(p => p.id === draggedId);\n    const targetIndex = playlists.findIndex(p => p.id === targetId);\n\n    if (draggedIndex === -1 || targetIndex === -1) return;\n\n    // Reorder\n    const [dragged] = playlists.splice(draggedIndex, 1);\n    playlists.splice(targetIndex, 0, dragged);\n\n    // Update order in library (need to save the new order)\n    this.library.playlists.reorderPlaylists(playlists.map(p => p.id));\n\n    this.render();\n    Logger.debug(`Reordered playlist ${draggedId} to position ${targetIndex}`);\n  }\n\n  private async handleFavoriteReorder(\n    draggedId: string,\n    draggedType: 'track' | 'playlist',\n    targetId: string,\n    targetType: 'track' | 'playlist'\n  ): Promise<void> {\n    const favorites = this.library.getOrderedFavorites();\n    const draggedIndex = favorites.findIndex(f => f.id === draggedId && f.type === draggedType);\n    const targetIndex = favorites.findIndex(f => f.id === targetId && f.type === targetType); // Drop ON this item\n\n    if (draggedIndex === -1 || targetIndex === -1) return;\n\n    // Remove dragged item\n    const [draggedItem] = favorites.splice(draggedIndex, 1);\n\n    // Insert at target index (shift others down)\n    favorites.splice(targetIndex, 0, draggedItem);\n\n    // Update library\n    this.library.reorderFavorites(favorites);\n    this.render();\n    Logger.debug(`Reordered favorite ${draggedId} to position ${targetIndex}`);\n  }\n\n  private async handleFileUpload(files: FileList): Promise<void> {\n    if (!game.user?.isGM) {\n      ui.notifications?.warn('Only GM can upload files.');\n      return;\n    }\n\n    // Validate audio files\n    const audioFiles = Array.from(files).filter(file => {\n      const ext = file.name.split('.').pop()?.toLowerCase();\n      return ['mp3', 'ogg', 'wav', 'flac', 'webm', 'm4a', 'aac'].includes(ext || '');\n    });\n\n    if (audioFiles.length === 0) {\n      ui.notifications?.warn('No valid audio files found. Supported formats: mp3, ogg, wav, flac, webm, m4a, aac');\n      return;\n    }\n\n    // Upload to dedicated ase_audio folder (separate from worlds and modules)\n    const targetSource = 'data';\n    const targetDir = 'ase_audio';\n\n    // Ensure directory exists (create if needed)\n    try {\n      await FilePicker.createDirectory(targetSource, targetDir, {});\n    } catch (err) {\n      // Directory might already exist, ignore error\n      Logger.debug('Directory creation skipped (might already exist):', err);\n    }\n\n    let importedCount = 0;\n    let failedCount = 0;\n\n    for (const file of audioFiles) {\n      try {\n        // Upload file to server\n        const response = await FilePicker.upload(targetSource, targetDir, file, {}) as any;\n        if (response.path) {\n          // Smart channel detection based on filename\n          const channel = this.detectChannelFromFilename(file.name);\n\n          // Get selected tags\n          const selectedTags = Array.from(this.filterState.selectedTags);\n\n          // Add to library\n          const track = await this.library.addItem(\n            response.path,\n            file.name.split('.')[0], // Remove extension\n            channel,\n            selectedTags\n          );\n\n          // Add to active playlist if one is selected\n          if (this.filterState.selectedPlaylistId) {\n            try {\n              this.library.playlists.addTrackToPlaylist(\n                this.filterState.selectedPlaylistId,\n                track.id,\n                channel\n              );\n            } catch (err) {\n              // Track might already be in playlist, ignore\n            }\n          }\n\n          importedCount++;\n        }\n      } catch (err) {\n        Logger.error(`Failed to upload ${file.name}:`, err);\n        failedCount++;\n      }\n    }\n\n    // Show summary notification\n    if (importedCount > 0) {\n      const playlistMsg = this.filterState.selectedPlaylistId\n        ? ` and added to active playlist`\n        : '';\n      ui.notifications?.info(`Imported ${importedCount} file(s)${playlistMsg}`);\n      this.render();\n    }\n\n    if (failedCount > 0) {\n      ui.notifications?.warn(`Failed to import ${failedCount} file(s)`);\n    }\n  }\n\n  /**\n   * Smart channel detection based on filename keywords\n   */\n  private detectChannelFromFilename(filename: string): TrackGroup {\n    const lowerName = filename.toLowerCase();\n\n    // Music keywords\n    const musicKeywords = ['music', 'song', 'theme', 'bgm', 'soundtrack', 'score', 'melody', 'музык'];\n    if (musicKeywords.some(keyword => lowerName.includes(keyword))) {\n      return 'music';\n    }\n\n    // Ambience keywords\n    const ambienceKeywords = ['ambient', 'ambience', 'atmosphere', 'environment', 'background', 'nature', 'wind', 'rain', 'forest', 'cave', 'амбиент', 'окружен'];\n    if (ambienceKeywords.some(keyword => lowerName.includes(keyword))) {\n      return 'ambience';\n    }\n\n    // SFX keywords\n    const sfxKeywords = ['sfx', 'sound', 'effect', 'fx', 'hit', 'impact', 'explosion', 'spell', 'attack', 'footstep', 'door', 'sword', 'интерфейс', 'эффект'];\n    if (sfxKeywords.some(keyword => lowerName.includes(keyword))) {\n      return 'sfx';\n    }\n\n    // Default to music if no keywords detected\n    return 'music';\n  }\n\n  private async handleDropTrackToPlaylist(itemId: string, playlistId: string): Promise<void> {\n    const item = this.library.getItem(itemId);\n    const playlist = this.library.playlists.getPlaylist(playlistId);\n\n    if (!item || !playlist) {\n      ui.notifications?.error('Track or playlist not found');\n      return;\n    }\n\n    try {\n      const group = this.inferGroupFromTags(item.tags) as TrackGroup;\n      this.library.playlists.addTrackToPlaylist(playlistId, itemId, group);\n      this.render();\n      ui.notifications?.info(`Added \"${item.name}\" to \"${playlist.name}\"`);\n    } catch (error) {\n      Logger.error('Failed to add track to playlist:', error);\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n      ui.notifications?.error(`Failed to add to playlist: ${errorMessage}`);\n    }\n  }\n\n  /**\n   * Setup drag-and-drop handler for Foundry native playlists\n   * Allows dragging PlaylistSound items into ASE library\n   */\n  private setupFoundryDragDrop(html: JQuery): void {\n    const dropZone = html.find('.ase-track-player-list');\n    if (!dropZone.length) return;\n\n    // Prevent default drag over to allow drop\n    dropZone.on('dragover', (event: JQuery.DragOverEvent) => {\n      event.preventDefault();\n      event.originalEvent!.dataTransfer!.dropEffect = 'copy';\n      // Only show drag-over border for external drags (Foundry playlists/files)\n      // Internal drags have 'application/x-ase-internal' marker\n      const isInternalDrag = event.originalEvent!.dataTransfer!.types.includes('application/x-ase-internal');\n      if (!isInternalDrag) {\n        dropZone.addClass('drag-over');\n      }\n    });\n\n    // Remove visual feedback on drag leave\n    dropZone.on('dragleave', (event: JQuery.DragLeaveEvent) => {\n      // Only remove if leaving the drop zone itself (not child elements)\n      if (event.currentTarget === event.target) {\n        dropZone.removeClass('drag-over');\n      }\n    });\n\n    // Handle drop\n    dropZone.on('drop', async (event: JQuery.DropEvent) => {\n      event.preventDefault();\n      dropZone.removeClass('drag-over');\n\n      await this.handleFoundryPlaylistDrop(event.originalEvent!);\n    });\n  }\n\n  /**\n   * Handle drop event from Foundry playlist\n   * Routes to appropriate handler based on type (single track vs full playlist)\n   */\n  private async handleFoundryPlaylistDrop(event: DragEvent): Promise<void> {\n    try {\n      // Extract drag data using Foundry's helper (V10+)\n      const dragData = TextEditor.getDragEventData(event) as any;\n\n      if (!dragData) {\n        Logger.debug('No drag data found, ignoring');\n        return;\n      }\n\n      Logger.debug('Foundry drop detected:', dragData.type);\n\n      // Route by type\n      if (dragData.type === 'PlaylistSound') {\n        await this.handlePlaylistSoundImport(dragData);\n\n\n      } else if (dragData.type === 'Playlist') {\n        await this.handlePlaylistImport(dragData);\n      } else {\n        Logger.debug(`Unsupported drop type: ${dragData.type}`);\n      }\n\n    } catch (error) {\n      Logger.error('Failed to handle Foundry playlist drop:', error);\n      ui.notifications?.error('Failed to import track from playlist');\n    }\n  }\n\n  /**\n   * Import single PlaylistSound track\n   */\n  private async handlePlaylistSoundImport(dragData: any): Promise<void> {\n    // Resolve UUID to get the actual PlaylistSound document\n    const sound = await fromUuid(dragData.uuid) as any;\n\n    if (!sound) {\n      ui.notifications?.error('Failed to resolve playlist sound');\n      return;\n    }\n\n    // Extract audio path and name\n    const audioPath = sound.path || sound.sound?.path;\n    const soundName = sound.name;\n\n    if (!audioPath) {\n      ui.notifications?.error('Playlist sound has no audio file path');\n      return;\n    }\n\n    // Check if already exists\n    const existing = this.library.findByUrl(audioPath);\n    if (existing) {\n      ui.notifications?.warn(`Track \"${soundName}\" already exists in library`);\n      return;\n    }\n\n    // Determine channel (use track channel, or default to 'music')\n    const channel = this.mapFoundryChannelToASE(sound.channel);\n\n    // Add to library\n    // Get selected tags\n    const selectedTags = Array.from(this.filterState.selectedTags);\n\n    // Add to library\n    const newTrack = await this.library.addItem(audioPath, soundName, channel, selectedTags);\n\n    // If a playlist is currently selected, add the track to it automatically\n    if (this.filterState.selectedPlaylistId) {\n      try {\n        this.library.playlists.addTrackToPlaylist(\n          this.filterState.selectedPlaylistId,\n          newTrack.id,\n          channel\n        );\n        const playlist = this.library.playlists.getPlaylist(this.filterState.selectedPlaylistId);\n        ui.notifications?.info(`Added \"${soundName}\" to library and playlist \"${playlist?.name}\"`);\n      } catch (err) {\n        // Track might already be in playlist, just notify about library add\n        ui.notifications?.info(`Added \"${soundName}\" to library`);\n      }\n    } else {\n      ui.notifications?.info(`Added \"${soundName}\" to library`);\n    }\n\n    this.render();\n  }\n\n  /**\n   * Import entire Playlist with all tracks\n   */\n  private async handlePlaylistImport(dragData: any): Promise<void> {\n    try {\n      const playlist = await fromUuid(dragData.uuid) as any;\n\n      if (!playlist) {\n        ui.notifications?.error('Failed to resolve Foundry playlist');\n        return;\n      }\n\n      Logger.info(`Importing Foundry playlist: ${playlist.name} (${playlist.sounds.size} tracks)`);\n\n      const playlistName = this.generateUniquePlaylistName(playlist.name);\n      const asePlaylist = this.library.playlists.createPlaylist(playlistName);\n\n      let addedCount = 0;\n      let skippedCount = 0;\n\n      for (const sound of playlist.sounds) {\n        const audioPath = sound.path || sound.sound?.path;\n        if (!audioPath) {\n          Logger.warn(`Skipping sound \"${sound.name}\" - no path`);\n          continue;\n        }\n\n        // Resolve channel with inheritance\n        const foundryChannel = sound.channel || playlist.channel;\n\n        // Map Foundry channels to ASE channels\n        let channel: TrackGroup = 'music'; // default\n        if (foundryChannel === 'environment') {\n          channel = 'ambience';\n        } else if (foundryChannel === 'interface') {\n          channel = 'sfx';\n        } else if (foundryChannel === 'music' || !foundryChannel) {\n          channel = 'music';\n        }\n\n        let trackId = this.library.findByUrl(audioPath)?.id;\n\n        if (!trackId) {\n          try {\n            // Get selected tags\n            const selectedTags = Array.from(this.filterState.selectedTags);\n            // Log once per playlist import to avoid spam? Or just log.\n            // Logger.debug(`[ASE] PlaylistImport: Adding track with tags: ${JSON.stringify(selectedTags)}`);\n\n            const track = await this.library.addItem(audioPath, sound.name, channel, selectedTags);\n            trackId = track.id;\n            addedCount++;\n          } catch (err) {\n            Logger.error(`Failed to add track \"${sound.name}\":`, err);\n            continue;\n          }\n        } else {\n          skippedCount++;\n        }\n\n        this.library.playlists.addTrackToPlaylist(asePlaylist.id, trackId, channel);\n      }\n\n      const message = `Imported playlist \"${playlistName}\": ${addedCount} new tracks${skippedCount > 0 ? `, ${skippedCount} already in library` : ''}`;\n      ui.notifications?.info(message);\n      this.render();\n\n    } catch (error) {\n      Logger.error('Failed to import Foundry playlist:', error);\n      ui.notifications?.error('Failed to import playlist');\n    }\n  }\n\n  private resolveFoundryChannel(sound: any, playlist: any): TrackGroup {\n    const effectiveChannel = sound.channel || sound.fadeIn?.type || playlist.channel || playlist.mode;\n\n    return this.mapFoundryChannelToASE(effectiveChannel);\n  }\n\n  private mapFoundryChannelToASE(foundryChannel: string | number | null | undefined): TrackGroup {\n    if (!foundryChannel && foundryChannel !== 0) return 'music';\n\n    // Convert to string for comparison\n    const channelStr = String(foundryChannel).toLowerCase();\n\n    // Foundry uses numeric constants (CONST.AUDIO_CHANNELS):\n    // 0 or \"0\" = music\n    // 1 or \"1\" = environment  \n    // 2 or \"2\" = interface\n    const channelMap: Record<string, TrackGroup> = {\n      '0': 'music',\n      '1': 'ambience',\n      '2': 'sfx',\n      'music': 'music',\n      'environment': 'ambience',\n      'interface': 'sfx'\n    };\n\n    const mapped = channelMap[channelStr] || 'music';\n\n    return mapped;\n  }\n\n  private generateUniquePlaylistName(baseName: string): string {\n    const existingPlaylists = this.library.playlists.getAllPlaylists();\n    const existingNames = new Set(existingPlaylists.map(p => p.name));\n\n    if (!existingNames.has(baseName)) return baseName;\n\n    let counter = 2;\n    while (existingNames.has(`${baseName} (${counter})`)) {\n      counter++;\n    }\n\n    return `${baseName} (${counter})`;\n  }\n\n  private async removeTrackFromPlaylist(playlistId: string, trackId: string): Promise<void> {\n    try {\n      this.library.playlists.removeLibraryItemFromPlaylist(playlistId, trackId);\n      if (this.parentApp) this.parentApp.captureScroll();\n      this.render();\n      ui.notifications?.info('Removed track from playlist');\n    } catch (error) {\n      Logger.error('Failed to remove track from playlist:', error);\n      ui.notifications?.error('Failed to remove track from playlist');\n    }\n  }\n\n  /**\n   * Highlight playlists in sidebar that contain the specified track\n   */\n  private highlightPlaylistsContainingTrack(trackId: string): void {\n    const playlists = this.library.playlists.getAllPlaylists();\n\n    // Find playlists containing this track\n    const containingPlaylists = playlists.filter(playlist =>\n      playlist.items.some(item => item.libraryItemId === trackId)\n    );\n\n    // Highlight them in the UI\n    containingPlaylists.forEach(playlist => {\n      $(`[data-playlist-id=\"${playlist.id}\"]`).addClass('highlight-contains-track');\n    });\n  }\n\n  /**\n   * Clear all playlist highlights\n   */\n  private clearPlaylistHighlights(): void {\n    $('.highlight-contains-track').removeClass('highlight-contains-track');\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Context Menus\n  // ─────────────────────────────────────────────────────────────\n\n  private setupContextMenus(html: JQuery): void {\n    // Track context menu\n    new ContextMenu(html, '.track-item', [\n      {\n        name: 'Edit Name',\n        icon: '<i class=\"fas fa-edit\"></i>',\n        callback: (target: JQuery | HTMLElement) => {\n          const li = $(target);\n          const itemId = li.data('item-id') as string;\n          this.onEditTrackName(itemId);\n        }\n      },\n      {\n        name: 'Edit Tags',\n        icon: '<i class=\"fas fa-tags\"></i>',\n        callback: (target: JQuery | HTMLElement) => {\n          const li = $(target);\n          const itemId = li.data('item-id') as string;\n          this.onEditTrackTags(itemId);\n        }\n      },\n      {\n        name: 'Add to Playlist',\n        icon: '<i class=\"fas fa-list-ul\"></i>',\n        callback: (target: JQuery | HTMLElement) => {\n          const li = $(target);\n          const itemId = li.data('item-id') as string;\n          this.handleAddToPlaylistFromContext(itemId);\n        }\n      },\n      {\n        name: 'Toggle Favorite',\n        icon: '<i class=\"fas fa-star\"></i>',\n        callback: (target: JQuery | HTMLElement) => {\n          const li = $(target);\n          const itemId = li.data('item-id') as string;\n          try {\n            const isFavorite = this.library.toggleFavorite(itemId);\n            if (this.parentApp) this.parentApp.captureScroll();\n            this.render();\n            ui.notifications?.info(isFavorite ? 'Added to favorites' : 'Removed from favorites');\n          } catch (error) {\n            Logger.error('Failed to toggle favorite:', error);\n            ui.notifications?.error('Failed to update favorite status');\n          }\n        }\n      },\n      {\n        name: 'Delete Track',\n        icon: '<i class=\"fas fa-trash\"></i>',\n        callback: (target: JQuery | HTMLElement) => {\n          const li = $(target);\n          const itemId = li.data('item-id') as string;\n          this.onDeleteTrackConfirm(itemId);\n        }\n      }\n    ]);\n\n    // Playlist context menu\n    new ContextMenu(html, '.playlist-item', [\n      {\n        name: 'Rename Playlist',\n        icon: '<i class=\"fas fa-edit\"></i>',\n        callback: (target: JQuery | HTMLElement) => {\n          const li = $(target);\n          const playlistId = li.data('playlist-id') as string;\n          this.onRenamePlaylist(playlistId);\n        }\n      },\n      {\n        name: 'Edit Description',\n        icon: '<i class=\"fas fa-align-left\"></i>',\n        callback: (target: JQuery | HTMLElement) => {\n          const li = $(target);\n          const playlistId = li.data('playlist-id') as string;\n          this.onEditPlaylistDescription(playlistId);\n        }\n      },\n      {\n        name: 'View Contents',\n        icon: '<i class=\"fas fa-list\"></i>',\n        callback: (target: JQuery | HTMLElement) => {\n          const li = $(target);\n          const playlistId = li.data('playlist-id') as string;\n          this.onViewPlaylistContents(playlistId);\n        }\n      },\n      {\n        name: 'Clear Playlist',\n        icon: '<i class=\"fas fa-eraser\"></i>',\n        callback: (target: JQuery | HTMLElement) => {\n          const li = $(target);\n          const playlistId = li.data('playlist-id') as string;\n          this.onClearPlaylist(playlistId);\n        }\n      },\n      {\n        name: 'Delete Playlist',\n        icon: '<i class=\"fas fa-trash\"></i>',\n        callback: (target: JQuery | HTMLElement) => {\n          const li = $(target);\n          const playlistId = li.data('playlist-id') as string;\n          this.onDeletePlaylistConfirm(playlistId);\n        }\n      }\n    ]);\n\n    // Tag context menu\n    new ContextMenu(html, '.tag-chip:not(.mini)', [\n      {\n        name: 'Rename Tag',\n        icon: '<i class=\"fas fa-edit\"></i>',\n        callback: (target: JQuery | HTMLElement) => {\n          const li = $(target);\n          const tagName = li.data('tag') as string;\n          this.onRenameTag(tagName);\n        }\n      },\n      {\n        name: 'Delete Tag',\n        icon: '<i class=\"fas fa-trash\"></i>',\n        callback: (target: JQuery | HTMLElement) => {\n          const li = $(target);\n          const tagName = li.data('tag') as string;\n          this.onDeleteTag(tagName);\n        }\n      }\n    ]);\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Context Menu Handlers - Tracks\n  // ─────────────────────────────────────────────────────────────\n\n  private async onEditTrackName(itemId: string): Promise<void> {\n    const item = this.library.getItem(itemId);\n    if (!item) {\n      ui.notifications?.error('Track not found');\n      return;\n    }\n\n    const newName = await this.promptTextInput('Edit Track Name', 'Track Name', item.name);\n    if (!newName || newName === item.name) return;\n\n    try {\n      this.library.updateItem(itemId, { name: newName });\n      if (this.parentApp) this.parentApp.captureScroll();\n      this.render();\n      ui.notifications?.info(`Renamed to: ${newName}`);\n    } catch (error) {\n      Logger.error('Failed to rename track:', error);\n      ui.notifications?.error('Failed to rename track');\n    }\n  }\n\n  private async onEditTrackTags(itemId: string): Promise<void> {\n    const item = this.library.getItem(itemId);\n    if (!item) {\n      ui.notifications?.error('Track not found');\n      return;\n    }\n\n    const tagsString = await this.promptTextInput(\n      'Edit Tags',\n      'Tags (comma-separated)',\n      item.tags.join(', ')\n    );\n    if (tagsString === null) return;\n\n    // Parse tags\n    const newTags = tagsString\n      .split(',')\n      .map(t => t.trim())\n      .filter(t => t.length > 0);\n\n    try {\n      this.library.updateItem(itemId, { tags: newTags });\n      if (this.parentApp) this.parentApp.captureScroll();\n      this.render();\n      ui.notifications?.info('Tags updated');\n    } catch (error) {\n      Logger.error('Failed to update tags:', error);\n      ui.notifications?.error('Failed to update tags');\n    }\n  }\n\n  private async onDeleteTrackConfirm(itemId: string): Promise<void> {\n    const item = this.library.getItem(itemId);\n    if (!item) {\n      ui.notifications?.error('Track not found');\n      return;\n    }\n\n    const confirmed = await Dialog.confirm({\n      title: 'Delete Track',\n      content: `<p>Are you sure you want to delete <strong>${item.name}</strong> from the library?</p>\n                <p class=\"notification warning\">This will remove it from all playlists and favorites.</p>`,\n      yes: () => true,\n      no: () => false,\n      defaultYes: false\n    });\n\n    if (confirmed) {\n      try {\n        this.library.removeItem(itemId);\n        if (this.parentApp) this.parentApp.captureScroll();\n        this.render();\n        ui.notifications?.info(`Deleted: ${item.name}`);\n      } catch (error) {\n        Logger.error('Failed to delete track:', error);\n        ui.notifications?.error('Failed to delete track');\n      }\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Context Menu Handlers - Playlists\n  // ─────────────────────────────────────────────────────────────\n\n  private async onRenamePlaylist(playlistId: string): Promise<void> {\n    const playlist = this.library.playlists.getPlaylist(playlistId);\n    if (!playlist) {\n      ui.notifications?.error('Playlist not found');\n      return;\n    }\n\n    const newName = await this.promptTextInput('Rename Playlist', 'Playlist Name', playlist.name);\n    if (!newName || newName === playlist.name) return;\n\n    try {\n      this.library.playlists.updatePlaylist(playlistId, { name: newName });\n      this.render();\n      ui.notifications?.info(`Renamed to: ${newName}`);\n    } catch (error) {\n      Logger.error('Failed to rename playlist:', error);\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n      ui.notifications?.error(`Failed to rename playlist: ${errorMessage}`);\n    }\n  }\n\n  private async onEditPlaylistDescription(playlistId: string): Promise<void> {\n    const playlist = this.library.playlists.getPlaylist(playlistId);\n    if (!playlist) {\n      ui.notifications?.error('Playlist not found');\n      return;\n    }\n\n    const description = await this.promptTextInput(\n      'Edit Description',\n      'Description',\n      playlist.description || ''\n    );\n    if (description === null) return;\n\n    try {\n      this.library.playlists.updatePlaylist(playlistId, { description: description || undefined });\n      this.render();\n      ui.notifications?.info('Description updated');\n    } catch (error) {\n      Logger.error('Failed to update description:', error);\n      ui.notifications?.error('Failed to update description');\n    }\n  }\n\n  private async onViewPlaylistContents(playlistId: string): Promise<void> {\n    const playlist = this.library.playlists.getPlaylist(playlistId);\n    if (!playlist) {\n      ui.notifications?.error('Playlist not found');\n      return;\n    }\n\n    const items = playlist.items\n      .sort((a, b) => a.order - b.order)\n      .map((playlistItem, index) => {\n        const libraryItem = this.library.getItem(playlistItem.libraryItemId);\n        const name = libraryItem?.name || 'Unknown';\n        return `<li><strong>${index + 1}.</strong> ${name}</li>`;\n      })\n      .join('');\n\n    const content = `\n      <div>\n        <p><strong>${playlist.name}</strong></p>\n        ${playlist.description ? `<p><em>${playlist.description}</em></p>` : ''}\n        <p>Total tracks: ${playlist.items.length}</p>\n        ${playlist.items.length > 0 ? `<ul class=\"playlist-contents-list\">${items}</ul>` : '<p>No tracks in playlist</p>'}\n      </div>\n    `;\n\n    new Dialog({\n      title: 'Playlist Contents',\n      content,\n      buttons: {\n        close: {\n          icon: '<i class=\"fas fa-times\"></i>',\n          label: 'Close'\n        }\n      },\n      default: 'close'\n    }).render(true);\n  }\n\n  private async onClearPlaylist(playlistId: string): Promise<void> {\n    const playlist = this.library.playlists.getPlaylist(playlistId);\n    if (!playlist) {\n      ui.notifications?.error('Playlist not found');\n      return;\n    }\n\n    if (playlist.items.length === 0) {\n      ui.notifications?.warn('Playlist is already empty');\n      return;\n    }\n\n    const confirmed = await Dialog.confirm({\n      title: 'Clear Playlist',\n      content: `<p>Are you sure you want to remove all ${playlist.items.length} tracks from <strong>${playlist.name}</strong>?</p>\n                <p class=\"notification warning\">This cannot be undone.</p>`,\n      yes: () => true,\n      no: () => false,\n      defaultYes: false\n    });\n\n    if (confirmed) {\n      try {\n        // Remove all items\n        const itemIds = [...playlist.items.map(i => i.id)];\n        itemIds.forEach(itemId => {\n          try {\n            this.library.playlists.removeTrackFromPlaylist(playlistId, itemId);\n          } catch (error) {\n            Logger.error('Failed to remove item:', error);\n          }\n        });\n\n        this.render();\n        ui.notifications?.info(`Cleared playlist: ${playlist.name}`);\n      } catch (error) {\n        Logger.error('Failed to clear playlist:', error);\n        ui.notifications?.error('Failed to clear playlist');\n      }\n    }\n  }\n\n  private async onDeletePlaylistConfirm(playlistId: string): Promise<void> {\n    const playlist = this.library.playlists.getPlaylist(playlistId);\n    if (!playlist) {\n      ui.notifications?.error('Playlist not found');\n      return;\n    }\n\n    const confirmed = await Dialog.confirm({\n      title: 'Delete Playlist',\n      content: `<p>Are you sure you want to delete <strong>${playlist.name}</strong>?</p>\n                <p class=\"notification info\">The tracks will remain in your library.</p>`,\n      yes: () => true,\n      no: () => false,\n      defaultYes: false\n    });\n\n    if (confirmed) {\n      try {\n        // Clear playlist filter if this playlist is selected\n        if (this.filterState.selectedPlaylistId === playlistId) {\n          this.filterState.selectedPlaylistId = null;\n        }\n\n        this.library.playlists.deletePlaylist(playlistId);\n        this.render();\n        ui.notifications?.info(`Deleted playlist: ${playlist.name}`);\n      } catch (error) {\n        Logger.error('Failed to delete playlist:', error);\n        ui.notifications?.error('Failed to delete playlist');\n      }\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Context Menu Handlers - Tags\n  // ─────────────────────────────────────────────────────────────\n\n  private async onRenameTag(oldTagName: string): Promise<void> {\n    const newTagName = await this.promptTextInput('Rename Tag', 'New Tag Name', oldTagName);\n    if (!newTagName || newTagName === oldTagName) return;\n\n    try {\n      // Find all items with this tag and update them\n      const items = this.library.getAllItems().filter(item => item.tags.includes(oldTagName));\n\n      items.forEach(item => {\n        const updatedTags = item.tags.map(tag => tag === oldTagName ? newTagName : tag);\n        this.library.updateItem(item.id, { tags: updatedTags });\n      });\n\n      // Update filter state if tag is selected\n      if (this.filterState.selectedTags.has(oldTagName)) {\n        this.filterState.selectedTags.delete(oldTagName);\n        this.filterState.selectedTags.add(newTagName);\n      }\n\n      this.render();\n      ui.notifications?.info(`Renamed tag \"${oldTagName}\" to \"${newTagName}\" in ${items.length} track(s)`);\n    } catch (error) {\n      Logger.error('Failed to rename tag:', error);\n      ui.notifications?.error('Failed to rename tag');\n    }\n  }\n\n  private async onDeleteTag(tagName: string): Promise<void> {\n    const items = this.library.getAllItems().filter(item => item.tags.includes(tagName));\n\n    const confirmed = await Dialog.confirm({\n      title: 'Delete Tag',\n      content: `<p>Are you sure you want to delete the tag <strong>${tagName}</strong>?</p>\n                <p class=\"notification warning\">This will remove the tag from ${items.length} track(s).</p>`,\n      yes: () => true,\n      no: () => false,\n      defaultYes: false\n    });\n\n    if (confirmed) {\n      try {\n        items.forEach(item => {\n          const updatedTags = item.tags.filter(tag => tag !== tagName);\n          this.library.updateItem(item.id, { tags: updatedTags });\n        });\n\n        // Remove from filter state if selected\n        this.filterState.selectedTags.delete(tagName);\n\n        this.render();\n        ui.notifications?.info(`Deleted tag \"${tagName}\" from ${items.length} track(s)`);\n      } catch (error) {\n        Logger.error('Failed to delete tag:', error);\n        ui.notifications?.error('Failed to delete tag');\n      }\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Utilities\n  // ─────────────────────────────────────────────────────────────\n\n\n\n  private async promptPlaylistSelection(playlists: Playlist[]): Promise<string | null> {\n    const options = playlists.map(p =>\n      `<option value=\"${p.id}\">${p.name} (${p.items.length} tracks)</option>`\n    ).join('');\n\n    return new Promise((resolve) => {\n      new Dialog({\n        title: 'Add to Playlist',\n        content: `\n          <form>\n            <div class=\"form-group\">\n              <label>Select Playlist:</label>\n              <select name=\"playlist-id\">\n                ${options}\n              </select>\n            </div>\n          </form>\n        `,\n        buttons: {\n          add: {\n            icon: '<i class=\"fas fa-plus\"></i>',\n            label: 'Add',\n            callback: (html: JQuery) => {\n              const playlistId = html.find('[name=\"playlist-id\"]').val() as string;\n              resolve(playlistId || null);\n            }\n          },\n          cancel: {\n            icon: '<i class=\"fas fa-times\"></i>',\n            label: 'Cancel',\n            callback: () => resolve(null)\n          }\n        },\n        default: 'add'\n      }).render(true);\n    });\n  }\n\n  private async promptTextInput(\n    title: string,\n    label: string,\n    defaultValue: string = ''\n  ): Promise<string | null> {\n    return new Promise((resolve) => {\n      new Dialog({\n        title,\n        content: `\n          <form>\n            <div class=\"form-group\">\n              <label>${label}:</label>\n              <input type=\"text\" name=\"text-input\" value=\"${defaultValue}\" autofocus />\n            </div>\n          </form>\n        `,\n        buttons: {\n          save: {\n            icon: '<i class=\"fas fa-check\"></i>',\n            label: 'Save',\n            callback: (html: JQuery) => {\n              const value = (html.find('[name=\"text-input\"]').val() as string || '').trim();\n              resolve(value || null);\n            }\n          },\n          cancel: {\n            icon: '<i class=\"fas fa-times\"></i>',\n            label: 'Cancel',\n            callback: () => resolve(null)\n          }\n        },\n        default: 'save'\n      }).render(true);\n    });\n  }\n\n  /**\n   * Handle adding track to playlist from context menu\n   */\n  private async handleAddToPlaylistFromContext(itemId: string): Promise<void> {\n    const item = this.library.getItem(itemId);\n    if (!item) return;\n\n    const playlists = this.library.playlists.getAllPlaylists();\n    if (playlists.length === 0) {\n      ui.notifications?.warn('No playlists available. Create one first.');\n      return;\n    }\n\n    const selectedPlaylistId = await this.promptPlaylistSelection(playlists);\n    if (!selectedPlaylistId) return;\n\n    try {\n      const group = this.inferGroupFromTags(item.tags) as any;\n      this.library.playlists.addTrackToPlaylist(selectedPlaylistId, itemId, group);\n      this.render();\n      ui.notifications?.info(`Added \"${item.name}\" to playlist`);\n    } catch (error) {\n      Logger.error('Failed to add track to playlist:', error);\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n      ui.notifications?.error(`Failed to add to playlist: ${errorMessage}`);\n    }\n  }\n\n\n}\n","import type { TrackGroup } from '@t/audio';\nimport type { QueueItem } from '@t/queue';\nimport type { LibraryItem, Playlist } from '@t/library';\nimport { AudioEngine } from '@core/AudioEngine';\nimport { SocketManager } from '@sync/SocketManager';\nimport { LibraryManager } from '@lib/LibraryManager';\nimport { PlaybackQueueManager } from '@queue/PlaybackQueueManager';\nimport { Logger } from '@utils/logger';\nimport { formatTime } from '@utils/time';\nimport type { PlaybackContext } from '@core/PlaybackScheduler';\n\nconst MODULE_ID = 'advanced-sound-engine';\n\n// ─────────────────────────────────────────────────────────────\n// Types for Mixer View Data\n// ─────────────────────────────────────────────────────────────\n\ninterface MixerViewData {\n  favorites: FavoriteViewData[];\n  queuePlaylists: QueuePlaylistViewData[];\n  effects: EffectViewData[];\n}\n\ninterface FavoriteViewData {\n  id: string;\n  name: string;\n  type: 'track' | 'playlist';\n  group?: TrackGroup;\n  isPlaying: boolean;\n  isPaused: boolean;\n  inQueue: boolean;\n}\n\ninterface EffectViewData {\n  id: string;\n  name: string;\n  enabled: boolean;\n}\n\ninterface QueuePlaylistViewData {\n  id: string | null;\n  name: string;\n  collapsed: boolean;\n  tracks: QueueTrackViewData[];\n}\n\ninterface QueueTrackViewData {\n  queueId: string;\n  libraryItemId: string;\n  name: string;\n  group: TrackGroup;\n  tags: string[];\n  isPlaying: boolean;\n  isPaused: boolean;\n  isStopped: boolean;\n  isLoading: boolean;\n  volume: number;\n  volumePercent: number;\n\n  playbackMode: string; // New playback mode system\n  currentTime: number;\n  currentTimeFormatted: string;\n  duration: number;\n  durationFormatted: string;\n  progress: number;\n  shouldBeHidden: boolean; // Computed: true if collapsed and not playing/paused\n}\n\n// ─────────────────────────────────────────────────────────────\n// SoundMixerApp - Mixer Tab Controller\n// ─────────────────────────────────────────────────────────────\n\nexport class SoundMixerApp {\n  private engine: AudioEngine;\n  private socket: SocketManager;\n  private libraryManager: LibraryManager;\n  private queueManager: PlaybackQueueManager;\n  private collapsedPlaylists: Set<string> = new Set();\n  private ungroupedCollapsed: boolean = false;\n  private updateInterval: ReturnType<typeof setInterval> | null = null;\n  private html: JQuery | null = null;\n  private renderParent: (() => void) | null = null;\n\n  // Throttle for socket broadcasts\n  private seekThrottleTimers: Map<string, ReturnType<typeof setTimeout>> = new Map();\n  private volumeThrottleTimers: Map<string, ReturnType<typeof setTimeout>> = new Map();\n  private static THROTTLE_MS = 200;\n\n  // Stored callbacks for proper cleanup\n  private _onQueueChangeBound: () => void;\n  private _onTrackEndedBound: () => void;\n  private _hookFavoritesId: number = 0;\n  private _hookAutoSwitchId: number = 0;\n\n  // Drag-and-Drop State (Optimization with RAF)\n  private _dragTarget: HTMLElement | null = null;\n  private _dragPosition: 'above' | 'below' | null = null;\n  private _rafId: number | null = null;\n  private _pendingDragUpdate: { target: HTMLElement, position: 'above' | 'below' } | null = null;\n\n  constructor(\n    engine: AudioEngine,\n    socket: SocketManager,\n    libraryManager: LibraryManager,\n    queueManager: PlaybackQueueManager\n  ) {\n    this.engine = engine;\n    this.socket = socket;\n    this.libraryManager = libraryManager;\n    this.queueManager = queueManager;\n\n    // Store bound callbacks for cleanup\n    this._onQueueChangeBound = () => this.onQueueChange();\n    this._onTrackEndedBound = () => this.onTrackStateChange();\n\n    // Subscribe to queue changes for real-time updates\n    this.queueManager.on('change', this._onQueueChangeBound);\n\n    // Subscribe to track state changes for UI updates\n    this.engine.on('trackEnded', this._onTrackEndedBound);\n\n    // Listen for external favorite changes (Global Hook)\n    this._hookFavoritesId = Hooks.on('ase.favoritesChanged' as any, () => {\n      this.requestRender();\n    });\n\n    // Listen for automatic track switches from PlaybackScheduler\n    this._hookAutoSwitchId = Hooks.on('ase.trackAutoSwitched' as any, () => {\n      Logger.debug('[SoundMixerApp] Track auto-switched, re-rendering');\n      this.requestRender();\n    });\n  }\n\n  // Set callback for requesting parent render\n  setRenderCallback(callback: () => void): void {\n    this.renderParent = callback;\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Data Provider\n  // ─────────────────────────────────────────────────────────────\n\n  getData(): MixerViewData {\n    // Get ordered favorites from library (includes both tracks and playlists)\n    const orderedFavorites = this.libraryManager.getOrderedFavorites();\n    const favorites: FavoriteViewData[] = [];\n\n    for (const fav of orderedFavorites) {\n      // Check if item is in queue (same pattern as LocalLibraryApp.ts:153-155)\n      const inQueue = fav.type === 'track'\n        ? (window.ASE?.queue?.hasItem(fav.id) ?? false)\n        : (window.ASE?.queue?.getItems().some((q) => q.playlistId === fav.id) ?? false);\n\n      if (fav.type === 'track') {\n        const item = this.libraryManager.getItem(fav.id);\n        if (item) {\n          const player = this.engine.getTrack(item.id);\n          favorites.push({\n            id: item.id,\n            name: item.name,\n            type: 'track',\n            group: item.group,\n            isPlaying: player?.state === 'playing',\n            isPaused: player?.state === 'paused',\n            inQueue,\n          });\n        }\n      } else if (fav.type === 'playlist') {\n        const playlist = this.libraryManager.playlists.getPlaylist(fav.id);\n        if (playlist) {\n          favorites.push({\n            id: playlist.id,\n            name: playlist.name,\n            type: 'playlist',\n            group: undefined,\n            isPlaying: false, // Playlists don't have individual play state\n            isPaused: false,\n            inQueue,\n          });\n        }\n      }\n    }\n\n    // Get queue items grouped by playlist\n    const queueItems = this.queueManager.getItems();\n    const queuePlaylists = this.groupQueueByPlaylist(queueItems);\n\n    // Get all effects from engine\n    const effects: EffectViewData[] = this.engine.getAllEffects().map((effect) => ({\n      id: effect.id,\n      name: effect.type,\n      enabled: effect.enabled,\n    }));\n\n    return {\n      favorites,\n      queuePlaylists,\n      effects,\n    };\n  }\n\n  private groupQueueByPlaylist(queueItems: QueueItem[]): QueuePlaylistViewData[] {\n    const groups = new Map<string | null, QueueItem[]>();\n\n    // Group by playlistId (null for un-grouped tracks)\n    for (const item of queueItems) {\n      const key = item.playlistId ?? null;\n      if (!groups.has(key)) {\n        groups.set(key, []);\n      }\n      groups.get(key)!.push(item);\n    }\n\n    const playlists: QueuePlaylistViewData[] = [];\n\n    for (const [playlistId, items] of groups) {\n      // Get playlist name\n      let name = 'Ungrouped';\n      if (playlistId) {\n        const playlist = this.libraryManager.playlists.getPlaylist(playlistId);\n        name = playlist?.name ?? 'Unknown Playlist';\n      }\n\n      const collapsed = playlistId ? this.collapsedPlaylists.has(playlistId) : this.ungroupedCollapsed;\n      const tracks = items.map(queueItem => this.getQueueTrackViewData(queueItem, collapsed));\n\n      playlists.push({\n        id: playlistId,\n        name,\n        collapsed: playlistId ? this.collapsedPlaylists.has(playlistId) : this.ungroupedCollapsed,\n        tracks,\n      });\n    }\n\n    return playlists;\n  }\n\n  private getQueueTrackViewData(queueItem: QueueItem, parentCollapsed: boolean = false): QueueTrackViewData {\n    const libraryItem = this.libraryManager.getItem(queueItem.libraryItemId);\n    const player = this.engine.getTrack(queueItem.libraryItemId);\n\n    const currentTimeRaw = player?.getCurrentTime() ?? 0;\n    const duration = libraryItem?.duration ?? player?.getDuration() ?? 0;\n    const currentTime = Math.min(currentTimeRaw, duration);\n\n    let progress = 0;\n    if (duration > 0 && Number.isFinite(duration)) {\n      progress = (currentTime / duration) * 100;\n    }\n    progress = Math.min(Math.max(progress, 0), 100);\n\n    // Get volume and loop from player if available (persisted state), fallback to queueItem\n    const volume = player?.volume ?? queueItem.volume;\n\n    const isPlaying = player?.state === 'playing';\n    const isPaused = player?.state === 'paused';\n    const shouldBeHidden = parentCollapsed && !isPlaying && !isPaused;\n\n    return {\n      queueId: queueItem.id,\n      libraryItemId: queueItem.libraryItemId,\n      name: libraryItem?.name ?? 'Unknown Track',\n      group: libraryItem?.group ?? queueItem.group,\n      tags: libraryItem?.tags ?? [],\n      isPlaying,\n      isPaused,\n      isStopped: !player || player.state === 'stopped',\n      isLoading: player?.state === 'loading',\n      volume,\n      volumePercent: Math.round(volume * 100),\n      playbackMode: libraryItem?.playbackMode || 'inherit', // Add playbackMode\n      currentTime,\n      currentTimeFormatted: formatTime(currentTime),\n      duration,\n      durationFormatted: formatTime(duration),\n      progress,\n      shouldBeHidden,\n    };\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Event Listeners\n  // ─────────────────────────────────────────────────────────────\n\n  activateListeners(html: JQuery): void {\n    this.html = html;\n    this.startUpdates();\n\n    // Favorites controls\n    html.find('[data-action=\"play-favorite\"]').on('click', (e) => this.onPlayFavorite(e));\n    html.find('[data-action=\"pause-favorite\"]').on('click', (e) => this.onPauseFavorite(e));\n    html.find('[data-action=\"stop-favorite\"]').on('click', (e) => this.onStopFavorite(e));\n    html.find('[data-action=\"add-to-queue-from-favorite\"]').on('click', (e) => this.onAddToQueueFromFavorite(e));\n\n    // Queue controls\n    html.find('[data-action=\"play-queue\"]').on('click', (e) => this.onPlayQueueItem(e));\n    html.find('[data-action=\"pause-queue\"]').on('click', (e) => this.onPauseQueueItem(e));\n    html.find('[data-action=\"stop-queue\"]').on('click', (e) => this.onStopQueueItem(e));\n    html.find('[data-action=\"remove-queue\"]').on('click', (e) => this.onRemoveQueueItem(e));\n    // Removed old loop button handler\n    html.find('[data-action=\"track-mode-dropdown\"]').on('click', (e) => this.onTrackModeClick(e));\n    html.find('[data-action=\"channel-dropdown\"]').on('click', (e) => this.onChannelDropdown(e));\n\n    // Playlist collapse/expand\n    html.find('[data-action=\"toggle-playlist\"]').on('click', (e) => this.onTogglePlaylist(e));\n\n    // Track controls\n    html.find('[data-action=\"seek\"]').on('input', (e) => this.onSeek(e));\n    html.find('[data-action=\"volume\"]').on('input', (e) => this.onVolumeChange(e));\n\n    // Real-time volume display update (without triggering audio change)\n    html.find('.volume-slider').on('input', (e) => {\n      const slider = e.currentTarget as HTMLInputElement;\n      const value = slider.value;\n      const volumeDisplay = $(slider).siblings('.vol-value');\n      volumeDisplay.text(`${value}%`);\n    });\n\n    // Progress bar time preview on hover\n    html.find('.progress-section').each((_, section) => {\n      const $section = $(section);\n      const $tooltip = $section.find('.progress-hover-time');\n\n      $section.on('mousemove', (e) => {\n        const rect = section.getBoundingClientRect();\n        const offsetX = e.clientX - rect.left;\n        const percentage = Math.max(0, Math.min(100, (offsetX / rect.width) * 100));\n\n        // Get duration from nearest track\n        const $track = $section.closest('.ase-queue-track');\n        const durationText = $track.find('.track-timer').text().split('/')[1]?.trim();\n\n        if (durationText) {\n          // Parse duration MM:SS to seconds\n          const [mins, secs] = durationText.split(':').map(Number);\n          const totalSeconds = (mins * 60) + secs;\n          const hoverSeconds = Math.floor((percentage / 100) * totalSeconds);\n\n          // Format to MM:SS\n          const hoverMins = Math.floor(hoverSeconds / 60);\n          const hoverSecs = hoverSeconds % 60;\n          const hoverTime = `${hoverMins}:${hoverSecs.toString().padStart(2, '0')}`;\n\n          $tooltip.text(hoverTime);\n          $tooltip.css({\n            left: `${percentage}%`,\n            display: 'block'\n          });\n        }\n      });\n\n      $section.on('mouseleave', () => {\n        $tooltip.css('display', 'none');\n      });\n    });\n\n    // Effects controls\n    html.find('[data-action=\"toggle-effect\"]').on('click', (e) => this.onToggleEffect(e));\n\n    // Drag and Drop\n    this.setupDragAndDrop(html);\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Favorites Handlers\n  // ─────────────────────────────────────────────────────────────\n\n  private async onPlayFavorite(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n    event.stopPropagation();\n    const $el = $(event.currentTarget);\n    const id = $el.data('favorite-id') as string;\n    const type = $el.data('favorite-type') as 'track' | 'playlist';\n\n    if (type === 'track') {\n      // Add track to queue if not already there\n      const libraryItem = this.libraryManager.getItem(id);\n      if (libraryItem) {\n        const queueItems = this.queueManager.getItems();\n        const existingQueueItem = queueItems.find(\n          (item) => item.libraryItemId === id && !item.playlistId\n        );\n\n        if (!existingQueueItem) {\n          this.queueManager.addItem(id, { group: libraryItem.group });\n        }\n\n        // Play the track with single track context\n        const context: PlaybackContext = {\n          type: 'track',\n          playbackMode: libraryItem.playbackMode\n        };\n        await this.playTrack(id, context);\n      }\n    } else {\n      // Add entire playlist to queue if not already there\n      const playlist = this.libraryManager.playlists.getPlaylist(id);\n      if (playlist) {\n        const queueItems = this.queueManager.getItems();\n        const existingPlaylistItems = queueItems.filter(\n          (item) => item.playlistId === id\n        );\n\n        if (existingPlaylistItems.length === 0) {\n          const tracks = this.libraryManager.playlists.getPlaylistTracks(id);\n          const playlistItems = tracks.map((t) => {\n            const item = this.libraryManager.getItem(t.libraryItemId);\n            return {\n              libraryItemId: t.libraryItemId,\n              group: item?.group || ('music' as const),\n            };\n          });\n          this.queueManager.addPlaylist(id, playlistItems as any);\n        }\n\n        // Play first track from playlist\n        await this.playPlaylist(id);\n      }\n    }\n    this.requestRender();\n  }\n\n  private onPauseFavorite(event: JQuery.ClickEvent): void {\n    event.preventDefault();\n    event.stopPropagation();\n    const $el = $(event.currentTarget);\n    const id = $el.data('favorite-id') as string;\n    const type = $el.data('favorite-type') as string;\n\n    if (type === 'track') {\n      this.pauseTrack(id);\n    }\n    this.requestRender();\n  }\n\n  private onStopFavorite(event: JQuery.ClickEvent): void {\n    event.preventDefault();\n    event.stopPropagation();\n    const $el = $(event.currentTarget);\n    const id = $el.data('favorite-id') as string;\n    const type = $el.data('favorite-type') as string;\n\n    if (type === 'track') {\n      this.stopTrack(id);\n    } else {\n      // Stop all tracks in playlist\n      this.stopPlaylist(id);\n    }\n    this.requestRender();\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Queue Item Handlers\n  // ─────────────────────────────────────────────────────────────\n\n  private async onPlayQueueItem(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n    event.stopPropagation();\n    const $track = $(event.currentTarget).closest('.ase-queue-track');\n    const queueId = $track.data('queue-id') as string;\n    const itemId = $track.data('item-id') as string;\n\n    // Find specific queue item by unique ID\n    const queueItem = this.queueManager.getItems().find(q => q.id === queueId);\n    if (!queueItem) {\n      Logger.warn(`Queue item not found for ID: ${queueId}`);\n      return;\n    }\n\n    let context: PlaybackContext;\n\n    if (queueItem.playlistId) {\n      // Трек из плейлиста\n      const playlist = this.libraryManager.playlists.getPlaylist(queueItem.playlistId);\n      context = {\n        type: 'playlist',\n        id: queueItem.playlistId,\n        playbackMode: playlist?.playbackMode || 'loop'\n      };\n    } else {\n      // Отдельный трек\n      const libraryItem = this.libraryManager.getItem(itemId);\n      context = {\n        type: 'track',\n        playbackMode: libraryItem?.playbackMode || 'inherit'\n      };\n    }\n\n    await this.playTrack(itemId, context);\n    this.requestRender();\n  }\n\n  private onPauseQueueItem(event: JQuery.ClickEvent): void {\n    event.preventDefault();\n    event.stopPropagation();\n    const $track = $(event.currentTarget).closest('.ase-queue-track');\n    const itemId = $track.data('item-id') as string;\n    this.pauseTrack(itemId);\n    this.requestRender();\n  }\n\n  private onStopQueueItem(event: JQuery.ClickEvent): void {\n    event.preventDefault();\n    event.stopPropagation();\n    const $track = $(event.currentTarget).closest('.ase-queue-track');\n    const itemId = $track.data('item-id') as string;\n    this.stopTrack(itemId);\n    this.requestRender();\n  }\n\n  private onRemoveQueueItem(event: JQuery.ClickEvent): void {\n    event.preventDefault();\n    event.stopPropagation();\n    const $track = $(event.currentTarget).closest('.ase-queue-track');\n    const queueId = $track.data('queue-id') as string;\n    const itemId = $track.data('item-id') as string;\n\n    // Stop the track first\n    this.stopTrack(itemId);\n    // Remove from queue\n    this.queueManager.removeItem(queueId);\n    this.requestRender();\n  }\n\n  /**\n   * Handle playback mode dropdown click\n   */\n  private onTrackModeClick(event: JQuery.ClickEvent): void {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const btn = $(event.currentTarget);\n    // Support both direct data on icon\n    let itemId = btn.data('item-id') as string;\n    if (!itemId) {\n      itemId = btn.closest('[data-item-id]').data('item-id') as string;\n    }\n\n    const item = this.libraryManager.getItem(itemId);\n    if (!item) {\n      Logger.warn(`Track Mode Clicked: Item not found for ID ${itemId}`);\n      return;\n    }\n\n    const modes: { label: string, value: string, icon: string }[] = [\n      { label: 'Inherit (Default)', value: 'inherit', icon: 'fa-arrow-turn-down' },\n      { label: 'Loop', value: 'loop', icon: 'fa-repeat' },\n      { label: 'Single', value: 'single', icon: 'fa-arrow-right-to-line' },\n      { label: 'Linear', value: 'linear', icon: 'fa-arrow-right' },\n      { label: 'Random', value: 'random', icon: 'fa-shuffle' }\n    ];\n\n    this.showModeContextMenu(event, modes, (mode) => {\n      this.libraryManager.updateItem(itemId, { playbackMode: mode as any });\n      this.requestRender();\n    });\n  }\n\n  /**\n   * Show context menu for mode selection\n   */\n  private showModeContextMenu(event: JQuery.ClickEvent, modes: any[], callback: (mode: string) => void): void {\n    const menuHtml = `\n      <div id=\"ase-mode-menu\" class=\"ase-context-menu\">\n        ${modes.map(m => `\n          <div class=\"ase-ctx-item\" data-value=\"${m.value}\">\n              <i class=\"fa-solid ${m.icon}\"></i> \n              <span>${m.label}</span>\n          </div>\n        `).join('')}\n      </div>\n    `;\n\n    $('#ase-mode-menu').remove();\n    const menu = $(menuHtml);\n    $('body').append(menu);\n\n    menu.css({ top: event.clientY, left: event.clientX });\n\n    menu.find('.ase-ctx-item').on('click', (e) => {\n      e.stopPropagation();\n      const val = $(e.currentTarget).data('value');\n      Logger.debug(`Mode Selected: ${val}`);\n      callback(val);\n      menu.remove();\n    });\n\n    // Close on click outside\n    setTimeout(() => {\n      $('body').one('click', () => {\n        menu.remove();\n      });\n    }, 10);\n  }\n\n  /**\n   * Handle channel dropdown click\n   */\n  private onChannelDropdown(event: JQuery.ClickEvent): void {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const btn = $(event.currentTarget);\n    const itemId = btn.data('item-id') as string;\n\n    // Also try finding it if clicked on icon inside\n    const id = itemId || btn.closest('[data-item-id]').data('item-id') as string;\n\n    const item = this.libraryManager.getItem(id);\n    if (!item) return;\n\n    const currentGroup = item.group || 'music';\n    const channels = ['music', 'ambience', 'sfx'];\n\n    // Create dropdown menu\n    const menu = $(`\n      <div class=\"ase-dropdown-menu\">\n        ${channels.map(ch => `\n          <div class=\"ase-dropdown-item ${ch === currentGroup ? 'active' : ''}\" data-channel=\"${ch}\">\n            ${ch.charAt(0).toUpperCase() + ch.slice(1)}\n          </div>\n        `).join('')}\n      </div>\n    `);\n\n    // Position menu\n    const rect = (event.currentTarget as HTMLElement).getBoundingClientRect();\n    menu.css({ top: rect.bottom + 2, left: rect.left });\n\n    $('body').append(menu);\n\n    menu.find('.ase-dropdown-item').on('click', (e) => {\n      e.stopPropagation();\n      const newChannel = $(e.currentTarget).data('channel') as string;\n      this.updateTrackChannel(id, newChannel);\n      menu.remove();\n    });\n\n    // Close on outside click\n    setTimeout(() => {\n      $(document).one('click', () => menu.remove());\n    }, 10);\n  }\n\n  private updateTrackChannel(itemId: string, channel: string): void {\n    const item = this.libraryManager.getItem(itemId);\n    if (!item) return;\n\n    this.libraryManager.updateItem(itemId, { group: channel as any });\n\n    // Also update queue item logic if needed? \n    // LibraryManager update should trigger re-renders via hooks/events eventually, \n    // but Mixer subscribes to queue changes mostly.\n    // However, LibraryItem update doesn't automatically trigger \"queue change\" event unless\n    // something in queue manager reacts to library updates.\n    // Let's force render.\n    this.requestRender();\n    ui.notifications?.info(`Channel set to ${channel}`);\n  }\n\n  private async onAddToQueueFromFavorite(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n    event.stopPropagation();\n    const $el = $(event.currentTarget);\n    const id = $el.data('favorite-id') as string;\n    const type = $el.data('favorite-type') as 'track' | 'playlist';\n\n    if (type === 'track') {\n      const libraryItem = this.libraryManager.getItem(id);\n      if (!libraryItem) return;\n\n      // Toggle: if already in queue, remove it\n      if (this.queueManager.hasItem(id)) {\n        this.queueManager.removeByLibraryItemId(id);\n        Logger.info('Removed track from queue:', libraryItem.name);\n        ui.notifications?.info(`Removed from queue: ${libraryItem.name}`);\n      } else {\n        this.queueManager.addItem(id, { group: libraryItem.group });\n        Logger.info('Added track to queue:', libraryItem.name);\n        ui.notifications?.info(`Added to queue: ${libraryItem.name}`);\n      }\n    } else {\n      // Add entire playlist to queue\n      const playlist = this.libraryManager.playlists.getPlaylist(id);\n      if (!playlist) return;\n\n      const tracks = this.libraryManager.playlists.getPlaylistTracks(id);\n\n      // Check if ALL tracks from playlist are in queue\n      const allInQueue = tracks.every(t => this.queueManager.hasItem(t.libraryItemId));\n\n      if (allInQueue) {\n        // Remove all tracks from this playlist\n        for (const track of tracks) {\n          this.queueManager.removeByLibraryItemId(track.libraryItemId);\n        }\n        Logger.info('Removed playlist from queue:', playlist.name);\n        ui.notifications?.info(`Removed from queue: ${playlist.name}`);\n      } else {\n        // Add playlist tracks\n        const playlistItems = tracks.map(t => {\n          const item = this.libraryManager.getItem(t.libraryItemId);\n          return {\n            libraryItemId: t.libraryItemId,\n            group: item?.group || 'music' as const,\n          };\n        });\n        this.queueManager.addPlaylist(id, playlistItems as any);\n        Logger.info('Added playlist to queue:', playlist.name);\n        ui.notifications?.info(`Added to queue: ${playlist.name}`);\n      }\n    }\n    this.requestRender();\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Drag and Drop\n  // ─────────────────────────────────────────────────────────────\n\n  private setupDragAndDrop(html: JQuery): void {\n    // ── Favorites reordering ──\n\n    // Prevent drag from interactive elements (buttons/icons in favorites)\n    html.find('.ase-favorite-item .ase-icons, .ase-favorite-item button, .ase-favorite-item input').on('pointerdown', (e) => {\n      e.stopPropagation();\n      const $item = $(e.currentTarget).closest('.ase-favorite-item');\n      $item.attr('draggable', 'false');\n    });\n\n    html.find('.ase-list-group[data-section=\"mixer-favorites\"]').on('pointerup pointercancel', () => {\n      html.find('.ase-favorite-item').attr('draggable', 'true');\n    });\n\n    html.find('.ase-favorite-item[draggable=\"true\"]').on('dragstart', (event: JQuery.DragStartEvent) => {\n      event.stopPropagation();\n      const favoriteId = String($(event.currentTarget).data('favorite-id'));\n      const favoriteType = String($(event.currentTarget).data('favorite-type'));\n\n      Logger.info(`[SoundMixerApp] DragStart Favorite: ${favoriteId} (${favoriteType})`);\n\n      event.originalEvent!.dataTransfer!.effectAllowed = 'move';\n      event.originalEvent!.dataTransfer!.setData('application/x-mixer-favorite-id', favoriteId);\n      event.originalEvent!.dataTransfer!.setData('application/x-mixer-favorite-type', favoriteType);\n      $(event.currentTarget).addClass('dragging');\n    });\n\n    html.find('.ase-favorite-item[draggable=\"true\"]').on('dragend', (event: JQuery.DragEndEvent) => {\n      // Cancel any pending RAF to prevent stale class application\n      if (this._rafId) {\n        cancelAnimationFrame(this._rafId);\n        this._rafId = null;\n      }\n      this._pendingDragUpdate = null;\n      this._dragTarget = null;\n      this._dragPosition = null;\n\n      $(event.currentTarget).removeClass('dragging');\n      html.find('.ase-favorite-item').removeClass('drag-over drag-above drag-below');\n    });\n\n    // Favorites visual feedback for insertion position\n    html.find('.ase-favorite-item').on('dragover', (event: JQuery.DragOverEvent) => {\n      // Robust check for types (Array or DOMStringList)\n      const types = event.originalEvent!.dataTransfer!.types;\n      const hasFavoriteId = (types instanceof DOMStringList && types.contains('application/x-mixer-favorite-id')) ||\n        (types instanceof Array && types.includes('application/x-mixer-favorite-id')) ||\n        (Array.from(types).includes('application/x-mixer-favorite-id'));\n\n      if (!hasFavoriteId) return;\n\n      event.preventDefault();\n      event.stopPropagation(); // Prevent parent handlers\n      event.originalEvent!.dataTransfer!.dropEffect = 'move';\n\n      // Optimize with RequestAnimationFrame\n      const rect = (event.currentTarget as HTMLElement).getBoundingClientRect();\n      const midY = rect.top + rect.height / 2;\n      const clientY = event.originalEvent!.clientY ?? event.clientY;\n      const isAbove = clientY < midY;\n      const newPos = isAbove ? 'above' : 'below';\n\n      // Store pending update\n      this._pendingDragUpdate = {\n        target: event.currentTarget as HTMLElement,\n        position: newPos\n      };\n\n      // Schedule RAF if not already running\n      if (!this._rafId) {\n        this._rafId = requestAnimationFrame(this._processDragUpdate.bind(this, html, '.ase-favorite-item'));\n      }\n    });\n\n    html.find('.ase-favorite-item').on('dragleave', (event: JQuery.DragLeaveEvent) => {\n      // If we leave the current target, clear it\n      if (this._dragTarget === event.currentTarget) {\n        this._dragTarget = null;\n        this._dragPosition = null;\n        // If we have a pending update for this target, clear it too, but we might have a new one incoming\n        // Simplest: just remove classes immediately on leave to be responsive\n        $(event.currentTarget).removeClass('drag-above drag-below');\n      }\n    });\n\n    html.find('.ase-favorite-item').on('drop', (event: JQuery.DropEvent) => {\n      event.preventDefault();\n      event.stopPropagation();\n\n      // Capture position before clearing state\n      const dropPosition = this._dragPosition || 'above';\n\n      // Cleanup RAF\n      if (this._rafId) {\n        cancelAnimationFrame(this._rafId);\n        this._rafId = null;\n      }\n      this._pendingDragUpdate = null;\n      this._dragTarget = null;\n      this._dragPosition = null;\n\n      const targetId = String($(event.currentTarget).data('favorite-id'));\n      const targetType = String($(event.currentTarget).data('favorite-type')) as 'track' | 'playlist';\n\n      html.find('.ase-favorite-item').removeClass('drag-above drag-below dragging');\n\n      const draggedId = event.originalEvent!.dataTransfer!.getData('application/x-mixer-favorite-id');\n      const draggedType = event.originalEvent!.dataTransfer!.getData('application/x-mixer-favorite-type') as 'track' | 'playlist';\n\n      Logger.info(`[SoundMixerApp] Drop Favorite: ${draggedId} -> ${targetId} (${dropPosition})`);\n\n      if (draggedId && draggedType && (draggedId !== targetId || draggedType !== targetType)) {\n        this.handleFavoriteReorder(draggedId, draggedType, targetId, targetType, dropPosition);\n      }\n    });\n\n    // ── Queue track reordering ──\n\n    // Prevent drag from interactive elements (volume, seek, buttons)\n    // stopPropagation alone doesn't block native HTML5 drag - we must disable draggable attribute\n    html.find('.ase-queue-track input, .ase-queue-track button, .ase-queue-track .volume-container, .ase-queue-track .progress-wrapper').on('pointerdown', (e) => {\n      e.stopPropagation();\n      const $track = $(e.currentTarget).closest('.ase-queue-track');\n      $track.attr('draggable', 'false');\n    });\n\n    // Restore draggable on pointer release (delegated to track list container)\n    html.find('.ase-track-player-list').on('pointerup pointercancel', () => {\n      html.find('.ase-queue-track').attr('draggable', 'true');\n    });\n\n    html.find('.ase-queue-track[draggable=\"true\"]').on('dragstart', (event: JQuery.DragStartEvent) => {\n      event.stopPropagation();\n      const queueId = String($(event.currentTarget).data('queue-id'));\n\n\n      Logger.info(`[SoundMixerApp] DragStart Queue: ${queueId}`);\n\n      event.originalEvent!.dataTransfer!.effectAllowed = 'move';\n      event.originalEvent!.dataTransfer!.setData('application/x-mixer-queue-id', queueId);\n      $(event.currentTarget).addClass('dragging');\n    });\n\n    html.find('.ase-queue-track[draggable=\"true\"]').on('dragend', (event: JQuery.DragEndEvent) => {\n      // Cancel any pending RAF to prevent stale class application\n      if (this._rafId) {\n        cancelAnimationFrame(this._rafId);\n        this._rafId = null;\n      }\n      this._pendingDragUpdate = null;\n      this._dragTarget = null;\n      this._dragPosition = null;\n\n      $(event.currentTarget).removeClass('dragging');\n      html.find('.ase-queue-track').removeClass('drag-over drag-above drag-below');\n\n      // Restore draggable in case it was disabled by slider interaction\n      $(event.currentTarget).attr('draggable', 'true');\n    });\n\n    html.find('.ase-queue-track').on('dragover', (event: JQuery.DragOverEvent) => {\n      const types = event.originalEvent!.dataTransfer!.types;\n      const hasQueueId = (types instanceof DOMStringList && types.contains('application/x-mixer-queue-id')) ||\n        (types instanceof Array && types.includes('application/x-mixer-queue-id')) ||\n        (Array.from(types).includes('application/x-mixer-queue-id'));\n\n      if (!hasQueueId) return;\n\n      event.preventDefault();\n      event.stopPropagation();\n      event.originalEvent!.dataTransfer!.dropEffect = 'move';\n\n      // Optimize Queue Drag with RAF\n      const rect = (event.currentTarget as HTMLElement).getBoundingClientRect();\n      const midY = rect.top + rect.height / 2;\n      const clientY = event.originalEvent!.clientY ?? event.clientY;\n      const isAbove = clientY < midY;\n      const newPos = isAbove ? 'above' : 'below';\n\n      this._pendingDragUpdate = {\n        target: event.currentTarget as HTMLElement,\n        position: newPos\n      };\n\n      if (!this._rafId) {\n        this._rafId = requestAnimationFrame(this._processDragUpdate.bind(this, html, '.ase-queue-track'));\n      }\n    });\n\n    html.find('.ase-queue-track').on('dragleave', (event: JQuery.DragLeaveEvent) => {\n      if (this._dragTarget === event.currentTarget) {\n        this._dragTarget = null;\n        this._dragPosition = null;\n        $(event.currentTarget).removeClass('drag-above drag-below');\n      }\n    });\n\n    html.find('.ase-queue-track').on('drop', (event: JQuery.DropEvent) => {\n      event.preventDefault();\n      event.stopPropagation();\n\n      // Capture position before clearing state\n      const dropPosition = this._dragPosition || 'above';\n\n      if (this._rafId) {\n        cancelAnimationFrame(this._rafId);\n        this._rafId = null;\n      }\n      this._pendingDragUpdate = null;\n      this._dragTarget = null;\n      this._dragPosition = null;\n\n      html.find('.ase-queue-track').removeClass('drag-above drag-below dragging');\n\n      const draggedQueueId = event.originalEvent!.dataTransfer!.getData('application/x-mixer-queue-id');\n      const targetQueueId = String($(event.currentTarget).data('queue-id'));\n\n      Logger.info(`[SoundMixerApp] Drop Queue: ${draggedQueueId} -> ${targetQueueId} (${dropPosition})`);\n\n      if (draggedQueueId && draggedQueueId !== targetQueueId) {\n        this.handleQueueReorder(draggedQueueId, targetQueueId, dropPosition);\n      }\n    });\n  }\n\n  private handleFavoriteReorder(\n    draggedId: string,\n    draggedType: 'track' | 'playlist',\n    targetId: string,\n    targetType: 'track' | 'playlist',\n    position: 'above' | 'below'\n  ): void {\n    const favorites = this.libraryManager.getOrderedFavorites();\n    const draggedIndex = favorites.findIndex(f => f.id === draggedId && f.type === draggedType);\n    const targetIndex = favorites.findIndex(f => f.id === targetId && f.type === targetType);\n\n    if (draggedIndex === -1 || targetIndex === -1) return;\n\n    const [draggedItem] = favorites.splice(draggedIndex, 1);\n    // After splice, target shifted if dragged was before it\n    let insertIndex: number;\n    if (position === 'above') {\n      insertIndex = draggedIndex < targetIndex ? targetIndex - 1 : targetIndex;\n    } else {\n      insertIndex = draggedIndex < targetIndex ? targetIndex : targetIndex + 1;\n    }\n    // Clamp to valid range after removal\n    insertIndex = Math.max(0, Math.min(insertIndex, favorites.length));\n    favorites.splice(insertIndex, 0, draggedItem);\n\n    this.libraryManager.reorderFavorites(favorites);\n    this.requestRender();\n    Logger.debug(`[SoundMixerApp] Reordered favorite ${draggedId} to position ${insertIndex} (${position})`);\n  }\n\n  private handleQueueReorder(draggedQueueId: string, targetQueueId: string, position: 'above' | 'below'): void {\n    const items = this.queueManager.getItems();\n    const draggedIndex = items.findIndex(i => i.id === draggedQueueId);\n    const targetIndex = items.findIndex(i => i.id === targetQueueId);\n\n    if (draggedIndex === -1 || targetIndex === -1) return;\n\n    // Account for splice behavior: removing an item before the target shifts indices.\n    // After splice(draggedIndex, 1), inserting at newIndex puts the item at:\n    //   - newIndex in the post-removal array\n    //   - If draggedIndex < targetIndex: effective original position = newIndex + 1\n    //   - If draggedIndex > targetIndex: effective original position = newIndex\n    let newIndex: number;\n    if (position === 'above') {\n      // Place before target\n      newIndex = draggedIndex < targetIndex ? targetIndex - 1 : targetIndex;\n    } else {\n      // Place after target\n      newIndex = draggedIndex < targetIndex ? targetIndex : targetIndex + 1;\n    }\n\n    this.queueManager.moveItem(draggedQueueId, newIndex);\n    Logger.debug(`[SoundMixerApp] Reordered queue item ${draggedQueueId} to position ${newIndex} (${position} target ${targetIndex})`);\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Playlist Toggle\n  // ─────────────────────────────────────────────────────────────\n\n  private onTogglePlaylist(event: JQuery.ClickEvent): void {\n    event.preventDefault();\n    const $playlist = $(event.currentTarget).closest('.ase-queue-playlist');\n    const playlistId = $playlist.data('playlist-id') as string | null;\n\n    // Handle Ungrouped (null/undefined) vs actual playlist IDs\n    if (playlistId === null || playlistId === undefined || playlistId === '') {\n      // Toggle Ungrouped\n      this.ungroupedCollapsed = !this.ungroupedCollapsed;\n    } else {\n      // Toggle normal playlist\n      if (this.collapsedPlaylists.has(playlistId)) {\n        this.collapsedPlaylists.delete(playlistId);\n      } else {\n        this.collapsedPlaylists.add(playlistId);\n      }\n    }\n\n    // Re-render to apply visual changes via Handlebars template\n    // This ensures tracks are shown/hidden based on their current state\n    this.requestRender();\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Track Controls\n  // ─────────────────────────────────────────────────────────────\n\n  private onSeek(event: JQuery.TriggeredEvent): void {\n    const $track = $(event.currentTarget).closest('.ase-queue-track');\n    const itemId = $track.data('item-id') as string;\n    const value = parseFloat($(event.currentTarget).val() as string);\n\n    const player = this.engine.getTrack(itemId);\n    if (player) {\n      const seekTime = (value / 100) * player.getDuration();\n      this.engine.seekTrack(itemId, seekTime);\n\n      // Throttled sync for socket\n      if (this.socket.syncEnabled) {\n        if (!this.seekThrottleTimers.has(itemId)) {\n          this.seekThrottleTimers.set(itemId, setTimeout(() => {\n            this.seekThrottleTimers.delete(itemId);\n            const currentPlayer = this.engine.getTrack(itemId);\n            if (currentPlayer) {\n              this.socket.broadcastTrackSeek(itemId, currentPlayer.getCurrentTime(), currentPlayer.state === 'playing');\n            }\n          }, SoundMixerApp.THROTTLE_MS));\n        }\n      }\n    }\n  }\n\n  private onVolumeChange(event: JQuery.TriggeredEvent): void {\n    const $track = $(event.currentTarget).closest('.ase-queue-track');\n    const itemId = $track.data('item-id') as string;\n    const value = parseInt($(event.currentTarget).val() as string, 10);\n    const volume = value / 100;\n\n    // Update engine volume\n    this.engine.setTrackVolume(itemId, volume);\n\n    // Throttled sync for socket\n    if (this.socket.syncEnabled) {\n      if (!this.volumeThrottleTimers.has(itemId)) {\n        this.volumeThrottleTimers.set(itemId, setTimeout(() => {\n          this.volumeThrottleTimers.delete(itemId);\n          const currentPlayer = this.engine.getTrack(itemId);\n          if (currentPlayer) {\n            this.socket.broadcastTrackVolume(itemId, currentPlayer.volume);\n          }\n        }, SoundMixerApp.THROTTLE_MS));\n      }\n    }\n\n    // Update display\n    $track.find('.ase-volume-value').text(`${value}%`);\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Playback Core Methods\n  // ─────────────────────────────────────────────────────────────\n\n  /**\n   * Воспроизвести трек с опциональным контекстом\n   * @param itemId - ID трека из библиотеки\n   * @param context - Контекст воспроизведения (playlist, track, queue)\n   */\n  private async playTrack(itemId: string, context?: PlaybackContext): Promise<void> {\n    const libraryItem = this.libraryManager.getItem(itemId);\n    if (!libraryItem) {\n      Logger.warn('Track not found in library:', itemId);\n      return;\n    }\n\n    let player = this.engine.getTrack(itemId);\n\n    // If player exists and is paused, resume from current position\n    if (player && player.state === 'paused') {\n      const offset = player.getCurrentTime();\n      await this.engine.playTrack(itemId, offset, context);\n\n      if (this.socket.syncEnabled) {\n        this.socket.broadcastTrackPlay(itemId, offset);\n      }\n      return;\n    }\n\n    // Create track if not exists\n    if (!player) {\n      player = await this.engine.createTrack({\n        id: itemId,\n        url: libraryItem.url,\n        group: libraryItem.group,\n        volume: 1,\n      });\n    }\n\n    // Создать контекст, если не передан\n    const playbackContext: PlaybackContext = context || {\n      type: 'track',\n      playbackMode: libraryItem.playbackMode\n    };\n\n    await this.engine.playTrack(itemId, 0, playbackContext);\n\n    // Sync if enabled\n    if (this.socket.syncEnabled) {\n      this.socket.broadcastTrackPlay(itemId, 0);\n    }\n  }\n\n  private pauseTrack(itemId: string): void {\n    const player = this.engine.getTrack(itemId);\n    this.engine.pauseTrack(itemId);\n\n    if (this.socket.syncEnabled && player) {\n      this.socket.broadcastTrackPause(itemId, player.getCurrentTime());\n    }\n  }\n\n  private stopTrack(itemId: string): void {\n    this.engine.stopTrack(itemId);\n\n    if (this.socket.syncEnabled) {\n      this.socket.broadcastTrackStop(itemId);\n    }\n  }\n\n  /**\n   * Воспроизвести плейлист (запускает первый трек с контекстом плейлиста)\n   * @param playlistId - ID плейлиста\n   */\n  private async playPlaylist(playlistId: string): Promise<void> {\n    const playlist = this.libraryManager.playlists.getPlaylist(playlistId);\n    if (!playlist) {\n      Logger.warn('Playlist not found:', playlistId);\n      return;\n    }\n\n    const tracks = this.libraryManager.playlists.getPlaylistTracks(playlistId);\n    if (!tracks.length) {\n      Logger.warn('Playlist is empty:', playlist.name);\n      return;\n    }\n\n    // Создать контекст плейлиста\n    const context: PlaybackContext = {\n      type: 'playlist',\n      id: playlistId,\n      playbackMode: playlist.playbackMode\n    };\n\n    // Play first track with playlist context\n    const firstTrack = tracks[0];\n    await this.playTrack(firstTrack.libraryItemId, context);\n  }\n\n  private stopPlaylist(playlistId: string): void {\n    const tracks = this.libraryManager.playlists.getPlaylistTracks(playlistId);\n    for (const track of tracks) {\n      this.stopTrack(track.libraryItemId);\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Real-time Updates\n  // ─────────────────────────────────────────────────────────────\n\n  private startUpdates(): void {\n    if (this.updateInterval) return;\n    this.updateInterval = setInterval(() => this.updateTrackDisplays(), 100);\n  }\n\n  stopUpdates(): void {\n    if (this.updateInterval) {\n      clearInterval(this.updateInterval);\n      this.updateInterval = null;\n    }\n  }\n\n  /**\n   * Full cleanup: stops updates, clears throttle timers, removes all event subscriptions.\n   * Called when the parent window closes.\n   */\n  dispose(): void {\n    this.stopUpdates();\n\n    // Clear all throttle timers\n    for (const timer of this.seekThrottleTimers.values()) {\n      clearTimeout(timer);\n    }\n    this.seekThrottleTimers.clear();\n\n    for (const timer of this.volumeThrottleTimers.values()) {\n      clearTimeout(timer);\n    }\n    this.volumeThrottleTimers.clear();\n\n    // Remove event subscriptions\n    this.queueManager.off('change', this._onQueueChangeBound);\n    this.engine.off('trackEnded', this._onTrackEndedBound);\n\n    // Remove Foundry hooks\n    if (this._hookFavoritesId) {\n      Hooks.off('ase.favoritesChanged' as any, this._hookFavoritesId);\n    }\n    if (this._hookAutoSwitchId) {\n      Hooks.off('ase.trackAutoSwitched' as any, this._hookAutoSwitchId);\n    }\n\n    this.html = null;\n    Logger.debug('[SoundMixerApp] Disposed');\n  }\n\n  private updateTrackDisplays(): void {\n    if (!this.html) return;\n\n    this.html.find('.ase-queue-track').each((_, el) => {\n      const $track = $(el);\n      const itemId = $track.data('item-id') as string;\n      const player = this.engine.getTrack(itemId);\n\n      if (player) {\n        const currentTime = player.getCurrentTime();\n        const duration = player.getDuration();\n        const progress = duration > 0 ? (currentTime / duration) * 100 : 0;\n\n        // Update progress bar\n        $track.find('.progress-fill').css('width', `${progress}%`);\n        $track.find('.seek-slider').val(progress);\n\n        // Update timer\n        $track.find('.track-timer').text(`${formatTime(currentTime)} / ${formatTime(duration)}`);\n\n        // Update state classes and play/pause button\n        $track.removeClass('is-playing is-paused');\n        const $playPauseBtn = $track.find('[data-action=\"play-queue\"], [data-action=\"pause-queue\"]');\n        const $playPauseIcon = $playPauseBtn.find('i');\n\n        if (player.state === 'playing') {\n          $track.addClass('is-playing');\n          $playPauseIcon.removeClass('fa-play').addClass('fa-pause');\n          $playPauseBtn.attr('data-action', 'pause-queue').attr('title', 'Pause');\n        } else if (player.state === 'paused') {\n          $track.addClass('is-paused');\n          $playPauseIcon.removeClass('fa-pause').addClass('fa-play');\n          $playPauseBtn.attr('data-action', 'play-queue').attr('title', 'Play');\n        } else {\n          $playPauseIcon.removeClass('fa-pause').addClass('fa-play');\n          $playPauseBtn.attr('data-action', 'play-queue').attr('title', 'Play');\n        }\n      }\n    });\n  }\n\n  private onQueueChange(): void {\n    Logger.debug('Queue changed, mixer should refresh');\n    this.requestRender();\n  }\n\n  private onTrackStateChange(): void {\n    Logger.debug('[SoundMixerApp] Track state changed, re-rendering mixer');\n    this.requestRender();\n  }\n\n  private requestRender(): void {\n    if (this.renderParent) {\n      this.renderParent();\n    }\n  }\n\n  private onToggleEffect(event: JQuery.ClickEvent): void {\n    event.preventDefault();\n    const $btn = $(event.currentTarget);\n    const effectId = $btn.data('effect-id') as string;\n\n    // Toggle state based on current class\n    const wasEnabled = $btn.hasClass('active');\n    const newState = !wasEnabled;\n\n    this.engine.setEffectEnabled(effectId, newState);\n\n    // Optimistic UI update\n    if (newState) {\n      $btn.addClass('active');\n    } else {\n      $btn.removeClass('active');\n    }\n\n    Logger.info(`Effect ${effectId} ${newState ? 'enabled' : 'disabled'}`);\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // RAF Processor for Drag Events\n  // ─────────────────────────────────────────────────────────────\n\n  private _processDragUpdate(html: JQuery, selector: string): void {\n    this._rafId = null; // Reset ID so new frames can be requested\n\n    if (!this._pendingDragUpdate) return;\n\n    const { target, position } = this._pendingDragUpdate;\n\n    // Avoid redundant DOM updates\n    if (this._dragTarget === target && this._dragPosition === position) {\n      return;\n    }\n\n    // Apply update\n    this._dragTarget = target;\n    this._dragPosition = position;\n\n    // Clean all\n    html.find(selector).removeClass('drag-above drag-below drag-over');\n\n    // Apply new class\n    $(target).addClass(position === 'above' ? 'drag-above' : 'drag-below');\n  }\n}","import { Logger } from '@utils/logger';\nimport type { LibraryState } from '@t/library';\n\nconst MODULE_ID = 'advanced-sound-engine';\n\n/**\n * GlobalStorage - Cross-world persistent storage using JSON files\n * \n * Stores library data in Data/ase_library/library.json\n * which persists across all worlds in Foundry and survives module updates\n */\nexport class GlobalStorage {\n    private static readonly FILE_PATH = '/ase_library/library.json';\n    private static readonly PRESETS_FILE_PATH = '/ase_library/presets.json';\n    private static readonly FILE_SOURCE = 'data';\n    private static readonly DIRECTORY = 'ase_library';\n\n    /**\n     * Load presets from global JSON file\n     */\n    static async loadPresets(): Promise<any[]> {\n        try {\n            const response = await fetch(`${this.PRESETS_FILE_PATH}?t=${Date.now()}`);\n            if (!response.ok) return this.getDefaultPresets();\n            const data = await response.json();\n            return data.length > 0 ? data : this.getDefaultPresets();\n        } catch (error) {\n            Logger.warn('Failed to load presets:', error);\n            return this.getDefaultPresets();\n        }\n    }\n\n    private static getDefaultPresets(): any[] {\n        return [\n            {\n                id: 'preset-cave',\n                name: 'Cave',\n                effects: [\n                    { type: 'reverb', params: { ir: 'cave', level: 1.2 }, routing: { music: false, sfx: true, ambience: true } },\n                    { type: 'delay', params: { time: 0.15, feedback: 0.3, level: 0.5 }, routing: { music: false, sfx: true, ambience: false } }\n                ]\n            },\n            {\n                id: 'preset-underwater',\n                name: 'Underwater',\n                effects: [\n                    { type: 'filter', params: { type: 'lowpass', frequency: 600, Q: 1.0, level: 1.0 }, routing: { music: true, sfx: true, ambience: true } }\n                ]\n            },\n            {\n                id: 'preset-radio',\n                name: 'Old Radio',\n                effects: [\n                    { type: 'filter', params: { type: 'bandpass', frequency: 2000, Q: 2.0, level: 1.5 }, routing: { music: true, sfx: true, ambience: true } },\n                    { type: 'distortion', params: { drive: 20, level: 0.8 }, routing: { music: true, sfx: true, ambience: true } }\n                ]\n            }\n        ];\n    }\n\n    /**\n     * Save presets to global JSON file\n     */\n    static async savePresets(presets: any[]): Promise<void> {\n        return this.saveFile(this.PRESETS_FILE_PATH, presets);\n    }\n\n    /**\n     * Generic save helper (refactored from save method)\n     */\n    private static async saveFile(path: string, data: any): Promise<void> {\n        try {\n            await this.ensureDirectory();\n            const json = JSON.stringify(data, null, 2);\n            const blob = new Blob([json], { type: 'application/json' });\n            const file = new File([blob], path.split('/').pop()!, { type: 'application/json' });\n\n            const originalInfo = ui.notifications?.info;\n            if (ui.notifications) ui.notifications.info = (() => { }) as any;\n\n            try {\n                await FilePicker.upload(this.FILE_SOURCE, this.DIRECTORY, file, {});\n            } finally {\n                if (ui.notifications && originalInfo) ui.notifications.info = originalInfo;\n            }\n        } catch (error) {\n            Logger.error(`Failed to save file ${path}:`, error);\n            throw error;\n        }\n    }\n\n    /**\n     * Load library state from global JSON file\n     */\n    static async load(): Promise<LibraryState | null> {\n        try {\n            // Attempt to fetch the file\n            const response = await fetch(`${this.FILE_PATH}?t=${Date.now()}`);\n\n            if (!response.ok) {\n                Logger.info('No existing library file found');\n                return null;\n            }\n\n            const data = await response.json();\n            Logger.info('Loaded library from global storage');\n            return data as LibraryState;\n        } catch (error) {\n            Logger.warn('Failed to load global library:', error);\n            return null;\n        }\n    }\n\n    /**\n     * Save library state to global JSON file\n     */\n    static async save(state: LibraryState): Promise<void> {\n        try {\n            await this.saveFile(this.FILE_PATH, state);\n            Logger.info('Saved library to global storage');\n        } catch (error) {\n            Logger.error('Failed to save library to global storage:', error);\n            throw error;\n        }\n    }\n\n    /**\n     * Ensure the module directory exists\n     */\n    private static async ensureDirectory(): Promise<void> {\n        try {\n            await FilePicker.createDirectory(this.FILE_SOURCE, this.DIRECTORY, {});\n        } catch (error) {\n            // Directory might already exist, ignore error\n            Logger.debug('Directory creation skipped (may already exist)');\n        }\n    }\n\n    /**\n     * Migrate data from world-scoped game.settings to global storage\n     */\n    static async migrateFromWorldSettings(): Promise<boolean> {\n        try {\n            // Check if we already have global storage\n            const existingGlobal = await this.load();\n            const itemsCount = existingGlobal?.items ?\n                (Array.isArray(existingGlobal.items) ? existingGlobal.items.length : Object.keys(existingGlobal.items).length) : 0;\n\n            if (existingGlobal && existingGlobal.items && itemsCount > 0) {\n                Logger.info('Global storage already populated, skipping migration');\n                return false;\n            }\n\n            // Try to load from old world-scoped settings\n            const oldData = await game.settings?.get(MODULE_ID as any, 'libraryState' as any) as string;\n            if (!oldData || oldData === '') {\n                Logger.info('No world-scoped data to migrate');\n                return false;\n            }\n\n            // Parse and save to global storage\n            const state = JSON.parse(oldData) as LibraryState;\n\n            // Only migrate if there's actual data\n            if (!state.items || (Array.isArray(state.items) ? state.items.length === 0 : Object.keys(state.items).length === 0)) {\n                Logger.info('World-scoped data is empty, skipping migration');\n                return false;\n            }\n\n            await this.save(state);\n\n            const itemCount = Array.isArray(state.items) ? state.items.length : Object.keys(state.items).length;\n            Logger.info(`Migrated ${itemCount} items from world settings to global storage`);\n            ui.notifications?.info(`ASE: Library migrated to global storage (${itemCount} tracks)`);\n\n            return true;\n        } catch (error) {\n            Logger.error('Migration from world settings failed:', error);\n            return false;\n        }\n    }\n\n    /**\n     * Delete a physical file from disk\n     * Shows manual deletion instructions since automatic deletion is unreliable\n     */\n    static async deletePhysicalFile(url: string): Promise<boolean> {\n        if (!this.isOurFile(url)) {\n            Logger.warn('Cannot delete file not in ase_audio folder:', url);\n            return false;\n        }\n\n        if (!game.user?.isGM) {\n            ui.notifications?.warn('Only GM can delete files');\n            return false;\n        }\n\n        // Parse file path\n        let filePath = url.replace(/\\\\/g, '/');\n        filePath = filePath.replace(/^\\/*/, '');\n        filePath = filePath.replace(/^Data\\//i, '');\n\n        // Show manual deletion dialog\n        const content = `\n            <div style=\"padding: 10px;\">\n                <p>Automatic file deletion is not available in this Foundry configuration.</p>\n                <p style=\"margin-top: 10px;\"><strong>To manually delete this file:</strong></p>\n                <ol style=\"margin-left: 20px; margin-top: 10px;\">\n                    <li>Navigate to your Foundry <code>Data</code> folder</li>\n                    <li>Find and delete: <code style=\"background: #1e293b; padding: 2px 6px; border-radius: 3px; color: #22d3ee;\">${filePath}</code></li>\n                </ol>\n                <p style=\"margin-top: 10px; color: #94a3b8; font-size: 12px;\">The track will be removed from the library now, but the file will remain on disk until manually deleted.</p>\n            </div>\n        `;\n\n        await Dialog.prompt({\n            title: 'Manual File Deletion Required',\n            content,\n            callback: () => { },\n            options: { width: 500 }\n        });\n\n        return true;\n    }\n\n    /**\n     * Check if file URL belongs to our module storage\n     * Handles various URL formats from different Foundry versions and platforms\n     */\n    static isOurFile(url: string): boolean {\n        // Normalize path separators and remove leading slashes\n        const normalizedUrl = url.replace(/\\\\/g, '/').toLowerCase();\n\n        // Check for our dedicated folder in various formats:\n        // - ase_audio/file.mp3\n        // - /ase_audio/file.mp3\n        // - Data/ase_audio/file.mp3\n        // - modules/advanced-sound-engine/ase_audio/file.mp3\n        return normalizedUrl.includes('ase_audio/') ||\n            normalizedUrl.includes('/ase_audio/') ||\n            normalizedUrl.endsWith('ase_audio');\n    }\n}\n","import { AudioEngine } from '@core/AudioEngine';\nimport { SocketManager } from '@sync/SocketManager';\nimport { GlobalStorage } from '@storage/GlobalStorage';\nimport type { EffectType, EffectState, EffectParam } from '@t/effects';\nimport type { TrackGroup } from '@t/audio';\nimport { Logger } from '@utils/logger';\n\nconst MODULE_ID = 'advanced-sound-engine';\n\nexport class SoundEffectsApp {\n    private engine: AudioEngine;\n    private socket: SocketManager;\n    private storage: GlobalStorage;\n    private html: JQuery | null = null;\n    private renderParent: (() => void) | null = null;\n    private updateInterval: ReturnType<typeof setInterval> | null = null;\n\n    constructor(\n        engine: AudioEngine,\n        socket: SocketManager,\n        storage: GlobalStorage\n    ) {\n        this.engine = engine;\n        this.socket = socket;\n        this.storage = storage;\n    }\n\n    setRenderCallback(callback: () => void): void {\n        this.renderParent = callback;\n    }\n\n    async getData() {\n        try {\n            // Load presets\n            const presets = await GlobalStorage.loadPresets();\n\n            // Transform effects into view data\n            const effects = this.engine.getAllEffects().map(effect => {\n                const state = this.engine.getEffectState(effect.type)!;\n\n                // Calculate Main Knob Rotation (Level)\n                // Range 0 to 2.0 -> -135deg to +135deg\n                const levelVal = (state.params['level'] as number) || 1.0;\n                const rotation = (levelVal / 2.0) * 270 - 135;\n\n                return {\n                    ...state,\n                    // Helper for template to render specific controls if needed\n                    isReverb: state.type === 'reverb',\n                    isDelay: state.type === 'delay',\n                    mainValue: levelVal.toFixed(2), // Display value\n                    mainParamRotation: rotation,\n                    // Add metadata for params (min, max, etc) which are not in state\n                    params: Object.entries(state.params).map(([key, value]) => {\n                        const paramConfig = (effect as any).params.get(key) as EffectParam;\n                        // Skip 'level' from the list if we treat it as the main knob only?\n                        // Or keep it as a slider too for precision? Let's keep it for now or hide it via CSS if needed.\n                        // Actually, let's filter it out from the list if it's the main knob to avoid duplication? \n                        // No, let's keep it in the list for now, user might want fine control.\n                        return {\n                            ...paramConfig,\n                            value: value\n                        };\n                    }).filter(p => p.id !== 'level') // Filter out level from the slider list to avoid clutter\n                };\n            });\n\n            // Sort order: Reverb, Filter, Delay, Compressor, Distortion\n            const sortOrder: EffectType[] = ['reverb', 'filter', 'delay', 'compressor', 'distortion'];\n            effects.sort((a, b) => sortOrder.indexOf(a.type) - sortOrder.indexOf(b.type));\n\n            return {\n                effects,\n                presets\n            };\n        } catch (error) {\n            Logger.error('Failed to get data for SoundEffectsApp:', error);\n            // Return safe default data to allow render\n            return {\n                effects: [],\n                presets: []\n            };\n        }\n    }\n\n    activateListeners(html: JQuery): void {\n        this.html = html;\n\n        Logger.debug('SoundEffectsApp: View Loaded');\n\n        // Event Delegation for Enable Toggle\n        // IMPORTANT: Unbind first to prevent conflicting multiple listeners on root element re-renders\n        html.off('click', '.ase-effect-toggle').on('click', '.ase-effect-toggle', (e) => this.onToggleEnable(e));\n\n        // Routing Buttons\n        html.off('click', '[data-action=\"toggle-route\"]').on('click', '[data-action=\"toggle-route\"]', (e) => this.onToggleRoute(e));\n\n        // Knobs / Sliders\n        // These are direct binds to new elements (found via find), so no accumulation issue, \n        // but ensuring cleanliness is good practice if elements weren't replaced. \n        // Since re-render replaces content, direct binds are fine.\n        html.find('.ase-param-slider').on('input', (e) => this.onParamChange(e));\n        html.find('.ase-param-input').on('change', (e) => this.onParamChange(e));\n\n        // Circular Knob Interaction\n        html.find('.ase-knob-circle').on('mousedown', (e) => this.onKnobCheck(e));\n\n        // Presets\n        html.find('[data-action=\"save-preset\"]').on('click', (e) => this.onSavePreset(e));\n        html.find('#ase-preset-select').on('change', (e) => this.onLoadPreset(e));\n    }\n\n    private onKnobCheck(event: JQuery.TriggeredEvent): void {\n        const $knob = $(event.currentTarget);\n        const $card = $knob.closest('.ase-effect-card');\n        const effectId = $card.data('effect-id') as string;\n\n        const startY = (event as any).pageY;\n        // We need to know current value to offset\n        // But since we are directly manipulating styling/value, we can read from engine or DOM\n        // Simpler: just use delta to inc/dec\n        const state = this.engine.getEffectState(effectId)!;\n        let currentValue = (state.params['level'] as number) || 1.0;\n\n        const onMouseMove = (moveEvent: JQuery.TriggeredEvent) => {\n            const pageY = (moveEvent as any).pageY || (moveEvent.originalEvent as MouseEvent).pageY;\n            const deltaY = startY - pageY; // Up is positive\n            const sensitivity = 0.01;\n            let newValue = currentValue + (deltaY * sensitivity);\n\n            // Clamp 0 to 2.0\n            newValue = Math.max(0, Math.min(2.0, newValue));\n\n            // Update UI immediately\n            const rotation = (newValue / 2.0) * 270 - 135;\n            $knob.css('--knob-rotation', `${rotation}deg`);\n            $knob.find('.ase-knob-value').text(newValue.toFixed(2));\n\n            // Update Engine\n            this.engine.setEffectParam(effectId, 'level', newValue);\n            this.socket.broadcastEffectParam(effectId, 'level', newValue);\n        };\n\n        const onMouseUp = () => {\n            $(document).off('mousemove', onMouseMove as any);\n            $(document).off('mouseup', onMouseUp as any);\n        };\n\n        $(document).on('mousemove', onMouseMove as any);\n        $(document).on('mouseup', onMouseUp as any);\n    }\n\n    private onToggleEnable(event: JQuery.ClickEvent): void {\n        event.preventDefault();\n\n        const $toggle = $(event.currentTarget);\n        const $card = $toggle.closest('.ase-effect-card');\n        const effectId = $card.data('effect-id') as string;\n\n        const wasEnabled = $card.hasClass('enabled');\n        const newState = !wasEnabled;\n\n        this.engine.setEffectEnabled(effectId, newState);\n        this.socket.broadcastEffectEnabled(effectId, newState);\n\n        // UI Update\n        if (newState) {\n            $card.addClass('enabled');\n        } else {\n            $card.removeClass('enabled');\n        }\n    }\n\n    private onToggleRoute(event: JQuery.ClickEvent): void {\n        event.preventDefault();\n        const $btn = $(event.currentTarget);\n        const $card = $btn.closest('.ase-effect-card');\n        const effectId = $card.data('effect-id') as string;\n        const channel = $btn.data('channel') as TrackGroup;\n\n        const isActive = $btn.hasClass('active');\n        const newState = !isActive;\n\n        this.engine.setEffectRouting(effectId, channel, newState);\n        this.socket.broadcastEffectRouting(effectId, channel, newState);\n\n        // UI Update immediately for responsiveness\n        if (newState) $btn.addClass('active');\n        else $btn.removeClass('active');\n    }\n\n    private onParamChange(event: JQuery.TriggeredEvent): void {\n        const $input = $(event.currentTarget);\n        const $card = $input.closest('.ase-effect-card');\n        const effectId = $card.data('effect-id') as string;\n        const paramId = $input.data('param-id') as string;\n\n        let value: string | number | boolean = $input.val() as string;\n\n        // Check type of param\n        if ($input.attr('type') === 'range') {\n            value = parseFloat(value);\n            // Update display value\n            $card.find(`.ase-param-control:has([data-param-id=\"${paramId}\"]) .ase-param-val`).text(value); // Hacky selector\n            // Better:\n            $input.siblings('.ase-param-val').text(value);\n        }\n\n        this.engine.setEffectParam(effectId, paramId, value);\n        this.socket.broadcastEffectParam(effectId, paramId, value);\n    }\n\n\n    private async onSavePreset(event: JQuery.ClickEvent): Promise<void> {\n        event.preventDefault();\n\n        // Get preset name\n        const content = `\n            <div class=\"form-group\">\n                <label>Preset Name</label>\n                <input type=\"text\" name=\"name\" placeholder=\"My Cool Preset\"/>\n            </div>\n        `;\n\n        new Dialog({\n            title: \"Save Effect Preset\",\n            content: content,\n            buttons: {\n                save: {\n                    label: \"Save\",\n                    callback: async (html: JQuery) => {\n                        const name = html.find('input[name=\"name\"]').val() as string;\n                        if (!name) return;\n\n                        await this.savePreset(name);\n                    }\n                }\n            }\n        }).render(true);\n    }\n\n    private async savePreset(name: string): Promise<void> {\n        // Collect state\n        const effects = this.engine.getAllEffects().map(e => this.engine.getEffectState(e.id)!);\n\n        const newPreset = {\n            id: generateUUID(), // We need a UUID helper or just Math.random\n            name,\n            effects\n        };\n\n        // Load existing, append, save\n        const presets = await GlobalStorage.loadPresets();\n        presets.push(newPreset);\n        await GlobalStorage.savePresets(presets);\n\n        ui.notifications?.info(`Saved preset: ${name}`);\n        this.renderParent?.();\n    }\n\n    private async onLoadPreset(event: JQuery.ChangeEvent): Promise<void> {\n        const presetId = $(event.currentTarget).val() as string;\n        if (!presetId) return;\n\n        const presets = await GlobalStorage.loadPresets();\n        const preset = presets.find((p: any) => p.id === presetId);\n\n        if (preset) {\n            // Apply all effects\n            for (const effectState of preset.effects) {\n                // Determine if we match by ID or Type\n                // Since Effect IDs might change or be fixed, matching by Type is safer for a Rack\n                // But if we support multiple instances of same type, we need index or ID\n                // For now, Single Rack (one of each type)\n\n                const existingEffect = this.engine.getAllEffects().find(e => e.type === effectState.type);\n                if (existingEffect) {\n                    // Apply PArsims\n                    for (const [key, value] of Object.entries(effectState.params)) {\n                        this.engine.setEffectParam(existingEffect.id, key, value);\n                    }\n\n                    // Apply Routing\n                    if (effectState.routing) {\n                        // engine.setRouting? engine.setEffectRouting\n                        for (const [group, active] of Object.entries(effectState.routing)) {\n                            this.engine.setEffectRouting(existingEffect.id, group as any, active as boolean);\n                        }\n                    }\n\n                    // Apply Enabled?\n                    // engine.setEffectEnabled?\n                }\n            }\n            ui.notifications?.info(`Loaded preset: ${preset.name}`);\n            this.renderParent?.();\n\n            // Broadcast full state to sync all clients\n            this.socket.broadcastFullState();\n        }\n    }\n\n    destroy(): void {\n        this.html = null;\n    }\n}\n\n// Helper if not imported\nfunction generateUUID() {\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);\n        return v.toString(16);\n    });\n}\n","import { AudioEngine } from '@core/AudioEngine';\nimport { SocketManager } from '@sync/SocketManager';\nimport { LibraryManager } from '@lib/LibraryManager';\nimport { PlaybackQueueManager } from '@queue/PlaybackQueueManager';\nimport { LocalLibraryApp } from './LocalLibraryApp';\nimport { SoundMixerApp } from './SoundMixerApp';\nimport { SoundEffectsApp } from './SoundEffectsApp';\nimport { Logger } from '@utils/logger';\n\nconst MODULE_ID = 'advanced-sound-engine';\n\nconst { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\ninterface AppState {\n    activeTab: 'mixer' | 'library' | 'online' | 'sfx';\n    syncEnabled: boolean;\n}\n\nexport class AdvancedSoundEngineApp extends HandlebarsApplicationMixin(ApplicationV2) {\n    private engine: AudioEngine;\n    private socket: SocketManager;\n    private libraryManager: LibraryManager;\n    private queueManager: PlaybackQueueManager;\n\n    // Sub-apps (Controllers)\n    private libraryApp: LocalLibraryApp;\n    private mixerApp: SoundMixerApp;\n    private effectsApp: SoundEffectsApp;\n\n    // Stored callback for cleanup\n    private _onQueueChangeBound!: () => void;\n\n    public state: AppState = {\n        activeTab: 'library', // Default to library as per user focus\n        syncEnabled: false\n    };\n\n    /**\n     * Define the templates used by this application.\n     * In V2, we define parts rather than a single template.\n     */\n    static override PARTS = {\n        main: {\n            template: `modules/${MODULE_ID}/templates/main-app.hbs`,\n            scrollable: ['.ase-content-body']\n        }\n    };\n\n    static override DEFAULT_OPTIONS = {\n        id: 'advanced-sound-engine-app',\n        tag: 'form',\n        window: {\n            title: 'Advanced Sound Engine',\n            icon: 'fas fa-music',\n            resizable: true,\n            controls: []\n        },\n        position: {\n            width: 1440,\n            height: 1050\n        },\n        classes: ['ase-window-layout']\n    };\n\n    constructor(engine: AudioEngine, socket: SocketManager, libraryManager: LibraryManager, queueManager: PlaybackQueueManager, options: any = {}) {\n        super(options);\n        this.engine = engine;\n        this.socket = socket;\n        this.libraryManager = libraryManager;\n        this.queueManager = queueManager;\n\n        // Initialize sub-controllers\n        this.libraryApp = new LocalLibraryApp(this.libraryManager, this);\n        this.mixerApp = new SoundMixerApp(this.engine, this.socket, this.libraryManager, this.queueManager);\n        this.effectsApp = new SoundEffectsApp(this.engine, this.socket, this.libraryManager.storage);\n\n        // Set render callback for mixer to trigger parent re-render\n        this.mixerApp.setRenderCallback(() => {\n            if (this.state.activeTab === 'mixer') {\n                this.captureScroll(); // Capture before re-rendering\n                this.render({ parts: ['main'] });\n            }\n        });\n\n        this.effectsApp.setRenderCallback(() => {\n            if (this.state.activeTab === 'sfx') {\n                this.captureScroll();\n                this.render({ parts: ['main'] });\n            }\n        });\n\n        // Subscribe to queue changes for UI updates\n        this._onQueueChangeBound = () => {\n            if (this.state.activeTab === 'mixer') {\n                this.captureScroll();\n                this.render({ parts: ['main'] });\n            }\n        };\n        this.queueManager.on('change', this._onQueueChangeBound);\n\n        // Restore Local Volume (UI Preference)\n        const savedLocalVol = localStorage.getItem('ase-gm-local-volume');\n        if (savedLocalVol !== null) {\n            this.engine.setLocalVolume(parseFloat(savedLocalVol));\n        }\n    }\n\n    /**\n     * V2 Context Preparation (replaces getData)\n     */\n    protected override async _prepareContext(options: any): Promise<any> {\n        const volumes = this.engine.volumes;\n\n        // Helper to check channel status\n        const getChannelStatus = (group: 'music' | 'ambience' | 'sfx') => {\n            const tracks = this.engine.getTracksByGroup(group);\n            if (tracks.length === 0) return { playing: false, paused: false };\n\n            const isPlaying = tracks.some(t => t.state === 'playing');\n            const isPaused = tracks.some(t => t.state === 'paused');\n\n            return { playing: isPlaying, paused: isPaused && !isPlaying };\n        };\n\n        const status = {\n            music: getChannelStatus('music'),\n            ambience: getChannelStatus('ambience'),\n            sfx: getChannelStatus('sfx')\n        };\n\n        // Get content for the active tab manually (legacy support for sub-apps returning data)\n        const renderTemplate = globalThis.renderTemplate; // V13 Compatibility\n\n        let tabContent = '';\n        if (this.state.activeTab === 'library') {\n            const libData = await this.libraryApp.getData();\n            tabContent = await renderTemplate('modules/advanced-sound-engine/templates/library.hbs', libData as any);\n        } else if (this.state.activeTab === 'mixer') {\n            const mixerData = await this.mixerApp.getData();\n            tabContent = await renderTemplate(`modules/${MODULE_ID}/templates/mixer.hbs`, mixerData as any);\n        } else if (this.state.activeTab === 'sfx') {\n            Logger.info(`[AdvancedSoundEngineApp] Rendering SFX tab...`);\n            const effectsData = await this.effectsApp.getData();\n            tabContent = await renderTemplate(`modules/${MODULE_ID}/templates/effects.hbs`, effectsData as any);\n        }\n\n        return {\n            activeTab: this.state.activeTab,\n            tabContent,\n            status,\n            volumes: {\n                master: Math.round(volumes.master * 100),\n                music: Math.round(volumes.music * 100),\n                ambience: Math.round(volumes.ambience * 100),\n                sfx: Math.round(volumes.sfx * 100),\n                local: Math.round(this.engine.localVolume * 100)\n            },\n            syncEnabled: this.socket.syncEnabled,\n            // Pass state for Handlebars if needed\n            tabs: [\n                { id: 'library', label: 'Library', icon: 'fas fa-book-open', active: this.state.activeTab === 'library' },\n                { id: 'mixer', label: 'Mixer', icon: 'fas fa-sliders-h', active: this.state.activeTab === 'mixer' },\n                { id: 'sfx', label: 'Effects', icon: 'fas fa-wave-square', active: this.state.activeTab === 'sfx' },\n                { id: 'online', label: 'Online', icon: 'fas fa-globe', active: this.state.activeTab === 'online' }\n            ]\n        };\n    }\n\n    /**\n     * V2 Render Hook (replaces activateListeners)\n     * Note: In V2, `this.element` is the HTML element itself, not a jQuery object.\n     * However, we wrap it in jQuery for compatibility with existing listener logic if preferred, \n     * or use vanilla JS. Sticking to jQuery for now to minimize logic rewrite risks.\n     */\n    protected override _onRender(context: any, options: any): void {\n        Logger.info(`[AdvancedSoundEngineApp] _onRender called. Active Tab: ${this.state.activeTab}`);\n        super._onRender(context, options);\n\n        // Wrap native element in jQuery for legacy compatibility\n        const html = $(this.element);\n\n        // Tab Navigation\n        html.find('.ase-tab').on('click', this.onTabSwitch.bind(this));\n\n        // Footer Controls (A7)\n        html.find('[data-action=\"toggle-sync\"]').on('click', this.onToggleSync.bind(this));\n        html.find('[data-action=\"global-play\"]').on('click', this.onGlobalPlay.bind(this));\n        html.find('[data-action=\"global-pause\"]').on('click', this.onGlobalPause.bind(this));\n        html.find('[data-action=\"global-stop\"]').on('click', this.onGlobalStop.bind(this));\n\n        // Mixer Sliders (Inputs)\n        html.find('.ase-volume-slider').on('input', this.onVolumeInput.bind(this));\n\n        // Delegate listeners to sub-apps\n        if (this.state.activeTab === 'library') {\n            this.libraryApp.activateListeners(html);\n        } else if (this.state.activeTab === 'mixer') {\n            this.mixerApp.activateListeners(html);\n        } else if (this.state.activeTab === 'sfx') {\n            Logger.info('[AdvancedSoundEngineApp] Delegating to effectsApp.activateListeners');\n            this.effectsApp.activateListeners(html);\n        }\n\n        // Restore Scroll (Global Smart Scroll)\n        this.restoreScroll();\n    }\n\n    // Unified Scroll State Store\n    private scrollStates: Record<'library' | 'mixer' | 'sfx' | 'online', Record<string, number>> = {\n        library: {\n            '.ase-track-player-list': 0,\n            '.ase-list-group': 0, // Playlists list\n            '.ase-favorites-section .ase-list-group': 0 // Favorites\n        },\n        mixer: {\n            '[data-section=\"mixer-queue\"]': 0,\n            '[data-section=\"mixer-favorites\"]': 0\n        },\n        sfx: {\n            '.ase-effects-layout': 0\n        },\n        online: {}\n    };\n\n    /**\n     * V2 Close Hook — cleanup all sub-apps and event subscriptions\n     */\n    protected override _onClose(options: any): void {\n        super._onClose(options);\n\n        // Dispose sub-apps\n        this.mixerApp.dispose();\n        this.effectsApp.destroy();\n        this.libraryApp.close();\n\n        // Remove queue change subscription\n        this.queueManager.off('change', this._onQueueChangeBound);\n\n        Logger.info('[AdvancedSoundEngineApp] Closed and cleaned up');\n    }\n\n    // ─────────────────────────────────────────────────────────────\n    // Event Handlers\n    // ─────────────────────────────────────────────────────────────\n\n    private async onTabSwitch(event: JQuery.ClickEvent): Promise<void> {\n        event.preventDefault();\n        const tabName = $(event.currentTarget).data('tab');\n        if (this.state.activeTab === tabName) return;\n\n        // Capture scroll BEFORE switching\n        this.captureScroll();\n\n        this.state.activeTab = tabName;\n        this.render({ parts: ['main'] });\n    }\n\n    /**\n     * Resets the scroll state for a specific tab to 0.\n     * Use this when changing filters or view context where the user expects to start from the top.\n     */\n    public resetScroll(tabName?: 'library' | 'mixer'): void {\n        const targetTab = tabName || this.state.activeTab;\n        const map = this.scrollStates[targetTab];\n\n        if (!map) return;\n\n        for (const selector of Object.keys(map)) {\n            map[selector] = 0;\n        }\n    }\n\n    /**\n     * Captures the current scroll positions for the ACTIVE tab.\n     * Call this before any operation that might trigger a re-render.\n     */\n    public captureScroll(): void {\n        const activeTab = this.state.activeTab;\n        const html = $(this.element);\n        const map = this.scrollStates[activeTab];\n\n        if (!map) return;\n\n        for (const selector of Object.keys(map)) {\n            const el = html.find(selector);\n            if (el.length) {\n                const scrollTop = el.scrollTop() || 0;\n                map[selector] = scrollTop;\n            }\n        }\n    }\n\n    /**\n     * Restores scroll positions for the ACTIVE tab.\n     * called automatically in _onRender.\n     */\n    private restoreScroll(): void {\n        const activeTab = this.state.activeTab;\n        const html = $(this.element);\n        const map = this.scrollStates[activeTab];\n\n        if (!map) return;\n\n        for (const [selector, scrollTop] of Object.entries(map)) {\n            const el = html.find(selector);\n            if (el.length) {\n                // Always enforce the stored scroll state\n                el.scrollTop(scrollTop);\n            }\n        }\n    }\n\n    private onToggleSync(event: JQuery.ClickEvent): void {\n        const enabled = !this.socket.syncEnabled;\n        this.socket.setSyncEnabled(enabled);\n        this.state.syncEnabled = enabled;\n        this.render();\n    }\n\n    private async onGlobalPlay(): Promise<void> {\n        this.engine.resume();\n        const tracks = this.engine.getAllTracks();\n\n        console.log('[ASE DEBUG] Global Play clicked, found', tracks.length, 'tracks');\n\n        for (const track of tracks) {\n            if (track.state === 'paused') {\n                const offset = track.getCurrentTime();\n                console.log('[ASE DEBUG] Resuming paused track:', track.id, 'at offset:', offset);\n                await track.play(offset);\n\n                // Broadcast to players\n                if (this.socket.syncEnabled) {\n                    console.log('[ASE DEBUG] Broadcasting track play for:', track.id);\n                    this.socket.broadcastTrackPlay(track.id, offset);\n                }\n            }\n        }\n\n        Logger.debug('Global Play/Resume Clicked');\n        this.render();\n    }\n\n    private onGlobalPause(): void {\n        console.log('[ASE DEBUG] Global Pause clicked');\n        const tracks = this.engine.getAllTracks();\n        for (const track of tracks) {\n            if (track.state === 'playing') {\n                const currentTime = track.getCurrentTime();\n                track.pause();\n                // Sync if enabled\n                if (this.socket.syncEnabled) {\n                    console.log('[ASE DEBUG] Global Pause broadcasting for track:', track.id, 'at', currentTime);\n                    this.socket.broadcastTrackPause(track.id, currentTime);\n                }\n            }\n        }\n        Logger.debug('Global Pause Clicked');\n        this.render();\n    }\n\n    private onGlobalStop(): void {\n        // AudioEngine.stopAll() now handles broadcast + scheduler cleanup internally\n        this.engine.stopAll();\n        this.render();\n    }\n\n    private onVolumeInput(event: JQuery.TriggeredEvent): void {\n        const input = event.currentTarget as HTMLInputElement;\n        const value = parseFloat(input.value) / 100;\n        const $input = $(input);\n        const channel = $input.data('channel') as 'music' | 'ambience' | 'sfx' | undefined;\n        const type = $input.data('type') as 'master' | 'local' | undefined;\n\n        if (channel) {\n            this.engine.setChannelVolume(channel, value);\n            this.socket.broadcastChannelVolume(channel, value);\n            $input.siblings('.ase-percentage').text(`${Math.round(value * 100)}%`);\n        } else if (type === 'local') {\n            this.engine.setLocalVolume(value);\n            // Local volume is NOT broadcast\n            // Save to localStorage for persistence\n            localStorage.setItem('ase-gm-local-volume', value.toString());\n            $input.siblings('.ase-local-perc').text(`${Math.round(value * 100)}%`);\n        } else {\n            // Master\n            this.engine.setMasterVolume(value);\n            this.socket.broadcastChannelVolume('master', value);\n            $input.siblings('.ase-master-perc').text(`${Math.round(value * 100)}%`);\n        }\n    }\n}\n","export function throttle<T extends (...args: Parameters<T>) => void>(\n  fn: T,\n  delay: number\n): (...args: Parameters<T>) => void {\n  let lastCall = 0;\n  let timeoutId: ReturnType<typeof setTimeout> | null = null;\n  \n  return function (this: ThisParameterType<T>, ...args: Parameters<T>) {\n    const now = Date.now();\n    const remaining = delay - (now - lastCall);\n    \n    if (remaining <= 0) {\n      if (timeoutId) {\n        clearTimeout(timeoutId);\n        timeoutId = null;\n      }\n      lastCall = now;\n      fn.apply(this, args);\n    } else if (!timeoutId) {\n      timeoutId = setTimeout(() => {\n        lastCall = Date.now();\n        timeoutId = null;\n        fn.apply(this, args);\n      }, remaining);\n    }\n  };\n}\n\nexport function debounce<T extends (...args: Parameters<T>) => void>(\n  fn: T,\n  delay: number\n): (...args: Parameters<T>) => void {\n  let timeoutId: ReturnType<typeof setTimeout> | null = null;\n  \n  return function (this: ThisParameterType<T>, ...args: Parameters<T>) {\n    if (timeoutId) {\n      clearTimeout(timeoutId);\n    }\n    timeoutId = setTimeout(() => {\n      fn.apply(this, args);\n    }, delay);\n  };\n}","import type { Playlist, PlaylistItem } from '@t/library';\nimport type { TrackGroup } from '@t/audio';\nimport { generateUUID } from '@utils/uuid';\nimport { Logger } from '@utils/logger';\n\nexport class PlaylistManager {\n  private playlists: Map<string, Playlist> = new Map();\n  private onChangeCallback?: () => void;\n\n  constructor(onChangeCallback?: () => void) {\n    this.onChangeCallback = onChangeCallback;\n  }\n\n  /**\n   * Notify about changes (triggers save)\n   */\n  private notifyChange(): void {\n    if (this.onChangeCallback) {\n      this.onChangeCallback();\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // CRUD Operations - Playlists\n  // ─────────────────────────────────────────────────────────────\n\n  /**\n   * Create new playlist\n   */\n  createPlaylist(name: string, description?: string): Playlist {\n    // Check for duplicate names\n    const existing = this.findByName(name);\n    if (existing) {\n      throw new Error(`Playlist with name \"${name}\" already exists`);\n    }\n\n    const now = Date.now();\n    const playlist: Playlist = {\n      id: generateUUID(),\n      name,\n      description,\n      items: [],\n      createdAt: now,\n      updatedAt: now,\n      favorite: false,\n      playbackMode: 'loop'\n    };\n\n    this.playlists.set(playlist.id, playlist);\n    this.notifyChange();\n    Logger.info(`Playlist created: ${playlist.name} (${playlist.id})`);\n\n    return playlist;\n  }\n\n  /**\n   * Update playlist metadata\n   */\n  updatePlaylist(id: string, updates: Partial<Pick<Playlist, 'name' | 'description' | 'favorite' | 'playbackMode'>>): Playlist {\n    const playlist = this.playlists.get(id);\n    if (!playlist) {\n      throw new Error(`Playlist not found: ${id}`);\n    }\n\n    // Validate name uniqueness if changing name\n    if (updates.name && updates.name !== playlist.name) {\n      const existing = this.findByName(updates.name);\n      if (existing && existing.id !== id) {\n        throw new Error(`Playlist with name \"${updates.name}\" already exists`);\n      }\n    }\n\n    // Update playlist\n    const updated = {\n      ...playlist,\n      ...updates,\n      updatedAt: Date.now()\n    };\n\n    this.playlists.set(id, updated);\n    this.notifyChange();\n    Logger.info(`Playlist updated: ${updated.name}`);\n\n    return updated;\n  }\n\n  /**\n   * Delete playlist\n   */\n  deletePlaylist(id: string): void {\n    const playlist = this.playlists.get(id);\n    if (!playlist) {\n      throw new Error(`Playlist not found: ${id}`);\n    }\n\n    this.playlists.delete(id);\n    this.notifyChange();\n    Logger.info(`Playlist deleted: ${playlist.name}`);\n  }\n\n  /**\n   * Get playlist by ID\n   */\n  getPlaylist(id: string): Playlist | undefined {\n    return this.playlists.get(id);\n  }\n\n  /**\n   * Get all playlists\n   */\n  getAllPlaylists(): Playlist[] {\n    return Array.from(this.playlists.values());\n  }\n\n  /**\n   * Find playlist by name\n   */\n  findByName(name: string): Playlist | undefined {\n    return Array.from(this.playlists.values()).find(p => p.name === name);\n  }\n\n  /**\n   * Get favorite playlists\n   */\n  getFavoritePlaylists(): Playlist[] {\n    return this.getAllPlaylists().filter(p => p.favorite);\n  }\n\n  /**\n   * Reorder playlists based on new order array of IDs\n   */\n  reorderPlaylists(orderedIds: string[]): void {\n    const newMap = new Map<string, Playlist>();\n\n    // First, add playlists in the new order\n    orderedIds.forEach(id => {\n      const playlist = this.playlists.get(id);\n      if (playlist) {\n        newMap.set(id, playlist);\n      }\n    });\n\n    // Add any remaining playlists that weren't in the order array\n    this.playlists.forEach((playlist, id) => {\n      if (!newMap.has(id)) {\n        newMap.set(id, playlist);\n      }\n    });\n\n    this.playlists = newMap;\n    this.notifyChange();\n    Logger.info('Playlists reordered');\n  }\n\n\n  /**\n   * Toggle playlist favorite status\n   */\n  togglePlaylistFavorite(id: string): boolean {\n    const playlist = this.getPlaylist(id);\n    if (!playlist) {\n      throw new Error(`Playlist not found: ${id}`);\n    }\n\n    playlist.favorite = !playlist.favorite;\n    playlist.updatedAt = Date.now();\n    this.notifyChange();\n\n    return playlist.favorite;\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // CRUD Operations - Playlist Items\n  // ─────────────────────────────────────────────────────────────\n\n  /**\n   * Add track to playlist\n   */\n  addTrackToPlaylist(\n    playlistId: string,\n    libraryItemId: string,\n    group: TrackGroup,\n    options?: Partial<Omit<PlaylistItem, 'id' | 'libraryItemId' | 'group' | 'order'>>\n  ): PlaylistItem {\n    const playlist = this.getPlaylist(playlistId);\n    if (!playlist) {\n      throw new Error(`Playlist not found: ${playlistId}`);\n    }\n\n    // Check if track already exists in playlist\n    const exists = playlist.items.find(item => item.libraryItemId === libraryItemId);\n    if (exists) {\n      throw new Error('Track already exists in this playlist');\n    }\n\n    // Create new playlist item\n    const item: PlaylistItem = {\n      id: generateUUID(),\n      libraryItemId,\n      group,\n      volume: options?.volume ?? 1.0,\n      order: playlist.items.length,\n      fadeIn: options?.fadeIn,\n      fadeOut: options?.fadeOut\n    };\n\n    playlist.items.push(item);\n    playlist.updatedAt = Date.now();\n    this.notifyChange();\n\n    Logger.debug(`Track added to playlist ${playlist.name}: ${libraryItemId}`);\n\n    return item;\n  }\n\n  /**\n   * Remove track from playlist\n   */\n  removeTrackFromPlaylist(playlistId: string, playlistItemId: string): void {\n    const playlist = this.getPlaylist(playlistId);\n    if (!playlist) {\n      throw new Error(`Playlist not found: ${playlistId}`);\n    }\n\n    const index = playlist.items.findIndex(item => item.id === playlistItemId);\n    if (index === -1) {\n      throw new Error(`Playlist item not found: ${playlistItemId}`);\n    }\n\n    playlist.items.splice(index, 1);\n\n    // Reorder remaining items\n    this.reorderPlaylistItems(playlist);\n\n    playlist.updatedAt = Date.now();\n    this.notifyChange();\n    Logger.debug(`Track removed from playlist ${playlist.name}`);\n  }\n\n  /**\n   * Remove all tracks with specific library item ID from playlist\n   */\n  removeLibraryItemFromPlaylist(playlistId: string, libraryItemId: string): number {\n    const playlist = this.getPlaylist(playlistId);\n    if (!playlist) {\n      throw new Error(`Playlist not found: ${playlistId}`);\n    }\n\n    const initialLength = playlist.items.length;\n    playlist.items = playlist.items.filter(item => item.libraryItemId !== libraryItemId);\n    const removed = initialLength - playlist.items.length;\n\n    if (removed > 0) {\n      this.reorderPlaylistItems(playlist);\n      playlist.updatedAt = Date.now();\n      this.notifyChange();\n      Logger.debug(`Removed ${removed} instances of library item ${libraryItemId} from playlist ${playlist.name}`);\n    }\n\n    return removed;\n  }\n\n  /**\n   * Remove library item from all playlists\n   */\n  removeLibraryItemFromAllPlaylists(libraryItemId: string): number {\n    let totalRemoved = 0;\n\n    this.playlists.forEach(playlist => {\n      const initialLength = playlist.items.length;\n      playlist.items = playlist.items.filter(item => item.libraryItemId !== libraryItemId);\n      const removed = initialLength - playlist.items.length;\n\n      if (removed > 0) {\n        this.reorderPlaylistItems(playlist);\n        playlist.updatedAt = Date.now();\n        totalRemoved += removed;\n      }\n    });\n\n    if (totalRemoved > 0) {\n      this.notifyChange();\n      Logger.info(`Removed library item ${libraryItemId} from ${totalRemoved} playlist(s)`);\n    }\n\n    return totalRemoved;\n  }\n\n  /**\n   * Update playlist item\n   */\n  updatePlaylistItem(\n    playlistId: string,\n    playlistItemId: string,\n    updates: Partial<Omit<PlaylistItem, 'id' | 'libraryItemId' | 'order'>>\n  ): PlaylistItem {\n    const playlist = this.getPlaylist(playlistId);\n    if (!playlist) {\n      throw new Error(`Playlist not found: ${playlistId}`);\n    }\n\n    const item = playlist.items.find(i => i.id === playlistItemId);\n    if (!item) {\n      throw new Error(`Playlist item not found: ${playlistItemId}`);\n    }\n\n    // Update item\n    Object.assign(item, updates);\n    playlist.updatedAt = Date.now();\n    this.notifyChange();\n\n    Logger.debug(`Playlist item updated in ${playlist.name}`);\n\n    return item;\n  }\n\n  /**\n   * Reorder track in playlist\n   */\n  reorderTrack(playlistId: string, playlistItemId: string, newOrder: number): void {\n    const playlist = this.getPlaylist(playlistId);\n    if (!playlist) {\n      throw new Error(`Playlist not found: ${playlistId}`);\n    }\n\n    const itemIndex = playlist.items.findIndex(i => i.id === playlistItemId);\n    if (itemIndex === -1) {\n      throw new Error(`Playlist item not found: ${playlistItemId}`);\n    }\n\n    // Validate new order\n    if (newOrder < 0 || newOrder >= playlist.items.length) {\n      throw new Error(`Invalid order: ${newOrder}`);\n    }\n\n    // Remove item from current position\n    const [item] = playlist.items.splice(itemIndex, 1);\n\n    // Insert at new position\n    playlist.items.splice(newOrder, 0, item);\n\n    // Reorder all items\n    this.reorderPlaylistItems(playlist);\n\n    playlist.updatedAt = Date.now();\n    this.notifyChange();\n    Logger.debug(`Track reordered in playlist ${playlist.name}`);\n  }\n\n  /**\n   * Get tracks in playlist\n   */\n  getPlaylistTracks(playlistId: string): PlaylistItem[] {\n    const playlist = this.getPlaylist(playlistId);\n    if (!playlist) {\n      throw new Error(`Playlist not found: ${playlistId}`);\n    }\n\n    return [...playlist.items].sort((a, b) => a.order - b.order);\n  }\n\n  /**\n   * Get playlists containing a specific library item\n   */\n  getPlaylistsContainingItem(libraryItemId: string): Playlist[] {\n    return this.getAllPlaylists().filter(playlist =>\n      playlist.items.some(item => item.libraryItemId === libraryItemId)\n    );\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Persistence\n  // ─────────────────────────────────────────────────────────────\n\n  /**\n   * Load playlists from state object\n   */\n  load(playlistsData: Record<string, Playlist>): void {\n    this.playlists.clear();\n\n    Object.values(playlistsData).forEach(playlist => {\n      // Ensure items are properly ordered\n      playlist.items.sort((a, b) => a.order - b.order);\n      // Migration: Ensure playbackMode exists\n      if (!playlist.playbackMode) {\n        playlist.playbackMode = 'loop';\n      }\n      this.playlists.set(playlist.id, playlist);\n    });\n\n    Logger.info(`PlaylistManager loaded: ${this.playlists.size} playlists`);\n  }\n\n  /**\n   * Export playlists to state object\n   */\n  export(): Record<string, Playlist> {\n    return Object.fromEntries(this.playlists);\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Utilities\n  // ─────────────────────────────────────────────────────────────\n\n  /**\n   * Reorder playlist items to ensure consecutive order values\n   */\n  private reorderPlaylistItems(playlist: Playlist): void {\n    playlist.items.forEach((item, index) => {\n      item.order = index;\n    });\n  }\n\n  /**\n   * Get statistics\n   */\n  getStats() {\n    const playlists = this.getAllPlaylists();\n    return {\n      totalPlaylists: playlists.length,\n      favoritePlaylists: playlists.filter(p => p.favorite).length,\n      totalTracks: playlists.reduce((sum, p) => sum + p.items.length, 0),\n      averageTracksPerPlaylist: playlists.length > 0\n        ? Math.round(playlists.reduce((sum, p) => sum + p.items.length, 0) / playlists.length)\n        : 0\n    };\n  }\n\n  /**\n   * Clear all playlists\n   */\n  clear(): void {\n    this.playlists.clear();\n    Logger.warn('All playlists cleared');\n  }\n}\n","import type { LibraryItem, LibraryState, LibraryStats } from '@t/library';\nimport type { TrackGroup } from '@t/audio';\nimport { generateUUID } from '@utils/uuid';\nimport { validateAudioFile } from '@utils/audio-validation';\nimport { Logger } from '@utils/logger';\nimport { debounce } from '@utils/throttle';\nimport { PlaylistManager } from './PlaylistManager';\nimport { GlobalStorage } from '@storage/GlobalStorage';\n\nconst MODULE_ID = 'advanced-sound-engine';\nconst LIBRARY_VERSION = 2;\n\nexport class LibraryManager {\n  private items: Map<string, LibraryItem> = new Map();\n  private customTags: Set<string> = new Set();\n  private favoritesOrder: Array<{ id: string, type: 'track' | 'playlist', addedAt: number }> = [];\n  private saveScheduled = false;\n  public readonly playlists: PlaylistManager;\n  public readonly storage: GlobalStorage;\n\n  // New property to track if we've initiated a scan this session\n  private hasScannedDurations = false;\n\n  private debouncedSave = debounce(() => {\n    this.saveToSettings();\n  }, 500);\n\n  constructor() {\n    this.storage = new GlobalStorage();\n    this.playlists = new PlaylistManager(() => this.scheduleSave());\n    // Load is now async, so we call it via then() to handle Promise\n    this.loadFromSettings().catch(err => Logger.error('Failed initial load:', err));\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // CRUD Operations\n  // ─────────────────────────────────────────────────────────────\n\n  /**\n   * Add new item to library\n   */\n  async addItem(url: string, name?: string, group: TrackGroup = 'music', tags: string[] = []): Promise<LibraryItem> {\n    // Validate audio format\n    const validation = validateAudioFile(url);\n    if (!validation.valid) {\n      throw new Error(validation.error || 'Invalid audio file');\n    }\n\n    // Generate name from filename if not provided\n    const itemName = name || this.extractNameFromUrl(url);\n\n    // Check for duplicates by URL\n    const existingByUrl = this.findByUrl(url);\n    if (existingByUrl) {\n      throw new Error(`Track with this URL already exists: ${existingByUrl.name}`);\n    }\n\n    // Check for duplicates by name\n    const existingByName = this.findByName(itemName);\n    if (existingByName) {\n      throw new Error(`Track with name \"${itemName}\" already exists in library`);\n    }\n\n    const now = Date.now();\n    const item: LibraryItem = {\n      id: generateUUID(),\n      url,\n      name: itemName,\n      tags: tags,\n      group: group,\n      duration: 0,\n      favorite: false,\n      playbackMode: 'inherit',\n      addedAt: now,\n      updatedAt: now\n    };\n\n    // Asynchronously extract duration\n    const audio = new Audio(url);\n    audio.addEventListener('loadedmetadata', () => {\n      if (audio.duration && isFinite(audio.duration)) {\n        item.duration = Math.round(audio.duration);\n        this.scheduleSave();\n        Logger.info(`Updated duration for ${item.name}: ${item.duration}s`);\n      }\n    });\n    // Handle error to avoid hanging if file is invalid/unreachable (though we don't block return)\n    audio.addEventListener('error', (e) => {\n      Logger.warn(`Failed to extract duration for ${item.name}:`, e);\n    });\n\n    this.items.set(item.id, item);\n    this.scheduleSave();\n\n    Logger.info(`Library item added: ${item.name} (${item.id})`);\n    return item;\n  }\n\n  /**\n   * Update existing item\n   */\n  updateItem(id: string, updates: Partial<LibraryItem>): LibraryItem {\n    const item = this.items.get(id);\n    if (!item) {\n      throw new Error(`Library item not found: ${id}`);\n    }\n\n    // Validate name uniqueness if changing name\n    if (updates.name && updates.name !== item.name) {\n      const existingByName = this.findByName(updates.name);\n      if (existingByName && existingByName.id !== id) {\n        throw new Error(`Track with name \"${updates.name}\" already exists`);\n      }\n    }\n\n    // Validate URL uniqueness if changing URL\n    if (updates.url && updates.url !== item.url) {\n      const validation = validateAudioFile(updates.url);\n      if (!validation.valid) {\n        throw new Error(validation.error || 'Invalid audio file');\n      }\n\n      const existingByUrl = this.findByUrl(updates.url);\n      if (existingByUrl && existingByUrl.id !== id) {\n        throw new Error(`Track with this URL already exists: ${existingByUrl.name}`);\n      }\n    }\n\n    // Prevent ID change\n    delete updates.id;\n\n    // Update item\n    const updated = {\n      ...item,\n      ...updates,\n      updatedAt: Date.now()\n    };\n\n    this.items.set(id, updated);\n    this.scheduleSave();\n\n    Logger.info(`Library item updated: ${updated.name}`);\n    return updated;\n  }\n\n  /**\n   * Remove item from library\n   */\n  removeItem(id: string): void {\n    const item = this.items.get(id);\n    if (!item) {\n      throw new Error(`Library item not found: ${id}`);\n    }\n\n    // Remove from all playlists first\n    this.playlists.removeLibraryItemFromAllPlaylists(id);\n\n    this.items.delete(id);\n    this.scheduleSave();\n\n    Logger.info(`Library item removed: ${item.name}`);\n  }\n\n  /**\n   * Get item by ID\n   */\n  getItem(id: string): LibraryItem | undefined {\n    return this.items.get(id);\n  }\n\n  /**\n   * Get all items\n   */\n  getAllItems(): LibraryItem[] {\n    return Array.from(this.items.values());\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Search & Filter\n  // ─────────────────────────────────────────────────────────────\n\n  /**\n   * Find item by URL\n   */\n  findByUrl(url: string): LibraryItem | undefined {\n    return Array.from(this.items.values()).find(item => item.url === url);\n  }\n\n  /**\n   * Find item by name\n   */\n  findByName(name: string): LibraryItem | undefined {\n    return Array.from(this.items.values()).find(item => item.name === name);\n  }\n\n  /**\n   * Search items by query\n   */\n  searchByName(query: string): LibraryItem[] {\n    const lowerQuery = query.toLowerCase();\n    return this.getAllItems().filter(item =>\n      item.name.toLowerCase().includes(lowerQuery)\n    );\n  }\n\n  /**\n   * Filter items by tags (OR logic)\n   */\n  filterByTags(tags: string[]): LibraryItem[] {\n    if (tags.length === 0) return this.getAllItems();\n\n    return this.getAllItems().filter(item =>\n      item.tags.some(tag => tags.includes(tag))\n    );\n  }\n\n  /**\n   * Get favorite items (sorted by favoritesOrder)\n   */\n  getFavorites(): LibraryItem[] {\n    return this.getAllItems().filter(item => item.favorite);\n  }\n\n  /**\n   * Get ordered favorites list (tracks + playlists)\n   */\n  getOrderedFavorites(): Array<{ id: string, type: 'track' | 'playlist', addedAt: number }> {\n    // Clean up orphaned entries and ensure all favorites are in the order list\n    const validFavorites: Array<{ id: string, type: 'track' | 'playlist', addedAt: number }> = [];\n\n    // First, include items from the order list that still exist\n    for (const entry of this.favoritesOrder) {\n      if (entry.type === 'track') {\n        const item = this.items.get(entry.id);\n        if (item && item.favorite) {\n          validFavorites.push(entry);\n        }\n      } else {\n        const playlist = this.playlists.getPlaylist(entry.id);\n        if (playlist && playlist.favorite) {\n          validFavorites.push(entry);\n        }\n      }\n    }\n\n    // Add any favorites not in the order list (at the beginning = newest)\n    const inOrderSet = new Set(validFavorites.map(f => `${f.type}:${f.id}`));\n\n    // Tracks\n    for (const item of this.getAllItems()) {\n      if (item.favorite && !inOrderSet.has(`track:${item.id}`)) {\n        validFavorites.unshift({ id: item.id, type: 'track', addedAt: Date.now() });\n      }\n    }\n\n    // Playlists\n    for (const playlist of this.playlists.getFavoritePlaylists()) {\n      if (!inOrderSet.has(`playlist:${playlist.id}`)) {\n        validFavorites.unshift({ id: playlist.id, type: 'playlist', addedAt: Date.now() });\n      }\n    }\n\n    this.favoritesOrder = validFavorites;\n    return validFavorites;\n  }\n\n  /**\n   * Reorder favorites based on new order array\n   */\n  reorderFavorites(orderedItems: Array<{ id: string, type: 'track' | 'playlist' }>): void {\n    const now = Date.now();\n    this.favoritesOrder = orderedItems.map(item => ({\n      id: item.id,\n      type: item.type,\n      addedAt: this.favoritesOrder.find(f => f.id === item.id && f.type === item.type)?.addedAt ?? now\n    }));\n    this.scheduleSave();\n    Logger.info('Favorites reordered');\n  }\n\n  /**\n   * Add item to favorites order (at the beginning = newest)\n   */\n  addToFavoritesOrder(id: string, type: 'track' | 'playlist'): void {\n    // Remove if already exists\n    this.favoritesOrder = this.favoritesOrder.filter(f => !(f.id === id && f.type === type));\n    // Add at beginning (newest first)\n    this.favoritesOrder.unshift({ id, type, addedAt: Date.now() });\n    this.scheduleSave();\n  }\n\n  /**\n   * Remove item from favorites order\n   */\n  removeFromFavoritesOrder(id: string, type: 'track' | 'playlist'): void {\n    this.favoritesOrder = this.favoritesOrder.filter(f => !(f.id === id && f.type === type));\n    this.scheduleSave();\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Tags Management\n  // ─────────────────────────────────────────────────────────────\n\n  /**\n   * Get all unique tags\n   */\n  getAllTags(): string[] {\n    const tagSet = new Set<string>(this.customTags);\n    this.items.forEach(item => {\n      item.tags.forEach(tag => tagSet.add(tag));\n    });\n    return Array.from(tagSet).sort();\n  }\n\n  /**\n   * Add a custom tag explicitly (even if not used on any track)\n   */\n  addCustomTag(tag: string): void {\n    // Normalize: trim and remove leading #\n    const normalizedTag = tag.trim().replace(/^#/, '');\n    if (normalizedTag && !this.customTags.has(normalizedTag)) {\n      this.customTags.add(normalizedTag);\n      this.scheduleSave();\n    }\n  }\n\n  /**\n   * Add tag to item\n   */\n  addTagToItem(itemId: string, tag: string): void {\n    const item = this.getItem(itemId);\n    if (!item) {\n      throw new Error(`Library item not found: ${itemId}`);\n    }\n\n    if (!item.tags.includes(tag)) {\n      item.tags.push(tag);\n      item.updatedAt = Date.now();\n      this.scheduleSave();\n    }\n  }\n\n  /**\n   * Remove tag from item\n   */\n  removeTagFromItem(itemId: string, tag: string): void {\n    const item = this.getItem(itemId);\n    if (!item) {\n      throw new Error(`Library item not found: ${itemId}`);\n    }\n\n    const index = item.tags.indexOf(tag);\n    if (index !== -1) {\n      item.tags.splice(index, 1);\n      item.updatedAt = Date.now();\n      this.scheduleSave();\n    }\n  }\n\n  /**\n   * Rename tag globally\n   */\n  renameTag(oldTag: string, newTag: string): number {\n    let count = 0;\n    this.items.forEach(item => {\n      const index = item.tags.indexOf(oldTag);\n      if (index !== -1) {\n        item.tags[index] = newTag;\n        item.updatedAt = Date.now();\n        count++;\n      }\n    });\n\n    if (count > 0) {\n      if (this.customTags.has(oldTag)) {\n        this.customTags.delete(oldTag);\n        this.customTags.add(newTag);\n      }\n      this.scheduleSave();\n      Logger.info(`Tag renamed: \"${oldTag}\" → \"${newTag}\" (${count} items)`);\n    } else if (this.customTags.has(oldTag)) {\n      // Renaming a tag that is ONLY in customTags (no items)\n      this.customTags.delete(oldTag);\n      this.customTags.add(newTag);\n      this.scheduleSave();\n      Logger.info(`Custom tag renamed: \"${oldTag}\" → \"${newTag}\"`);\n    }\n\n    return count;\n  }\n\n  /**\n   * Delete tag globally\n   */\n  deleteTag(tag: string): number {\n    let count = 0;\n    this.items.forEach(item => {\n      const index = item.tags.indexOf(tag);\n      if (index !== -1) {\n        item.tags.splice(index, 1);\n        item.updatedAt = Date.now();\n        count++;\n      }\n    });\n\n    if (count > 0) {\n      if (this.customTags.has(tag)) {\n        this.customTags.delete(tag);\n      }\n      this.scheduleSave();\n      Logger.info(`Tag deleted: \"${tag}\" (${count} items)`);\n    } else if (this.customTags.has(tag)) {\n      // Deleting a tag that is ONLY in customTags\n      this.customTags.delete(tag);\n      this.scheduleSave();\n      Logger.info(`Custom tag deleted: \"${tag}\"`);\n    }\n\n    return count;\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Favorites\n  // ─────────────────────────────────────────────────────────────\n\n  /**\n   * Toggle favorite status\n   */\n  toggleFavorite(id: string): boolean {\n    const item = this.items.get(id);\n    if (!item) {\n      throw new Error('Item not found');\n    }\n\n    item.favorite = !item.favorite;\n    item.updatedAt = Date.now();\n\n    // Update favorites order array\n    if (item.favorite) {\n      this.addToFavoritesOrder(item.id, 'track');\n      Logger.info(`Added favorite: ${item.name}`);\n    } else {\n      this.removeFromFavoritesOrder(item.id, 'track'); // Assuming 'track' type for removal\n      Logger.info(`Removed favorite: ${item.name}`);\n    }\n\n    this.scheduleSave();\n\n    // Emit Hook for UI updates\n    Hooks.callAll('ase.favoritesChanged' as string as any, { id: item.id, isFavorite: item.favorite });\n\n    return item.favorite;\n  }\n\n\n  /**\n   * Scan library for items with missing duration (0) and try to extract it.\n   * Run this once per session or on demand.\n   */\n  public async scanMissingDurations(): Promise<void> {\n    if (this.hasScannedDurations) return;\n    this.hasScannedDurations = true;\n\n    const missing = Array.from(this.items.values()).filter(i => !i.duration || i.duration === 0);\n    if (missing.length === 0) return;\n\n    Logger.info(`Scanning ${missing.length} items for missing duration...`);\n    let updatedCount = 0;\n\n    // Process in batches to avoid network spam\n    const batchSize = 5;\n    for (let i = 0; i < missing.length; i += batchSize) {\n      const batch = missing.slice(i, i + batchSize);\n      await Promise.all(batch.map(item => new Promise<void>((resolve) => {\n        const audio = new Audio(item.url);\n\n        const cleanup = () => {\n          audio.onloadedmetadata = null;\n          audio.onerror = null;\n          resolve();\n        };\n\n        audio.onloadedmetadata = () => {\n          if (audio.duration && isFinite(audio.duration)) {\n            item.duration = Math.round(audio.duration);\n            updatedCount++;\n            // Don't save immediately for each item, batch it\n          }\n          cleanup();\n        };\n\n        audio.onerror = () => {\n          // Logger.warn(`Failed to extract duration for ${item.name} during scan`); // Optional: don't spam logs\n          cleanup();\n        };\n\n        // Timeout to prevent hanging\n        setTimeout(cleanup, 5000);\n      })));\n    }\n\n    if (updatedCount > 0) {\n      Logger.info(`Updated duration for ${updatedCount} items.`);\n      this.scheduleSave();\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Persistence\n  // ─────────────────────────────────────────────────────────────\n\n  /**\n   * Get library statistics\n   */\n  getStats(): LibraryStats {\n    const items = this.getAllItems();\n    const playlistStats = this.playlists.getStats();\n\n    return {\n      totalItems: items.length,\n      favoriteItems: items.filter(i => i.favorite).length,\n      totalDuration: items.reduce((sum, i) => sum + i.duration, 0),\n      tagCount: this.getAllTags().length,\n      totalPlaylists: playlistStats.totalPlaylists,\n      itemsByGroup: this.getGroupCounts(),\n    };\n  }\n\n  private getGroupCounts(): Record<TrackGroup, number> {\n    const counts: Record<TrackGroup, number> = { music: 0, ambience: 0, sfx: 0 };\n    for (const item of this.items.values()) {\n      if (counts[item.group] !== undefined) {\n        counts[item.group]++;\n      }\n    }\n    return counts;\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Persistence\n  // ─────────────────────────────────────────────────────────────\n\n  private async loadFromSettings(): Promise<void> {\n    try {\n      // First, try to migrate from old world-scoped settings\n      await GlobalStorage.migrateFromWorldSettings();\n\n      // Load from global storage\n      const state = await GlobalStorage.load();\n\n      if (!state) {\n        Logger.info('No saved library state, starting fresh');\n        return;\n      }\n\n      // Migrate if needed\n      if (state.version !== LIBRARY_VERSION) {\n        Logger.warn(`Library version mismatch: ${state.version} → ${LIBRARY_VERSION}`);\n        // Add migration logic here if needed\n      }\n\n      // Load items\n      this.items.clear();\n      // Use strict type guard or iteration\n      if (state.items) {\n        Object.values(state.items).forEach((item) => {\n          if (this.isValidLibraryItem(item)) {\n            // Migration: Ensure playbackMode exists\n            if (!item.playbackMode) {\n              item.playbackMode = 'inherit';\n            }\n            this.items.set(item.id, item);\n          }\n        });\n      }\n\n      // Load custom tags\n      this.customTags = new Set(state.customTags || []);\n\n      // Load playlists\n      this.playlists.load(state.playlists || {});\n\n      // Load favorites order\n      this.favoritesOrder = state.favoritesOrder || [];\n\n      Logger.info(`Library loaded: ${this.items.size} items, ${this.playlists.getAllPlaylists().length} playlists, ${this.customTags.size} custom tags`);\n    } catch (error) {\n      Logger.error('Failed to load library state:', error);\n    }\n  }\n\n  private isValidLibraryItem(item: any): item is LibraryItem {\n    return item && typeof item.id === 'string' && typeof item.url === 'string';\n  }\n\n  private async saveToSettings(): Promise<void> {\n    try {\n      const state: LibraryState = {\n        items: Object.fromEntries(this.items),\n        playlists: this.playlists.export(),\n        customTags: Array.from(this.customTags),\n        favoritesOrder: this.favoritesOrder, // Extended property in state (needs interface update if missing)\n        version: LIBRARY_VERSION,\n        lastModified: Date.now()\n      };\n\n      await GlobalStorage.save(state);\n      this.saveScheduled = false;\n\n      Logger.debug(`Library saved: ${this.items.size} items, ${this.playlists.getAllPlaylists().length} playlists`);\n    } catch (error) {\n      Logger.error('Failed to save library state:', error);\n    }\n  }\n\n  private scheduleSave(): void {\n    this.debouncedSave();\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Utilities\n  // ─────────────────────────────────────────────────────────────\n\n  private extractNameFromUrl(url: string): string {\n    try {\n      const decoded = decodeURIComponent(url);\n      const parts = decoded.split('/');\n      const filename = parts[parts.length - 1];\n      return filename.replace(/\\.[^.]+$/, ''); // Remove extension\n    } catch {\n      return 'Unknown Track';\n    }\n  }\n\n  /**\n   * Clear all library data\n   */\n  clear(): void {\n    this.items.clear();\n    this.playlists.clear();\n    this.scheduleSave();\n    Logger.warn('Library cleared');\n  }\n\n  /**\n   * Dispose resources\n   */\n  dispose(): void {\n    // Save immediately before disposing\n    if (this.saveScheduled) {\n      this.saveToSettings();\n    }\n  }\n}\n","import type { QueueItem, PlaybackQueueState } from '@t/queue';\nimport type { TrackGroup } from '@t/audio';\nimport { generateUUID } from '@utils/uuid';\nimport { Logger } from '../utils/logger';\n\nconst MODULE_ID = 'advanced-sound-engine';\n\ntype QueueEventType = 'add' | 'remove' | 'change' | 'active';\ntype QueueEventCallback = (data: { item?: QueueItem; items?: QueueItem[] }) => void;\n\n/**\n * Manages the playback queue\n * Queue state is persisted between sessions via game.settings\n */\nexport class PlaybackQueueManager {\n    private items: QueueItem[] = [];\n    private activeItemId: string | null = null;\n    private eventListeners: Map<QueueEventType, Set<QueueEventCallback>> = new Map();\n    private saveTimeout: number | null = null;\n\n    constructor() {\n        Logger.info('PlaybackQueueManager initialized');\n    }\n\n    /**\n     * Load queue state from settings\n     */\n    async load(): Promise<void> {\n        try {\n            const savedState = (game.settings as any)?.get(MODULE_ID, 'queueState') as PlaybackQueueState | undefined;\n\n            if (savedState && savedState.items) {\n                this.items = savedState.items;\n                this.activeItemId = savedState.activeItemId || null;\n                Logger.info(`Loaded ${this.items.length} items from queue`);\n            } else {\n                Logger.debug('No saved queue state found');\n            }\n        } catch (error) {\n            Logger.error('Failed to load queue state:', error);\n        }\n    }\n\n    /**\n     * Save queue state to settings (debounced)\n     */\n    private scheduleSave(): void {\n        if (this.saveTimeout !== null) {\n            window.clearTimeout(this.saveTimeout);\n        }\n\n        this.saveTimeout = window.setTimeout(() => {\n            this.save();\n            this.saveTimeout = null;\n        }, 500); // 500ms debounce\n    }\n\n    /**\n     * Save queue state immediately\n     */\n    private async save(): Promise<void> {\n        try {\n            const state: PlaybackQueueState = {\n                items: this.items,\n                activeItemId: this.activeItemId\n            };\n\n            await (game.settings as any)?.set(MODULE_ID, 'queueState', state);\n            Logger.debug('Queue state saved');\n        } catch (error) {\n            Logger.error('Failed to save queue state:', error);\n        }\n    }\n\n    // ─────────────────────────────────────────────────────────────\n    // Core Operations\n    // ─────────────────────────────────────────────────────────────\n\n    /**\n     * Add a library item to the queue\n     */\n    addItem(libraryItemId: string, options?: Partial<Omit<QueueItem, 'id' | 'libraryItemId' | 'addedAt'>>): QueueItem {\n        const item: QueueItem = {\n            id: generateUUID(),\n            libraryItemId,\n            group: options?.group ?? 'music',\n            addedAt: Date.now(),\n            state: 'stopped',\n            volume: options?.volume ?? 1,\n            playlistId: options?.playlistId,\n        };\n\n        this.items.push(item);\n        this.emit('add', { item });\n        this.emit('change', { items: this.items });\n        this.scheduleSave();\n\n        Logger.debug('Added to queue:', item.id, libraryItemId);\n        return item;\n    }\n\n    /**\n     * Add all items from a playlist to the queue\n     */\n    addPlaylist(playlistId: string, playlistItems: Array<{ libraryItemId: string; group: TrackGroup; volume?: number; loop?: boolean }>): QueueItem[] {\n        const added: QueueItem[] = [];\n\n        for (const pItem of playlistItems) {\n            const queueItem = this.addItem(pItem.libraryItemId, {\n                playlistId,\n                group: pItem.group,\n                volume: pItem.volume,\n                // Loop is removed\n            });\n            added.push(queueItem);\n        }\n\n        return added;\n    }\n\n    /**\n     * Remove an item from the queue\n     */\n    removeItem(queueItemId: string): boolean {\n        const index = this.items.findIndex(i => i.id === queueItemId);\n        if (index === -1) return false;\n\n        const [removed] = this.items.splice(index, 1);\n\n        if (this.activeItemId === queueItemId) {\n            this.activeItemId = null;\n            this.emit('active', { item: undefined });\n        }\n\n        this.emit('remove', { item: removed });\n        this.emit('change', { items: this.items });\n        this.scheduleSave();\n\n        Logger.debug('Removed from queue:', queueItemId);\n        return true;\n    }\n\n    /**\n     * Clear all items from the queue\n     */\n    clearQueue(): void {\n        this.items = [];\n        this.activeItemId = null;\n        this.emit('change', { items: [] });\n        this.emit('active', { item: undefined });\n        this.scheduleSave();\n        Logger.debug('Queue cleared');\n    }\n\n    /**\n     * Move a queue item to a new position\n     */\n    moveItem(queueItemId: string, newIndex: number): void {\n        const currentIndex = this.items.findIndex(i => i.id === queueItemId);\n        if (currentIndex === -1) {\n            Logger.warn('Cannot move: item not in queue', queueItemId);\n            return;\n        }\n\n        // Clamp newIndex\n        const clampedIndex = Math.max(0, Math.min(newIndex, this.items.length - 1));\n        if (currentIndex === clampedIndex) return;\n\n        const [item] = this.items.splice(currentIndex, 1);\n        this.items.splice(clampedIndex, 0, item);\n\n        this.emit('change', { items: this.items });\n        this.scheduleSave();\n        Logger.debug('Moved queue item:', queueItemId, 'to index:', clampedIndex);\n    }\n\n    // ─────────────────────────────────────────────────────────────\n    // Playback Control\n    // ─────────────────────────────────────────────────────────────\n\n    /**\n     * Set the currently active (playing) item\n     */\n    setActive(queueItemId: string | null): void {\n        if (queueItemId && !this.items.find(i => i.id === queueItemId)) {\n            Logger.warn('Cannot set active: item not in queue', queueItemId);\n            return;\n        }\n\n        this.activeItemId = queueItemId;\n        const item = this.getActive();\n        this.emit('active', { item: item ?? undefined });\n        Logger.debug('Active item set:', queueItemId);\n    }\n\n    /**\n     * Get the currently active item\n     */\n    getActive(): QueueItem | null {\n        if (!this.activeItemId) return null;\n        return this.items.find(i => i.id === this.activeItemId) ?? null;\n    }\n\n    /**\n     * Get the next item in the queue (after active)\n     */\n    getNext(): QueueItem | null {\n        if (!this.activeItemId) return this.items[0] ?? null;\n\n        const currentIndex = this.items.findIndex(i => i.id === this.activeItemId);\n        if (currentIndex === -1 || currentIndex >= this.items.length - 1) return null;\n\n        return this.items[currentIndex + 1];\n    }\n\n    /**\n     * Get the previous item in the queue (before active)\n     */\n    getPrevious(): QueueItem | null {\n        if (!this.activeItemId) return null;\n\n        const currentIndex = this.items.findIndex(i => i.id === this.activeItemId);\n        if (currentIndex <= 0) return null;\n\n        return this.items[currentIndex - 1];\n    }\n\n    /**\n     * Update the state of a queue item\n     */\n    updateItemState(queueItemId: string, state: QueueItem['state']): void {\n        const item = this.items.find(i => i.id === queueItemId);\n        if (item) {\n            item.state = state;\n            this.emit('change', { items: this.items });\n        }\n    }\n\n    // ─────────────────────────────────────────────────────────────\n    // State Access\n    // ─────────────────────────────────────────────────────────────\n\n    /**\n     * Get all items in the queue\n     */\n    getItems(): QueueItem[] {\n        return [...this.items];\n    }\n\n    /**\n     * Get full queue state\n     */\n    getState(): PlaybackQueueState {\n        return {\n            items: [...this.items],\n            activeItemId: this.activeItemId,\n        };\n    }\n\n    /**\n     * Check if an item is in the queue\n     */\n    hasItem(libraryItemId: string): boolean {\n        return this.items.some(i => i.libraryItemId === libraryItemId);\n    }\n\n    /**\n     * Remove all queue items that reference a specific library item\n     */\n    removeByLibraryItemId(libraryItemId: string): boolean {\n        const toRemove = this.items.filter(i => i.libraryItemId === libraryItemId);\n        if (toRemove.length === 0) return false;\n\n        for (const item of toRemove) {\n            this.removeItem(item.id);\n        }\n        return true;\n    }\n\n    // ─────────────────────────────────────────────────────────────\n    // Event System\n    // ─────────────────────────────────────────────────────────────\n\n    /**\n     * Dispose: clear pending save timer and all event listeners\n     */\n    dispose(): void {\n        if (this.saveTimeout !== null) {\n            window.clearTimeout(this.saveTimeout);\n            this.saveTimeout = null;\n        }\n        this.eventListeners.clear();\n        Logger.debug('PlaybackQueueManager disposed');\n    }\n\n    on(event: QueueEventType, callback: QueueEventCallback): void {\n        if (!this.eventListeners.has(event)) {\n            this.eventListeners.set(event, new Set());\n        }\n        this.eventListeners.get(event)!.add(callback);\n    }\n\n    off(event: QueueEventType, callback: QueueEventCallback): void {\n        this.eventListeners.get(event)?.delete(callback);\n    }\n\n    private emit(event: QueueEventType, data: { item?: QueueItem; items?: QueueItem[] }): void {\n        this.eventListeners.get(event)?.forEach(cb => cb(data));\n    }\n}\n","import { Logger } from '@utils/logger';\nimport { AudioEngine } from './AudioEngine';\nimport { LibraryManager } from '../library/LibraryManager';\nimport { PlaybackMode } from '@t/library';\nimport type { PlaybackQueueManager } from '../queue/PlaybackQueueManager';\n// Define a local type alias if import fails or just use string literal union if types are tricky to resolve in this hybrid env\ntype PlaylistPlaybackMode = 'linear' | 'loop' | 'random';\n\nexport interface PlaybackContext {\n    type: 'playlist' | 'track' | 'queue';\n    id?: string; // Playlist ID or specific context ID\n    playbackMode?: PlaybackMode | PlaylistPlaybackMode;\n}\n\nexport class PlaybackScheduler {\n    private engine: AudioEngine;\n    private library: LibraryManager;\n    private queue: PlaybackQueueManager;\n    private currentContext: PlaybackContext | null = null;\n    private _stopped: boolean = false;\n\n    // Stored callbacks for proper cleanup\n    private _onTrackEndedBound: (trackId: string) => void;\n    private _onContextChangedBound: (context: PlaybackContext) => void;\n\n    constructor(engine: AudioEngine, library: LibraryManager, queue: PlaybackQueueManager) {\n        this.engine = engine;\n        this.library = library;\n        this.queue = queue;\n\n        this._onTrackEndedBound = (trackId: string) => this.handleTrackEnded(trackId);\n        this._onContextChangedBound = (context: PlaybackContext) => this.setContext(context);\n\n        this.setupListeners();\n    }\n\n    private setupListeners(): void {\n        this.engine.on('trackEnded', this._onTrackEndedBound);\n        this.engine.on('contextChanged', this._onContextChangedBound);\n    }\n\n    /**\n     * Dispose: remove all engine event listeners\n     */\n    dispose(): void {\n        this.engine.off('trackEnded', this._onTrackEndedBound);\n        this.engine.off('contextChanged', this._onContextChangedBound);\n        this.currentContext = null;\n        this._stopped = true;\n        Logger.debug('[PlaybackScheduler] Disposed');\n    }\n\n    /**\n     * Set the current playback context (e.g., user clicked \"Play\" on a playlist)\n     */\n    setContext(context: PlaybackContext): void {\n        this.currentContext = context;\n        this._stopped = false;\n        Logger.debug('Playback Context set:', context);\n    }\n\n    /**\n     * Clear the playback context and stop scheduling.\n     * Called by AudioEngine.stopAll() to prevent race conditions\n     * where an 'ended' event fires after stopAll and Scheduler starts the next track.\n     */\n    clearContext(): void {\n        this.currentContext = null;\n        this._stopped = true;\n        Logger.debug('Playback Context cleared (stopAll)');\n    }\n\n    /**\n     * Handle track ending\n     */\n    async handleTrackEnded(trackId: string): Promise<void> {\n        Logger.info(`[PlaybackScheduler] Track ended: ${trackId}`);\n\n        // Guard: if stopAll() was called, ignore any late 'ended' events\n        if (this._stopped) {\n            Logger.debug(`[PlaybackScheduler] Ignoring ended event after stopAll for: ${trackId}`);\n            return;\n        }\n\n        Logger.info(`[PlaybackScheduler] Current context:`, this.currentContext);\n\n        if (!this.currentContext) {\n            Logger.warn('[PlaybackScheduler] No playback context available - auto-progression disabled');\n            return;\n        }\n\n        const { type, id } = this.currentContext;\n        Logger.info(`[PlaybackScheduler] Context type: ${type}, id: ${id || 'none'}, mode: ${this.currentContext.playbackMode}`);\n\n        if (type === 'playlist' && id) {\n            Logger.info(`[PlaybackScheduler] Handling playlist context: ${id}`);\n            await this.handlePlaylistContext(id, trackId);\n        } else if (type === 'track') {\n            Logger.info(`[PlaybackScheduler] Handling track context`);\n            await this.handleTrackContext(trackId);\n        }\n    }\n\n\n    private async handlePlaylistContext(playlistId: string, endedTrackId: string): Promise<void> {\n        const playlist = this.library.playlists.getPlaylist(playlistId);\n        if (!playlist) {\n            Logger.warn(`Playlist ${playlistId} not found`);\n            return;\n        }\n\n        // Ensure items are sorted\n        const tracks = [...playlist.items].sort((a, b) => a.order - b.order);\n        if (tracks.length === 0) {\n            Logger.warn(`Playlist ${playlist.name} is empty`);\n            return;\n        }\n\n        // Find current track by libraryItemId (AudioEngine uses libraryItemId as track ID)\n        const currentIndex = tracks.findIndex(t => t.libraryItemId === endedTrackId);\n\n        if (currentIndex === -1) {\n            Logger.warn(`Ended track ${endedTrackId} not found in playlist ${playlist.name}`);\n            return;\n        }\n\n        // Проверить индивидуальный режим трека\n        const track = this.library.getItem(endedTrackId);\n        if (!track) {\n            Logger.warn(`Track ${endedTrackId} not found in library`);\n            return;\n        }\n\n        // Если у трека свой режим (не inherit), обработать его индивидуально\n        if (track.playbackMode && track.playbackMode !== 'inherit') {\n            Logger.info(`Track ${track.name} has individual mode: ${track.playbackMode}`);\n            await this.handleIndividualTrackMode(endedTrackId, track.playbackMode as PlaybackMode, playlistId);\n            return; // Не продолжать логику плейлиста\n        }\n\n        // Трек наследует режим плейлиста\n        Logger.debug(`Track ${track.name} inherits playlist mode`);\n        const mode = (playlist.playbackMode || 'loop') as PlaylistPlaybackMode;\n\n        // ─── QUEUE SYNC FIX ───\n        // Check if this playlist exists in the Queue. If so, use the Queue's order.\n        const queueItems = this.queue.getItems().filter(i => i.playlistId === playlistId);\n        let effectiveTracks: { libraryItemId: string, volume?: number }[] = tracks;\n        let effectiveIndex = currentIndex;\n\n        if (queueItems.length > 0) {\n            // Map QueueItems to a structure compatible with our logic\n            effectiveTracks = queueItems.map(qi => ({\n                libraryItemId: qi.libraryItemId,\n                volume: qi.volume\n            }));\n\n            // Recalculate index based on Queue Order\n            effectiveIndex = effectiveTracks.findIndex(t => t.libraryItemId === endedTrackId);\n            Logger.debug(`Using Queue order for playlist ${playlist.name}. Index: ${effectiveIndex}/${effectiveTracks.length}`);\n        } else {\n            Logger.debug(`Using Library order for playlist ${playlist.name} (not in queue). Index: ${currentIndex}/${tracks.length}`);\n        }\n\n        Logger.debug(`Playlist mode: ${mode}, current index: ${effectiveIndex}/${effectiveTracks.length}`);\n\n        switch (mode) {\n            case 'linear':\n                if (effectiveIndex < effectiveTracks.length - 1) {\n                    const nextItem = effectiveTracks[effectiveIndex + 1];\n                    // Остановить текущий трек перед запуском следующего\n                    await this.engine.stopTrack(endedTrackId);\n                    await this.playPlaylistItem(nextItem, playlistId, playlist.playbackMode);\n                } else {\n                    Logger.debug('Playlist linear playback finished.');\n                    // Очистить контекст после завершения\n                    await this.engine.stopTrack(endedTrackId);\n                    this.currentContext = null;\n                }\n                break;\n            case 'loop':\n                let nextIndex = effectiveIndex + 1;\n                if (nextIndex >= effectiveTracks.length) {\n                    nextIndex = 0; // Loop back to start\n                }\n                // Остановить текущий трек перед запуском следующего\n                await this.engine.stopTrack(endedTrackId);\n                await this.playPlaylistItem(effectiveTracks[nextIndex], playlistId, playlist.playbackMode);\n                break;\n            case 'random':\n                // Остановить текущий трек перед запуском следующего\n                await this.engine.stopTrack(endedTrackId);\n\n                // Simple random: pick any other track from EFFECTIVE list\n                if (effectiveTracks.length > 1) {\n                    let randomIndex;\n                    do {\n                        randomIndex = Math.floor(Math.random() * effectiveTracks.length);\n                    } while (randomIndex === effectiveIndex && effectiveTracks.length > 1);\n                    await this.playPlaylistItem(effectiveTracks[randomIndex], playlistId, playlist.playbackMode);\n                } else {\n                    // If only 1 track, repeat it\n                    await this.playPlaylistItem(effectiveTracks[0], playlistId, playlist.playbackMode);\n                }\n                break;\n        }\n    }\n\n    /**\n     * Воспроизвести элемент плейлиста\n     * @param item - Элемент плейлиста\n     * @param playlistId - ID плейлиста\n     * @param playlistMode - Режим воспроизведения плейлиста\n     */\n    private async playPlaylistItem(item: any, playlistId: string, playlistMode: string): Promise<void> {\n        const track = this.library.getItem(item.libraryItemId);\n        if (!track) {\n            Logger.warn(`Track ${item.libraryItemId} not found in library`);\n            return;\n        }\n\n        Logger.debug(`Playing playlist item: ${track.name}`);\n\n        // Проверить, существует ли трек в AudioEngine\n        let player = this.engine.getTrack(track.id);\n\n        // Создать трек, если не существует\n        if (!player) {\n            player = await this.engine.createTrack({\n                id: track.id,\n                url: track.url,\n                group: track.group,\n                volume: item.volume !== undefined ? item.volume : 1\n            });\n        }\n\n        // Создать контекст плейлиста\n        const context: PlaybackContext = {\n            type: 'playlist',\n            id: playlistId,\n            playbackMode: playlistMode as PlaylistPlaybackMode\n        };\n\n        // Воспроизвести трек с контекстом плейлиста\n        await this.engine.playTrack(track.id, 0, context);\n\n        // Notify UI about track change\n        Hooks.call('ase.trackAutoSwitched' as any);\n    }\n\n    /**\n     * Обработать завершение отдельного трека (не из плейлиста)\n     * @param trackId - ID завершившегося трека\n     */\n    private async handleTrackContext(trackId: string): Promise<void> {\n        const track = this.library.getItem(trackId);\n        if (!track) {\n            Logger.warn(`Track ${trackId} not found in library`);\n            return;\n        }\n\n        let mode = track.playbackMode as PlaybackMode;\n\n        // Если режим inherit, используем single как fallback (для одиночных треков)\n        if (mode === 'inherit') {\n            Logger.debug(`Track ${track.name} has inherit mode, using single as fallback`);\n            mode = 'single';\n        }\n\n        Logger.debug(`Track ${track.name} playback mode: ${mode}`);\n\n        switch (mode) {\n            case 'loop':\n                // Повторить тот же трек\n                Logger.debug(`Looping track: ${track.name}`);\n                const context: PlaybackContext = {\n                    type: 'track',\n                    playbackMode: 'loop'\n                };\n                await this.engine.playTrack(trackId, 0, context);\n                break;\n\n            case 'single':\n                // Воспроизвести один раз и остановить (полный сброс)\n                Logger.debug(`Track ${track.name} finished (single mode) - stopping`);\n                await this.engine.stopTrack(trackId);\n                this.currentContext = null;\n                break;\n\n            case 'random':\n            case 'linear':\n                // Для отдельных треков используем Ungrouped как виртуальный плейлист\n                await this.handleUngroupedQueueContext(trackId, mode);\n                break;\n        }\n    }\n\n    /**\n     * Обработать индивидуальный режим воспроизведения трека в контексте плейлиста\n     * @param trackId - ID завершившегося трека\n     * @param mode - Индивидуальный режим трека\n     * @param playlistId - ID плейлиста (если контекст плейлиста)\n     */\n    private async handleIndividualTrackMode(trackId: string, mode: PlaybackMode, playlistId?: string): Promise<void> {\n        const track = this.library.getItem(trackId);\n        if (!track) {\n            Logger.warn(`Track ${trackId} not found in library`);\n            return;\n        }\n\n        Logger.debug(`Handling individual track mode: ${track.name} - ${mode}`);\n\n        switch (mode) {\n            case 'loop':\n                // Повторить тот же трек (игнорируя логику плейлиста)\n                Logger.debug(`Looping track: ${track.name}`);\n                const loopContext: PlaybackContext = {\n                    type: 'track',\n                    playbackMode: 'loop'\n                };\n                await this.engine.playTrack(trackId, 0, loopContext);\n                Hooks.call('ase.trackAutoSwitched' as any);\n                break;\n\n            case 'single':\n                // Остановить трек полностью (перевести в Stop)\n                Logger.debug(`Track ${track.name} finished (single mode) - stopping`);\n                await this.engine.stopTrack(trackId);\n                this.currentContext = null;\n                break;\n\n            case 'random':\n                // Random для одного трека = повторить его в random режиме\n                Logger.debug(`Random track: ${track.name} - repeating`);\n                // Остановить перед повторным запуском (сброс UI)\n                await this.engine.stopTrack(trackId);\n\n                const randomContext: PlaybackContext = {\n                    type: 'track',\n                    playbackMode: 'random'\n                };\n                await this.engine.playTrack(trackId, 0, randomContext);\n                Hooks.call('ase.trackAutoSwitched' as any);\n                break;\n\n            case 'linear':\n                if (playlistId) {\n                    const playlist = this.library.playlists.getPlaylist(playlistId);\n                    if (playlist) {\n                        // Use queue order if playlist is in the queue, otherwise fall back to library order\n                        const queueItems = this.queue.getItems().filter(i => i.playlistId === playlistId);\n                        let effectiveTracks: { libraryItemId: string, volume?: number }[];\n\n                        if (queueItems.length > 0) {\n                            effectiveTracks = queueItems.map(qi => ({\n                                libraryItemId: qi.libraryItemId,\n                                volume: qi.volume\n                            }));\n                            Logger.debug(`[handleIndividualTrackMode] Using Queue order for playlist ${playlist.name}`);\n                        } else {\n                            effectiveTracks = [...playlist.items].sort((a, b) => a.order - b.order).map(t => ({\n                                libraryItemId: t.libraryItemId,\n                                volume: t.volume\n                            }));\n                            Logger.debug(`[handleIndividualTrackMode] Using Library order for playlist ${playlist.name}`);\n                        }\n\n                        const currentIndex = effectiveTracks.findIndex(t => t.libraryItemId === trackId);\n\n                        if (currentIndex !== -1 && currentIndex < effectiveTracks.length - 1) {\n                            Logger.debug(`Track ${track.name} (linear) -> launching next track in playlist`);\n                            // Остановить текущий трек перед запуском следующего\n                            await this.engine.stopTrack(trackId);\n\n                            const nextItem = effectiveTracks[currentIndex + 1];\n                            await this.playPlaylistItem(nextItem, playlistId, playlist.playbackMode || 'loop');\n                            return;\n                        }\n                    }\n                }\n\n                // Linear для одиночного трека (или конец плейлиста) = single (остановить)\n                Logger.debug(`Track ${track.name} finished (linear mode) and no next track - stopping`);\n                await this.engine.stopTrack(trackId);\n                this.currentContext = null;\n                break;\n\n            case 'inherit':\n                // Не должно попасть сюда (проверено выше)\n                Logger.warn(`Unexpected inherit mode in handleIndividualTrackMode`);\n                break;\n        }\n    }\n\n    /**\n     * Обработать Random/Linear режимы для треков в Ungrouped очереди\n     * @param trackId - ID завершившегося трека\n     * @param mode - Режим воспроизведения (random или linear)\n     */\n    private async handleUngroupedQueueContext(trackId: string, mode: 'random' | 'linear'): Promise<void> {\n        // Получить все треки из очереди без playlistId (Ungrouped)\n        const ungroupedTracks = this.queue.getItems().filter(item => !item.playlistId);\n\n        if (ungroupedTracks.length === 0) {\n            Logger.debug('No ungrouped tracks in queue');\n            this.currentContext = null;\n            return;\n        }\n\n        // Найти индекс текущего трека\n        const currentIndex = ungroupedTracks.findIndex(item => item.libraryItemId === trackId);\n\n        if (currentIndex === -1) {\n            Logger.warn(`Track ${trackId} not found in ungrouped queue`);\n            this.currentContext = null;\n            return;\n        }\n\n        Logger.debug(`Ungrouped queue mode: ${mode}, current index: ${currentIndex}/${ungroupedTracks.length}`);\n\n        let nextTrack = null;\n\n        if (mode === 'linear') {\n            // Следующий трек в порядке очереди\n            if (currentIndex < ungroupedTracks.length - 1) {\n                nextTrack = ungroupedTracks[currentIndex + 1];\n                Logger.debug(`Linear: playing next track in ungrouped queue`);\n            } else {\n                Logger.debug('Ungrouped linear playback finished');\n                this.currentContext = null;\n                return;\n            }\n        } else if (mode === 'random') {\n            // Случайный трек из ungrouped очереди\n            if (ungroupedTracks.length > 1) {\n                let randomIndex;\n                do {\n                    randomIndex = Math.floor(Math.random() * ungroupedTracks.length);\n                } while (randomIndex === currentIndex && ungroupedTracks.length > 1);\n                nextTrack = ungroupedTracks[randomIndex];\n                Logger.debug(`Random: selected track at index ${randomIndex}`);\n            } else {\n                // Только один трек - повторить его\n                nextTrack = ungroupedTracks[0];\n                Logger.debug('Random: only one track, repeating it');\n            }\n        }\n\n        if (!nextTrack) {\n            this.currentContext = null;\n            return;\n        }\n\n        // Получить данные трека из библиотеки\n        const libraryItem = this.library.getItem(nextTrack.libraryItemId);\n        if (!libraryItem) {\n            Logger.warn(`Track ${nextTrack.libraryItemId} not found in library`);\n            this.currentContext = null;\n            return;\n        }\n\n        // Проверить, существует ли трек в AudioEngine\n        let player = this.engine.getTrack(libraryItem.id);\n\n        // Создать трек, если не существует\n        if (!player) {\n            player = await this.engine.createTrack({\n                id: libraryItem.id,\n                url: libraryItem.url,\n                group: libraryItem.group,\n                volume: 1\n            });\n        }\n\n        // Создать контекст трека\n        const context: PlaybackContext = {\n            type: 'track',\n            playbackMode: mode\n        };\n\n        // Воспроизвести следующий трек\n        await this.engine.playTrack(libraryItem.id, 0, context);\n\n        // Notify UI about track change\n        Hooks.call('ase.trackAutoSwitched' as any);\n    }\n}\n","console.log(\"ADVANCED SOUND ENGINE: Entry point loaded\");\nimport '../styles/sound-engine.scss';\nimport { AudioEngine } from '@core/AudioEngine';\nimport { PlayerAudioEngine } from '@core/PlayerAudioEngine';\nimport { SocketManager } from '@sync/SocketManager';\nimport { SoundMixerApp } from '@ui/SoundMixerApp';\nimport { PlayerVolumePanel } from '@ui/PlayerVolumePanel';\nimport { LocalLibraryApp } from '@ui/LocalLibraryApp';\nimport { AdvancedSoundEngineApp } from '@ui/AdvancedSoundEngineApp';\nimport { LibraryManager } from '@lib/LibraryManager';\nimport { PlaybackQueueManager } from './queue/PlaybackQueueManager';\nimport { Logger } from '@utils/logger';\nimport { PlaybackScheduler } from '@core/PlaybackScheduler';\n\nconst MODULE_ID = 'advanced-sound-engine';\n\n// GM\nlet gmEngine: AudioEngine | null = null;\nlet mainApp: AdvancedSoundEngineApp | null = null;\nlet libraryManager: LibraryManager | null = null;\nlet queueManager: PlaybackQueueManager | null = null;\nlet playbackScheduler: PlaybackScheduler | null = null;\n\n// Player\nlet playerEngine: PlayerAudioEngine | null = null;\nlet volumePanel: PlayerVolumePanel | null = null;\n\n// Shared\nlet socketManager: SocketManager | null = null;\n\ndeclare global {\n  interface Window {\n    ASE: {\n      isGM: boolean;\n      openPanel: (tab?: string, forceRender?: boolean) => void;\n      openLibrary?: () => void;\n      engine?: AudioEngine | PlayerAudioEngine;\n      socket?: SocketManager;\n      library?: LibraryManager;\n      queue?: PlaybackQueueManager;\n    };\n  }\n}\n\n\n\n// Add button to scene controls\n// Add button to scene controls\n// Add button to scene controls\nHooks.on('getSceneControlButtons', (controls: SceneControl[]) => {\n  try {\n    const isGM = game.user?.isGM ?? false;\n\n    const aseTools: SceneControlTool[] = [\n      {\n        name: 'ase-open-mixer',\n        title: isGM ? 'Open Sound Mixer' : 'Open Sound Volume',\n        icon: isGM ? 'fas fa-sliders-h' : 'fas fa-volume-up',\n        button: true,\n        onClick: () => {\n          Logger.debug('Button clicked: Open Mixer/Volume');\n          if (window.ASE) {\n            window.ASE.openPanel();\n          } else {\n            Logger.error('Window.ASE is undefined!');\n          }\n        }\n      }\n    ];\n\n    if (isGM) {\n      aseTools.push({\n        name: 'ase-open-library',\n        title: 'Open Sound Library',\n        icon: 'fas fa-book-open',\n        button: true,\n        onClick: () => {\n          Logger.debug('Button clicked: Open Library');\n          if (window.ASE && window.ASE.openLibrary) {\n            window.ASE.openLibrary();\n          } else {\n            Logger.error('Window.ASE or openLibrary undefined');\n          }\n        }\n      });\n    }\n\n    // V13+ Compatibility: controls might be an object/record instead of an array\n    if (!Array.isArray(controls) && typeof controls === 'object' && controls !== null) {\n      Logger.info('Detected non-array controls structure (V13?)');\n\n      // Check if \"sounds\" exists as a property\n      const soundsLayer = (controls as any).sounds;\n\n      if (soundsLayer && Array.isArray(soundsLayer.tools)) {\n        soundsLayer.tools.push(...aseTools);\n        Logger.info('Added tools to \"sounds\" layer (V13 Object Mode)');\n      } else {\n        // Fallback: Add as a new property\n        (controls as any)['advanced-sound-engine'] = {\n          name: 'advanced-sound-engine',\n          title: 'Advanced Sound Engine',\n          icon: 'fas fa-music',\n          visible: true,\n          tools: aseTools\n        };\n        Logger.info('Created dedicated control group (V13 Object Mode)');\n      }\n      return;\n    }\n\n    // V10-V12 Compatibility: controls is an array\n    if (Array.isArray(controls)) {\n      // Try to find the \"sounds\" layer control group\n      const soundsLayer = controls.find((c: SceneControl) => c.name === 'sounds');\n\n      if (soundsLayer) {\n        // Add our tools to the existing sounds layer\n        soundsLayer.tools.push(...aseTools);\n      } else {\n        // Fallback: Create a dedicated group if \"sounds\" layer is missing\n        controls.push({\n          name: 'advanced-sound-engine',\n          title: 'Advanced Sound Engine',\n          icon: 'fas fa-music',\n          visible: true,\n          tools: aseTools\n        });\n      }\n    } else {\n      Logger.warn('Unknown controls structure:', controls);\n    }\n\n  } catch (error) {\n    Logger.error('Failed to initialize scene controls:', error);\n  }\n});\n\n// Manually bind click listeners in case standard onClick fails (V13 compat)\nHooks.on('renderSceneControls', (controls: any, html: JQuery) => {\n  try {\n    // Detect if html is jQuery or native Element\n    const findElement = (selector: string): HTMLElement | null => {\n      // Foundry often passes jQuery objects\n      if (typeof (html as any).find === 'function') {\n        const el = (html as any).find(selector);\n        return el.length ? el[0] : null;\n      }\n      // Native HTMLElement\n      else if (html instanceof HTMLElement) {\n        return html.querySelector(selector);\n      }\n      return null;\n    };\n\n    const mixerBtn = findElement('[data-tool=\"ase-open-mixer\"]');\n    if (mixerBtn) {\n      mixerBtn.onclick = (event: MouseEvent) => {\n        event.preventDefault();\n        event.stopPropagation();\n        Logger.debug('Manual click handler (native): Open Mixer');\n        window.ASE?.openPanel();\n      };\n    }\n\n    const libraryBtn = findElement('[data-tool=\"ase-open-library\"]');\n    if (libraryBtn) {\n      libraryBtn.onclick = (event: MouseEvent) => {\n        event.preventDefault();\n        event.stopPropagation();\n        Logger.debug('Manual click handler (native): Open Library');\n        window.ASE?.openLibrary?.();\n      };\n    }\n  } catch (error) {\n    Logger.warn('Failed to bind manual click listeners:', error);\n  }\n});\n// ─────────────────────────────────────────────────────────────\n// Initialization\n// ─────────────────────────────────────────────────────────────\n\n// ─────────────────────────────────────────────────────────────\n// Handlebars Helpers\n// ─────────────────────────────────────────────────────────────\n\nfunction registerHandlebarsHelpers(): void {\n  // Format duration from seconds to MM:SS\n  Handlebars.registerHelper('formatDuration', (seconds: number): string => {\n    if (!seconds || seconds <= 0) return '--:--';\n\n    const minutes = Math.floor(seconds / 60);\n    const secs = Math.floor(seconds % 60);\n    return `${minutes}:${secs.toString().padStart(2, '0')}`;\n  });\n\n  // Check equality (for {{#if (eq a b)}})\n  Handlebars.registerHelper('eq', (a: any, b: any): boolean => {\n    return a === b;\n  });\n\n  // OR helper for conditional logic\n  Handlebars.registerHelper('or', (...args: any[]): boolean => {\n    // Last argument is Handlebars options object, exclude it\n    const values = args.slice(0, -1);\n    return values.some((val) => !!val);\n  });\n}\n\n// ─────────────────────────────────────────────────────────────\n// Init Hooks\n// ─────────────────────────────────────────────────────────────\n\nHooks.once('init', async () => {\n  Logger.info('Initializing Advanced Sound Engine...');\n  registerSettings();\n  registerHandlebarsHelpers();\n\n  // Preload templates\n  await loadTemplates([\n    `modules/${MODULE_ID}/templates/partials/effect-card.hbs`\n  ]);\n});\n\nHooks.once('ready', async () => {\n  const isGM = game.user?.isGM ?? false;\n  Logger.info(`Starting Advanced Sound Engine (${isGM ? 'GM' : 'Player'})...`);\n\n  // Initialize queue manager FIRST (needed by PlaybackScheduler)\n  queueManager = new PlaybackQueueManager();\n  await queueManager.load(); // Load saved queue state\n\n  socketManager = new SocketManager();\n\n  if (isGM) {\n    await initializeGM();\n  } else {\n    await initializePlayer();\n  }\n\n  window.ASE = {\n    isGM,\n    openPanel: isGM ? openMainApp : openVolumePanel,\n    openLibrary: () => isGM && openMainApp('library'),\n    engine: isGM ? gmEngine ?? undefined : playerEngine ?? undefined,\n    socket: socketManager ?? undefined,\n    library: isGM ? libraryManager ?? undefined : undefined,\n    queue: queueManager\n  };\n\n  setupAutoplayHandler();\n\n  Logger.info('Advanced Sound Engine ready');\n});\n\nasync function initializeGM(): Promise<void> {\n  libraryManager = new LibraryManager();\n  gmEngine = new AudioEngine();\n  socketManager!.initializeAsGM(gmEngine);\n\n  await gmEngine.loadSavedState();\n\n  // Initialize Scheduler\n  playbackScheduler = new PlaybackScheduler(gmEngine, libraryManager, queueManager!);\n\n  // Wire up references for atomic stopAll()\n  gmEngine.setScheduler(playbackScheduler);\n  gmEngine.setSocketManager(socketManager!);\n\n  Logger.info('PlaybackScheduler initialized');\n}\n\nasync function initializePlayer(): Promise<void> {\n  playerEngine = new PlayerAudioEngine(socketManager!);\n  socketManager!.initializeAsPlayer(playerEngine);\n\n  // Restore saved local volume\n  const savedVolume = PlayerVolumePanel.loadSavedVolume();\n  playerEngine!.setLocalVolume(savedVolume);\n}\n\n// ─────────────────────────────────────────────────────────────\n// Panels\n// ─────────────────────────────────────────────────────────────\n// Open main app with specific tab\nfunction openMainApp(tab?: string, forceRender: boolean = false): void {\n  if (!gmEngine || !socketManager || !libraryManager) return;\n\n  if (mainApp && mainApp.rendered) {\n    if (tab && mainApp.state.activeTab !== tab) {\n      mainApp.state.activeTab = tab as any;\n      forceRender = true;\n    }\n\n    if (forceRender) {\n      mainApp.render(false); // Re-render content, keep window position\n    } else {\n      mainApp.bringToTop();\n    }\n  } else {\n    mainApp = new AdvancedSoundEngineApp(gmEngine, socketManager, libraryManager, queueManager!);\n    if (tab) mainApp.state.activeTab = tab as any;\n    mainApp.render(true);\n  }\n}\n\nfunction openVolumePanel(): void {\n  if (!playerEngine) return;\n\n  if (volumePanel && volumePanel.rendered) {\n    volumePanel.bringToTop();\n  } else {\n    volumePanel = new PlayerVolumePanel(playerEngine);\n    volumePanel.render(true);\n  }\n}\n\n// Old openLibrary removed/redirected\nfunction openLibrary(): void {\n  openMainApp('library');\n}\n\n\n\n// ─────────────────────────────────────────────────────────────\n// Autoplay Policy Handler\n// ─────────────────────────────────────────────────────────────\n\nfunction setupAutoplayHandler(): void {\n  const resumeAudio = () => {\n    gmEngine?.resume();\n    playerEngine?.resume();\n  };\n\n  document.addEventListener('click', resumeAudio, { once: true });\n  document.addEventListener('keydown', resumeAudio, { once: true });\n\n  Hooks.once('canvasReady', resumeAudio);\n}\n\n// ─────────────────────────────────────────────────────────────\n// Settings\n// ─────────────────────────────────────────────────────────────\n\nfunction registerSettings(): void {\n  (game.settings as any).register(MODULE_ID, 'mixerState', {\n    name: 'Mixer State',\n    hint: 'Internal storage for mixer state',\n    scope: 'world',\n    config: false,\n    type: String,\n    default: ''\n  });\n\n  (game.settings as any).register(MODULE_ID, 'maxSimultaneousTracks', {\n    name: 'Maximum Simultaneous Tracks',\n    hint: 'Limit the number of tracks that can play at once (1-32)',\n    scope: 'world',\n    config: true,\n    type: Number,\n    range: { min: 1, max: 32, step: 1 },\n    default: 8\n  });\n\n  // Legacy library state fallback (world-scoped, for migration only)\n  (game.settings as any).register(MODULE_ID, 'libraryState', {\n    name: 'Library State',\n    hint: 'Internal storage for library items and playlists',\n    scope: 'world',\n    config: false,\n    type: String,\n    default: ''\n  });\n\n  // Queue state (world-scoped, session persistence  \n  (game.settings as any).register(MODULE_ID, 'queueState', {\n    name: 'Queue State',\n    hint: 'Playback queue state (persists between sessions)',\n    scope: 'world',\n    config: false,\n    type: Object,\n    default: { items: [], activeItemId: null }\n  });\n}\n\n// ─────────────────────────────────────────────────────────────\n// Cleanup\n// ─────────────────────────────────────────────────────────────\n\nHooks.once('closeGame', () => {\n  mainApp?.close();\n  volumePanel?.close();\n  playbackScheduler?.dispose();\n  socketManager?.dispose();\n  gmEngine?.dispose();\n  playerEngine?.dispose();\n  queueManager?.dispose();\n  libraryManager?.dispose();\n});"],"names":["generateUUID","MODULE_ID","socketManager","_a","libraryManager","queueManager","item"],"mappings":"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"}