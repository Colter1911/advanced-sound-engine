{"version":3,"file":"module.js","sources":["../src/utils/logger.ts","../src/core/StreamingPlayer.ts","../src/utils/time.ts","../src/core/AudioEngine.ts","../src/core/PlayerAudioEngine.ts","../src/sync/SocketManager.ts","../src/utils/throttle.ts","../src/ui/SoundMixerApp.ts","../src/ui/PlayerVolumePanel.ts","../src/module.ts"],"sourcesContent":["const PREFIX = 'ASE';\r\n\r\nexport const Logger = {\r\n  info: (message: string, ...args: unknown[]) => {\r\n    console.log(`${PREFIX} | ${message}`, ...args);\r\n  },\r\n  \r\n  warn: (message: string, ...args: unknown[]) => {\r\n    console.warn(`${PREFIX} | ${message}`, ...args);\r\n  },\r\n  \r\n  error: (message: string, ...args: unknown[]) => {\r\n    console.error(`${PREFIX} | ${message}`, ...args);\r\n  },\r\n  \r\n  debug: (message: string, ...args: unknown[]) => {\r\n    if (CONFIG?.debug?.audio) {\r\n      console.debug(`${PREFIX} | ${message}`, ...args);\r\n    }\r\n  }\r\n};","import type { TrackGroup, PlaybackState } from '@t/audio';\r\nimport { Logger } from '@utils/logger';\r\n\r\nexport class StreamingPlayer {\r\n  readonly id: string;\r\n  private ctx: AudioContext;\r\n  private _group: TrackGroup;\r\n  private _url: string = '';\r\n  \r\n  private audio: HTMLAudioElement;\r\n  private sourceNode: MediaElementAudioSourceNode | null = null;\r\n  private gainNode: GainNode;\r\n  private outputNode: GainNode;\r\n  \r\n  private _state: PlaybackState = 'stopped';\r\n  private _volume: number = 1;\r\n  private _loop: boolean = false;\r\n  private _ready: boolean = false;\r\n\r\n  constructor(\r\n    id: string,\r\n    ctx: AudioContext,\r\n    channelOutput: GainNode,\r\n    group: TrackGroup = 'music'\r\n  ) {\r\n    this.id = id;\r\n    this.ctx = ctx;\r\n    this._group = group;\r\n    \r\n    this.audio = new Audio();\r\n    this.audio.crossOrigin = 'anonymous';\r\n    this.audio.preload = 'auto';\r\n    \r\n    this.gainNode = ctx.createGain();\r\n    this.outputNode = ctx.createGain();\r\n    \r\n    this.gainNode.connect(this.outputNode);\r\n    this.outputNode.connect(channelOutput);\r\n    \r\n    this.setupAudioEvents();\r\n  }\r\n\r\n  private setupAudioEvents(): void {\r\n    this.audio.addEventListener('canplay', () => {\r\n      this._ready = true;\r\n      if (this._state === 'loading') {\r\n        this._state = 'stopped';\r\n      }\r\n      Logger.debug(`Track ${this.id} ready to play`);\r\n    });\r\n\r\n    this.audio.addEventListener('ended', () => {\r\n      if (!this._loop) {\r\n        this._state = 'stopped';\r\n        Logger.debug(`Track ${this.id} ended`);\r\n      }\r\n    });\r\n\r\n    this.audio.addEventListener('error', (e) => {\r\n      Logger.error(`Track ${this.id} error:`, this.audio.error);\r\n      this._state = 'stopped';\r\n    });\r\n  }\r\n\r\n  get state(): PlaybackState {\r\n    return this._state;\r\n  }\r\n\r\n  get group(): TrackGroup {\r\n    return this._group;\r\n  }\r\n\r\n  get url(): string {\r\n    return this._url;\r\n  }\r\n\r\n  get volume(): number {\r\n    return this._volume;\r\n  }\r\n\r\n  get loop(): boolean {\r\n    return this._loop;\r\n  }\r\n\r\n  get ready(): boolean {\r\n    return this._ready;\r\n  }\r\n\r\n  async load(url: string): Promise<void> {\r\n    this._state = 'loading';\r\n    this._url = url;\r\n    this._ready = false;\r\n\r\n    return new Promise((resolve, reject) => {\r\n      const onCanPlay = () => {\r\n        this.audio.removeEventListener('canplay', onCanPlay);\r\n        this.audio.removeEventListener('error', onError);\r\n        \r\n        // Connect to Web Audio\r\n        if (!this.sourceNode) {\r\n          this.sourceNode = this.ctx.createMediaElementSource(this.audio);\r\n          this.sourceNode.connect(this.gainNode);\r\n        }\r\n        \r\n        this._ready = true;\r\n        this._state = 'stopped';\r\n        Logger.debug(`Track loaded: ${this.id}`);\r\n        resolve();\r\n      };\r\n\r\n      const onError = () => {\r\n        this.audio.removeEventListener('canplay', onCanPlay);\r\n        this.audio.removeEventListener('error', onError);\r\n        this._state = 'stopped';\r\n        reject(new Error(`Failed to load: ${url}`));\r\n      };\r\n\r\n      this.audio.addEventListener('canplay', onCanPlay, { once: true });\r\n      this.audio.addEventListener('error', onError, { once: true });\r\n      \r\n      this.audio.src = url;\r\n      this.audio.load();\r\n    });\r\n  }\r\n\r\n  async play(offset: number = 0): Promise<void> {\r\n    if (!this._ready) {\r\n      Logger.warn(`Track ${this.id} not ready`);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      this.audio.currentTime = Math.max(0, Math.min(offset, this.audio.duration || 0));\r\n      this.audio.loop = this._loop;\r\n      await this.audio.play();\r\n      this._state = 'playing';\r\n      Logger.debug(`Track ${this.id} playing from ${offset.toFixed(2)}s`);\r\n    } catch (error) {\r\n      Logger.error(`Failed to play ${this.id}:`, error);\r\n    }\r\n  }\r\n\r\n  pause(): void {\r\n    if (this._state !== 'playing') return;\r\n    \r\n    this.audio.pause();\r\n    this._state = 'paused';\r\n    Logger.debug(`Track ${this.id} paused at ${this.audio.currentTime.toFixed(2)}s`);\r\n  }\r\n\r\n  stop(): void {\r\n    this.audio.pause();\r\n    this.audio.currentTime = 0;\r\n    this._state = 'stopped';\r\n    Logger.debug(`Track ${this.id} stopped`);\r\n  }\r\n\r\n  seek(time: number): void {\r\n    const safeTime = Math.max(0, Math.min(time, this.audio.duration || 0));\r\n    this.audio.currentTime = safeTime;\r\n  }\r\n\r\n  setVolume(value: number): void {\r\n    this._volume = Math.max(0, Math.min(1, value));\r\n    this.gainNode.gain.setValueAtTime(this._volume, this.ctx.currentTime);\r\n  }\r\n\r\n  setLoop(value: boolean): void {\r\n    this._loop = value;\r\n    this.audio.loop = value;\r\n  }\r\n\r\n  setChannel(newGroup: TrackGroup, newOutput: GainNode): void {\r\n    this._group = newGroup;\r\n    this.outputNode.disconnect();\r\n    this.outputNode.connect(newOutput);\r\n  }\r\n\r\n  getCurrentTime(): number {\r\n    return this.audio.currentTime;\r\n  }\r\n\r\n  getDuration(): number {\r\n    return this.audio.duration || 0;\r\n  }\r\n\r\n  getState() {\r\n    return {\r\n      id: this.id,\r\n      url: this._url,\r\n      group: this._group,\r\n      playbackState: this._state,\r\n      volume: this._volume,\r\n      loop: this._loop,\r\n      currentTime: this.getCurrentTime(),\r\n      duration: this.getDuration()\r\n    };\r\n  }\r\n\r\n  dispose(): void {\r\n    this.audio.pause();\r\n    this.audio.src = '';\r\n    this.sourceNode?.disconnect();\r\n    this.gainNode.disconnect();\r\n    this.outputNode.disconnect();\r\n    Logger.debug(`Track ${this.id} disposed`);\r\n  }\r\n}","/**\r\n * Get current server time (for sync calculations)\r\n */\r\nexport function getServerTime(): number {\r\n  // Foundry's game.time.serverTime учитывает offset\r\n  return Date.now();\r\n}\r\n\r\n/**\r\n * Calculate playback offset based on start time\r\n */\r\nexport function calculateOffset(startedAt: number, pausedAt: number = 0): number {\r\n  if (pausedAt > 0) {\r\n    return pausedAt;\r\n  }\r\n  return (getServerTime() - startedAt) / 1000;\r\n}\r\n\r\n/**\r\n * Format seconds to mm:ss\r\n */\r\nexport function formatTime(seconds: number): string {\r\n  if (!isFinite(seconds) || seconds < 0) return '0:00';\r\n  \r\n  const mins = Math.floor(seconds / 60);\r\n  const secs = Math.floor(seconds % 60);\r\n  return `${mins}:${secs.toString().padStart(2, '0')}`;\r\n}","import type { TrackConfig, TrackState, MixerState, TrackGroup, ChannelVolumes } from '@t/audio';\r\nimport { StreamingPlayer } from './StreamingPlayer';\r\nimport { Logger } from '@utils/logger';\r\nimport { getServerTime } from '@utils/time';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\nconst MAX_SIMULTANEOUS = 8;\r\n\r\nexport class AudioEngine {\r\n  private ctx: AudioContext;\r\n  private masterGain: GainNode;\r\n  private channelGains: Record<TrackGroup, GainNode>;\r\n  private players: Map<string, StreamingPlayer> = new Map();\r\n  \r\n  private _volumes: ChannelVolumes = {\r\n    master: 1,\r\n    music: 1,\r\n    ambience: 1,\r\n    sfx: 1\r\n  };\r\n  \r\n  private saveTimeout: ReturnType<typeof setTimeout> | null = null;\r\n\r\n  constructor() {\r\n    this.ctx = new AudioContext();\r\n    \r\n    this.masterGain = this.ctx.createGain();\r\n    this.masterGain.connect(this.ctx.destination);\r\n    \r\n    this.channelGains = {\r\n      music: this.ctx.createGain(),\r\n      ambience: this.ctx.createGain(),\r\n      sfx: this.ctx.createGain()\r\n    };\r\n    \r\n    this.channelGains.music.connect(this.masterGain);\r\n    this.channelGains.ambience.connect(this.masterGain);\r\n    this.channelGains.sfx.connect(this.masterGain);\r\n    \r\n    Logger.info('AudioEngine initialized');\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Persistence (GM only)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private scheduleSave(): void {\r\n    if (!game.user?.isGM) return;\r\n    \r\n    if (this.saveTimeout) {\r\n      clearTimeout(this.saveTimeout);\r\n    }\r\n    this.saveTimeout = setTimeout(() => {\r\n      this.saveState();\r\n    }, 500);\r\n  }\r\n\r\n  private async saveState(): Promise<void> {\r\n    if (!game.ready || !game.user?.isGM) return;\r\n    \r\n    const state = this.getState();\r\n    \r\n    try {\r\n      await game.settings.set(MODULE_ID, 'mixerState', JSON.stringify(state));\r\n      Logger.debug('Mixer state saved');\r\n    } catch (error) {\r\n      Logger.error('Failed to save mixer state:', error);\r\n    }\r\n  }\r\n\r\n  async loadSavedState(): Promise<void> {\r\n    if (!game.ready) return;\r\n    \r\n    try {\r\n      const savedJson = game.settings.get(MODULE_ID, 'mixerState') as string;\r\n      if (!savedJson) return;\r\n      \r\n      const state = JSON.parse(savedJson) as MixerState;\r\n      await this.restoreState(state);\r\n      \r\n      Logger.info('Mixer state restored');\r\n    } catch (error) {\r\n      Logger.error('Failed to load mixer state:', error);\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Track Management\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  async createTrack(config: TrackConfig): Promise<StreamingPlayer> {\r\n    if (this.players.has(config.id)) {\r\n      return this.players.get(config.id)!;\r\n    }\r\n\r\n    const channelOutput = this.channelGains[config.group];\r\n    \r\n    const player = new StreamingPlayer(\r\n      config.id,\r\n      this.ctx,\r\n      channelOutput,\r\n      config.group\r\n    );\r\n\r\n    if (config.volume !== undefined) {\r\n      player.setVolume(config.volume);\r\n    }\r\n    if (config.loop !== undefined) {\r\n      player.setLoop(config.loop);\r\n    }\r\n\r\n    await player.load(config.url);\r\n\r\n    this.players.set(config.id, player);\r\n    this.scheduleSave();\r\n    \r\n    Logger.info(`Track created: ${config.id}`);\r\n    return player;\r\n  }\r\n\r\n  getTrack(id: string): StreamingPlayer | undefined {\r\n    return this.players.get(id);\r\n  }\r\n\r\n  removeTrack(id: string): boolean {\r\n    const player = this.players.get(id);\r\n    if (!player) return false;\r\n\r\n    player.dispose();\r\n    this.players.delete(id);\r\n    this.scheduleSave();\r\n    \r\n    Logger.info(`Track removed: ${id}`);\r\n    return true;\r\n  }\r\n\r\n  getAllTracks(): StreamingPlayer[] {\r\n    return Array.from(this.players.values());\r\n  }\r\n\r\n  getTracksByGroup(group: TrackGroup): StreamingPlayer[] {\r\n    return this.getAllTracks().filter(t => t.group === group);\r\n  }\r\n\r\n  setTrackChannel(id: string, newGroup: TrackGroup): void {\r\n    const player = this.players.get(id);\r\n    if (!player) return;\r\n    \r\n    player.setChannel(newGroup, this.channelGains[newGroup]);\r\n    this.scheduleSave();\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Playback Control\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  async playTrack(id: string, offset: number = 0): Promise<void> {\r\n    const player = this.players.get(id);\r\n    if (!player) {\r\n      Logger.warn(`Track not found: ${id}`);\r\n      return;\r\n    }\r\n    \r\n    const playingCount = this.getAllTracks().filter(t => t.state === 'playing').length;\r\n    const isCurrentlyPlaying = player.state === 'playing';\r\n    \r\n    if (!isCurrentlyPlaying && playingCount >= MAX_SIMULTANEOUS) {\r\n      Logger.warn(`Maximum simultaneous tracks (${MAX_SIMULTANEOUS}) reached`);\r\n      ui.notifications?.warn(`Cannot play more than ${MAX_SIMULTANEOUS} tracks simultaneously`);\r\n      return;\r\n    }\r\n    \r\n    await player.play(offset);\r\n  }\r\n\r\n  pauseTrack(id: string): void {\r\n    this.players.get(id)?.pause();\r\n  }\r\n\r\n  stopTrack(id: string): void {\r\n    this.players.get(id)?.stop();\r\n  }\r\n\r\n  seekTrack(id: string, time: number): void {\r\n    this.players.get(id)?.seek(time);\r\n  }\r\n\r\n  setTrackVolume(id: string, volume: number): void {\r\n    this.players.get(id)?.setVolume(volume);\r\n    this.scheduleSave();\r\n  }\r\n\r\n  setTrackLoop(id: string, loop: boolean): void {\r\n    this.players.get(id)?.setLoop(loop);\r\n    this.scheduleSave();\r\n  }\r\n\r\n  stopAll(): void {\r\n    for (const player of this.players.values()) {\r\n      player.stop();\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Volume Control\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  get volumes(): ChannelVolumes {\r\n    return { ...this._volumes };\r\n  }\r\n\r\n  setMasterVolume(value: number): void {\r\n    this._volumes.master = Math.max(0, Math.min(1, value));\r\n    this.masterGain.gain.linearRampToValueAtTime(\r\n      this._volumes.master,\r\n      this.ctx.currentTime + 0.01\r\n    );\r\n    this.scheduleSave();\r\n  }\r\n\r\n  setChannelVolume(channel: TrackGroup, value: number): void {\r\n    this._volumes[channel] = Math.max(0, Math.min(1, value));\r\n    this.channelGains[channel].gain.linearRampToValueAtTime(\r\n      this._volumes[channel],\r\n      this.ctx.currentTime + 0.01\r\n    );\r\n    this.scheduleSave();\r\n  }\r\n\r\n  getChannelVolume(channel: TrackGroup): number {\r\n    return this._volumes[channel];\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // State\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  getState(): MixerState {\r\n    const tracks: TrackState[] = [];\r\n    \r\n    for (const player of this.players.values()) {\r\n      tracks.push(player.getState());\r\n    }\r\n\r\n    return {\r\n      masterVolume: this._volumes.master,\r\n      channelVolumes: { ...this._volumes },\r\n      tracks,\r\n      timestamp: getServerTime(),\r\n      syncEnabled: false\r\n    };\r\n  }\r\n\r\n  async restoreState(state: MixerState): Promise<void> {\r\n    // Restore volumes\r\n    this._volumes.master = state.masterVolume;\r\n    this.masterGain.gain.setValueAtTime(this._volumes.master, this.ctx.currentTime);\r\n    \r\n    if (state.channelVolumes) {\r\n      for (const channel of ['music', 'ambience', 'sfx'] as TrackGroup[]) {\r\n        this._volumes[channel] = state.channelVolumes[channel];\r\n        this.channelGains[channel].gain.setValueAtTime(this._volumes[channel], this.ctx.currentTime);\r\n      }\r\n    }\r\n\r\n    // Restore tracks (without playing)\r\n    for (const trackState of state.tracks) {\r\n      if (!this.players.has(trackState.id)) {\r\n        try {\r\n          await this.createTrack({\r\n            id: trackState.id,\r\n            url: trackState.url,\r\n            group: trackState.group,\r\n            volume: trackState.volume,\r\n            loop: trackState.loop\r\n          });\r\n        } catch (error) {\r\n          Logger.error(`Failed to restore track ${trackState.id}:`, error);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Remove tracks not in state\r\n    const stateTrackIds = new Set(state.tracks.map(t => t.id));\r\n    for (const [id] of this.players) {\r\n      if (!stateTrackIds.has(id)) {\r\n        this.removeTrack(id);\r\n      }\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Audio Context\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  async resume(): Promise<void> {\r\n    if (this.ctx.state === 'suspended') {\r\n      await this.ctx.resume();\r\n      Logger.info('AudioContext resumed');\r\n    }\r\n  }\r\n\r\n  get contextState(): AudioContextState {\r\n    return this.ctx.state;\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Cleanup\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  dispose(): void {\r\n    if (this.saveTimeout) {\r\n      clearTimeout(this.saveTimeout);\r\n    }\r\n    for (const player of this.players.values()) {\r\n      player.dispose();\r\n    }\r\n    this.players.clear();\r\n    this.ctx.close();\r\n    Logger.info('AudioEngine disposed');\r\n  }\r\n}","import type { TrackGroup, ChannelVolumes, SyncTrackState, TrackPlayPayload } from '@t/audio';\r\nimport { StreamingPlayer } from './StreamingPlayer';\r\nimport { Logger } from '@utils/logger';\r\nimport { getServerTime } from '@utils/time';\r\n\r\n/**\r\n * Упрощенный движок для игроков — только получает команды\r\n */\r\nexport class PlayerAudioEngine {\r\n  private ctx: AudioContext;\r\n  private masterGain: GainNode;\r\n  private gmGain: GainNode; // Громкость от GM\r\n  private channelGains: Record<TrackGroup, GainNode>;\r\n  private players: Map<string, StreamingPlayer> = new Map();\r\n  \r\n  private _localVolume: number = 1; // Личная громкость игрока\r\n  private _gmVolumes: ChannelVolumes = {\r\n    master: 1,\r\n    music: 1,\r\n    ambience: 1,\r\n    sfx: 1\r\n  };\r\n\r\n  constructor() {\r\n    this.ctx = new AudioContext();\r\n    \r\n    // Chain: tracks -> channels -> gmGain -> masterGain -> destination\r\n    this.masterGain = this.ctx.createGain();\r\n    this.masterGain.connect(this.ctx.destination);\r\n    \r\n    this.gmGain = this.ctx.createGain();\r\n    this.gmGain.connect(this.masterGain);\r\n    \r\n    this.channelGains = {\r\n      music: this.ctx.createGain(),\r\n      ambience: this.ctx.createGain(),\r\n      sfx: this.ctx.createGain()\r\n    };\r\n    \r\n    this.channelGains.music.connect(this.gmGain);\r\n    this.channelGains.ambience.connect(this.gmGain);\r\n    this.channelGains.sfx.connect(this.gmGain);\r\n    \r\n    Logger.info('PlayerAudioEngine initialized');\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Local Volume (Player's personal control)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  get localVolume(): number {\r\n    return this._localVolume;\r\n  }\r\n\r\n  setLocalVolume(value: number): void {\r\n    this._localVolume = Math.max(0, Math.min(1, value));\r\n    this.masterGain.gain.linearRampToValueAtTime(\r\n      this._localVolume,\r\n      this.ctx.currentTime + 0.01\r\n    );\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // GM Volume (from sync)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  setGMVolume(channel: TrackGroup | 'master', value: number): void {\r\n    const safeValue = Math.max(0, Math.min(1, value));\r\n    \r\n    if (channel === 'master') {\r\n      this._gmVolumes.master = safeValue;\r\n      this.gmGain.gain.linearRampToValueAtTime(safeValue, this.ctx.currentTime + 0.01);\r\n    } else {\r\n      this._gmVolumes[channel] = safeValue;\r\n      this.channelGains[channel].gain.linearRampToValueAtTime(safeValue, this.ctx.currentTime + 0.01);\r\n    }\r\n  }\r\n\r\n  setAllGMVolumes(volumes: ChannelVolumes): void {\r\n    this._gmVolumes = { ...volumes };\r\n    \r\n    this.gmGain.gain.setValueAtTime(volumes.master, this.ctx.currentTime);\r\n    this.channelGains.music.gain.setValueAtTime(volumes.music, this.ctx.currentTime);\r\n    this.channelGains.ambience.gain.setValueAtTime(volumes.ambience, this.ctx.currentTime);\r\n    this.channelGains.sfx.gain.setValueAtTime(volumes.sfx, this.ctx.currentTime);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Track Commands (from GM via socket)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  async handlePlay(payload: TrackPlayPayload): Promise<void> {\r\n    let player = this.players.get(payload.trackId);\r\n    \r\n    // Create if doesn't exist\r\n    if (!player) {\r\n      player = new StreamingPlayer(\r\n        payload.trackId,\r\n        this.ctx,\r\n        this.channelGains[payload.group],\r\n        payload.group\r\n      );\r\n      \r\n      await player.load(payload.url);\r\n      this.players.set(payload.trackId, player);\r\n    }\r\n    \r\n    player.setVolume(payload.volume);\r\n    player.setLoop(payload.loop);\r\n    \r\n    // Calculate offset based on time elapsed since GM started\r\n    const elapsed = (getServerTime() - payload.startTimestamp) / 1000;\r\n    const adjustedOffset = Math.max(0, payload.offset + elapsed);\r\n    \r\n    await player.play(adjustedOffset);\r\n    Logger.debug(`Player: track ${payload.trackId} playing at ${adjustedOffset.toFixed(2)}s`);\r\n  }\r\n\r\n  handlePause(trackId: string): void {\r\n    this.players.get(trackId)?.pause();\r\n  }\r\n\r\n  handleStop(trackId: string): void {\r\n    this.players.get(trackId)?.stop();\r\n  }\r\n\r\n  handleSeek(trackId: string, time: number, isPlaying: boolean, seekTimestamp: number): void {\r\n    const player = this.players.get(trackId);\r\n    if (!player) return;\r\n    \r\n    if (isPlaying) {\r\n      const elapsed = (getServerTime() - seekTimestamp) / 1000;\r\n      player.seek(time + elapsed);\r\n    } else {\r\n      player.seek(time);\r\n    }\r\n  }\r\n\r\n  handleTrackVolume(trackId: string, volume: number): void {\r\n    this.players.get(trackId)?.setVolume(volume);\r\n  }\r\n\r\n  handleTrackLoop(trackId: string, loop: boolean): void {\r\n    this.players.get(trackId)?.setLoop(loop);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Sync State (full state from GM)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  async syncState(tracks: SyncTrackState[], volumes: ChannelVolumes): Promise<void> {\r\n    // Set volumes\r\n    this.setAllGMVolumes(volumes);\r\n    \r\n    // Handle tracks\r\n    const newTrackIds = new Set(tracks.map(t => t.id));\r\n    \r\n    // Remove tracks not in sync\r\n    for (const [id, player] of this.players) {\r\n      if (!newTrackIds.has(id)) {\r\n        player.dispose();\r\n        this.players.delete(id);\r\n      }\r\n    }\r\n    \r\n    // Add/update tracks\r\n    for (const trackState of tracks) {\r\n      let player = this.players.get(trackState.id);\r\n      \r\n      if (!player) {\r\n        player = new StreamingPlayer(\r\n          trackState.id,\r\n          this.ctx,\r\n          this.channelGains[trackState.group],\r\n          trackState.group\r\n        );\r\n        \r\n        await player.load(trackState.url);\r\n        this.players.set(trackState.id, player);\r\n      }\r\n      \r\n      player.setVolume(trackState.volume);\r\n      player.setLoop(trackState.loop);\r\n      \r\n      if (trackState.isPlaying) {\r\n        const elapsed = (getServerTime() - trackState.startTimestamp) / 1000;\r\n        const adjustedTime = trackState.currentTime + elapsed;\r\n        await player.play(adjustedTime);\r\n      } else {\r\n        player.stop();\r\n      }\r\n    }\r\n    \r\n    Logger.info('Player: synced state from GM');\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Sync Off\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  stopAll(): void {\r\n    for (const player of this.players.values()) {\r\n      player.stop();\r\n    }\r\n  }\r\n\r\n  clearAll(): void {\r\n    for (const player of this.players.values()) {\r\n      player.dispose();\r\n    }\r\n    this.players.clear();\r\n    Logger.info('Player: all tracks cleared');\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Audio Context\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  async resume(): Promise<void> {\r\n    if (this.ctx.state === 'suspended') {\r\n      await this.ctx.resume();\r\n      Logger.info('PlayerAudioEngine: AudioContext resumed');\r\n    }\r\n  }\r\n\r\n  dispose(): void {\r\n    this.clearAll();\r\n    this.ctx.close();\r\n    Logger.info('PlayerAudioEngine disposed');\r\n  }\r\n}","import type { \r\n  SocketMessage, \r\n  SocketMessageType,\r\n  SyncStatePayload,\r\n  SyncTrackState,\r\n  TrackPlayPayload,\r\n  TrackPausePayload,\r\n  TrackStopPayload,\r\n  TrackSeekPayload,\r\n  TrackVolumePayload,\r\n  TrackLoopPayload,\r\n  ChannelVolumePayload,\r\n  TrackGroup,\r\n  ChannelVolumes\r\n} from '@t/audio';\r\nimport { AudioEngine } from '@core/AudioEngine';\r\nimport { PlayerAudioEngine } from '@core/PlayerAudioEngine';\r\nimport { Logger } from '@utils/logger';\r\nimport { getServerTime } from '@utils/time';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\nconst SOCKET_NAME = `module.${MODULE_ID}`;\r\n\r\nexport class SocketManager {\r\n  private gmEngine: AudioEngine | null = null;\r\n  private playerEngine: PlayerAudioEngine | null = null;\r\n  private socket: any = null;\r\n  private _syncEnabled: boolean = false;\r\n  private isGM: boolean = false;\r\n\r\n  constructor() {}\r\n\r\n  initializeAsGM(engine: AudioEngine): void {\r\n    this.isGM = true;\r\n    this.gmEngine = engine;\r\n    this.socket = game.socket;\r\n    \r\n    this.socket?.on(SOCKET_NAME, (message: SocketMessage) => {\r\n      this.handleGMMessage(message);\r\n    });\r\n    \r\n    Logger.info('SocketManager initialized as GM');\r\n  }\r\n\r\n  initializeAsPlayer(engine: PlayerAudioEngine): void {\r\n    this.isGM = false;\r\n    this.playerEngine = engine;\r\n    this.socket = game.socket;\r\n    \r\n    this.socket?.on(SOCKET_NAME, (message: SocketMessage) => {\r\n      this.handlePlayerMessage(message);\r\n    });\r\n    \r\n    // Request current state on join\r\n    setTimeout(() => {\r\n      this.send('player-ready', {});\r\n    }, 1000);\r\n    \r\n    Logger.info('SocketManager initialized as Player');\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Sync Mode (GM)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  get syncEnabled(): boolean {\r\n    return this._syncEnabled;\r\n  }\r\n\r\n  setSyncEnabled(enabled: boolean): void {\r\n    if (!this.isGM) return;\r\n    \r\n    this._syncEnabled = enabled;\r\n    \r\n    if (enabled) {\r\n      this.broadcastSyncStart();\r\n    } else {\r\n      this.broadcastSyncStop();\r\n    }\r\n    \r\n    Logger.info(`Sync mode: ${enabled ? 'ON' : 'OFF'}`);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // GM Message Handling\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private handleGMMessage(message: SocketMessage): void {\r\n    if (message.senderId === game.user?.id) return;\r\n    \r\n    if (message.type === 'player-ready' && this._syncEnabled) {\r\n      // Send current state to newly joined player\r\n      this.sendStateTo(message.senderId);\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Player Message Handling\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async handlePlayerMessage(message: SocketMessage): Promise<void> {\r\n    if (message.senderId === game.user?.id) return;\r\n    if (!this.playerEngine) return;\r\n    \r\n    Logger.debug(`Player received: ${message.type}`, message.payload);\r\n    \r\n    switch (message.type) {\r\n      case 'sync-start':\r\n        const startPayload = message.payload as SyncStatePayload;\r\n        await this.playerEngine.syncState(startPayload.tracks, startPayload.channelVolumes);\r\n        break;\r\n        \r\n      case 'sync-stop':\r\n        this.playerEngine.clearAll();\r\n        break;\r\n        \r\n      case 'sync-state':\r\n        const statePayload = message.payload as SyncStatePayload;\r\n        await this.playerEngine.syncState(statePayload.tracks, statePayload.channelVolumes);\r\n        break;\r\n        \r\n      case 'track-play':\r\n        const playPayload = message.payload as TrackPlayPayload;\r\n        await this.playerEngine.handlePlay(playPayload);\r\n        break;\r\n        \r\n      case 'track-pause':\r\n        const pausePayload = message.payload as TrackPausePayload;\r\n        this.playerEngine.handlePause(pausePayload.trackId);\r\n        break;\r\n        \r\n      case 'track-stop':\r\n        const stopPayload = message.payload as TrackStopPayload;\r\n        this.playerEngine.handleStop(stopPayload.trackId);\r\n        break;\r\n        \r\n      case 'track-seek':\r\n        const seekPayload = message.payload as TrackSeekPayload;\r\n        this.playerEngine.handleSeek(\r\n          seekPayload.trackId, \r\n          seekPayload.time, \r\n          seekPayload.isPlaying,\r\n          seekPayload.seekTimestamp\r\n        );\r\n        break;\r\n        \r\n      case 'track-volume':\r\n        const volPayload = message.payload as TrackVolumePayload;\r\n        this.playerEngine.handleTrackVolume(volPayload.trackId, volPayload.volume);\r\n        break;\r\n        \r\n      case 'track-loop':\r\n        const loopPayload = message.payload as TrackLoopPayload;\r\n        this.playerEngine.handleTrackLoop(loopPayload.trackId, loopPayload.loop);\r\n        break;\r\n        \r\n      case 'channel-volume':\r\n        const chVolPayload = message.payload as ChannelVolumePayload;\r\n        this.playerEngine.setGMVolume(chVolPayload.channel, chVolPayload.volume);\r\n        break;\r\n        \r\n      case 'stop-all':\r\n        this.playerEngine.stopAll();\r\n        break;\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // GM Broadcast Methods\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private send(type: SocketMessageType, payload: unknown, targetUserId?: string): void {\r\n    if (!this.socket) return;\r\n\r\n    const message: SocketMessage = {\r\n      type,\r\n      payload,\r\n      senderId: game.user?.id ?? '',\r\n      timestamp: getServerTime()\r\n    };\r\n\r\n    if (targetUserId) {\r\n      this.socket.emit(SOCKET_NAME, message, { recipients: [targetUserId] });\r\n    } else {\r\n      this.socket.emit(SOCKET_NAME, message);\r\n    }\r\n\r\n    Logger.debug(`Sent: ${type}`, payload);\r\n  }\r\n\r\n  private getCurrentSyncState(): SyncStatePayload {\r\n    if (!this.gmEngine) {\r\n      return { tracks: [], channelVolumes: { master: 1, music: 1, ambience: 1, sfx: 1 } };\r\n    }\r\n    \r\n    const now = getServerTime();\r\n    const tracks: SyncTrackState[] = [];\r\n    \r\n    for (const player of this.gmEngine.getAllTracks()) {\r\n      const state = player.getState();\r\n      tracks.push({\r\n        id: state.id,\r\n        url: state.url,\r\n        group: state.group,\r\n        volume: state.volume,\r\n        loop: state.loop,\r\n        isPlaying: state.playbackState === 'playing',\r\n        currentTime: player.getCurrentTime(),\r\n        startTimestamp: now\r\n      });\r\n    }\r\n    \r\n    return {\r\n      tracks,\r\n      channelVolumes: this.gmEngine.volumes\r\n    };\r\n  }\r\n\r\n  private broadcastSyncStart(): void {\r\n    const state = this.getCurrentSyncState();\r\n    this.send('sync-start', state);\r\n  }\r\n\r\n  private broadcastSyncStop(): void {\r\n    this.send('sync-stop', {});\r\n  }\r\n\r\n  private sendStateTo(userId: string): void {\r\n    const state = this.getCurrentSyncState();\r\n    this.send('sync-state', state, userId);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // GM Actions (called when GM interacts with mixer)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  broadcastTrackPlay(trackId: string, offset: number): void {\r\n    if (!this._syncEnabled || !this.gmEngine) return;\r\n    \r\n    const player = this.gmEngine.getTrack(trackId);\r\n    if (!player) return;\r\n    \r\n    const payload: TrackPlayPayload = {\r\n      trackId,\r\n      url: player.url,\r\n      group: player.group,\r\n      volume: player.volume,\r\n      loop: player.loop,\r\n      offset,\r\n      startTimestamp: getServerTime()\r\n    };\r\n    \r\n    this.send('track-play', payload);\r\n  }\r\n\r\n  broadcastTrackPause(trackId: string, pausedAt: number): void {\r\n    if (!this._syncEnabled) return;\r\n    \r\n    const payload: TrackPausePayload = { trackId, pausedAt };\r\n    this.send('track-pause', payload);\r\n  }\r\n\r\n  broadcastTrackStop(trackId: string): void {\r\n    if (!this._syncEnabled) return;\r\n    \r\n    const payload: TrackStopPayload = { trackId };\r\n    this.send('track-stop', payload);\r\n  }\r\n\r\n  broadcastTrackSeek(trackId: string, time: number, isPlaying: boolean): void {\r\n    if (!this._syncEnabled) return;\r\n    \r\n    const payload: TrackSeekPayload = {\r\n      trackId,\r\n      time,\r\n      isPlaying,\r\n      seekTimestamp: getServerTime()\r\n    };\r\n    this.send('track-seek', payload);\r\n  }\r\n\r\n  broadcastTrackVolume(trackId: string, volume: number): void {\r\n    if (!this._syncEnabled) return;\r\n    \r\n    const payload: TrackVolumePayload = { trackId, volume };\r\n    this.send('track-volume', payload);\r\n  }\r\n\r\n  broadcastTrackLoop(trackId: string, loop: boolean): void {\r\n    if (!this._syncEnabled) return;\r\n    \r\n    const payload: TrackLoopPayload = { trackId, loop };\r\n    this.send('track-loop', payload);\r\n  }\r\n\r\n  broadcastChannelVolume(channel: TrackGroup | 'master', volume: number): void {\r\n    if (!this._syncEnabled) return;\r\n    \r\n    const payload: ChannelVolumePayload = { channel, volume };\r\n    this.send('channel-volume', payload);\r\n  }\r\n\r\n  broadcastStopAll(): void {\r\n    if (!this._syncEnabled) return;\r\n    this.send('stop-all', {});\r\n  }\r\n\r\n  dispose(): void {\r\n    this.socket?.off(SOCKET_NAME);\r\n  }\r\n}","export function throttle<T extends (...args: Parameters<T>) => void>(\r\n  fn: T,\r\n  delay: number\r\n): (...args: Parameters<T>) => void {\r\n  let lastCall = 0;\r\n  let timeoutId: ReturnType<typeof setTimeout> | null = null;\r\n  \r\n  return function (this: ThisParameterType<T>, ...args: Parameters<T>) {\r\n    const now = Date.now();\r\n    const remaining = delay - (now - lastCall);\r\n    \r\n    if (remaining <= 0) {\r\n      if (timeoutId) {\r\n        clearTimeout(timeoutId);\r\n        timeoutId = null;\r\n      }\r\n      lastCall = now;\r\n      fn.apply(this, args);\r\n    } else if (!timeoutId) {\r\n      timeoutId = setTimeout(() => {\r\n        lastCall = Date.now();\r\n        timeoutId = null;\r\n        fn.apply(this, args);\r\n      }, remaining);\r\n    }\r\n  };\r\n}\r\n\r\nexport function debounce<T extends (...args: Parameters<T>) => void>(\r\n  fn: T,\r\n  delay: number\r\n): (...args: Parameters<T>) => void {\r\n  let timeoutId: ReturnType<typeof setTimeout> | null = null;\r\n  \r\n  return function (this: ThisParameterType<T>, ...args: Parameters<T>) {\r\n    if (timeoutId) {\r\n      clearTimeout(timeoutId);\r\n    }\r\n    timeoutId = setTimeout(() => {\r\n      fn.apply(this, args);\r\n    }, delay);\r\n  };\r\n}","import type { TrackGroup } from '@t/audio';\r\nimport { AudioEngine } from '@core/AudioEngine';\r\nimport { SocketManager } from '@sync/SocketManager';\r\nimport { StreamingPlayer } from '@core/StreamingPlayer';\r\nimport { Logger } from '@utils/logger';\r\nimport { formatTime } from '@utils/time';\r\nimport { throttle } from '@utils/throttle';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\nconst MAX_SIMULTANEOUS = 8;\r\n\r\ninterface MixerData {\r\n  tracks: TrackViewData[];\r\n  volumes: {\r\n    master: number;\r\n    music: number;\r\n    ambience: number;\r\n    sfx: number;\r\n  };\r\n  playingCount: number;\r\n  maxSimultaneous: number;\r\n  syncEnabled: boolean;\r\n}\r\n\r\ninterface TrackViewData {\r\n  id: string;\r\n  name: string;\r\n  group: TrackGroup;\r\n  isPlaying: boolean;\r\n  isPaused: boolean;\r\n  isStopped: boolean;\r\n  isLoading: boolean;\r\n  volume: number;\r\n  volumePercent: number;\r\n  loop: boolean;\r\n  currentTime: number;\r\n  currentTimeFormatted: string;\r\n  duration: number;\r\n  durationFormatted: string;\r\n  progress: number;\r\n}\r\n\r\nexport class SoundMixerApp extends Application {\r\n  private engine: AudioEngine;\r\n  private socket: SocketManager;\r\n  private updateInterval: ReturnType<typeof setInterval> | null = null;\r\n\r\n  static override get defaultOptions(): ApplicationOptions {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'ase-sound-mixer',\r\n      title: 'Sound Mixer (GM)',\r\n      template: `modules/${MODULE_ID}/templates/mixer.hbs`,\r\n      classes: ['ase-mixer'],\r\n      width: 550,\r\n      height: 'auto',\r\n      resizable: true,\r\n      minimizable: true,\r\n      popOut: true\r\n    }) as ApplicationOptions;\r\n  }\r\n\r\n  constructor(engine: AudioEngine, socket: SocketManager, options?: Partial<ApplicationOptions>) {\r\n    super(options);\r\n    this.engine = engine;\r\n    this.socket = socket;\r\n  }\r\n\r\n  override getData(): MixerData {\r\n    const tracks = this.engine.getAllTracks().map(player => this.getTrackViewData(player));\r\n    const volumes = this.engine.volumes;\r\n    const playingCount = tracks.filter(t => t.isPlaying).length;\r\n    \r\n    return {\r\n      tracks,\r\n      volumes: {\r\n        master: Math.round(volumes.master * 100),\r\n        music: Math.round(volumes.music * 100),\r\n        ambience: Math.round(volumes.ambience * 100),\r\n        sfx: Math.round(volumes.sfx * 100)\r\n      },\r\n      playingCount,\r\n      maxSimultaneous: MAX_SIMULTANEOUS,\r\n      syncEnabled: this.socket.syncEnabled\r\n    };\r\n  }\r\n\r\n  private getTrackViewData(player: StreamingPlayer): TrackViewData {\r\n    const state = player.getState();\r\n    const currentTime = player.getCurrentTime();\r\n    const duration = player.getDuration();\r\n    \r\n    return {\r\n      id: state.id,\r\n      name: this.extractFileName(state.url),\r\n      group: state.group,\r\n      isPlaying: state.playbackState === 'playing',\r\n      isPaused: state.playbackState === 'paused',\r\n      isStopped: state.playbackState === 'stopped',\r\n      isLoading: state.playbackState === 'loading',\r\n      volume: state.volume,\r\n      volumePercent: Math.round(state.volume * 100),\r\n      loop: state.loop,\r\n      currentTime,\r\n      currentTimeFormatted: formatTime(currentTime),\r\n      duration,\r\n      durationFormatted: formatTime(duration),\r\n      progress: duration > 0 ? (currentTime / duration) * 100 : 0\r\n    };\r\n  }\r\n\r\n  private extractFileName(url: string): string {\r\n    if (!url) return 'Unknown';\r\n    try {\r\n      const decoded = decodeURIComponent(url);\r\n      const parts = decoded.split('/');\r\n      const fileName = parts[parts.length - 1];\r\n      return fileName.replace(/\\.[^.]+$/, '');\r\n    } catch {\r\n      const parts = url.split('/');\r\n      const fileName = parts[parts.length - 1];\r\n      return fileName.replace(/\\.[^.]+$/, '');\r\n    }\r\n  }\r\n\r\n  override activateListeners(html: JQuery): void {\r\n    super.activateListeners(html);\r\n\r\n    // Sync toggle\r\n    html.find('#ase-sync-toggle').on('change', (event) => {\r\n      const enabled = (event.target as HTMLInputElement).checked;\r\n      this.socket.setSyncEnabled(enabled);\r\n      this.updateSyncIndicator(html, enabled);\r\n    });\r\n\r\n    // Channel volume sliders\r\n    const throttledChannelVolume = throttle((channel: string, value: number) => {\r\n      if (channel === 'master') {\r\n        this.engine.setMasterVolume(value);\r\n        this.socket.broadcastChannelVolume('master', value);\r\n      } else {\r\n        this.engine.setChannelVolume(channel as TrackGroup, value);\r\n        this.socket.broadcastChannelVolume(channel as TrackGroup, value);\r\n      }\r\n    }, 50);\r\n\r\n    html.find('.ase-channel-slider').on('input', (event) => {\r\n      const channel = $(event.currentTarget).data('channel') as string;\r\n      const value = parseFloat((event.target as HTMLInputElement).value) / 100;\r\n      throttledChannelVolume(channel, value);\r\n      $(event.currentTarget).siblings('.ase-channel-value').text(`${Math.round(value * 100)}%`);\r\n    });\r\n\r\n    // Add track\r\n    html.find('#ase-add-track').on('click', () => this.onAddTrack());\r\n\r\n    // Track controls\r\n    const tracks = html.find('.ase-tracks');\r\n    \r\n    tracks.on('click', '.ase-btn-play', (event) => {\r\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\r\n      this.onPlayTrack(trackId);\r\n    });\r\n\r\n    tracks.on('click', '.ase-btn-pause', (event) => {\r\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\r\n      this.onPauseTrack(trackId);\r\n    });\r\n\r\n    tracks.on('click', '.ase-btn-stop', (event) => {\r\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\r\n      this.onStopTrack(trackId);\r\n    });\r\n\r\n    tracks.on('click', '.ase-btn-remove', (event) => {\r\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\r\n      this.onRemoveTrack(trackId);\r\n    });\r\n\r\n    tracks.on('change', '.ase-loop-toggle', (event) => {\r\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\r\n      const loop = (event.target as HTMLInputElement).checked;\r\n      this.engine.setTrackLoop(trackId, loop);\r\n      this.socket.broadcastTrackLoop(trackId, loop);\r\n    });\r\n\r\n    tracks.on('change', '.ase-channel-select', (event) => {\r\n      const trackId = $(event.currentTarget).data('track-id') as string;\r\n      const channel = (event.target as HTMLSelectElement).value as TrackGroup;\r\n      this.engine.setTrackChannel(trackId, channel);\r\n    });\r\n\r\n    // Volume slider\r\n    const throttledVolume = throttle((trackId: string, value: number) => {\r\n      this.engine.setTrackVolume(trackId, value);\r\n      this.socket.broadcastTrackVolume(trackId, value);\r\n    }, 50);\r\n\r\n    tracks.on('input', '.ase-volume-slider', (event) => {\r\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\r\n      const value = parseFloat((event.target as HTMLInputElement).value) / 100;\r\n      throttledVolume(trackId, value);\r\n      $(event.currentTarget).siblings('.ase-volume-value').text(`${Math.round(value * 100)}%`);\r\n    });\r\n\r\n    // Seek slider\r\n    const throttledSeek = throttle((trackId: string, time: number) => {\r\n      const player = this.engine.getTrack(trackId);\r\n      const isPlaying = player?.state === 'playing';\r\n      this.engine.seekTrack(trackId, time);\r\n      this.socket.broadcastTrackSeek(trackId, time, isPlaying ?? false);\r\n    }, 100);\r\n\r\n    tracks.on('input', '.ase-seek-slider', (event) => {\r\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\r\n      const player = this.engine.getTrack(trackId);\r\n      if (player) {\r\n        const percent = parseFloat((event.target as HTMLInputElement).value);\r\n        const time = (percent / 100) * player.getDuration();\r\n        throttledSeek(trackId, time);\r\n      }\r\n    });\r\n\r\n    // Stop all\r\n    html.find('#ase-stop-all').on('click', () => {\r\n      this.engine.stopAll();\r\n      this.socket.broadcastStopAll();\r\n      this.render();\r\n    });\r\n\r\n    this.startUpdates();\r\n  }\r\n\r\n  private updateSyncIndicator(html: JQuery, enabled: boolean): void {\r\n    const indicator = html.find('.ase-sync-status');\r\n    indicator.toggleClass('is-active', enabled);\r\n    indicator.find('span').text(enabled ? 'SYNC ON' : 'SYNC OFF');\r\n  }\r\n\r\n  private startUpdates(): void {\r\n    this.stopUpdates();\r\n    this.updateInterval = setInterval(() => {\r\n      this.updateTrackDisplays();\r\n    }, 250);\r\n  }\r\n\r\n  private stopUpdates(): void {\r\n    if (this.updateInterval) {\r\n      clearInterval(this.updateInterval);\r\n      this.updateInterval = null;\r\n    }\r\n  }\r\n\r\n  private updateTrackDisplays(): void {\r\n    const html = this.element;\r\n    if (!html || !html.length) return;\r\n\r\n    let playingCount = 0;\r\n\r\n    for (const player of this.engine.getAllTracks()) {\r\n      const trackEl = html.find(`.ase-track[data-track-id=\"${player.id}\"]`);\r\n      if (!trackEl.length) continue;\r\n\r\n      const currentTime = player.getCurrentTime();\r\n      const duration = player.getDuration();\r\n      const progress = duration > 0 ? (currentTime / duration) * 100 : 0;\r\n      const state = player.state;\r\n\r\n      if (state === 'playing') playingCount++;\r\n\r\n      trackEl.find('.ase-time-current').text(formatTime(currentTime));\r\n      \r\n      const seekSlider = trackEl.find('.ase-seek-slider');\r\n      if (!seekSlider.is(':active')) {\r\n        seekSlider.val(progress);\r\n      }\r\n\r\n      trackEl.removeClass('is-playing is-paused is-stopped is-loading');\r\n      trackEl.addClass(`is-${state}`);\r\n      \r\n      trackEl.find('.ase-btn-play').prop('disabled', state === 'playing' || state === 'loading');\r\n      trackEl.find('.ase-btn-pause').prop('disabled', state !== 'playing');\r\n      trackEl.find('.ase-btn-stop').prop('disabled', state === 'stopped');\r\n    }\r\n\r\n    const totalTracks = this.engine.getAllTracks().length;\r\n    html.find('.ase-track-count').text(`${playingCount}/${totalTracks} playing`);\r\n  }\r\n\r\n  private async onAddTrack(): Promise<void> {\r\n    const fp = new FilePicker({\r\n      type: 'audio',\r\n      current: '',\r\n      callback: async (path: string) => {\r\n        await this.addTrackFromPath(path);\r\n      }\r\n    });\r\n    fp.render(true);\r\n  }\r\n\r\n  async addTrackFromPath(path: string, group: TrackGroup = 'music'): Promise<void> {\r\n    const trackId = `track-${Date.now()}`;\r\n    \r\n    try {\r\n      await this.engine.createTrack({\r\n        id: trackId,\r\n        url: path,\r\n        group,\r\n        volume: 1,\r\n        loop: false\r\n      });\r\n      \r\n      this.render();\r\n      ui.notifications?.info(`Added: ${this.extractFileName(path)}`);\r\n      \r\n    } catch (error) {\r\n      Logger.error('Failed to add track:', error);\r\n      ui.notifications?.error(`Failed to load: ${path}`);\r\n    }\r\n  }\r\n\r\n  private async onPlayTrack(trackId: string): Promise<void> {\r\n    const player = this.engine.getTrack(trackId);\r\n    if (!player) return;\r\n\r\n    const offset = player.state === 'paused' ? player.getCurrentTime() : 0;\r\n    await this.engine.playTrack(trackId, offset);\r\n    this.socket.broadcastTrackPlay(trackId, offset);\r\n  }\r\n\r\n  private onPauseTrack(trackId: string): void {\r\n    const player = this.engine.getTrack(trackId);\r\n    if (!player) return;\r\n    \r\n    const pausedAt = player.getCurrentTime();\r\n    this.engine.pauseTrack(trackId);\r\n    this.socket.broadcastTrackPause(trackId, pausedAt);\r\n  }\r\n\r\n  private onStopTrack(trackId: string): void {\r\n    this.engine.stopTrack(trackId);\r\n    this.socket.broadcastTrackStop(trackId);\r\n  }\r\n\r\n  private onRemoveTrack(trackId: string): void {\r\n    this.engine.removeTrack(trackId);\r\n    this.render();\r\n  }\r\n\r\n  override close(options?: Application.CloseOptions): Promise<void> {\r\n    this.stopUpdates();\r\n    return super.close(options);\r\n  }\r\n}","import { PlayerAudioEngine } from '@core/PlayerAudioEngine';\r\nimport { Logger } from '@utils/logger';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\n\r\nexport class PlayerVolumePanel extends Application {\r\n  private engine: PlayerAudioEngine;\r\n\r\n  static override get defaultOptions(): ApplicationOptions {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'ase-player-volume',\r\n      title: 'Sound Volume',\r\n      template: `modules/${MODULE_ID}/templates/player-volume.hbs`,\r\n      classes: ['ase-player-panel'],\r\n      width: 200,\r\n      height: 'auto',\r\n      resizable: false,\r\n      minimizable: true,\r\n      popOut: true\r\n    }) as ApplicationOptions;\r\n  }\r\n\r\n  constructor(engine: PlayerAudioEngine, options?: Partial<ApplicationOptions>) {\r\n    super(options);\r\n    this.engine = engine;\r\n  }\r\n\r\n  override getData() {\r\n    return {\r\n      volume: Math.round(this.engine.localVolume * 100)\r\n    };\r\n  }\r\n\r\n  override activateListeners(html: JQuery): void {\r\n    super.activateListeners(html);\r\n\r\n    html.find('.ase-volume-slider').on('input', (event) => {\r\n      const value = parseFloat((event.target as HTMLInputElement).value) / 100;\r\n      this.engine.setLocalVolume(value);\r\n      html.find('.ase-volume-value').text(`${Math.round(value * 100)}%`);\r\n      \r\n      // Save preference\r\n      this.saveVolume(value);\r\n    });\r\n  }\r\n\r\n  private saveVolume(value: number): void {\r\n    localStorage.setItem(`${MODULE_ID}-player-volume`, String(value));\r\n  }\r\n\r\n  static loadSavedVolume(): number {\r\n    const saved = localStorage.getItem(`${MODULE_ID}-player-volume`);\r\n    return saved ? parseFloat(saved) : 1;\r\n  }\r\n}","import '../styles/sound-engine.scss';\r\nimport { AudioEngine } from '@core/AudioEngine';\r\nimport { PlayerAudioEngine } from '@core/PlayerAudioEngine';\r\nimport { SocketManager } from '@sync/SocketManager';\r\nimport { SoundMixerApp } from '@ui/SoundMixerApp';\r\nimport { PlayerVolumePanel } from '@ui/PlayerVolumePanel';\r\nimport { Logger } from '@utils/logger';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\n\r\n// GM\r\nlet gmEngine: AudioEngine | null = null;\r\nlet mixerApp: SoundMixerApp | null = null;\r\n\r\n// Player\r\nlet playerEngine: PlayerAudioEngine | null = null;\r\nlet volumePanel: PlayerVolumePanel | null = null;\r\n\r\n// Shared\r\nlet socketManager: SocketManager | null = null;\r\n\r\ndeclare global {\r\n  interface Window {\r\n    ASE: {\r\n      isGM: boolean;\r\n      openPanel: () => void;\r\n      engine?: AudioEngine | PlayerAudioEngine;\r\n      socket?: SocketManager;\r\n    };\r\n  }\r\n}\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// Initialization\r\n// ─────────────────────────────────────────────────────────────\r\n\r\nHooks.once('init', () => {\r\n  Logger.info('Initializing Advanced Sound Engine...');\r\n  registerSettings();\r\n});\r\n\r\nHooks.once('ready', async () => {\r\n  const isGM = game.user?.isGM ?? false;\r\n  Logger.info(`Starting Advanced Sound Engine (${isGM ? 'GM' : 'Player'})...`);\r\n  \r\n  socketManager = new SocketManager();\r\n  \r\n  if (isGM) {\r\n    await initializeGM();\r\n  } else {\r\n    await initializePlayer();\r\n  }\r\n  \r\n  window.ASE = {\r\n    isGM,\r\n    openPanel: isGM ? openMixer : openVolumePanel,\r\n    engine: isGM ? gmEngine ?? undefined : playerEngine ?? undefined,\r\n    socket: socketManager ?? undefined\r\n  };\r\n  \r\n  setupAutoplayHandler();\r\n  addControlButton();\r\n  \r\n  Logger.info('Advanced Sound Engine ready');\r\n});\r\n\r\nasync function initializeGM(): Promise<void> {\r\n  gmEngine = new AudioEngine();\r\n  socketManager!.initializeAsGM(gmEngine);\r\n  \r\n  await gmEngine.loadSavedState();\r\n}\r\n\r\nasync function initializePlayer(): Promise<void> {\r\n  playerEngine = new PlayerAudioEngine();\r\n  socketManager!.initializeAsPlayer(playerEngine);\r\n  \r\n  // Restore saved local volume\r\n  const savedVolume = PlayerVolumePanel.loadSavedVolume();\r\n  playerEngine.setLocalVolume(savedVolume);\r\n}\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// Panels\r\n// ─────────────────────────────────────────────────────────────\r\n\r\nfunction openMixer(): void {\r\n  if (!gmEngine || !socketManager) return;\r\n  \r\n  if (mixerApp && mixerApp.rendered) {\r\n    mixerApp.bringToTop();\r\n  } else {\r\n    mixerApp = new SoundMixerApp(gmEngine, socketManager);\r\n    mixerApp.render(true);\r\n  }\r\n}\r\n\r\nfunction openVolumePanel(): void {\r\n  if (!playerEngine) return;\r\n  \r\n  if (volumePanel && volumePanel.rendered) {\r\n    volumePanel.bringToTop();\r\n  } else {\r\n    volumePanel = new PlayerVolumePanel(playerEngine);\r\n    volumePanel.render(true);\r\n  }\r\n}\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// Control Button\r\n// ─────────────────────────────────────────────────────────────\r\n\r\nfunction addControlButton(): void {\r\n  Hooks.on('renderSceneControls', () => {\r\n    // Проверяем, не добавлена ли уже кнопка\r\n    if (document.getElementById('ase-control-btn')) return;\r\n    \r\n    const controls = document.querySelector('#controls');\r\n    if (!controls) return;\r\n    \r\n    const isGM = game.user?.isGM ?? false;\r\n    \r\n    const btn = document.createElement('li');\r\n    btn.id = 'ase-control-btn';\r\n    btn.className = 'scene-control';\r\n    btn.dataset.tooltip = isGM ? 'Sound Mixer' : 'Sound Volume';\r\n    btn.innerHTML = `<i class=\"fas ${isGM ? 'fa-sliders-h' : 'fa-volume-up'}\"></i>`;\r\n    btn.style.cursor = 'pointer';\r\n    \r\n    btn.addEventListener('click', () => {\r\n      if (isGM) {\r\n        openMixer();\r\n      } else {\r\n        openVolumePanel();\r\n      }\r\n    });\r\n    \r\n    controls.appendChild(btn);\r\n  });\r\n}\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// Autoplay Policy Handler\r\n// ─────────────────────────────────────────────────────────────\r\n\r\nfunction setupAutoplayHandler(): void {\r\n  const resumeAudio = () => {\r\n    gmEngine?.resume();\r\n    playerEngine?.resume();\r\n  };\r\n  \r\n  document.addEventListener('click', resumeAudio, { once: true });\r\n  document.addEventListener('keydown', resumeAudio, { once: true });\r\n  \r\n  Hooks.once('canvasReady', resumeAudio);\r\n}\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// Settings\r\n// ─────────────────────────────────────────────────────────────\r\n\r\nfunction registerSettings(): void {\r\n  game.settings.register(MODULE_ID, 'mixerState', {\r\n    name: 'Mixer State',\r\n    hint: 'Internal storage for mixer state',\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: ''\r\n  });\r\n}\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// Cleanup\r\n// ─────────────────────────────────────────────────────────────\r\n\r\nHooks.once('closeGame', () => {\r\n  mixerApp?.close();\r\n  volumePanel?.close();\r\n  socketManager?.dispose();\r\n  gmEngine?.dispose();\r\n  playerEngine?.dispose();\r\n});"],"names":["PREFIX","Logger","message","args","_a","StreamingPlayer","id","ctx","channelOutput","group","__publicField","url","resolve","reject","onCanPlay","onError","offset","error","time","safeTime","value","newGroup","newOutput","getServerTime","formatTime","seconds","mins","secs","MODULE_ID","MAX_SIMULTANEOUS","AudioEngine","state","savedJson","config","player","playingCount","t","volume","loop","channel","tracks","trackState","stateTrackIds","PlayerAudioEngine","safeValue","volumes","payload","elapsed","adjustedOffset","trackId","isPlaying","seekTimestamp","newTrackIds","adjustedTime","SOCKET_NAME","SocketManager","engine","enabled","startPayload","statePayload","playPayload","pausePayload","stopPayload","seekPayload","volPayload","loopPayload","chVolPayload","type","targetUserId","now","userId","pausedAt","throttle","fn","delay","lastCall","timeoutId","remaining","SoundMixerApp","socket","options","currentTime","duration","parts","html","event","throttledChannelVolume","throttledVolume","throttledSeek","indicator","trackEl","progress","seekSlider","totalTracks","path","_b","PlayerVolumePanel","saved","gmEngine","mixerApp","playerEngine","volumePanel","socketManager","registerSettings","isGM","initializeGM","initializePlayer","openMixer","openVolumePanel","setupAutoplayHandler","addControlButton","savedVolume","controls","btn","resumeAudio"],"mappings":"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"}