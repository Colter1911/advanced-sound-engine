{"version":3,"file":"module.js","sources":["../src/utils/logger.ts","../src/core/StreamingPlayer.ts","../src/utils/time.ts","../src/utils/uuid.ts","../src/utils/audio-validation.ts","../src/core/effects/AudioEffect.ts","../src/core/effects/ReverbEffect.ts","../src/core/effects/DelayEffect.ts","../src/core/effects/FilterEffect.ts","../src/core/effects/CompressorEffect.ts","../src/core/effects/DistortionEffect.ts","../src/core/AudioEngine.ts","../src/core/PlayerAudioEngine.ts","../src/sync/SocketManager.ts","../src/ui/PlayerVolumePanel.ts","../src/ui/LocalLibraryApp.ts","../src/ui/SoundMixerApp.ts","../src/storage/GlobalStorage.ts","../src/ui/SoundEffectsApp.ts","../src/ui/AdvancedSoundEngineApp.ts","../src/utils/throttle.ts","../src/library/PlaylistManager.ts","../src/library/LibraryManager.ts","../src/queue/PlaybackQueueManager.ts","../src/main.ts"],"sourcesContent":["const PREFIX = 'ASE';\r\n\r\nexport const Logger = {\r\n  info: (message: string, ...args: unknown[]) => {\r\n    console.log(`${PREFIX} | ${message}`, ...args);\r\n  },\r\n  \r\n  warn: (message: string, ...args: unknown[]) => {\r\n    console.warn(`${PREFIX} | ${message}`, ...args);\r\n  },\r\n  \r\n  error: (message: string, ...args: unknown[]) => {\r\n    console.error(`${PREFIX} | ${message}`, ...args);\r\n  },\r\n  \r\n  debug: (message: string, ...args: unknown[]) => {\r\n    if (CONFIG?.debug?.audio) {\r\n      console.debug(`${PREFIX} | ${message}`, ...args);\r\n    }\r\n  }\r\n};","import type { TrackGroup, PlaybackState } from '@t/audio';\r\nimport { Logger } from '@utils/logger';\r\n\r\nexport class StreamingPlayer {\r\n  readonly id: string;\r\n  private ctx: AudioContext;\r\n  private _group: TrackGroup;\r\n  private _url: string = '';\r\n\r\n  private audio: HTMLAudioElement;\r\n  private sourceNode: MediaElementAudioSourceNode | null = null;\r\n  private gainNode: GainNode;\r\n  private outputNode: GainNode;\r\n\r\n  private _state: PlaybackState = 'stopped';\r\n  private _volume: number = 1;\r\n  private _loop: boolean = false;\r\n  private _ready: boolean = false;\r\n\r\n  constructor(\r\n    id: string,\r\n    ctx: AudioContext,\r\n    channelOutput: GainNode,\r\n    group: TrackGroup = 'music'\r\n  ) {\r\n    this.id = id;\r\n    this.ctx = ctx;\r\n    this._group = group;\r\n\r\n    this.audio = new Audio();\r\n    this.audio.crossOrigin = 'anonymous';\r\n    this.audio.preload = 'auto';\r\n\r\n    this.gainNode = ctx.createGain();\r\n    this.outputNode = ctx.createGain();\r\n\r\n    this.gainNode.connect(this.outputNode);\r\n    this.outputNode.connect(channelOutput);\r\n\r\n    this.setupAudioEvents();\r\n  }\r\n\r\n  private setupAudioEvents(): void {\r\n    this.audio.addEventListener('canplay', () => {\r\n      this._ready = true;\r\n      if (this._state === 'loading') {\r\n        this._state = 'stopped';\r\n      }\r\n      Logger.debug(`Track ${this.id} ready to play`);\r\n    });\r\n\r\n    this.audio.addEventListener('ended', () => {\r\n      if (!this._loop) {\r\n        this._state = 'stopped';\r\n        Logger.debug(`Track ${this.id} ended`);\r\n      }\r\n    });\r\n\r\n    this.audio.addEventListener('error', (e) => {\r\n      // Ignore errors if we are disposing (src cleared)\r\n      if (this.audio.getAttribute('src') === '' || !this.audio.src) return;\r\n\r\n      Logger.error(`Track ${this.id} error:`, this.audio.error);\r\n      this._state = 'stopped';\r\n    });\r\n  }\r\n\r\n  get state(): PlaybackState {\r\n    return this._state;\r\n  }\r\n\r\n  get group(): TrackGroup {\r\n    return this._group;\r\n  }\r\n\r\n  get url(): string {\r\n    return this._url;\r\n  }\r\n\r\n  get volume(): number {\r\n    return this._volume;\r\n  }\r\n\r\n  get loop(): boolean {\r\n    return this._loop;\r\n  }\r\n\r\n  get ready(): boolean {\r\n    return this._ready;\r\n  }\r\n\r\n  async load(url: string): Promise<void> {\r\n    this._state = 'loading';\r\n    this._url = url;\r\n    this._ready = false;\r\n\r\n    return new Promise((resolve, reject) => {\r\n      const onCanPlay = () => {\r\n        this.audio.removeEventListener('canplay', onCanPlay);\r\n        this.audio.removeEventListener('error', onError);\r\n\r\n        // Connect to Web Audio\r\n        if (!this.sourceNode) {\r\n          this.sourceNode = this.ctx.createMediaElementSource(this.audio);\r\n          this.sourceNode.connect(this.gainNode);\r\n        }\r\n\r\n        this._ready = true;\r\n        this._state = 'stopped';\r\n        Logger.debug(`Track loaded: ${this.id}`);\r\n        resolve();\r\n      };\r\n\r\n      const onError = () => {\r\n        this.audio.removeEventListener('canplay', onCanPlay);\r\n        this.audio.removeEventListener('error', onError);\r\n        this._state = 'stopped';\r\n        reject(new Error(`Failed to load: ${url}`));\r\n      };\r\n\r\n      this.audio.addEventListener('canplay', onCanPlay, { once: true });\r\n      this.audio.addEventListener('error', onError, { once: true });\r\n\r\n      this.audio.src = url;\r\n      this.audio.load();\r\n    });\r\n  }\r\n\r\n  async play(offset: number = 0): Promise<void> {\r\n    if (!this._ready) {\r\n      Logger.warn(`Track ${this.id} not ready`);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      this.audio.currentTime = Math.max(0, Math.min(offset, this.audio.duration || 0));\r\n      this.audio.loop = this._loop;\r\n      await this.audio.play();\r\n      this._state = 'playing';\r\n      Logger.debug(`Track ${this.id} playing from ${offset.toFixed(2)}s`);\r\n    } catch (error) {\r\n      Logger.error(`Failed to play ${this.id}:`, error);\r\n    }\r\n  }\r\n\r\n  pause(): void {\r\n    if (this._state !== 'playing') return;\r\n\r\n    this.audio.pause();\r\n    this._state = 'paused';\r\n    Logger.debug(`Track ${this.id} paused at ${this.audio.currentTime.toFixed(2)}s`);\r\n  }\r\n\r\n  stop(): void {\r\n    this.audio.pause();\r\n    this.audio.currentTime = 0;\r\n    this._state = 'stopped';\r\n    Logger.debug(`Track ${this.id} stopped`);\r\n  }\r\n\r\n  seek(time: number): void {\r\n    const safeTime = Math.max(0, Math.min(time, this.audio.duration || 0));\r\n    this.audio.currentTime = safeTime;\r\n  }\r\n\r\n  setVolume(value: number): void {\r\n    this._volume = Math.max(0, Math.min(1, value));\r\n    this.gainNode.gain.setValueAtTime(this._volume, this.ctx.currentTime);\r\n  }\r\n\r\n  setLoop(value: boolean): void {\r\n    this._loop = value;\r\n    this.audio.loop = value;\r\n  }\r\n\r\n  setChannel(newGroup: TrackGroup, newOutput: GainNode): void {\r\n    this._group = newGroup;\r\n    this.outputNode.disconnect();\r\n    this.outputNode.connect(newOutput);\r\n  }\r\n\r\n  getCurrentTime(): number {\r\n    return this.audio.currentTime;\r\n  }\r\n\r\n  getDuration(): number {\r\n    return this.audio.duration || 0;\r\n  }\r\n\r\n  getState() {\r\n    return {\r\n      id: this.id,\r\n      url: this._url,\r\n      group: this._group,\r\n      playbackState: this._state,\r\n      volume: this._volume,\r\n      loop: this._loop,\r\n      currentTime: this.getCurrentTime(),\r\n      duration: this.getDuration()\r\n    };\r\n  }\r\n\r\n  dispose(): void {\r\n    this.audio.pause();\r\n    this.audio.src = '';\r\n    this.sourceNode?.disconnect();\r\n    this.gainNode.disconnect();\r\n    this.outputNode.disconnect();\r\n    Logger.debug(`Track ${this.id} disposed`);\r\n  }\r\n}","/**\r\n * Get current server time (for sync calculations)\r\n */\r\nexport function getServerTime(): number {\r\n  // Foundry's game.time.serverTime учитывает offset\r\n  return Date.now();\r\n}\r\n\r\n/**\r\n * Calculate playback offset based on start time\r\n */\r\nexport function calculateOffset(startedAt: number, pausedAt: number = 0): number {\r\n  if (pausedAt > 0) {\r\n    return pausedAt;\r\n  }\r\n  return (getServerTime() - startedAt) / 1000;\r\n}\r\n\r\n/**\r\n * Format seconds to mm:ss\r\n */\r\nexport function formatTime(seconds: number): string {\r\n  if (!isFinite(seconds) || seconds < 0) return '0:00';\r\n  \r\n  const mins = Math.floor(seconds / 60);\r\n  const secs = Math.floor(seconds % 60);\r\n  return `${mins}:${secs.toString().padStart(2, '0')}`;\r\n}","/**\r\n * Generate a UUID v4\r\n * Based on RFC 4122 standard\r\n */\r\nexport function generateUUID(): string {\r\n  // Use crypto.randomUUID if available (modern browsers/Node 19+)\r\n  if (typeof crypto !== 'undefined' && crypto.randomUUID) {\r\n    return crypto.randomUUID();\r\n  }\r\n\r\n  // Fallback: manual UUID v4 generation\r\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {\r\n    const r = Math.random() * 16 | 0;\r\n    const v = c === 'x' ? r : (r & 0x3 | 0x8);\r\n    return v.toString(16);\r\n  });\r\n}\r\n\r\n/**\r\n * Validate UUID format\r\n */\r\nexport function isValidUUID(uuid: string): boolean {\r\n  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;\r\n  return uuidRegex.test(uuid);\r\n}\r\n","/**\r\n * Поддерживаемые аудио форматы\r\n */\r\nexport const SUPPORTED_AUDIO_FORMATS = [\r\n  '.mp3',\r\n  '.ogg',\r\n  '.wav',\r\n  '.webm',\r\n  '.m4a',\r\n  '.aac',\r\n  '.flac',\r\n  '.opus'\r\n] as const;\r\n\r\nexport type SupportedAudioFormat = typeof SUPPORTED_AUDIO_FORMATS[number];\r\n\r\n/**\r\n * MIME типы для поддерживаемых форматов\r\n */\r\nexport const AUDIO_MIME_TYPES: Record<string, string> = {\r\n  '.mp3': 'audio/mpeg',\r\n  '.ogg': 'audio/ogg',\r\n  '.wav': 'audio/wav',\r\n  '.webm': 'audio/webm',\r\n  '.m4a': 'audio/mp4',\r\n  '.aac': 'audio/aac',\r\n  '.flac': 'audio/flac',\r\n  '.opus': 'audio/opus'\r\n};\r\n\r\n/**\r\n * Проверка, является ли файл поддерживаемым аудио форматом\r\n */\r\nexport function isValidAudioFormat(url: string): boolean {\r\n  const extension = getFileExtension(url);\r\n  return SUPPORTED_AUDIO_FORMATS.includes(extension as SupportedAudioFormat);\r\n}\r\n\r\n/**\r\n * Получить расширение файла из URL\r\n */\r\nexport function getFileExtension(url: string): string {\r\n  try {\r\n    // Decode URL first\r\n    const decoded = decodeURIComponent(url);\r\n\r\n    // Remove query parameters and hash\r\n    const cleanUrl = decoded.split('?')[0].split('#')[0];\r\n\r\n    // Extract extension\r\n    const match = cleanUrl.match(/\\.([a-z0-9]+)$/i);\r\n    return match ? `.${match[1].toLowerCase()}` : '';\r\n  } catch {\r\n    return '';\r\n  }\r\n}\r\n\r\n/**\r\n * Получить MIME тип для аудио файла\r\n */\r\nexport function getAudioMimeType(url: string): string | null {\r\n  const extension = getFileExtension(url);\r\n  return AUDIO_MIME_TYPES[extension] || null;\r\n}\r\n\r\n/**\r\n * Валидация результата с деталями ошибки\r\n */\r\nexport interface AudioValidationResult {\r\n  valid: boolean;\r\n  error?: string;\r\n  extension?: string;\r\n  mimeType?: string;\r\n}\r\n\r\n/**\r\n * Полная валидация аудио файла\r\n */\r\nexport function validateAudioFile(url: string): AudioValidationResult {\r\n  if (!url || typeof url !== 'string') {\r\n    return {\r\n      valid: false,\r\n      error: 'URL is required and must be a string'\r\n    };\r\n  }\r\n\r\n  const extension = getFileExtension(url);\r\n\r\n  if (!extension) {\r\n    return {\r\n      valid: false,\r\n      error: 'Could not extract file extension from URL'\r\n    };\r\n  }\r\n\r\n  if (!isValidAudioFormat(url)) {\r\n    return {\r\n      valid: false,\r\n      error: `Unsupported audio format: ${extension}. Supported formats: ${SUPPORTED_AUDIO_FORMATS.join(', ')}`,\r\n      extension\r\n    };\r\n  }\r\n\r\n  const mimeType = getAudioMimeType(url);\r\n\r\n  return {\r\n    valid: true,\r\n    extension,\r\n    mimeType: mimeType || undefined\r\n  };\r\n}\r\n\r\n/**\r\n * Проверка поддержки формата браузером\r\n */\r\nexport function isBrowserAudioSupported(extension: string): boolean {\r\n  if (typeof Audio === 'undefined') {\r\n    return false;\r\n  }\r\n\r\n  const mimeType = AUDIO_MIME_TYPES[extension];\r\n  if (!mimeType) {\r\n    return false;\r\n  }\r\n\r\n  const audio = new Audio();\r\n  const canPlay = audio.canPlayType(mimeType);\r\n\r\n  // Returns: '' (no support), 'maybe', 'probably'\r\n  return canPlay === 'probably' || canPlay === 'maybe';\r\n}\r\n","import type { EffectState, EffectType, EffectParam } from '@t/effects';\r\nimport { generateUUID } from '@utils/uuid';\r\nimport { Logger } from '@utils/logger';\r\n\r\nexport abstract class AudioEffect {\r\n    public readonly id: string;\r\n    public readonly type: EffectType;\r\n    public enabled: boolean = false;\r\n\r\n    protected ctx: AudioContext;\r\n    public inputNode: GainNode;\r\n    public outputNode: GainNode;\r\n    protected wetNode: GainNode;\r\n    protected dryNode: GainNode;\r\n\r\n    protected params: Map<string, EffectParam> = new Map();\r\n\r\n    constructor(ctx: AudioContext, type: EffectType, id?: string) {\r\n        this.ctx = ctx;\r\n        this.type = type;\r\n        // CRITICAL FIX: Use type as ID by default instead of UUID for sync compatibility\r\n        this.id = id || type;\r\n\r\n        // Create nodes\r\n        this.inputNode = ctx.createGain();\r\n        this.outputNode = ctx.createGain();\r\n        this.wetNode = ctx.createGain();\r\n        this.dryNode = ctx.createGain();\r\n\r\n        // Default Routing:\r\n        // Input -> Split to Dry/Wet\r\n        // Dry -> Output\r\n        // Wet -> [Effect Processing] -> Output\r\n\r\n        this.inputNode.connect(this.dryNode);\r\n        this.dryNode.connect(this.outputNode);\r\n\r\n        // CRITICAL FIX: Connect wet to output (was missing!)\r\n        // Subclasses connect: inputNode -> [EffectNodes] -> wetNode\r\n        // Then we route: wetNode -> outputNode -> masterGain\r\n        this.wetNode.connect(this.outputNode);\r\n\r\n        // Add generic Output Level parameter\r\n        this.addParam({\r\n            id: 'level',\r\n            name: 'Output Level',\r\n            type: 'float',\r\n            value: 1.0,\r\n            defaultValue: 1.0,\r\n            min: 0,\r\n            max: 2.0,\r\n            step: 0.01,\r\n            suffix: ''\r\n        });\r\n\r\n        // Ensure enabled state is applied (sets wetNode gain to 1)\r\n        this.setEnabled(this.enabled);\r\n    }\r\n\r\n    /**\r\n     * Set a parameter value\r\n     */\r\n    public setParam(key: string, value: any): void {\r\n        const param = this.params.get(key);\r\n        if (!param) {\r\n            Logger.warn(`Effect ${this.type} has no parameter '${key}'`);\r\n            return;\r\n        }\r\n\r\n        Logger.debug(`Effect ${this.type} (${this.id}) setting ${key} to`, value);\r\n        param.value = value;\r\n\r\n        // Handle base parameters\r\n        if (key === 'level') {\r\n            this.outputNode.gain.setTargetAtTime(value as number, this.ctx.currentTime, 0.05);\r\n        } else {\r\n            this.applyParam(key, value);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get current state\r\n     */\r\n    public getState(): EffectState {\r\n        const paramsObj: Record<string, any> = {};\r\n        for (const [key, param] of this.params) {\r\n            paramsObj[key] = param.value;\r\n        }\r\n\r\n        return {\r\n            id: this.id,\r\n            type: this.type,\r\n            enabled: this.enabled,\r\n            params: paramsObj,\r\n            routing: {\r\n                music: false,\r\n                ambience: false,\r\n                sfx: false\r\n            } // Routing is managed by AudioEngine, this is just a placeholder or could be updated by engine\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Initialize parameters (called by subclass)\r\n     */\r\n    protected addParam(param: EffectParam): void {\r\n        this.params.set(param.id, param);\r\n    }\r\n\r\n    /**\r\n     * Apply parameter to internal audio nodes (implemented by subclass)\r\n     */\r\n    protected abstract applyParam(key: string, value: any): void;\r\n\r\n    /**\r\n     * Connect internal nodes (implemented by subclass)\r\n     * Should connect this.inputNode -> [Effect] -> this.wetNode\r\n     */\r\n    protected abstract buildGraph(): void;\r\n\r\n    /**\r\n     * Enable/Disable effect processing\r\n     */\r\n    public setEnabled(enabled: boolean): void {\r\n        this.enabled = enabled;\r\n        // When disabled, we might want to bypass processing to save CPU\r\n        // For now, we assume implicit bypass \r\n        if (enabled) {\r\n            this.wetNode.gain.setTargetAtTime(1, this.ctx.currentTime, 0.05);\r\n            // We might want to lower dry signal if it's an insert effect, \r\n            // but since we are using Send architecture, effects are usually 100% wet\r\n            // and we mix them in. \r\n            // WAIT! If we use Send architecture (Aux Send), the effect should output ONLY Wet signal.\r\n            // The Dry signal comes from the original channel.\r\n            this.dryNode.gain.value = 0;\r\n        } else {\r\n            // Disabled = Mute effect output\r\n            this.wetNode.gain.setTargetAtTime(0, this.ctx.currentTime, 0.05);\r\n            this.dryNode.gain.value = 0;\r\n        }\r\n    }\r\n\r\n    public setDryWet(mix: number) {\r\n        // only relevant if used as insert\r\n    }\r\n\r\n    public dispose(): void {\r\n        this.inputNode.disconnect();\r\n        this.outputNode.disconnect();\r\n        this.wetNode.disconnect();\r\n        this.dryNode.disconnect();\r\n    }\r\n}\r\n","import { AudioEffect } from './AudioEffect';\r\nimport { Logger } from '@utils/logger';\r\n\r\nexport class ReverbEffect extends AudioEffect {\r\n    private convolverNode: ConvolverNode;\r\n\r\n    constructor(ctx: AudioContext, id?: string) {\r\n        super(ctx, 'reverb', id);\r\n        this.convolverNode = ctx.createConvolver();\r\n        this.convolverNode.normalize = false; // Disable normalization to keep volume levels predictably high\r\n\r\n        this.addParam({\r\n            id: 'decay',\r\n            name: 'Decay Time',\r\n            type: 'float',\r\n            value: 2.0,\r\n            defaultValue: 2.0,\r\n            min: 0.1,\r\n            max: 10.0,\r\n            step: 0.1,\r\n            suffix: 's'\r\n        });\r\n\r\n        this.addParam({\r\n            id: 'size',\r\n            name: 'Room Size',\r\n            type: 'float',\r\n            value: 1.0,\r\n            defaultValue: 1.0,\r\n            min: 0.1,\r\n            max: 3.0,\r\n            step: 0.1,\r\n            suffix: 'x'\r\n        });\r\n\r\n        this.addParam({\r\n            id: 'tone',\r\n            name: 'Tone (Video)',\r\n            type: 'select',\r\n            value: 'default',\r\n            defaultValue: 'default',\r\n            options: [\r\n                { label: 'Standard', value: 'default' },\r\n                { label: 'Dark', value: 'dark' },\r\n                { label: 'Bright', value: 'bright' }\r\n            ]\r\n        });\r\n\r\n        this.buildGraph();\r\n        this.updateImpulse();\r\n    }\r\n\r\n    protected buildGraph(): void {\r\n        this.inputNode.connect(this.convolverNode);\r\n        this.convolverNode.connect(this.wetNode);\r\n    }\r\n\r\n    protected applyParam(key: string, value: any): void {\r\n        if (key === 'decay' || key === 'size' || key === 'tone') {\r\n            this.updateImpulse();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Re-generates global impulse based on current parameters\r\n     */\r\n    private updateImpulse(): void {\r\n        const decayTime = (this.params.get('decay')?.value as number) || 2.0;\r\n        const sizeMult = (this.params.get('size')?.value as number) || 1.0;\r\n        const tone = (this.params.get('tone')?.value as string) || 'default';\r\n\r\n        // Base duration = decay time * size multiplier (roughly)\r\n        const duration = decayTime * sizeMult;\r\n\r\n        // Tone affects the initial burst or the noise \"color\"\r\n        // For simple synthesis, we can affect how fast it decays initially vs late tail.\r\n        // Dark = faster high freq decay (simulated by decay curve power)\r\n        let decayCurvePower = 2.0;\r\n        if (tone === 'dark') decayCurvePower = 3.0; // Decay faster (perceptually)\r\n        if (tone === 'bright') decayCurvePower = 1.5; // Sustain noise longer\r\n\r\n        this.generateSimpleImpulse(duration, decayCurvePower);\r\n    }\r\n\r\n    /**\r\n     * Generates a simple synthetic impulse response (white noise with exponential decay)\r\n     */\r\n    private generateSimpleImpulse(duration: number, decayPower: number): void {\r\n        // Safety clamps\r\n        if (duration <= 0.01) duration = 0.01;\r\n\r\n        const rate = this.ctx.sampleRate;\r\n        const length = Math.floor(rate * duration);\r\n        const impulse = this.ctx.createBuffer(2, length, rate);\r\n        const left = impulse.getChannelData(0);\r\n        const right = impulse.getChannelData(1);\r\n\r\n        for (let i = 0; i < length; i++) {\r\n            const n = i / length;\r\n            // Exponential decay\r\n            const gain = Math.pow(1 - n, decayPower);\r\n\r\n            // SIGNIFICANTLY reduce gain to prevent volume boosting.\r\n            // A long reverb impulse sums up to a lot of energy.\r\n            // 0.05 seems conservative but safe for \"adding\" ambience without overpowering dry.\r\n            const volumeScale = 0.05;\r\n\r\n            left[i] = (Math.random() * 2 - 1) * gain * volumeScale;\r\n            right[i] = (Math.random() * 2 - 1) * gain * volumeScale;\r\n        }\r\n\r\n        this.convolverNode.buffer = impulse;\r\n    }\r\n}\r\n","import { AudioEffect } from './AudioEffect';\r\nimport { Logger } from '@utils/logger';\r\n\r\nexport class DelayEffect extends AudioEffect {\r\n    private delayNode: DelayNode;\r\n    private feedbackNode: GainNode;\r\n\r\n    constructor(ctx: AudioContext, id?: string) {\r\n        super(ctx, 'delay', id);\r\n        this.delayNode = ctx.createDelay(5.0); // Max delay 5s\r\n        this.feedbackNode = ctx.createGain();\r\n\r\n        this.addParam({\r\n            id: 'time',\r\n            name: 'Time',\r\n            type: 'float',\r\n            value: 0.3,\r\n            defaultValue: 0.3,\r\n            min: 0,\r\n            max: 2.0,\r\n            step: 0.01,\r\n            suffix: 's'\r\n        });\r\n\r\n        this.addParam({\r\n            id: 'feedback',\r\n            name: 'Feedback',\r\n            type: 'float',\r\n            value: 0.4,\r\n            defaultValue: 0.4,\r\n            min: 0,\r\n            max: 0.9,\r\n            step: 0.01,\r\n            suffix: ''\r\n        });\r\n\r\n        this.buildGraph();\r\n        this.applyParam('time', 0.3);\r\n        this.applyParam('feedback', 0.4);\r\n    }\r\n\r\n    protected buildGraph(): void {\r\n        // Input -> Delay -> Output\r\n        //      |-> Feedback -> Delay\r\n\r\n        // Connect Input to Delay\r\n        this.inputNode.connect(this.delayNode);\r\n\r\n        // Connect Delay to Wet Output\r\n        this.delayNode.connect(this.wetNode);\r\n\r\n        // Feedback Loop: Delay -> Feedback -> Delay\r\n        this.delayNode.connect(this.feedbackNode);\r\n        this.feedbackNode.connect(this.delayNode);\r\n    }\r\n\r\n    protected applyParam(key: string, value: any): void {\r\n        switch (key) {\r\n            case 'time':\r\n                this.delayNode.delayTime.setTargetAtTime(value as number, this.ctx.currentTime, 0.05);\r\n                break;\r\n            case 'feedback':\r\n                this.feedbackNode.gain.setTargetAtTime(value as number, this.ctx.currentTime, 0.05);\r\n                break;\r\n        }\r\n    }\r\n}\r\n","import { AudioEffect } from './AudioEffect';\r\n\r\nexport class FilterEffect extends AudioEffect {\r\n    private filterNode: BiquadFilterNode;\r\n\r\n    constructor(ctx: AudioContext, id?: string) {\r\n        super(ctx, 'filter', id);\r\n        this.filterNode = ctx.createBiquadFilter();\r\n\r\n        this.addParam({\r\n            id: 'type',\r\n            name: 'Type',\r\n            type: 'select',\r\n            value: 'lowpass',\r\n            defaultValue: 'lowpass',\r\n            options: [\r\n                { label: 'Lowpass', value: 'lowpass' },\r\n                { label: 'Highpass', value: 'highpass' },\r\n                { label: 'Bandpass', value: 'bandpass' },\r\n                { label: 'Peaking', value: 'peaking' }\r\n            ]\r\n        });\r\n\r\n        this.addParam({\r\n            id: 'frequency',\r\n            name: 'Frequency',\r\n            type: 'float',\r\n            value: 1000,\r\n            defaultValue: 1000,\r\n            min: 20,\r\n            max: 20000,\r\n            step: 10,\r\n            suffix: 'Hz'\r\n        });\r\n\r\n        this.addParam({\r\n            id: 'Q',\r\n            name: 'Resonance',\r\n            type: 'float',\r\n            value: 1,\r\n            defaultValue: 1,\r\n            min: 0.1,\r\n            max: 10,\r\n            step: 0.1,\r\n            suffix: ''\r\n        });\r\n\r\n        this.buildGraph();\r\n        this.applyParam('type', 'lowpass');\r\n        this.applyParam('frequency', 1000);\r\n    }\r\n\r\n    protected buildGraph(): void {\r\n        this.inputNode.connect(this.filterNode);\r\n        this.filterNode.connect(this.wetNode);\r\n    }\r\n\r\n    protected applyParam(key: string, value: any): void {\r\n        switch (key) {\r\n            case 'type':\r\n                this.filterNode.type = value as BiquadFilterType;\r\n                break;\r\n            case 'frequency':\r\n                this.filterNode.frequency.setTargetAtTime(value as number, this.ctx.currentTime, 0.05);\r\n                break;\r\n            case 'Q':\r\n                this.filterNode.Q.setTargetAtTime(value as number, this.ctx.currentTime, 0.05);\r\n                break;\r\n        }\r\n    }\r\n}\r\n","import { AudioEffect } from './AudioEffect';\r\n\r\nexport class CompressorEffect extends AudioEffect {\r\n    private compressorNode: DynamicsCompressorNode;\r\n    private makeupNode: GainNode;\r\n\r\n    constructor(ctx: AudioContext, id?: string) {\r\n        super(ctx, 'compressor', id);\r\n        this.compressorNode = ctx.createDynamicsCompressor();\r\n        this.makeupNode = ctx.createGain();\r\n\r\n        this.addParam({\r\n            id: 'threshold',\r\n            name: 'Threshold',\r\n            type: 'float',\r\n            value: -24,\r\n            defaultValue: -24,\r\n            min: -100,\r\n            max: 0,\r\n            step: 1,\r\n            suffix: 'dB'\r\n        });\r\n\r\n        this.addParam({\r\n            id: 'ratio',\r\n            name: 'Ratio',\r\n            type: 'float',\r\n            value: 12,\r\n            defaultValue: 12,\r\n            min: 1,\r\n            max: 20,\r\n            step: 0.5,\r\n            suffix: ''\r\n        });\r\n\r\n        this.buildGraph();\r\n        this.applyParam('threshold', -24);\r\n        this.applyParam('ratio', 12);\r\n    }\r\n\r\n    protected buildGraph(): void {\r\n        this.inputNode.connect(this.compressorNode);\r\n        this.compressorNode.connect(this.makeupNode);\r\n        this.makeupNode.connect(this.wetNode);\r\n    }\r\n\r\n    protected applyParam(key: string, value: any): void {\r\n        switch (key) {\r\n            case 'threshold':\r\n                this.compressorNode.threshold.setTargetAtTime(value as number, this.ctx.currentTime, 0.05);\r\n                this.updateMakeupGain();\r\n                break;\r\n            case 'ratio':\r\n                this.compressorNode.ratio.setTargetAtTime(value as number, this.ctx.currentTime, 0.05);\r\n                this.updateMakeupGain();\r\n                break;\r\n        }\r\n    }\r\n\r\n    private updateMakeupGain(): void {\r\n        // Simple auto-makeup gain logic\r\n        // Approximate gain reduction compensation\r\n        const threshold = this.compressorNode.threshold.value;\r\n        const ratio = this.compressorNode.ratio.value;\r\n\r\n        // If threshold is 0, no compression, gain should be 1.\r\n        // As threshold drops, we expect volume loss.\r\n        // We compensate roughly half of the potential reduction to be safe.\r\n        // Formula: Gain(dB) = -Threshold * 0.6 (tuned by ear usually)\r\n\r\n        let makeupDb = 0;\r\n        if (threshold < 0) {\r\n            makeupDb = -threshold * 0.5;\r\n        }\r\n\r\n        // Convert dB to linear gain: 10^(dB/20)\r\n        const makeupGain = Math.pow(10, makeupDb / 20);\r\n\r\n        this.makeupNode.gain.setTargetAtTime(makeupGain, this.ctx.currentTime, 0.05);\r\n    }\r\n}\r\n","import { AudioEffect } from './AudioEffect';\r\n\r\nexport class DistortionEffect extends AudioEffect {\r\n    private shaperNode: WaveShaperNode;\r\n    private preGain: GainNode;\r\n\r\n    constructor(ctx: AudioContext, id?: string) {\r\n        super(ctx, 'distortion', id);\r\n        this.shaperNode = ctx.createWaveShaper();\r\n        this.shaperNode.oversample = '4x';\r\n        this.preGain = ctx.createGain();\r\n\r\n        this.addParam({\r\n            id: 'drive',\r\n            name: 'Drive',\r\n            type: 'float',\r\n            value: 0,\r\n            defaultValue: 0,\r\n            min: 0,\r\n            max: 100,\r\n            step: 1,\r\n            suffix: '%'\r\n        });\r\n\r\n        this.buildGraph();\r\n        this.updateCurve(0);\r\n    }\r\n\r\n    protected buildGraph(): void {\r\n        // Input -> PreGain (Drive) -> WaveShaper -> WetNode\r\n        this.inputNode.connect(this.preGain);\r\n        this.preGain.connect(this.shaperNode);\r\n        this.shaperNode.connect(this.wetNode);\r\n    }\r\n\r\n    protected applyParam(key: string, value: any): void {\r\n        if (key === 'drive') {\r\n            const driveAmount = value as number;\r\n            this.updateCurve(driveAmount);\r\n\r\n            // Apply input gain (pre-drive)\r\n            // 0% -> 1.0 (0dB)\r\n            // 100% -> 20.0 (+26dB) - significant boost to force clipping\r\n            // Using exponential curve for more natural feel\r\n            const gain = 1 + (driveAmount / 5);\r\n            this.preGain.gain.setTargetAtTime(gain, this.ctx.currentTime, 0.05);\r\n        }\r\n    }\r\n\r\n    private updateCurve(amount: number): void {\r\n        const k = amount; // 0-100\r\n\r\n        if (k === 0) {\r\n            this.shaperNode.curve = null;\r\n            return;\r\n        }\r\n\r\n        const n_samples = 44100;\r\n        const curve = new Float32Array(n_samples);\r\n        const deg = Math.PI / 180;\r\n\r\n        // Improved output compensation - as we drive harder, we might want to normalize the curve\r\n        // slightly differently, but standard waveshaping usually stays within -1..1 range on Y axis.\r\n\r\n        for (let i = 0; i < n_samples; ++i) {\r\n            const x = (i * 2) / n_samples - 1;\r\n\r\n            // Sigmoid function: (1+k)*x / (1+k*|x|)\r\n            // k needs to be scaled up to make the curve sharper\r\n            // 0-100 is linear, let's map it to 0-1000 for the formula\r\n            const k_scaled = k * 2;\r\n\r\n            // Standard soft-clipping formula\r\n            curve[i] = ((k_scaled + 20) * x) / (20 + k_scaled * Math.abs(x));\r\n        }\r\n\r\n        this.shaperNode.curve = curve;\r\n    }\r\n}\r\n","import type { TrackConfig, TrackState, MixerState, TrackGroup, ChannelVolumes } from '@t/audio';\r\nimport type { EffectState, EffectType, EffectParam } from '@t/effects';\r\nimport { StreamingPlayer } from './StreamingPlayer';\r\nimport { Logger } from '@utils/logger';\r\nimport { getServerTime } from '@utils/time';\r\nimport { generateUUID } from '@utils/uuid';\r\nimport { validateAudioFile } from '@utils/audio-validation';\r\n\r\n// Effects\r\nimport { AudioEffect } from './effects/AudioEffect';\r\nimport { ReverbEffect } from './effects/ReverbEffect';\r\nimport { DelayEffect } from './effects/DelayEffect';\r\nimport { FilterEffect } from './effects/FilterEffect';\r\nimport { CompressorEffect } from './effects/CompressorEffect';\r\nimport { DistortionEffect } from './effects/DistortionEffect';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\n\r\nfunction getMaxSimultaneous(): number {\r\n  return ((game.settings as any).get(MODULE_ID, 'maxSimultaneousTracks') as number) || 8;\r\n}\r\n\r\nexport class AudioEngine {\r\n  private ctx: AudioContext;\r\n  private masterGain: GainNode;\r\n  private channelGains: Record<TrackGroup, GainNode>;\r\n  private players: Map<string, StreamingPlayer> = new Map();\r\n\r\n  // Effects System\r\n  // Effects System\r\n  private effects: Map<string, AudioEffect> = new Map();\r\n  // Sends: Channel -> EffectId -> GainNode\r\n  private sends: Record<TrackGroup, Map<string, GainNode>> = {\r\n    music: new Map(),\r\n    ambience: new Map(),\r\n    sfx: new Map()\r\n  };\r\n  // Direct Gains: Channel -> Master (Control dry level)\r\n  private directGains: Record<TrackGroup, GainNode>;\r\n\r\n  private _volumes: ChannelVolumes = {\r\n    master: 1,\r\n    music: 1,\r\n    ambience: 1,\r\n    sfx: 1\r\n  };\r\n\r\n  private saveTimeout: ReturnType<typeof setTimeout> | null = null;\r\n\r\n  constructor() {\r\n    this.ctx = new AudioContext();\r\n\r\n    this.masterGain = this.ctx.createGain();\r\n    this.masterGain.connect(this.ctx.destination);\r\n\r\n    this.channelGains = {\r\n      music: this.ctx.createGain(),\r\n      ambience: this.ctx.createGain(),\r\n      sfx: this.ctx.createGain()\r\n    };\r\n\r\n    // Initialize Direct Gains\r\n    this.directGains = {\r\n      music: this.ctx.createGain(),\r\n      ambience: this.ctx.createGain(),\r\n      sfx: this.ctx.createGain()\r\n    };\r\n\r\n    // Connect Channel -> DirectGain -> Master\r\n    // This replaces the direct connection so we can duck the dry signal\r\n    this.channelGains.music.connect(this.directGains.music);\r\n    this.directGains.music.connect(this.masterGain);\r\n\r\n    this.channelGains.ambience.connect(this.directGains.ambience);\r\n    this.directGains.ambience.connect(this.masterGain);\r\n\r\n    this.channelGains.sfx.connect(this.directGains.sfx);\r\n    this.directGains.sfx.connect(this.masterGain);\r\n\r\n    this.initializeEffects();\r\n\r\n    Logger.info('AudioEngine initialized');\r\n  }\r\n\r\n  private initializeEffects(): void {\r\n    // Create one instance of each effect\r\n    const effectClasses = [\r\n      ReverbEffect,\r\n      FilterEffect,\r\n      DelayEffect,\r\n      CompressorEffect,\r\n      DistortionEffect\r\n    ];\r\n\r\n    effectClasses.forEach(EffectClass => {\r\n      const effect = new EffectClass(this.ctx);\r\n      // CRITICAL FIX: Use effect type as ID instead of UUID for sync compatibility with PlayerAudioEngine\r\n      const effectId = effect.type; // 'reverb', 'delay', 'filter', etc.\r\n      this.effects.set(effectId, effect);\r\n\r\n      // Connect Effect Output to Master Gain\r\n      effect.outputNode.connect(this.masterGain);\r\n\r\n      // Create Send Gains for each channel\r\n      (['music', 'ambience', 'sfx'] as TrackGroup[]).forEach(group => {\r\n        const sendGain = this.ctx.createGain();\r\n        sendGain.gain.value = 0; // Default off\r\n\r\n        // Connect Channel -> SendGain -> Effect Input\r\n        this.channelGains[group].connect(sendGain);\r\n        sendGain.connect(effect.inputNode);\r\n\r\n        this.sends[group].set(effectId, sendGain);\r\n      });\r\n    });\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Persistence (GM only)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private scheduleSave(): void {\r\n    if (!game.user?.isGM) return;\r\n\r\n    if (this.saveTimeout) {\r\n      clearTimeout(this.saveTimeout);\r\n    }\r\n    this.saveTimeout = setTimeout(() => {\r\n      this.saveState();\r\n    }, 500);\r\n  }\r\n\r\n  private async saveState(): Promise<void> {\r\n    if (!game.ready || !game.user?.isGM) return;\r\n\r\n    const state = this.getState();\r\n\r\n    try {\r\n      await (game.settings as any).set(MODULE_ID, 'mixerState', JSON.stringify(state));\r\n      Logger.debug('Mixer state saved');\r\n    } catch (error) {\r\n      Logger.error('Failed to save mixer state:', error);\r\n    }\r\n  }\r\n\r\n  async loadSavedState(): Promise<void> {\r\n    if (!game.ready) return;\r\n\r\n    try {\r\n      const savedJson = (game.settings as any).get(MODULE_ID, 'mixerState') as string;\r\n      if (!savedJson) return;\r\n\r\n      const state = JSON.parse(savedJson) as MixerState;\r\n      await this.restoreState(state);\r\n\r\n      Logger.info('Mixer state restored');\r\n    } catch (error) {\r\n      Logger.error('Failed to load mixer state:', error);\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Track Management\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  async createTrack(config: TrackConfig): Promise<StreamingPlayer> {\r\n    // Generate UUID if not provided\r\n    const trackId = config.id || generateUUID();\r\n\r\n    if (this.players.has(trackId)) {\r\n      return this.players.get(trackId)!;\r\n    }\r\n\r\n    // Validate audio file format\r\n    const validation = validateAudioFile(config.url);\r\n    if (!validation.valid) {\r\n      const error = new Error(validation.error || 'Invalid audio file');\r\n      Logger.error(`Track validation failed: ${validation.error}`);\r\n      throw error;\r\n    }\r\n\r\n    const channelOutput = this.channelGains[config.group];\r\n\r\n    const player = new StreamingPlayer(\r\n      trackId,\r\n      this.ctx,\r\n      channelOutput,\r\n      config.group\r\n    );\r\n\r\n    if (config.volume !== undefined) {\r\n      player.setVolume(config.volume);\r\n    }\r\n    if (config.loop !== undefined) {\r\n      player.setLoop(config.loop);\r\n    }\r\n\r\n    await player.load(config.url);\r\n\r\n    this.players.set(trackId, player);\r\n    this.scheduleSave();\r\n\r\n    Logger.info(`Track created: ${trackId} (${validation.extension})`);\r\n    return player;\r\n  }\r\n\r\n  getTrack(id: string): StreamingPlayer | undefined {\r\n    return this.players.get(id);\r\n  }\r\n\r\n  removeTrack(id: string): boolean {\r\n    const player = this.players.get(id);\r\n    if (!player) return false;\r\n\r\n    player.dispose();\r\n    this.players.delete(id);\r\n    this.scheduleSave();\r\n\r\n    Logger.info(`Track removed: ${id}`);\r\n    return true;\r\n  }\r\n\r\n  getAllTracks(): StreamingPlayer[] {\r\n    return Array.from(this.players.values());\r\n  }\r\n\r\n  getTracksByGroup(group: TrackGroup): StreamingPlayer[] {\r\n    return this.getAllTracks().filter(t => t.group === group);\r\n  }\r\n\r\n  setTrackChannel(id: string, newGroup: TrackGroup): void {\r\n    const player = this.players.get(id);\r\n    if (!player) return;\r\n\r\n    player.setChannel(newGroup, this.channelGains[newGroup]);\r\n    this.scheduleSave();\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Playback Control\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  async playTrack(id: string, offset: number = 0): Promise<void> {\r\n    const player = this.players.get(id);\r\n    if (!player) {\r\n      Logger.warn(`Track not found: ${id}`);\r\n      return;\r\n    }\r\n\r\n    const maxSimultaneous = getMaxSimultaneous();\r\n    const playingCount = this.getAllTracks().filter(t => t.state === 'playing').length;\r\n    const isCurrentlyPlaying = player.state === 'playing';\r\n\r\n    if (!isCurrentlyPlaying && playingCount >= maxSimultaneous) {\r\n      Logger.warn(`Maximum simultaneous tracks (${maxSimultaneous}) reached`);\r\n      ui.notifications?.warn(`Cannot play more than ${maxSimultaneous} tracks simultaneously`);\r\n      return;\r\n    }\r\n\r\n    await player.play(offset);\r\n  }\r\n\r\n  pauseTrack(id: string): void {\r\n    this.players.get(id)?.pause();\r\n  }\r\n\r\n  stopTrack(id: string): void {\r\n    this.players.get(id)?.stop();\r\n  }\r\n\r\n  seekTrack(id: string, time: number): void {\r\n    this.players.get(id)?.seek(time);\r\n  }\r\n\r\n  setTrackVolume(id: string, volume: number): void {\r\n    this.players.get(id)?.setVolume(volume);\r\n    this.scheduleSave();\r\n  }\r\n\r\n  setTrackLoop(id: string, loop: boolean): void {\r\n    this.players.get(id)?.setLoop(loop);\r\n    this.scheduleSave();\r\n  }\r\n\r\n  stopAll(): void {\r\n    for (const player of this.players.values()) {\r\n      player.stop();\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Volume Control\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  get volumes(): ChannelVolumes {\r\n    return { ...this._volumes };\r\n  }\r\n\r\n  setMasterVolume(value: number): void {\r\n    this._volumes.master = Math.max(0, Math.min(1, value));\r\n    this.masterGain.gain.linearRampToValueAtTime(\r\n      this._volumes.master,\r\n      this.ctx.currentTime + 0.01\r\n    );\r\n    this.scheduleSave();\r\n  }\r\n\r\n  setChannelVolume(channel: TrackGroup, value: number): void {\r\n    this._volumes[channel] = Math.max(0, Math.min(1, value));\r\n    this.channelGains[channel].gain.linearRampToValueAtTime(\r\n      this._volumes[channel],\r\n      this.ctx.currentTime + 0.01\r\n    );\r\n    this.scheduleSave();\r\n  }\r\n\r\n  getChannelVolume(channel: TrackGroup): number {\r\n    return this._volumes[channel];\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Effects Management\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  getAllEffects(): AudioEffect[] {\r\n    return Array.from(this.effects.values());\r\n  }\r\n\r\n  setEffectParam(effectId: string, paramId: string, value: any): void {\r\n    const effect = this.effects.get(effectId);\r\n    if (!effect) return;\r\n\r\n    effect.setParam(paramId, value);\r\n    this.scheduleSave();\r\n  }\r\n\r\n  setEffectEnabled(effectId: string, enabled: boolean): void {\r\n    const effect = this.effects.get(effectId);\r\n    if (!effect) {\r\n      console.warn('[ASE GM] setEffectEnabled: Effect not found:', effectId);\r\n      return;\r\n    }\r\n\r\n    console.log('[ASE GM] setEffectEnabled:', effectId, enabled, 'effect.enabled before:', effect.enabled);\r\n    effect.setEnabled(enabled);\r\n    console.log('[ASE GM] effect.enabled after:', effect.enabled);\r\n    this.scheduleSave();\r\n\r\n    // Update dry levels for all channels that use this effect\r\n    (['music', 'ambience', 'sfx'] as TrackGroup[]).forEach(group => {\r\n      this.updateDryLevel(group);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Toggle routing from a channel to an effect\r\n   */\r\n  setEffectRouting(effectId: string, channel: TrackGroup, enabled: boolean): void {\r\n    const channelSends = this.sends[channel];\r\n    const sendNode = channelSends.get(effectId);\r\n\r\n    console.log('[ASE GM] setEffectRouting:', effectId, channel, enabled, 'sendNode exists:', !!sendNode);\r\n    if (sendNode) {\r\n      console.log('[ASE GM] Setting send gain from', sendNode.gain.value, 'to', enabled ? 1 : 0);\r\n      // Smooth transition\r\n      sendNode.gain.setTargetAtTime(enabled ? 1 : 0, this.ctx.currentTime, 0.05);\r\n      this.scheduleSave();\r\n\r\n      // Update dry level for this channel\r\n      this.updateDryLevel(channel);\r\n    } else {\r\n      console.warn('[ASE GM] Send node not found for:', effectId, channel);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Checks active effects for the channel and adjusts direct (dry) gain.\r\n   * If an INSERT effect (Filter, Distortion, Compressor) is active + routed, \r\n   * we duck the dry signal to 0.\r\n   */\r\n  private updateDryLevel(channel: TrackGroup): void {\r\n    let isInsertActive = false;\r\n    const insertTypes: EffectType[] = ['filter', 'distortion', 'compressor'];\r\n\r\n    for (const effect of this.effects.values()) {\r\n      // Check if effect is enabled globally\r\n      if (!effect.enabled) continue;\r\n\r\n      // Check if routed to this channel\r\n      const sendNode = this.sends[channel].get(effect.id);\r\n      const isRouted = (sendNode?.gain.value || 0) > 0.5; // Threshold check\r\n\r\n      if (isRouted && insertTypes.includes(effect.type)) {\r\n        isInsertActive = true;\r\n        break; // Found one, that's enough to mute dry\r\n      }\r\n    }\r\n\r\n    // If Insert is active, Dry = 0. Else Dry = 1.\r\n    const targetGain = isInsertActive ? 0 : 1;\r\n\r\n    // Smooth transition to avoid clicks\r\n    this.directGains[channel].gain.setTargetAtTime(targetGain, this.ctx.currentTime, 0.1);\r\n\r\n    Logger.debug(`Channel ${channel} dry level set to ${targetGain} (Insert Active: ${isInsertActive})`);\r\n  }\r\n\r\n  getEffectState(effectId: string): EffectState | undefined {\r\n    const effect = this.effects.get(effectId);\r\n    if (!effect) return undefined;\r\n\r\n    const state = effect.getState();\r\n\r\n    // Inject current routing state\r\n    (['music', 'ambience', 'sfx'] as TrackGroup[]).forEach(group => {\r\n      const sendGain = this.sends[group].get(effectId);\r\n      // We consider it enabled if gain > 0.1\r\n      state.routing[group] = (sendGain?.gain.value || 0) > 0.1;\r\n    });\r\n\r\n    return state;\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // State\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  getState(): MixerState {\r\n    const tracks: TrackState[] = [];\r\n\r\n    for (const player of this.players.values()) {\r\n      tracks.push(player.getState());\r\n    }\r\n\r\n    return {\r\n      masterVolume: this._volumes.master,\r\n      channelVolumes: { ...this._volumes },\r\n      tracks,\r\n      effects: this.getAllEffects().map(e => this.getEffectState(e.type)!),\r\n      timestamp: getServerTime(),\r\n      syncEnabled: false\r\n    };\r\n  }\r\n\r\n  async restoreState(state: MixerState): Promise<void> {\r\n    // Restore volumes\r\n    this._volumes.master = state.masterVolume;\r\n    this.masterGain.gain.setValueAtTime(this._volumes.master, this.ctx.currentTime);\r\n\r\n    if (state.channelVolumes) {\r\n      for (const channel of ['music', 'ambience', 'sfx'] as TrackGroup[]) {\r\n        this._volumes[channel] = state.channelVolumes[channel];\r\n        this.channelGains[channel].gain.setValueAtTime(this._volumes[channel], this.ctx.currentTime);\r\n      }\r\n    }\r\n\r\n    // Restore Effects\r\n    if (state.effects) {\r\n      for (const fxState of state.effects) {\r\n        // Find by Type since IDs might be regenerated on reload if not persistent?\r\n        // Actually, IDs are persistent in state. But we initialized new effects with random IDs in constructor.\r\n        // We need to match by TYPE because we have exactly 1 of each type.\r\n\r\n        const effect = Array.from(this.effects.values()).find(e => e.type === fxState.type);\r\n        if (effect) {\r\n          // Restore Params\r\n          for (const [key, value] of Object.entries(fxState.params)) {\r\n            effect.setParam(key, value);\r\n          }\r\n\r\n          // Restore Routing\r\n          for (const [group, enabled] of Object.entries(fxState.routing)) {\r\n            this.setEffectRouting(effect.id, group as TrackGroup, enabled as boolean);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // Restore tracks (without playing)\r\n    for (const trackState of state.tracks) {\r\n      if (!this.players.has(trackState.id)) {\r\n        try {\r\n          await this.createTrack({\r\n            id: trackState.id,\r\n            url: trackState.url,\r\n            group: trackState.group,\r\n            volume: trackState.volume,\r\n            loop: trackState.loop\r\n          });\r\n        } catch (error) {\r\n          Logger.error(`Failed to restore track ${trackState.id}:`, error);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Remove tracks not in state\r\n    const stateTrackIds = new Set(state.tracks.map(t => t.id));\r\n    for (const [id] of this.players) {\r\n      if (!stateTrackIds.has(id)) {\r\n        this.removeTrack(id);\r\n      }\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Audio Context\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  async resume(): Promise<void> {\r\n    if (this.ctx.state === 'suspended') {\r\n      await this.ctx.resume();\r\n      Logger.info('AudioContext resumed');\r\n    }\r\n  }\r\n\r\n  get contextState(): AudioContextState {\r\n    return this.ctx.state;\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Cleanup\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  dispose(): void {\r\n    if (this.saveTimeout) {\r\n      clearTimeout(this.saveTimeout);\r\n    }\r\n    for (const player of this.players.values()) {\r\n      player.dispose();\r\n    }\r\n    this.players.clear();\r\n\r\n    for (const effect of this.effects.values()) {\r\n      effect.dispose();\r\n    }\r\n    this.effects.clear();\r\n\r\n    this.ctx.close();\r\n    Logger.info('AudioEngine disposed');\r\n  }\r\n}","import type { TrackGroup, ChannelVolumes, SyncTrackState, TrackPlayPayload } from '@t/audio';\r\nimport type { EffectState, EffectType, EffectParam } from '@t/effects';\r\nimport { StreamingPlayer } from './StreamingPlayer';\r\nimport { Logger } from '@utils/logger';\r\nimport { getServerTime } from '@utils/time';\r\n\r\n// Effects\r\nimport { AudioEffect } from './effects/AudioEffect';\r\nimport { ReverbEffect } from './effects/ReverbEffect';\r\nimport { DelayEffect } from './effects/DelayEffect';\r\nimport { FilterEffect } from './effects/FilterEffect';\r\nimport { CompressorEffect } from './effects/CompressorEffect';\r\nimport { DistortionEffect } from './effects/DistortionEffect';\r\n\r\n/**\r\n * Упрощенный движок для игроков — только получает команды\r\n */\r\nexport class PlayerAudioEngine {\r\n  private ctx: AudioContext;\r\n  private masterGain: GainNode;\r\n  private gmGain: GainNode; // Громкость от GM\r\n  private channelGains: Record<TrackGroup, GainNode>;\r\n  private players: Map<string, StreamingPlayer> = new Map();\r\n\r\n  // Effects System\r\n  private effects: Map<string, AudioEffect> = new Map();\r\n  // Sends: Channel -> EffectId -> GainNode\r\n  private sends: Record<TrackGroup, Map<string, GainNode>> = {\r\n    music: new Map(),\r\n    ambience: new Map(),\r\n    sfx: new Map()\r\n  };\r\n  // Direct Gains: Channel -> Master (Control dry level)\r\n  private directGains: Record<TrackGroup, GainNode>;\r\n\r\n  private _localVolume: number = 1; // Личная громкость игрока\r\n  private _gmVolumes: ChannelVolumes = {\r\n    master: 1,\r\n    music: 1,\r\n    ambience: 1,\r\n    sfx: 1\r\n  };\r\n\r\n  // Periodic sync verification\r\n  private lastSyncState: SyncTrackState[] = [];\r\n  private syncCheckInterval: number | null = null;\r\n  private socketManager: any; // Reference to SocketManager for requesting sync\r\n  private lastSyncRequestTime: number = 0;\r\n  private readonly SYNC_REQUEST_COOLDOWN = 10000; // 10 seconds\r\n\r\n  constructor(socketManager?: any) {\r\n    this.ctx = new AudioContext();\r\n    this.socketManager = socketManager;\r\n\r\n    // Start periodic sync verification (5 seconds)\r\n    this.startSyncVerification();\r\n\r\n    // Chain: tracks -> channels -> [direct/sends] -> gmGain -> masterGain -> destination\r\n    this.masterGain = this.ctx.createGain();\r\n    this.masterGain.connect(this.ctx.destination);\r\n\r\n    this.gmGain = this.ctx.createGain();\r\n    this.gmGain.connect(this.masterGain);\r\n\r\n    this.channelGains = {\r\n      music: this.ctx.createGain(),\r\n      ambience: this.ctx.createGain(),\r\n      sfx: this.ctx.createGain()\r\n    };\r\n\r\n    // Initialize Direct Gains\r\n    this.directGains = {\r\n      music: this.ctx.createGain(),\r\n      ambience: this.ctx.createGain(),\r\n      sfx: this.ctx.createGain()\r\n    };\r\n\r\n    // Connect Channel -> DirectGain -> GMGain\r\n    this.channelGains.music.connect(this.directGains.music);\r\n    this.directGains.music.connect(this.gmGain);\r\n\r\n    this.channelGains.ambience.connect(this.directGains.ambience);\r\n    this.directGains.ambience.connect(this.gmGain);\r\n\r\n    this.channelGains.sfx.connect(this.directGains.sfx);\r\n    this.directGains.sfx.connect(this.gmGain);\r\n\r\n    this.initializeEffects();\r\n\r\n    Logger.info('PlayerAudioEngine initialized');\r\n    console.log(\"%c ASE PLAYER ENGINE V3 (FIXED) LOADED \", \"background: #222; color: #bada55; font-size: 20px; font-weight: bold;\");\r\n  }\r\n\r\n  private startSyncVerification(): void {\r\n    this.syncCheckInterval = window.setInterval(() => {\r\n      this.verifySyncState();\r\n    }, 5000); // Check every 5 seconds\r\n  }\r\n\r\n  private verifySyncState(): void {\r\n    let needsResync = false;\r\n\r\n    // CRITICAL FIX: If sync state is empty, we should have no players\r\n    if (this.lastSyncState.length === 0) {\r\n      if (this.players.size > 0) {\r\n        console.warn('[ASE PLAYER] Sync verification: Have', this.players.size, 'players but sync state is empty');\r\n        needsResync = true;\r\n      } else {\r\n        console.log('[ASE PLAYER] Sync verification OK (no tracks)');\r\n        return;\r\n      }\r\n    }\r\n\r\n    // Check each expected track\r\n    for (const expectedTrack of this.lastSyncState) {\r\n      const player = this.players.get(expectedTrack.id);\r\n\r\n      if (!player) {\r\n        // Missing player\r\n        if (expectedTrack.isPlaying) {\r\n          console.warn('[ASE PLAYER] Sync verification: Expected track not found', expectedTrack.id);\r\n          needsResync = true;\r\n          break;\r\n        }\r\n        continue;\r\n      }\r\n\r\n      if (player) {\r\n        const actuallyPlaying = player.state === 'playing';\r\n\r\n        // Should be playing but isn't\r\n        if (expectedTrack.isPlaying && !actuallyPlaying) {\r\n          console.warn('[ASE PLAYER] Sync verification: Track should be playing but is', player.state, expectedTrack.id);\r\n          needsResync = true;\r\n          break;\r\n        }\r\n\r\n        // Shouldn't be playing but is\r\n        if (!expectedTrack.isPlaying && actuallyPlaying) {\r\n          console.warn('[ASE PLAYER] Sync verification: Track should be stopped but is playing', expectedTrack.id);\r\n          needsResync = true;\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    // CRITICAL FIX: Check for unexpected tracks that aren't in sync state\r\n    if (!needsResync) {\r\n      const expectedIds = new Set(this.lastSyncState.map(t => t.id));\r\n      for (const [id, player] of this.players) {\r\n        if (!expectedIds.has(id)) {\r\n          console.warn('[ASE PLAYER] Sync verification: Unexpected track exists:', id, 'state:', player.state);\r\n          needsResync = true;\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (needsResync) {\r\n      // Cooldown check to prevent infinite loop\r\n      const now = Date.now();\r\n      if (now - this.lastSyncRequestTime < this.SYNC_REQUEST_COOLDOWN) {\r\n        console.warn('[ASE PLAYER] Sync request on cooldown, skipping');\r\n        return;\r\n      }\r\n\r\n      console.log('[ASE PLAYER] Sync verification failed - requesting full sync from GM');\r\n      this.lastSyncRequestTime = now;\r\n      // Trigger a full state request from GM\r\n      if (this.socketManager) {\r\n        this.socketManager.requestFullSync();\r\n      } else {\r\n        console.warn('[ASE PLAYER] Cannot request sync: socketManager not set');\r\n      }\r\n    } else {\r\n      console.log('[ASE PLAYER] Sync verification OK');\r\n    }\r\n  }\r\n\r\n  dispose(): void {\r\n    // Clear interval on cleanup\r\n    if (this.syncCheckInterval !== null) {\r\n      window.clearInterval(this.syncCheckInterval);\r\n      this.syncCheckInterval = null;\r\n    }\r\n\r\n    // Dispose all players\r\n    this.clearAll();\r\n\r\n    // Dispose effects\r\n    for (const effect of this.effects.values()) {\r\n      effect.dispose();\r\n    }\r\n    this.effects.clear();\r\n\r\n    // Close audio context\r\n    this.ctx.close();\r\n    Logger.info('PlayerAudioEngine disposed');\r\n  }\r\n\r\n  private initializeEffects(): void {\r\n    // Create one instance of each effect\r\n    const effectClasses = [\r\n      ReverbEffect,\r\n      FilterEffect,\r\n      DelayEffect,\r\n      CompressorEffect,\r\n      DistortionEffect\r\n    ];\r\n\r\n    effectClasses.forEach(EffectClass => {\r\n      const effect = new EffectClass(this.ctx);\r\n      this.effects.set(effect.id, effect);\r\n\r\n      // Connect Effect Output to GM Gain (so it's controlled by GM master volume)\r\n      effect.outputNode.connect(this.gmGain);\r\n\r\n      // Create Send Gains for each channel\r\n      (['music', 'ambience', 'sfx'] as TrackGroup[]).forEach(group => {\r\n        const sendGain = this.ctx.createGain();\r\n        sendGain.gain.value = 0; // Default off\r\n\r\n        // Connect Channel -> SendGain -> Effect Input\r\n        this.channelGains[group].connect(sendGain);\r\n        sendGain.connect(effect.inputNode);\r\n\r\n        this.sends[group].set(effect.id, sendGain);\r\n      });\r\n    });\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Local Volume (Player's personal control)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  get localVolume(): number {\r\n    return this._localVolume;\r\n  }\r\n\r\n  setLocalVolume(value: number): void {\r\n    this._localVolume = Math.max(0, Math.min(1, value));\r\n    this.masterGain.gain.linearRampToValueAtTime(\r\n      this._localVolume,\r\n      this.ctx.currentTime + 0.01\r\n    );\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // GM Volume (from sync)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  setGMVolume(channel: TrackGroup | 'master', value: number): void {\r\n    const safeValue = Math.max(0, Math.min(1, value));\r\n\r\n    if (channel === 'master') {\r\n      this._gmVolumes.master = safeValue;\r\n      this.gmGain.gain.linearRampToValueAtTime(safeValue, this.ctx.currentTime + 0.01);\r\n    } else {\r\n      this._gmVolumes[channel] = safeValue;\r\n      this.channelGains[channel].gain.linearRampToValueAtTime(safeValue, this.ctx.currentTime + 0.01);\r\n    }\r\n  }\r\n\r\n  setAllGMVolumes(volumes: ChannelVolumes): void {\r\n    this._gmVolumes = { ...volumes };\r\n\r\n    this.gmGain.gain.setValueAtTime(volumes.master, this.ctx.currentTime);\r\n    this.channelGains.music.gain.setValueAtTime(volumes.music, this.ctx.currentTime);\r\n    this.channelGains.ambience.gain.setValueAtTime(volumes.ambience, this.ctx.currentTime);\r\n    this.channelGains.sfx.gain.setValueAtTime(volumes.sfx, this.ctx.currentTime);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Effects Management (Called via Socket)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  setEffectParam(effectId: string, paramId: string, value: any): void {\r\n    console.log('[ASE PLAYER] setEffectParam received:', effectId, paramId, value);\r\n    const effect = this.effects.get(effectId);\r\n    if (!effect) {\r\n      console.warn('[ASE PLAYER] Effect not found:', effectId);\r\n      return;\r\n    }\r\n    effect.setParam(paramId, value);\r\n    console.log('[ASE PLAYER] Effect param set successfully');\r\n  }\r\n\r\n  setEffectEnabled(effectId: string, enabled: boolean): void {\r\n    console.log('[ASE PLAYER] setEffectEnabled received:', effectId, enabled);\r\n    const effect = this.effects.get(effectId);\r\n    if (!effect) {\r\n      console.warn('[ASE PLAYER] Effect not found:', effectId);\r\n      return;\r\n    }\r\n\r\n    effect.setEnabled(enabled);\r\n    console.log('[ASE PLAYER] Effect enabled set to:', enabled);\r\n\r\n    // Update dry levels\r\n    (['music', 'ambience', 'sfx'] as TrackGroup[]).forEach(group => {\r\n      this.updateDryLevel(group);\r\n    });\r\n  }\r\n\r\n  setEffectRouting(effectId: string, channel: TrackGroup, active: boolean): void {\r\n    console.log('[ASE PLAYER] setEffectRouting received:', effectId, channel, active);\r\n    const channelSends = this.sends[channel];\r\n    const sendNode = channelSends.get(effectId);\r\n\r\n    if (sendNode) {\r\n      sendNode.gain.setTargetAtTime(active ? 1 : 0, this.ctx.currentTime, 0.05);\r\n      this.updateDryLevel(channel);\r\n      console.log('[ASE PLAYER] Effect routing set successfully');\r\n    } else {\r\n      console.warn('[ASE PLAYER] Send node not found for:', effectId, channel);\r\n    }\r\n  }\r\n\r\n  private updateDryLevel(channel: TrackGroup): void {\r\n    let isInsertActive = false;\r\n    const insertTypes: EffectType[] = ['filter', 'distortion', 'compressor'];\r\n\r\n    for (const effect of this.effects.values()) {\r\n      if (!effect.enabled) continue;\r\n\r\n      const sendNode = this.sends[channel].get(effect.id);\r\n      const isRouted = (sendNode?.gain.value || 0) > 0.5;\r\n\r\n      if (isRouted && insertTypes.includes(effect.type)) {\r\n        isInsertActive = true;\r\n        break;\r\n      }\r\n    }\r\n\r\n    const targetGain = isInsertActive ? 0 : 1;\r\n    this.directGains[channel].gain.setTargetAtTime(targetGain, this.ctx.currentTime, 0.1);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Local Playback Control (Interface Compliance)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  async playTrack(id: string, offset: number = 0): Promise<void> {\r\n    const player = this.players.get(id);\r\n    if (player) {\r\n      await player.play(offset);\r\n    } else {\r\n      Logger.warn(`PlayerAudioEngine: Track ${id} not found locally.`);\r\n    }\r\n  }\r\n\r\n  pauseTrack(id: string): void {\r\n    this.players.get(id)?.pause();\r\n  }\r\n\r\n  stopTrack(id: string): void {\r\n    this.players.get(id)?.stop();\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Track Commands (from GM via socket)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  async handlePlay(payload: TrackPlayPayload): Promise<void> {\r\n    let player = this.players.get(payload.trackId);\r\n\r\n    // If player exists with different URL, dispose it first\r\n    if (player && player.url !== payload.url) {\r\n      Logger.debug(`Player: Disposing existing track ${payload.trackId} (URL changed)`);\r\n      player.stop();\r\n      player.dispose();\r\n      this.players.delete(payload.trackId);\r\n      player = undefined;\r\n    }\r\n\r\n    // Create if doesn't exist\r\n    if (!player) {\r\n      player = new StreamingPlayer(\r\n        payload.trackId,\r\n        this.ctx,\r\n        this.channelGains[payload.group],\r\n        payload.group\r\n      );\r\n\r\n      await player.load(payload.url);\r\n      this.players.set(payload.trackId, player);\r\n    }\r\n\r\n    player.setVolume(payload.volume);\r\n    player.setLoop(payload.loop);\r\n\r\n    // Calculate offset based on time elapsed since GM started\r\n    const elapsed = (getServerTime() - payload.startTimestamp) / 1000;\r\n    const adjustedOffset = Math.max(0, payload.offset + elapsed);\r\n\r\n    Logger.debug(`Player: Handling Play. TrackId=${payload.trackId}, Vol=${payload.volume}, Offset=${adjustedOffset}s`);\r\n\r\n    await player.play(adjustedOffset);\r\n    Logger.debug(`Player: track ${payload.trackId} playing at ${adjustedOffset.toFixed(2)}s`);\r\n  }\r\n\r\n  handlePause(trackId: string): void {\r\n    this.players.get(trackId)?.pause();\r\n  }\r\n\r\n  handleStop(trackId: string): void {\r\n    this.players.get(trackId)?.stop();\r\n  }\r\n\r\n  handleSeek(trackId: string, time: number, isPlaying: boolean, seekTimestamp: number): void {\r\n    const player = this.players.get(trackId);\r\n    if (!player) return;\r\n\r\n    if (isPlaying) {\r\n      const elapsed = (getServerTime() - seekTimestamp) / 1000;\r\n      player.seek(time + elapsed);\r\n    } else {\r\n      player.seek(time);\r\n    }\r\n  }\r\n\r\n  handleTrackVolume(trackId: string, volume: number): void {\r\n    this.players.get(trackId)?.setVolume(volume);\r\n  }\r\n\r\n  handleTrackLoop(trackId: string, loop: boolean): void {\r\n    this.players.get(trackId)?.setLoop(loop);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Sync State (full state from GM)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  async syncState(tracks: SyncTrackState[], volumes: ChannelVolumes, effectsState: EffectState[] = []): Promise<void> {\r\n    Logger.debug(`Player: Sync State Received. Tracks=${tracks.length}, Effects=${effectsState?.length || 0}`);\r\n    Logger.debug('Player: Volumes', volumes);\r\n\r\n    // Store last sync state for periodic verification\r\n    this.lastSyncState = tracks;\r\n\r\n    // Set volumes\r\n    this.setAllGMVolumes(volumes);\r\n\r\n    // Check GM Gain after setting\r\n    Logger.debug(`Player: GM Gain set to ${this.gmGain.gain.value}`);\r\n\r\n    // Sync Effect States\r\n    if (effectsState && effectsState.length > 0) {\r\n      for (const effectState of effectsState) {\r\n        const effect = this.effects.get(effectState.id);\r\n        if (!effect) {\r\n          console.warn('[ASE PLAYER] Effect not found during sync:', effectState.id);\r\n          continue;\r\n        }\r\n\r\n        // Apply enabled state\r\n        this.setEffectEnabled(effectState.id, effectState.enabled);\r\n\r\n        // Apply routing\r\n        (['music', 'ambience', 'sfx'] as TrackGroup[]).forEach(group => {\r\n          const active = effectState.routing[group] || false;\r\n          this.setEffectRouting(effectState.id, group, active);\r\n        });\r\n\r\n        // Apply params\r\n        Object.entries(effectState.params).forEach(([paramId, value]) => {\r\n          this.setEffectParam(effectState.id, paramId, value);\r\n        });\r\n\r\n        Logger.debug(`Player: synced ${effect.type} state from GM`);\r\n      }\r\n    }\r\n\r\n    // Handle tracks\r\n    const newTrackIds = new Set(tracks.map(t => t.id));\r\n\r\n    // Remove tracks not in sync\r\n    for (const [id, player] of this.players) {\r\n      if (!newTrackIds.has(id)) {\r\n        player.dispose();\r\n        this.players.delete(id);\r\n      }\r\n    }\r\n\r\n    // Add/update tracks\r\n    for (const trackState of tracks) {\r\n      let player = this.players.get(trackState.id);\r\n\r\n      // CRITICAL FIX: Stop tracks that should not be playing\r\n      if (player && !trackState.isPlaying && player.state === 'playing') {\r\n        console.log('[ASE PLAYER] Stopping track that should not be playing:', trackState.id);\r\n        player.stop();\r\n        continue; // Skip further processing for this track as it's now stopped\r\n      }\r\n\r\n      if (!player) {\r\n        // Create if doesn't exist and should be playing\r\n        if (trackState.isPlaying) {\r\n          await this.handlePlay({\r\n            trackId: trackState.id,\r\n            url: trackState.url,\r\n            group: trackState.group,\r\n            volume: trackState.volume,\r\n            loop: trackState.loop,\r\n            offset: trackState.currentTime,\r\n            startTimestamp: trackState.startTimestamp\r\n          });\r\n        }\r\n        continue; // If player was just created (and played) or doesn't need to be created, move to next track\r\n      }\r\n\r\n      // For existing players (that weren't stopped above)\r\n      player.setVolume(trackState.volume);\r\n      player.setLoop(trackState.loop);\r\n\r\n      if (trackState.isPlaying) {\r\n        const elapsed = (getServerTime() - trackState.startTimestamp) / 1000;\r\n        const adjustedTime = trackState.currentTime + elapsed;\r\n        await player.play(adjustedTime);\r\n      } else {\r\n        player.stop();\r\n      }\r\n    }\r\n\r\n    Logger.info('Player: synced state from GM');\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Sync Off\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  // Stop all tracks without disposing\r\n  stopAll(): void {\r\n    console.log('[ASE PLAYER] Stopping all tracks');\r\n    for (const player of this.players.values()) {\r\n      if (player.state === 'playing' || player.state === 'paused') {\r\n        player.stop();\r\n      }\r\n    }\r\n    // CRITICAL FIX: Clear sync state so verification knows nothing should be playing\r\n    this.lastSyncState = [];\r\n    console.log('[ASE PLAYER] Cleared lastSyncState after stopAll');\r\n  }\r\n\r\n  // Clear all tracks (stop + dispose)\r\n  clearAll(): void {\r\n    console.log('[ASE PLAYER] Clearing all tracks');\r\n    // CRITICAL FIX: Stop tracks before disposing\r\n    for (const player of this.players.values()) {\r\n      player.stop(); // Ensure audio stops immediately\r\n      player.dispose();\r\n    }\r\n    this.players.clear();\r\n    // CRITICAL FIX: Clear sync state\r\n    this.lastSyncState = [];\r\n    Logger.info('Player: all tracks cleared');\r\n    console.log('[ASE PLAYER] Cleared lastSyncState after clearAll');\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Audio Context\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  async resume(): Promise<void> {\r\n    if (this.ctx.state === 'suspended') {\r\n      await this.ctx.resume();\r\n      Logger.info('PlayerAudioEngine: AudioContext resumed');\r\n    }\r\n  }\r\n}","import type {\r\n  SocketMessage,\r\n  SocketMessageType,\r\n  SyncStatePayload,\r\n  SyncTrackState,\r\n  TrackPlayPayload,\r\n  TrackPausePayload,\r\n  TrackStopPayload,\r\n  TrackSeekPayload,\r\n  TrackVolumePayload,\r\n  TrackLoopPayload,\r\n  ChannelVolumePayload,\r\n  TrackGroup,\r\n  ChannelVolumes,\r\n  EffectParamPayload,\r\n  EffectRoutingPayload\r\n} from '@t/audio';\r\nimport { AudioEngine } from '@core/AudioEngine';\r\nimport { PlayerAudioEngine } from '@core/PlayerAudioEngine';\r\nimport { Logger } from '@utils/logger';\r\nimport { getServerTime } from '@utils/time';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\nconst SOCKET_NAME = `module.${MODULE_ID}`;\r\n\r\nexport class SocketManager {\r\n  private gmEngine: AudioEngine | null = null;\r\n  private playerEngine: PlayerAudioEngine | null = null;\r\n  private socket: any = null;\r\n  private _syncEnabled: boolean = false;\r\n  private isGM: boolean = false;\r\n\r\n  constructor() { }\r\n\r\n  initializeAsGM(engine: AudioEngine): void {\r\n    this.isGM = true;\r\n    this.gmEngine = engine;\r\n    this.socket = game.socket;\r\n\r\n    this.socket?.on(SOCKET_NAME, (message: SocketMessage) => {\r\n      this.handleGMMessage(message);\r\n    });\r\n\r\n    Logger.info('SocketManager initialized as GM');\r\n  }\r\n\r\n  initializeAsPlayer(engine: PlayerAudioEngine): void {\r\n    this.isGM = false;\r\n    this.playerEngine = engine;\r\n    this.socket = game.socket;\r\n\r\n    this.socket?.on(SOCKET_NAME, (message: SocketMessage) => {\r\n      this.handlePlayerMessage(message);\r\n    });\r\n\r\n    // Request current state on join\r\n    setTimeout(() => {\r\n      this.send('player-ready', {});\r\n    }, 1000);\r\n\r\n    Logger.info('SocketManager initialized as Player');\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Sync Mode (GM)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  get syncEnabled(): boolean {\r\n    return this._syncEnabled;\r\n  }\r\n\r\n  setSyncEnabled(enabled: boolean): void {\r\n    if (!this.isGM) return;\r\n\r\n    this._syncEnabled = enabled;\r\n\r\n    if (enabled) {\r\n      this.broadcastSyncStart();\r\n    } else {\r\n      this.broadcastSyncStop();\r\n    }\r\n\r\n    Logger.info(`Sync mode: ${enabled ? 'ON' : 'OFF'}`);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // GM Message Handling\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private handleGMMessage(message: SocketMessage): void {\r\n    if (message.senderId === game.user?.id) return;\r\n\r\n    if (message.type === 'player-ready' && this._syncEnabled) {\r\n      // Send current state to newly joined player\r\n      this.sendStateTo(message.senderId);\r\n    }\r\n\r\n    if (message.type === 'sync-request' && this._syncEnabled) {\r\n      // Player is requesting full sync (likely due to detected mismatch)\r\n      console.log('[ASE GM] Received sync request from player:', message.senderId);\r\n      this.sendStateTo(message.senderId);\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Player Message Handling\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async handlePlayerMessage(message: SocketMessage): Promise<void> {\r\n    if (message.senderId === game.user?.id) return;\r\n    if (!this.playerEngine) return;\r\n\r\n    Logger.debug(`Player received: ${message.type}`, message.payload);\r\n\r\n    switch (message.type) {\r\n      case 'sync-start':\r\n        const startPayload = message.payload as SyncStatePayload;\r\n        await this.playerEngine.syncState(startPayload.tracks, startPayload.channelVolumes, startPayload.effects);\r\n        break;\r\n\r\n      case 'sync-stop':\r\n        this.playerEngine.clearAll();\r\n        break;\r\n\r\n      case 'sync-state':\r\n        const statePayload = message.payload as SyncStatePayload;\r\n        await this.playerEngine.syncState(statePayload.tracks, statePayload.channelVolumes, statePayload.effects);\r\n        break;\r\n\r\n      case 'track-play':\r\n        const playPayload = message.payload as TrackPlayPayload;\r\n        await this.playerEngine.handlePlay(playPayload);\r\n        break;\r\n\r\n      case 'track-pause':\r\n        const pausePayload = message.payload as TrackPausePayload;\r\n        this.playerEngine.handlePause(pausePayload.trackId);\r\n        break;\r\n\r\n      case 'track-stop':\r\n        const stopPayload = message.payload as TrackStopPayload;\r\n        this.playerEngine.handleStop(stopPayload.trackId);\r\n        break;\r\n\r\n      case 'track-seek':\r\n        const seekPayload = message.payload as TrackSeekPayload;\r\n        this.playerEngine.handleSeek(\r\n          seekPayload.trackId,\r\n          seekPayload.time,\r\n          seekPayload.isPlaying,\r\n          seekPayload.seekTimestamp\r\n        );\r\n        break;\r\n\r\n      case 'track-volume':\r\n        const volPayload = message.payload as TrackVolumePayload;\r\n        this.playerEngine.handleTrackVolume(volPayload.trackId, volPayload.volume);\r\n        break;\r\n\r\n      case 'track-loop':\r\n        const loopPayload = message.payload as TrackLoopPayload;\r\n        this.playerEngine.handleTrackLoop(loopPayload.trackId, loopPayload.loop);\r\n        break;\r\n\r\n      case 'channel-volume':\r\n        const chVolPayload = message.payload as ChannelVolumePayload;\r\n        this.playerEngine.setGMVolume(chVolPayload.channel, chVolPayload.volume);\r\n        break;\r\n\r\n      case 'stop-all':\r\n        this.playerEngine.stopAll();\r\n        break;\r\n\r\n      case 'effect-param':\r\n        const paramPayload = message.payload as EffectParamPayload;\r\n        (this.playerEngine as any).setEffectParam(paramPayload.effectId, paramPayload.paramId, paramPayload.value);\r\n        break;\r\n\r\n      case 'effect-routing':\r\n        const routingPayload = message.payload as EffectRoutingPayload;\r\n        (this.playerEngine as any).setEffectRouting(routingPayload.effectId, routingPayload.channel, routingPayload.active);\r\n        break;\r\n\r\n      case 'effect-enabled':\r\n        const enabledPayload = message.payload as any; // EffectEnabledPayload\r\n        (this.playerEngine as any).setEffectEnabled(enabledPayload.effectId, enabledPayload.enabled);\r\n        break;\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // GM Broadcast Methods\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private send(type: SocketMessageType, payload: unknown, targetUserId?: string): void {\r\n    if (!this.socket) return;\r\n\r\n    const message: SocketMessage = {\r\n      type,\r\n      payload,\r\n      senderId: game.user?.id ?? '',\r\n      timestamp: getServerTime()\r\n    };\r\n\r\n    if (targetUserId) {\r\n      this.socket.emit(SOCKET_NAME, message, { recipients: [targetUserId] });\r\n    } else {\r\n      this.socket.emit(SOCKET_NAME, message);\r\n    }\r\n\r\n    Logger.debug(`Sent: ${type}`, payload);\r\n  }\r\n\r\n  private getCurrentSyncState(): SyncStatePayload {\r\n    if (!this.gmEngine) {\r\n      return { tracks: [], channelVolumes: { master: 1, music: 1, ambience: 1, sfx: 1 }, effects: [] };\r\n    }\r\n\r\n    const now = getServerTime();\r\n    const tracks: SyncTrackState[] = [];\r\n\r\n    for (const player of this.gmEngine.getAllTracks()) {\r\n      const state = player.getState();\r\n      tracks.push({\r\n        id: state.id,\r\n        url: state.url,\r\n        group: state.group,\r\n        volume: state.volume,\r\n        loop: state.loop,\r\n        isPlaying: state.playbackState === 'playing',\r\n        currentTime: player.getCurrentTime(),\r\n        startTimestamp: now\r\n      });\r\n    }\r\n\r\n    return {\r\n      tracks,\r\n      channelVolumes: this.gmEngine.volumes,\r\n      effects: this.gmEngine.getAllEffects().map(e => this.gmEngine!.getEffectState(e.id)!)\r\n    };\r\n  }\r\n\r\n  public broadcastFullState(): void {\r\n    if (!this._syncEnabled) return;\r\n    this.broadcastSyncStart(); // Re-uses sync-start or sync-state logic\r\n  }\r\n\r\n  private broadcastSyncStart(): void {\r\n    const state = this.getCurrentSyncState();\r\n    this.send('sync-start', state);\r\n  }\r\n\r\n  private broadcastSyncStop(): void {\r\n    this.send('sync-stop', {});\r\n  }\r\n\r\n  private sendStateTo(userId: string): void {\r\n    const state = this.getCurrentSyncState();\r\n    this.send('sync-state', state, userId);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // GM Actions (called when GM interacts with mixer)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  broadcastTrackPlay(trackId: string, offset: number): void {\r\n    if (!this._syncEnabled || !this.gmEngine) return;\r\n\r\n    const player = this.gmEngine.getTrack(trackId);\r\n    if (!player) return;\r\n\r\n    const payload: TrackPlayPayload = {\r\n      trackId,\r\n      url: player.url,\r\n      group: player.group,\r\n      volume: player.volume,\r\n      loop: player.loop,\r\n      offset,\r\n      startTimestamp: getServerTime()\r\n    };\r\n\r\n    this.send('track-play', payload);\r\n  }\r\n\r\n  broadcastTrackPause(trackId: string, pausedAt: number): void {\r\n    if (!this._syncEnabled) return;\r\n\r\n    const payload: TrackPausePayload = { trackId, pausedAt };\r\n    this.send('track-pause', payload);\r\n  }\r\n\r\n  broadcastTrackStop(trackId: string): void {\r\n    if (!this._syncEnabled) return;\r\n\r\n    const payload: TrackStopPayload = { trackId };\r\n    this.send('track-stop', payload);\r\n  }\r\n\r\n  broadcastTrackSeek(trackId: string, time: number, isPlaying: boolean): void {\r\n    if (!this._syncEnabled) return;\r\n\r\n    const payload: TrackSeekPayload = {\r\n      trackId,\r\n      time,\r\n      isPlaying,\r\n      seekTimestamp: getServerTime()\r\n    };\r\n    this.send('track-seek', payload);\r\n  }\r\n\r\n  broadcastTrackVolume(trackId: string, volume: number): void {\r\n    if (!this._syncEnabled) return;\r\n\r\n    const payload: TrackVolumePayload = { trackId, volume };\r\n    this.send('track-volume', payload);\r\n  }\r\n\r\n  broadcastTrackLoop(trackId: string, loop: boolean): void {\r\n    if (!this._syncEnabled) return;\r\n\r\n    const payload: TrackLoopPayload = { trackId, loop };\r\n    this.send('track-loop', payload);\r\n  }\r\n\r\n  broadcastChannelVolume(channel: TrackGroup | 'master', volume: number): void {\r\n    if (!this._syncEnabled) return;\r\n\r\n    const payload: ChannelVolumePayload = { channel, volume };\r\n    this.send('channel-volume', payload);\r\n  }\r\n\r\n  broadcastStopAll(): void {\r\n    if (!this._syncEnabled) return;\r\n    this.send('stop-all', {});\r\n  }\r\n\r\n  dispose(): void {\r\n    this.socket?.off(SOCKET_NAME);\r\n  }\r\n\r\n  // Effects\r\n\r\n  broadcastEffectParam(effectId: string, paramId: string, value: any): void {\r\n    if (!this._syncEnabled) return;\r\n    console.log('[ASE GM] Broadcasting effect param:', effectId, paramId, value);\r\n    this.send('effect-param', { effectId, paramId, value } as EffectParamPayload);\r\n  }\r\n\r\n  broadcastEffectRouting(effectId: string, channel: TrackGroup, active: boolean): void {\r\n    if (!this._syncEnabled) return;\r\n    console.log('[ASE GM] Broadcasting effect routing:', effectId, channel, active);\r\n    this.send('effect-routing', { effectId, channel, active } as EffectRoutingPayload);\r\n  }\r\n\r\n  broadcastEffectEnabled(effectId: string, enabled: boolean): void {\r\n    if (!this._syncEnabled) return;\r\n    console.log('[ASE GM] Broadcasting effect enabled:', effectId, enabled);\r\n    this.send('effect-enabled', { effectId, enabled } as any);\r\n  }\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Player Methods (request sync from GM)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  requestFullSync(): void {\r\n    console.log('[ASE PLAYER] Requesting full sync from GM');\r\n    this.send('sync-request', {});\r\n  }\r\n}","import { PlayerAudioEngine } from '@core/PlayerAudioEngine';\r\nimport { Logger } from '@utils/logger';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\n\r\nexport class PlayerVolumePanel extends Application {\r\n  private engine: PlayerAudioEngine;\r\n\r\n  static override get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'ase-player-volume',\r\n      title: 'Sound Volume',\r\n      template: `modules/${MODULE_ID}/templates/player-volume.hbs`,\r\n      classes: ['ase-player-panel'],\r\n      width: 200,\r\n      height: 'auto',\r\n      resizable: false,\r\n      minimizable: true,\r\n      popOut: true\r\n    }) as any;\r\n  }\r\n\r\n  constructor(engine: PlayerAudioEngine, options?: any) {\r\n    super(options);\r\n    this.engine = engine;\r\n  }\r\n\r\n  override getData() {\r\n    return {\r\n      volume: Math.round(this.engine.localVolume * 100)\r\n    };\r\n  }\r\n\r\n  override activateListeners(html: JQuery): void {\r\n    super.activateListeners(html);\r\n\r\n    html.find('.ase-volume-slider').on('input', (event) => {\r\n      const value = parseFloat((event.target as HTMLInputElement).value) / 100;\r\n      this.engine.setLocalVolume(value);\r\n      html.find('.ase-volume-value').text(`${Math.round(value * 100)}%`);\r\n\r\n      // Save preference\r\n      this.saveVolume(value);\r\n    });\r\n  }\r\n\r\n  private saveVolume(value: number): void {\r\n    localStorage.setItem(`${MODULE_ID}-player-volume`, String(value));\r\n  }\r\n\r\n  static loadSavedVolume(): number {\r\n    const saved = localStorage.getItem(`${MODULE_ID}-player-volume`);\r\n    return saved ? parseFloat(saved) : 1;\r\n  }\r\n}","import type { LibraryItem, Playlist } from '@t/library';\r\nimport type { TrackGroup } from '@t/audio';\r\nimport { LibraryManager } from '@lib/LibraryManager';\r\nimport { Logger } from '@utils/logger';\r\nimport { formatTime } from '@utils/time';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\n\r\ninterface FilterState {\r\n  searchQuery: string;\r\n  selectedChannels: Set<TrackGroup>;\r\n  selectedPlaylistId: string | null;\r\n  selectedTags: Set<string>;\r\n  sortBy: 'name-asc' | 'name-desc' | 'date-asc' | 'date-desc' | 'duration-asc' | 'duration-desc' | 'playable';\r\n}\r\n\r\ninterface LibraryData {\r\n  items: LibraryItemViewData[];\r\n  playlists: PlaylistViewData[];\r\n  favorites: FavoriteViewData[];\r\n  tags: TagViewData[];\r\n  stats: {\r\n    totalItems: number;\r\n    favoriteItems: number;\r\n    playlists: number;\r\n    tagCount: number;\r\n  };\r\n  searchQuery: string;\r\n  filters: {\r\n    music: boolean;\r\n    ambience: boolean;\r\n    sfx: boolean;\r\n  };\r\n  selectedPlaylistId: string | null;\r\n  sortBy: string;\r\n  hasActiveFilters: boolean;\r\n}\r\n\r\ninterface TagViewData {\r\n  name: string;\r\n  value: string;\r\n  selected: boolean;\r\n}\r\n\r\ninterface LibraryItemViewData {\r\n  id: string;\r\n  name: string;\r\n  url: string;\r\n  duration: string;\r\n  durationFormatted: string;\r\n  durationSeconds: number;\r\n  tags: string[];\r\n  favorite: boolean;\r\n  group: string;\r\n  inQueue: boolean;\r\n  isPlaying: boolean;\r\n  isPaused: boolean;\r\n}\r\n\r\ninterface PlaylistViewData {\r\n  id: string;\r\n  name: string;\r\n  itemCount: number;\r\n  trackCount: number; // Alias for template\r\n  favorite: boolean;\r\n  inQueue: boolean;\r\n  selected?: boolean;\r\n}\r\n\r\ninterface FavoriteViewData {\r\n  id: string;\r\n  name: string;\r\n  type: 'track' | 'playlist';\r\n  group?: string; // music/ambience/sfx for tracks\r\n  inQueue?: boolean;\r\n}\r\n\r\nexport class LocalLibraryApp extends Application {\r\n  private library: LibraryManager;\r\n  private filterState: FilterState;\r\n\r\n  static override get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'local-library',\r\n      template: 'modules/advanced-sound-engine/templates/library.hbs',\r\n      title: 'Sound Library',\r\n      width: 1100,\r\n      height: 700,\r\n      classes: ['advanced-sound-engine', 'library'],\r\n      resizable: true,\r\n      tabs: [{ navSelector: '.tabs', contentSelector: '.content', initial: 'library' }]\r\n    });\r\n  }\r\n\r\n  private parentApp: any; // Using any to avoid circular import issues for now, or use interface\r\n\r\n  constructor(library: LibraryManager, parentApp: any, options = {}) {\r\n    super(options);\r\n    this.library = library;\r\n    this.parentApp = parentApp;\r\n    this.filterState = {\r\n      searchQuery: '',\r\n      selectedChannels: new Set(['music', 'ambience', 'sfx']),\r\n      selectedPlaylistId: null,\r\n      selectedTags: new Set(),\r\n      // Default sort\r\n      sortBy: 'date-desc'\r\n    } as any;\r\n  }\r\n\r\n  // Helper to request scroll persistence\r\n  private persistScroll(): void {\r\n    if (this.parentApp && typeof this.parentApp.captureLibraryScroll === 'function') {\r\n      this.parentApp.captureLibraryScroll();\r\n    }\r\n  }\r\n\r\n  // Override render to delegate to main app\r\n  override render(force?: boolean, options?: any): any {\r\n    // If we are part of the unified app, we just trigger the main app to update\r\n    if (window.ASE?.openPanel) {\r\n      window.ASE.openPanel('library', true);\r\n      return;\r\n    }\r\n    return super.render(force, options);\r\n  }\r\n\r\n  override getData(): LibraryData {\r\n    let items = this.library.getAllItems();\r\n    const playlists = this.library.playlists.getAllPlaylists();\r\n    const allTags = this.library.getAllTags();\r\n    const stats = this.library.getStats();\r\n\r\n    // Trigger background scan for missing durations (run once per session)\r\n    this.library.scanMissingDurations().then(() => {\r\n      // If items were updated, we might want to re-render, but usually scheduleSave will trigger an event? \r\n      // For now, we rely on the next interaction or auto-refresh if we implement signals.\r\n      // Or we can force a render if updates happened. \r\n      // But scanMissingDurations is async and we don't await it here to avoid blocking UI.\r\n    });\r\n\r\n    // Apply filters\r\n    items = this.applyFilters(items);\r\n\r\n    // Apply sorting\r\n    items = this.applySorting(items);\r\n\r\n    // Build favorites list (tracks + playlists)\r\n    // Use the ordered list from LibraryManager\r\n    const orderedFavorites = this.library.getOrderedFavorites();\r\n\r\n    const favorites: FavoriteViewData[] = orderedFavorites.map((entry): FavoriteViewData | null => {\r\n      const inQueue = entry.type === 'track'\r\n        ? (window.ASE?.queue?.hasItem(entry.id) ?? false)\r\n        : (window.ASE?.queue?.getItems().some(q => q.playlistId === entry.id) ?? false);\r\n\r\n      if (entry.type === 'track') {\r\n        const item = this.library.getItem(entry.id);\r\n        if (!item) return null; // Should be handled by getOrderedFavorites cleanup\r\n\r\n        return {\r\n          id: item.id,\r\n          name: item.name,\r\n          type: 'track' as const,\r\n          group: this.inferGroupFromTags(item.tags),\r\n          inQueue\r\n        };\r\n      } else {\r\n        const playlist = this.library.playlists.getPlaylist(entry.id);\r\n        if (!playlist) return null;\r\n\r\n        return {\r\n          id: playlist.id,\r\n          name: playlist.name,\r\n          type: 'playlist' as const,\r\n          inQueue\r\n        };\r\n      }\r\n    }).filter((f): f is FavoriteViewData => f !== null);\r\n\r\n    // Build tags list with selection state, ensuring selected and recent tags are visible\r\n    const tagSet = new Set(allTags);\r\n    this.filterState.selectedTags.forEach(t => tagSet.add(t));\r\n\r\n    const tags: TagViewData[] = Array.from(tagSet).sort().map(tag => {\r\n      // Normalize: ensure no leading #\r\n      const normalizedTag = tag.startsWith('#') ? tag.substring(1) : tag;\r\n      const isSelected = this.filterState.selectedTags.has(tag) || this.filterState.selectedTags.has(normalizedTag);\r\n      return {\r\n        name: normalizedTag, // Display name (without #)\r\n        value: normalizedTag, // Data value (also normalized for consistency)\r\n        selected: isSelected\r\n      };\r\n    });\r\n\r\n    // Build playlists with selection state\r\n    const playlistsViewData = playlists.map(p => ({\r\n      ...this.getPlaylistViewData(p),\r\n      selected: p.id === this.filterState.selectedPlaylistId\r\n    }));\r\n\r\n    // Check if any filters are active (if NOT all channels are selected, or other filters exist)\r\n    const allChannelsSelected = this.filterState.selectedChannels.size === 3; // Assuming 3 channels\r\n    const hasActiveFilters = !!(\r\n      this.filterState.searchQuery ||\r\n      !allChannelsSelected ||\r\n      this.filterState.selectedPlaylistId ||\r\n      this.filterState.selectedTags.size > 0\r\n    );\r\n\r\n    return {\r\n      items: items.map(item => this.getItemViewData(item)),\r\n      playlists: playlistsViewData,\r\n      favorites,\r\n      tags,\r\n      stats: {\r\n        totalItems: stats.totalItems,\r\n        favoriteItems: stats.favoriteItems,\r\n        playlists: stats.totalPlaylists,\r\n        tagCount: stats.tagCount\r\n      },\r\n      // Filter state for UI\r\n      searchQuery: this.filterState.searchQuery,\r\n      filters: {\r\n        music: this.filterState.selectedChannels.has('music'),\r\n        ambience: this.filterState.selectedChannels.has('ambience'),\r\n        sfx: this.filterState.selectedChannels.has('sfx')\r\n      },\r\n      selectedPlaylistId: this.filterState.selectedPlaylistId,\r\n      sortBy: this.filterState.sortBy,\r\n      hasActiveFilters\r\n    };\r\n  }\r\n\r\n  private getPlaylistViewData(playlist: Playlist): PlaylistViewData {\r\n    // Check if playlist is in queue\r\n    const inQueue = window.ASE?.queue?.getItems().some(\r\n      item => item.playlistId === playlist.id\r\n    ) ?? false;\r\n\r\n    return {\r\n      id: playlist.id,\r\n      name: playlist.name,\r\n      itemCount: playlist.items.length,\r\n      trackCount: playlist.items.length, // Alias for template\r\n      favorite: playlist.favorite,\r\n      inQueue,\r\n      selected: false\r\n    };\r\n  }\r\n\r\n  private getItemViewData(item: LibraryItem): LibraryItemViewData {\r\n    const inQueue = window.ASE?.queue?.hasItem(item.id) ?? false;\r\n    const durationFormatted = formatTime(item.duration);\r\n\r\n    // Get playback state from AudioEngine\r\n    const player = (window.ASE?.engine as any)?.getTrack?.(item.id);\r\n    const isPlaying = player?.state === 'playing';\r\n    const isPaused = player?.state === 'paused';\r\n\r\n    return {\r\n      id: item.id,\r\n      name: item.name,\r\n      url: item.url,\r\n      duration: durationFormatted,\r\n      durationFormatted,\r\n      durationSeconds: item.duration,\r\n      tags: item.tags,\r\n      favorite: item.favorite,\r\n      group: item.group || 'music',\r\n      inQueue,\r\n      isPlaying,\r\n      isPaused\r\n    };\r\n  }\r\n\r\n  private inferGroupFromTags(tags: string[]): string {\r\n    // Try to infer group from tags if possible\r\n    const lowerTags = tags.map(t => t.toLowerCase());\r\n    if (lowerTags.some(t => t.includes('music'))) return 'music';\r\n    if (lowerTags.some(t => t.includes('ambient') || t.includes('ambience'))) return 'ambience';\r\n    if (lowerTags.some(t => t.includes('sfx') || t.includes('effect'))) return 'sfx';\r\n    return 'music'; // default\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Filtering & Sorting\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private applyFilters(items: LibraryItem[]): LibraryItem[] {\r\n    let filtered = items;\r\n\r\n    // Search filter\r\n    if (this.filterState.searchQuery) {\r\n      const query = this.filterState.searchQuery.toLowerCase();\r\n      filtered = filtered.filter(item =>\r\n        item.name.toLowerCase().includes(query) ||\r\n        item.tags.some(tag => tag.toLowerCase().includes(query))\r\n      );\r\n    }\r\n\r\n    // Channel filter (OR logic: Show item if its group is in selectedChannels)\r\n    // If no channels selected, show all items (default behavior)\r\n    if (this.filterState.selectedChannels.size > 0) {\r\n      filtered = filtered.filter(item => {\r\n        const group = (item.group || 'music') as TrackGroup;\r\n        return this.filterState.selectedChannels.has(group);\r\n      });\r\n    }\r\n    // If no channels selected, show all items (don't filter)\r\n\r\n    // Playlist filter\r\n    if (this.filterState.selectedPlaylistId) {\r\n      const playlist = this.library.playlists.getPlaylist(this.filterState.selectedPlaylistId);\r\n      if (playlist) {\r\n        const playlistItemIds = new Set(playlist.items.map(i => i.libraryItemId));\r\n        filtered = filtered.filter(item => playlistItemIds.has(item.id));\r\n      }\r\n    }\r\n\r\n    // Tags filter (AND logic - show items that have ALL selected tags)\r\n    if (this.filterState.selectedTags.size > 0) {\r\n      const selectedTagsArray = Array.from(this.filterState.selectedTags);\r\n      filtered = filtered.filter(item =>\r\n        selectedTagsArray.every(tag => item.tags.includes(tag))\r\n      );\r\n    }\r\n\r\n    return filtered;\r\n  }\r\n\r\n  private applySorting(items: LibraryItem[]): LibraryItem[] {\r\n    const sorted = [...items];\r\n\r\n    switch (this.filterState.sortBy) {\r\n      case 'playable': {\r\n        // Sort by playback state: playing first, paused second, rest by date\r\n        const viewDataCache = new Map<string, LibraryItemViewData>();\r\n        for (const item of sorted) {\r\n          viewDataCache.set(item.id, this.getItemViewData(item));\r\n        }\r\n\r\n        sorted.sort((a, b) => {\r\n          const aData = viewDataCache.get(a.id)!;\r\n          const bData = viewDataCache.get(b.id)!;\r\n\r\n          // Priority: playing > paused > stopped\r\n          const aPriority = aData.isPlaying ? 2 : (aData.isPaused ? 1 : 0);\r\n          const bPriority = bData.isPlaying ? 2 : (bData.isPaused ? 1 : 0);\r\n\r\n          if (aPriority !== bPriority) {\r\n            return bPriority - aPriority; // Higher priority first\r\n          }\r\n\r\n          // If same state, sort by date (newest first)\r\n          return b.addedAt - a.addedAt;\r\n        });\r\n        break;\r\n      }\r\n      case 'name-asc':\r\n        sorted.sort((a, b) => a.name.localeCompare(b.name));\r\n        break;\r\n      case 'name-desc':\r\n        sorted.sort((a, b) => b.name.localeCompare(a.name));\r\n        break;\r\n      case 'date-asc':\r\n        sorted.sort((a, b) => a.addedAt - b.addedAt);\r\n        break;\r\n      case 'date-desc':\r\n        sorted.sort((a, b) => b.addedAt - a.addedAt);\r\n        break;\r\n      case 'duration-asc':\r\n        sorted.sort((a, b) => a.duration - b.duration);\r\n        break;\r\n      case 'duration-desc':\r\n        sorted.sort((a, b) => b.duration - a.duration);\r\n        break;\r\n    }\r\n\r\n    return sorted;\r\n  }\r\n\r\n  override activateListeners(html: JQuery): void {\r\n    super.activateListeners(html);\r\n\r\n    // Toolbar actions\r\n    html.find('[data-action=\"add-track\"]').on('click', this.onAddTrack.bind(this));\r\n    // Listen for KeyDown (Enter) for search execution\r\n    html.find('.ase-search-input').on('keydown', this.onSearchKeydown.bind(this));\r\n    // Listen for 'input' to manage X button visibility and auto-reset on empty\r\n    html.find('.ase-search-input').on('input', this.onSearchInput.bind(this));\r\n    html.find('.ase-search-clear').on('click', this.onClearSearch.bind(this));\r\n    html.find('[data-action=\"filter-channel\"]').on('click', this._onFilterChannel.bind(this));\r\n    html.find('[data-action=\"sort-change\"]').on('change', this.onChangeSort.bind(this));\r\n    html.find('[data-action=\"clear-filters\"]').on('click', this.onClearFilters.bind(this));\r\n\r\n    // Tag actions\r\n    html.find('[data-action=\"toggle-tag\"]').on('click', this.onToggleTag.bind(this));\r\n    html.find('[data-action=\"add-tag\"]').on('click', this.onAddTag.bind(this));\r\n\r\n    // Track actions\r\n    html.find('[data-action=\"play-track\"]').on('click', this.onPlayTrack.bind(this));\r\n    html.find('[data-action=\"pause-track\"]').on('click', this.onPauseTrack.bind(this));\r\n    html.find('[data-action=\"stop-track\"]').on('click', this.onStopTrack.bind(this));\r\n    html.find('[data-action=\"add-to-queue\"]').on('click', this.onAddToQueue.bind(this));\r\n    html.find('[data-action=\"toggle-favorite\"]').on('click', this.onToggleFavorite.bind(this));\r\n    html.find('[data-action=\"add-to-playlist\"]').on('click', this.onAddToPlaylist.bind(this));\r\n    html.find('[data-action=\"track-menu\"]').on('click', this.onTrackMenu.bind(this));\r\n\r\n    // In-track tag management\r\n    html.find('[data-action=\"add-tag-to-track\"]').on('click', this.onAddTagToTrack.bind(this));\r\n\r\n    // Channel dropdown\r\n    html.find('[data-action=\"channel-dropdown\"]').on('click', this.onChannelDropdown.bind(this));\r\n\r\n    // Delete track\r\n    html.find('[data-action=\"delete-track\"]').on('click', this.onDeleteTrack.bind(this));\r\n\r\n    // Track context menu (right-click)\r\n    html.find('.ase-track-player-item').on('contextmenu', this.onTrackContext.bind(this));\r\n\r\n    // Tag context menu on track (right-click on tag)\r\n    html.find('.ase-track-tags .ase-tag').on('contextmenu', this.onTrackTagContext.bind(this));\r\n\r\n    // Playlist actions\r\n    html.find('[data-action=\"select-playlist\"]').on('click', this.onSelectPlaylist.bind(this));\r\n    html.find('[data-action=\"create-playlist\"]').on('click', this.onCreatePlaylist.bind(this));\r\n    html.find('[data-action=\"toggle-playlist-favorite\"]').on('click', this.onTogglePlaylistFavorite.bind(this));\r\n    html.find('[data-action=\"toggle-playlist-queue\"]').on('click', this.onTogglePlaylistQueue.bind(this));\r\n    html.find('[data-action=\"playlist-menu\"]').on('click', this.onPlaylistMenu.bind(this));\r\n    html.find('.ase-list-item[data-playlist-id]').on('contextmenu', this.onPlaylistContext.bind(this));\r\n\r\n    // Favorite actions\r\n    html.find('[data-action=\"remove-from-favorites\"]').on('click', this.onRemoveFromFavorites.bind(this));\r\n    html.find('[data-action=\"toggle-favorite-queue\"]').on('click', this.onToggleFavoriteQueue.bind(this));\r\n\r\n    // Drag and drop\r\n    this.setupDragAndDrop(html);\r\n    this.setupFoundryDragDrop(html);\r\n\r\n    // Track hover highlighting for playlists\r\n    html.find('.ase-track-player-item').on('mouseenter', (event: JQuery.MouseEnterEvent) => {\r\n      const trackId = $(event.currentTarget).data('item-id');\r\n      if (trackId) {\r\n        this.highlightPlaylistsContainingTrack(trackId);\r\n      }\r\n    });\r\n\r\n    html.find('.ase-track-player-item').on('mouseleave', () => {\r\n      this.clearPlaylistHighlights();\r\n    });\r\n\r\n    // Custom Context Menu for GLOBAL tags only (in top panel)\r\n    html.find('.ase-tags-inline .ase-tag').on('contextmenu', this.onTagContext.bind(this));\r\n\r\n    Logger.debug('LocalLibraryApp listeners activated');\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Event Handlers\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async onAddTrack(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n\r\n    const fp = new FilePicker({\r\n      type: 'audio',\r\n      callback: async (path: string) => {\r\n        await this.addTrackFromPath(path);\r\n      }\r\n    });\r\n    fp.render(true);\r\n  }\r\n\r\n  private async addTrackFromPath(path: string, group: TrackGroup = 'music'): Promise<void> {\r\n    try {\r\n      // Get currently selected tags\r\n      const selectedTags = Array.from(this.filterState.selectedTags);\r\n\r\n      const item = await this.library.addItem(path, undefined, group, selectedTags);\r\n      this.persistScroll();\r\n      this.render();\r\n      ui.notifications?.info(`Added to library: ${item.name}`);\r\n    } catch (error) {\r\n      Logger.error('Failed to add track to library:', error);\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      ui.notifications?.error(`Failed to add track: ${errorMessage}`);\r\n    }\r\n  }\r\n\r\n  private async onToggleFavorite(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n\r\n    const btn = $(event.currentTarget);\r\n    const itemId = btn.closest('[data-item-id]').data('item-id') as string;\r\n\r\n    try {\r\n      // Optimistic UI update for instant feedback\r\n      const icon = btn.find('i');\r\n      if (icon.hasClass('far')) {\r\n        icon.removeClass('far').addClass('fas active');\r\n        btn.addClass('active');\r\n      } else {\r\n        icon.removeClass('fas active').addClass('far');\r\n        btn.removeClass('active');\r\n      }\r\n\r\n      this.persistScroll();\r\n      const isFavorite = this.library.toggleFavorite(itemId);\r\n\r\n      // We still re-render to update the sidebar/state fully, but the button interaction felt instant\r\n      this.render();\r\n      ui.notifications?.info(isFavorite ? 'Added to favorites' : 'Removed from favorites');\r\n    } catch (error) {\r\n      Logger.error('Failed to toggle favorite:', error);\r\n      ui.notifications?.error('Failed to update favorite status');\r\n    }\r\n  }\r\n\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Playlist Event Handlers\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async onCreatePlaylist(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n\r\n    const name = await this.promptPlaylistName();\r\n    if (!name) return;\r\n\r\n    try {\r\n      const playlist = this.library.playlists.createPlaylist(name);\r\n      // Create playlist -> might want to scroll to it? Or keep position?\r\n      // User: \"actions in zone of tracks\". Playlists are separate zone. \r\n      // But adding playlist shouldn't jump list to top? Let's persist.\r\n      this.persistScroll();\r\n      this.render();\r\n      ui.notifications?.info(`Created playlist: ${playlist.name}`);\r\n    } catch (error) {\r\n      Logger.error('Failed to create playlist:', error);\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      ui.notifications?.error(`Failed to create playlist: ${errorMessage}`);\r\n    }\r\n  }\r\n\r\n  private async onTogglePlaylistFavorite(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n\r\n    const playlistId = $(event.currentTarget).closest('[data-playlist-id]').data('playlist-id') as string;\r\n\r\n    try {\r\n      this.persistScroll();\r\n      const isFavorite = this.library.playlists.togglePlaylistFavorite(playlistId);\r\n      this.render();\r\n      ui.notifications?.info(isFavorite ? 'Added to favorites' : 'Removed from favorites');\r\n    } catch (error) {\r\n      Logger.error('Failed to toggle playlist favorite:', error);\r\n      ui.notifications?.error('Failed to update favorite status');\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Toolbar Event Handlers\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private onSearchInput(event: JQuery.TriggeredEvent): void {\r\n    const val = ($(event.currentTarget).val() as string || '');\r\n    const trimmedVal = val.trim();\r\n\r\n    // If field becomes empty and search was active, reset search\r\n    if (!trimmedVal && this.filterState.searchQuery) {\r\n      this.filterState.searchQuery = '';\r\n      this.render();\r\n    }\r\n  }\r\n\r\n  private onSearchKeydown(event: JQuery.KeyDownEvent): void {\r\n    if (event.key === 'Enter') {\r\n      event.preventDefault();\r\n      const query = ($(event.currentTarget).val() as string || '').trim().toLowerCase();\r\n      if (this.filterState.searchQuery !== query) {\r\n        this.filterState.searchQuery = query;\r\n        this.render();\r\n      }\r\n    }\r\n  }\r\n\r\n  private onClearSearch(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    this.filterState.searchQuery = '';\r\n    const wrapper = $(event.currentTarget).closest('.ase-search-input-wrapper');\r\n    wrapper.find('.ase-search-input').val('');\r\n    this.render(); // Re-render to show all items\r\n  }\r\n\r\n  private _onFilterChannel(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    const btn = $(event.currentTarget);\r\n    const channel = btn.data('channel') as TrackGroup;\r\n\r\n    // Toggle logic: If clicked, toggle it.\r\n    if (this.filterState.selectedChannels.has(channel)) {\r\n      this.filterState.selectedChannels.delete(channel);\r\n      btn.removeClass('active');\r\n    } else {\r\n      this.filterState.selectedChannels.add(channel);\r\n      btn.addClass('active');\r\n    }\r\n\r\n    // Pass true to force render because complex logic might need re-evaluation of the list\r\n    // OR implement client-side hiding for this too if feeling brave. \r\n    // Given 3 checkboxes, re-render is safer to ensure correct combinatorics.\r\n    this.render();\r\n    Logger.debug('Filter channel toggled:', channel, this.filterState.selectedChannels);\r\n  }\r\n\r\n  private onChangeSort(event: JQuery.ChangeEvent): void {\r\n    const sortValue = $(event.currentTarget).val() as FilterState['sortBy'];\r\n    this.filterState.sortBy = sortValue;\r\n    this.render();\r\n    Logger.debug('Sort changed:', sortValue);\r\n  }\r\n\r\n  private onClearFilters(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n\r\n    // Reset all filters except channels (as requested: \"clear button... resets all except sound channels\")\r\n    this.filterState.searchQuery = '';\r\n    this.filterState.selectedPlaylistId = null;\r\n    this.filterState.selectedTags.clear();\r\n\r\n    // channels remain as is? \"Kнопка clear... сбрасывает все фильтры кроме каналов звука\"\r\n    // \"All Tracks\" button usually means SHOW ALL. \r\n    // IF the button is named \"All Tracks\" (in template it is \"Clear Filters\" or similar?), let's verify.\r\n    // Template says: <button ... data-action=\"clear-filters\">All Tracks</button>\r\n    // So YES, it should reset eveything relative to \"viewing a slice\", but the user EXPLICITLY said:\r\n    // \"except sound channels... they work separately\".\r\n\r\n    // So we DO NOT reset selectedChannels.\r\n\r\n    this.render();\r\n    ui.notifications?.info('Filters cleared (Channels preserved)');\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Tag Event Handlers\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private onToggleTag(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    // Use the right click context menu for edit/delete\r\n    // Left click just toggles filter\r\n    const tag = String($(event.currentTarget).data('tag')); // String() fixes numeric coercion\r\n\r\n    console.log('[ASE] onToggleTag called with tag:', tag);\r\n    console.log('[ASE] Current selectedTags:', Array.from(this.filterState.selectedTags));\r\n\r\n    if (this.filterState.selectedTags.has(tag)) {\r\n      this.filterState.selectedTags.delete(tag);\r\n      console.log('[ASE] Tag deselected');\r\n    } else {\r\n      this.filterState.selectedTags.add(tag);\r\n      console.log('[ASE] Tag selected');\r\n    }\r\n\r\n    this.render();\r\n  }\r\n\r\n  private onTagContext(event: JQuery.ContextMenuEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const tag = String($(event.currentTarget).data('tag')); // String() fixes numeric coercion\r\n\r\n    // Create a custom context menu appended to body to avoid clipping\r\n    const menuHtml = `\r\n      <div id=\"ase-custom-context-menu\" style=\"position: fixed; z-index: 10000; background: #222; border: 1px solid #444; border-radius: 4px; padding: 5px 0;\">\r\n        <div class=\"ase-ctx-item\" data-action=\"edit\" style=\"padding: 5px 15px; cursor: pointer; color: white;\">\r\n            <i class=\"fas fa-edit\" style=\"margin-right: 5px;\"></i> Edit\r\n        </div>\r\n        <div class=\"ase-ctx-item\" data-action=\"delete\" style=\"padding: 5px 15px; cursor: pointer; color: #ff6666;\">\r\n            <i class=\"fas fa-trash\" style=\"margin-right: 5px;\"></i> Delete\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n    // Remove existing\r\n    $('#ase-custom-context-menu').remove();\r\n\r\n    const menu = $(menuHtml);\r\n    $('body').append(menu);\r\n\r\n    // Position\r\n    menu.css({\r\n      top: event.clientY,\r\n      left: event.clientX\r\n    });\r\n\r\n    // Handlers\r\n    menu.find('[data-action=\"edit\"]').on('click', () => {\r\n      this.renameTag(tag);\r\n      menu.remove();\r\n    });\r\n\r\n    menu.find('[data-action=\"delete\"]').on('click', () => {\r\n      this.deleteTag(tag);\r\n      menu.remove();\r\n    });\r\n\r\n    // Initial Hover effect\r\n    menu.find('.ase-ctx-item').hover(\r\n      function () { $(this).css('background', '#333'); },\r\n      function () { $(this).css('background', 'transparent'); }\r\n    );\r\n\r\n    // Close on click elsewhere\r\n    $(document).one('click', () => {\r\n      menu.remove();\r\n    });\r\n\r\n    console.log('Opened context menu for tag:', tag);\r\n  }\r\n\r\n  private async onAddTag(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n\r\n    const rawTagName = await this.promptTagName();\r\n    if (!rawTagName) return;\r\n\r\n    // Normalize: trim and remove leading # if user added it\r\n    const tagName = rawTagName.trim().replace(/^#/, '');\r\n    if (!tagName) return;\r\n\r\n    console.log('[ASE] onAddTag: normalized tagName =', tagName);\r\n\r\n    // Add to selectedTags for immediate visual feedback\r\n    this.filterState.selectedTags.add(tagName);\r\n\r\n    // Add to library persistent tags\r\n    this.library.addCustomTag(tagName);\r\n\r\n    console.log('[ASE] onAddTag: selectedTags now =', Array.from(this.filterState.selectedTags));\r\n    console.log('[ASE] onAddTag: allTags from library =', this.library.getAllTags());\r\n\r\n    this.render();\r\n    ui.notifications?.info(`Tag \"${tagName}\" added.`);\r\n  }\r\n\r\n  // Helper for Context Menu Callbacks to ensure `this` binding and argument passing\r\n  private _onRenameTag(header: JQuery): void {\r\n    const tag = header.data('tag');\r\n    this.renameTag(tag);\r\n  }\r\n\r\n  private _onDeleteTag(header: JQuery): void {\r\n    const tag = header.data('tag');\r\n    this.deleteTag(tag);\r\n  }\r\n\r\n  // Correcting selector/listener activation for Context Menu if needed\r\n  // Foundry ContextMenu usually works fine. If z-index issue, it's CSS.\r\n  // We will force high z-index via CSS injection or ensure fixed position.\r\n  // BUT: user said \"Buttons don't work\". \r\n  // This usually means the callback failed or `this` yielded undefined.\r\n  // The inline arrow functions `() => this.renameTag(tag)` in `activateListeners` SHOULD be fine if `this` is correct.\r\n  // Let's verify `activateListeners`.\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Tag Management Logic\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async renameTag(oldTag: string): Promise<void> {\r\n    const newTag = await this.promptTagName(oldTag);\r\n    if (!newTag || newTag === oldTag) return;\r\n\r\n    // Use LibraryManager's method\r\n    const count = this.library.renameTag(oldTag, newTag);\r\n\r\n    // Also update filter state if selected\r\n    if (this.filterState.selectedTags.has(oldTag)) {\r\n      this.filterState.selectedTags.delete(oldTag);\r\n      this.filterState.selectedTags.add(newTag);\r\n    }\r\n\r\n    if (count > 0) {\r\n      // Renaming tag does not necessarily keep scroll unless it was a tag list interaction?\r\n      // User said \"zone of tracks with tracks\". Tag list is separate. \r\n      // But renaming right from track context menu? Let's enabling it generally.\r\n      // Actually user said \"zone of tracks\". Let's persist.\r\n      this.persistScroll();\r\n      this.render();\r\n      ui.notifications?.info(`Renamed tag \"${oldTag}\" to \"${newTag}\" on ${count} tracks.`);\r\n    }\r\n  }\r\n\r\n  private async deleteTag(tag: string): Promise<void> {\r\n    const tagStr = String(tag); // Ensure string for numeric tags\r\n    console.log('[ASE] deleteTag called for:', tagStr);\r\n\r\n    const confirm = await Dialog.confirm({\r\n      title: \"Delete Tag\",\r\n      content: `Are you sure you want to delete tag \"${tagStr}\" from all tracks?`\r\n    });\r\n    if (!confirm) return;\r\n\r\n    // Use LibraryManager's method\r\n    const count = this.library.deleteTag(tagStr);\r\n\r\n    // Remove from filter\r\n    this.filterState.selectedTags.delete(tagStr);\r\n\r\n    // Always re-render\r\n    this.persistScroll();\r\n    this.render();\r\n    ui.notifications?.info(count > 0 ? `Deleted tag \"${tagStr}\" from ${count} tracks.` : `Deleted custom tag \"${tagStr}\".`);\r\n  }\r\n\r\n  private async promptTagName(current: string = \"\"): Promise<string | null> {\r\n    return new Promise((resolve) => {\r\n      new Dialog({\r\n        title: current ? \"Rename Tag\" : \"New Tag\",\r\n        content: `<input type=\"text\" id=\"tag-name\" value=\"${current}\" style=\"width:100%;box-sizing:border-box;\"/>`,\r\n        buttons: {\r\n          ok: {\r\n            label: \"OK\",\r\n            callback: (html: JQuery) => resolve(html.find('#tag-name').val() as string)\r\n          }\r\n        },\r\n        default: \"ok\",\r\n        close: () => resolve(null)\r\n      }).render(true);\r\n    });\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Track Event Handlers (Extended)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async onPlayTrack(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const itemId = $(event.currentTarget).data('item-id') as string;\r\n\r\n    Logger.debug('Play track:', itemId);\r\n\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) {\r\n      Logger.warn('Track not found:', itemId);\r\n      return;\r\n    }\r\n\r\n    // Get engine and queue from window.ASE\r\n    const engine = window.ASE?.engine;\r\n    const queue = window.ASE?.queue;\r\n\r\n    if (!engine) {\r\n      Logger.warn('Audio engine not available');\r\n      return;\r\n    }\r\n\r\n    // Add to queue if not already there\r\n    if (queue && !queue.hasItem(itemId)) {\r\n      queue.addItem(itemId, {\r\n        group: item.group,\r\n        volume: 1,\r\n        loop: false\r\n      });\r\n    }\r\n\r\n    // Get or create player\r\n    let player = (engine as any).getTrack?.(itemId);\r\n    if (!player) {\r\n      player = await (engine as any).createTrack?.({\r\n        id: itemId,\r\n        url: item.url,\r\n        group: item.group,\r\n        volume: 1,\r\n        loop: false\r\n      });\r\n    }\r\n\r\n    // Check if track is paused and get current position\r\n    let offset = 0;\r\n    if (player && player.state === 'paused') {\r\n      offset = player.getCurrentTime();\r\n    }\r\n\r\n    // Play the track (resume from offset if paused)\r\n    await (engine as any).playTrack?.(itemId, offset);\r\n\r\n    // Sync if enabled\r\n    const socket = window.ASE?.socket;\r\n    if (socket && socket.syncEnabled) {\r\n      Logger.debug('LocalLibrary: Broadcasting Play for track', itemId);\r\n      socket.broadcastTrackPlay(itemId, offset);\r\n    }\r\n\r\n    this.persistScroll();\r\n    this.render();\r\n  }\r\n\r\n  private onStopTrack(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const itemId = $(event.currentTarget).data('item-id') as string;\r\n\r\n    Logger.debug('Stop track:', itemId);\r\n\r\n    // Stop the track\r\n    window.ASE.engine?.stopTrack(itemId);\r\n\r\n    // Sync if enabled\r\n    const socket = window.ASE?.socket;\r\n    if (socket && socket.syncEnabled) {\r\n      socket.broadcastTrackStop(itemId);\r\n    }\r\n\r\n    // Remove from queue\r\n    if (window.ASE?.queue) {\r\n      window.ASE.queue.removeByLibraryItemId(itemId);\r\n    }\r\n\r\n    this.persistScroll();\r\n    this.render();\r\n  }\r\n\r\n  private onPauseTrack(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const itemId = $(event.currentTarget).data('item-id') as string;\r\n    console.log('[ASE DEBUG] onPauseTrack called for:', itemId);\r\n\r\n    // Get current time before pausing for sync\r\n    const engine = window.ASE?.engine;\r\n    const player = (engine as any)?.getTrack?.(itemId);\r\n    const currentTime = player?.getCurrentTime() ?? 0;\r\n    console.log('[ASE DEBUG] Pause - currentTime:', currentTime, 'player state:', player?.state);\r\n\r\n    engine?.pauseTrack(itemId);\r\n\r\n    // Sync if enabled\r\n    const socket = window.ASE?.socket;\r\n    console.log('[ASE DEBUG] Socket syncEnabled:', socket?.syncEnabled);\r\n    if (socket && socket.syncEnabled) {\r\n      console.log('[ASE DEBUG] Broadcasting pause for', itemId);\r\n      socket.broadcastTrackPause(itemId, currentTime);\r\n    }\r\n\r\n    this.persistScroll();\r\n    this.render(); // Update UI and bottom panel indicators\r\n  }\r\n\r\n  private onAddToQueue(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const itemId = String($(event.currentTarget).data('item-id'));\r\n\r\n    if (!window.ASE?.queue) {\r\n      Logger.warn('Queue manager not available');\r\n      return;\r\n    }\r\n\r\n    // Get item details to determine group\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) {\r\n      Logger.warn('Item not found:', itemId);\r\n      return;\r\n    }\r\n\r\n    // Toggle: if already in queue, remove; otherwise add\r\n    if (window.ASE.queue.hasItem(itemId)) {\r\n      window.ASE.queue.removeByLibraryItemId(itemId);\r\n      Logger.debug('Removed from queue:', itemId);\r\n      ui.notifications?.info(`\"${item.name}\" removed from queue`);\r\n    } else {\r\n      window.ASE.queue.addItem(itemId, {\r\n        group: item.group || 'music',\r\n        volume: 1,\r\n        loop: false\r\n      });\r\n      Logger.debug('Added to queue:', itemId);\r\n      ui.notifications?.info(`\"${item.name}\" added to queue`);\r\n    }\r\n\r\n    this.persistScroll();\r\n    this.render();\r\n  }\r\n\r\n  private async onAddTagToTrack(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const itemId = $(event.currentTarget).data('item-id') as string;\r\n    Logger.debug('Add tag to track:', itemId);\r\n\r\n    // Open tag editor dialog\r\n    this.showTagEditor(itemId);\r\n  }\r\n\r\n  private async onAddToPlaylist(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const itemId = $(event.currentTarget).data('item-id') as string;\r\n    const item = this.library.getItem(itemId);\r\n\r\n    if (!item) {\r\n      ui.notifications?.error('Track not found');\r\n      return;\r\n    }\r\n\r\n    const playlists = this.library.playlists.getAllPlaylists();\r\n    if (playlists.length === 0) {\r\n      ui.notifications?.warn('No playlists available. Create one first.');\r\n      return;\r\n    }\r\n\r\n    // Show playlist selection dialog\r\n    const selectedPlaylistId = await this.promptPlaylistSelection(playlists);\r\n    if (!selectedPlaylistId) return;\r\n\r\n    try {\r\n      const group = this.inferGroupFromTags(item.tags) as TrackGroup;\r\n      this.library.playlists.addTrackToPlaylist(selectedPlaylistId, itemId, group);\r\n      this.render();\r\n      ui.notifications?.info(`Added \"${item.name}\" to playlist`);\r\n    } catch (error) {\r\n      Logger.error('Failed to add track to playlist:', error);\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      ui.notifications?.error(`Failed to add to playlist: ${errorMessage}`);\r\n    }\r\n  }\r\n\r\n  private onTrackMenu(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    // Context menu is now handled by right-click\r\n    // This button can trigger the same menu programmatically\r\n    const itemId = $(event.currentTarget).data('item-id') as string;\r\n    const trackElement = $(event.currentTarget).closest('.ase-track-player-item');\r\n\r\n    // Trigger a contextmenu event on the track item\r\n    const contextMenuEvent = new MouseEvent('contextmenu', {\r\n      bubbles: true,\r\n      cancelable: true,\r\n      view: window,\r\n      clientX: event.clientX,\r\n      clientY: event.clientY\r\n    });\r\n    trackElement[0]?.dispatchEvent(contextMenuEvent);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Favorites Event Handlers\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private onRemoveFromFavorites(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n\r\n    const favoriteId = String($(event.currentTarget).data('favorite-id'));\r\n    const favoriteType = String($(event.currentTarget).data('favorite-type'));\r\n\r\n    Logger.debug('Remove from favorites:', favoriteId, favoriteType);\r\n\r\n    if (favoriteType === 'playlist') {\r\n      const playlist = this.library.playlists.getPlaylist(favoriteId);\r\n      if (playlist) {\r\n        this.library.playlists.updatePlaylist(favoriteId, { favorite: false });\r\n        ui.notifications?.info(`Removed \"${playlist.name}\" from favorites`);\r\n      }\r\n    } else {\r\n      const item = this.library.getItem(favoriteId);\r\n      if (item) {\r\n        this.library.toggleFavorite(favoriteId);\r\n        ui.notifications?.info(`Removed \"${item.name}\" from favorites`);\r\n      }\r\n    }\r\n\r\n    this.persistScroll();\r\n    this.render();\r\n  }\r\n\r\n  private onToggleFavoriteQueue(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n\r\n    const favoriteId = String($(event.currentTarget).data('favorite-id'));\r\n    const favoriteType = String($(event.currentTarget).data('favorite-type'));\r\n\r\n    if (!window.ASE?.queue) {\r\n      Logger.warn('Queue manager not available');\r\n      return;\r\n    }\r\n\r\n    if (favoriteType === 'playlist') {\r\n      // Delegate to playlist queue handler\r\n      const playlist = this.library.playlists.getPlaylist(favoriteId);\r\n      if (!playlist) return;\r\n\r\n      const inQueue = window.ASE.queue.getItems().some(item => item.playlistId === favoriteId);\r\n\r\n      if (inQueue) {\r\n        const itemsToRemove = window.ASE.queue.getItems().filter(item => item.playlistId === favoriteId);\r\n        itemsToRemove.forEach(item => window.ASE!.queue!.removeItem(item.id));\r\n        ui.notifications?.info(`Removed \"${playlist.name}\" from queue`);\r\n      } else {\r\n        const playlistItems = playlist.items.map(pItem => ({\r\n          libraryItemId: pItem.libraryItemId,\r\n          group: pItem.group || 'music' as const,\r\n          volume: pItem.volume,\r\n          loop: pItem.loop\r\n        }));\r\n        window.ASE.queue.addPlaylist(favoriteId, playlistItems);\r\n        ui.notifications?.info(`Added \"${playlist.name}\" to queue`);\r\n      }\r\n    } else {\r\n      // Track\r\n      const item = this.library.getItem(favoriteId);\r\n      if (!item) return;\r\n\r\n      const inQueue = window.ASE.queue.hasItem(favoriteId);\r\n\r\n      if (inQueue) {\r\n        const queueItems = window.ASE.queue.getItems().filter(q => q.libraryItemId === favoriteId);\r\n        queueItems.forEach(q => window.ASE!.queue!.removeItem(q.id));\r\n        ui.notifications?.info(`Removed \"${item.name}\" from queue`);\r\n      } else {\r\n        window.ASE.queue.addItem(favoriteId, {\r\n          group: this.inferGroupFromTags(item.tags) as any,\r\n          volume: 1,\r\n          loop: false\r\n        });\r\n        ui.notifications?.info(`Added \"${item.name}\" to queue`);\r\n      }\r\n    }\r\n\r\n    this.persistScroll();\r\n    this.render();\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Track Control Handlers\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private onChannelDropdown(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n\r\n    const itemId = String($(event.currentTarget).data('item-id'));\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) return;\r\n\r\n    const currentGroup = item.group || 'music';\r\n    const channels = ['music', 'ambience', 'sfx'];\r\n\r\n    // Create dropdown menu\r\n    const menu = $(`\r\n      <div class=\"ase-dropdown-menu\" style=\"position: fixed; z-index: 9999; background: #1e283d; border: 1px solid #334155; border-radius: 4px; min-width: 100px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);\">\r\n        ${channels.map(ch => `\r\n          <div class=\"ase-dropdown-item\" data-channel=\"${ch}\" style=\"padding: 8px 12px; cursor: pointer; color: ${ch === currentGroup ? 'var(--accent-cyan)' : '#94a3b8'}; font-size: 12px;\">\r\n            ${ch.charAt(0).toUpperCase() + ch.slice(1)}\r\n          </div>\r\n        `).join('')}\r\n      </div>\r\n    `);\r\n\r\n    const rect = (event.currentTarget as HTMLElement).getBoundingClientRect();\r\n    menu.css({ top: rect.bottom + 2, left: rect.left });\r\n\r\n    $('body').append(menu);\r\n\r\n    menu.find('.ase-dropdown-item').on('click', (e) => {\r\n      const newChannel = $(e.currentTarget).data('channel') as string;\r\n      this.updateTrackChannel(itemId, newChannel);\r\n      menu.remove();\r\n    });\r\n\r\n    // Close on outside click\r\n    setTimeout(() => {\r\n      $(document).one('click', () => menu.remove());\r\n    }, 10);\r\n  }\r\n\r\n  private updateTrackChannel(itemId: string, channel: string): void {\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) return;\r\n\r\n    // Update group field directly (not as a tag)\r\n    this.library.updateItem(itemId, { group: channel as TrackGroup });\r\n    this.persistScroll();\r\n    this.render();\r\n    ui.notifications?.info(`Channel set to ${channel}`);\r\n  }\r\n\r\n  private onDeleteTrack(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n\r\n    const itemId = String($(event.currentTarget).data('item-id'));\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) return;\r\n\r\n    const isInPlaylist = !!this.filterState.selectedPlaylistId;\r\n\r\n    const dialogData: any = {\r\n      title: isInPlaylist ? 'Manage Track' : 'Delete Track',\r\n      content: `<p>${isInPlaylist ? `What would you like to do with \"${item.name}\"?` : `Are you sure you want to delete \"${item.name}\"?`}</p>`,\r\n      buttons: {},\r\n      default: 'cancel'\r\n    };\r\n\r\n    if (isInPlaylist) {\r\n      dialogData.buttons.removeFromPlaylist = {\r\n        icon: '<i class=\"fas fa-minus-circle\"></i>',\r\n        label: 'Remove from Playlist',\r\n        callback: () => {\r\n          if (this.filterState.selectedPlaylistId) {\r\n            this.removeTrackFromPlaylist(this.filterState.selectedPlaylistId, itemId);\r\n          }\r\n        }\r\n      };\r\n    }\r\n\r\n    dialogData.buttons.delete = {\r\n      icon: '<i class=\"fas fa-trash\"></i>',\r\n      label: isInPlaylist ? 'Delete Track (Global)' : 'Delete',\r\n      callback: () => {\r\n        this.library.removeItem(itemId);\r\n        this.persistScroll();\r\n        this.render();\r\n        ui.notifications?.info(`Deleted \"${item.name}\"`);\r\n      }\r\n    };\r\n\r\n    dialogData.buttons.cancel = {\r\n      icon: '<i class=\"fas fa-times\"></i>',\r\n      label: 'Cancel'\r\n    };\r\n\r\n    new Dialog(dialogData).render(true);\r\n  }\r\n\r\n  private onTrackContext(event: JQuery.ContextMenuEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n\r\n    const itemId = String($(event.currentTarget).data('item-id'));\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) return;\r\n\r\n    // Remove existing menus\r\n    $('.ase-context-menu').remove();\r\n\r\n    const isInPlaylist = !!this.filterState.selectedPlaylistId;\r\n    const deleteLabel = 'Delete Track';\r\n\r\n    let menuHtml = `\r\n      <div class=\"ase-context-menu\" style=\"position: fixed; z-index: 9999; background: #1e283d; border: 1px solid #334155; border-radius: 4px; min-width: 150px; box-shadow: 0 4px 12px rgba(0,0,0,0.4);\">\r\n        <div class=\"ase-menu-item\" data-action=\"rename\" style=\"padding: 8px 12px; cursor: pointer; color: #e5e5e5; font-size: 12px;\">\r\n          <i class=\"fa-solid fa-pen\" style=\"width: 16px;\"></i> Rename\r\n        </div>\r\n        <div class=\"ase-menu-item\" data-action=\"add-to-playlist\" style=\"padding: 8px 12px; cursor: pointer; color: #e5e5e5; font-size: 12px;\">\r\n          <i class=\"fa-solid fa-list\" style=\"width: 16px;\"></i> Add to Playlist\r\n        </div>`;\r\n\r\n    if (isInPlaylist) {\r\n      menuHtml += `\r\n        <div class=\"ase-menu-item\" data-action=\"remove-from-playlist\" style=\"padding: 8px 12px; cursor: pointer; color: #e5e5e5; font-size: 12px;\">\r\n          <i class=\"fa-solid fa-minus-circle\" style=\"width: 16px;\"></i> Remove from Playlist\r\n        </div>`;\r\n    }\r\n\r\n    menuHtml += `\r\n        <div class=\"ase-menu-item\" data-action=\"edit-tags\" style=\"padding: 8px 12px; cursor: pointer; color: #e5e5e5; font-size: 12px;\">\r\n          <i class=\"fa-solid fa-tags\" style=\"width: 16px;\"></i> Edit Tags\r\n        </div>\r\n        <div style=\"border-top: 1px solid #334155; margin: 4px 0;\"></div>\r\n        <div class=\"ase-menu-item\" data-action=\"delete\" style=\"padding: 8px 12px; cursor: pointer; color: #f87171; font-size: 12px;\">\r\n          <i class=\"fa-solid fa-trash\" style=\"width: 16px;\"></i> ${deleteLabel}\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n    const menu = $(menuHtml);\r\n\r\n    menu.css({ top: event.clientY, left: event.clientX });\r\n    $('body').append(menu);\r\n\r\n    menu.find('.ase-menu-item').on('mouseenter', (e) => $(e.currentTarget).css('background', '#2d3a52'));\r\n    menu.find('.ase-menu-item').on('mouseleave', (e) => $(e.currentTarget).css('background', 'transparent'));\r\n\r\n    menu.find('[data-action=\"rename\"]').on('click', async () => {\r\n      menu.remove();\r\n      await this.renameTrack(itemId);\r\n    });\r\n\r\n    menu.find('[data-action=\"add-to-playlist\"]').on('click', async () => {\r\n      menu.remove();\r\n      await this.addTrackToPlaylistDialog(itemId);\r\n    });\r\n\r\n    if (isInPlaylist) {\r\n      menu.find('[data-action=\"remove-from-playlist\"]').on('click', async () => {\r\n        menu.remove();\r\n        if (this.filterState.selectedPlaylistId) {\r\n          await this.removeTrackFromPlaylist(this.filterState.selectedPlaylistId, itemId);\r\n        }\r\n      });\r\n    }\r\n\r\n    menu.find('[data-action=\"edit-tags\"]').on('click', () => {\r\n      menu.remove();\r\n      this.showTagEditor(itemId);\r\n    });\r\n\r\n    menu.find('[data-action=\"delete\"]').on('click', () => {\r\n      menu.remove();\r\n      this.onDeleteTrack({ preventDefault: () => { }, stopPropagation: () => { }, currentTarget: $(`<div data-item-id=\"${itemId}\">`)[0] } as any);\r\n    });\r\n\r\n    setTimeout(() => {\r\n      $(document).one('click', () => menu.remove());\r\n    }, 10);\r\n  }\r\n\r\n  private onTrackTagContext(event: JQuery.ContextMenuEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n\r\n    const tagName = String($(event.currentTarget).data('tag'));\r\n    const itemId = String($(event.currentTarget).data('item-id'));\r\n\r\n    $('.ase-context-menu').remove();\r\n\r\n    const menu = $(`\r\n      <div class=\"ase-context-menu\" style=\"position: fixed; z-index: 9999; background: #1e283d; border: 1px solid #334155; border-radius: 4px; min-width: 120px; box-shadow: 0 4px 12px rgba(0,0,0,0.4);\">\r\n        <div class=\"ase-menu-item\" data-action=\"remove-tag\" style=\"padding: 8px 12px; cursor: pointer; color: #f87171; font-size: 12px;\">\r\n          <i class=\"fa-solid fa-times\" style=\"width: 16px;\"></i> Remove Tag\r\n        </div>\r\n      </div>\r\n    `);\r\n\r\n    menu.css({ top: event.clientY, left: event.clientX });\r\n    $('body').append(menu);\r\n\r\n    menu.find('.ase-menu-item').on('mouseenter', (e) => $(e.currentTarget).css('background', '#2d3a52'));\r\n    menu.find('.ase-menu-item').on('mouseleave', (e) => $(e.currentTarget).css('background', 'transparent'));\r\n\r\n    menu.find('[data-action=\"remove-tag\"]').on('click', () => {\r\n      menu.remove();\r\n      this.library.removeTagFromItem(itemId, tagName);\r\n      this.persistScroll();\r\n      this.render();\r\n      ui.notifications?.info(`Removed tag \"${tagName}\"`);\r\n    });\r\n\r\n    setTimeout(() => {\r\n      $(document).one('click', () => menu.remove());\r\n    }, 10);\r\n  }\r\n\r\n  private async renameTrack(itemId: string): Promise<void> {\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) return;\r\n\r\n    const newName = await this.promptInput('Rename Track', 'Track Name:', item.name);\r\n    if (newName && newName !== item.name) {\r\n      this.library.updateItem(itemId, { name: newName });\r\n      this.persistScroll();\r\n      this.render();\r\n      ui.notifications?.info(`Renamed to \"${newName}\"`);\r\n    }\r\n  }\r\n\r\n  private async addTrackToPlaylistDialog(itemId: string): Promise<void> {\r\n    const playlists = this.library.playlists.getAllPlaylists();\r\n    if (playlists.length === 0) {\r\n      ui.notifications?.warn('No playlists available. Create one first.');\r\n      return;\r\n    }\r\n\r\n    const selectedPlaylistId = await this.promptPlaylistSelection(playlists);\r\n    if (!selectedPlaylistId) return;\r\n\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) return;\r\n\r\n    const group = this.inferGroupFromTags(item.tags) as TrackGroup;\r\n    this.library.playlists.addTrackToPlaylist(selectedPlaylistId, itemId, group);\r\n    this.persistScroll();\r\n    this.render();\r\n    ui.notifications?.info(`Added \"${item.name}\" to playlist`);\r\n  }\r\n\r\n  private showTagEditor(itemId: string): void {\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) return;\r\n\r\n    const allTags = this.library.getAllTags();\r\n    const currentTags = new Set(item.tags);\r\n\r\n    const content = `\r\n      <form>\r\n        <div style=\"max-height: 300px; overflow-y: auto;\">\r\n          ${allTags.map(tag => `\r\n            <div class=\"form-group\" style=\"margin: 5px 0;\">\r\n              <label style=\"display: flex; align-items: center; gap: 8px; cursor: pointer;\">\r\n                <input type=\"checkbox\" name=\"tag\" value=\"${tag}\" ${currentTags.has(tag) ? 'checked' : ''}>\r\n                <span>#${tag}</span>\r\n              </label>\r\n            </div>\r\n          `).join('')}\r\n        </div>\r\n        <div class=\"form-group\" style=\"margin-top: 10px;\">\r\n          <input type=\"text\" name=\"newTag\" placeholder=\"Add new tag...\" style=\"width: 100%;\">\r\n        </div>\r\n      </form>\r\n    `;\r\n\r\n    new Dialog({\r\n      title: `Edit Tags: ${item.name}`,\r\n      content,\r\n      buttons: {\r\n        save: {\r\n          icon: '<i class=\"fas fa-save\"></i>',\r\n          label: 'Save',\r\n          callback: (html: JQuery) => {\r\n            const selectedTags: string[] = [];\r\n            html.find('input[name=\"tag\"]:checked').each((_, el) => {\r\n              selectedTags.push($(el).val() as string);\r\n            });\r\n\r\n            const newTag = (html.find('input[name=\"newTag\"]').val() as string)?.trim();\r\n            if (newTag) {\r\n              selectedTags.push(newTag);\r\n              this.library.addCustomTag(newTag);\r\n            }\r\n\r\n            this.library.updateItem(itemId, { tags: selectedTags });\r\n            this.persistScroll();\r\n            this.render();\r\n          }\r\n        },\r\n        cancel: {\r\n          icon: '<i class=\"fas fa-times\"></i>',\r\n          label: 'Cancel'\r\n        }\r\n      },\r\n      default: 'save'\r\n    }).render(true);\r\n  }\r\n\r\n  private async promptInput(title: string, label: string, defaultValue: string = ''): Promise<string | null> {\r\n    return new Promise((resolve) => {\r\n      new Dialog({\r\n        title,\r\n        content: `\r\n          <form>\r\n            <div class=\"form-group\">\r\n              <label>${label}</label>\r\n              <input type=\"text\" name=\"input\" value=\"${defaultValue}\" autofocus style=\"width: 100%;\">\r\n            </div>\r\n          </form>\r\n        `,\r\n        buttons: {\r\n          ok: {\r\n            icon: '<i class=\"fas fa-check\"></i>',\r\n            label: 'OK',\r\n            callback: (html: JQuery) => {\r\n              const value = html.find('input[name=\"input\"]').val() as string;\r\n              resolve(value?.trim() || null);\r\n            }\r\n          },\r\n          cancel: {\r\n            icon: '<i class=\"fas fa-times\"></i>',\r\n            label: 'Cancel',\r\n            callback: () => resolve(null)\r\n          }\r\n        },\r\n        default: 'ok'\r\n      }).render(true);\r\n    });\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Playlist Event Handlers (Extended)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private onSelectPlaylist(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    const playlistId = $(event.currentTarget).data('playlist-id') as string;\r\n\r\n    // Toggle playlist filter\r\n    if (this.filterState.selectedPlaylistId === playlistId) {\r\n      // Deselect if clicking the same playlist\r\n      this.filterState.selectedPlaylistId = null;\r\n    } else {\r\n      this.filterState.selectedPlaylistId = playlistId;\r\n    }\r\n\r\n    this.render();\r\n    Logger.debug('Select playlist:', playlistId);\r\n  }\r\n\r\n  private onPlaylistMenu(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    // Context menu is now handled by right-click\r\n    // This button can trigger the same menu programmatically\r\n    const playlistId = $(event.currentTarget).data('playlist-id') as string;\r\n    const playlistElement = $(event.currentTarget).closest('.ase-list-item');\r\n\r\n    // Trigger a contextmenu event on the playlist item\r\n    const contextMenuEvent = new MouseEvent('contextmenu', {\r\n      bubbles: true,\r\n      cancelable: true,\r\n      view: window,\r\n      clientX: event.clientX,\r\n      clientY: event.clientY\r\n    });\r\n    playlistElement[0]?.dispatchEvent(contextMenuEvent);\r\n  }\r\n\r\n  private onTogglePlaylistQueue(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n\r\n    const playlistId = String($(event.currentTarget).data('playlist-id'));\r\n    const playlist = this.library.playlists.getPlaylist(playlistId);\r\n\r\n    if (!playlist || !window.ASE?.queue) {\r\n      Logger.warn('Cannot toggle playlist queue: playlist or queue not available');\r\n      return;\r\n    }\r\n\r\n    // Check if already in queue (by playlistId)\r\n    const inQueue = window.ASE.queue.getItems().some(item => item.playlistId === playlistId);\r\n\r\n    if (inQueue) {\r\n      // Remove all items from this playlist\r\n      const itemsToRemove = window.ASE.queue.getItems().filter(item => item.playlistId === playlistId);\r\n      itemsToRemove.forEach(item => window.ASE!.queue!.removeItem(item.id));\r\n      ui.notifications?.info(`Removed \"${playlist.name}\" from queue`);\r\n    } else {\r\n      // Add all playlist items to queue\r\n      const playlistItems = playlist.items.map(pItem => {\r\n        const libraryItem = this.library.getItem(pItem.libraryItemId);\r\n        return {\r\n          libraryItemId: pItem.libraryItemId,\r\n          group: pItem.group || 'music' as const,\r\n          volume: pItem.volume,\r\n          loop: pItem.loop\r\n        };\r\n      }).filter(item => item.libraryItemId);\r\n\r\n      window.ASE.queue.addPlaylist(playlistId, playlistItems);\r\n      ui.notifications?.info(`Added \"${playlist.name}\" (${playlist.items.length} tracks) to queue`);\r\n    }\r\n\r\n    this.render();\r\n  }\r\n\r\n  private onPlaylistContext(event: JQuery.ContextMenuEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n\r\n    const playlistId = String($(event.currentTarget).data('playlist-id'));\r\n    const playlist = this.library.playlists.getPlaylist(playlistId);\r\n\r\n    if (!playlist) return;\r\n\r\n    // Create a custom context menu appended to body to avoid clipping\r\n\r\n    const menuHtml = `\r\n      <div id=\"ase-custom-context-menu\" style=\"position: fixed; z-index: 10000; background: #222; border: 1px solid #444; border-radius: 4px; padding: 5px 0;\">\r\n        <div class=\"ase-ctx-item\" data-action=\"edit\" style=\"padding: 5px 15px; cursor: pointer; color: white;\">\r\n            <i class=\"fas fa-edit\" style=\"margin-right: 5px;\"></i> Rename\r\n        </div>\r\n        <div class=\"ase-ctx-item\" data-action=\"delete\" style=\"padding: 5px 15px; cursor: pointer; color: #ff6666;\">\r\n            <i class=\"fas fa-trash\" style=\"margin-right: 5px;\"></i> Delete\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n    // Remove existing\r\n    $('#ase-custom-context-menu').remove();\r\n\r\n    const menu = $(menuHtml);\r\n    $('body').append(menu);\r\n\r\n    // Position\r\n    menu.css({\r\n      top: event.clientY,\r\n      left: event.clientX\r\n    });\r\n\r\n    // Hover effect\r\n    menu.find('.ase-ctx-item').on('mouseenter', function () {\r\n      $(this).css('background-color', '#333');\r\n    }).on('mouseleave', function () {\r\n      $(this).css('background-color', 'transparent');\r\n    });\r\n\r\n    // Handle clicks\r\n    menu.find('[data-action=\"edit\"]').on('click', () => {\r\n      menu.remove();\r\n      this.renamePlaylist(playlistId);\r\n    });\r\n\r\n    menu.find('[data-action=\"delete\"]').on('click', () => {\r\n      menu.remove();\r\n      this.deletePlaylist(playlistId);\r\n    });\r\n\r\n    // Close on click outside\r\n    setTimeout(() => {\r\n      $(document).one('click', () => menu.remove());\r\n    }, 50);\r\n  }\r\n\r\n  private async renamePlaylist(playlistId: string): Promise<void> {\r\n    const playlist = this.library.playlists.getPlaylist(playlistId);\r\n    if (!playlist) return;\r\n\r\n    const newName = await this.promptPlaylistName(playlist.name);\r\n    if (!newName || newName === playlist.name) return;\r\n\r\n    this.library.playlists.updatePlaylist(playlistId, { name: newName });\r\n    this.persistScroll();\r\n    this.render();\r\n    ui.notifications?.info(`Renamed playlist to \"${newName}\"`);\r\n  }\r\n\r\n  private async deletePlaylist(playlistId: string): Promise<void> {\r\n    const playlist = this.library.playlists.getPlaylist(playlistId);\r\n    if (!playlist) return;\r\n\r\n    const confirm = await Dialog.confirm({\r\n      title: \"Delete Playlist\",\r\n      content: `Are you sure you want to delete playlist \"${playlist.name}\"?`\r\n    });\r\n\r\n    if (!confirm) return;\r\n\r\n    this.library.playlists.deletePlaylist(playlistId);\r\n\r\n    // Clear selection if this was selected\r\n    if (this.filterState.selectedPlaylistId === playlistId) {\r\n      this.filterState.selectedPlaylistId = null;\r\n    }\r\n\r\n    this.render();\r\n    ui.notifications?.info(`Deleted playlist \"${playlist.name}\"`);\r\n  }\r\n\r\n  private async promptPlaylistName(current: string = \"\"): Promise<string | null> {\r\n    return new Promise((resolve) => {\r\n      new Dialog({\r\n        title: current ? \"Rename Playlist\" : \"New Playlist\",\r\n        content: `\r\n          <form>\r\n            <div class=\"form-group\">\r\n              <label>Playlist Name:</label>\r\n              <input type=\"text\" name=\"playlistName\" value=\"${current}\" autofocus style=\"width: 100%;\">\r\n            </div>\r\n          </form>\r\n        `,\r\n        buttons: {\r\n          ok: {\r\n            icon: '<i class=\"fas fa-check\"></i>',\r\n            label: \"OK\",\r\n            callback: (html: JQuery) => {\r\n              const name = html.find('[name=\"playlistName\"]').val() as string;\r\n              resolve(name?.trim() || null);\r\n            }\r\n          },\r\n          cancel: {\r\n            icon: '<i class=\"fas fa-times\"></i>',\r\n            label: \"Cancel\",\r\n            callback: () => resolve(null)\r\n          }\r\n        },\r\n        default: \"ok\"\r\n      }).render(true);\r\n    });\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Drag and Drop\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private setupDragAndDrop(html: JQuery): void {\r\n    // Drag start\r\n    html.find('.ase-track-player-item[draggable=\"true\"]').on('dragstart', (event: JQuery.DragStartEvent) => {\r\n      const itemId = $(event.currentTarget).find('[data-item-id]').data('item-id') as string || $(event.currentTarget).data('item-id') as string;\r\n      // Note: Data-item-id might be on the action button/icon, but for the row it should be on the row or accessible.\r\n      // In template: <div class=\"ase-track-player-item\"> doesn't have data-item-id directly? \r\n      // Let's check template.\r\n      // Template: <div class=\"ase-track-player-item\"> inside each item. \r\n      // Actually, my template rewrite in 751:\r\n      // {{#each items}} <div class=\"ase-track-player-item\"> ... <div class=\"ase-track-actions\"> <i ... data-item-id=\"{{this.id}}\">\r\n      // The row itself DOES NOT have data-item-id in the rewrite! \r\n      // I NEED TO ADD IT TO THE TEMPLATE OR FIND IT.\r\n      // I will assume I will fix the template to include data-item-id on the row, or find it inside.\r\n      // For now, let's find it inside.\r\n      const id = $(event.currentTarget).find('[data-item-id]').first().data('item-id') as string;\r\n\r\n      event.originalEvent!.dataTransfer!.effectAllowed = 'copy';\r\n      event.originalEvent!.dataTransfer!.setData('text/plain', id);\r\n      // Mark as internal ASE drag with custom type\r\n      event.originalEvent!.dataTransfer!.setData('application/x-ase-internal', 'true');\r\n      $(event.currentTarget).addClass('dragging');\r\n    });\r\n\r\n    // Drag end\r\n    html.find('.ase-track-player-item[draggable=\"true\"]').on('dragend', (event: JQuery.DragEndEvent) => {\r\n      $(event.currentTarget).removeClass('dragging');\r\n    });\r\n\r\n    // Drop zones (playlists)\r\n    html.find('.ase-list-item[data-playlist-id]').on('dragover', (event: JQuery.DragOverEvent) => {\r\n      event.preventDefault();\r\n      event.originalEvent!.dataTransfer!.dropEffect = 'copy';\r\n      // Show drag-over highlight when dragging tracks onto playlists\r\n      // Internal drags have 'application/x-ase-internal' marker\r\n      const isInternalDrag = event.originalEvent!.dataTransfer!.types.includes('application/x-ase-internal');\r\n      if (isInternalDrag) {\r\n        $(event.currentTarget).addClass('drag-over');\r\n      }\r\n    });\r\n\r\n    html.find('.ase-list-item[data-playlist-id]').on('dragleave', (event: JQuery.DragLeaveEvent) => {\r\n      $(event.currentTarget).removeClass('drag-over');\r\n    });\r\n\r\n    html.find('.ase-list-item[data-playlist-id]').on('drop', async (event: JQuery.DropEvent) => {\r\n      event.preventDefault();\r\n      const itemId = event.originalEvent!.dataTransfer!.getData('text/plain');\r\n      const playlistId = $(event.currentTarget).data('playlist-id') as string;\r\n      $(event.currentTarget).removeClass('drag-over');\r\n\r\n      // Check if this is a playlist reorder drop (dragging a playlist onto another)\r\n      const draggedPlaylistId = event.originalEvent!.dataTransfer!.getData('application/x-playlist-id');\r\n      if (draggedPlaylistId && draggedPlaylistId !== playlistId) {\r\n        await this.handlePlaylistReorder(draggedPlaylistId, playlistId);\r\n        return;\r\n      }\r\n\r\n      await this.handleDropTrackToPlaylist(itemId, playlistId);\r\n    });\r\n\r\n    // Playlist reordering - drag start\r\n    html.find('.ase-list-item[data-playlist-id][draggable=\"true\"]').on('dragstart', (event: JQuery.DragStartEvent) => {\r\n      const playlistId = String($(event.currentTarget).data('playlist-id'));\r\n      event.originalEvent!.dataTransfer!.effectAllowed = 'move';\r\n      event.originalEvent!.dataTransfer!.setData('application/x-playlist-id', playlistId);\r\n      $(event.currentTarget).addClass('dragging');\r\n    });\r\n\r\n    html.find('.ase-list-item[data-playlist-id][draggable=\"true\"]').on('dragend', (event: JQuery.DragEndEvent) => {\r\n      $(event.currentTarget).removeClass('dragging');\r\n      html.find('.ase-list-item').removeClass('drag-over drag-above drag-below');\r\n    });\r\n\r\n    // Favorites reordering - drag start\r\n    html.find('.ase-favorite-item[draggable=\"true\"]').on('dragstart', (event: JQuery.DragStartEvent) => {\r\n      const favoriteId = String($(event.currentTarget).data('favorite-id'));\r\n      const favoriteType = String($(event.currentTarget).data('favorite-type'));\r\n      event.originalEvent!.dataTransfer!.effectAllowed = 'move';\r\n      event.originalEvent!.dataTransfer!.setData('application/x-favorite-id', favoriteId);\r\n      event.originalEvent!.dataTransfer!.setData('application/x-favorite-type', favoriteType);\r\n      $(event.currentTarget).addClass('dragging');\r\n    });\r\n\r\n    html.find('.ase-favorite-item[draggable=\"true\"]').on('dragend', (event: JQuery.DragEndEvent) => {\r\n      $(event.currentTarget).removeClass('dragging');\r\n      html.find('.ase-favorite-item').removeClass('drag-over drag-above drag-below');\r\n    });\r\n\r\n    // Visual feedback for playlist insertion position\r\n    html.find('.ase-list-item[data-playlist-id]').on('dragover', (event: JQuery.DragOverEvent) => {\r\n      const draggedPlaylistId = event.originalEvent!.dataTransfer!.types.includes('application/x-playlist-id');\r\n      if (!draggedPlaylistId) return; // Not a playlist drag\r\n\r\n      event.preventDefault();\r\n      event.originalEvent!.dataTransfer!.dropEffect = 'move';\r\n\r\n      const rect = (event.currentTarget as HTMLElement).getBoundingClientRect();\r\n      const midY = rect.top + rect.height / 2;\r\n      const isAbove = event.clientY! < midY;\r\n\r\n      // Clear drag classes from ALL playlist items first\r\n      html.find('.ase-list-item[data-playlist-id]').removeClass('drag-above drag-below drag-over');\r\n      // Then add to current target\r\n      $(event.currentTarget).addClass(isAbove ? 'drag-above' : 'drag-below');\r\n    });\r\n\r\n    // Visual feedback for favorites insertion position\r\n    html.find('.ase-favorite-item').on('dragover', (event: JQuery.DragOverEvent) => {\r\n      const hasFavoriteId = event.originalEvent!.dataTransfer!.types.includes('application/x-favorite-id');\r\n      if (!hasFavoriteId) return; // Not a favorite drag\r\n\r\n      event.preventDefault();\r\n      event.originalEvent!.dataTransfer!.dropEffect = 'move';\r\n\r\n      const rect = (event.currentTarget as HTMLElement).getBoundingClientRect();\r\n      const midY = rect.top + rect.height / 2;\r\n      const isAbove = event.clientY! < midY;\r\n\r\n      // Clear drag classes from ALL favorite items first\r\n      html.find('.ase-favorite-item').removeClass('drag-above drag-below drag-over');\r\n      // Then add to current target\r\n      $(event.currentTarget).addClass(isAbove ? 'drag-above' : 'drag-below');\r\n    });\r\n\r\n    html.find('.ase-favorite-item').on('drop', async (event: JQuery.DropEvent) => {\r\n      event.preventDefault();\r\n      const favoriteId = String($(event.currentTarget).data('favorite-id'));\r\n      const favoriteType = String($(event.currentTarget).data('favorite-type'));\r\n\r\n      $(event.currentTarget).removeClass('drag-above drag-below dragging');\r\n\r\n      const draggedId = event.originalEvent!.dataTransfer!.getData('application/x-favorite-id');\r\n      const draggedType = event.originalEvent!.dataTransfer!.getData('application/x-favorite-type');\r\n\r\n      if (draggedId && draggedType && (draggedId !== favoriteId || draggedType !== favoriteType)) {\r\n        await this.handleFavoriteReorder(draggedId, draggedType as 'track' | 'playlist', favoriteId, favoriteType as 'track' | 'playlist');\r\n      }\r\n    });\r\n\r\n    // Drop zone from OS (Main Library Area)\r\n    html.find('.ase-content-area').on('dragover', (event: JQuery.DragOverEvent) => {\r\n      event.preventDefault();\r\n      $(event.currentTarget).addClass('drag-over-import');\r\n    });\r\n\r\n    html.find('.ase-content-area').on('dragleave', (event: JQuery.DragLeaveEvent) => {\r\n      $(event.currentTarget).removeClass('drag-over-import');\r\n    });\r\n\r\n    html.find('.ase-content-area').on('drop', async (event: JQuery.DropEvent) => {\r\n      event.preventDefault();\r\n      $(event.currentTarget).removeClass('drag-over-import');\r\n\r\n      // Handle files from OS\r\n      const files = event.originalEvent?.dataTransfer?.files;\r\n      if (files && files.length > 0) {\r\n        Logger.debug(`Dropped ${files.length} files from OS`);\r\n        // Processing files...\r\n        // Note: Foundry FilePicker/Upload API is needed here.\r\n        // For now, we simulate the drop if it's external, or handle internal drops logic separately.\r\n\r\n        // Check if it's an internal drag (track item)\r\n        // If dataTransfer has 'text/plain' equal to item ID, it's internal.\r\n        const internalId = event.originalEvent?.dataTransfer?.getData('text/plain');\r\n        if (internalId && !files.length) {\r\n          // Internal drop on main area -> Maybe remove from current playlist if we are in one? \r\n          // Currently do nothing.\r\n          return;\r\n        }\r\n\r\n        // Real file upload\r\n        await this.handleFileUpload(files);\r\n      }\r\n    });\r\n  }\r\n\r\n  private async handlePlaylistReorder(draggedId: string, targetId: string): Promise<void> {\r\n    // Get current playlists order\r\n    const playlists = this.library.playlists.getAllPlaylists();\r\n    const draggedIndex = playlists.findIndex(p => p.id === draggedId);\r\n    const targetIndex = playlists.findIndex(p => p.id === targetId);\r\n\r\n    if (draggedIndex === -1 || targetIndex === -1) return;\r\n\r\n    // Reorder\r\n    const [dragged] = playlists.splice(draggedIndex, 1);\r\n    playlists.splice(targetIndex, 0, dragged);\r\n\r\n    // Update order in library (need to save the new order)\r\n    this.library.playlists.reorderPlaylists(playlists.map(p => p.id));\r\n\r\n    this.render();\r\n    Logger.debug(`Reordered playlist ${draggedId} to position ${targetIndex}`);\r\n  }\r\n\r\n  private async handleFavoriteReorder(\r\n    draggedId: string,\r\n    draggedType: 'track' | 'playlist',\r\n    targetId: string,\r\n    targetType: 'track' | 'playlist'\r\n  ): Promise<void> {\r\n    const favorites = this.library.getOrderedFavorites();\r\n    const draggedIndex = favorites.findIndex(f => f.id === draggedId && f.type === draggedType);\r\n    const targetIndex = favorites.findIndex(f => f.id === targetId && f.type === targetType); // Drop ON this item\r\n\r\n    if (draggedIndex === -1 || targetIndex === -1) return;\r\n\r\n    // Remove dragged item\r\n    const [draggedItem] = favorites.splice(draggedIndex, 1);\r\n\r\n    // Insert at target index (shift others down)\r\n    favorites.splice(targetIndex, 0, draggedItem);\r\n\r\n    // Update library\r\n    this.library.reorderFavorites(favorites);\r\n    this.render();\r\n    Logger.debug(`Reordered favorite ${draggedId} to position ${targetIndex}`);\r\n  }\r\n\r\n  private async handleFileUpload(files: FileList): Promise<void> {\r\n    if (!game.user?.isGM) {\r\n      ui.notifications?.warn('Only GM can upload files.');\r\n      return;\r\n    }\r\n\r\n    // Validate audio files\r\n    const audioFiles = Array.from(files).filter(file => {\r\n      const ext = file.name.split('.').pop()?.toLowerCase();\r\n      return ['mp3', 'ogg', 'wav', 'flac', 'webm', 'm4a', 'aac'].includes(ext || '');\r\n    });\r\n\r\n    if (audioFiles.length === 0) {\r\n      ui.notifications?.warn('No valid audio files found. Supported formats: mp3, ogg, wav, flac, webm, m4a, aac');\r\n      return;\r\n    }\r\n\r\n    // Upload to dedicated ase_audio folder (separate from worlds and modules)\r\n    const targetSource = 'data';\r\n    const targetDir = 'ase_audio';\r\n\r\n    // Ensure directory exists (create if needed)\r\n    try {\r\n      await FilePicker.createDirectory(targetSource, targetDir, {});\r\n    } catch (err) {\r\n      // Directory might already exist, ignore error\r\n      Logger.debug('Directory creation skipped (might already exist):', err);\r\n    }\r\n\r\n    let importedCount = 0;\r\n    let failedCount = 0;\r\n\r\n    for (const file of audioFiles) {\r\n      try {\r\n        // Upload file to server\r\n        const response = await FilePicker.upload(targetSource, targetDir, file, {}) as any;\r\n        if (response.path) {\r\n          // Smart channel detection based on filename\r\n          const channel = this.detectChannelFromFilename(file.name);\r\n\r\n          // Get selected tags\r\n          const selectedTags = Array.from(this.filterState.selectedTags);\r\n\r\n          // Add to library\r\n          const track = await this.library.addItem(\r\n            response.path,\r\n            file.name.split('.')[0], // Remove extension\r\n            channel,\r\n            selectedTags\r\n          );\r\n\r\n          // Add to active playlist if one is selected\r\n          if (this.filterState.selectedPlaylistId) {\r\n            try {\r\n              this.library.playlists.addTrackToPlaylist(\r\n                this.filterState.selectedPlaylistId,\r\n                track.id,\r\n                channel\r\n              );\r\n            } catch (err) {\r\n              // Track might already be in playlist, ignore\r\n            }\r\n          }\r\n\r\n          importedCount++;\r\n        }\r\n      } catch (err) {\r\n        Logger.error(`Failed to upload ${file.name}:`, err);\r\n        failedCount++;\r\n      }\r\n    }\r\n\r\n    // Show summary notification\r\n    if (importedCount > 0) {\r\n      const playlistMsg = this.filterState.selectedPlaylistId\r\n        ? ` and added to active playlist`\r\n        : '';\r\n      ui.notifications?.info(`Imported ${importedCount} file(s)${playlistMsg}`);\r\n      this.render();\r\n    }\r\n\r\n    if (failedCount > 0) {\r\n      ui.notifications?.warn(`Failed to import ${failedCount} file(s)`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Smart channel detection based on filename keywords\r\n   */\r\n  private detectChannelFromFilename(filename: string): TrackGroup {\r\n    const lowerName = filename.toLowerCase();\r\n\r\n    // Music keywords\r\n    const musicKeywords = ['music', 'song', 'theme', 'bgm', 'soundtrack', 'score', 'melody', 'музык'];\r\n    if (musicKeywords.some(keyword => lowerName.includes(keyword))) {\r\n      return 'music';\r\n    }\r\n\r\n    // Ambience keywords\r\n    const ambienceKeywords = ['ambient', 'ambience', 'atmosphere', 'environment', 'background', 'nature', 'wind', 'rain', 'forest', 'cave', 'амбиент', 'окружен'];\r\n    if (ambienceKeywords.some(keyword => lowerName.includes(keyword))) {\r\n      return 'ambience';\r\n    }\r\n\r\n    // SFX keywords\r\n    const sfxKeywords = ['sfx', 'sound', 'effect', 'fx', 'hit', 'impact', 'explosion', 'spell', 'attack', 'footstep', 'door', 'sword', 'интерфейс', 'эффект'];\r\n    if (sfxKeywords.some(keyword => lowerName.includes(keyword))) {\r\n      return 'sfx';\r\n    }\r\n\r\n    // Default to music if no keywords detected\r\n    return 'music';\r\n  }\r\n\r\n  private async handleDropTrackToPlaylist(itemId: string, playlistId: string): Promise<void> {\r\n    const item = this.library.getItem(itemId);\r\n    const playlist = this.library.playlists.getPlaylist(playlistId);\r\n\r\n    if (!item || !playlist) {\r\n      ui.notifications?.error('Track or playlist not found');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const group = this.inferGroupFromTags(item.tags) as TrackGroup;\r\n      this.library.playlists.addTrackToPlaylist(playlistId, itemId, group);\r\n      this.render();\r\n      ui.notifications?.info(`Added \"${item.name}\" to \"${playlist.name}\"`);\r\n    } catch (error) {\r\n      Logger.error('Failed to add track to playlist:', error);\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      ui.notifications?.error(`Failed to add to playlist: ${errorMessage}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Setup drag-and-drop handler for Foundry native playlists\r\n   * Allows dragging PlaylistSound items into ASE library\r\n   */\r\n  private setupFoundryDragDrop(html: JQuery): void {\r\n    const dropZone = html.find('.ase-track-player-list');\r\n    if (!dropZone.length) return;\r\n\r\n    // Prevent default drag over to allow drop\r\n    dropZone.on('dragover', (event: JQuery.DragOverEvent) => {\r\n      event.preventDefault();\r\n      event.originalEvent!.dataTransfer!.dropEffect = 'copy';\r\n      // Only show drag-over border for external drags (Foundry playlists/files)\r\n      // Internal drags have 'application/x-ase-internal' marker\r\n      const isInternalDrag = event.originalEvent!.dataTransfer!.types.includes('application/x-ase-internal');\r\n      if (!isInternalDrag) {\r\n        dropZone.addClass('drag-over');\r\n      }\r\n    });\r\n\r\n    // Remove visual feedback on drag leave\r\n    dropZone.on('dragleave', (event: JQuery.DragLeaveEvent) => {\r\n      // Only remove if leaving the drop zone itself (not child elements)\r\n      if (event.currentTarget === event.target) {\r\n        dropZone.removeClass('drag-over');\r\n      }\r\n    });\r\n\r\n    // Handle drop\r\n    dropZone.on('drop', async (event: JQuery.DropEvent) => {\r\n      event.preventDefault();\r\n      dropZone.removeClass('drag-over');\r\n\r\n      await this.handleFoundryPlaylistDrop(event.originalEvent!);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle drop event from Foundry playlist\r\n   * Routes to appropriate handler based on type (single track vs full playlist)\r\n   */\r\n  private async handleFoundryPlaylistDrop(event: DragEvent): Promise<void> {\r\n    try {\r\n      // Extract drag data using Foundry's helper (V10+)\r\n      const dragData = TextEditor.getDragEventData(event) as any;\r\n\r\n      if (!dragData) {\r\n        Logger.debug('No drag data found, ignoring');\r\n        return;\r\n      }\r\n\r\n      Logger.debug('Foundry drop detected:', dragData.type);\r\n\r\n      // Route by type\r\n      if (dragData.type === 'PlaylistSound') {\r\n        await this.handlePlaylistSoundImport(dragData);\r\n\r\n\r\n      } else if (dragData.type === 'Playlist') {\r\n        await this.handlePlaylistImport(dragData);\r\n      } else {\r\n        Logger.debug(`Unsupported drop type: ${dragData.type}`);\r\n      }\r\n\r\n    } catch (error) {\r\n      Logger.error('Failed to handle Foundry playlist drop:', error);\r\n      ui.notifications?.error('Failed to import track from playlist');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Import single PlaylistSound track\r\n   */\r\n  private async handlePlaylistSoundImport(dragData: any): Promise<void> {\r\n    // Resolve UUID to get the actual PlaylistSound document\r\n    const sound = await fromUuid(dragData.uuid) as any;\r\n\r\n    if (!sound) {\r\n      ui.notifications?.error('Failed to resolve playlist sound');\r\n      return;\r\n    }\r\n\r\n    // Extract audio path and name\r\n    const audioPath = sound.path || sound.sound?.path;\r\n    const soundName = sound.name;\r\n\r\n    if (!audioPath) {\r\n      ui.notifications?.error('Playlist sound has no audio file path');\r\n      return;\r\n    }\r\n\r\n    // Check if already exists\r\n    const existing = this.library.findByUrl(audioPath);\r\n    if (existing) {\r\n      ui.notifications?.warn(`Track \"${soundName}\" already exists in library`);\r\n      return;\r\n    }\r\n\r\n    // Determine channel (use track channel, or default to 'music')\r\n    const channel = this.mapFoundryChannelToASE(sound.channel);\r\n\r\n    // Add to library\r\n    // Get selected tags\r\n    const selectedTags = Array.from(this.filterState.selectedTags);\r\n\r\n    // Add to library\r\n    const newTrack = await this.library.addItem(audioPath, soundName, channel, selectedTags);\r\n\r\n    // If a playlist is currently selected, add the track to it automatically\r\n    if (this.filterState.selectedPlaylistId) {\r\n      try {\r\n        this.library.playlists.addTrackToPlaylist(\r\n          this.filterState.selectedPlaylistId,\r\n          newTrack.id,\r\n          channel\r\n        );\r\n        const playlist = this.library.playlists.getPlaylist(this.filterState.selectedPlaylistId);\r\n        ui.notifications?.info(`Added \"${soundName}\" to library and playlist \"${playlist?.name}\"`);\r\n      } catch (err) {\r\n        // Track might already be in playlist, just notify about library add\r\n        ui.notifications?.info(`Added \"${soundName}\" to library`);\r\n      }\r\n    } else {\r\n      ui.notifications?.info(`Added \"${soundName}\" to library`);\r\n    }\r\n\r\n    this.render();\r\n  }\r\n\r\n  /**\r\n   * Import entire Playlist with all tracks\r\n   */\r\n  private async handlePlaylistImport(dragData: any): Promise<void> {\r\n    try {\r\n      const playlist = await fromUuid(dragData.uuid) as any;\r\n\r\n      if (!playlist) {\r\n        ui.notifications?.error('Failed to resolve Foundry playlist');\r\n        return;\r\n      }\r\n\r\n      Logger.info(`Importing Foundry playlist: ${playlist.name} (${playlist.sounds.size} tracks)`);\r\n\r\n      const playlistName = this.generateUniquePlaylistName(playlist.name);\r\n      const asePlaylist = this.library.playlists.createPlaylist(playlistName);\r\n\r\n      let addedCount = 0;\r\n      let skippedCount = 0;\r\n\r\n      for (const sound of playlist.sounds) {\r\n        const audioPath = sound.path || sound.sound?.path;\r\n        if (!audioPath) {\r\n          Logger.warn(`Skipping sound \"${sound.name}\" - no path`);\r\n          continue;\r\n        }\r\n\r\n        // Resolve channel with inheritance\r\n        const foundryChannel = sound.channel || playlist.channel;\r\n\r\n        // Map Foundry channels to ASE channels\r\n        let channel: TrackGroup = 'music'; // default\r\n        if (foundryChannel === 'environment') {\r\n          channel = 'ambience';\r\n        } else if (foundryChannel === 'interface') {\r\n          channel = 'sfx';\r\n        } else if (foundryChannel === 'music' || !foundryChannel) {\r\n          channel = 'music';\r\n        }\r\n\r\n        let trackId = this.library.findByUrl(audioPath)?.id;\r\n\r\n        if (!trackId) {\r\n          try {\r\n            // Get selected tags\r\n            const selectedTags = Array.from(this.filterState.selectedTags);\r\n            // Log once per playlist import to avoid spam? Or just log.\r\n            // Logger.debug(`[ASE] PlaylistImport: Adding track with tags: ${JSON.stringify(selectedTags)}`);\r\n\r\n            const track = await this.library.addItem(audioPath, sound.name, channel, selectedTags);\r\n            trackId = track.id;\r\n            addedCount++;\r\n          } catch (err) {\r\n            Logger.error(`Failed to add track \"${sound.name}\":`, err);\r\n            continue;\r\n          }\r\n        } else {\r\n          skippedCount++;\r\n        }\r\n\r\n        this.library.playlists.addTrackToPlaylist(asePlaylist.id, trackId, channel);\r\n      }\r\n\r\n      const message = `Imported playlist \"${playlistName}\": ${addedCount} new tracks${skippedCount > 0 ? `, ${skippedCount} already in library` : ''}`;\r\n      ui.notifications?.info(message);\r\n      this.render();\r\n\r\n    } catch (error) {\r\n      Logger.error('Failed to import Foundry playlist:', error);\r\n      ui.notifications?.error('Failed to import playlist');\r\n    }\r\n  }\r\n\r\n  private resolveFoundryChannel(sound: any, playlist: any): TrackGroup {\r\n    const effectiveChannel = sound.channel || sound.fadeIn?.type || playlist.channel || playlist.mode;\r\n\r\n    return this.mapFoundryChannelToASE(effectiveChannel);\r\n  }\r\n\r\n  private mapFoundryChannelToASE(foundryChannel: string | number | null | undefined): TrackGroup {\r\n    if (!foundryChannel && foundryChannel !== 0) return 'music';\r\n\r\n    // Convert to string for comparison\r\n    const channelStr = String(foundryChannel).toLowerCase();\r\n\r\n    // Foundry uses numeric constants (CONST.AUDIO_CHANNELS):\r\n    // 0 or \"0\" = music\r\n    // 1 or \"1\" = environment  \r\n    // 2 or \"2\" = interface\r\n    const channelMap: Record<string, TrackGroup> = {\r\n      '0': 'music',\r\n      '1': 'ambience',\r\n      '2': 'sfx',\r\n      'music': 'music',\r\n      'environment': 'ambience',\r\n      'interface': 'sfx'\r\n    };\r\n\r\n    const mapped = channelMap[channelStr] || 'music';\r\n\r\n    return mapped;\r\n  }\r\n\r\n  private generateUniquePlaylistName(baseName: string): string {\r\n    const existingPlaylists = this.library.playlists.getAllPlaylists();\r\n    const existingNames = new Set(existingPlaylists.map(p => p.name));\r\n\r\n    if (!existingNames.has(baseName)) return baseName;\r\n\r\n    let counter = 2;\r\n    while (existingNames.has(`${baseName} (${counter})`)) {\r\n      counter++;\r\n    }\r\n\r\n    return `${baseName} (${counter})`;\r\n  }\r\n\r\n  private async removeTrackFromPlaylist(playlistId: string, trackId: string): Promise<void> {\r\n    try {\r\n      this.library.playlists.removeLibraryItemFromPlaylist(playlistId, trackId);\r\n      this.persistScroll();\r\n      this.render();\r\n      ui.notifications?.info('Removed track from playlist');\r\n    } catch (error) {\r\n      Logger.error('Failed to remove track from playlist:', error);\r\n      ui.notifications?.error('Failed to remove track from playlist');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Highlight playlists in sidebar that contain the specified track\r\n   */\r\n  private highlightPlaylistsContainingTrack(trackId: string): void {\r\n    const playlists = this.library.playlists.getAllPlaylists();\r\n\r\n    // Find playlists containing this track\r\n    const containingPlaylists = playlists.filter(playlist =>\r\n      playlist.items.some(item => item.libraryItemId === trackId)\r\n    );\r\n\r\n    // Highlight them in the UI\r\n    containingPlaylists.forEach(playlist => {\r\n      $(`[data-playlist-id=\"${playlist.id}\"]`).addClass('highlight-contains-track');\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear all playlist highlights\r\n   */\r\n  private clearPlaylistHighlights(): void {\r\n    $('.highlight-contains-track').removeClass('highlight-contains-track');\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Context Menus\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private setupContextMenus(html: JQuery): void {\r\n    // Track context menu\r\n    new ContextMenu(html, '.track-item', [\r\n      {\r\n        name: 'Edit Name',\r\n        icon: '<i class=\"fas fa-edit\"></i>',\r\n        callback: (target: JQuery | HTMLElement) => {\r\n          const li = $(target);\r\n          const itemId = li.data('item-id') as string;\r\n          this.onEditTrackName(itemId);\r\n        }\r\n      },\r\n      {\r\n        name: 'Edit Tags',\r\n        icon: '<i class=\"fas fa-tags\"></i>',\r\n        callback: (target: JQuery | HTMLElement) => {\r\n          const li = $(target);\r\n          const itemId = li.data('item-id') as string;\r\n          this.onEditTrackTags(itemId);\r\n        }\r\n      },\r\n      {\r\n        name: 'Add to Playlist',\r\n        icon: '<i class=\"fas fa-list-ul\"></i>',\r\n        callback: (target: JQuery | HTMLElement) => {\r\n          const li = $(target);\r\n          const itemId = li.data('item-id') as string;\r\n          this.handleAddToPlaylistFromContext(itemId);\r\n        }\r\n      },\r\n      {\r\n        name: 'Toggle Favorite',\r\n        icon: '<i class=\"fas fa-star\"></i>',\r\n        callback: (target: JQuery | HTMLElement) => {\r\n          const li = $(target);\r\n          const itemId = li.data('item-id') as string;\r\n          try {\r\n            const isFavorite = this.library.toggleFavorite(itemId);\r\n            this.persistScroll();\r\n            this.render();\r\n            ui.notifications?.info(isFavorite ? 'Added to favorites' : 'Removed from favorites');\r\n          } catch (error) {\r\n            Logger.error('Failed to toggle favorite:', error);\r\n            ui.notifications?.error('Failed to update favorite status');\r\n          }\r\n        }\r\n      },\r\n      {\r\n        name: 'Delete Track',\r\n        icon: '<i class=\"fas fa-trash\"></i>',\r\n        callback: (target: JQuery | HTMLElement) => {\r\n          const li = $(target);\r\n          const itemId = li.data('item-id') as string;\r\n          this.onDeleteTrackConfirm(itemId);\r\n        }\r\n      }\r\n    ]);\r\n\r\n    // Playlist context menu\r\n    new ContextMenu(html, '.playlist-item', [\r\n      {\r\n        name: 'Rename Playlist',\r\n        icon: '<i class=\"fas fa-edit\"></i>',\r\n        callback: (target: JQuery | HTMLElement) => {\r\n          const li = $(target);\r\n          const playlistId = li.data('playlist-id') as string;\r\n          this.onRenamePlaylist(playlistId);\r\n        }\r\n      },\r\n      {\r\n        name: 'Edit Description',\r\n        icon: '<i class=\"fas fa-align-left\"></i>',\r\n        callback: (target: JQuery | HTMLElement) => {\r\n          const li = $(target);\r\n          const playlistId = li.data('playlist-id') as string;\r\n          this.onEditPlaylistDescription(playlistId);\r\n        }\r\n      },\r\n      {\r\n        name: 'View Contents',\r\n        icon: '<i class=\"fas fa-list\"></i>',\r\n        callback: (target: JQuery | HTMLElement) => {\r\n          const li = $(target);\r\n          const playlistId = li.data('playlist-id') as string;\r\n          this.onViewPlaylistContents(playlistId);\r\n        }\r\n      },\r\n      {\r\n        name: 'Clear Playlist',\r\n        icon: '<i class=\"fas fa-eraser\"></i>',\r\n        callback: (target: JQuery | HTMLElement) => {\r\n          const li = $(target);\r\n          const playlistId = li.data('playlist-id') as string;\r\n          this.onClearPlaylist(playlistId);\r\n        }\r\n      },\r\n      {\r\n        name: 'Delete Playlist',\r\n        icon: '<i class=\"fas fa-trash\"></i>',\r\n        callback: (target: JQuery | HTMLElement) => {\r\n          const li = $(target);\r\n          const playlistId = li.data('playlist-id') as string;\r\n          this.onDeletePlaylistConfirm(playlistId);\r\n        }\r\n      }\r\n    ]);\r\n\r\n    // Tag context menu\r\n    new ContextMenu(html, '.tag-chip:not(.mini)', [\r\n      {\r\n        name: 'Rename Tag',\r\n        icon: '<i class=\"fas fa-edit\"></i>',\r\n        callback: (target: JQuery | HTMLElement) => {\r\n          const li = $(target);\r\n          const tagName = li.data('tag') as string;\r\n          this.onRenameTag(tagName);\r\n        }\r\n      },\r\n      {\r\n        name: 'Delete Tag',\r\n        icon: '<i class=\"fas fa-trash\"></i>',\r\n        callback: (target: JQuery | HTMLElement) => {\r\n          const li = $(target);\r\n          const tagName = li.data('tag') as string;\r\n          this.onDeleteTag(tagName);\r\n        }\r\n      }\r\n    ]);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Context Menu Handlers - Tracks\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async onEditTrackName(itemId: string): Promise<void> {\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) {\r\n      ui.notifications?.error('Track not found');\r\n      return;\r\n    }\r\n\r\n    const newName = await this.promptTextInput('Edit Track Name', 'Track Name', item.name);\r\n    if (!newName || newName === item.name) return;\r\n\r\n    try {\r\n      this.library.updateItem(itemId, { name: newName });\r\n      this.persistScroll();\r\n      this.render();\r\n      ui.notifications?.info(`Renamed to: ${newName}`);\r\n    } catch (error) {\r\n      Logger.error('Failed to rename track:', error);\r\n      ui.notifications?.error('Failed to rename track');\r\n    }\r\n  }\r\n\r\n  private async onEditTrackTags(itemId: string): Promise<void> {\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) {\r\n      ui.notifications?.error('Track not found');\r\n      return;\r\n    }\r\n\r\n    const tagsString = await this.promptTextInput(\r\n      'Edit Tags',\r\n      'Tags (comma-separated)',\r\n      item.tags.join(', ')\r\n    );\r\n    if (tagsString === null) return;\r\n\r\n    // Parse tags\r\n    const newTags = tagsString\r\n      .split(',')\r\n      .map(t => t.trim())\r\n      .filter(t => t.length > 0);\r\n\r\n    try {\r\n      this.library.updateItem(itemId, { tags: newTags });\r\n      this.persistScroll();\r\n      this.render();\r\n      ui.notifications?.info('Tags updated');\r\n    } catch (error) {\r\n      Logger.error('Failed to update tags:', error);\r\n      ui.notifications?.error('Failed to update tags');\r\n    }\r\n  }\r\n\r\n  private async onDeleteTrackConfirm(itemId: string): Promise<void> {\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) {\r\n      ui.notifications?.error('Track not found');\r\n      return;\r\n    }\r\n\r\n    const confirmed = await Dialog.confirm({\r\n      title: 'Delete Track',\r\n      content: `<p>Are you sure you want to delete <strong>${item.name}</strong> from the library?</p>\r\n                <p class=\"notification warning\">This will remove it from all playlists and favorites.</p>`,\r\n      yes: () => true,\r\n      no: () => false,\r\n      defaultYes: false\r\n    });\r\n\r\n    if (confirmed) {\r\n      try {\r\n        this.library.removeItem(itemId);\r\n        this.persistScroll();\r\n        this.render();\r\n        ui.notifications?.info(`Deleted: ${item.name}`);\r\n      } catch (error) {\r\n        Logger.error('Failed to delete track:', error);\r\n        ui.notifications?.error('Failed to delete track');\r\n      }\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Context Menu Handlers - Playlists\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async onRenamePlaylist(playlistId: string): Promise<void> {\r\n    const playlist = this.library.playlists.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      ui.notifications?.error('Playlist not found');\r\n      return;\r\n    }\r\n\r\n    const newName = await this.promptTextInput('Rename Playlist', 'Playlist Name', playlist.name);\r\n    if (!newName || newName === playlist.name) return;\r\n\r\n    try {\r\n      this.library.playlists.updatePlaylist(playlistId, { name: newName });\r\n      this.render();\r\n      ui.notifications?.info(`Renamed to: ${newName}`);\r\n    } catch (error) {\r\n      Logger.error('Failed to rename playlist:', error);\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      ui.notifications?.error(`Failed to rename playlist: ${errorMessage}`);\r\n    }\r\n  }\r\n\r\n  private async onEditPlaylistDescription(playlistId: string): Promise<void> {\r\n    const playlist = this.library.playlists.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      ui.notifications?.error('Playlist not found');\r\n      return;\r\n    }\r\n\r\n    const description = await this.promptTextInput(\r\n      'Edit Description',\r\n      'Description',\r\n      playlist.description || ''\r\n    );\r\n    if (description === null) return;\r\n\r\n    try {\r\n      this.library.playlists.updatePlaylist(playlistId, { description: description || undefined });\r\n      this.render();\r\n      ui.notifications?.info('Description updated');\r\n    } catch (error) {\r\n      Logger.error('Failed to update description:', error);\r\n      ui.notifications?.error('Failed to update description');\r\n    }\r\n  }\r\n\r\n  private async onViewPlaylistContents(playlistId: string): Promise<void> {\r\n    const playlist = this.library.playlists.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      ui.notifications?.error('Playlist not found');\r\n      return;\r\n    }\r\n\r\n    const items = playlist.items\r\n      .sort((a, b) => a.order - b.order)\r\n      .map((playlistItem, index) => {\r\n        const libraryItem = this.library.getItem(playlistItem.libraryItemId);\r\n        const name = libraryItem?.name || 'Unknown';\r\n        return `<li><strong>${index + 1}.</strong> ${name}</li>`;\r\n      })\r\n      .join('');\r\n\r\n    const content = `\r\n      <div>\r\n        <p><strong>${playlist.name}</strong></p>\r\n        ${playlist.description ? `<p><em>${playlist.description}</em></p>` : ''}\r\n        <p>Total tracks: ${playlist.items.length}</p>\r\n        ${playlist.items.length > 0 ? `<ul class=\"playlist-contents-list\">${items}</ul>` : '<p>No tracks in playlist</p>'}\r\n      </div>\r\n    `;\r\n\r\n    new Dialog({\r\n      title: 'Playlist Contents',\r\n      content,\r\n      buttons: {\r\n        close: {\r\n          icon: '<i class=\"fas fa-times\"></i>',\r\n          label: 'Close'\r\n        }\r\n      },\r\n      default: 'close'\r\n    }).render(true);\r\n  }\r\n\r\n  private async onClearPlaylist(playlistId: string): Promise<void> {\r\n    const playlist = this.library.playlists.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      ui.notifications?.error('Playlist not found');\r\n      return;\r\n    }\r\n\r\n    if (playlist.items.length === 0) {\r\n      ui.notifications?.warn('Playlist is already empty');\r\n      return;\r\n    }\r\n\r\n    const confirmed = await Dialog.confirm({\r\n      title: 'Clear Playlist',\r\n      content: `<p>Are you sure you want to remove all ${playlist.items.length} tracks from <strong>${playlist.name}</strong>?</p>\r\n                <p class=\"notification warning\">This cannot be undone.</p>`,\r\n      yes: () => true,\r\n      no: () => false,\r\n      defaultYes: false\r\n    });\r\n\r\n    if (confirmed) {\r\n      try {\r\n        // Remove all items\r\n        const itemIds = [...playlist.items.map(i => i.id)];\r\n        itemIds.forEach(itemId => {\r\n          try {\r\n            this.library.playlists.removeTrackFromPlaylist(playlistId, itemId);\r\n          } catch (error) {\r\n            Logger.error('Failed to remove item:', error);\r\n          }\r\n        });\r\n\r\n        this.render();\r\n        ui.notifications?.info(`Cleared playlist: ${playlist.name}`);\r\n      } catch (error) {\r\n        Logger.error('Failed to clear playlist:', error);\r\n        ui.notifications?.error('Failed to clear playlist');\r\n      }\r\n    }\r\n  }\r\n\r\n  private async onDeletePlaylistConfirm(playlistId: string): Promise<void> {\r\n    const playlist = this.library.playlists.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      ui.notifications?.error('Playlist not found');\r\n      return;\r\n    }\r\n\r\n    const confirmed = await Dialog.confirm({\r\n      title: 'Delete Playlist',\r\n      content: `<p>Are you sure you want to delete <strong>${playlist.name}</strong>?</p>\r\n                <p class=\"notification info\">The tracks will remain in your library.</p>`,\r\n      yes: () => true,\r\n      no: () => false,\r\n      defaultYes: false\r\n    });\r\n\r\n    if (confirmed) {\r\n      try {\r\n        // Clear playlist filter if this playlist is selected\r\n        if (this.filterState.selectedPlaylistId === playlistId) {\r\n          this.filterState.selectedPlaylistId = null;\r\n        }\r\n\r\n        this.library.playlists.deletePlaylist(playlistId);\r\n        this.render();\r\n        ui.notifications?.info(`Deleted playlist: ${playlist.name}`);\r\n      } catch (error) {\r\n        Logger.error('Failed to delete playlist:', error);\r\n        ui.notifications?.error('Failed to delete playlist');\r\n      }\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Context Menu Handlers - Tags\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async onRenameTag(oldTagName: string): Promise<void> {\r\n    const newTagName = await this.promptTextInput('Rename Tag', 'New Tag Name', oldTagName);\r\n    if (!newTagName || newTagName === oldTagName) return;\r\n\r\n    try {\r\n      // Find all items with this tag and update them\r\n      const items = this.library.getAllItems().filter(item => item.tags.includes(oldTagName));\r\n\r\n      items.forEach(item => {\r\n        const updatedTags = item.tags.map(tag => tag === oldTagName ? newTagName : tag);\r\n        this.library.updateItem(item.id, { tags: updatedTags });\r\n      });\r\n\r\n      // Update filter state if tag is selected\r\n      if (this.filterState.selectedTags.has(oldTagName)) {\r\n        this.filterState.selectedTags.delete(oldTagName);\r\n        this.filterState.selectedTags.add(newTagName);\r\n      }\r\n\r\n      this.render();\r\n      ui.notifications?.info(`Renamed tag \"${oldTagName}\" to \"${newTagName}\" in ${items.length} track(s)`);\r\n    } catch (error) {\r\n      Logger.error('Failed to rename tag:', error);\r\n      ui.notifications?.error('Failed to rename tag');\r\n    }\r\n  }\r\n\r\n  private async onDeleteTag(tagName: string): Promise<void> {\r\n    const items = this.library.getAllItems().filter(item => item.tags.includes(tagName));\r\n\r\n    const confirmed = await Dialog.confirm({\r\n      title: 'Delete Tag',\r\n      content: `<p>Are you sure you want to delete the tag <strong>${tagName}</strong>?</p>\r\n                <p class=\"notification warning\">This will remove the tag from ${items.length} track(s).</p>`,\r\n      yes: () => true,\r\n      no: () => false,\r\n      defaultYes: false\r\n    });\r\n\r\n    if (confirmed) {\r\n      try {\r\n        items.forEach(item => {\r\n          const updatedTags = item.tags.filter(tag => tag !== tagName);\r\n          this.library.updateItem(item.id, { tags: updatedTags });\r\n        });\r\n\r\n        // Remove from filter state if selected\r\n        this.filterState.selectedTags.delete(tagName);\r\n\r\n        this.render();\r\n        ui.notifications?.info(`Deleted tag \"${tagName}\" from ${items.length} track(s)`);\r\n      } catch (error) {\r\n        Logger.error('Failed to delete tag:', error);\r\n        ui.notifications?.error('Failed to delete tag');\r\n      }\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Utilities\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n\r\n\r\n  private async promptPlaylistSelection(playlists: Playlist[]): Promise<string | null> {\r\n    const options = playlists.map(p =>\r\n      `<option value=\"${p.id}\">${p.name} (${p.items.length} tracks)</option>`\r\n    ).join('');\r\n\r\n    return new Promise((resolve) => {\r\n      new Dialog({\r\n        title: 'Add to Playlist',\r\n        content: `\r\n          <form>\r\n            <div class=\"form-group\">\r\n              <label>Select Playlist:</label>\r\n              <select name=\"playlist-id\">\r\n                ${options}\r\n              </select>\r\n            </div>\r\n          </form>\r\n        `,\r\n        buttons: {\r\n          add: {\r\n            icon: '<i class=\"fas fa-plus\"></i>',\r\n            label: 'Add',\r\n            callback: (html: JQuery) => {\r\n              const playlistId = html.find('[name=\"playlist-id\"]').val() as string;\r\n              resolve(playlistId || null);\r\n            }\r\n          },\r\n          cancel: {\r\n            icon: '<i class=\"fas fa-times\"></i>',\r\n            label: 'Cancel',\r\n            callback: () => resolve(null)\r\n          }\r\n        },\r\n        default: 'add'\r\n      }).render(true);\r\n    });\r\n  }\r\n\r\n  private async promptTextInput(\r\n    title: string,\r\n    label: string,\r\n    defaultValue: string = ''\r\n  ): Promise<string | null> {\r\n    return new Promise((resolve) => {\r\n      new Dialog({\r\n        title,\r\n        content: `\r\n          <form>\r\n            <div class=\"form-group\">\r\n              <label>${label}:</label>\r\n              <input type=\"text\" name=\"text-input\" value=\"${defaultValue}\" autofocus />\r\n            </div>\r\n          </form>\r\n        `,\r\n        buttons: {\r\n          save: {\r\n            icon: '<i class=\"fas fa-check\"></i>',\r\n            label: 'Save',\r\n            callback: (html: JQuery) => {\r\n              const value = (html.find('[name=\"text-input\"]').val() as string || '').trim();\r\n              resolve(value || null);\r\n            }\r\n          },\r\n          cancel: {\r\n            icon: '<i class=\"fas fa-times\"></i>',\r\n            label: 'Cancel',\r\n            callback: () => resolve(null)\r\n          }\r\n        },\r\n        default: 'save'\r\n      }).render(true);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle adding track to playlist from context menu\r\n   */\r\n  private async handleAddToPlaylistFromContext(itemId: string): Promise<void> {\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) return;\r\n\r\n    const playlists = this.library.playlists.getAllPlaylists();\r\n    if (playlists.length === 0) {\r\n      ui.notifications?.warn('No playlists available. Create one first.');\r\n      return;\r\n    }\r\n\r\n    const selectedPlaylistId = await this.promptPlaylistSelection(playlists);\r\n    if (!selectedPlaylistId) return;\r\n\r\n    try {\r\n      const group = this.inferGroupFromTags(item.tags) as any;\r\n      this.library.playlists.addTrackToPlaylist(selectedPlaylistId, itemId, group);\r\n      this.render();\r\n      ui.notifications?.info(`Added \"${item.name}\" to playlist`);\r\n    } catch (error) {\r\n      Logger.error('Failed to add track to playlist:', error);\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      ui.notifications?.error(`Failed to add to playlist: ${errorMessage}`);\r\n    }\r\n  }\r\n}\r\n","import type { TrackGroup } from '@t/audio';\r\nimport type { QueueItem } from '@t/queue';\r\nimport type { LibraryItem, Playlist } from '@t/library';\r\nimport { AudioEngine } from '@core/AudioEngine';\r\nimport { SocketManager } from '@sync/SocketManager';\r\nimport { LibraryManager } from '@lib/LibraryManager';\r\nimport { PlaybackQueueManager } from '@queue/PlaybackQueueManager';\r\nimport { Logger } from '@utils/logger';\r\nimport { formatTime } from '@utils/time';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// Types for Mixer View Data\r\n// ─────────────────────────────────────────────────────────────\r\n\r\ninterface MixerViewData {\r\n  favorites: FavoriteViewData[];\r\n  queuePlaylists: QueuePlaylistViewData[];\r\n  effects: EffectViewData[];\r\n}\r\n\r\ninterface FavoriteViewData {\r\n  id: string;\r\n  name: string;\r\n  type: 'track' | 'playlist';\r\n  group?: TrackGroup;\r\n  isPlaying: boolean;\r\n  isPaused: boolean;\r\n  inQueue: boolean;\r\n}\r\n\r\ninterface EffectViewData {\r\n  id: string;\r\n  name: string;\r\n  enabled: boolean;\r\n}\r\n\r\ninterface QueuePlaylistViewData {\r\n  id: string | null;\r\n  name: string;\r\n  collapsed: boolean;\r\n  tracks: QueueTrackViewData[];\r\n}\r\n\r\ninterface QueueTrackViewData {\r\n  queueId: string;\r\n  libraryItemId: string;\r\n  name: string;\r\n  group: TrackGroup;\r\n  tags: string[];\r\n  isPlaying: boolean;\r\n  isPaused: boolean;\r\n  isStopped: boolean;\r\n  isLoading: boolean;\r\n  volume: number;\r\n  volumePercent: number;\r\n  loop: boolean;\r\n  currentTime: number;\r\n  currentTimeFormatted: string;\r\n  duration: number;\r\n  durationFormatted: string;\r\n  progress: number;\r\n}\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// SoundMixerApp - Mixer Tab Controller\r\n// ─────────────────────────────────────────────────────────────\r\n\r\nexport class SoundMixerApp {\r\n  private engine: AudioEngine;\r\n  private socket: SocketManager;\r\n  private libraryManager: LibraryManager;\r\n  private queueManager: PlaybackQueueManager;\r\n  private collapsedPlaylists: Set<string> = new Set();\r\n  private updateInterval: ReturnType<typeof setInterval> | null = null;\r\n  private html: JQuery | null = null;\r\n  private renderParent: (() => void) | null = null;\r\n\r\n  // Throttle for socket broadcasts\r\n  private seekThrottleTimers: Map<string, ReturnType<typeof setTimeout>> = new Map();\r\n  private volumeThrottleTimers: Map<string, ReturnType<typeof setTimeout>> = new Map();\r\n  private static THROTTLE_MS = 200;\r\n\r\n  constructor(\r\n    engine: AudioEngine,\r\n    socket: SocketManager,\r\n    libraryManager: LibraryManager,\r\n    queueManager: PlaybackQueueManager\r\n  ) {\r\n    this.engine = engine;\r\n    this.socket = socket;\r\n    this.libraryManager = libraryManager;\r\n    this.queueManager = queueManager;\r\n\r\n    // Subscribe to queue changes for real-time updates\r\n    this.queueManager.on('change', () => this.onQueueChange());\r\n\r\n    // Listen for external favorite changes (Global Hook)\r\n    Hooks.on('ase.favoritesChanged' as any, () => {\r\n      this.requestRender();\r\n    });\r\n  }\r\n\r\n  // Set callback for requesting parent render\r\n  setRenderCallback(callback: () => void): void {\r\n    this.renderParent = callback;\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Data Provider\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  getData(): MixerViewData {\r\n    // Get ordered favorites from library (includes both tracks and playlists)\r\n    const orderedFavorites = this.libraryManager.getOrderedFavorites();\r\n    const favorites: FavoriteViewData[] = [];\r\n\r\n    for (const fav of orderedFavorites) {\r\n      // Check if item is in queue (same pattern as LocalLibraryApp.ts:153-155)\r\n      const inQueue = fav.type === 'track'\r\n        ? (window.ASE?.queue?.hasItem(fav.id) ?? false)\r\n        : (window.ASE?.queue?.getItems().some((q) => q.playlistId === fav.id) ?? false);\r\n\r\n      if (fav.type === 'track') {\r\n        const item = this.libraryManager.getItem(fav.id);\r\n        if (item) {\r\n          const player = this.engine.getTrack(item.id);\r\n          favorites.push({\r\n            id: item.id,\r\n            name: item.name,\r\n            type: 'track',\r\n            group: item.group,\r\n            isPlaying: player?.state === 'playing',\r\n            isPaused: player?.state === 'paused',\r\n            inQueue,\r\n          });\r\n        }\r\n      } else if (fav.type === 'playlist') {\r\n        const playlist = this.libraryManager.playlists.getPlaylist(fav.id);\r\n        if (playlist) {\r\n          favorites.push({\r\n            id: playlist.id,\r\n            name: playlist.name,\r\n            type: 'playlist',\r\n            group: undefined,\r\n            isPlaying: false, // Playlists don't have individual play state\r\n            isPaused: false,\r\n            inQueue,\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    // Get queue items grouped by playlist\r\n    const queueItems = this.queueManager.getItems();\r\n    const queuePlaylists = this.groupQueueByPlaylist(queueItems);\r\n\r\n    // Get all effects from engine\r\n    const effects: EffectViewData[] = this.engine.getAllEffects().map((effect) => ({\r\n      id: effect.id,\r\n      name: effect.type,\r\n      enabled: effect.enabled,\r\n    }));\r\n\r\n    return {\r\n      favorites,\r\n      queuePlaylists,\r\n      effects,\r\n    };\r\n  }\r\n\r\n  private groupQueueByPlaylist(queueItems: QueueItem[]): QueuePlaylistViewData[] {\r\n    const groups = new Map<string | null, QueueItem[]>();\r\n\r\n    // Group by playlistId (null for un-grouped tracks)\r\n    for (const item of queueItems) {\r\n      const key = item.playlistId ?? null;\r\n      if (!groups.has(key)) {\r\n        groups.set(key, []);\r\n      }\r\n      groups.get(key)!.push(item);\r\n    }\r\n\r\n    const playlists: QueuePlaylistViewData[] = [];\r\n\r\n    for (const [playlistId, items] of groups) {\r\n      // Get playlist name\r\n      let name = 'Ungrouped';\r\n      if (playlistId) {\r\n        const playlist = this.libraryManager.playlists.getPlaylist(playlistId);\r\n        name = playlist?.name ?? 'Unknown Playlist';\r\n      }\r\n\r\n      const tracks = items.map(queueItem => this.getQueueTrackViewData(queueItem));\r\n\r\n      playlists.push({\r\n        id: playlistId,\r\n        name,\r\n        collapsed: playlistId ? this.collapsedPlaylists.has(playlistId) : false,\r\n        tracks,\r\n      });\r\n    }\r\n\r\n    return playlists;\r\n  }\r\n\r\n  private getQueueTrackViewData(queueItem: QueueItem): QueueTrackViewData {\r\n    const libraryItem = this.libraryManager.getItem(queueItem.libraryItemId);\r\n    const player = this.engine.getTrack(queueItem.libraryItemId);\r\n\r\n    const currentTime = player?.getCurrentTime() ?? 0;\r\n    const duration = libraryItem?.duration ?? player?.getDuration() ?? 0;\r\n    const progress = duration > 0 ? (currentTime / duration) * 100 : 0;\r\n\r\n    // Get volume and loop from player if available (persisted state), fallback to queueItem\r\n    const volume = player?.volume ?? queueItem.volume;\r\n    const loop = player?.loop ?? queueItem.loop;\r\n\r\n    return {\r\n      queueId: queueItem.id,\r\n      libraryItemId: queueItem.libraryItemId,\r\n      name: libraryItem?.name ?? 'Unknown Track',\r\n      group: queueItem.group,\r\n      tags: libraryItem?.tags ?? [],\r\n      isPlaying: player?.state === 'playing',\r\n      isPaused: player?.state === 'paused',\r\n      isStopped: !player || player.state === 'stopped',\r\n      isLoading: player?.state === 'loading',\r\n      volume,\r\n      volumePercent: Math.round(volume * 100),\r\n      loop,\r\n      currentTime,\r\n      currentTimeFormatted: formatTime(currentTime),\r\n      duration,\r\n      durationFormatted: formatTime(duration),\r\n      progress,\r\n    };\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Event Listeners\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  activateListeners(html: JQuery): void {\r\n    this.html = html;\r\n    this.startUpdates();\r\n\r\n    // Favorites controls\r\n    html.find('[data-action=\"play-favorite\"]').on('click', (e) => this.onPlayFavorite(e));\r\n    html.find('[data-action=\"pause-favorite\"]').on('click', (e) => this.onPauseFavorite(e));\r\n    html.find('[data-action=\"stop-favorite\"]').on('click', (e) => this.onStopFavorite(e));\r\n    html.find('[data-action=\"add-to-queue-from-favorite\"]').on('click', (e) => this.onAddToQueueFromFavorite(e));\r\n\r\n    // Queue controls\r\n    html.find('[data-action=\"play-queue\"]').on('click', (e) => this.onPlayQueueItem(e));\r\n    html.find('[data-action=\"pause-queue\"]').on('click', (e) => this.onPauseQueueItem(e));\r\n    html.find('[data-action=\"stop-queue\"]').on('click', (e) => this.onStopQueueItem(e));\r\n    html.find('[data-action=\"remove-queue\"]').on('click', (e) => this.onRemoveQueueItem(e));\r\n    html.find('[data-action=\"loop-queue\"]').on('click', (e) => this.onLoopQueueItem(e));\r\n\r\n    // Playlist collapse/expand\r\n    html.find('[data-action=\"toggle-playlist\"]').on('click', (e) => this.onTogglePlaylist(e));\r\n\r\n    // Track controls\r\n    html.find('[data-action=\"seek\"]').on('input', (e) => this.onSeek(e));\r\n    html.find('[data-action=\"volume\"]').on('input', (e) => this.onVolumeChange(e));\r\n\r\n    // Effects controls\r\n    html.find('[data-action=\"toggle-effect\"]').on('change', (e) => this.onToggleEffect(e));\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Favorites Handlers\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async onPlayFavorite(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const $el = $(event.currentTarget);\r\n    const id = $el.data('favorite-id') as string;\r\n    const type = $el.data('favorite-type') as 'track' | 'playlist';\r\n\r\n    if (type === 'track') {\r\n      // Add track to queue if not already there\r\n      const libraryItem = this.libraryManager.getItem(id);\r\n      if (libraryItem) {\r\n        const queueItems = this.queueManager.getItems();\r\n        const existingQueueItem = queueItems.find(\r\n          (item) => item.libraryItemId === id && !item.playlistId\r\n        );\r\n\r\n        if (!existingQueueItem) {\r\n          this.queueManager.addItem(id, { group: libraryItem.group });\r\n        }\r\n\r\n        // Play the track\r\n        await this.playTrack(id);\r\n      }\r\n    } else {\r\n      // Add entire playlist to queue if not already there\r\n      const playlist = this.libraryManager.playlists.getPlaylist(id);\r\n      if (playlist) {\r\n        const queueItems = this.queueManager.getItems();\r\n        const existingPlaylistItems = queueItems.filter(\r\n          (item) => item.playlistId === id\r\n        );\r\n\r\n        if (existingPlaylistItems.length === 0) {\r\n          const tracks = this.libraryManager.playlists.getPlaylistTracks(id);\r\n          const playlistItems = tracks.map((t) => {\r\n            const item = this.libraryManager.getItem(t.libraryItemId);\r\n            return {\r\n              libraryItemId: t.libraryItemId,\r\n              group: item?.group || ('music' as const),\r\n            };\r\n          });\r\n          this.queueManager.addPlaylist(id, playlistItems as any);\r\n        }\r\n\r\n        // Play first track from playlist\r\n        await this.playPlaylist(id);\r\n      }\r\n    }\r\n    this.requestRender();\r\n  }\r\n\r\n  private onPauseFavorite(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const $el = $(event.currentTarget);\r\n    const id = $el.data('favorite-id') as string;\r\n    const type = $el.data('favorite-type') as string;\r\n\r\n    if (type === 'track') {\r\n      this.pauseTrack(id);\r\n    }\r\n    this.requestRender();\r\n  }\r\n\r\n  private onStopFavorite(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const $el = $(event.currentTarget);\r\n    const id = $el.data('favorite-id') as string;\r\n    const type = $el.data('favorite-type') as string;\r\n\r\n    if (type === 'track') {\r\n      this.stopTrack(id);\r\n    } else {\r\n      // Stop all tracks in playlist\r\n      this.stopPlaylist(id);\r\n    }\r\n    this.requestRender();\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Queue Item Handlers\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async onPlayQueueItem(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const $track = $(event.currentTarget).closest('.ase-queue-track');\r\n    const itemId = $track.data('item-id') as string;\r\n    await this.playTrack(itemId);\r\n    this.requestRender();\r\n  }\r\n\r\n  private onPauseQueueItem(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const $track = $(event.currentTarget).closest('.ase-queue-track');\r\n    const itemId = $track.data('item-id') as string;\r\n    this.pauseTrack(itemId);\r\n    this.requestRender();\r\n  }\r\n\r\n  private onStopQueueItem(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const $track = $(event.currentTarget).closest('.ase-queue-track');\r\n    const itemId = $track.data('item-id') as string;\r\n    this.stopTrack(itemId);\r\n    this.requestRender();\r\n  }\r\n\r\n  private onRemoveQueueItem(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const $track = $(event.currentTarget).closest('.ase-queue-track');\r\n    const queueId = $track.data('queue-id') as string;\r\n    const itemId = $track.data('item-id') as string;\r\n\r\n    // Stop the track first\r\n    this.stopTrack(itemId);\r\n    // Remove from queue\r\n    this.queueManager.removeItem(queueId);\r\n    this.requestRender();\r\n  }\r\n\r\n  private onLoopQueueItem(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const $track = $(event.currentTarget).closest('.ase-queue-track');\r\n    const itemId = $track.data('item-id') as string;\r\n    const $icon = $(event.currentTarget);\r\n\r\n    const currentLoop = $icon.hasClass('active');\r\n    const newLoop = !currentLoop;\r\n\r\n    this.engine.setTrackLoop(itemId, newLoop);\r\n\r\n    // Trigger save to persist loop state\r\n    (this.engine as any).scheduleSave?.();\r\n\r\n    if (newLoop) {\r\n      $icon.addClass('active').css('color', 'var(--accent-cyan)');\r\n    } else {\r\n      $icon.removeClass('active').css('color', '');\r\n    }\r\n  }\r\n\r\n  private async onAddToQueueFromFavorite(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const $el = $(event.currentTarget);\r\n    const id = $el.data('favorite-id') as string;\r\n    const type = $el.data('favorite-type') as 'track' | 'playlist';\r\n\r\n    if (type === 'track') {\r\n      const libraryItem = this.libraryManager.getItem(id);\r\n      if (libraryItem) {\r\n        this.queueManager.addItem(id, { group: libraryItem.group });\r\n        Logger.info('Added track to queue:', libraryItem.name);\r\n      }\r\n    } else {\r\n      // Add entire playlist to queue\r\n      const playlist = this.libraryManager.playlists.getPlaylist(id);\r\n      if (playlist) {\r\n        const tracks = this.libraryManager.playlists.getPlaylistTracks(id);\r\n        const playlistItems = tracks.map(t => {\r\n          const item = this.libraryManager.getItem(t.libraryItemId);\r\n          return {\r\n            libraryItemId: t.libraryItemId,\r\n            group: item?.group || 'music' as const,\r\n          };\r\n        });\r\n        this.queueManager.addPlaylist(id, playlistItems as any);\r\n        Logger.info('Added playlist to queue:', playlist.name);\r\n      }\r\n    }\r\n    this.requestRender();\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Playlist Toggle\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private onTogglePlaylist(event: JQuery.ClickEvent): void {\r\n    const $playlist = $(event.currentTarget).closest('.ase-queue-playlist');\r\n    const playlistId = $playlist.data('playlist-id') as string;\r\n\r\n    if (!playlistId) return;\r\n\r\n    if (this.collapsedPlaylists.has(playlistId)) {\r\n      this.collapsedPlaylists.delete(playlistId);\r\n      $playlist.removeClass('is-collapsed');\r\n      // Show all tracks\r\n      $playlist.find('.ase-queue-track').show();\r\n    } else {\r\n      this.collapsedPlaylists.add(playlistId);\r\n      $playlist.addClass('is-collapsed');\r\n      // Hide non-playing/paused tracks\r\n      $playlist.find('.ase-queue-track').each((_, el) => {\r\n        const $el = $(el);\r\n        if (!$el.hasClass('is-playing') && !$el.hasClass('is-paused')) {\r\n          $el.hide();\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Track Controls\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private onSeek(event: JQuery.TriggeredEvent): void {\r\n    const $track = $(event.currentTarget).closest('.ase-queue-track');\r\n    const itemId = $track.data('item-id') as string;\r\n    const value = parseFloat($(event.currentTarget).val() as string);\r\n\r\n    const player = this.engine.getTrack(itemId);\r\n    if (player) {\r\n      const seekTime = (value / 100) * player.getDuration();\r\n      this.engine.seekTrack(itemId, seekTime);\r\n\r\n      // Throttled sync for socket\r\n      if (this.socket.syncEnabled) {\r\n        if (!this.seekThrottleTimers.has(itemId)) {\r\n          this.seekThrottleTimers.set(itemId, setTimeout(() => {\r\n            this.seekThrottleTimers.delete(itemId);\r\n            const currentPlayer = this.engine.getTrack(itemId);\r\n            if (currentPlayer) {\r\n              this.socket.broadcastTrackSeek(itemId, currentPlayer.getCurrentTime(), currentPlayer.state === 'playing');\r\n            }\r\n          }, SoundMixerApp.THROTTLE_MS));\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private onVolumeChange(event: JQuery.TriggeredEvent): void {\r\n    const $track = $(event.currentTarget).closest('.ase-queue-track');\r\n    const itemId = $track.data('item-id') as string;\r\n    const value = parseInt($(event.currentTarget).val() as string, 10);\r\n    const volume = value / 100;\r\n\r\n    // Update engine volume\r\n    this.engine.setTrackVolume(itemId, volume);\r\n\r\n    // Throttled sync for socket\r\n    if (this.socket.syncEnabled) {\r\n      if (!this.volumeThrottleTimers.has(itemId)) {\r\n        this.volumeThrottleTimers.set(itemId, setTimeout(() => {\r\n          this.volumeThrottleTimers.delete(itemId);\r\n          const currentPlayer = this.engine.getTrack(itemId);\r\n          if (currentPlayer) {\r\n            this.socket.broadcastTrackVolume(itemId, currentPlayer.volume);\r\n          }\r\n        }, SoundMixerApp.THROTTLE_MS));\r\n      }\r\n    }\r\n\r\n    // Update display\r\n    $track.find('.ase-volume-value').text(`${value}%`);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Playback Core Methods\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async playTrack(itemId: string): Promise<void> {\r\n    const libraryItem = this.libraryManager.getItem(itemId);\r\n    if (!libraryItem) {\r\n      Logger.warn('Track not found in library:', itemId);\r\n      return;\r\n    }\r\n\r\n    let player = this.engine.getTrack(itemId);\r\n\r\n    // If player exists and is paused, resume from current position\r\n    if (player && player.state === 'paused') {\r\n      const offset = player.getCurrentTime();\r\n      await this.engine.playTrack(itemId, offset);\r\n\r\n      if (this.socket.syncEnabled) {\r\n        this.socket.broadcastTrackPlay(itemId, offset);\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Create track if not exists\r\n    if (!player) {\r\n      player = await this.engine.createTrack({\r\n        id: itemId,\r\n        url: libraryItem.url,\r\n        group: libraryItem.group,\r\n        volume: 1,\r\n        loop: false,\r\n      });\r\n    }\r\n\r\n    await this.engine.playTrack(itemId);\r\n\r\n    // Sync if enabled\r\n    if (this.socket.syncEnabled) {\r\n      this.socket.broadcastTrackPlay(itemId, 0);\r\n    }\r\n  }\r\n\r\n  private pauseTrack(itemId: string): void {\r\n    const player = this.engine.getTrack(itemId);\r\n    this.engine.pauseTrack(itemId);\r\n\r\n    if (this.socket.syncEnabled && player) {\r\n      this.socket.broadcastTrackPause(itemId, player.getCurrentTime());\r\n    }\r\n  }\r\n\r\n  private stopTrack(itemId: string): void {\r\n    this.engine.stopTrack(itemId);\r\n\r\n    if (this.socket.syncEnabled) {\r\n      this.socket.broadcastTrackStop(itemId);\r\n    }\r\n  }\r\n\r\n  private async playPlaylist(playlistId: string): Promise<void> {\r\n    const tracks = this.libraryManager.playlists.getPlaylistTracks(playlistId);\r\n    if (!tracks.length) return;\r\n\r\n    // Play first track\r\n    const firstTrack = tracks[0];\r\n    await this.playTrack(firstTrack.libraryItemId);\r\n  }\r\n\r\n  private stopPlaylist(playlistId: string): void {\r\n    const tracks = this.libraryManager.playlists.getPlaylistTracks(playlistId);\r\n    for (const track of tracks) {\r\n      this.stopTrack(track.libraryItemId);\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Real-time Updates\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private startUpdates(): void {\r\n    if (this.updateInterval) return;\r\n    this.updateInterval = setInterval(() => this.updateTrackDisplays(), 100);\r\n  }\r\n\r\n  stopUpdates(): void {\r\n    if (this.updateInterval) {\r\n      clearInterval(this.updateInterval);\r\n      this.updateInterval = null;\r\n    }\r\n  }\r\n\r\n  private updateTrackDisplays(): void {\r\n    if (!this.html) return;\r\n\r\n    this.html.find('.ase-queue-track').each((_, el) => {\r\n      const $track = $(el);\r\n      const itemId = $track.data('item-id') as string;\r\n      const player = this.engine.getTrack(itemId);\r\n\r\n      if (player) {\r\n        const currentTime = player.getCurrentTime();\r\n        const duration = player.getDuration();\r\n        const progress = duration > 0 ? (currentTime / duration) * 100 : 0;\r\n\r\n        $track.find('.ase-time-current').text(formatTime(currentTime));\r\n        $track.find('.ase-seek-slider').val(progress);\r\n\r\n        // Update state classes\r\n        $track.removeClass('is-playing is-paused');\r\n        if (player.state === 'playing') {\r\n          $track.addClass('is-playing');\r\n        } else if (player.state === 'paused') {\r\n          $track.addClass('is-paused');\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  private onQueueChange(): void {\r\n    Logger.debug('Queue changed, mixer should refresh');\r\n    this.requestRender();\r\n  }\r\n\r\n  private requestRender(): void {\r\n    if (this.renderParent) {\r\n      this.renderParent();\r\n    }\r\n  }\r\n\r\n  private onToggleEffect(event: JQuery.ChangeEvent): void {\r\n    const $checkbox = $(event.currentTarget) as JQuery<HTMLInputElement>;\r\n    const effectId = $checkbox.data('effect-id') as string;\r\n    const enabled = $checkbox.is(':checked');\r\n\r\n    this.engine.setEffectEnabled(effectId, enabled);\r\n    Logger.info(`Effect ${effectId} ${enabled ? 'enabled' : 'disabled'}`);\r\n  }\r\n}","import { Logger } from '@utils/logger';\r\nimport type { LibraryState } from '@t/library';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\n\r\n/**\r\n * GlobalStorage - Cross-world persistent storage using JSON files\r\n * \r\n * Stores library data in Data/ase_library/library.json\r\n * which persists across all worlds in Foundry and survives module updates\r\n */\r\nexport class GlobalStorage {\r\n    private static readonly FILE_PATH = '/ase_library/library.json';\r\n    private static readonly PRESETS_FILE_PATH = '/ase_library/presets.json';\r\n    private static readonly FILE_SOURCE = 'data';\r\n    private static readonly DIRECTORY = 'ase_library';\r\n\r\n    /**\r\n     * Load presets from global JSON file\r\n     */\r\n    static async loadPresets(): Promise<any[]> {\r\n        try {\r\n            const response = await fetch(`${this.PRESETS_FILE_PATH}?t=${Date.now()}`);\r\n            if (!response.ok) return this.getDefaultPresets();\r\n            const data = await response.json();\r\n            return data.length > 0 ? data : this.getDefaultPresets();\r\n        } catch (error) {\r\n            Logger.warn('Failed to load presets:', error);\r\n            return this.getDefaultPresets();\r\n        }\r\n    }\r\n\r\n    private static getDefaultPresets(): any[] {\r\n        return [\r\n            {\r\n                id: 'preset-cave',\r\n                name: 'Cave',\r\n                effects: [\r\n                    { type: 'reverb', params: { ir: 'cave', level: 1.2 }, routing: { music: false, sfx: true, ambience: true } },\r\n                    { type: 'delay', params: { time: 0.15, feedback: 0.3, level: 0.5 }, routing: { music: false, sfx: true, ambience: false } }\r\n                ]\r\n            },\r\n            {\r\n                id: 'preset-underwater',\r\n                name: 'Underwater',\r\n                effects: [\r\n                    { type: 'filter', params: { type: 'lowpass', frequency: 600, Q: 1.0, level: 1.0 }, routing: { music: true, sfx: true, ambience: true } }\r\n                ]\r\n            },\r\n            {\r\n                id: 'preset-radio',\r\n                name: 'Old Radio',\r\n                effects: [\r\n                    { type: 'filter', params: { type: 'bandpass', frequency: 2000, Q: 2.0, level: 1.5 }, routing: { music: true, sfx: true, ambience: true } },\r\n                    { type: 'distortion', params: { drive: 20, level: 0.8 }, routing: { music: true, sfx: true, ambience: true } }\r\n                ]\r\n            }\r\n        ];\r\n    }\r\n\r\n    /**\r\n     * Save presets to global JSON file\r\n     */\r\n    static async savePresets(presets: any[]): Promise<void> {\r\n        return this.saveFile(this.PRESETS_FILE_PATH, presets);\r\n    }\r\n\r\n    /**\r\n     * Generic save helper (refactored from save method)\r\n     */\r\n    private static async saveFile(path: string, data: any): Promise<void> {\r\n        try {\r\n            await this.ensureDirectory();\r\n            const json = JSON.stringify(data, null, 2);\r\n            const blob = new Blob([json], { type: 'application/json' });\r\n            const file = new File([blob], path.split('/').pop()!, { type: 'application/json' });\r\n\r\n            const originalInfo = ui.notifications?.info;\r\n            if (ui.notifications) ui.notifications.info = (() => { }) as any;\r\n\r\n            try {\r\n                await FilePicker.upload(this.FILE_SOURCE, this.DIRECTORY, file, {});\r\n            } finally {\r\n                if (ui.notifications && originalInfo) ui.notifications.info = originalInfo;\r\n            }\r\n        } catch (error) {\r\n            Logger.error(`Failed to save file ${path}:`, error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Load library state from global JSON file\r\n     */\r\n    static async load(): Promise<LibraryState | null> {\r\n        try {\r\n            // Attempt to fetch the file\r\n            const response = await fetch(`${this.FILE_PATH}?t=${Date.now()}`);\r\n\r\n            if (!response.ok) {\r\n                Logger.info('No existing library file found');\r\n                return null;\r\n            }\r\n\r\n            const data = await response.json();\r\n            Logger.info('Loaded library from global storage');\r\n            return data as LibraryState;\r\n        } catch (error) {\r\n            Logger.warn('Failed to load global library:', error);\r\n            return null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Save library state to global JSON file\r\n     */\r\n    static async save(state: LibraryState): Promise<void> {\r\n        try {\r\n            await this.saveFile(this.FILE_PATH, state);\r\n            Logger.info('Saved library to global storage');\r\n        } catch (error) {\r\n            Logger.error('Failed to save library to global storage:', error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Ensure the module directory exists\r\n     */\r\n    private static async ensureDirectory(): Promise<void> {\r\n        try {\r\n            await FilePicker.createDirectory(this.FILE_SOURCE, this.DIRECTORY, {});\r\n        } catch (error) {\r\n            // Directory might already exist, ignore error\r\n            Logger.debug('Directory creation skipped (may already exist)');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Migrate data from world-scoped game.settings to global storage\r\n     */\r\n    static async migrateFromWorldSettings(): Promise<boolean> {\r\n        try {\r\n            // Check if we already have global storage\r\n            const existingGlobal = await this.load();\r\n            const itemsCount = existingGlobal?.items ?\r\n                (Array.isArray(existingGlobal.items) ? existingGlobal.items.length : Object.keys(existingGlobal.items).length) : 0;\r\n\r\n            if (existingGlobal && existingGlobal.items && itemsCount > 0) {\r\n                Logger.info('Global storage already populated, skipping migration');\r\n                return false;\r\n            }\r\n\r\n            // Try to load from old world-scoped settings\r\n            const oldData = await game.settings?.get(MODULE_ID as any, 'libraryState' as any) as string;\r\n            if (!oldData || oldData === '') {\r\n                Logger.info('No world-scoped data to migrate');\r\n                return false;\r\n            }\r\n\r\n            // Parse and save to global storage\r\n            const state = JSON.parse(oldData) as LibraryState;\r\n\r\n            // Only migrate if there's actual data\r\n            if (!state.items || (Array.isArray(state.items) ? state.items.length === 0 : Object.keys(state.items).length === 0)) {\r\n                Logger.info('World-scoped data is empty, skipping migration');\r\n                return false;\r\n            }\r\n\r\n            await this.save(state);\r\n\r\n            const itemCount = Array.isArray(state.items) ? state.items.length : Object.keys(state.items).length;\r\n            Logger.info(`Migrated ${itemCount} items from world settings to global storage`);\r\n            ui.notifications?.info(`ASE: Library migrated to global storage (${itemCount} tracks)`);\r\n\r\n            return true;\r\n        } catch (error) {\r\n            Logger.error('Migration from world settings failed:', error);\r\n            return false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Delete a physical file from disk\r\n     * Shows manual deletion instructions since automatic deletion is unreliable\r\n     */\r\n    static async deletePhysicalFile(url: string): Promise<boolean> {\r\n        if (!this.isOurFile(url)) {\r\n            Logger.warn('Cannot delete file not in ase_audio folder:', url);\r\n            return false;\r\n        }\r\n\r\n        if (!game.user?.isGM) {\r\n            ui.notifications?.warn('Only GM can delete files');\r\n            return false;\r\n        }\r\n\r\n        // Parse file path\r\n        let filePath = url.replace(/\\\\/g, '/');\r\n        filePath = filePath.replace(/^\\/*/, '');\r\n        filePath = filePath.replace(/^Data\\//i, '');\r\n\r\n        // Show manual deletion dialog\r\n        const content = `\r\n            <div style=\"padding: 10px;\">\r\n                <p>Automatic file deletion is not available in this Foundry configuration.</p>\r\n                <p style=\"margin-top: 10px;\"><strong>To manually delete this file:</strong></p>\r\n                <ol style=\"margin-left: 20px; margin-top: 10px;\">\r\n                    <li>Navigate to your Foundry <code>Data</code> folder</li>\r\n                    <li>Find and delete: <code style=\"background: #1e293b; padding: 2px 6px; border-radius: 3px; color: #22d3ee;\">${filePath}</code></li>\r\n                </ol>\r\n                <p style=\"margin-top: 10px; color: #94a3b8; font-size: 12px;\">The track will be removed from the library now, but the file will remain on disk until manually deleted.</p>\r\n            </div>\r\n        `;\r\n\r\n        await Dialog.prompt({\r\n            title: 'Manual File Deletion Required',\r\n            content,\r\n            callback: () => { },\r\n            options: { width: 500 }\r\n        });\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Check if file URL belongs to our module storage\r\n     * Handles various URL formats from different Foundry versions and platforms\r\n     */\r\n    static isOurFile(url: string): boolean {\r\n        // Normalize path separators and remove leading slashes\r\n        const normalizedUrl = url.replace(/\\\\/g, '/').toLowerCase();\r\n\r\n        // Check for our dedicated folder in various formats:\r\n        // - ase_audio/file.mp3\r\n        // - /ase_audio/file.mp3\r\n        // - Data/ase_audio/file.mp3\r\n        // - modules/advanced-sound-engine/ase_audio/file.mp3\r\n        return normalizedUrl.includes('ase_audio/') ||\r\n            normalizedUrl.includes('/ase_audio/') ||\r\n            normalizedUrl.endsWith('ase_audio');\r\n    }\r\n}\r\n","import { AudioEngine } from '@core/AudioEngine';\r\nimport { SocketManager } from '@sync/SocketManager';\r\nimport { GlobalStorage } from '@storage/GlobalStorage';\r\nimport type { EffectType, EffectState, EffectParam } from '@t/effects';\r\nimport type { TrackGroup } from '@t/audio';\r\nimport { Logger } from '@utils/logger';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\n\r\nexport class SoundEffectsApp {\r\n    private engine: AudioEngine;\r\n    private socket: SocketManager;\r\n    private storage: GlobalStorage;\r\n    private html: JQuery | null = null;\r\n    private renderParent: (() => void) | null = null;\r\n    private updateInterval: ReturnType<typeof setInterval> | null = null;\r\n\r\n    constructor(\r\n        engine: AudioEngine,\r\n        socket: SocketManager,\r\n        storage: GlobalStorage\r\n    ) {\r\n        this.engine = engine;\r\n        this.socket = socket;\r\n        this.storage = storage;\r\n    }\r\n\r\n    setRenderCallback(callback: () => void): void {\r\n        this.renderParent = callback;\r\n    }\r\n\r\n    async getData() {\r\n        try {\r\n            // Load presets\r\n            const presets = await GlobalStorage.loadPresets();\r\n\r\n            // Transform effects into view data\r\n            const effects = this.engine.getAllEffects().map(effect => {\r\n                const state = this.engine.getEffectState(effect.type)!;\r\n\r\n                // Calculate Main Knob Rotation (Level)\r\n                // Range 0 to 2.0 -> -135deg to +135deg\r\n                const levelVal = (state.params['level'] as number) || 1.0;\r\n                const rotation = (levelVal / 2.0) * 270 - 135;\r\n\r\n                return {\r\n                    ...state,\r\n                    // Helper for template to render specific controls if needed\r\n                    isReverb: state.type === 'reverb',\r\n                    isDelay: state.type === 'delay',\r\n                    mainValue: levelVal.toFixed(2), // Display value\r\n                    mainParamRotation: rotation,\r\n                    // Add metadata for params (min, max, etc) which are not in state\r\n                    params: Object.entries(state.params).map(([key, value]) => {\r\n                        const paramConfig = (effect as any).params.get(key) as EffectParam;\r\n                        // Skip 'level' from the list if we treat it as the main knob only?\r\n                        // Or keep it as a slider too for precision? Let's keep it for now or hide it via CSS if needed.\r\n                        // Actually, let's filter it out from the list if it's the main knob to avoid duplication? \r\n                        // No, let's keep it in the list for now, user might want fine control.\r\n                        return {\r\n                            ...paramConfig,\r\n                            value: value\r\n                        };\r\n                    }).filter(p => p.id !== 'level') // Filter out level from the slider list to avoid clutter\r\n                };\r\n            });\r\n\r\n            // Sort order: Reverb, Filter, Delay, Compressor, Distortion\r\n            const sortOrder: EffectType[] = ['reverb', 'filter', 'delay', 'compressor', 'distortion'];\r\n            effects.sort((a, b) => sortOrder.indexOf(a.type) - sortOrder.indexOf(b.type));\r\n\r\n            return {\r\n                effects,\r\n                presets\r\n            };\r\n        } catch (error) {\r\n            Logger.error('Failed to get data for SoundEffectsApp:', error);\r\n            // Return safe default data to allow render\r\n            return {\r\n                effects: [],\r\n                presets: []\r\n            };\r\n        }\r\n    }\r\n\r\n    activateListeners(html: JQuery): void {\r\n        this.html = html;\r\n\r\n        console.log(\"AudioSoundEngine | SoundEffectsApp | View Loaded\");\r\n\r\n        // Event Delegation for Enable Toggle\r\n        // IMPORTANT: Unbind first to prevent conflicting multiple listeners on root element re-renders\r\n        html.off('click', '.ase-effect-toggle').on('click', '.ase-effect-toggle', (e) => this.onToggleEnable(e));\r\n\r\n        // Routing Buttons\r\n        html.off('click', '[data-action=\"toggle-route\"]').on('click', '[data-action=\"toggle-route\"]', (e) => this.onToggleRoute(e));\r\n\r\n        // Knobs / Sliders\r\n        // These are direct binds to new elements (found via find), so no accumulation issue, \r\n        // but ensuring cleanliness is good practice if elements weren't replaced. \r\n        // Since re-render replaces content, direct binds are fine.\r\n        html.find('.ase-param-slider').on('input', (e) => this.onParamChange(e));\r\n        html.find('.ase-param-input').on('change', (e) => this.onParamChange(e));\r\n\r\n        // Circular Knob Interaction\r\n        html.find('.ase-knob-circle').on('mousedown', (e) => this.onKnobCheck(e));\r\n\r\n        // Presets\r\n        html.find('[data-action=\"save-preset\"]').on('click', (e) => this.onSavePreset(e));\r\n        html.find('#ase-preset-select').on('change', (e) => this.onLoadPreset(e));\r\n    }\r\n\r\n    private onKnobCheck(event: JQuery.TriggeredEvent): void {\r\n        const $knob = $(event.currentTarget);\r\n        const $card = $knob.closest('.ase-effect-card');\r\n        const effectId = $card.data('effect-id') as string;\r\n\r\n        const startY = (event as any).pageY;\r\n        // We need to know current value to offset\r\n        // But since we are directly manipulating styling/value, we can read from engine or DOM\r\n        // Simpler: just use delta to inc/dec\r\n        const state = this.engine.getEffectState(effectId)!;\r\n        let currentValue = (state.params['level'] as number) || 1.0;\r\n\r\n        const onMouseMove = (moveEvent: JQuery.TriggeredEvent) => {\r\n            const pageY = (moveEvent as any).pageY || (moveEvent.originalEvent as MouseEvent).pageY;\r\n            const deltaY = startY - pageY; // Up is positive\r\n            const sensitivity = 0.01;\r\n            let newValue = currentValue + (deltaY * sensitivity);\r\n\r\n            // Clamp 0 to 2.0\r\n            newValue = Math.max(0, Math.min(2.0, newValue));\r\n\r\n            // Update UI immediately\r\n            const rotation = (newValue / 2.0) * 270 - 135;\r\n            $knob.css('--knob-rotation', `${rotation}deg`);\r\n            $knob.find('.ase-knob-value').text(newValue.toFixed(2));\r\n\r\n            // Update Engine\r\n            this.engine.setEffectParam(effectId, 'level', newValue);\r\n            this.socket.broadcastEffectParam(effectId, 'level', newValue);\r\n        };\r\n\r\n        const onMouseUp = () => {\r\n            $(document).off('mousemove', onMouseMove as any);\r\n            $(document).off('mouseup', onMouseUp as any);\r\n        };\r\n\r\n        $(document).on('mousemove', onMouseMove as any);\r\n        $(document).on('mouseup', onMouseUp as any);\r\n    }\r\n\r\n    private onToggleEnable(event: JQuery.ClickEvent): void {\r\n        event.preventDefault();\r\n\r\n        const $toggle = $(event.currentTarget);\r\n        const $card = $toggle.closest('.ase-effect-card');\r\n        const effectId = $card.data('effect-id') as string;\r\n\r\n        const wasEnabled = $card.hasClass('enabled');\r\n        const newState = !wasEnabled;\r\n\r\n        this.engine.setEffectEnabled(effectId, newState);\r\n        this.socket.broadcastEffectEnabled(effectId, newState);\r\n\r\n        // UI Update\r\n        if (newState) {\r\n            $card.addClass('enabled');\r\n        } else {\r\n            $card.removeClass('enabled');\r\n        }\r\n    }\r\n\r\n    private onToggleRoute(event: JQuery.ClickEvent): void {\r\n        event.preventDefault();\r\n        const $btn = $(event.currentTarget);\r\n        const $card = $btn.closest('.ase-effect-card');\r\n        const effectId = $card.data('effect-id') as string;\r\n        const channel = $btn.data('channel') as TrackGroup;\r\n\r\n        const isActive = $btn.hasClass('active');\r\n        const newState = !isActive;\r\n\r\n        this.engine.setEffectRouting(effectId, channel, newState);\r\n        this.socket.broadcastEffectRouting(effectId, channel, newState);\r\n\r\n        // UI Update immediately for responsiveness\r\n        if (newState) $btn.addClass('active');\r\n        else $btn.removeClass('active');\r\n    }\r\n\r\n    private onParamChange(event: JQuery.TriggeredEvent): void {\r\n        const $input = $(event.currentTarget);\r\n        const $card = $input.closest('.ase-effect-card');\r\n        const effectId = $card.data('effect-id') as string;\r\n        const paramId = $input.data('param-id') as string;\r\n\r\n        let value: string | number | boolean = $input.val() as string;\r\n\r\n        // Check type of param\r\n        if ($input.attr('type') === 'range') {\r\n            value = parseFloat(value);\r\n            // Update display value\r\n            $card.find(`.ase-param-control:has([data-param-id=\"${paramId}\"]) .ase-param-val`).text(value); // Hacky selector\r\n            // Better:\r\n            $input.siblings('.ase-param-val').text(value);\r\n        }\r\n\r\n        this.engine.setEffectParam(effectId, paramId, value);\r\n        this.socket.broadcastEffectParam(effectId, paramId, value);\r\n    }\r\n\r\n\r\n    private async onSavePreset(event: JQuery.ClickEvent): Promise<void> {\r\n        event.preventDefault();\r\n\r\n        // Get preset name\r\n        const content = `\r\n            <div class=\"form-group\">\r\n                <label>Preset Name</label>\r\n                <input type=\"text\" name=\"name\" placeholder=\"My Cool Preset\"/>\r\n            </div>\r\n        `;\r\n\r\n        new Dialog({\r\n            title: \"Save Effect Preset\",\r\n            content: content,\r\n            buttons: {\r\n                save: {\r\n                    label: \"Save\",\r\n                    callback: async (html: JQuery) => {\r\n                        const name = html.find('input[name=\"name\"]').val() as string;\r\n                        if (!name) return;\r\n\r\n                        await this.savePreset(name);\r\n                    }\r\n                }\r\n            }\r\n        }).render(true);\r\n    }\r\n\r\n    private async savePreset(name: string): Promise<void> {\r\n        // Collect state\r\n        const effects = this.engine.getAllEffects().map(e => this.engine.getEffectState(e.id)!);\r\n\r\n        const newPreset = {\r\n            id: generateUUID(), // We need a UUID helper or just Math.random\r\n            name,\r\n            effects\r\n        };\r\n\r\n        // Load existing, append, save\r\n        const presets = await GlobalStorage.loadPresets();\r\n        presets.push(newPreset);\r\n        await GlobalStorage.savePresets(presets);\r\n\r\n        ui.notifications?.info(`Saved preset: ${name}`);\r\n        this.renderParent?.();\r\n    }\r\n\r\n    private async onLoadPreset(event: JQuery.ChangeEvent): Promise<void> {\r\n        const presetId = $(event.currentTarget).val() as string;\r\n        if (!presetId) return;\r\n\r\n        const presets = await GlobalStorage.loadPresets();\r\n        const preset = presets.find((p: any) => p.id === presetId);\r\n\r\n        if (preset) {\r\n            // Apply all effects\r\n            for (const effectState of preset.effects) {\r\n                // Determine if we match by ID or Type\r\n                // Since Effect IDs might change or be fixed, matching by Type is safer for a Rack\r\n                // But if we support multiple instances of same type, we need index or ID\r\n                // For now, Single Rack (one of each type)\r\n\r\n                const existingEffect = this.engine.getAllEffects().find(e => e.type === effectState.type);\r\n                if (existingEffect) {\r\n                    // Apply PArsims\r\n                    for (const [key, value] of Object.entries(effectState.params)) {\r\n                        this.engine.setEffectParam(existingEffect.id, key, value);\r\n                    }\r\n\r\n                    // Apply Routing\r\n                    if (effectState.routing) {\r\n                        // engine.setRouting? engine.setEffectRouting\r\n                        for (const [group, active] of Object.entries(effectState.routing)) {\r\n                            this.engine.setEffectRouting(existingEffect.id, group as any, active as boolean);\r\n                        }\r\n                    }\r\n\r\n                    // Apply Enabled?\r\n                    // engine.setEffectEnabled?\r\n                }\r\n            }\r\n            ui.notifications?.info(`Loaded preset: ${preset.name}`);\r\n            this.renderParent?.();\r\n\r\n            // Broadcast full state to sync all clients\r\n            this.socket.broadcastFullState();\r\n        }\r\n    }\r\n\r\n    destroy(): void {\r\n        this.html = null;\r\n    }\r\n}\r\n\r\n// Helper if not imported\r\nfunction generateUUID() {\r\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\r\n        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);\r\n        return v.toString(16);\r\n    });\r\n}\r\n","import { AudioEngine } from '@core/AudioEngine';\r\nimport { SocketManager } from '@sync/SocketManager';\r\nimport { LibraryManager } from '@lib/LibraryManager';\r\nimport { PlaybackQueueManager } from '@queue/PlaybackQueueManager';\r\nimport { LocalLibraryApp } from './LocalLibraryApp';\r\nimport { SoundMixerApp } from './SoundMixerApp';\r\nimport { SoundEffectsApp } from './SoundEffectsApp';\r\nimport { Logger } from '@utils/logger';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\n\r\nconst { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\r\n\r\ninterface AppState {\r\n    activeTab: 'mixer' | 'library' | 'online' | 'sfx';\r\n    syncEnabled: boolean;\r\n}\r\n\r\nexport class AdvancedSoundEngineApp extends HandlebarsApplicationMixin(ApplicationV2) {\r\n    private engine: AudioEngine;\r\n    private socket: SocketManager;\r\n    private libraryManager: LibraryManager;\r\n    private queueManager: PlaybackQueueManager;\r\n\r\n    // Sub-apps (Controllers)\r\n    private libraryApp: LocalLibraryApp;\r\n    private mixerApp: SoundMixerApp;\r\n    private effectsApp: SoundEffectsApp;\r\n\r\n    public state: AppState = {\r\n        activeTab: 'library', // Default to library as per user focus\r\n        syncEnabled: false\r\n    };\r\n\r\n    /**\r\n     * Define the templates used by this application.\r\n     * In V2, we define parts rather than a single template.\r\n     */\r\n    static override PARTS = {\r\n        main: {\r\n            template: `modules/${MODULE_ID}/templates/main-app.hbs`,\r\n            scrollable: ['.ase-content-body']\r\n        }\r\n    };\r\n\r\n    static override DEFAULT_OPTIONS = {\r\n        id: 'advanced-sound-engine-app',\r\n        tag: 'form',\r\n        window: {\r\n            title: 'Advanced Sound Engine',\r\n            icon: 'fas fa-music',\r\n            resizable: true,\r\n            controls: []\r\n        },\r\n        position: {\r\n            width: 1440,\r\n            height: 1050\r\n        },\r\n        classes: ['ase-window-layout']\r\n    };\r\n\r\n    constructor(engine: AudioEngine, socket: SocketManager, libraryManager: LibraryManager, queueManager: PlaybackQueueManager, options: any = {}) {\r\n        super(options);\r\n        this.engine = engine;\r\n        this.socket = socket;\r\n        this.libraryManager = libraryManager;\r\n        this.queueManager = queueManager;\r\n\r\n        // Initialize sub-controllers\r\n        this.libraryApp = new LocalLibraryApp(this.libraryManager, this);\r\n        this.mixerApp = new SoundMixerApp(this.engine, this.socket, this.libraryManager, this.queueManager);\r\n        this.effectsApp = new SoundEffectsApp(this.engine, this.socket, this.libraryManager.storage);\r\n\r\n        // Set render callback for mixer to trigger parent re-render\r\n        this.mixerApp.setRenderCallback(() => {\r\n            if (this.state.activeTab === 'mixer') {\r\n                this.render({ parts: ['main'] });\r\n            }\r\n        });\r\n\r\n        this.effectsApp.setRenderCallback(() => {\r\n            if (this.state.activeTab === 'sfx') {\r\n                this.render({ parts: ['main'] });\r\n            }\r\n        });\r\n\r\n        // Subscribe to queue changes for UI updates\r\n        this.queueManager.on('change', () => {\r\n            if (this.state.activeTab === 'mixer') {\r\n                this.render({ parts: ['main'] });\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * V2 Context Preparation (replaces getData)\r\n     */\r\n    protected override async _prepareContext(options: any): Promise<any> {\r\n        const volumes = this.engine.volumes;\r\n\r\n        // Helper to check channel status\r\n        const getChannelStatus = (group: 'music' | 'ambience' | 'sfx') => {\r\n            const tracks = this.engine.getTracksByGroup(group);\r\n            if (tracks.length === 0) return { playing: false, paused: false };\r\n\r\n            const isPlaying = tracks.some(t => t.state === 'playing');\r\n            const isPaused = tracks.some(t => t.state === 'paused');\r\n\r\n            return { playing: isPlaying, paused: isPaused && !isPlaying };\r\n        };\r\n\r\n        const status = {\r\n            music: getChannelStatus('music'),\r\n            ambience: getChannelStatus('ambience'),\r\n            sfx: getChannelStatus('sfx')\r\n        };\r\n\r\n        // Get content for the active tab manually (legacy support for sub-apps returning data)\r\n        const renderTemplate = foundry.applications.handlebars.renderTemplate; // V13 Compatibility\r\n\r\n        let tabContent = '';\r\n        if (this.state.activeTab === 'library') {\r\n            const libData = await this.libraryApp.getData();\r\n            tabContent = await renderTemplate('modules/advanced-sound-engine/templates/library.hbs', libData as any);\r\n        } else if (this.state.activeTab === 'mixer') {\r\n            const mixerData = await this.mixerApp.getData();\r\n            tabContent = await renderTemplate(`modules/${MODULE_ID}/templates/mixer.hbs`, mixerData as any);\r\n        } else if (this.state.activeTab === 'sfx') {\r\n            Logger.info(`[AdvancedSoundEngineApp] Rendering SFX tab...`);\r\n            const effectsData = await this.effectsApp.getData();\r\n            tabContent = await renderTemplate(`modules/${MODULE_ID}/templates/effects.hbs`, effectsData as any);\r\n        }\r\n\r\n        return {\r\n            activeTab: this.state.activeTab,\r\n            tabContent,\r\n            status,\r\n            volumes: {\r\n                master: Math.round(volumes.master * 100),\r\n                music: Math.round(volumes.music * 100),\r\n                ambience: Math.round(volumes.ambience * 100),\r\n                sfx: Math.round(volumes.sfx * 100)\r\n            },\r\n            syncEnabled: this.socket.syncEnabled,\r\n            // Pass state for Handlebars if needed\r\n            tabs: [\r\n                { id: 'library', label: 'Library', icon: 'fas fa-book-open', active: this.state.activeTab === 'library' },\r\n                { id: 'mixer', label: 'Mixer', icon: 'fas fa-sliders-h', active: this.state.activeTab === 'mixer' },\r\n                { id: 'sfx', label: 'Effects', icon: 'fas fa-wave-square', active: this.state.activeTab === 'sfx' },\r\n                { id: 'online', label: 'Online', icon: 'fas fa-globe', active: this.state.activeTab === 'online' }\r\n            ]\r\n        };\r\n    }\r\n\r\n    /**\r\n     * V2 Render Hook (replaces activateListeners)\r\n     * Note: In V2, `this.element` is the HTML element itself, not a jQuery object.\r\n     * However, we wrap it in jQuery for compatibility with existing listener logic if preferred, \r\n     * or use vanilla JS. Sticking to jQuery for now to minimize logic rewrite risks.\r\n     */\r\n    protected override _onRender(context: any, options: any): void {\r\n        Logger.info(`[AdvancedSoundEngineApp] _onRender called. Active Tab: ${this.state.activeTab}`);\r\n        super._onRender(context, options);\r\n\r\n        // Wrap native element in jQuery for legacy compatibility\r\n        const html = $(this.element);\r\n\r\n        // Tab Navigation\r\n        html.find('.ase-tab').on('click', this.onTabSwitch.bind(this));\r\n\r\n        // Footer Controls (A7)\r\n        html.find('[data-action=\"toggle-sync\"]').on('click', this.onToggleSync.bind(this));\r\n        html.find('[data-action=\"global-play\"]').on('click', this.onGlobalPlay.bind(this));\r\n        html.find('[data-action=\"global-pause\"]').on('click', this.onGlobalPause.bind(this));\r\n        html.find('[data-action=\"global-stop\"]').on('click', this.onGlobalStop.bind(this));\r\n\r\n        // Mixer Sliders (Inputs)\r\n        html.find('.ase-volume-slider').on('input', this.onVolumeInput.bind(this));\r\n\r\n        // Delegate listeners to sub-apps\r\n        if (this.state.activeTab === 'library') {\r\n            this.libraryApp.activateListeners(html);\r\n        } else if (this.state.activeTab === 'mixer') {\r\n            this.mixerApp.activateListeners(html);\r\n        } else if (this.state.activeTab === 'sfx') {\r\n            Logger.info('[AdvancedSoundEngineApp] Delegating to effectsApp.activateListeners');\r\n            this.effectsApp.activateListeners(html);\r\n        }\r\n\r\n        // Restore Scroll \r\n        // V2 has native `scrollable` support in `PARTS`, but for complex intra-tab scrolling we might still need this manual handling\r\n        if (this.state.activeTab === 'library') {\r\n            if (this.persistScrollOnce) {\r\n                const scrollState = { ...this._scrollLibrary };\r\n                this.persistScrollOnce = false;\r\n\r\n                // Use setTimeout to ensure DOM is fully painted/layout is calculated\r\n                setTimeout(() => {\r\n                    const tracksList = html.find('.ase-track-player-list');\r\n                    const playlistList = html.find('.ase-list-group').first();\r\n                    const favList = html.find('.ase-favorites-section .ase-list-group');\r\n\r\n                    if (tracksList.length) tracksList.scrollTop(scrollState.tracks);\r\n                    if (playlistList.length) playlistList.scrollTop(scrollState.playlists);\r\n                    if (favList.length) favList.scrollTop(scrollState.favorites);\r\n\r\n                    Logger.info(`[SmartScroll] Restored scroll (delayed): Tracks=${scrollState.tracks}`);\r\n                }, 1);\r\n            }\r\n        }\r\n    }\r\n\r\n    public persistScrollOnce = false;\r\n    private _scrollLibrary = { tracks: 0, playlists: 0, favorites: 0 };\r\n\r\n    /**\r\n     * V2 Close Hook\r\n     */\r\n    protected override _onClose(options: any): void {\r\n        super._onClose(options);\r\n        // Any cleanup if needed\r\n    }\r\n\r\n    // ─────────────────────────────────────────────────────────────\r\n    // Event Handlers\r\n    // ─────────────────────────────────────────────────────────────\r\n\r\n    private async onTabSwitch(event: JQuery.ClickEvent): Promise<void> {\r\n        event.preventDefault();\r\n        const tabName = $(event.currentTarget).data('tab');\r\n        if (this.state.activeTab === tabName) return;\r\n\r\n        // Before switching, save scroll if leaving library (optional, or just reset)\r\n        if (this.state.activeTab === 'library') {\r\n            const html = $(this.element);\r\n            this._scrollLibrary.tracks = html.find('.ase-track-player-list').scrollTop() || 0;\r\n            this._scrollLibrary.playlists = html.find('.ase-list-group').first().scrollTop() || 0;\r\n        }\r\n\r\n        this.state.activeTab = tabName;\r\n        this.render({ parts: ['main'] });\r\n    }\r\n\r\n    /**\r\n     * Captures the current scroll positions of the library tab.\r\n     * Call this before triggering a re-render if you want to restore scroll afterwards.\r\n     * Sets persistScrollOnce to true automatically.\r\n     */\r\n    public captureLibraryScroll(): void {\r\n        if (this.state.activeTab !== 'library') return;\r\n\r\n        const html = $(this.element);\r\n        this._scrollLibrary.tracks = html.find('.ase-track-player-list').scrollTop() || 0;\r\n        this._scrollLibrary.playlists = html.find('.ase-list-group').first().scrollTop() || 0;\r\n        this._scrollLibrary.favorites = html.find('.ase-favorites-section .ase-list-group').scrollTop() || 0;\r\n\r\n        Logger.info(`[SmartScroll] Captured scroll: Tracks=${this._scrollLibrary.tracks}`);\r\n        this.persistScrollOnce = true;\r\n    }\r\n\r\n    private onToggleSync(event: JQuery.ClickEvent): void {\r\n        const enabled = !this.socket.syncEnabled;\r\n        this.socket.setSyncEnabled(enabled);\r\n        this.state.syncEnabled = enabled;\r\n        this.render();\r\n    }\r\n\r\n    private async onGlobalPlay(): Promise<void> {\r\n        this.engine.resume();\r\n        const tracks = this.engine.getAllTracks();\r\n\r\n        console.log('[ASE DEBUG] Global Play clicked, found', tracks.length, 'tracks');\r\n\r\n        for (const track of tracks) {\r\n            if (track.state === 'paused') {\r\n                const offset = track.getCurrentTime();\r\n                console.log('[ASE DEBUG] Resuming paused track:', track.id, 'at offset:', offset);\r\n                await track.play(offset);\r\n\r\n                // Broadcast to players\r\n                if (this.socket.syncEnabled) {\r\n                    console.log('[ASE DEBUG] Broadcasting track play for:', track.id);\r\n                    this.socket.broadcastTrackPlay(track.id, offset);\r\n                }\r\n            }\r\n        }\r\n\r\n        Logger.debug('Global Play/Resume Clicked');\r\n        this.render();\r\n    }\r\n\r\n    private onGlobalPause(): void {\r\n        console.log('[ASE DEBUG] Global Pause clicked');\r\n        const tracks = this.engine.getAllTracks();\r\n        for (const track of tracks) {\r\n            if (track.state === 'playing') {\r\n                const currentTime = track.getCurrentTime();\r\n                track.pause();\r\n                // Sync if enabled\r\n                if (this.socket.syncEnabled) {\r\n                    console.log('[ASE DEBUG] Global Pause broadcasting for track:', track.id, 'at', currentTime);\r\n                    this.socket.broadcastTrackPause(track.id, currentTime);\r\n                }\r\n            }\r\n        }\r\n        Logger.debug('Global Pause Clicked');\r\n        this.render();\r\n    }\r\n\r\n    private onGlobalStop(): void {\r\n        this.engine.stopAll();\r\n        if (this.socket.syncEnabled) {\r\n            this.socket.broadcastStopAll();\r\n        }\r\n        this.render();\r\n    }\r\n\r\n    private onVolumeInput(event: JQuery.TriggeredEvent): void {\r\n        const input = event.currentTarget as HTMLInputElement;\r\n        const value = parseFloat(input.value) / 100;\r\n        const channel = $(input).data('channel') as 'music' | 'ambience' | 'sfx' | undefined;\r\n\r\n        if (channel) {\r\n            this.engine.setChannelVolume(channel, value);\r\n            this.socket.broadcastChannelVolume(channel, value);\r\n        } else {\r\n            this.engine.setMasterVolume(value);\r\n            this.socket.broadcastChannelVolume('master', value);\r\n        }\r\n\r\n        $(input).siblings('.ase-percentage').text(`${Math.round(value * 100)}%`);\r\n        $(input).siblings('.ase-master-perc').text(`${Math.round(value * 100)}%`);\r\n    }\r\n}\r\n","export function throttle<T extends (...args: Parameters<T>) => void>(\r\n  fn: T,\r\n  delay: number\r\n): (...args: Parameters<T>) => void {\r\n  let lastCall = 0;\r\n  let timeoutId: ReturnType<typeof setTimeout> | null = null;\r\n  \r\n  return function (this: ThisParameterType<T>, ...args: Parameters<T>) {\r\n    const now = Date.now();\r\n    const remaining = delay - (now - lastCall);\r\n    \r\n    if (remaining <= 0) {\r\n      if (timeoutId) {\r\n        clearTimeout(timeoutId);\r\n        timeoutId = null;\r\n      }\r\n      lastCall = now;\r\n      fn.apply(this, args);\r\n    } else if (!timeoutId) {\r\n      timeoutId = setTimeout(() => {\r\n        lastCall = Date.now();\r\n        timeoutId = null;\r\n        fn.apply(this, args);\r\n      }, remaining);\r\n    }\r\n  };\r\n}\r\n\r\nexport function debounce<T extends (...args: Parameters<T>) => void>(\r\n  fn: T,\r\n  delay: number\r\n): (...args: Parameters<T>) => void {\r\n  let timeoutId: ReturnType<typeof setTimeout> | null = null;\r\n  \r\n  return function (this: ThisParameterType<T>, ...args: Parameters<T>) {\r\n    if (timeoutId) {\r\n      clearTimeout(timeoutId);\r\n    }\r\n    timeoutId = setTimeout(() => {\r\n      fn.apply(this, args);\r\n    }, delay);\r\n  };\r\n}","import type { Playlist, PlaylistItem } from '@t/library';\r\nimport type { TrackGroup } from '@t/audio';\r\nimport { generateUUID } from '@utils/uuid';\r\nimport { Logger } from '@utils/logger';\r\n\r\nexport class PlaylistManager {\r\n  private playlists: Map<string, Playlist> = new Map();\r\n  private onChangeCallback?: () => void;\r\n\r\n  constructor(onChangeCallback?: () => void) {\r\n    this.onChangeCallback = onChangeCallback;\r\n  }\r\n\r\n  /**\r\n   * Notify about changes (triggers save)\r\n   */\r\n  private notifyChange(): void {\r\n    if (this.onChangeCallback) {\r\n      this.onChangeCallback();\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // CRUD Operations - Playlists\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  /**\r\n   * Create new playlist\r\n   */\r\n  createPlaylist(name: string, description?: string): Playlist {\r\n    // Check for duplicate names\r\n    const existing = this.findByName(name);\r\n    if (existing) {\r\n      throw new Error(`Playlist with name \"${name}\" already exists`);\r\n    }\r\n\r\n    const now = Date.now();\r\n    const playlist: Playlist = {\r\n      id: generateUUID(),\r\n      name,\r\n      description,\r\n      items: [],\r\n      createdAt: now,\r\n      updatedAt: now,\r\n      favorite: false\r\n    };\r\n\r\n    this.playlists.set(playlist.id, playlist);\r\n    this.notifyChange();\r\n    Logger.info(`Playlist created: ${playlist.name} (${playlist.id})`);\r\n\r\n    return playlist;\r\n  }\r\n\r\n  /**\r\n   * Update playlist metadata\r\n   */\r\n  updatePlaylist(id: string, updates: Partial<Pick<Playlist, 'name' | 'description' | 'favorite'>>): Playlist {\r\n    const playlist = this.playlists.get(id);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${id}`);\r\n    }\r\n\r\n    // Validate name uniqueness if changing name\r\n    if (updates.name && updates.name !== playlist.name) {\r\n      const existing = this.findByName(updates.name);\r\n      if (existing && existing.id !== id) {\r\n        throw new Error(`Playlist with name \"${updates.name}\" already exists`);\r\n      }\r\n    }\r\n\r\n    // Update playlist\r\n    const updated = {\r\n      ...playlist,\r\n      ...updates,\r\n      updatedAt: Date.now()\r\n    };\r\n\r\n    this.playlists.set(id, updated);\r\n    this.notifyChange();\r\n    Logger.info(`Playlist updated: ${updated.name}`);\r\n\r\n    return updated;\r\n  }\r\n\r\n  /**\r\n   * Delete playlist\r\n   */\r\n  deletePlaylist(id: string): void {\r\n    const playlist = this.playlists.get(id);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${id}`);\r\n    }\r\n\r\n    this.playlists.delete(id);\r\n    this.notifyChange();\r\n    Logger.info(`Playlist deleted: ${playlist.name}`);\r\n  }\r\n\r\n  /**\r\n   * Get playlist by ID\r\n   */\r\n  getPlaylist(id: string): Playlist | undefined {\r\n    return this.playlists.get(id);\r\n  }\r\n\r\n  /**\r\n   * Get all playlists\r\n   */\r\n  getAllPlaylists(): Playlist[] {\r\n    return Array.from(this.playlists.values());\r\n  }\r\n\r\n  /**\r\n   * Find playlist by name\r\n   */\r\n  findByName(name: string): Playlist | undefined {\r\n    return Array.from(this.playlists.values()).find(p => p.name === name);\r\n  }\r\n\r\n  /**\r\n   * Get favorite playlists\r\n   */\r\n  getFavoritePlaylists(): Playlist[] {\r\n    return this.getAllPlaylists().filter(p => p.favorite);\r\n  }\r\n\r\n  /**\r\n   * Reorder playlists based on new order array of IDs\r\n   */\r\n  reorderPlaylists(orderedIds: string[]): void {\r\n    const newMap = new Map<string, Playlist>();\r\n\r\n    // First, add playlists in the new order\r\n    orderedIds.forEach(id => {\r\n      const playlist = this.playlists.get(id);\r\n      if (playlist) {\r\n        newMap.set(id, playlist);\r\n      }\r\n    });\r\n\r\n    // Add any remaining playlists that weren't in the order array\r\n    this.playlists.forEach((playlist, id) => {\r\n      if (!newMap.has(id)) {\r\n        newMap.set(id, playlist);\r\n      }\r\n    });\r\n\r\n    this.playlists = newMap;\r\n    this.notifyChange();\r\n    Logger.info('Playlists reordered');\r\n  }\r\n\r\n\r\n  /**\r\n   * Toggle playlist favorite status\r\n   */\r\n  togglePlaylistFavorite(id: string): boolean {\r\n    const playlist = this.getPlaylist(id);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${id}`);\r\n    }\r\n\r\n    playlist.favorite = !playlist.favorite;\r\n    playlist.updatedAt = Date.now();\r\n    this.notifyChange();\r\n\r\n    return playlist.favorite;\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // CRUD Operations - Playlist Items\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  /**\r\n   * Add track to playlist\r\n   */\r\n  addTrackToPlaylist(\r\n    playlistId: string,\r\n    libraryItemId: string,\r\n    group: TrackGroup,\r\n    options?: Partial<Omit<PlaylistItem, 'id' | 'libraryItemId' | 'group' | 'order'>>\r\n  ): PlaylistItem {\r\n    const playlist = this.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${playlistId}`);\r\n    }\r\n\r\n    // Check if track already exists in playlist\r\n    const exists = playlist.items.find(item => item.libraryItemId === libraryItemId);\r\n    if (exists) {\r\n      throw new Error('Track already exists in this playlist');\r\n    }\r\n\r\n    // Create new playlist item\r\n    const item: PlaylistItem = {\r\n      id: generateUUID(),\r\n      libraryItemId,\r\n      group,\r\n      volume: options?.volume ?? 1.0,\r\n      loop: options?.loop ?? false,\r\n      order: playlist.items.length,\r\n      fadeIn: options?.fadeIn,\r\n      fadeOut: options?.fadeOut\r\n    };\r\n\r\n    playlist.items.push(item);\r\n    playlist.updatedAt = Date.now();\r\n    this.notifyChange();\r\n\r\n    Logger.debug(`Track added to playlist ${playlist.name}: ${libraryItemId}`);\r\n\r\n    return item;\r\n  }\r\n\r\n  /**\r\n   * Remove track from playlist\r\n   */\r\n  removeTrackFromPlaylist(playlistId: string, playlistItemId: string): void {\r\n    const playlist = this.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${playlistId}`);\r\n    }\r\n\r\n    const index = playlist.items.findIndex(item => item.id === playlistItemId);\r\n    if (index === -1) {\r\n      throw new Error(`Playlist item not found: ${playlistItemId}`);\r\n    }\r\n\r\n    playlist.items.splice(index, 1);\r\n\r\n    // Reorder remaining items\r\n    this.reorderPlaylistItems(playlist);\r\n\r\n    playlist.updatedAt = Date.now();\r\n    this.notifyChange();\r\n    Logger.debug(`Track removed from playlist ${playlist.name}`);\r\n  }\r\n\r\n  /**\r\n   * Remove all tracks with specific library item ID from playlist\r\n   */\r\n  removeLibraryItemFromPlaylist(playlistId: string, libraryItemId: string): number {\r\n    const playlist = this.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${playlistId}`);\r\n    }\r\n\r\n    const initialLength = playlist.items.length;\r\n    playlist.items = playlist.items.filter(item => item.libraryItemId !== libraryItemId);\r\n    const removed = initialLength - playlist.items.length;\r\n\r\n    if (removed > 0) {\r\n      this.reorderPlaylistItems(playlist);\r\n      playlist.updatedAt = Date.now();\r\n      this.notifyChange();\r\n      Logger.debug(`Removed ${removed} instances of library item ${libraryItemId} from playlist ${playlist.name}`);\r\n    }\r\n\r\n    return removed;\r\n  }\r\n\r\n  /**\r\n   * Remove library item from all playlists\r\n   */\r\n  removeLibraryItemFromAllPlaylists(libraryItemId: string): number {\r\n    let totalRemoved = 0;\r\n\r\n    this.playlists.forEach(playlist => {\r\n      const initialLength = playlist.items.length;\r\n      playlist.items = playlist.items.filter(item => item.libraryItemId !== libraryItemId);\r\n      const removed = initialLength - playlist.items.length;\r\n\r\n      if (removed > 0) {\r\n        this.reorderPlaylistItems(playlist);\r\n        playlist.updatedAt = Date.now();\r\n        totalRemoved += removed;\r\n      }\r\n    });\r\n\r\n    if (totalRemoved > 0) {\r\n      this.notifyChange();\r\n      Logger.info(`Removed library item ${libraryItemId} from ${totalRemoved} playlist(s)`);\r\n    }\r\n\r\n    return totalRemoved;\r\n  }\r\n\r\n  /**\r\n   * Update playlist item\r\n   */\r\n  updatePlaylistItem(\r\n    playlistId: string,\r\n    playlistItemId: string,\r\n    updates: Partial<Omit<PlaylistItem, 'id' | 'libraryItemId' | 'order'>>\r\n  ): PlaylistItem {\r\n    const playlist = this.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${playlistId}`);\r\n    }\r\n\r\n    const item = playlist.items.find(i => i.id === playlistItemId);\r\n    if (!item) {\r\n      throw new Error(`Playlist item not found: ${playlistItemId}`);\r\n    }\r\n\r\n    // Update item\r\n    Object.assign(item, updates);\r\n    playlist.updatedAt = Date.now();\r\n    this.notifyChange();\r\n\r\n    Logger.debug(`Playlist item updated in ${playlist.name}`);\r\n\r\n    return item;\r\n  }\r\n\r\n  /**\r\n   * Reorder track in playlist\r\n   */\r\n  reorderTrack(playlistId: string, playlistItemId: string, newOrder: number): void {\r\n    const playlist = this.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${playlistId}`);\r\n    }\r\n\r\n    const itemIndex = playlist.items.findIndex(i => i.id === playlistItemId);\r\n    if (itemIndex === -1) {\r\n      throw new Error(`Playlist item not found: ${playlistItemId}`);\r\n    }\r\n\r\n    // Validate new order\r\n    if (newOrder < 0 || newOrder >= playlist.items.length) {\r\n      throw new Error(`Invalid order: ${newOrder}`);\r\n    }\r\n\r\n    // Remove item from current position\r\n    const [item] = playlist.items.splice(itemIndex, 1);\r\n\r\n    // Insert at new position\r\n    playlist.items.splice(newOrder, 0, item);\r\n\r\n    // Reorder all items\r\n    this.reorderPlaylistItems(playlist);\r\n\r\n    playlist.updatedAt = Date.now();\r\n    this.notifyChange();\r\n    Logger.debug(`Track reordered in playlist ${playlist.name}`);\r\n  }\r\n\r\n  /**\r\n   * Get tracks in playlist\r\n   */\r\n  getPlaylistTracks(playlistId: string): PlaylistItem[] {\r\n    const playlist = this.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${playlistId}`);\r\n    }\r\n\r\n    return [...playlist.items].sort((a, b) => a.order - b.order);\r\n  }\r\n\r\n  /**\r\n   * Get playlists containing a specific library item\r\n   */\r\n  getPlaylistsContainingItem(libraryItemId: string): Playlist[] {\r\n    return this.getAllPlaylists().filter(playlist =>\r\n      playlist.items.some(item => item.libraryItemId === libraryItemId)\r\n    );\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Persistence\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  /**\r\n   * Load playlists from state object\r\n   */\r\n  load(playlistsData: Record<string, Playlist>): void {\r\n    this.playlists.clear();\r\n\r\n    Object.values(playlistsData).forEach(playlist => {\r\n      // Ensure items are properly ordered\r\n      playlist.items.sort((a, b) => a.order - b.order);\r\n      this.playlists.set(playlist.id, playlist);\r\n    });\r\n\r\n    Logger.info(`PlaylistManager loaded: ${this.playlists.size} playlists`);\r\n  }\r\n\r\n  /**\r\n   * Export playlists to state object\r\n   */\r\n  export(): Record<string, Playlist> {\r\n    return Object.fromEntries(this.playlists);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Utilities\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  /**\r\n   * Reorder playlist items to ensure consecutive order values\r\n   */\r\n  private reorderPlaylistItems(playlist: Playlist): void {\r\n    playlist.items.forEach((item, index) => {\r\n      item.order = index;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get statistics\r\n   */\r\n  getStats() {\r\n    const playlists = this.getAllPlaylists();\r\n    return {\r\n      totalPlaylists: playlists.length,\r\n      favoritePlaylists: playlists.filter(p => p.favorite).length,\r\n      totalTracks: playlists.reduce((sum, p) => sum + p.items.length, 0),\r\n      averageTracksPerPlaylist: playlists.length > 0\r\n        ? Math.round(playlists.reduce((sum, p) => sum + p.items.length, 0) / playlists.length)\r\n        : 0\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Clear all playlists\r\n   */\r\n  clear(): void {\r\n    this.playlists.clear();\r\n    Logger.warn('All playlists cleared');\r\n  }\r\n}\r\n","import type { LibraryItem, LibraryState, LibraryStats } from '@t/library';\r\nimport type { TrackGroup } from '@t/audio';\r\nimport { generateUUID } from '@utils/uuid';\r\nimport { validateAudioFile } from '@utils/audio-validation';\r\nimport { Logger } from '@utils/logger';\r\nimport { debounce } from '@utils/throttle';\r\nimport { PlaylistManager } from './PlaylistManager';\r\nimport { GlobalStorage } from '@storage/GlobalStorage';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\nconst LIBRARY_VERSION = 1;\r\n\r\nexport class LibraryManager {\r\n  private items: Map<string, LibraryItem> = new Map();\r\n  private customTags: Set<string> = new Set();\r\n  private favoritesOrder: Array<{ id: string, type: 'track' | 'playlist', addedAt: number }> = [];\r\n  private saveScheduled = false;\r\n  public readonly playlists: PlaylistManager;\r\n  public readonly storage: GlobalStorage;\r\n\r\n  // New property to track if we've initiated a scan this session\r\n  private hasScannedDurations = false;\r\n\r\n  private debouncedSave = debounce(() => {\r\n    this.saveToSettings();\r\n  }, 500);\r\n\r\n  constructor() {\r\n    this.storage = new GlobalStorage();\r\n    this.playlists = new PlaylistManager(() => this.scheduleSave());\r\n    // Load is now async, so we call it via then() to handle Promise\r\n    this.loadFromSettings().catch(err => Logger.error('Failed initial load:', err));\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // CRUD Operations\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  /**\r\n   * Add new item to library\r\n   */\r\n  async addItem(url: string, name?: string, group: TrackGroup = 'music', tags: string[] = []): Promise<LibraryItem> {\r\n    // Validate audio format\r\n    const validation = validateAudioFile(url);\r\n    if (!validation.valid) {\r\n      throw new Error(validation.error || 'Invalid audio file');\r\n    }\r\n\r\n    // Generate name from filename if not provided\r\n    const itemName = name || this.extractNameFromUrl(url);\r\n\r\n    // Check for duplicates by URL\r\n    const existingByUrl = this.findByUrl(url);\r\n    if (existingByUrl) {\r\n      throw new Error(`Track with this URL already exists: ${existingByUrl.name}`);\r\n    }\r\n\r\n    // Check for duplicates by name\r\n    const existingByName = this.findByName(itemName);\r\n    if (existingByName) {\r\n      throw new Error(`Track with name \"${itemName}\" already exists in library`);\r\n    }\r\n\r\n    const now = Date.now();\r\n    const item: LibraryItem = {\r\n      id: generateUUID(),\r\n      url,\r\n      name: itemName,\r\n      tags: tags,\r\n      group: group,\r\n      duration: 0,\r\n      favorite: false,\r\n      addedAt: now,\r\n      updatedAt: now\r\n    };\r\n\r\n    // Asynchronously extract duration\r\n    const audio = new Audio(url);\r\n    audio.addEventListener('loadedmetadata', () => {\r\n      if (audio.duration && isFinite(audio.duration)) {\r\n        item.duration = Math.round(audio.duration);\r\n        this.scheduleSave();\r\n        Logger.info(`Updated duration for ${item.name}: ${item.duration}s`);\r\n      }\r\n    });\r\n    // Handle error to avoid hanging if file is invalid/unreachable (though we don't block return)\r\n    audio.addEventListener('error', (e) => {\r\n      Logger.warn(`Failed to extract duration for ${item.name}:`, e);\r\n    });\r\n\r\n    this.items.set(item.id, item);\r\n    this.scheduleSave();\r\n\r\n    Logger.info(`Library item added: ${item.name} (${item.id})`);\r\n    return item;\r\n  }\r\n\r\n  /**\r\n   * Update existing item\r\n   */\r\n  updateItem(id: string, updates: Partial<LibraryItem>): LibraryItem {\r\n    const item = this.items.get(id);\r\n    if (!item) {\r\n      throw new Error(`Library item not found: ${id}`);\r\n    }\r\n\r\n    // Validate name uniqueness if changing name\r\n    if (updates.name && updates.name !== item.name) {\r\n      const existingByName = this.findByName(updates.name);\r\n      if (existingByName && existingByName.id !== id) {\r\n        throw new Error(`Track with name \"${updates.name}\" already exists`);\r\n      }\r\n    }\r\n\r\n    // Validate URL uniqueness if changing URL\r\n    if (updates.url && updates.url !== item.url) {\r\n      const validation = validateAudioFile(updates.url);\r\n      if (!validation.valid) {\r\n        throw new Error(validation.error || 'Invalid audio file');\r\n      }\r\n\r\n      const existingByUrl = this.findByUrl(updates.url);\r\n      if (existingByUrl && existingByUrl.id !== id) {\r\n        throw new Error(`Track with this URL already exists: ${existingByUrl.name}`);\r\n      }\r\n    }\r\n\r\n    // Prevent ID change\r\n    delete updates.id;\r\n\r\n    // Update item\r\n    const updated = {\r\n      ...item,\r\n      ...updates,\r\n      updatedAt: Date.now()\r\n    };\r\n\r\n    this.items.set(id, updated);\r\n    this.scheduleSave();\r\n\r\n    Logger.info(`Library item updated: ${updated.name}`);\r\n    return updated;\r\n  }\r\n\r\n  /**\r\n   * Remove item from library\r\n   */\r\n  removeItem(id: string): void {\r\n    const item = this.items.get(id);\r\n    if (!item) {\r\n      throw new Error(`Library item not found: ${id}`);\r\n    }\r\n\r\n    // Remove from all playlists first\r\n    this.playlists.removeLibraryItemFromAllPlaylists(id);\r\n\r\n    this.items.delete(id);\r\n    this.scheduleSave();\r\n\r\n    Logger.info(`Library item removed: ${item.name}`);\r\n  }\r\n\r\n  /**\r\n   * Get item by ID\r\n   */\r\n  getItem(id: string): LibraryItem | undefined {\r\n    return this.items.get(id);\r\n  }\r\n\r\n  /**\r\n   * Get all items\r\n   */\r\n  getAllItems(): LibraryItem[] {\r\n    return Array.from(this.items.values());\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Search & Filter\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  /**\r\n   * Find item by URL\r\n   */\r\n  findByUrl(url: string): LibraryItem | undefined {\r\n    return Array.from(this.items.values()).find(item => item.url === url);\r\n  }\r\n\r\n  /**\r\n   * Find item by name\r\n   */\r\n  findByName(name: string): LibraryItem | undefined {\r\n    return Array.from(this.items.values()).find(item => item.name === name);\r\n  }\r\n\r\n  /**\r\n   * Search items by query\r\n   */\r\n  searchByName(query: string): LibraryItem[] {\r\n    const lowerQuery = query.toLowerCase();\r\n    return this.getAllItems().filter(item =>\r\n      item.name.toLowerCase().includes(lowerQuery)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Filter items by tags (OR logic)\r\n   */\r\n  filterByTags(tags: string[]): LibraryItem[] {\r\n    if (tags.length === 0) return this.getAllItems();\r\n\r\n    return this.getAllItems().filter(item =>\r\n      item.tags.some(tag => tags.includes(tag))\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get favorite items (sorted by favoritesOrder)\r\n   */\r\n  getFavorites(): LibraryItem[] {\r\n    return this.getAllItems().filter(item => item.favorite);\r\n  }\r\n\r\n  /**\r\n   * Get ordered favorites list (tracks + playlists)\r\n   */\r\n  getOrderedFavorites(): Array<{ id: string, type: 'track' | 'playlist', addedAt: number }> {\r\n    // Clean up orphaned entries and ensure all favorites are in the order list\r\n    const validFavorites: Array<{ id: string, type: 'track' | 'playlist', addedAt: number }> = [];\r\n\r\n    // First, include items from the order list that still exist\r\n    for (const entry of this.favoritesOrder) {\r\n      if (entry.type === 'track') {\r\n        const item = this.items.get(entry.id);\r\n        if (item && item.favorite) {\r\n          validFavorites.push(entry);\r\n        }\r\n      } else {\r\n        const playlist = this.playlists.getPlaylist(entry.id);\r\n        if (playlist && playlist.favorite) {\r\n          validFavorites.push(entry);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Add any favorites not in the order list (at the beginning = newest)\r\n    const inOrderSet = new Set(validFavorites.map(f => `${f.type}:${f.id}`));\r\n\r\n    // Tracks\r\n    for (const item of this.getAllItems()) {\r\n      if (item.favorite && !inOrderSet.has(`track:${item.id}`)) {\r\n        validFavorites.unshift({ id: item.id, type: 'track', addedAt: Date.now() });\r\n      }\r\n    }\r\n\r\n    // Playlists\r\n    for (const playlist of this.playlists.getFavoritePlaylists()) {\r\n      if (!inOrderSet.has(`playlist:${playlist.id}`)) {\r\n        validFavorites.unshift({ id: playlist.id, type: 'playlist', addedAt: Date.now() });\r\n      }\r\n    }\r\n\r\n    this.favoritesOrder = validFavorites;\r\n    return validFavorites;\r\n  }\r\n\r\n  /**\r\n   * Reorder favorites based on new order array\r\n   */\r\n  reorderFavorites(orderedItems: Array<{ id: string, type: 'track' | 'playlist' }>): void {\r\n    const now = Date.now();\r\n    this.favoritesOrder = orderedItems.map(item => ({\r\n      id: item.id,\r\n      type: item.type,\r\n      addedAt: this.favoritesOrder.find(f => f.id === item.id && f.type === item.type)?.addedAt ?? now\r\n    }));\r\n    this.scheduleSave();\r\n    Logger.info('Favorites reordered');\r\n  }\r\n\r\n  /**\r\n   * Add item to favorites order (at the beginning = newest)\r\n   */\r\n  addToFavoritesOrder(id: string, type: 'track' | 'playlist'): void {\r\n    // Remove if already exists\r\n    this.favoritesOrder = this.favoritesOrder.filter(f => !(f.id === id && f.type === type));\r\n    // Add at beginning (newest first)\r\n    this.favoritesOrder.unshift({ id, type, addedAt: Date.now() });\r\n    this.scheduleSave();\r\n  }\r\n\r\n  /**\r\n   * Remove item from favorites order\r\n   */\r\n  removeFromFavoritesOrder(id: string, type: 'track' | 'playlist'): void {\r\n    this.favoritesOrder = this.favoritesOrder.filter(f => !(f.id === id && f.type === type));\r\n    this.scheduleSave();\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Tags Management\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  /**\r\n   * Get all unique tags\r\n   */\r\n  getAllTags(): string[] {\r\n    const tagSet = new Set<string>(this.customTags);\r\n    this.items.forEach(item => {\r\n      item.tags.forEach(tag => tagSet.add(tag));\r\n    });\r\n    return Array.from(tagSet).sort();\r\n  }\r\n\r\n  /**\r\n   * Add a custom tag explicitly (even if not used on any track)\r\n   */\r\n  addCustomTag(tag: string): void {\r\n    // Normalize: trim and remove leading #\r\n    const normalizedTag = tag.trim().replace(/^#/, '');\r\n    if (normalizedTag && !this.customTags.has(normalizedTag)) {\r\n      this.customTags.add(normalizedTag);\r\n      this.scheduleSave();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add tag to item\r\n   */\r\n  addTagToItem(itemId: string, tag: string): void {\r\n    const item = this.getItem(itemId);\r\n    if (!item) {\r\n      throw new Error(`Library item not found: ${itemId}`);\r\n    }\r\n\r\n    if (!item.tags.includes(tag)) {\r\n      item.tags.push(tag);\r\n      item.updatedAt = Date.now();\r\n      this.scheduleSave();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove tag from item\r\n   */\r\n  removeTagFromItem(itemId: string, tag: string): void {\r\n    const item = this.getItem(itemId);\r\n    if (!item) {\r\n      throw new Error(`Library item not found: ${itemId}`);\r\n    }\r\n\r\n    const index = item.tags.indexOf(tag);\r\n    if (index !== -1) {\r\n      item.tags.splice(index, 1);\r\n      item.updatedAt = Date.now();\r\n      this.scheduleSave();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Rename tag globally\r\n   */\r\n  renameTag(oldTag: string, newTag: string): number {\r\n    let count = 0;\r\n    this.items.forEach(item => {\r\n      const index = item.tags.indexOf(oldTag);\r\n      if (index !== -1) {\r\n        item.tags[index] = newTag;\r\n        item.updatedAt = Date.now();\r\n        count++;\r\n      }\r\n    });\r\n\r\n    if (count > 0) {\r\n      if (this.customTags.has(oldTag)) {\r\n        this.customTags.delete(oldTag);\r\n        this.customTags.add(newTag);\r\n      }\r\n      this.scheduleSave();\r\n      Logger.info(`Tag renamed: \"${oldTag}\" → \"${newTag}\" (${count} items)`);\r\n    } else if (this.customTags.has(oldTag)) {\r\n      // Renaming a tag that is ONLY in customTags (no items)\r\n      this.customTags.delete(oldTag);\r\n      this.customTags.add(newTag);\r\n      this.scheduleSave();\r\n      Logger.info(`Custom tag renamed: \"${oldTag}\" → \"${newTag}\"`);\r\n    }\r\n\r\n    return count;\r\n  }\r\n\r\n  /**\r\n   * Delete tag globally\r\n   */\r\n  deleteTag(tag: string): number {\r\n    let count = 0;\r\n    this.items.forEach(item => {\r\n      const index = item.tags.indexOf(tag);\r\n      if (index !== -1) {\r\n        item.tags.splice(index, 1);\r\n        item.updatedAt = Date.now();\r\n        count++;\r\n      }\r\n    });\r\n\r\n    if (count > 0) {\r\n      if (this.customTags.has(tag)) {\r\n        this.customTags.delete(tag);\r\n      }\r\n      this.scheduleSave();\r\n      Logger.info(`Tag deleted: \"${tag}\" (${count} items)`);\r\n    } else if (this.customTags.has(tag)) {\r\n      // Deleting a tag that is ONLY in customTags\r\n      this.customTags.delete(tag);\r\n      this.scheduleSave();\r\n      Logger.info(`Custom tag deleted: \"${tag}\"`);\r\n    }\r\n\r\n    return count;\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Favorites\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  /**\r\n   * Toggle favorite status\r\n   */\r\n  toggleFavorite(id: string): boolean {\r\n    const item = this.items.get(id);\r\n    if (!item) {\r\n      throw new Error('Item not found');\r\n    }\r\n\r\n    item.favorite = !item.favorite;\r\n    item.updatedAt = Date.now();\r\n\r\n    // Update favorites order array\r\n    if (item.favorite) {\r\n      this.addToFavoritesOrder(item.id, 'track');\r\n      Logger.info(`Added favorite: ${item.name}`);\r\n    } else {\r\n      this.removeFromFavoritesOrder(item.id, 'track'); // Assuming 'track' type for removal\r\n      Logger.info(`Removed favorite: ${item.name}`);\r\n    }\r\n\r\n    this.scheduleSave();\r\n\r\n    // Emit Hook for UI updates\r\n    Hooks.callAll('ase.favoritesChanged' as string as any, { id: item.id, isFavorite: item.favorite });\r\n\r\n    return item.favorite;\r\n  }\r\n\r\n\r\n  /**\r\n   * Scan library for items with missing duration (0) and try to extract it.\r\n   * Run this once per session or on demand.\r\n   */\r\n  public async scanMissingDurations(): Promise<void> {\r\n    if (this.hasScannedDurations) return;\r\n    this.hasScannedDurations = true;\r\n\r\n    const missing = Array.from(this.items.values()).filter(i => !i.duration || i.duration === 0);\r\n    if (missing.length === 0) return;\r\n\r\n    Logger.info(`Scanning ${missing.length} items for missing duration...`);\r\n    let updatedCount = 0;\r\n\r\n    // Process in batches to avoid network spam\r\n    const batchSize = 5;\r\n    for (let i = 0; i < missing.length; i += batchSize) {\r\n      const batch = missing.slice(i, i + batchSize);\r\n      await Promise.all(batch.map(item => new Promise<void>((resolve) => {\r\n        const audio = new Audio(item.url);\r\n\r\n        const cleanup = () => {\r\n          audio.onloadedmetadata = null;\r\n          audio.onerror = null;\r\n          resolve();\r\n        };\r\n\r\n        audio.onloadedmetadata = () => {\r\n          if (audio.duration && isFinite(audio.duration)) {\r\n            item.duration = Math.round(audio.duration);\r\n            updatedCount++;\r\n            // Don't save immediately for each item, batch it\r\n          }\r\n          cleanup();\r\n        };\r\n\r\n        audio.onerror = () => {\r\n          // Logger.warn(`Failed to extract duration for ${item.name} during scan`); // Optional: don't spam logs\r\n          cleanup();\r\n        };\r\n\r\n        // Timeout to prevent hanging\r\n        setTimeout(cleanup, 5000);\r\n      })));\r\n    }\r\n\r\n    if (updatedCount > 0) {\r\n      Logger.info(`Updated duration for ${updatedCount} items.`);\r\n      this.scheduleSave();\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Persistence\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  /**\r\n   * Get library statistics\r\n   */\r\n  getStats(): LibraryStats {\r\n    const items = this.getAllItems();\r\n    const playlistStats = this.playlists.getStats();\r\n\r\n    return {\r\n      totalItems: items.length,\r\n      favoriteItems: items.filter(i => i.favorite).length,\r\n      totalDuration: items.reduce((sum, i) => sum + i.duration, 0),\r\n      tagCount: this.getAllTags().length,\r\n      totalPlaylists: playlistStats.totalPlaylists,\r\n      itemsByGroup: this.getGroupCounts(),\r\n    };\r\n  }\r\n\r\n  private getGroupCounts(): Record<TrackGroup, number> {\r\n    const counts: Record<TrackGroup, number> = { music: 0, ambience: 0, sfx: 0 };\r\n    for (const item of this.items.values()) {\r\n      if (counts[item.group] !== undefined) {\r\n        counts[item.group]++;\r\n      }\r\n    }\r\n    return counts;\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Persistence\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async loadFromSettings(): Promise<void> {\r\n    try {\r\n      // First, try to migrate from old world-scoped settings\r\n      await GlobalStorage.migrateFromWorldSettings();\r\n\r\n      // Load from global storage\r\n      const state = await GlobalStorage.load();\r\n\r\n      if (!state) {\r\n        Logger.info('No saved library state, starting fresh');\r\n        return;\r\n      }\r\n\r\n      // Migrate if needed\r\n      if (state.version !== LIBRARY_VERSION) {\r\n        Logger.warn(`Library version mismatch: ${state.version} → ${LIBRARY_VERSION}`);\r\n        // Add migration logic here if needed\r\n      }\r\n\r\n      // Load items\r\n      this.items.clear();\r\n      // Use strict type guard or iteration\r\n      if (state.items) {\r\n        Object.values(state.items).forEach((item) => {\r\n          if (this.isValidLibraryItem(item)) {\r\n            this.items.set(item.id, item);\r\n          }\r\n        });\r\n      }\r\n\r\n      // Load custom tags\r\n      this.customTags = new Set(state.customTags || []);\r\n\r\n      // Load playlists\r\n      this.playlists.load(state.playlists || {});\r\n\r\n      // Load favorites order\r\n      this.favoritesOrder = state.favoritesOrder || [];\r\n\r\n      Logger.info(`Library loaded: ${this.items.size} items, ${this.playlists.getAllPlaylists().length} playlists, ${this.customTags.size} custom tags`);\r\n    } catch (error) {\r\n      Logger.error('Failed to load library state:', error);\r\n    }\r\n  }\r\n\r\n  private isValidLibraryItem(item: any): item is LibraryItem {\r\n    return item && typeof item.id === 'string' && typeof item.url === 'string';\r\n  }\r\n\r\n  private async saveToSettings(): Promise<void> {\r\n    try {\r\n      const state: LibraryState = {\r\n        items: Object.fromEntries(this.items),\r\n        playlists: this.playlists.export(),\r\n        customTags: Array.from(this.customTags),\r\n        favoritesOrder: this.favoritesOrder, // Extended property in state (needs interface update if missing)\r\n        version: LIBRARY_VERSION,\r\n        lastModified: Date.now()\r\n      };\r\n\r\n      await GlobalStorage.save(state);\r\n      this.saveScheduled = false;\r\n\r\n      Logger.debug(`Library saved: ${this.items.size} items, ${this.playlists.getAllPlaylists().length} playlists`);\r\n    } catch (error) {\r\n      Logger.error('Failed to save library state:', error);\r\n    }\r\n  }\r\n\r\n  private scheduleSave(): void {\r\n    this.debouncedSave();\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Utilities\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private extractNameFromUrl(url: string): string {\r\n    try {\r\n      const decoded = decodeURIComponent(url);\r\n      const parts = decoded.split('/');\r\n      const filename = parts[parts.length - 1];\r\n      return filename.replace(/\\.[^.]+$/, ''); // Remove extension\r\n    } catch {\r\n      return 'Unknown Track';\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear all library data\r\n   */\r\n  clear(): void {\r\n    this.items.clear();\r\n    this.playlists.clear();\r\n    this.scheduleSave();\r\n    Logger.warn('Library cleared');\r\n  }\r\n\r\n  /**\r\n   * Dispose resources\r\n   */\r\n  dispose(): void {\r\n    // Save immediately before disposing\r\n    if (this.saveScheduled) {\r\n      this.saveToSettings();\r\n    }\r\n  }\r\n}\r\n","import type { QueueItem, PlaybackQueueState } from '@t/queue';\r\nimport type { TrackGroup } from '@t/audio';\r\nimport { generateUUID } from '@utils/uuid';\r\nimport { Logger } from '../utils/logger';\r\n\r\ntype QueueEventType = 'add' | 'remove' | 'change' | 'active';\r\ntype QueueEventCallback = (data: { item?: QueueItem; items?: QueueItem[] }) => void;\r\n\r\n/**\r\n * Manages the runtime playback queue\r\n * This is NOT persisted - it's a session-level working set for the mixer\r\n */\r\nexport class PlaybackQueueManager {\r\n    private items: QueueItem[] = [];\r\n    private activeItemId: string | null = null;\r\n    private eventListeners: Map<QueueEventType, Set<QueueEventCallback>> = new Map();\r\n\r\n    constructor() {\r\n        Logger.info('PlaybackQueueManager initialized');\r\n    }\r\n\r\n    // ─────────────────────────────────────────────────────────────\r\n    // Core Operations\r\n    // ─────────────────────────────────────────────────────────────\r\n\r\n    /**\r\n     * Add a library item to the queue\r\n     */\r\n    addItem(libraryItemId: string, options?: Partial<Omit<QueueItem, 'id' | 'libraryItemId' | 'addedAt'>>): QueueItem {\r\n        const item: QueueItem = {\r\n            id: generateUUID(),\r\n            libraryItemId,\r\n            group: options?.group ?? 'music',\r\n            addedAt: Date.now(),\r\n            state: 'stopped',\r\n            volume: options?.volume ?? 1,\r\n            loop: options?.loop ?? false,\r\n            playlistId: options?.playlistId,\r\n        };\r\n\r\n        this.items.push(item);\r\n        this.emit('add', { item });\r\n        this.emit('change', { items: this.items });\r\n\r\n        Logger.debug('Added to queue:', item.id, libraryItemId);\r\n        return item;\r\n    }\r\n\r\n    /**\r\n     * Add all items from a playlist to the queue\r\n     */\r\n    addPlaylist(playlistId: string, playlistItems: Array<{ libraryItemId: string; group: TrackGroup; volume?: number; loop?: boolean }>): QueueItem[] {\r\n        const added: QueueItem[] = [];\r\n\r\n        for (const pItem of playlistItems) {\r\n            const queueItem = this.addItem(pItem.libraryItemId, {\r\n                playlistId,\r\n                group: pItem.group,\r\n                volume: pItem.volume,\r\n                loop: pItem.loop,\r\n            });\r\n            added.push(queueItem);\r\n        }\r\n\r\n        return added;\r\n    }\r\n\r\n    /**\r\n     * Remove an item from the queue\r\n     */\r\n    removeItem(queueItemId: string): boolean {\r\n        const index = this.items.findIndex(i => i.id === queueItemId);\r\n        if (index === -1) return false;\r\n\r\n        const [removed] = this.items.splice(index, 1);\r\n\r\n        if (this.activeItemId === queueItemId) {\r\n            this.activeItemId = null;\r\n            this.emit('active', { item: undefined });\r\n        }\r\n\r\n        this.emit('remove', { item: removed });\r\n        this.emit('change', { items: this.items });\r\n\r\n        Logger.debug('Removed from queue:', queueItemId);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Clear all items from the queue\r\n     */\r\n    clearQueue(): void {\r\n        this.items = [];\r\n        this.activeItemId = null;\r\n        this.emit('change', { items: [] });\r\n        this.emit('active', { item: undefined });\r\n        Logger.debug('Queue cleared');\r\n    }\r\n\r\n    // ─────────────────────────────────────────────────────────────\r\n    // Playback Control\r\n    // ─────────────────────────────────────────────────────────────\r\n\r\n    /**\r\n     * Set the currently active (playing) item\r\n     */\r\n    setActive(queueItemId: string | null): void {\r\n        if (queueItemId && !this.items.find(i => i.id === queueItemId)) {\r\n            Logger.warn('Cannot set active: item not in queue', queueItemId);\r\n            return;\r\n        }\r\n\r\n        this.activeItemId = queueItemId;\r\n        const item = this.getActive();\r\n        this.emit('active', { item: item ?? undefined });\r\n        Logger.debug('Active item set:', queueItemId);\r\n    }\r\n\r\n    /**\r\n     * Get the currently active item\r\n     */\r\n    getActive(): QueueItem | null {\r\n        if (!this.activeItemId) return null;\r\n        return this.items.find(i => i.id === this.activeItemId) ?? null;\r\n    }\r\n\r\n    /**\r\n     * Get the next item in the queue (after active)\r\n     */\r\n    getNext(): QueueItem | null {\r\n        if (!this.activeItemId) return this.items[0] ?? null;\r\n\r\n        const currentIndex = this.items.findIndex(i => i.id === this.activeItemId);\r\n        if (currentIndex === -1 || currentIndex >= this.items.length - 1) return null;\r\n\r\n        return this.items[currentIndex + 1];\r\n    }\r\n\r\n    /**\r\n     * Get the previous item in the queue (before active)\r\n     */\r\n    getPrevious(): QueueItem | null {\r\n        if (!this.activeItemId) return null;\r\n\r\n        const currentIndex = this.items.findIndex(i => i.id === this.activeItemId);\r\n        if (currentIndex <= 0) return null;\r\n\r\n        return this.items[currentIndex - 1];\r\n    }\r\n\r\n    /**\r\n     * Update the state of a queue item\r\n     */\r\n    updateItemState(queueItemId: string, state: QueueItem['state']): void {\r\n        const item = this.items.find(i => i.id === queueItemId);\r\n        if (item) {\r\n            item.state = state;\r\n            this.emit('change', { items: this.items });\r\n        }\r\n    }\r\n\r\n    // ─────────────────────────────────────────────────────────────\r\n    // State Access\r\n    // ─────────────────────────────────────────────────────────────\r\n\r\n    /**\r\n     * Get all items in the queue\r\n     */\r\n    getItems(): QueueItem[] {\r\n        return [...this.items];\r\n    }\r\n\r\n    /**\r\n     * Get full queue state\r\n     */\r\n    getState(): PlaybackQueueState {\r\n        return {\r\n            items: [...this.items],\r\n            activeItemId: this.activeItemId,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Check if an item is in the queue\r\n     */\r\n    hasItem(libraryItemId: string): boolean {\r\n        return this.items.some(i => i.libraryItemId === libraryItemId);\r\n    }\r\n\r\n    /**\r\n     * Remove all queue items that reference a specific library item\r\n     */\r\n    removeByLibraryItemId(libraryItemId: string): boolean {\r\n        const toRemove = this.items.filter(i => i.libraryItemId === libraryItemId);\r\n        if (toRemove.length === 0) return false;\r\n\r\n        for (const item of toRemove) {\r\n            this.removeItem(item.id);\r\n        }\r\n        return true;\r\n    }\r\n\r\n    // ─────────────────────────────────────────────────────────────\r\n    // Event System\r\n    // ─────────────────────────────────────────────────────────────\r\n\r\n    on(event: QueueEventType, callback: QueueEventCallback): void {\r\n        if (!this.eventListeners.has(event)) {\r\n            this.eventListeners.set(event, new Set());\r\n        }\r\n        this.eventListeners.get(event)!.add(callback);\r\n    }\r\n\r\n    off(event: QueueEventType, callback: QueueEventCallback): void {\r\n        this.eventListeners.get(event)?.delete(callback);\r\n    }\r\n\r\n    private emit(event: QueueEventType, data: { item?: QueueItem; items?: QueueItem[] }): void {\r\n        this.eventListeners.get(event)?.forEach(cb => cb(data));\r\n    }\r\n}\r\n","console.log(\"ADVANCED SOUND ENGINE: Entry point loaded\");\r\nimport '../styles/sound-engine.scss';\r\nimport { AudioEngine } from '@core/AudioEngine';\r\nimport { PlayerAudioEngine } from '@core/PlayerAudioEngine';\r\nimport { SocketManager } from '@sync/SocketManager';\r\nimport { SoundMixerApp } from '@ui/SoundMixerApp';\r\nimport { PlayerVolumePanel } from '@ui/PlayerVolumePanel';\r\nimport { LocalLibraryApp } from '@ui/LocalLibraryApp';\r\nimport { AdvancedSoundEngineApp } from '@ui/AdvancedSoundEngineApp';\r\nimport { LibraryManager } from '@lib/LibraryManager';\r\nimport { PlaybackQueueManager } from './queue/PlaybackQueueManager';\r\nimport { Logger } from '@utils/logger';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\n\r\n// GM\r\nlet gmEngine: AudioEngine | null = null;\r\nlet mainApp: AdvancedSoundEngineApp | null = null;\r\nlet libraryManager: LibraryManager | null = null;\r\nlet queueManager: PlaybackQueueManager | null = null;\r\n\r\n// Player\r\nlet playerEngine: PlayerAudioEngine | null = null;\r\nlet volumePanel: PlayerVolumePanel | null = null;\r\n\r\n// Shared\r\nlet socketManager: SocketManager | null = null;\r\n\r\ndeclare global {\r\n  interface Window {\r\n    ASE: {\r\n      isGM: boolean;\r\n      openPanel: (tab?: string, forceRender?: boolean) => void;\r\n      openLibrary?: () => void;\r\n      engine?: AudioEngine | PlayerAudioEngine;\r\n      socket?: SocketManager;\r\n      library?: LibraryManager;\r\n      queue?: PlaybackQueueManager;\r\n    };\r\n  }\r\n}\r\n\r\n\r\n\r\n// Add button to scene controls\r\n// Add button to scene controls\r\n// Add button to scene controls\r\nHooks.on('getSceneControlButtons', (controls: SceneControl[]) => {\r\n  try {\r\n    const isGM = game.user?.isGM ?? false;\r\n\r\n    const aseTools: SceneControlTool[] = [\r\n      {\r\n        name: 'ase-open-mixer',\r\n        title: isGM ? 'Open Sound Mixer' : 'Open Sound Volume',\r\n        icon: isGM ? 'fas fa-sliders-h' : 'fas fa-volume-up',\r\n        button: true,\r\n        onClick: () => {\r\n          Logger.debug('Button clicked: Open Mixer/Volume');\r\n          if (window.ASE) {\r\n            window.ASE.openPanel();\r\n          } else {\r\n            Logger.error('Window.ASE is undefined!');\r\n          }\r\n        }\r\n      }\r\n    ];\r\n\r\n    if (isGM) {\r\n      aseTools.push({\r\n        name: 'ase-open-library',\r\n        title: 'Open Sound Library',\r\n        icon: 'fas fa-book-open',\r\n        button: true,\r\n        onClick: () => {\r\n          Logger.debug('Button clicked: Open Library');\r\n          if (window.ASE && window.ASE.openLibrary) {\r\n            window.ASE.openLibrary();\r\n          } else {\r\n            Logger.error('Window.ASE or openLibrary undefined');\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n    // V13+ Compatibility: controls might be an object/record instead of an array\r\n    if (!Array.isArray(controls) && typeof controls === 'object' && controls !== null) {\r\n      Logger.info('Detected non-array controls structure (V13?)');\r\n\r\n      // Check if \"sounds\" exists as a property\r\n      const soundsLayer = (controls as any).sounds;\r\n\r\n      if (soundsLayer && Array.isArray(soundsLayer.tools)) {\r\n        soundsLayer.tools.push(...aseTools);\r\n        Logger.info('Added tools to \"sounds\" layer (V13 Object Mode)');\r\n      } else {\r\n        // Fallback: Add as a new property\r\n        (controls as any)['advanced-sound-engine'] = {\r\n          name: 'advanced-sound-engine',\r\n          title: 'Advanced Sound Engine',\r\n          icon: 'fas fa-music',\r\n          visible: true,\r\n          tools: aseTools\r\n        };\r\n        Logger.info('Created dedicated control group (V13 Object Mode)');\r\n      }\r\n      return;\r\n    }\r\n\r\n    // V10-V12 Compatibility: controls is an array\r\n    if (Array.isArray(controls)) {\r\n      // Try to find the \"sounds\" layer control group\r\n      const soundsLayer = controls.find((c: SceneControl) => c.name === 'sounds');\r\n\r\n      if (soundsLayer) {\r\n        // Add our tools to the existing sounds layer\r\n        soundsLayer.tools.push(...aseTools);\r\n      } else {\r\n        // Fallback: Create a dedicated group if \"sounds\" layer is missing\r\n        controls.push({\r\n          name: 'advanced-sound-engine',\r\n          title: 'Advanced Sound Engine',\r\n          icon: 'fas fa-music',\r\n          visible: true,\r\n          tools: aseTools\r\n        });\r\n      }\r\n    } else {\r\n      Logger.warn('Unknown controls structure:', controls);\r\n    }\r\n\r\n  } catch (error) {\r\n    Logger.error('Failed to initialize scene controls:', error);\r\n  }\r\n});\r\n\r\n// Manually bind click listeners in case standard onClick fails (V13 compat)\r\nHooks.on('renderSceneControls', (controls: any, html: JQuery) => {\r\n  try {\r\n    // Detect if html is jQuery or native Element\r\n    const findElement = (selector: string): HTMLElement | null => {\r\n      // Foundry often passes jQuery objects\r\n      if (typeof (html as any).find === 'function') {\r\n        const el = (html as any).find(selector);\r\n        return el.length ? el[0] : null;\r\n      }\r\n      // Native HTMLElement\r\n      else if (html instanceof HTMLElement) {\r\n        return html.querySelector(selector);\r\n      }\r\n      return null;\r\n    };\r\n\r\n    const mixerBtn = findElement('[data-tool=\"ase-open-mixer\"]');\r\n    if (mixerBtn) {\r\n      mixerBtn.onclick = (event: MouseEvent) => {\r\n        event.preventDefault();\r\n        event.stopPropagation();\r\n        Logger.debug('Manual click handler (native): Open Mixer');\r\n        window.ASE?.openPanel();\r\n      };\r\n    }\r\n\r\n    const libraryBtn = findElement('[data-tool=\"ase-open-library\"]');\r\n    if (libraryBtn) {\r\n      libraryBtn.onclick = (event: MouseEvent) => {\r\n        event.preventDefault();\r\n        event.stopPropagation();\r\n        Logger.debug('Manual click handler (native): Open Library');\r\n        window.ASE?.openLibrary?.();\r\n      };\r\n    }\r\n  } catch (error) {\r\n    Logger.warn('Failed to bind manual click listeners:', error);\r\n  }\r\n});\r\n// ─────────────────────────────────────────────────────────────\r\n// Initialization\r\n// ─────────────────────────────────────────────────────────────\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// Handlebars Helpers\r\n// ─────────────────────────────────────────────────────────────\r\n\r\nfunction registerHandlebarsHelpers(): void {\r\n  // Format duration from seconds to MM:SS\r\n  Handlebars.registerHelper('formatDuration', (seconds: number): string => {\r\n    if (!seconds || seconds <= 0) return '--:--';\r\n\r\n    const minutes = Math.floor(seconds / 60);\r\n    const secs = Math.floor(seconds % 60);\r\n    return `${minutes}:${secs.toString().padStart(2, '0')}`;\r\n  });\r\n\r\n  // Check equality (for {{#if (eq a b)}})\r\n  Handlebars.registerHelper('eq', (a: any, b: any): boolean => {\r\n    return a === b;\r\n  });\r\n}\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// Init Hooks\r\n// ─────────────────────────────────────────────────────────────\r\n\r\nHooks.once('init', async () => {\r\n  Logger.info('Initializing Advanced Sound Engine...');\r\n  registerSettings();\r\n  registerHandlebarsHelpers();\r\n\r\n  // Preload templates\r\n  await loadTemplates([\r\n    `modules/${MODULE_ID}/templates/partials/effect-card.hbs`\r\n  ]);\r\n});\r\n\r\nHooks.once('ready', async () => {\r\n  const isGM = game.user?.isGM ?? false;\r\n  Logger.info(`Starting Advanced Sound Engine (${isGM ? 'GM' : 'Player'})...`);\r\n\r\n  socketManager = new SocketManager();\r\n\r\n  if (isGM) {\r\n    await initializeGM();\r\n  } else {\r\n    await initializePlayer();\r\n  }\r\n\r\n  // Initialize queue manager (runtime, no persistence)\r\n  queueManager = new PlaybackQueueManager();\r\n\r\n  window.ASE = {\r\n    isGM,\r\n    openPanel: isGM ? openMainApp : openVolumePanel,\r\n    openLibrary: () => isGM && openMainApp('library'),\r\n    engine: isGM ? gmEngine ?? undefined : playerEngine ?? undefined,\r\n    socket: socketManager ?? undefined,\r\n    library: isGM ? libraryManager ?? undefined : undefined,\r\n    queue: queueManager\r\n  };\r\n\r\n  setupAutoplayHandler();\r\n\r\n  Logger.info('Advanced Sound Engine ready');\r\n});\r\n\r\nasync function initializeGM(): Promise<void> {\r\n  libraryManager = new LibraryManager();\r\n  gmEngine = new AudioEngine();\r\n  socketManager!.initializeAsGM(gmEngine);\r\n\r\n  await gmEngine.loadSavedState();\r\n}\r\n\r\nasync function initializePlayer(): Promise<void> {\r\n  playerEngine = new PlayerAudioEngine(socketManager!);\r\n  socketManager!.initializeAsPlayer(playerEngine);\r\n\r\n  // Restore saved local volume\r\n  const savedVolume = PlayerVolumePanel.loadSavedVolume();\r\n  playerEngine!.setLocalVolume(savedVolume);\r\n}\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// Panels\r\n// ─────────────────────────────────────────────────────────────\r\n// Open main app with specific tab\r\nfunction openMainApp(tab?: string, forceRender: boolean = false): void {\r\n  if (!gmEngine || !socketManager || !libraryManager) return;\r\n\r\n  if (mainApp && mainApp.rendered) {\r\n    if (tab && mainApp.state.activeTab !== tab) {\r\n      mainApp.state.activeTab = tab as any;\r\n      forceRender = true;\r\n    }\r\n\r\n    if (forceRender) {\r\n      mainApp.render(false); // Re-render content, keep window position\r\n    } else {\r\n      mainApp.bringToTop();\r\n    }\r\n  } else {\r\n    mainApp = new AdvancedSoundEngineApp(gmEngine, socketManager, libraryManager, queueManager!);\r\n    if (tab) mainApp.state.activeTab = tab as any;\r\n    mainApp.render(true);\r\n  }\r\n}\r\n\r\nfunction openVolumePanel(): void {\r\n  if (!playerEngine) return;\r\n\r\n  if (volumePanel && volumePanel.rendered) {\r\n    volumePanel.bringToTop();\r\n  } else {\r\n    volumePanel = new PlayerVolumePanel(playerEngine);\r\n    volumePanel.render(true);\r\n  }\r\n}\r\n\r\n// Old openLibrary removed/redirected\r\nfunction openLibrary(): void {\r\n  openMainApp('library');\r\n}\r\n\r\n\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// Autoplay Policy Handler\r\n// ─────────────────────────────────────────────────────────────\r\n\r\nfunction setupAutoplayHandler(): void {\r\n  const resumeAudio = () => {\r\n    gmEngine?.resume();\r\n    playerEngine?.resume();\r\n  };\r\n\r\n  document.addEventListener('click', resumeAudio, { once: true });\r\n  document.addEventListener('keydown', resumeAudio, { once: true });\r\n\r\n  Hooks.once('canvasReady', resumeAudio);\r\n}\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// Settings\r\n// ─────────────────────────────────────────────────────────────\r\n\r\nfunction registerSettings(): void {\r\n  (game.settings as any).register(MODULE_ID, 'mixerState', {\r\n    name: 'Mixer State',\r\n    hint: 'Internal storage for mixer state',\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: ''\r\n  });\r\n\r\n  (game.settings as any).register(MODULE_ID, 'maxSimultaneousTracks', {\r\n    name: 'Maximum Simultaneous Tracks',\r\n    hint: 'Limit the number of tracks that can play at once (1-32)',\r\n    scope: 'world',\r\n    config: true,\r\n    type: Number,\r\n    range: { min: 1, max: 32, step: 1 },\r\n    default: 8\r\n  });\r\n\r\n  (game.settings as any).register(MODULE_ID, 'libraryState', {\r\n    name: 'Library State',\r\n    hint: 'Internal storage for library items and playlists',\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: ''\r\n  });\r\n}\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// Cleanup\r\n// ─────────────────────────────────────────────────────────────\r\n\r\nHooks.once('closeGame', () => {\r\n  mainApp?.close();\r\n  volumePanel?.close();\r\n  socketManager?.dispose();\r\n  gmEngine?.dispose();\r\n  playerEngine?.dispose();\r\n  libraryManager?.dispose();\r\n});"],"names":["generateUUID","MODULE_ID","socketManager","_a","libraryManager","queueManager","item"],"mappings":"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"}