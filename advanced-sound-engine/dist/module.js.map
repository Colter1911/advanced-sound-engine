<<<<<<< HEAD
<<<<<<< HEAD
{"version":3,"file":"module.js","sources":["../src/utils/logger.ts","../src/core/StreamingPlayer.ts","../src/utils/time.ts","../src/core/AudioEngine.ts","../src/core/PlayerAudioEngine.ts","../src/sync/SocketManager.ts","../src/utils/throttle.ts","../src/ui/SoundMixerApp.ts","../src/ui/PlayerVolumePanel.ts","../src/module.ts"],"sourcesContent":["const PREFIX = 'ASE';\n\nexport const Logger = {\n  info: (message: string, ...args: unknown[]) => {\n    console.log(`${PREFIX} | ${message}`, ...args);\n  },\n  \n  warn: (message: string, ...args: unknown[]) => {\n    console.warn(`${PREFIX} | ${message}`, ...args);\n  },\n  \n  error: (message: string, ...args: unknown[]) => {\n    console.error(`${PREFIX} | ${message}`, ...args);\n  },\n  \n  debug: (message: string, ...args: unknown[]) => {\n    if (CONFIG?.debug?.audio) {\n      console.debug(`${PREFIX} | ${message}`, ...args);\n    }\n  }\n};","import type { TrackGroup, PlaybackState } from '@t/audio';\nimport { Logger } from '@utils/logger';\n\nexport class StreamingPlayer {\n  readonly id: string;\n  private ctx: AudioContext;\n  private _group: TrackGroup;\n  private _url: string = '';\n  \n  private audio: HTMLAudioElement;\n  private sourceNode: MediaElementAudioSourceNode | null = null;\n  private gainNode: GainNode;\n  private outputNode: GainNode;\n  \n  private _state: PlaybackState = 'stopped';\n  private _volume: number = 1;\n  private _loop: boolean = false;\n  private _ready: boolean = false;\n\n  constructor(\n    id: string,\n    ctx: AudioContext,\n    channelOutput: GainNode,\n    group: TrackGroup = 'music'\n  ) {\n    this.id = id;\n    this.ctx = ctx;\n    this._group = group;\n    \n    this.audio = new Audio();\n    this.audio.crossOrigin = 'anonymous';\n    this.audio.preload = 'auto';\n    \n    this.gainNode = ctx.createGain();\n    this.outputNode = ctx.createGain();\n    \n    this.gainNode.connect(this.outputNode);\n    this.outputNode.connect(channelOutput);\n    \n    this.setupAudioEvents();\n  }\n\n  private setupAudioEvents(): void {\n    this.audio.addEventListener('canplay', () => {\n      this._ready = true;\n      if (this._state === 'loading') {\n        this._state = 'stopped';\n      }\n      Logger.debug(`Track ${this.id} ready to play`);\n    });\n\n    this.audio.addEventListener('ended', () => {\n      if (!this._loop) {\n        this._state = 'stopped';\n        Logger.debug(`Track ${this.id} ended`);\n      }\n    });\n\n    this.audio.addEventListener('error', (e) => {\n      Logger.error(`Track ${this.id} error:`, this.audio.error);\n      this._state = 'stopped';\n    });\n  }\n\n  get state(): PlaybackState {\n    return this._state;\n  }\n\n  get group(): TrackGroup {\n    return this._group;\n  }\n\n  get url(): string {\n    return this._url;\n  }\n\n  get volume(): number {\n    return this._volume;\n  }\n\n  get loop(): boolean {\n    return this._loop;\n  }\n\n  get ready(): boolean {\n    return this._ready;\n  }\n\n  async load(url: string): Promise<void> {\n    this._state = 'loading';\n    this._url = url;\n    this._ready = false;\n\n    return new Promise((resolve, reject) => {\n      const onCanPlay = () => {\n        this.audio.removeEventListener('canplay', onCanPlay);\n        this.audio.removeEventListener('error', onError);\n        \n        // Connect to Web Audio\n        if (!this.sourceNode) {\n          this.sourceNode = this.ctx.createMediaElementSource(this.audio);\n          this.sourceNode.connect(this.gainNode);\n        }\n        \n        this._ready = true;\n        this._state = 'stopped';\n        Logger.debug(`Track loaded: ${this.id}`);\n        resolve();\n      };\n\n      const onError = () => {\n        this.audio.removeEventListener('canplay', onCanPlay);\n        this.audio.removeEventListener('error', onError);\n        this._state = 'stopped';\n        reject(new Error(`Failed to load: ${url}`));\n      };\n\n      this.audio.addEventListener('canplay', onCanPlay, { once: true });\n      this.audio.addEventListener('error', onError, { once: true });\n      \n      this.audio.src = url;\n      this.audio.load();\n    });\n  }\n\n  async play(offset: number = 0): Promise<void> {\n    if (!this._ready) {\n      Logger.warn(`Track ${this.id} not ready`);\n      return;\n    }\n\n    try {\n      this.audio.currentTime = Math.max(0, Math.min(offset, this.audio.duration || 0));\n      this.audio.loop = this._loop;\n      await this.audio.play();\n      this._state = 'playing';\n      Logger.debug(`Track ${this.id} playing from ${offset.toFixed(2)}s`);\n    } catch (error) {\n      Logger.error(`Failed to play ${this.id}:`, error);\n    }\n  }\n\n  pause(): void {\n    if (this._state !== 'playing') return;\n    \n    this.audio.pause();\n    this._state = 'paused';\n    Logger.debug(`Track ${this.id} paused at ${this.audio.currentTime.toFixed(2)}s`);\n  }\n\n  stop(): void {\n    this.audio.pause();\n    this.audio.currentTime = 0;\n    this._state = 'stopped';\n    Logger.debug(`Track ${this.id} stopped`);\n  }\n\n  seek(time: number): void {\n    const safeTime = Math.max(0, Math.min(time, this.audio.duration || 0));\n    this.audio.currentTime = safeTime;\n  }\n\n  setVolume(value: number): void {\n    this._volume = Math.max(0, Math.min(1, value));\n    this.gainNode.gain.setValueAtTime(this._volume, this.ctx.currentTime);\n  }\n\n  setLoop(value: boolean): void {\n    this._loop = value;\n    this.audio.loop = value;\n  }\n\n  setChannel(newGroup: TrackGroup, newOutput: GainNode): void {\n    this._group = newGroup;\n    this.outputNode.disconnect();\n    this.outputNode.connect(newOutput);\n  }\n\n  getCurrentTime(): number {\n    return this.audio.currentTime;\n  }\n\n  getDuration(): number {\n    return this.audio.duration || 0;\n  }\n\n  getState() {\n    return {\n      id: this.id,\n      url: this._url,\n      group: this._group,\n      playbackState: this._state,\n      volume: this._volume,\n      loop: this._loop,\n      currentTime: this.getCurrentTime(),\n      duration: this.getDuration()\n    };\n  }\n\n  dispose(): void {\n    this.audio.pause();\n    this.audio.src = '';\n    this.sourceNode?.disconnect();\n    this.gainNode.disconnect();\n    this.outputNode.disconnect();\n    Logger.debug(`Track ${this.id} disposed`);\n  }\n}","/**\n * Get current server time (for sync calculations)\n */\nexport function getServerTime(): number {\n  // Foundry's game.time.serverTime учитывает offset\n  return Date.now();\n}\n\n/**\n * Calculate playback offset based on start time\n */\nexport function calculateOffset(startedAt: number, pausedAt: number = 0): number {\n  if (pausedAt > 0) {\n    return pausedAt;\n  }\n  return (getServerTime() - startedAt) / 1000;\n}\n\n/**\n * Format seconds to mm:ss\n */\nexport function formatTime(seconds: number): string {\n  if (!isFinite(seconds) || seconds < 0) return '0:00';\n  \n  const mins = Math.floor(seconds / 60);\n  const secs = Math.floor(seconds % 60);\n  return `${mins}:${secs.toString().padStart(2, '0')}`;\n}","import type { TrackConfig, TrackState, MixerState, TrackGroup, ChannelVolumes } from '@t/audio';\nimport { StreamingPlayer } from './StreamingPlayer';\nimport { Logger } from '@utils/logger';\nimport { getServerTime } from '@utils/time';\n\nconst MODULE_ID = 'advanced-sound-engine';\nconst MAX_SIMULTANEOUS = 8;\n\nexport class AudioEngine {\n  private ctx: AudioContext;\n  private masterGain: GainNode;\n  private channelGains: Record<TrackGroup, GainNode>;\n  private players: Map<string, StreamingPlayer> = new Map();\n  \n  private _volumes: ChannelVolumes = {\n    master: 1,\n    music: 1,\n    ambience: 1,\n    sfx: 1\n  };\n  \n  private saveTimeout: ReturnType<typeof setTimeout> | null = null;\n\n  constructor() {\n    this.ctx = new AudioContext();\n    \n    this.masterGain = this.ctx.createGain();\n    this.masterGain.connect(this.ctx.destination);\n    \n    this.channelGains = {\n      music: this.ctx.createGain(),\n      ambience: this.ctx.createGain(),\n      sfx: this.ctx.createGain()\n    };\n    \n    this.channelGains.music.connect(this.masterGain);\n    this.channelGains.ambience.connect(this.masterGain);\n    this.channelGains.sfx.connect(this.masterGain);\n    \n    Logger.info('AudioEngine initialized');\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Persistence (GM only)\n  // ─────────────────────────────────────────────────────────────\n\n  private scheduleSave(): void {\n    if (!game.user?.isGM) return;\n    \n    if (this.saveTimeout) {\n      clearTimeout(this.saveTimeout);\n    }\n    this.saveTimeout = setTimeout(() => {\n      this.saveState();\n    }, 500);\n  }\n\n  private async saveState(): Promise<void> {\n    if (!game.ready || !game.user?.isGM) return;\n    \n    const state = this.getState();\n    \n    try {\n      await game.settings.set(MODULE_ID, 'mixerState', JSON.stringify(state));\n      Logger.debug('Mixer state saved');\n    } catch (error) {\n      Logger.error('Failed to save mixer state:', error);\n    }\n  }\n\n  async loadSavedState(): Promise<void> {\n    if (!game.ready) return;\n    \n    try {\n      const savedJson = game.settings.get(MODULE_ID, 'mixerState') as string;\n      if (!savedJson) return;\n      \n      const state = JSON.parse(savedJson) as MixerState;\n      await this.restoreState(state);\n      \n      Logger.info('Mixer state restored');\n    } catch (error) {\n      Logger.error('Failed to load mixer state:', error);\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Track Management\n  // ─────────────────────────────────────────────────────────────\n\n  async createTrack(config: TrackConfig): Promise<StreamingPlayer> {\n    if (this.players.has(config.id)) {\n      return this.players.get(config.id)!;\n    }\n\n    const channelOutput = this.channelGains[config.group];\n    \n    const player = new StreamingPlayer(\n      config.id,\n      this.ctx,\n      channelOutput,\n      config.group\n    );\n\n    if (config.volume !== undefined) {\n      player.setVolume(config.volume);\n    }\n    if (config.loop !== undefined) {\n      player.setLoop(config.loop);\n    }\n\n    await player.load(config.url);\n\n    this.players.set(config.id, player);\n    this.scheduleSave();\n    \n    Logger.info(`Track created: ${config.id}`);\n    return player;\n  }\n\n  getTrack(id: string): StreamingPlayer | undefined {\n    return this.players.get(id);\n  }\n\n  removeTrack(id: string): boolean {\n    const player = this.players.get(id);\n    if (!player) return false;\n\n    player.dispose();\n    this.players.delete(id);\n    this.scheduleSave();\n    \n    Logger.info(`Track removed: ${id}`);\n    return true;\n  }\n\n  getAllTracks(): StreamingPlayer[] {\n    return Array.from(this.players.values());\n  }\n\n  getTracksByGroup(group: TrackGroup): StreamingPlayer[] {\n    return this.getAllTracks().filter(t => t.group === group);\n  }\n\n  setTrackChannel(id: string, newGroup: TrackGroup): void {\n    const player = this.players.get(id);\n    if (!player) return;\n    \n    player.setChannel(newGroup, this.channelGains[newGroup]);\n    this.scheduleSave();\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Playback Control\n  // ─────────────────────────────────────────────────────────────\n\n  async playTrack(id: string, offset: number = 0): Promise<void> {\n    const player = this.players.get(id);\n    if (!player) {\n      Logger.warn(`Track not found: ${id}`);\n      return;\n    }\n    \n    const playingCount = this.getAllTracks().filter(t => t.state === 'playing').length;\n    const isCurrentlyPlaying = player.state === 'playing';\n    \n    if (!isCurrentlyPlaying && playingCount >= MAX_SIMULTANEOUS) {\n      Logger.warn(`Maximum simultaneous tracks (${MAX_SIMULTANEOUS}) reached`);\n      ui.notifications?.warn(`Cannot play more than ${MAX_SIMULTANEOUS} tracks simultaneously`);\n      return;\n    }\n    \n    await player.play(offset);\n  }\n\n  pauseTrack(id: string): void {\n    this.players.get(id)?.pause();\n  }\n\n  stopTrack(id: string): void {\n    this.players.get(id)?.stop();\n  }\n\n  seekTrack(id: string, time: number): void {\n    this.players.get(id)?.seek(time);\n  }\n\n  setTrackVolume(id: string, volume: number): void {\n    this.players.get(id)?.setVolume(volume);\n    this.scheduleSave();\n  }\n\n  setTrackLoop(id: string, loop: boolean): void {\n    this.players.get(id)?.setLoop(loop);\n    this.scheduleSave();\n  }\n\n  stopAll(): void {\n    for (const player of this.players.values()) {\n      player.stop();\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Volume Control\n  // ─────────────────────────────────────────────────────────────\n\n  get volumes(): ChannelVolumes {\n    return { ...this._volumes };\n  }\n\n  setMasterVolume(value: number): void {\n    this._volumes.master = Math.max(0, Math.min(1, value));\n    this.masterGain.gain.linearRampToValueAtTime(\n      this._volumes.master,\n      this.ctx.currentTime + 0.01\n    );\n    this.scheduleSave();\n  }\n\n  setChannelVolume(channel: TrackGroup, value: number): void {\n    this._volumes[channel] = Math.max(0, Math.min(1, value));\n    this.channelGains[channel].gain.linearRampToValueAtTime(\n      this._volumes[channel],\n      this.ctx.currentTime + 0.01\n    );\n    this.scheduleSave();\n  }\n\n  getChannelVolume(channel: TrackGroup): number {\n    return this._volumes[channel];\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // State\n  // ─────────────────────────────────────────────────────────────\n\n  getState(): MixerState {\n    const tracks: TrackState[] = [];\n    \n    for (const player of this.players.values()) {\n      tracks.push(player.getState());\n    }\n\n    return {\n      masterVolume: this._volumes.master,\n      channelVolumes: { ...this._volumes },\n      tracks,\n      timestamp: getServerTime(),\n      syncEnabled: false\n    };\n  }\n\n  async restoreState(state: MixerState): Promise<void> {\n    // Restore volumes\n    this._volumes.master = state.masterVolume;\n    this.masterGain.gain.setValueAtTime(this._volumes.master, this.ctx.currentTime);\n    \n    if (state.channelVolumes) {\n      for (const channel of ['music', 'ambience', 'sfx'] as TrackGroup[]) {\n        this._volumes[channel] = state.channelVolumes[channel];\n        this.channelGains[channel].gain.setValueAtTime(this._volumes[channel], this.ctx.currentTime);\n      }\n    }\n\n    // Restore tracks (without playing)\n    for (const trackState of state.tracks) {\n      if (!this.players.has(trackState.id)) {\n        try {\n          await this.createTrack({\n            id: trackState.id,\n            url: trackState.url,\n            group: trackState.group,\n            volume: trackState.volume,\n            loop: trackState.loop\n          });\n        } catch (error) {\n          Logger.error(`Failed to restore track ${trackState.id}:`, error);\n        }\n      }\n    }\n\n    // Remove tracks not in state\n    const stateTrackIds = new Set(state.tracks.map(t => t.id));\n    for (const [id] of this.players) {\n      if (!stateTrackIds.has(id)) {\n        this.removeTrack(id);\n      }\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Audio Context\n  // ─────────────────────────────────────────────────────────────\n\n  async resume(): Promise<void> {\n    if (this.ctx.state === 'suspended') {\n      await this.ctx.resume();\n      Logger.info('AudioContext resumed');\n    }\n  }\n\n  get contextState(): AudioContextState {\n    return this.ctx.state;\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Cleanup\n  // ─────────────────────────────────────────────────────────────\n\n  dispose(): void {\n    if (this.saveTimeout) {\n      clearTimeout(this.saveTimeout);\n    }\n    for (const player of this.players.values()) {\n      player.dispose();\n    }\n    this.players.clear();\n    this.ctx.close();\n    Logger.info('AudioEngine disposed');\n  }\n}","import type { TrackGroup, ChannelVolumes, SyncTrackState, TrackPlayPayload } from '@t/audio';\nimport { StreamingPlayer } from './StreamingPlayer';\nimport { Logger } from '@utils/logger';\nimport { getServerTime } from '@utils/time';\n\n/**\n * Упрощенный движок для игроков — только получает команды\n */\nexport class PlayerAudioEngine {\n  private ctx: AudioContext;\n  private masterGain: GainNode;\n  private gmGain: GainNode; // Громкость от GM\n  private channelGains: Record<TrackGroup, GainNode>;\n  private players: Map<string, StreamingPlayer> = new Map();\n  \n  private _localVolume: number = 1; // Личная громкость игрока\n  private _gmVolumes: ChannelVolumes = {\n    master: 1,\n    music: 1,\n    ambience: 1,\n    sfx: 1\n  };\n\n  constructor() {\n    this.ctx = new AudioContext();\n    \n    // Chain: tracks -> channels -> gmGain -> masterGain -> destination\n    this.masterGain = this.ctx.createGain();\n    this.masterGain.connect(this.ctx.destination);\n    \n    this.gmGain = this.ctx.createGain();\n    this.gmGain.connect(this.masterGain);\n    \n    this.channelGains = {\n      music: this.ctx.createGain(),\n      ambience: this.ctx.createGain(),\n      sfx: this.ctx.createGain()\n    };\n    \n    this.channelGains.music.connect(this.gmGain);\n    this.channelGains.ambience.connect(this.gmGain);\n    this.channelGains.sfx.connect(this.gmGain);\n    \n    Logger.info('PlayerAudioEngine initialized');\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Local Volume (Player's personal control)\n  // ─────────────────────────────────────────────────────────────\n\n  get localVolume(): number {\n    return this._localVolume;\n  }\n\n  setLocalVolume(value: number): void {\n    this._localVolume = Math.max(0, Math.min(1, value));\n    this.masterGain.gain.linearRampToValueAtTime(\n      this._localVolume,\n      this.ctx.currentTime + 0.01\n    );\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // GM Volume (from sync)\n  // ─────────────────────────────────────────────────────────────\n\n  setGMVolume(channel: TrackGroup | 'master', value: number): void {\n    const safeValue = Math.max(0, Math.min(1, value));\n    \n    if (channel === 'master') {\n      this._gmVolumes.master = safeValue;\n      this.gmGain.gain.linearRampToValueAtTime(safeValue, this.ctx.currentTime + 0.01);\n    } else {\n      this._gmVolumes[channel] = safeValue;\n      this.channelGains[channel].gain.linearRampToValueAtTime(safeValue, this.ctx.currentTime + 0.01);\n    }\n  }\n\n  setAllGMVolumes(volumes: ChannelVolumes): void {\n    this._gmVolumes = { ...volumes };\n    \n    this.gmGain.gain.setValueAtTime(volumes.master, this.ctx.currentTime);\n    this.channelGains.music.gain.setValueAtTime(volumes.music, this.ctx.currentTime);\n    this.channelGains.ambience.gain.setValueAtTime(volumes.ambience, this.ctx.currentTime);\n    this.channelGains.sfx.gain.setValueAtTime(volumes.sfx, this.ctx.currentTime);\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Track Commands (from GM via socket)\n  // ─────────────────────────────────────────────────────────────\n\n  async handlePlay(payload: TrackPlayPayload): Promise<void> {\n    let player = this.players.get(payload.trackId);\n    \n    // Create if doesn't exist\n    if (!player) {\n      player = new StreamingPlayer(\n        payload.trackId,\n        this.ctx,\n        this.channelGains[payload.group],\n        payload.group\n      );\n      \n      await player.load(payload.url);\n      this.players.set(payload.trackId, player);\n    }\n    \n    player.setVolume(payload.volume);\n    player.setLoop(payload.loop);\n    \n    // Calculate offset based on time elapsed since GM started\n    const elapsed = (getServerTime() - payload.startTimestamp) / 1000;\n    const adjustedOffset = Math.max(0, payload.offset + elapsed);\n    \n    await player.play(adjustedOffset);\n    Logger.debug(`Player: track ${payload.trackId} playing at ${adjustedOffset.toFixed(2)}s`);\n  }\n\n  handlePause(trackId: string): void {\n    this.players.get(trackId)?.pause();\n  }\n\n  handleStop(trackId: string): void {\n    this.players.get(trackId)?.stop();\n  }\n\n  handleSeek(trackId: string, time: number, isPlaying: boolean, seekTimestamp: number): void {\n    const player = this.players.get(trackId);\n    if (!player) return;\n    \n    if (isPlaying) {\n      const elapsed = (getServerTime() - seekTimestamp) / 1000;\n      player.seek(time + elapsed);\n    } else {\n      player.seek(time);\n    }\n  }\n\n  handleTrackVolume(trackId: string, volume: number): void {\n    this.players.get(trackId)?.setVolume(volume);\n  }\n\n  handleTrackLoop(trackId: string, loop: boolean): void {\n    this.players.get(trackId)?.setLoop(loop);\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Sync State (full state from GM)\n  // ─────────────────────────────────────────────────────────────\n\n  async syncState(tracks: SyncTrackState[], volumes: ChannelVolumes): Promise<void> {\n    // Set volumes\n    this.setAllGMVolumes(volumes);\n    \n    // Handle tracks\n    const newTrackIds = new Set(tracks.map(t => t.id));\n    \n    // Remove tracks not in sync\n    for (const [id, player] of this.players) {\n      if (!newTrackIds.has(id)) {\n        player.dispose();\n        this.players.delete(id);\n      }\n    }\n    \n    // Add/update tracks\n    for (const trackState of tracks) {\n      let player = this.players.get(trackState.id);\n      \n      if (!player) {\n        player = new StreamingPlayer(\n          trackState.id,\n          this.ctx,\n          this.channelGains[trackState.group],\n          trackState.group\n        );\n        \n        await player.load(trackState.url);\n        this.players.set(trackState.id, player);\n      }\n      \n      player.setVolume(trackState.volume);\n      player.setLoop(trackState.loop);\n      \n      if (trackState.isPlaying) {\n        const elapsed = (getServerTime() - trackState.startTimestamp) / 1000;\n        const adjustedTime = trackState.currentTime + elapsed;\n        await player.play(adjustedTime);\n      } else {\n        player.stop();\n      }\n    }\n    \n    Logger.info('Player: synced state from GM');\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Sync Off\n  // ─────────────────────────────────────────────────────────────\n\n  stopAll(): void {\n    for (const player of this.players.values()) {\n      player.stop();\n    }\n  }\n\n  clearAll(): void {\n    for (const player of this.players.values()) {\n      player.dispose();\n    }\n    this.players.clear();\n    Logger.info('Player: all tracks cleared');\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Audio Context\n  // ─────────────────────────────────────────────────────────────\n\n  async resume(): Promise<void> {\n    if (this.ctx.state === 'suspended') {\n      await this.ctx.resume();\n      Logger.info('PlayerAudioEngine: AudioContext resumed');\n    }\n  }\n\n  dispose(): void {\n    this.clearAll();\n    this.ctx.close();\n    Logger.info('PlayerAudioEngine disposed');\n  }\n}","import type { \n  SocketMessage, \n  SocketMessageType,\n  SyncStatePayload,\n  SyncTrackState,\n  TrackPlayPayload,\n  TrackPausePayload,\n  TrackStopPayload,\n  TrackSeekPayload,\n  TrackVolumePayload,\n  TrackLoopPayload,\n  ChannelVolumePayload,\n  TrackGroup,\n  ChannelVolumes\n} from '@t/audio';\nimport { AudioEngine } from '@core/AudioEngine';\nimport { PlayerAudioEngine } from '@core/PlayerAudioEngine';\nimport { Logger } from '@utils/logger';\nimport { getServerTime } from '@utils/time';\n\nconst MODULE_ID = 'advanced-sound-engine';\nconst SOCKET_NAME = `module.${MODULE_ID}`;\n\nexport class SocketManager {\n  private gmEngine: AudioEngine | null = null;\n  private playerEngine: PlayerAudioEngine | null = null;\n  private socket: any = null;\n  private _syncEnabled: boolean = false;\n  private isGM: boolean = false;\n\n  constructor() {}\n\n  initializeAsGM(engine: AudioEngine): void {\n    this.isGM = true;\n    this.gmEngine = engine;\n    this.socket = game.socket;\n    \n    this.socket?.on(SOCKET_NAME, (message: SocketMessage) => {\n      this.handleGMMessage(message);\n    });\n    \n    Logger.info('SocketManager initialized as GM');\n  }\n\n  initializeAsPlayer(engine: PlayerAudioEngine): void {\n    this.isGM = false;\n    this.playerEngine = engine;\n    this.socket = game.socket;\n    \n    this.socket?.on(SOCKET_NAME, (message: SocketMessage) => {\n      this.handlePlayerMessage(message);\n    });\n    \n    // Request current state on join\n    setTimeout(() => {\n      this.send('player-ready', {});\n    }, 1000);\n    \n    Logger.info('SocketManager initialized as Player');\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Sync Mode (GM)\n  // ─────────────────────────────────────────────────────────────\n\n  get syncEnabled(): boolean {\n    return this._syncEnabled;\n  }\n\n  setSyncEnabled(enabled: boolean): void {\n    if (!this.isGM) return;\n    \n    this._syncEnabled = enabled;\n    \n    if (enabled) {\n      this.broadcastSyncStart();\n    } else {\n      this.broadcastSyncStop();\n    }\n    \n    Logger.info(`Sync mode: ${enabled ? 'ON' : 'OFF'}`);\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // GM Message Handling\n  // ─────────────────────────────────────────────────────────────\n\n  private handleGMMessage(message: SocketMessage): void {\n    if (message.senderId === game.user?.id) return;\n    \n    if (message.type === 'player-ready' && this._syncEnabled) {\n      // Send current state to newly joined player\n      this.sendStateTo(message.senderId);\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Player Message Handling\n  // ─────────────────────────────────────────────────────────────\n\n  private async handlePlayerMessage(message: SocketMessage): Promise<void> {\n    if (message.senderId === game.user?.id) return;\n    if (!this.playerEngine) return;\n    \n    Logger.debug(`Player received: ${message.type}`, message.payload);\n    \n    switch (message.type) {\n      case 'sync-start':\n        const startPayload = message.payload as SyncStatePayload;\n        await this.playerEngine.syncState(startPayload.tracks, startPayload.channelVolumes);\n        break;\n        \n      case 'sync-stop':\n        this.playerEngine.clearAll();\n        break;\n        \n      case 'sync-state':\n        const statePayload = message.payload as SyncStatePayload;\n        await this.playerEngine.syncState(statePayload.tracks, statePayload.channelVolumes);\n        break;\n        \n      case 'track-play':\n        const playPayload = message.payload as TrackPlayPayload;\n        await this.playerEngine.handlePlay(playPayload);\n        break;\n        \n      case 'track-pause':\n        const pausePayload = message.payload as TrackPausePayload;\n        this.playerEngine.handlePause(pausePayload.trackId);\n        break;\n        \n      case 'track-stop':\n        const stopPayload = message.payload as TrackStopPayload;\n        this.playerEngine.handleStop(stopPayload.trackId);\n        break;\n        \n      case 'track-seek':\n        const seekPayload = message.payload as TrackSeekPayload;\n        this.playerEngine.handleSeek(\n          seekPayload.trackId, \n          seekPayload.time, \n          seekPayload.isPlaying,\n          seekPayload.seekTimestamp\n        );\n        break;\n        \n      case 'track-volume':\n        const volPayload = message.payload as TrackVolumePayload;\n        this.playerEngine.handleTrackVolume(volPayload.trackId, volPayload.volume);\n        break;\n        \n      case 'track-loop':\n        const loopPayload = message.payload as TrackLoopPayload;\n        this.playerEngine.handleTrackLoop(loopPayload.trackId, loopPayload.loop);\n        break;\n        \n      case 'channel-volume':\n        const chVolPayload = message.payload as ChannelVolumePayload;\n        this.playerEngine.setGMVolume(chVolPayload.channel, chVolPayload.volume);\n        break;\n        \n      case 'stop-all':\n        this.playerEngine.stopAll();\n        break;\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // GM Broadcast Methods\n  // ─────────────────────────────────────────────────────────────\n\n  private send(type: SocketMessageType, payload: unknown, targetUserId?: string): void {\n    if (!this.socket) return;\n\n    const message: SocketMessage = {\n      type,\n      payload,\n      senderId: game.user?.id ?? '',\n      timestamp: getServerTime()\n    };\n\n    if (targetUserId) {\n      this.socket.emit(SOCKET_NAME, message, { recipients: [targetUserId] });\n    } else {\n      this.socket.emit(SOCKET_NAME, message);\n    }\n\n    Logger.debug(`Sent: ${type}`, payload);\n  }\n\n  private getCurrentSyncState(): SyncStatePayload {\n    if (!this.gmEngine) {\n      return { tracks: [], channelVolumes: { master: 1, music: 1, ambience: 1, sfx: 1 } };\n    }\n    \n    const now = getServerTime();\n    const tracks: SyncTrackState[] = [];\n    \n    for (const player of this.gmEngine.getAllTracks()) {\n      const state = player.getState();\n      tracks.push({\n        id: state.id,\n        url: state.url,\n        group: state.group,\n        volume: state.volume,\n        loop: state.loop,\n        isPlaying: state.playbackState === 'playing',\n        currentTime: player.getCurrentTime(),\n        startTimestamp: now\n      });\n    }\n    \n    return {\n      tracks,\n      channelVolumes: this.gmEngine.volumes\n    };\n  }\n\n  private broadcastSyncStart(): void {\n    const state = this.getCurrentSyncState();\n    this.send('sync-start', state);\n  }\n\n  private broadcastSyncStop(): void {\n    this.send('sync-stop', {});\n  }\n\n  private sendStateTo(userId: string): void {\n    const state = this.getCurrentSyncState();\n    this.send('sync-state', state, userId);\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // GM Actions (called when GM interacts with mixer)\n  // ─────────────────────────────────────────────────────────────\n\n  broadcastTrackPlay(trackId: string, offset: number): void {\n    if (!this._syncEnabled || !this.gmEngine) return;\n    \n    const player = this.gmEngine.getTrack(trackId);\n    if (!player) return;\n    \n    const payload: TrackPlayPayload = {\n      trackId,\n      url: player.url,\n      group: player.group,\n      volume: player.volume,\n      loop: player.loop,\n      offset,\n      startTimestamp: getServerTime()\n    };\n    \n    this.send('track-play', payload);\n  }\n\n  broadcastTrackPause(trackId: string, pausedAt: number): void {\n    if (!this._syncEnabled) return;\n    \n    const payload: TrackPausePayload = { trackId, pausedAt };\n    this.send('track-pause', payload);\n  }\n\n  broadcastTrackStop(trackId: string): void {\n    if (!this._syncEnabled) return;\n    \n    const payload: TrackStopPayload = { trackId };\n    this.send('track-stop', payload);\n  }\n\n  broadcastTrackSeek(trackId: string, time: number, isPlaying: boolean): void {\n    if (!this._syncEnabled) return;\n    \n    const payload: TrackSeekPayload = {\n      trackId,\n      time,\n      isPlaying,\n      seekTimestamp: getServerTime()\n    };\n    this.send('track-seek', payload);\n  }\n\n  broadcastTrackVolume(trackId: string, volume: number): void {\n    if (!this._syncEnabled) return;\n    \n    const payload: TrackVolumePayload = { trackId, volume };\n    this.send('track-volume', payload);\n  }\n\n  broadcastTrackLoop(trackId: string, loop: boolean): void {\n    if (!this._syncEnabled) return;\n    \n    const payload: TrackLoopPayload = { trackId, loop };\n    this.send('track-loop', payload);\n  }\n\n  broadcastChannelVolume(channel: TrackGroup | 'master', volume: number): void {\n    if (!this._syncEnabled) return;\n    \n    const payload: ChannelVolumePayload = { channel, volume };\n    this.send('channel-volume', payload);\n  }\n\n  broadcastStopAll(): void {\n    if (!this._syncEnabled) return;\n    this.send('stop-all', {});\n  }\n\n  dispose(): void {\n    this.socket?.off(SOCKET_NAME);\n  }\n}","export function throttle<T extends (...args: Parameters<T>) => void>(\n  fn: T,\n  delay: number\n): (...args: Parameters<T>) => void {\n  let lastCall = 0;\n  let timeoutId: ReturnType<typeof setTimeout> | null = null;\n  \n  return function (this: ThisParameterType<T>, ...args: Parameters<T>) {\n    const now = Date.now();\n    const remaining = delay - (now - lastCall);\n    \n    if (remaining <= 0) {\n      if (timeoutId) {\n        clearTimeout(timeoutId);\n        timeoutId = null;\n      }\n      lastCall = now;\n      fn.apply(this, args);\n    } else if (!timeoutId) {\n      timeoutId = setTimeout(() => {\n        lastCall = Date.now();\n        timeoutId = null;\n        fn.apply(this, args);\n      }, remaining);\n    }\n  };\n}\n\nexport function debounce<T extends (...args: Parameters<T>) => void>(\n  fn: T,\n  delay: number\n): (...args: Parameters<T>) => void {\n  let timeoutId: ReturnType<typeof setTimeout> | null = null;\n  \n  return function (this: ThisParameterType<T>, ...args: Parameters<T>) {\n    if (timeoutId) {\n      clearTimeout(timeoutId);\n    }\n    timeoutId = setTimeout(() => {\n      fn.apply(this, args);\n    }, delay);\n  };\n}","import type { TrackGroup } from '@t/audio';\nimport { AudioEngine } from '@core/AudioEngine';\nimport { SocketManager } from '@sync/SocketManager';\nimport { StreamingPlayer } from '@core/StreamingPlayer';\nimport { Logger } from '@utils/logger';\nimport { formatTime } from '@utils/time';\nimport { throttle } from '@utils/throttle';\n\nconst MODULE_ID = 'advanced-sound-engine';\nconst MAX_SIMULTANEOUS = 8;\n\ninterface MixerData {\n  tracks: TrackViewData[];\n  volumes: {\n    master: number;\n    music: number;\n    ambience: number;\n    sfx: number;\n  };\n  playingCount: number;\n  maxSimultaneous: number;\n  syncEnabled: boolean;\n}\n\ninterface TrackViewData {\n  id: string;\n  name: string;\n  group: TrackGroup;\n  isPlaying: boolean;\n  isPaused: boolean;\n  isStopped: boolean;\n  isLoading: boolean;\n  volume: number;\n  volumePercent: number;\n  loop: boolean;\n  currentTime: number;\n  currentTimeFormatted: string;\n  duration: number;\n  durationFormatted: string;\n  progress: number;\n}\n\nexport class SoundMixerApp extends Application {\n  private engine: AudioEngine;\n  private socket: SocketManager;\n  private updateInterval: ReturnType<typeof setInterval> | null = null;\n\n  static override get defaultOptions(): ApplicationOptions {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      id: 'ase-sound-mixer',\n      title: 'Sound Mixer (GM)',\n      template: `modules/${MODULE_ID}/templates/mixer.hbs`,\n      classes: ['ase-mixer'],\n      width: 550,\n      height: 'auto',\n      resizable: true,\n      minimizable: true,\n      popOut: true\n    }) as ApplicationOptions;\n  }\n\n  constructor(engine: AudioEngine, socket: SocketManager, options?: Partial<ApplicationOptions>) {\n    super(options);\n    this.engine = engine;\n    this.socket = socket;\n  }\n\n  override getData(): MixerData {\n    const tracks = this.engine.getAllTracks().map(player => this.getTrackViewData(player));\n    const volumes = this.engine.volumes;\n    const playingCount = tracks.filter(t => t.isPlaying).length;\n    \n    return {\n      tracks,\n      volumes: {\n        master: Math.round(volumes.master * 100),\n        music: Math.round(volumes.music * 100),\n        ambience: Math.round(volumes.ambience * 100),\n        sfx: Math.round(volumes.sfx * 100)\n      },\n      playingCount,\n      maxSimultaneous: MAX_SIMULTANEOUS,\n      syncEnabled: this.socket.syncEnabled\n    };\n  }\n\n  private getTrackViewData(player: StreamingPlayer): TrackViewData {\n    const state = player.getState();\n    const currentTime = player.getCurrentTime();\n    const duration = player.getDuration();\n    \n    return {\n      id: state.id,\n      name: this.extractFileName(state.url),\n      group: state.group,\n      isPlaying: state.playbackState === 'playing',\n      isPaused: state.playbackState === 'paused',\n      isStopped: state.playbackState === 'stopped',\n      isLoading: state.playbackState === 'loading',\n      volume: state.volume,\n      volumePercent: Math.round(state.volume * 100),\n      loop: state.loop,\n      currentTime,\n      currentTimeFormatted: formatTime(currentTime),\n      duration,\n      durationFormatted: formatTime(duration),\n      progress: duration > 0 ? (currentTime / duration) * 100 : 0\n    };\n  }\n\n  private extractFileName(url: string): string {\n    if (!url) return 'Unknown';\n    try {\n      const decoded = decodeURIComponent(url);\n      const parts = decoded.split('/');\n      const fileName = parts[parts.length - 1];\n      return fileName.replace(/\\.[^.]+$/, '');\n    } catch {\n      const parts = url.split('/');\n      const fileName = parts[parts.length - 1];\n      return fileName.replace(/\\.[^.]+$/, '');\n    }\n  }\n\n  override activateListeners(html: JQuery): void {\n    super.activateListeners(html);\n\n    // Sync toggle\n    html.find('#ase-sync-toggle').on('change', (event) => {\n      const enabled = (event.target as HTMLInputElement).checked;\n      this.socket.setSyncEnabled(enabled);\n      this.updateSyncIndicator(html, enabled);\n    });\n\n    // Channel volume sliders\n    const throttledChannelVolume = throttle((channel: string, value: number) => {\n      if (channel === 'master') {\n        this.engine.setMasterVolume(value);\n        this.socket.broadcastChannelVolume('master', value);\n      } else {\n        this.engine.setChannelVolume(channel as TrackGroup, value);\n        this.socket.broadcastChannelVolume(channel as TrackGroup, value);\n      }\n    }, 50);\n\n    html.find('.ase-channel-slider').on('input', (event) => {\n      const channel = $(event.currentTarget).data('channel') as string;\n      const value = parseFloat((event.target as HTMLInputElement).value) / 100;\n      throttledChannelVolume(channel, value);\n      $(event.currentTarget).siblings('.ase-channel-value').text(`${Math.round(value * 100)}%`);\n    });\n\n    // Add track\n    html.find('#ase-add-track').on('click', () => this.onAddTrack());\n\n    // Track controls\n    const tracks = html.find('.ase-tracks');\n    \n    tracks.on('click', '.ase-btn-play', (event) => {\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\n      this.onPlayTrack(trackId);\n    });\n\n    tracks.on('click', '.ase-btn-pause', (event) => {\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\n      this.onPauseTrack(trackId);\n    });\n\n    tracks.on('click', '.ase-btn-stop', (event) => {\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\n      this.onStopTrack(trackId);\n    });\n\n    tracks.on('click', '.ase-btn-remove', (event) => {\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\n      this.onRemoveTrack(trackId);\n    });\n\n    tracks.on('change', '.ase-loop-toggle', (event) => {\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\n      const loop = (event.target as HTMLInputElement).checked;\n      this.engine.setTrackLoop(trackId, loop);\n      this.socket.broadcastTrackLoop(trackId, loop);\n    });\n\n    tracks.on('change', '.ase-channel-select', (event) => {\n      const trackId = $(event.currentTarget).data('track-id') as string;\n      const channel = (event.target as HTMLSelectElement).value as TrackGroup;\n      this.engine.setTrackChannel(trackId, channel);\n    });\n\n    // Volume slider\n    const throttledVolume = throttle((trackId: string, value: number) => {\n      this.engine.setTrackVolume(trackId, value);\n      this.socket.broadcastTrackVolume(trackId, value);\n    }, 50);\n\n    tracks.on('input', '.ase-volume-slider', (event) => {\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\n      const value = parseFloat((event.target as HTMLInputElement).value) / 100;\n      throttledVolume(trackId, value);\n      $(event.currentTarget).siblings('.ase-volume-value').text(`${Math.round(value * 100)}%`);\n    });\n\n    // Seek slider\n    const throttledSeek = throttle((trackId: string, time: number) => {\n      const player = this.engine.getTrack(trackId);\n      const isPlaying = player?.state === 'playing';\n      this.engine.seekTrack(trackId, time);\n      this.socket.broadcastTrackSeek(trackId, time, isPlaying ?? false);\n    }, 100);\n\n    tracks.on('input', '.ase-seek-slider', (event) => {\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\n      const player = this.engine.getTrack(trackId);\n      if (player) {\n        const percent = parseFloat((event.target as HTMLInputElement).value);\n        const time = (percent / 100) * player.getDuration();\n        throttledSeek(trackId, time);\n      }\n    });\n\n    // Stop all\n    html.find('#ase-stop-all').on('click', () => {\n      this.engine.stopAll();\n      this.socket.broadcastStopAll();\n      this.render();\n    });\n\n    this.startUpdates();\n  }\n\n  private updateSyncIndicator(html: JQuery, enabled: boolean): void {\n    const indicator = html.find('.ase-sync-status');\n    indicator.toggleClass('is-active', enabled);\n    indicator.find('span').text(enabled ? 'SYNC ON' : 'SYNC OFF');\n  }\n\n  private startUpdates(): void {\n    this.stopUpdates();\n    this.updateInterval = setInterval(() => {\n      this.updateTrackDisplays();\n    }, 250);\n  }\n\n  private stopUpdates(): void {\n    if (this.updateInterval) {\n      clearInterval(this.updateInterval);\n      this.updateInterval = null;\n    }\n  }\n\n  private updateTrackDisplays(): void {\n    const html = this.element;\n    if (!html || !html.length) return;\n\n    let playingCount = 0;\n\n    for (const player of this.engine.getAllTracks()) {\n      const trackEl = html.find(`.ase-track[data-track-id=\"${player.id}\"]`);\n      if (!trackEl.length) continue;\n\n      const currentTime = player.getCurrentTime();\n      const duration = player.getDuration();\n      const progress = duration > 0 ? (currentTime / duration) * 100 : 0;\n      const state = player.state;\n\n      if (state === 'playing') playingCount++;\n\n      trackEl.find('.ase-time-current').text(formatTime(currentTime));\n      \n      const seekSlider = trackEl.find('.ase-seek-slider');\n      if (!seekSlider.is(':active')) {\n        seekSlider.val(progress);\n      }\n\n      trackEl.removeClass('is-playing is-paused is-stopped is-loading');\n      trackEl.addClass(`is-${state}`);\n      \n      trackEl.find('.ase-btn-play').prop('disabled', state === 'playing' || state === 'loading');\n      trackEl.find('.ase-btn-pause').prop('disabled', state !== 'playing');\n      trackEl.find('.ase-btn-stop').prop('disabled', state === 'stopped');\n    }\n\n    const totalTracks = this.engine.getAllTracks().length;\n    html.find('.ase-track-count').text(`${playingCount}/${totalTracks} playing`);\n  }\n\n  private async onAddTrack(): Promise<void> {\n    const fp = new FilePicker({\n      type: 'audio',\n      current: '',\n      callback: async (path: string) => {\n        await this.addTrackFromPath(path);\n      }\n    });\n    fp.render(true);\n  }\n\n  async addTrackFromPath(path: string, group: TrackGroup = 'music'): Promise<void> {\n    const trackId = `track-${Date.now()}`;\n    \n    try {\n      await this.engine.createTrack({\n        id: trackId,\n        url: path,\n        group,\n        volume: 1,\n        loop: false\n      });\n      \n      this.render();\n      ui.notifications?.info(`Added: ${this.extractFileName(path)}`);\n      \n    } catch (error) {\n      Logger.error('Failed to add track:', error);\n      ui.notifications?.error(`Failed to load: ${path}`);\n    }\n  }\n\n  private async onPlayTrack(trackId: string): Promise<void> {\n    const player = this.engine.getTrack(trackId);\n    if (!player) return;\n\n    const offset = player.state === 'paused' ? player.getCurrentTime() : 0;\n    await this.engine.playTrack(trackId, offset);\n    this.socket.broadcastTrackPlay(trackId, offset);\n  }\n\n  private onPauseTrack(trackId: string): void {\n    const player = this.engine.getTrack(trackId);\n    if (!player) return;\n    \n    const pausedAt = player.getCurrentTime();\n    this.engine.pauseTrack(trackId);\n    this.socket.broadcastTrackPause(trackId, pausedAt);\n  }\n\n  private onStopTrack(trackId: string): void {\n    this.engine.stopTrack(trackId);\n    this.socket.broadcastTrackStop(trackId);\n  }\n\n  private onRemoveTrack(trackId: string): void {\n    this.engine.removeTrack(trackId);\n    this.render();\n  }\n\n  override close(options?: Application.CloseOptions): Promise<void> {\n    this.stopUpdates();\n    return super.close(options);\n  }\n}","import { PlayerAudioEngine } from '@core/PlayerAudioEngine';\nimport { Logger } from '@utils/logger';\n\nconst MODULE_ID = 'advanced-sound-engine';\n\nexport class PlayerVolumePanel extends Application {\n  private engine: PlayerAudioEngine;\n\n  static override get defaultOptions(): ApplicationOptions {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      id: 'ase-player-volume',\n      title: 'Sound Volume',\n      template: `modules/${MODULE_ID}/templates/player-volume.hbs`,\n      classes: ['ase-player-panel'],\n      width: 200,\n      height: 'auto',\n      resizable: false,\n      minimizable: true,\n      popOut: true\n    }) as ApplicationOptions;\n  }\n\n  constructor(engine: PlayerAudioEngine, options?: Partial<ApplicationOptions>) {\n    super(options);\n    this.engine = engine;\n  }\n\n  override getData() {\n    return {\n      volume: Math.round(this.engine.localVolume * 100)\n    };\n  }\n\n  override activateListeners(html: JQuery): void {\n    super.activateListeners(html);\n\n    html.find('.ase-volume-slider').on('input', (event) => {\n      const value = parseFloat((event.target as HTMLInputElement).value) / 100;\n      this.engine.setLocalVolume(value);\n      html.find('.ase-volume-value').text(`${Math.round(value * 100)}%`);\n      \n      // Save preference\n      this.saveVolume(value);\n    });\n  }\n\n  private saveVolume(value: number): void {\n    localStorage.setItem(`${MODULE_ID}-player-volume`, String(value));\n  }\n\n  static loadSavedVolume(): number {\n    const saved = localStorage.getItem(`${MODULE_ID}-player-volume`);\n    return saved ? parseFloat(saved) : 1;\n  }\n}","import '../styles/sound-engine.scss';\nimport { AudioEngine } from '@core/AudioEngine';\nimport { PlayerAudioEngine } from '@core/PlayerAudioEngine';\nimport { SocketManager } from '@sync/SocketManager';\nimport { SoundMixerApp } from '@ui/SoundMixerApp';\nimport { PlayerVolumePanel } from '@ui/PlayerVolumePanel';\nimport { Logger } from '@utils/logger';\n\nconst MODULE_ID = 'advanced-sound-engine';\n\n// GM\nlet gmEngine: AudioEngine | null = null;\nlet mixerApp: SoundMixerApp | null = null;\n\n// Player\nlet playerEngine: PlayerAudioEngine | null = null;\nlet volumePanel: PlayerVolumePanel | null = null;\n\n// Shared\nlet socketManager: SocketManager | null = null;\n\ndeclare global {\n  interface Window {\n    ASE: {\n      isGM: boolean;\n      openPanel: () => void;\n      engine?: AudioEngine | PlayerAudioEngine;\n      socket?: SocketManager;\n    };\n  }\n}\n\n// ─────────────────────────────────────────────────────────────\n// Control Button (в начале файла, после импортов)\n// ─────────────────────────────────────────────────────────────\n\nHooks.on('getSceneControlButtons', (controls: Record<string, any>) => {\n  console.log('ASE: Hook fired', controls);\n  \n  const isGM = game.user?.isGM ?? false;\n\n  // Добавляем к существующему контролу sounds\ncontrols['advanced-sound-engine'] = {\n  name: 'advanced-sound-engine',\n  title: isGM ? 'Sound Mixer' : 'Sound Volume',\n  icon: isGM ? 'fas fa-sliders-h' : 'fas fa-volume-up',\n  visible: true,\n  tools: {\n    'open-panel': {\n      name: 'open-panel',\n      title: isGM ? 'Sound Mixer' : 'Sound Volume',\n      icon: isGM ? 'fas fa-sliders-h' : 'fas fa-volume-up',\n      button: true,\n      onClick: () => window.ASE?.openPanel()\n    }\n  }\n};\n});\n// ─────────────────────────────────────────────────────────────\n// Initialization\n// ─────────────────────────────────────────────────────────────\n\nHooks.once('init', () => {\n  Logger.info('Initializing Advanced Sound Engine...');\n  registerSettings();\n});\n\nHooks.once('ready', async () => {\n  const isGM = game.user?.isGM ?? false;\n  Logger.info(`Starting Advanced Sound Engine (${isGM ? 'GM' : 'Player'})...`);\n  \n  socketManager = new SocketManager();\n  \n  if (isGM) {\n    await initializeGM();\n  } else {\n    await initializePlayer();\n  }\n  \n  window.ASE = {\n    isGM,\n    openPanel: isGM ? openMixer : openVolumePanel,\n    engine: isGM ? gmEngine ?? undefined : playerEngine ?? undefined,\n    socket: socketManager ?? undefined\n  };\n  \n  setupAutoplayHandler();\n    \n  Logger.info('Advanced Sound Engine ready');\n});\n\nasync function initializeGM(): Promise<void> {\n  gmEngine = new AudioEngine();\n  socketManager!.initializeAsGM(gmEngine);\n  \n  await gmEngine.loadSavedState();\n}\n\nasync function initializePlayer(): Promise<void> {\n  playerEngine = new PlayerAudioEngine();\n  socketManager!.initializeAsPlayer(playerEngine);\n  \n  // Restore saved local volume\n  const savedVolume = PlayerVolumePanel.loadSavedVolume();\n  playerEngine.setLocalVolume(savedVolume);\n}\n\n// ─────────────────────────────────────────────────────────────\n// Panels\n// ─────────────────────────────────────────────────────────────\n\nfunction openMixer(): void {\n  if (!gmEngine || !socketManager) return;\n  \n  if (mixerApp && mixerApp.rendered) {\n    mixerApp.bringToTop();\n  } else {\n    mixerApp = new SoundMixerApp(gmEngine, socketManager);\n    mixerApp.render(true);\n  }\n}\n\nfunction openVolumePanel(): void {\n  if (!playerEngine) return;\n  \n  if (volumePanel && volumePanel.rendered) {\n    volumePanel.bringToTop();\n  } else {\n    volumePanel = new PlayerVolumePanel(playerEngine);\n    volumePanel.render(true);\n  }\n}\n\n\n\n// ─────────────────────────────────────────────────────────────\n// Autoplay Policy Handler\n// ─────────────────────────────────────────────────────────────\n\nfunction setupAutoplayHandler(): void {\n  const resumeAudio = () => {\n    gmEngine?.resume();\n    playerEngine?.resume();\n  };\n  \n  document.addEventListener('click', resumeAudio, { once: true });\n  document.addEventListener('keydown', resumeAudio, { once: true });\n  \n  Hooks.once('canvasReady', resumeAudio);\n}\n\n// ─────────────────────────────────────────────────────────────\n// Settings\n// ─────────────────────────────────────────────────────────────\n\nfunction registerSettings(): void {\n  game.settings.register(MODULE_ID, 'mixerState', {\n    name: 'Mixer State',\n    hint: 'Internal storage for mixer state',\n    scope: 'world',\n    config: false,\n    type: String,\n    default: ''\n  });\n}\n\n// ─────────────────────────────────────────────────────────────\n// Cleanup\n// ─────────────────────────────────────────────────────────────\n\nHooks.once('closeGame', () => {\n  mixerApp?.close();\n  volumePanel?.close();\n  socketManager?.dispose();\n  gmEngine?.dispose();\n  playerEngine?.dispose();\n});"],"names":["PREFIX","Logger","message","args","_a","StreamingPlayer","id","ctx","channelOutput","group","__publicField","url","resolve","reject","onCanPlay","onError","offset","error","time","safeTime","value","newGroup","newOutput","getServerTime","formatTime","seconds","mins","secs","MODULE_ID","MAX_SIMULTANEOUS","AudioEngine","state","savedJson","config","player","playingCount","t","volume","loop","channel","tracks","trackState","stateTrackIds","PlayerAudioEngine","safeValue","volumes","payload","elapsed","adjustedOffset","trackId","isPlaying","seekTimestamp","newTrackIds","adjustedTime","SOCKET_NAME","SocketManager","engine","enabled","startPayload","statePayload","playPayload","pausePayload","stopPayload","seekPayload","volPayload","loopPayload","chVolPayload","type","targetUserId","now","userId","pausedAt","throttle","fn","delay","lastCall","timeoutId","remaining","SoundMixerApp","socket","options","currentTime","duration","parts","html","event","throttledChannelVolume","throttledVolume","throttledSeek","indicator","trackEl","progress","seekSlider","totalTracks","path","_b","PlayerVolumePanel","saved","gmEngine","mixerApp","playerEngine","volumePanel","socketManager","controls","isGM","registerSettings","initializeGM","initializePlayer","openMixer","openVolumePanel","setupAutoplayHandler","savedVolume","resumeAudio"],"mappings":"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"}
=======
{"version":3,"file":"module.js","sources":["../src/utils/logger.ts","../src/core/StreamingPlayer.ts","../src/utils/time.ts","../src/utils/uuid.ts","../src/utils/audio-validation.ts","../src/core/AudioEngine.ts","../src/core/PlayerAudioEngine.ts","../src/sync/SocketManager.ts","../src/utils/throttle.ts","../src/ui/SoundMixerApp.ts","../src/ui/PlayerVolumePanel.ts","../src/ui/LocalLibraryApp.ts","../src/library/LibraryManager.ts","../src/module.ts"],"sourcesContent":["const PREFIX = 'ASE';\n\nexport const Logger = {\n  info: (message: string, ...args: unknown[]) => {\n    console.log(`${PREFIX} | ${message}`, ...args);\n  },\n  \n  warn: (message: string, ...args: unknown[]) => {\n    console.warn(`${PREFIX} | ${message}`, ...args);\n  },\n  \n  error: (message: string, ...args: unknown[]) => {\n    console.error(`${PREFIX} | ${message}`, ...args);\n  },\n  \n  debug: (message: string, ...args: unknown[]) => {\n    if (CONFIG?.debug?.audio) {\n      console.debug(`${PREFIX} | ${message}`, ...args);\n    }\n  }\n};","import type { TrackGroup, PlaybackState } from '@t/audio';\nimport { Logger } from '@utils/logger';\n\nexport class StreamingPlayer {\n  readonly id: string;\n  private ctx: AudioContext;\n  private _group: TrackGroup;\n  private _url: string = '';\n  \n  private audio: HTMLAudioElement;\n  private sourceNode: MediaElementAudioSourceNode | null = null;\n  private gainNode: GainNode;\n  private outputNode: GainNode;\n  \n  private _state: PlaybackState = 'stopped';\n  private _volume: number = 1;\n  private _loop: boolean = false;\n  private _ready: boolean = false;\n\n  constructor(\n    id: string,\n    ctx: AudioContext,\n    channelOutput: GainNode,\n    group: TrackGroup = 'music'\n  ) {\n    this.id = id;\n    this.ctx = ctx;\n    this._group = group;\n    \n    this.audio = new Audio();\n    this.audio.crossOrigin = 'anonymous';\n    this.audio.preload = 'auto';\n    \n    this.gainNode = ctx.createGain();\n    this.outputNode = ctx.createGain();\n    \n    this.gainNode.connect(this.outputNode);\n    this.outputNode.connect(channelOutput);\n    \n    this.setupAudioEvents();\n  }\n\n  private setupAudioEvents(): void {\n    this.audio.addEventListener('canplay', () => {\n      this._ready = true;\n      if (this._state === 'loading') {\n        this._state = 'stopped';\n      }\n      Logger.debug(`Track ${this.id} ready to play`);\n    });\n\n    this.audio.addEventListener('ended', () => {\n      if (!this._loop) {\n        this._state = 'stopped';\n        Logger.debug(`Track ${this.id} ended`);\n      }\n    });\n\n    this.audio.addEventListener('error', (e) => {\n      Logger.error(`Track ${this.id} error:`, this.audio.error);\n      this._state = 'stopped';\n    });\n  }\n\n  get state(): PlaybackState {\n    return this._state;\n  }\n\n  get group(): TrackGroup {\n    return this._group;\n  }\n\n  get url(): string {\n    return this._url;\n  }\n\n  get volume(): number {\n    return this._volume;\n  }\n\n  get loop(): boolean {\n    return this._loop;\n  }\n\n  get ready(): boolean {\n    return this._ready;\n  }\n\n  async load(url: string): Promise<void> {\n    this._state = 'loading';\n    this._url = url;\n    this._ready = false;\n\n    return new Promise((resolve, reject) => {\n      const onCanPlay = () => {\n        this.audio.removeEventListener('canplay', onCanPlay);\n        this.audio.removeEventListener('error', onError);\n        \n        // Connect to Web Audio\n        if (!this.sourceNode) {\n          this.sourceNode = this.ctx.createMediaElementSource(this.audio);\n          this.sourceNode.connect(this.gainNode);\n        }\n        \n        this._ready = true;\n        this._state = 'stopped';\n        Logger.debug(`Track loaded: ${this.id}`);\n        resolve();\n      };\n\n      const onError = () => {\n        this.audio.removeEventListener('canplay', onCanPlay);\n        this.audio.removeEventListener('error', onError);\n        this._state = 'stopped';\n        reject(new Error(`Failed to load: ${url}`));\n      };\n\n      this.audio.addEventListener('canplay', onCanPlay, { once: true });\n      this.audio.addEventListener('error', onError, { once: true });\n      \n      this.audio.src = url;\n      this.audio.load();\n    });\n  }\n\n  async play(offset: number = 0): Promise<void> {\n    if (!this._ready) {\n      Logger.warn(`Track ${this.id} not ready`);\n      return;\n    }\n\n    try {\n      this.audio.currentTime = Math.max(0, Math.min(offset, this.audio.duration || 0));\n      this.audio.loop = this._loop;\n      await this.audio.play();\n      this._state = 'playing';\n      Logger.debug(`Track ${this.id} playing from ${offset.toFixed(2)}s`);\n    } catch (error) {\n      Logger.error(`Failed to play ${this.id}:`, error);\n    }\n  }\n\n  pause(): void {\n    if (this._state !== 'playing') return;\n    \n    this.audio.pause();\n    this._state = 'paused';\n    Logger.debug(`Track ${this.id} paused at ${this.audio.currentTime.toFixed(2)}s`);\n  }\n\n  stop(): void {\n    this.audio.pause();\n    this.audio.currentTime = 0;\n    this._state = 'stopped';\n    Logger.debug(`Track ${this.id} stopped`);\n  }\n\n  seek(time: number): void {\n    const safeTime = Math.max(0, Math.min(time, this.audio.duration || 0));\n    this.audio.currentTime = safeTime;\n  }\n\n  setVolume(value: number): void {\n    this._volume = Math.max(0, Math.min(1, value));\n    this.gainNode.gain.setValueAtTime(this._volume, this.ctx.currentTime);\n  }\n\n  setLoop(value: boolean): void {\n    this._loop = value;\n    this.audio.loop = value;\n  }\n\n  setChannel(newGroup: TrackGroup, newOutput: GainNode): void {\n    this._group = newGroup;\n    this.outputNode.disconnect();\n    this.outputNode.connect(newOutput);\n  }\n\n  getCurrentTime(): number {\n    return this.audio.currentTime;\n  }\n\n  getDuration(): number {\n    return this.audio.duration || 0;\n  }\n\n  getState() {\n    return {\n      id: this.id,\n      url: this._url,\n      group: this._group,\n      playbackState: this._state,\n      volume: this._volume,\n      loop: this._loop,\n      currentTime: this.getCurrentTime(),\n      duration: this.getDuration()\n    };\n  }\n\n  dispose(): void {\n    this.audio.pause();\n    this.audio.src = '';\n    this.sourceNode?.disconnect();\n    this.gainNode.disconnect();\n    this.outputNode.disconnect();\n    Logger.debug(`Track ${this.id} disposed`);\n  }\n}","/**\n * Get current server time (for sync calculations)\n */\nexport function getServerTime(): number {\n  // Foundry's game.time.serverTime учитывает offset\n  return Date.now();\n}\n\n/**\n * Calculate playback offset based on start time\n */\nexport function calculateOffset(startedAt: number, pausedAt: number = 0): number {\n  if (pausedAt > 0) {\n    return pausedAt;\n  }\n  return (getServerTime() - startedAt) / 1000;\n}\n\n/**\n * Format seconds to mm:ss\n */\nexport function formatTime(seconds: number): string {\n  if (!isFinite(seconds) || seconds < 0) return '0:00';\n  \n  const mins = Math.floor(seconds / 60);\n  const secs = Math.floor(seconds % 60);\n  return `${mins}:${secs.toString().padStart(2, '0')}`;\n}","/**\n * Generate a UUID v4\n * Based on RFC 4122 standard\n */\nexport function generateUUID(): string {\n  // Use crypto.randomUUID if available (modern browsers/Node 19+)\n  if (typeof crypto !== 'undefined' && crypto.randomUUID) {\n    return crypto.randomUUID();\n  }\n\n  // Fallback: manual UUID v4 generation\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {\n    const r = Math.random() * 16 | 0;\n    const v = c === 'x' ? r : (r & 0x3 | 0x8);\n    return v.toString(16);\n  });\n}\n\n/**\n * Validate UUID format\n */\nexport function isValidUUID(uuid: string): boolean {\n  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;\n  return uuidRegex.test(uuid);\n}\n","/**\n * Поддерживаемые аудио форматы\n */\nexport const SUPPORTED_AUDIO_FORMATS = [\n  '.mp3',\n  '.ogg',\n  '.wav',\n  '.webm',\n  '.m4a',\n  '.aac',\n  '.flac',\n  '.opus'\n] as const;\n\nexport type SupportedAudioFormat = typeof SUPPORTED_AUDIO_FORMATS[number];\n\n/**\n * MIME типы для поддерживаемых форматов\n */\nexport const AUDIO_MIME_TYPES: Record<string, string> = {\n  '.mp3': 'audio/mpeg',\n  '.ogg': 'audio/ogg',\n  '.wav': 'audio/wav',\n  '.webm': 'audio/webm',\n  '.m4a': 'audio/mp4',\n  '.aac': 'audio/aac',\n  '.flac': 'audio/flac',\n  '.opus': 'audio/opus'\n};\n\n/**\n * Проверка, является ли файл поддерживаемым аудио форматом\n */\nexport function isValidAudioFormat(url: string): boolean {\n  const extension = getFileExtension(url);\n  return SUPPORTED_AUDIO_FORMATS.includes(extension as SupportedAudioFormat);\n}\n\n/**\n * Получить расширение файла из URL\n */\nexport function getFileExtension(url: string): string {\n  try {\n    // Decode URL first\n    const decoded = decodeURIComponent(url);\n\n    // Remove query parameters and hash\n    const cleanUrl = decoded.split('?')[0].split('#')[0];\n\n    // Extract extension\n    const match = cleanUrl.match(/\\.([a-z0-9]+)$/i);\n    return match ? `.${match[1].toLowerCase()}` : '';\n  } catch {\n    return '';\n  }\n}\n\n/**\n * Получить MIME тип для аудио файла\n */\nexport function getAudioMimeType(url: string): string | null {\n  const extension = getFileExtension(url);\n  return AUDIO_MIME_TYPES[extension] || null;\n}\n\n/**\n * Валидация результата с деталями ошибки\n */\nexport interface AudioValidationResult {\n  valid: boolean;\n  error?: string;\n  extension?: string;\n  mimeType?: string;\n}\n\n/**\n * Полная валидация аудио файла\n */\nexport function validateAudioFile(url: string): AudioValidationResult {\n  if (!url || typeof url !== 'string') {\n    return {\n      valid: false,\n      error: 'URL is required and must be a string'\n    };\n  }\n\n  const extension = getFileExtension(url);\n\n  if (!extension) {\n    return {\n      valid: false,\n      error: 'Could not extract file extension from URL'\n    };\n  }\n\n  if (!isValidAudioFormat(url)) {\n    return {\n      valid: false,\n      error: `Unsupported audio format: ${extension}. Supported formats: ${SUPPORTED_AUDIO_FORMATS.join(', ')}`,\n      extension\n    };\n  }\n\n  const mimeType = getAudioMimeType(url);\n\n  return {\n    valid: true,\n    extension,\n    mimeType: mimeType || undefined\n  };\n}\n\n/**\n * Проверка поддержки формата браузером\n */\nexport function isBrowserAudioSupported(extension: string): boolean {\n  if (typeof Audio === 'undefined') {\n    return false;\n  }\n\n  const mimeType = AUDIO_MIME_TYPES[extension];\n  if (!mimeType) {\n    return false;\n  }\n\n  const audio = new Audio();\n  const canPlay = audio.canPlayType(mimeType);\n\n  // Returns: '' (no support), 'maybe', 'probably'\n  return canPlay === 'probably' || canPlay === 'maybe';\n}\n","import type { TrackConfig, TrackState, MixerState, TrackGroup, ChannelVolumes } from '@t/audio';\nimport { StreamingPlayer } from './StreamingPlayer';\nimport { Logger } from '@utils/logger';\nimport { getServerTime } from '@utils/time';\nimport { generateUUID } from '@utils/uuid';\nimport { validateAudioFile } from '@utils/audio-validation';\n\nconst MODULE_ID = 'advanced-sound-engine';\n\nfunction getMaxSimultaneous(): number {\n  return (game.settings.get(MODULE_ID, 'maxSimultaneousTracks') as number) || 8;\n}\n\nexport class AudioEngine {\n  private ctx: AudioContext;\n  private masterGain: GainNode;\n  private channelGains: Record<TrackGroup, GainNode>;\n  private players: Map<string, StreamingPlayer> = new Map();\n  \n  private _volumes: ChannelVolumes = {\n    master: 1,\n    music: 1,\n    ambience: 1,\n    sfx: 1\n  };\n  \n  private saveTimeout: ReturnType<typeof setTimeout> | null = null;\n\n  constructor() {\n    this.ctx = new AudioContext();\n    \n    this.masterGain = this.ctx.createGain();\n    this.masterGain.connect(this.ctx.destination);\n    \n    this.channelGains = {\n      music: this.ctx.createGain(),\n      ambience: this.ctx.createGain(),\n      sfx: this.ctx.createGain()\n    };\n    \n    this.channelGains.music.connect(this.masterGain);\n    this.channelGains.ambience.connect(this.masterGain);\n    this.channelGains.sfx.connect(this.masterGain);\n    \n    Logger.info('AudioEngine initialized');\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Persistence (GM only)\n  // ─────────────────────────────────────────────────────────────\n\n  private scheduleSave(): void {\n    if (!game.user?.isGM) return;\n    \n    if (this.saveTimeout) {\n      clearTimeout(this.saveTimeout);\n    }\n    this.saveTimeout = setTimeout(() => {\n      this.saveState();\n    }, 500);\n  }\n\n  private async saveState(): Promise<void> {\n    if (!game.ready || !game.user?.isGM) return;\n    \n    const state = this.getState();\n    \n    try {\n      await game.settings.set(MODULE_ID, 'mixerState', JSON.stringify(state));\n      Logger.debug('Mixer state saved');\n    } catch (error) {\n      Logger.error('Failed to save mixer state:', error);\n    }\n  }\n\n  async loadSavedState(): Promise<void> {\n    if (!game.ready) return;\n    \n    try {\n      const savedJson = game.settings.get(MODULE_ID, 'mixerState') as string;\n      if (!savedJson) return;\n      \n      const state = JSON.parse(savedJson) as MixerState;\n      await this.restoreState(state);\n      \n      Logger.info('Mixer state restored');\n    } catch (error) {\n      Logger.error('Failed to load mixer state:', error);\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Track Management\n  // ─────────────────────────────────────────────────────────────\n\n  async createTrack(config: TrackConfig): Promise<StreamingPlayer> {\n    // Generate UUID if not provided\n    const trackId = config.id || generateUUID();\n\n    if (this.players.has(trackId)) {\n      return this.players.get(trackId)!;\n    }\n\n    // Validate audio file format\n    const validation = validateAudioFile(config.url);\n    if (!validation.valid) {\n      const error = new Error(validation.error || 'Invalid audio file');\n      Logger.error(`Track validation failed: ${validation.error}`);\n      throw error;\n    }\n\n    const channelOutput = this.channelGains[config.group];\n\n    const player = new StreamingPlayer(\n      trackId,\n      this.ctx,\n      channelOutput,\n      config.group\n    );\n\n    if (config.volume !== undefined) {\n      player.setVolume(config.volume);\n    }\n    if (config.loop !== undefined) {\n      player.setLoop(config.loop);\n    }\n\n    await player.load(config.url);\n\n    this.players.set(trackId, player);\n    this.scheduleSave();\n\n    Logger.info(`Track created: ${trackId} (${validation.extension})`);\n    return player;\n  }\n\n  getTrack(id: string): StreamingPlayer | undefined {\n    return this.players.get(id);\n  }\n\n  removeTrack(id: string): boolean {\n    const player = this.players.get(id);\n    if (!player) return false;\n\n    player.dispose();\n    this.players.delete(id);\n    this.scheduleSave();\n    \n    Logger.info(`Track removed: ${id}`);\n    return true;\n  }\n\n  getAllTracks(): StreamingPlayer[] {\n    return Array.from(this.players.values());\n  }\n\n  getTracksByGroup(group: TrackGroup): StreamingPlayer[] {\n    return this.getAllTracks().filter(t => t.group === group);\n  }\n\n  setTrackChannel(id: string, newGroup: TrackGroup): void {\n    const player = this.players.get(id);\n    if (!player) return;\n    \n    player.setChannel(newGroup, this.channelGains[newGroup]);\n    this.scheduleSave();\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Playback Control\n  // ─────────────────────────────────────────────────────────────\n\n  async playTrack(id: string, offset: number = 0): Promise<void> {\n    const player = this.players.get(id);\n    if (!player) {\n      Logger.warn(`Track not found: ${id}`);\n      return;\n    }\n\n    const maxSimultaneous = getMaxSimultaneous();\n    const playingCount = this.getAllTracks().filter(t => t.state === 'playing').length;\n    const isCurrentlyPlaying = player.state === 'playing';\n\n    if (!isCurrentlyPlaying && playingCount >= maxSimultaneous) {\n      Logger.warn(`Maximum simultaneous tracks (${maxSimultaneous}) reached`);\n      ui.notifications?.warn(`Cannot play more than ${maxSimultaneous} tracks simultaneously`);\n      return;\n    }\n\n    await player.play(offset);\n  }\n\n  pauseTrack(id: string): void {\n    this.players.get(id)?.pause();\n  }\n\n  stopTrack(id: string): void {\n    this.players.get(id)?.stop();\n  }\n\n  seekTrack(id: string, time: number): void {\n    this.players.get(id)?.seek(time);\n  }\n\n  setTrackVolume(id: string, volume: number): void {\n    this.players.get(id)?.setVolume(volume);\n    this.scheduleSave();\n  }\n\n  setTrackLoop(id: string, loop: boolean): void {\n    this.players.get(id)?.setLoop(loop);\n    this.scheduleSave();\n  }\n\n  stopAll(): void {\n    for (const player of this.players.values()) {\n      player.stop();\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Volume Control\n  // ─────────────────────────────────────────────────────────────\n\n  get volumes(): ChannelVolumes {\n    return { ...this._volumes };\n  }\n\n  setMasterVolume(value: number): void {\n    this._volumes.master = Math.max(0, Math.min(1, value));\n    this.masterGain.gain.linearRampToValueAtTime(\n      this._volumes.master,\n      this.ctx.currentTime + 0.01\n    );\n    this.scheduleSave();\n  }\n\n  setChannelVolume(channel: TrackGroup, value: number): void {\n    this._volumes[channel] = Math.max(0, Math.min(1, value));\n    this.channelGains[channel].gain.linearRampToValueAtTime(\n      this._volumes[channel],\n      this.ctx.currentTime + 0.01\n    );\n    this.scheduleSave();\n  }\n\n  getChannelVolume(channel: TrackGroup): number {\n    return this._volumes[channel];\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // State\n  // ─────────────────────────────────────────────────────────────\n\n  getState(): MixerState {\n    const tracks: TrackState[] = [];\n    \n    for (const player of this.players.values()) {\n      tracks.push(player.getState());\n    }\n\n    return {\n      masterVolume: this._volumes.master,\n      channelVolumes: { ...this._volumes },\n      tracks,\n      timestamp: getServerTime(),\n      syncEnabled: false\n    };\n  }\n\n  async restoreState(state: MixerState): Promise<void> {\n    // Restore volumes\n    this._volumes.master = state.masterVolume;\n    this.masterGain.gain.setValueAtTime(this._volumes.master, this.ctx.currentTime);\n    \n    if (state.channelVolumes) {\n      for (const channel of ['music', 'ambience', 'sfx'] as TrackGroup[]) {\n        this._volumes[channel] = state.channelVolumes[channel];\n        this.channelGains[channel].gain.setValueAtTime(this._volumes[channel], this.ctx.currentTime);\n      }\n    }\n\n    // Restore tracks (without playing)\n    for (const trackState of state.tracks) {\n      if (!this.players.has(trackState.id)) {\n        try {\n          await this.createTrack({\n            id: trackState.id,\n            url: trackState.url,\n            group: trackState.group,\n            volume: trackState.volume,\n            loop: trackState.loop\n          });\n        } catch (error) {\n          Logger.error(`Failed to restore track ${trackState.id}:`, error);\n        }\n      }\n    }\n\n    // Remove tracks not in state\n    const stateTrackIds = new Set(state.tracks.map(t => t.id));\n    for (const [id] of this.players) {\n      if (!stateTrackIds.has(id)) {\n        this.removeTrack(id);\n      }\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Audio Context\n  // ─────────────────────────────────────────────────────────────\n\n  async resume(): Promise<void> {\n    if (this.ctx.state === 'suspended') {\n      await this.ctx.resume();\n      Logger.info('AudioContext resumed');\n    }\n  }\n\n  get contextState(): AudioContextState {\n    return this.ctx.state;\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Cleanup\n  // ─────────────────────────────────────────────────────────────\n\n  dispose(): void {\n    if (this.saveTimeout) {\n      clearTimeout(this.saveTimeout);\n    }\n    for (const player of this.players.values()) {\n      player.dispose();\n    }\n    this.players.clear();\n    this.ctx.close();\n    Logger.info('AudioEngine disposed');\n  }\n}","import type { TrackGroup, ChannelVolumes, SyncTrackState, TrackPlayPayload } from '@t/audio';\nimport { StreamingPlayer } from './StreamingPlayer';\nimport { Logger } from '@utils/logger';\nimport { getServerTime } from '@utils/time';\n\n/**\n * Упрощенный движок для игроков — только получает команды\n */\nexport class PlayerAudioEngine {\n  private ctx: AudioContext;\n  private masterGain: GainNode;\n  private gmGain: GainNode; // Громкость от GM\n  private channelGains: Record<TrackGroup, GainNode>;\n  private players: Map<string, StreamingPlayer> = new Map();\n  \n  private _localVolume: number = 1; // Личная громкость игрока\n  private _gmVolumes: ChannelVolumes = {\n    master: 1,\n    music: 1,\n    ambience: 1,\n    sfx: 1\n  };\n\n  constructor() {\n    this.ctx = new AudioContext();\n    \n    // Chain: tracks -> channels -> gmGain -> masterGain -> destination\n    this.masterGain = this.ctx.createGain();\n    this.masterGain.connect(this.ctx.destination);\n    \n    this.gmGain = this.ctx.createGain();\n    this.gmGain.connect(this.masterGain);\n    \n    this.channelGains = {\n      music: this.ctx.createGain(),\n      ambience: this.ctx.createGain(),\n      sfx: this.ctx.createGain()\n    };\n    \n    this.channelGains.music.connect(this.gmGain);\n    this.channelGains.ambience.connect(this.gmGain);\n    this.channelGains.sfx.connect(this.gmGain);\n    \n    Logger.info('PlayerAudioEngine initialized');\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Local Volume (Player's personal control)\n  // ─────────────────────────────────────────────────────────────\n\n  get localVolume(): number {\n    return this._localVolume;\n  }\n\n  setLocalVolume(value: number): void {\n    this._localVolume = Math.max(0, Math.min(1, value));\n    this.masterGain.gain.linearRampToValueAtTime(\n      this._localVolume,\n      this.ctx.currentTime + 0.01\n    );\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // GM Volume (from sync)\n  // ─────────────────────────────────────────────────────────────\n\n  setGMVolume(channel: TrackGroup | 'master', value: number): void {\n    const safeValue = Math.max(0, Math.min(1, value));\n    \n    if (channel === 'master') {\n      this._gmVolumes.master = safeValue;\n      this.gmGain.gain.linearRampToValueAtTime(safeValue, this.ctx.currentTime + 0.01);\n    } else {\n      this._gmVolumes[channel] = safeValue;\n      this.channelGains[channel].gain.linearRampToValueAtTime(safeValue, this.ctx.currentTime + 0.01);\n    }\n  }\n\n  setAllGMVolumes(volumes: ChannelVolumes): void {\n    this._gmVolumes = { ...volumes };\n    \n    this.gmGain.gain.setValueAtTime(volumes.master, this.ctx.currentTime);\n    this.channelGains.music.gain.setValueAtTime(volumes.music, this.ctx.currentTime);\n    this.channelGains.ambience.gain.setValueAtTime(volumes.ambience, this.ctx.currentTime);\n    this.channelGains.sfx.gain.setValueAtTime(volumes.sfx, this.ctx.currentTime);\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Track Commands (from GM via socket)\n  // ─────────────────────────────────────────────────────────────\n\n  async handlePlay(payload: TrackPlayPayload): Promise<void> {\n    let player = this.players.get(payload.trackId);\n    \n    // Create if doesn't exist\n    if (!player) {\n      player = new StreamingPlayer(\n        payload.trackId,\n        this.ctx,\n        this.channelGains[payload.group],\n        payload.group\n      );\n      \n      await player.load(payload.url);\n      this.players.set(payload.trackId, player);\n    }\n    \n    player.setVolume(payload.volume);\n    player.setLoop(payload.loop);\n    \n    // Calculate offset based on time elapsed since GM started\n    const elapsed = (getServerTime() - payload.startTimestamp) / 1000;\n    const adjustedOffset = Math.max(0, payload.offset + elapsed);\n    \n    await player.play(adjustedOffset);\n    Logger.debug(`Player: track ${payload.trackId} playing at ${adjustedOffset.toFixed(2)}s`);\n  }\n\n  handlePause(trackId: string): void {\n    this.players.get(trackId)?.pause();\n  }\n\n  handleStop(trackId: string): void {\n    this.players.get(trackId)?.stop();\n  }\n\n  handleSeek(trackId: string, time: number, isPlaying: boolean, seekTimestamp: number): void {\n    const player = this.players.get(trackId);\n    if (!player) return;\n    \n    if (isPlaying) {\n      const elapsed = (getServerTime() - seekTimestamp) / 1000;\n      player.seek(time + elapsed);\n    } else {\n      player.seek(time);\n    }\n  }\n\n  handleTrackVolume(trackId: string, volume: number): void {\n    this.players.get(trackId)?.setVolume(volume);\n  }\n\n  handleTrackLoop(trackId: string, loop: boolean): void {\n    this.players.get(trackId)?.setLoop(loop);\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Sync State (full state from GM)\n  // ─────────────────────────────────────────────────────────────\n\n  async syncState(tracks: SyncTrackState[], volumes: ChannelVolumes): Promise<void> {\n    // Set volumes\n    this.setAllGMVolumes(volumes);\n    \n    // Handle tracks\n    const newTrackIds = new Set(tracks.map(t => t.id));\n    \n    // Remove tracks not in sync\n    for (const [id, player] of this.players) {\n      if (!newTrackIds.has(id)) {\n        player.dispose();\n        this.players.delete(id);\n      }\n    }\n    \n    // Add/update tracks\n    for (const trackState of tracks) {\n      let player = this.players.get(trackState.id);\n      \n      if (!player) {\n        player = new StreamingPlayer(\n          trackState.id,\n          this.ctx,\n          this.channelGains[trackState.group],\n          trackState.group\n        );\n        \n        await player.load(trackState.url);\n        this.players.set(trackState.id, player);\n      }\n      \n      player.setVolume(trackState.volume);\n      player.setLoop(trackState.loop);\n      \n      if (trackState.isPlaying) {\n        const elapsed = (getServerTime() - trackState.startTimestamp) / 1000;\n        const adjustedTime = trackState.currentTime + elapsed;\n        await player.play(adjustedTime);\n      } else {\n        player.stop();\n      }\n    }\n    \n    Logger.info('Player: synced state from GM');\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Sync Off\n  // ─────────────────────────────────────────────────────────────\n\n  stopAll(): void {\n    for (const player of this.players.values()) {\n      player.stop();\n    }\n  }\n\n  clearAll(): void {\n    for (const player of this.players.values()) {\n      player.dispose();\n    }\n    this.players.clear();\n    Logger.info('Player: all tracks cleared');\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Audio Context\n  // ─────────────────────────────────────────────────────────────\n\n  async resume(): Promise<void> {\n    if (this.ctx.state === 'suspended') {\n      await this.ctx.resume();\n      Logger.info('PlayerAudioEngine: AudioContext resumed');\n    }\n  }\n\n  dispose(): void {\n    this.clearAll();\n    this.ctx.close();\n    Logger.info('PlayerAudioEngine disposed');\n  }\n}","import type { \n  SocketMessage, \n  SocketMessageType,\n  SyncStatePayload,\n  SyncTrackState,\n  TrackPlayPayload,\n  TrackPausePayload,\n  TrackStopPayload,\n  TrackSeekPayload,\n  TrackVolumePayload,\n  TrackLoopPayload,\n  ChannelVolumePayload,\n  TrackGroup,\n  ChannelVolumes\n} from '@t/audio';\nimport { AudioEngine } from '@core/AudioEngine';\nimport { PlayerAudioEngine } from '@core/PlayerAudioEngine';\nimport { Logger } from '@utils/logger';\nimport { getServerTime } from '@utils/time';\n\nconst MODULE_ID = 'advanced-sound-engine';\nconst SOCKET_NAME = `module.${MODULE_ID}`;\n\nexport class SocketManager {\n  private gmEngine: AudioEngine | null = null;\n  private playerEngine: PlayerAudioEngine | null = null;\n  private socket: any = null;\n  private _syncEnabled: boolean = false;\n  private isGM: boolean = false;\n\n  constructor() {}\n\n  initializeAsGM(engine: AudioEngine): void {\n    this.isGM = true;\n    this.gmEngine = engine;\n    this.socket = game.socket;\n    \n    this.socket?.on(SOCKET_NAME, (message: SocketMessage) => {\n      this.handleGMMessage(message);\n    });\n    \n    Logger.info('SocketManager initialized as GM');\n  }\n\n  initializeAsPlayer(engine: PlayerAudioEngine): void {\n    this.isGM = false;\n    this.playerEngine = engine;\n    this.socket = game.socket;\n    \n    this.socket?.on(SOCKET_NAME, (message: SocketMessage) => {\n      this.handlePlayerMessage(message);\n    });\n    \n    // Request current state on join\n    setTimeout(() => {\n      this.send('player-ready', {});\n    }, 1000);\n    \n    Logger.info('SocketManager initialized as Player');\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Sync Mode (GM)\n  // ─────────────────────────────────────────────────────────────\n\n  get syncEnabled(): boolean {\n    return this._syncEnabled;\n  }\n\n  setSyncEnabled(enabled: boolean): void {\n    if (!this.isGM) return;\n    \n    this._syncEnabled = enabled;\n    \n    if (enabled) {\n      this.broadcastSyncStart();\n    } else {\n      this.broadcastSyncStop();\n    }\n    \n    Logger.info(`Sync mode: ${enabled ? 'ON' : 'OFF'}`);\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // GM Message Handling\n  // ─────────────────────────────────────────────────────────────\n\n  private handleGMMessage(message: SocketMessage): void {\n    if (message.senderId === game.user?.id) return;\n    \n    if (message.type === 'player-ready' && this._syncEnabled) {\n      // Send current state to newly joined player\n      this.sendStateTo(message.senderId);\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Player Message Handling\n  // ─────────────────────────────────────────────────────────────\n\n  private async handlePlayerMessage(message: SocketMessage): Promise<void> {\n    if (message.senderId === game.user?.id) return;\n    if (!this.playerEngine) return;\n    \n    Logger.debug(`Player received: ${message.type}`, message.payload);\n    \n    switch (message.type) {\n      case 'sync-start':\n        const startPayload = message.payload as SyncStatePayload;\n        await this.playerEngine.syncState(startPayload.tracks, startPayload.channelVolumes);\n        break;\n        \n      case 'sync-stop':\n        this.playerEngine.clearAll();\n        break;\n        \n      case 'sync-state':\n        const statePayload = message.payload as SyncStatePayload;\n        await this.playerEngine.syncState(statePayload.tracks, statePayload.channelVolumes);\n        break;\n        \n      case 'track-play':\n        const playPayload = message.payload as TrackPlayPayload;\n        await this.playerEngine.handlePlay(playPayload);\n        break;\n        \n      case 'track-pause':\n        const pausePayload = message.payload as TrackPausePayload;\n        this.playerEngine.handlePause(pausePayload.trackId);\n        break;\n        \n      case 'track-stop':\n        const stopPayload = message.payload as TrackStopPayload;\n        this.playerEngine.handleStop(stopPayload.trackId);\n        break;\n        \n      case 'track-seek':\n        const seekPayload = message.payload as TrackSeekPayload;\n        this.playerEngine.handleSeek(\n          seekPayload.trackId, \n          seekPayload.time, \n          seekPayload.isPlaying,\n          seekPayload.seekTimestamp\n        );\n        break;\n        \n      case 'track-volume':\n        const volPayload = message.payload as TrackVolumePayload;\n        this.playerEngine.handleTrackVolume(volPayload.trackId, volPayload.volume);\n        break;\n        \n      case 'track-loop':\n        const loopPayload = message.payload as TrackLoopPayload;\n        this.playerEngine.handleTrackLoop(loopPayload.trackId, loopPayload.loop);\n        break;\n        \n      case 'channel-volume':\n        const chVolPayload = message.payload as ChannelVolumePayload;\n        this.playerEngine.setGMVolume(chVolPayload.channel, chVolPayload.volume);\n        break;\n        \n      case 'stop-all':\n        this.playerEngine.stopAll();\n        break;\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // GM Broadcast Methods\n  // ─────────────────────────────────────────────────────────────\n\n  private send(type: SocketMessageType, payload: unknown, targetUserId?: string): void {\n    if (!this.socket) return;\n\n    const message: SocketMessage = {\n      type,\n      payload,\n      senderId: game.user?.id ?? '',\n      timestamp: getServerTime()\n    };\n\n    if (targetUserId) {\n      this.socket.emit(SOCKET_NAME, message, { recipients: [targetUserId] });\n    } else {\n      this.socket.emit(SOCKET_NAME, message);\n    }\n\n    Logger.debug(`Sent: ${type}`, payload);\n  }\n\n  private getCurrentSyncState(): SyncStatePayload {\n    if (!this.gmEngine) {\n      return { tracks: [], channelVolumes: { master: 1, music: 1, ambience: 1, sfx: 1 } };\n    }\n    \n    const now = getServerTime();\n    const tracks: SyncTrackState[] = [];\n    \n    for (const player of this.gmEngine.getAllTracks()) {\n      const state = player.getState();\n      tracks.push({\n        id: state.id,\n        url: state.url,\n        group: state.group,\n        volume: state.volume,\n        loop: state.loop,\n        isPlaying: state.playbackState === 'playing',\n        currentTime: player.getCurrentTime(),\n        startTimestamp: now\n      });\n    }\n    \n    return {\n      tracks,\n      channelVolumes: this.gmEngine.volumes\n    };\n  }\n\n  private broadcastSyncStart(): void {\n    const state = this.getCurrentSyncState();\n    this.send('sync-start', state);\n  }\n\n  private broadcastSyncStop(): void {\n    this.send('sync-stop', {});\n  }\n\n  private sendStateTo(userId: string): void {\n    const state = this.getCurrentSyncState();\n    this.send('sync-state', state, userId);\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // GM Actions (called when GM interacts with mixer)\n  // ─────────────────────────────────────────────────────────────\n\n  broadcastTrackPlay(trackId: string, offset: number): void {\n    if (!this._syncEnabled || !this.gmEngine) return;\n    \n    const player = this.gmEngine.getTrack(trackId);\n    if (!player) return;\n    \n    const payload: TrackPlayPayload = {\n      trackId,\n      url: player.url,\n      group: player.group,\n      volume: player.volume,\n      loop: player.loop,\n      offset,\n      startTimestamp: getServerTime()\n    };\n    \n    this.send('track-play', payload);\n  }\n\n  broadcastTrackPause(trackId: string, pausedAt: number): void {\n    if (!this._syncEnabled) return;\n    \n    const payload: TrackPausePayload = { trackId, pausedAt };\n    this.send('track-pause', payload);\n  }\n\n  broadcastTrackStop(trackId: string): void {\n    if (!this._syncEnabled) return;\n    \n    const payload: TrackStopPayload = { trackId };\n    this.send('track-stop', payload);\n  }\n\n  broadcastTrackSeek(trackId: string, time: number, isPlaying: boolean): void {\n    if (!this._syncEnabled) return;\n    \n    const payload: TrackSeekPayload = {\n      trackId,\n      time,\n      isPlaying,\n      seekTimestamp: getServerTime()\n    };\n    this.send('track-seek', payload);\n  }\n\n  broadcastTrackVolume(trackId: string, volume: number): void {\n    if (!this._syncEnabled) return;\n    \n    const payload: TrackVolumePayload = { trackId, volume };\n    this.send('track-volume', payload);\n  }\n\n  broadcastTrackLoop(trackId: string, loop: boolean): void {\n    if (!this._syncEnabled) return;\n    \n    const payload: TrackLoopPayload = { trackId, loop };\n    this.send('track-loop', payload);\n  }\n\n  broadcastChannelVolume(channel: TrackGroup | 'master', volume: number): void {\n    if (!this._syncEnabled) return;\n    \n    const payload: ChannelVolumePayload = { channel, volume };\n    this.send('channel-volume', payload);\n  }\n\n  broadcastStopAll(): void {\n    if (!this._syncEnabled) return;\n    this.send('stop-all', {});\n  }\n\n  dispose(): void {\n    this.socket?.off(SOCKET_NAME);\n  }\n}","export function throttle<T extends (...args: Parameters<T>) => void>(\n  fn: T,\n  delay: number\n): (...args: Parameters<T>) => void {\n  let lastCall = 0;\n  let timeoutId: ReturnType<typeof setTimeout> | null = null;\n  \n  return function (this: ThisParameterType<T>, ...args: Parameters<T>) {\n    const now = Date.now();\n    const remaining = delay - (now - lastCall);\n    \n    if (remaining <= 0) {\n      if (timeoutId) {\n        clearTimeout(timeoutId);\n        timeoutId = null;\n      }\n      lastCall = now;\n      fn.apply(this, args);\n    } else if (!timeoutId) {\n      timeoutId = setTimeout(() => {\n        lastCall = Date.now();\n        timeoutId = null;\n        fn.apply(this, args);\n      }, remaining);\n    }\n  };\n}\n\nexport function debounce<T extends (...args: Parameters<T>) => void>(\n  fn: T,\n  delay: number\n): (...args: Parameters<T>) => void {\n  let timeoutId: ReturnType<typeof setTimeout> | null = null;\n  \n  return function (this: ThisParameterType<T>, ...args: Parameters<T>) {\n    if (timeoutId) {\n      clearTimeout(timeoutId);\n    }\n    timeoutId = setTimeout(() => {\n      fn.apply(this, args);\n    }, delay);\n  };\n}","import type { TrackGroup } from '@t/audio';\nimport { AudioEngine } from '@core/AudioEngine';\nimport { SocketManager } from '@sync/SocketManager';\nimport { StreamingPlayer } from '@core/StreamingPlayer';\nimport { Logger } from '@utils/logger';\nimport { formatTime } from '@utils/time';\nimport { throttle } from '@utils/throttle';\nimport { generateUUID } from '@utils/uuid';\n\nconst MODULE_ID = 'advanced-sound-engine';\n\nfunction getMaxSimultaneous(): number {\n  return (game.settings.get(MODULE_ID, 'maxSimultaneousTracks') as number) || 8;\n}\n\ninterface MixerData {\n  tracks: TrackViewData[];\n  volumes: {\n    master: number;\n    music: number;\n    ambience: number;\n    sfx: number;\n  };\n  playingCount: number;\n  maxSimultaneous: number;\n  syncEnabled: boolean;\n}\n\ninterface TrackViewData {\n  id: string;\n  name: string;\n  group: TrackGroup;\n  isPlaying: boolean;\n  isPaused: boolean;\n  isStopped: boolean;\n  isLoading: boolean;\n  volume: number;\n  volumePercent: number;\n  loop: boolean;\n  currentTime: number;\n  currentTimeFormatted: string;\n  duration: number;\n  durationFormatted: string;\n  progress: number;\n}\n\nexport class SoundMixerApp extends Application {\n  private engine: AudioEngine;\n  private socket: SocketManager;\n  private updateInterval: ReturnType<typeof setInterval> | null = null;\n\n  static override get defaultOptions(): ApplicationOptions {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      id: 'ase-sound-mixer',\n      title: 'Sound Mixer (GM)',\n      template: `modules/${MODULE_ID}/templates/mixer.hbs`,\n      classes: ['ase-mixer'],\n      width: 550,\n      height: 'auto',\n      resizable: true,\n      minimizable: true,\n      popOut: true\n    }) as ApplicationOptions;\n  }\n\n  constructor(engine: AudioEngine, socket: SocketManager, options?: Partial<ApplicationOptions>) {\n    super(options);\n    this.engine = engine;\n    this.socket = socket;\n  }\n\n  override getData(): MixerData {\n    const tracks = this.engine.getAllTracks().map(player => this.getTrackViewData(player));\n    const volumes = this.engine.volumes;\n    const playingCount = tracks.filter(t => t.isPlaying).length;\n\n    return {\n      tracks,\n      volumes: {\n        master: Math.round(volumes.master * 100),\n        music: Math.round(volumes.music * 100),\n        ambience: Math.round(volumes.ambience * 100),\n        sfx: Math.round(volumes.sfx * 100)\n      },\n      playingCount,\n      maxSimultaneous: getMaxSimultaneous(),\n      syncEnabled: this.socket.syncEnabled\n    };\n  }\n\n  private getTrackViewData(player: StreamingPlayer): TrackViewData {\n    const state = player.getState();\n    const currentTime = player.getCurrentTime();\n    const duration = player.getDuration();\n    \n    return {\n      id: state.id,\n      name: this.extractFileName(state.url),\n      group: state.group,\n      isPlaying: state.playbackState === 'playing',\n      isPaused: state.playbackState === 'paused',\n      isStopped: state.playbackState === 'stopped',\n      isLoading: state.playbackState === 'loading',\n      volume: state.volume,\n      volumePercent: Math.round(state.volume * 100),\n      loop: state.loop,\n      currentTime,\n      currentTimeFormatted: formatTime(currentTime),\n      duration,\n      durationFormatted: formatTime(duration),\n      progress: duration > 0 ? (currentTime / duration) * 100 : 0\n    };\n  }\n\n  private extractFileName(url: string): string {\n    if (!url) return 'Unknown';\n    try {\n      const decoded = decodeURIComponent(url);\n      const parts = decoded.split('/');\n      const fileName = parts[parts.length - 1];\n      return fileName.replace(/\\.[^.]+$/, '');\n    } catch {\n      const parts = url.split('/');\n      const fileName = parts[parts.length - 1];\n      return fileName.replace(/\\.[^.]+$/, '');\n    }\n  }\n\n  override activateListeners(html: JQuery): void {\n    super.activateListeners(html);\n\n    // Sync toggle\n    html.find('#ase-sync-toggle').on('change', (event) => {\n      const enabled = (event.target as HTMLInputElement).checked;\n      this.socket.setSyncEnabled(enabled);\n      this.updateSyncIndicator(html, enabled);\n    });\n\n    // Channel volume sliders\n    const throttledChannelVolume = throttle((channel: string, value: number) => {\n      if (channel === 'master') {\n        this.engine.setMasterVolume(value);\n        this.socket.broadcastChannelVolume('master', value);\n      } else {\n        this.engine.setChannelVolume(channel as TrackGroup, value);\n        this.socket.broadcastChannelVolume(channel as TrackGroup, value);\n      }\n    }, 50);\n\n    html.find('.ase-channel-slider').on('input', (event) => {\n      const channel = $(event.currentTarget).data('channel') as string;\n      const value = parseFloat((event.target as HTMLInputElement).value) / 100;\n      throttledChannelVolume(channel, value);\n      $(event.currentTarget).siblings('.ase-channel-value').text(`${Math.round(value * 100)}%`);\n    });\n\n    // Add track\n    html.find('#ase-add-track').on('click', () => this.onAddTrack());\n\n    // Track controls\n    const tracks = html.find('.ase-tracks');\n    \n    tracks.on('click', '.ase-btn-play', (event) => {\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\n      this.onPlayTrack(trackId);\n    });\n\n    tracks.on('click', '.ase-btn-pause', (event) => {\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\n      this.onPauseTrack(trackId);\n    });\n\n    tracks.on('click', '.ase-btn-stop', (event) => {\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\n      this.onStopTrack(trackId);\n    });\n\n    tracks.on('click', '.ase-btn-remove', (event) => {\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\n      this.onRemoveTrack(trackId);\n    });\n\n    tracks.on('change', '.ase-loop-toggle', (event) => {\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\n      const loop = (event.target as HTMLInputElement).checked;\n      this.engine.setTrackLoop(trackId, loop);\n      this.socket.broadcastTrackLoop(trackId, loop);\n    });\n\n    tracks.on('change', '.ase-channel-select', (event) => {\n      const trackId = $(event.currentTarget).data('track-id') as string;\n      const channel = (event.target as HTMLSelectElement).value as TrackGroup;\n      this.engine.setTrackChannel(trackId, channel);\n    });\n\n    // Volume slider\n    const throttledVolume = throttle((trackId: string, value: number) => {\n      this.engine.setTrackVolume(trackId, value);\n      this.socket.broadcastTrackVolume(trackId, value);\n    }, 50);\n\n    tracks.on('input', '.ase-volume-slider', (event) => {\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\n      const value = parseFloat((event.target as HTMLInputElement).value) / 100;\n      throttledVolume(trackId, value);\n      $(event.currentTarget).siblings('.ase-volume-value').text(`${Math.round(value * 100)}%`);\n    });\n\n    // Seek slider\n    const throttledSeek = throttle((trackId: string, time: number) => {\n      const player = this.engine.getTrack(trackId);\n      const isPlaying = player?.state === 'playing';\n      this.engine.seekTrack(trackId, time);\n      this.socket.broadcastTrackSeek(trackId, time, isPlaying ?? false);\n    }, 100);\n\n    tracks.on('input', '.ase-seek-slider', (event) => {\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\n      const player = this.engine.getTrack(trackId);\n      if (player) {\n        const percent = parseFloat((event.target as HTMLInputElement).value);\n        const time = (percent / 100) * player.getDuration();\n        throttledSeek(trackId, time);\n      }\n    });\n\n    // Stop all\n    html.find('#ase-stop-all').on('click', () => {\n      this.engine.stopAll();\n      this.socket.broadcastStopAll();\n      this.render();\n    });\n\n    this.startUpdates();\n  }\n\n  private updateSyncIndicator(html: JQuery, enabled: boolean): void {\n    const indicator = html.find('.ase-sync-status');\n    indicator.toggleClass('is-active', enabled);\n    indicator.find('span').text(enabled ? 'SYNC ON' : 'SYNC OFF');\n  }\n\n  private startUpdates(): void {\n    this.stopUpdates();\n    this.updateInterval = setInterval(() => {\n      this.updateTrackDisplays();\n    }, 250);\n  }\n\n  private stopUpdates(): void {\n    if (this.updateInterval) {\n      clearInterval(this.updateInterval);\n      this.updateInterval = null;\n    }\n  }\n\n  private updateTrackDisplays(): void {\n    const html = this.element;\n    if (!html || !html.length) return;\n\n    let playingCount = 0;\n\n    for (const player of this.engine.getAllTracks()) {\n      const trackEl = html.find(`.ase-track[data-track-id=\"${player.id}\"]`);\n      if (!trackEl.length) continue;\n\n      const currentTime = player.getCurrentTime();\n      const duration = player.getDuration();\n      const progress = duration > 0 ? (currentTime / duration) * 100 : 0;\n      const state = player.state;\n\n      if (state === 'playing') playingCount++;\n\n      trackEl.find('.ase-time-current').text(formatTime(currentTime));\n      \n      const seekSlider = trackEl.find('.ase-seek-slider');\n      if (!seekSlider.is(':active')) {\n        seekSlider.val(progress);\n      }\n\n      trackEl.removeClass('is-playing is-paused is-stopped is-loading');\n      trackEl.addClass(`is-${state}`);\n      \n      trackEl.find('.ase-btn-play').prop('disabled', state === 'playing' || state === 'loading');\n      trackEl.find('.ase-btn-pause').prop('disabled', state !== 'playing');\n      trackEl.find('.ase-btn-stop').prop('disabled', state === 'stopped');\n    }\n\n    const totalTracks = this.engine.getAllTracks().length;\n    html.find('.ase-track-count').text(`${playingCount}/${totalTracks} playing`);\n  }\n\n  private async onAddTrack(): Promise<void> {\n    const fp = new FilePicker({\n      type: 'audio',\n      current: '',\n      callback: async (path: string) => {\n        await this.addTrackFromPath(path);\n      }\n    });\n    fp.render(true);\n  }\n\n  async addTrackFromPath(path: string, group: TrackGroup = 'music'): Promise<void> {\n    const trackId = generateUUID();\n\n    try {\n      await this.engine.createTrack({\n        id: trackId,\n        url: path,\n        group,\n        volume: 1,\n        loop: false\n      });\n\n      this.render();\n      ui.notifications?.info(`Added: ${this.extractFileName(path)}`);\n\n    } catch (error) {\n      Logger.error('Failed to add track:', error);\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n      ui.notifications?.error(`Failed to load: ${errorMessage}`);\n    }\n  }\n\n  private async onPlayTrack(trackId: string): Promise<void> {\n    const player = this.engine.getTrack(trackId);\n    if (!player) return;\n\n    const offset = player.state === 'paused' ? player.getCurrentTime() : 0;\n    await this.engine.playTrack(trackId, offset);\n    this.socket.broadcastTrackPlay(trackId, offset);\n  }\n\n  private onPauseTrack(trackId: string): void {\n    const player = this.engine.getTrack(trackId);\n    if (!player) return;\n    \n    const pausedAt = player.getCurrentTime();\n    this.engine.pauseTrack(trackId);\n    this.socket.broadcastTrackPause(trackId, pausedAt);\n  }\n\n  private onStopTrack(trackId: string): void {\n    this.engine.stopTrack(trackId);\n    this.socket.broadcastTrackStop(trackId);\n  }\n\n  private onRemoveTrack(trackId: string): void {\n    this.engine.removeTrack(trackId);\n    this.render();\n  }\n\n  override close(options?: Application.CloseOptions): Promise<void> {\n    this.stopUpdates();\n    return super.close(options);\n  }\n}","import { PlayerAudioEngine } from '@core/PlayerAudioEngine';\nimport { Logger } from '@utils/logger';\n\nconst MODULE_ID = 'advanced-sound-engine';\n\nexport class PlayerVolumePanel extends Application {\n  private engine: PlayerAudioEngine;\n\n  static override get defaultOptions(): ApplicationOptions {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      id: 'ase-player-volume',\n      title: 'Sound Volume',\n      template: `modules/${MODULE_ID}/templates/player-volume.hbs`,\n      classes: ['ase-player-panel'],\n      width: 200,\n      height: 'auto',\n      resizable: false,\n      minimizable: true,\n      popOut: true\n    }) as ApplicationOptions;\n  }\n\n  constructor(engine: PlayerAudioEngine, options?: Partial<ApplicationOptions>) {\n    super(options);\n    this.engine = engine;\n  }\n\n  override getData() {\n    return {\n      volume: Math.round(this.engine.localVolume * 100)\n    };\n  }\n\n  override activateListeners(html: JQuery): void {\n    super.activateListeners(html);\n\n    html.find('.ase-volume-slider').on('input', (event) => {\n      const value = parseFloat((event.target as HTMLInputElement).value) / 100;\n      this.engine.setLocalVolume(value);\n      html.find('.ase-volume-value').text(`${Math.round(value * 100)}%`);\n      \n      // Save preference\n      this.saveVolume(value);\n    });\n  }\n\n  private saveVolume(value: number): void {\n    localStorage.setItem(`${MODULE_ID}-player-volume`, String(value));\n  }\n\n  static loadSavedVolume(): number {\n    const saved = localStorage.getItem(`${MODULE_ID}-player-volume`);\n    return saved ? parseFloat(saved) : 1;\n  }\n}","import type { LibraryItem } from '@t/library';\nimport type { TrackGroup } from '@t/audio';\nimport { LibraryManager } from '@lib/LibraryManager';\nimport { Logger } from '@utils/logger';\nimport { formatTime } from '@utils/time';\n\nconst MODULE_ID = 'advanced-sound-engine';\n\ninterface LibraryData {\n  items: LibraryItemViewData[];\n  stats: {\n    total: number;\n    favorites: number;\n  };\n}\n\ninterface LibraryItemViewData {\n  id: string;\n  name: string;\n  url: string;\n  duration: string;\n  durationSeconds: number;\n  tags: string[];\n  favorite: boolean;\n  group: string;\n}\n\nexport class LocalLibraryApp extends Application {\n  private library: LibraryManager;\n\n  static override get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      id: 'local-library',\n      template: 'modules/advanced-sound-engine/templates/library.hbs',\n      title: 'Sound Library',\n      width: 1100,\n      height: 700,\n      classes: ['advanced-sound-engine', 'library'],\n      resizable: true,\n      tabs: [{ navSelector: '.tabs', contentSelector: '.content', initial: 'library' }]\n    });\n  }\n\n  constructor(library: LibraryManager, options = {}) {\n    super(options);\n    this.library = library;\n  }\n\n  override getData(): LibraryData {\n    const items = this.library.getAllItems();\n    const stats = this.library.getStats();\n\n    return {\n      items: items.map(item => this.getItemViewData(item)),\n      stats: {\n        total: stats.totalItems,\n        favorites: stats.favoriteItems\n      }\n    };\n  }\n\n  private getItemViewData(item: LibraryItem): LibraryItemViewData {\n    return {\n      id: item.id,\n      name: item.name,\n      url: item.url,\n      duration: formatTime(item.duration),\n      durationSeconds: item.duration,\n      tags: item.tags,\n      favorite: item.favorite,\n      group: this.inferGroupFromTags(item.tags)\n    };\n  }\n\n  private inferGroupFromTags(tags: string[]): string {\n    // Try to infer group from tags if possible\n    const lowerTags = tags.map(t => t.toLowerCase());\n    if (lowerTags.some(t => t.includes('music'))) return 'music';\n    if (lowerTags.some(t => t.includes('ambient') || t.includes('ambience'))) return 'ambience';\n    if (lowerTags.some(t => t.includes('sfx') || t.includes('effect'))) return 'sfx';\n    return 'music'; // default\n  }\n\n  override activateListeners(html: JQuery): void {\n    super.activateListeners(html);\n\n    // Add track button\n    html.find('[data-action=\"add-track\"]').on('click', this.onAddTrack.bind(this));\n\n    // Track actions\n    html.find('[data-action=\"toggle-favorite\"]').on('click', this.onToggleFavorite.bind(this));\n    html.find('[data-action=\"delete-track\"]').on('click', this.onDeleteTrack.bind(this));\n\n    Logger.debug('LocalLibraryApp listeners activated');\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Event Handlers\n  // ─────────────────────────────────────────────────────────────\n\n  private async onAddTrack(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n\n    const fp = new FilePicker({\n      type: 'audio',\n      callback: async (path: string) => {\n        await this.addTrackFromPath(path);\n      }\n    });\n    fp.render(true);\n  }\n\n  private async addTrackFromPath(path: string, group: TrackGroup = 'music'): Promise<void> {\n    try {\n      const item = await this.library.addItem(path, undefined, group);\n      this.render();\n      ui.notifications?.info(`Added to library: ${item.name}`);\n    } catch (error) {\n      Logger.error('Failed to add track to library:', error);\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n      ui.notifications?.error(`Failed to add track: ${errorMessage}`);\n    }\n  }\n\n  private async onToggleFavorite(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n    const itemId = $(event.currentTarget).closest('[data-item-id]').data('item-id') as string;\n\n    try {\n      const isFavorite = this.library.toggleFavorite(itemId);\n      this.render();\n      ui.notifications?.info(isFavorite ? 'Added to favorites' : 'Removed from favorites');\n    } catch (error) {\n      Logger.error('Failed to toggle favorite:', error);\n      ui.notifications?.error('Failed to update favorite status');\n    }\n  }\n\n  private async onDeleteTrack(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n    const itemId = $(event.currentTarget).closest('[data-item-id]').data('item-id') as string;\n    const item = this.library.getItem(itemId);\n\n    if (!item) {\n      ui.notifications?.error('Track not found');\n      return;\n    }\n\n    const confirmed = await Dialog.confirm({\n      title: 'Delete Track',\n      content: `<p>Are you sure you want to delete <strong>${item.name}</strong> from the library?</p>\n                <p class=\"notification warning\">This will remove it from all playlists and favorites.</p>`,\n      yes: () => true,\n      no: () => false,\n      defaultYes: false\n    });\n\n    if (confirmed) {\n      try {\n        this.library.removeItem(itemId);\n        this.render();\n        ui.notifications?.info(`Deleted: ${item.name}`);\n      } catch (error) {\n        Logger.error('Failed to delete track:', error);\n        ui.notifications?.error('Failed to delete track');\n      }\n    }\n  }\n}\n","import type { LibraryItem, LibraryState } from '@t/library';\nimport type { TrackGroup } from '@t/audio';\nimport { generateUUID } from '@utils/uuid';\nimport { validateAudioFile } from '@utils/audio-validation';\nimport { Logger } from '@utils/logger';\nimport { debounce } from '@utils/throttle';\n\nconst MODULE_ID = 'advanced-sound-engine';\nconst LIBRARY_VERSION = 1;\n\nexport class LibraryManager {\n  private items: Map<string, LibraryItem> = new Map();\n  private saveScheduled = false;\n\n  private debouncedSave = debounce(() => {\n    this.saveToSettings();\n  }, 500);\n\n  constructor() {\n    this.loadFromSettings();\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // CRUD Operations\n  // ─────────────────────────────────────────────────────────────\n\n  /**\n   * Add new item to library\n   */\n  async addItem(url: string, name?: string, group: TrackGroup = 'music'): Promise<LibraryItem> {\n    // Validate audio format\n    const validation = validateAudioFile(url);\n    if (!validation.valid) {\n      throw new Error(validation.error || 'Invalid audio file');\n    }\n\n    // Generate name from filename if not provided\n    const itemName = name || this.extractNameFromUrl(url);\n\n    // Check for duplicates by URL\n    const existingByUrl = this.findByUrl(url);\n    if (existingByUrl) {\n      throw new Error(`Track with this URL already exists: ${existingByUrl.name}`);\n    }\n\n    // Check for duplicates by name\n    const existingByName = this.findByName(itemName);\n    if (existingByName) {\n      throw new Error(`Track with name \"${itemName}\" already exists in library`);\n    }\n\n    const now = Date.now();\n    const item: LibraryItem = {\n      id: generateUUID(),\n      url,\n      name: itemName,\n      tags: [],\n      duration: 0,\n      favorite: false,\n      addedAt: now,\n      updatedAt: now\n    };\n\n    this.items.set(item.id, item);\n    this.scheduleSave();\n\n    Logger.info(`Library item added: ${item.name} (${item.id})`);\n    return item;\n  }\n\n  /**\n   * Update existing item\n   */\n  updateItem(id: string, updates: Partial<LibraryItem>): LibraryItem {\n    const item = this.items.get(id);\n    if (!item) {\n      throw new Error(`Library item not found: ${id}`);\n    }\n\n    // Validate name uniqueness if changing name\n    if (updates.name && updates.name !== item.name) {\n      const existingByName = this.findByName(updates.name);\n      if (existingByName && existingByName.id !== id) {\n        throw new Error(`Track with name \"${updates.name}\" already exists`);\n      }\n    }\n\n    // Validate URL uniqueness if changing URL\n    if (updates.url && updates.url !== item.url) {\n      const validation = validateAudioFile(updates.url);\n      if (!validation.valid) {\n        throw new Error(validation.error || 'Invalid audio file');\n      }\n\n      const existingByUrl = this.findByUrl(updates.url);\n      if (existingByUrl && existingByUrl.id !== id) {\n        throw new Error(`Track with this URL already exists: ${existingByUrl.name}`);\n      }\n    }\n\n    // Prevent ID change\n    delete updates.id;\n\n    // Update item\n    const updated = {\n      ...item,\n      ...updates,\n      updatedAt: Date.now()\n    };\n\n    this.items.set(id, updated);\n    this.scheduleSave();\n\n    Logger.info(`Library item updated: ${updated.name}`);\n    return updated;\n  }\n\n  /**\n   * Remove item from library\n   */\n  removeItem(id: string): void {\n    const item = this.items.get(id);\n    if (!item) {\n      throw new Error(`Library item not found: ${id}`);\n    }\n\n    this.items.delete(id);\n    this.scheduleSave();\n\n    Logger.info(`Library item removed: ${item.name}`);\n  }\n\n  /**\n   * Get item by ID\n   */\n  getItem(id: string): LibraryItem | undefined {\n    return this.items.get(id);\n  }\n\n  /**\n   * Get all items\n   */\n  getAllItems(): LibraryItem[] {\n    return Array.from(this.items.values());\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Search & Filter\n  // ─────────────────────────────────────────────────────────────\n\n  /**\n   * Find item by URL\n   */\n  findByUrl(url: string): LibraryItem | undefined {\n    return Array.from(this.items.values()).find(item => item.url === url);\n  }\n\n  /**\n   * Find item by name\n   */\n  findByName(name: string): LibraryItem | undefined {\n    return Array.from(this.items.values()).find(item => item.name === name);\n  }\n\n  /**\n   * Search items by query\n   */\n  searchByName(query: string): LibraryItem[] {\n    const lowerQuery = query.toLowerCase();\n    return this.getAllItems().filter(item =>\n      item.name.toLowerCase().includes(lowerQuery)\n    );\n  }\n\n  /**\n   * Filter items by tags (OR logic)\n   */\n  filterByTags(tags: string[]): LibraryItem[] {\n    if (tags.length === 0) return this.getAllItems();\n\n    return this.getAllItems().filter(item =>\n      item.tags.some(tag => tags.includes(tag))\n    );\n  }\n\n  /**\n   * Get favorite items\n   */\n  getFavorites(): LibraryItem[] {\n    return this.getAllItems().filter(item => item.favorite);\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Tags Management\n  // ─────────────────────────────────────────────────────────────\n\n  /**\n   * Get all unique tags\n   */\n  getAllTags(): string[] {\n    const tagSet = new Set<string>();\n    this.items.forEach(item => {\n      item.tags.forEach(tag => tagSet.add(tag));\n    });\n    return Array.from(tagSet).sort();\n  }\n\n  /**\n   * Add tag to item\n   */\n  addTagToItem(itemId: string, tag: string): void {\n    const item = this.getItem(itemId);\n    if (!item) {\n      throw new Error(`Library item not found: ${itemId}`);\n    }\n\n    if (!item.tags.includes(tag)) {\n      item.tags.push(tag);\n      item.updatedAt = Date.now();\n      this.scheduleSave();\n    }\n  }\n\n  /**\n   * Remove tag from item\n   */\n  removeTagFromItem(itemId: string, tag: string): void {\n    const item = this.getItem(itemId);\n    if (!item) {\n      throw new Error(`Library item not found: ${itemId}`);\n    }\n\n    const index = item.tags.indexOf(tag);\n    if (index !== -1) {\n      item.tags.splice(index, 1);\n      item.updatedAt = Date.now();\n      this.scheduleSave();\n    }\n  }\n\n  /**\n   * Rename tag globally\n   */\n  renameTag(oldTag: string, newTag: string): number {\n    let count = 0;\n    this.items.forEach(item => {\n      const index = item.tags.indexOf(oldTag);\n      if (index !== -1) {\n        item.tags[index] = newTag;\n        item.updatedAt = Date.now();\n        count++;\n      }\n    });\n\n    if (count > 0) {\n      this.scheduleSave();\n      Logger.info(`Tag renamed: \"${oldTag}\" → \"${newTag}\" (${count} items)`);\n    }\n\n    return count;\n  }\n\n  /**\n   * Delete tag globally\n   */\n  deleteTag(tag: string): number {\n    let count = 0;\n    this.items.forEach(item => {\n      const index = item.tags.indexOf(tag);\n      if (index !== -1) {\n        item.tags.splice(index, 1);\n        item.updatedAt = Date.now();\n        count++;\n      }\n    });\n\n    if (count > 0) {\n      this.scheduleSave();\n      Logger.info(`Tag deleted: \"${tag}\" (${count} items)`);\n    }\n\n    return count;\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Favorites\n  // ─────────────────────────────────────────────────────────────\n\n  /**\n   * Toggle favorite status\n   */\n  toggleFavorite(itemId: string): boolean {\n    const item = this.getItem(itemId);\n    if (!item) {\n      throw new Error(`Library item not found: ${itemId}`);\n    }\n\n    item.favorite = !item.favorite;\n    item.updatedAt = Date.now();\n    this.scheduleSave();\n\n    return item.favorite;\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Persistence\n  // ─────────────────────────────────────────────────────────────\n\n  private loadFromSettings(): void {\n    try {\n      const saved = game.settings.get(MODULE_ID, 'libraryState') as string;\n      if (!saved) {\n        Logger.info('No saved library state, starting fresh');\n        return;\n      }\n\n      const state: LibraryState = JSON.parse(saved);\n\n      // Migrate if needed\n      if (state.version !== LIBRARY_VERSION) {\n        Logger.warn(`Library version mismatch: ${state.version} → ${LIBRARY_VERSION}`);\n        // Add migration logic here if needed\n      }\n\n      // Load items\n      this.items.clear();\n      Object.values(state.items).forEach(item => {\n        this.items.set(item.id, item);\n      });\n\n      Logger.info(`Library loaded: ${this.items.size} items`);\n    } catch (error) {\n      Logger.error('Failed to load library state:', error);\n    }\n  }\n\n  private saveToSettings(): void {\n    try {\n      const state: LibraryState = {\n        items: Object.fromEntries(this.items),\n        playlists: {},\n        version: LIBRARY_VERSION,\n        lastModified: Date.now()\n      };\n\n      game.settings.set(MODULE_ID, 'libraryState', JSON.stringify(state));\n      this.saveScheduled = false;\n\n      Logger.debug(`Library saved: ${this.items.size} items`);\n    } catch (error) {\n      Logger.error('Failed to save library state:', error);\n    }\n  }\n\n  private scheduleSave(): void {\n    this.debouncedSave();\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Utilities\n  // ─────────────────────────────────────────────────────────────\n\n  private extractNameFromUrl(url: string): string {\n    try {\n      const decoded = decodeURIComponent(url);\n      const parts = decoded.split('/');\n      const filename = parts[parts.length - 1];\n      return filename.replace(/\\.[^.]+$/, ''); // Remove extension\n    } catch {\n      return 'Unknown Track';\n    }\n  }\n\n  /**\n   * Get library statistics\n   */\n  getStats() {\n    const items = this.getAllItems();\n    return {\n      totalItems: items.length,\n      favoriteItems: items.filter(i => i.favorite).length,\n      totalDuration: items.reduce((sum, i) => sum + i.duration, 0),\n      tagCount: this.getAllTags().length\n    };\n  }\n\n  /**\n   * Clear all library data\n   */\n  clear(): void {\n    this.items.clear();\n    this.scheduleSave();\n    Logger.warn('Library cleared');\n  }\n\n  /**\n   * Dispose resources\n   */\n  dispose(): void {\n    // Save immediately before disposing\n    if (this.saveScheduled) {\n      this.saveToSettings();\n    }\n  }\n}\n","import '../styles/sound-engine.scss';\nimport { AudioEngine } from '@core/AudioEngine';\nimport { PlayerAudioEngine } from '@core/PlayerAudioEngine';\nimport { SocketManager } from '@sync/SocketManager';\nimport { SoundMixerApp } from '@ui/SoundMixerApp';\nimport { PlayerVolumePanel } from '@ui/PlayerVolumePanel';\nimport { LocalLibraryApp } from '@ui/LocalLibraryApp';\nimport { LibraryManager } from '@lib/LibraryManager';\nimport { Logger } from '@utils/logger';\n\nconst MODULE_ID = 'advanced-sound-engine';\n\n// GM\nlet gmEngine: AudioEngine | null = null;\nlet mixerApp: SoundMixerApp | null = null;\nlet libraryApp: LocalLibraryApp | null = null;\nlet libraryManager: LibraryManager | null = null;\n\n// Player\nlet playerEngine: PlayerAudioEngine | null = null;\nlet volumePanel: PlayerVolumePanel | null = null;\n\n// Shared\nlet socketManager: SocketManager | null = null;\n\ndeclare global {\n  interface Window {\n    ASE: {\n      isGM: boolean;\n      openPanel: () => void;\n      openLibrary?: () => void;\n      engine?: AudioEngine | PlayerAudioEngine;\n      socket?: SocketManager;\n      library?: LibraryManager;\n    };\n  }\n}\n\n// ─────────────────────────────────────────────────────────────\n// Control Button (в начале файла, после импортов)\n// ─────────────────────────────────────────────────────────────\n\nHooks.on('getSceneControlButtons', (controls: Record<string, any>) => {\n  console.log('ASE: Hook fired', controls);\n\n  const isGM = game.user?.isGM ?? false;\n\n  const tools: Record<string, any> = {\n    'open-panel': {\n      name: 'open-panel',\n      title: isGM ? 'Sound Mixer' : 'Sound Volume',\n      icon: isGM ? 'fas fa-sliders-h' : 'fas fa-volume-up',\n      button: true,\n      onClick: () => window.ASE?.openPanel()\n    }\n  };\n\n  // Add library button for GM\n  if (isGM) {\n    tools['open-library'] = {\n      name: 'open-library',\n      title: 'Sound Library',\n      icon: 'fas fa-book',\n      button: true,\n      onClick: () => window.ASE?.openLibrary?.()\n    };\n  }\n\n  controls['advanced-sound-engine'] = {\n    name: 'advanced-sound-engine',\n    title: isGM ? 'Advanced Sound Engine' : 'Sound Volume',\n    icon: isGM ? 'fas fa-sliders-h' : 'fas fa-volume-up',\n    visible: true,\n    tools\n  };\n});\n// ─────────────────────────────────────────────────────────────\n// Initialization\n// ─────────────────────────────────────────────────────────────\n\nHooks.once('init', () => {\n  Logger.info('Initializing Advanced Sound Engine...');\n  registerSettings();\n});\n\nHooks.once('ready', async () => {\n  const isGM = game.user?.isGM ?? false;\n  Logger.info(`Starting Advanced Sound Engine (${isGM ? 'GM' : 'Player'})...`);\n  \n  socketManager = new SocketManager();\n  \n  if (isGM) {\n    await initializeGM();\n  } else {\n    await initializePlayer();\n  }\n  \n  window.ASE = {\n    isGM,\n    openPanel: isGM ? openMixer : openVolumePanel,\n    openLibrary: isGM ? openLibrary : undefined,\n    engine: isGM ? gmEngine ?? undefined : playerEngine ?? undefined,\n    socket: socketManager ?? undefined,\n    library: isGM ? libraryManager ?? undefined : undefined\n  };\n  \n  setupAutoplayHandler();\n    \n  Logger.info('Advanced Sound Engine ready');\n});\n\nasync function initializeGM(): Promise<void> {\n  libraryManager = new LibraryManager();\n  gmEngine = new AudioEngine();\n  socketManager!.initializeAsGM(gmEngine);\n\n  await gmEngine.loadSavedState();\n}\n\nasync function initializePlayer(): Promise<void> {\n  playerEngine = new PlayerAudioEngine();\n  socketManager!.initializeAsPlayer(playerEngine);\n  \n  // Restore saved local volume\n  const savedVolume = PlayerVolumePanel.loadSavedVolume();\n  playerEngine.setLocalVolume(savedVolume);\n}\n\n// ─────────────────────────────────────────────────────────────\n// Panels\n// ─────────────────────────────────────────────────────────────\n\nfunction openMixer(): void {\n  if (!gmEngine || !socketManager) return;\n  \n  if (mixerApp && mixerApp.rendered) {\n    mixerApp.bringToTop();\n  } else {\n    mixerApp = new SoundMixerApp(gmEngine, socketManager);\n    mixerApp.render(true);\n  }\n}\n\nfunction openVolumePanel(): void {\n  if (!playerEngine) return;\n\n  if (volumePanel && volumePanel.rendered) {\n    volumePanel.bringToTop();\n  } else {\n    volumePanel = new PlayerVolumePanel(playerEngine);\n    volumePanel.render(true);\n  }\n}\n\nfunction openLibrary(): void {\n  if (!libraryManager) return;\n\n  if (libraryApp && libraryApp.rendered) {\n    libraryApp.bringToTop();\n  } else {\n    libraryApp = new LocalLibraryApp(libraryManager);\n    libraryApp.render(true);\n  }\n}\n\n\n\n// ─────────────────────────────────────────────────────────────\n// Autoplay Policy Handler\n// ─────────────────────────────────────────────────────────────\n\nfunction setupAutoplayHandler(): void {\n  const resumeAudio = () => {\n    gmEngine?.resume();\n    playerEngine?.resume();\n  };\n  \n  document.addEventListener('click', resumeAudio, { once: true });\n  document.addEventListener('keydown', resumeAudio, { once: true });\n  \n  Hooks.once('canvasReady', resumeAudio);\n}\n\n// ─────────────────────────────────────────────────────────────\n// Settings\n// ─────────────────────────────────────────────────────────────\n\nfunction registerSettings(): void {\n  game.settings.register(MODULE_ID, 'mixerState', {\n    name: 'Mixer State',\n    hint: 'Internal storage for mixer state',\n    scope: 'world',\n    config: false,\n    type: String,\n    default: ''\n  });\n\n  game.settings.register(MODULE_ID, 'maxSimultaneousTracks', {\n    name: 'Maximum Simultaneous Tracks',\n    hint: 'Maximum number of tracks that can play simultaneously (1-32)',\n    scope: 'world',\n    config: true,\n    type: Number,\n    default: 16,\n    range: {\n      min: 1,\n      max: 32,\n      step: 1\n    }\n  });\n\n  game.settings.register(MODULE_ID, 'libraryState', {\n    name: 'Library State',\n    hint: 'Internal storage for library items and playlists',\n    scope: 'world',\n    config: false,\n    type: String,\n    default: ''\n  });\n}\n\n// ─────────────────────────────────────────────────────────────\n// Cleanup\n// ─────────────────────────────────────────────────────────────\n\nHooks.once('closeGame', () => {\n  mixerApp?.close();\n  libraryApp?.close();\n  volumePanel?.close();\n  socketManager?.dispose();\n  gmEngine?.dispose();\n  playerEngine?.dispose();\n  libraryManager?.dispose();\n});"],"names":["PREFIX","Logger","message","args","_a","StreamingPlayer","id","ctx","channelOutput","group","__publicField","url","resolve","reject","onCanPlay","onError","offset","error","time","safeTime","value","newGroup","newOutput","getServerTime","formatTime","seconds","mins","secs","generateUUID","c","r","SUPPORTED_AUDIO_FORMATS","AUDIO_MIME_TYPES","isValidAudioFormat","extension","getFileExtension","match","getAudioMimeType","validateAudioFile","mimeType","MODULE_ID","getMaxSimultaneous","AudioEngine","state","savedJson","config","trackId","validation","player","maxSimultaneous","playingCount","t","volume","loop","channel","tracks","trackState","stateTrackIds","PlayerAudioEngine","safeValue","volumes","payload","elapsed","adjustedOffset","isPlaying","seekTimestamp","newTrackIds","adjustedTime","SOCKET_NAME","SocketManager","engine","enabled","startPayload","statePayload","playPayload","pausePayload","stopPayload","seekPayload","volPayload","loopPayload","chVolPayload","type","targetUserId","now","userId","pausedAt","throttle","fn","delay","lastCall","timeoutId","remaining","debounce","SoundMixerApp","socket","options","currentTime","duration","parts","html","event","throttledChannelVolume","throttledVolume","throttledSeek","indicator","trackEl","progress","seekSlider","totalTracks","path","_b","errorMessage","PlayerVolumePanel","saved","LocalLibraryApp","library","items","stats","item","tags","lowerTags","itemId","isFavorite","_c","LIBRARY_VERSION","LibraryManager","name","itemName","existingByUrl","updates","existingByName","updated","query","lowerQuery","tag","tagSet","index","oldTag","newTag","count","i","sum","gmEngine","mixerApp","libraryApp","libraryManager","playerEngine","volumePanel","socketManager","controls","isGM","tools","registerSettings","initializeGM","initializePlayer","openMixer","openVolumePanel","openLibrary","setupAutoplayHandler","savedVolume","resumeAudio"],"mappings":";;;AAAA,MAAMA,IAAS,OAEFC,IAAS;AAAA,EACpB,MAAM,CAACC,MAAoBC,MAAoB;AAC7C,YAAQ,IAAI,GAAGH,CAAM,MAAME,CAAO,IAAI,GAAGC,CAAI;AAAA,EAC/C;AAAA,EAEA,MAAM,CAACD,MAAoBC,MAAoB;AAC7C,YAAQ,KAAK,GAAGH,CAAM,MAAME,CAAO,IAAI,GAAGC,CAAI;AAAA,EAChD;AAAA,EAEA,OAAO,CAACD,MAAoBC,MAAoB;AAC9C,YAAQ,MAAM,GAAGH,CAAM,MAAME,CAAO,IAAI,GAAGC,CAAI;AAAA,EACjD;AAAA,EAEA,OAAO,CAACD,MAAoBC,MAAoB;AAflD,QAAAC;AAgBI,KAAIA,IAAA,iCAAQ,UAAR,QAAAA,EAAe,SACjB,QAAQ,MAAM,GAAGJ,CAAM,MAAME,CAAO,IAAI,GAAGC,CAAI;AAAA,EAEnD;AACF;ACjBO,MAAME,EAAgB;AAAA,EAgB3B,YACEC,GACAC,GACAC,GACAC,IAAoB,SACpB;AApBO,IAAAC,EAAA;AACD,IAAAA,EAAA;AACA,IAAAA,EAAA;AACA,IAAAA,EAAA,cAAe;AAEf,IAAAA,EAAA;AACA,IAAAA,EAAA,oBAAiD;AACjD,IAAAA,EAAA;AACA,IAAAA,EAAA;AAEA,IAAAA,EAAA,gBAAwB;AACxB,IAAAA,EAAA,iBAAkB;AAClB,IAAAA,EAAA,eAAiB;AACjB,IAAAA,EAAA,gBAAkB;AAQxB,SAAK,KAAKJ,GACV,KAAK,MAAMC,GACX,KAAK,SAASE,GAEd,KAAK,QAAQ,IAAI,MAAA,GACjB,KAAK,MAAM,cAAc,aACzB,KAAK,MAAM,UAAU,QAErB,KAAK,WAAWF,EAAI,WAAA,GACpB,KAAK,aAAaA,EAAI,WAAA,GAEtB,KAAK,SAAS,QAAQ,KAAK,UAAU,GACrC,KAAK,WAAW,QAAQC,CAAa,GAErC,KAAK,iBAAA;AAAA,EACP;AAAA,EAEQ,mBAAyB;AAC/B,SAAK,MAAM,iBAAiB,WAAW,MAAM;AAC3C,WAAK,SAAS,IACV,KAAK,WAAW,cAClB,KAAK,SAAS,YAEhBP,EAAO,MAAM,SAAS,KAAK,EAAE,gBAAgB;AAAA,IAC/C,CAAC,GAED,KAAK,MAAM,iBAAiB,SAAS,MAAM;AACzC,MAAK,KAAK,UACR,KAAK,SAAS,WACdA,EAAO,MAAM,SAAS,KAAK,EAAE,QAAQ;AAAA,IAEzC,CAAC,GAED,KAAK,MAAM,iBAAiB,SAAS,CAAC,MAAM;AAC1C,MAAAA,EAAO,MAAM,SAAS,KAAK,EAAE,WAAW,KAAK,MAAM,KAAK,GACxD,KAAK,SAAS;AAAA,IAChB,CAAC;AAAA,EACH;AAAA,EAEA,IAAI,QAAuB;AACzB,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,IAAI,QAAoB;AACtB,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,IAAI,MAAc;AAChB,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,IAAI,SAAiB;AACnB,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,IAAI,OAAgB;AAClB,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,IAAI,QAAiB;AACnB,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,MAAM,KAAKU,GAA4B;AACrC,gBAAK,SAAS,WACd,KAAK,OAAOA,GACZ,KAAK,SAAS,IAEP,IAAI,QAAQ,CAACC,GAASC,MAAW;AACtC,YAAMC,IAAY,MAAM;AACtB,aAAK,MAAM,oBAAoB,WAAWA,CAAS,GACnD,KAAK,MAAM,oBAAoB,SAASC,CAAO,GAG1C,KAAK,eACR,KAAK,aAAa,KAAK,IAAI,yBAAyB,KAAK,KAAK,GAC9D,KAAK,WAAW,QAAQ,KAAK,QAAQ,IAGvC,KAAK,SAAS,IACd,KAAK,SAAS,WACdd,EAAO,MAAM,iBAAiB,KAAK,EAAE,EAAE,GACvCW,EAAA;AAAA,MACF,GAEMG,IAAU,MAAM;AACpB,aAAK,MAAM,oBAAoB,WAAWD,CAAS,GACnD,KAAK,MAAM,oBAAoB,SAASC,CAAO,GAC/C,KAAK,SAAS,WACdF,EAAO,IAAI,MAAM,mBAAmBF,CAAG,EAAE,CAAC;AAAA,MAC5C;AAEA,WAAK,MAAM,iBAAiB,WAAWG,GAAW,EAAE,MAAM,IAAM,GAChE,KAAK,MAAM,iBAAiB,SAASC,GAAS,EAAE,MAAM,IAAM,GAE5D,KAAK,MAAM,MAAMJ,GACjB,KAAK,MAAM,KAAA;AAAA,IACb,CAAC;AAAA,EACH;AAAA,EAEA,MAAM,KAAKK,IAAiB,GAAkB;AAC5C,QAAI,CAAC,KAAK,QAAQ;AAChB,MAAAf,EAAO,KAAK,SAAS,KAAK,EAAE,YAAY;AACxC;AAAA,IACF;AAEA,QAAI;AACF,WAAK,MAAM,cAAc,KAAK,IAAI,GAAG,KAAK,IAAIe,GAAQ,KAAK,MAAM,YAAY,CAAC,CAAC,GAC/E,KAAK,MAAM,OAAO,KAAK,OACvB,MAAM,KAAK,MAAM,KAAA,GACjB,KAAK,SAAS,WACdf,EAAO,MAAM,SAAS,KAAK,EAAE,iBAAiBe,EAAO,QAAQ,CAAC,CAAC,GAAG;AAAA,IACpE,SAASC,GAAO;AACd,MAAAhB,EAAO,MAAM,kBAAkB,KAAK,EAAE,KAAKgB,CAAK;AAAA,IAClD;AAAA,EACF;AAAA,EAEA,QAAc;AACZ,IAAI,KAAK,WAAW,cAEpB,KAAK,MAAM,MAAA,GACX,KAAK,SAAS,UACdhB,EAAO,MAAM,SAAS,KAAK,EAAE,cAAc,KAAK,MAAM,YAAY,QAAQ,CAAC,CAAC,GAAG;AAAA,EACjF;AAAA,EAEA,OAAa;AACX,SAAK,MAAM,MAAA,GACX,KAAK,MAAM,cAAc,GACzB,KAAK,SAAS,WACdA,EAAO,MAAM,SAAS,KAAK,EAAE,UAAU;AAAA,EACzC;AAAA,EAEA,KAAKiB,GAAoB;AACvB,UAAMC,IAAW,KAAK,IAAI,GAAG,KAAK,IAAID,GAAM,KAAK,MAAM,YAAY,CAAC,CAAC;AACrE,SAAK,MAAM,cAAcC;AAAA,EAC3B;AAAA,EAEA,UAAUC,GAAqB;AAC7B,SAAK,UAAU,KAAK,IAAI,GAAG,KAAK,IAAI,GAAGA,CAAK,CAAC,GAC7C,KAAK,SAAS,KAAK,eAAe,KAAK,SAAS,KAAK,IAAI,WAAW;AAAA,EACtE;AAAA,EAEA,QAAQA,GAAsB;AAC5B,SAAK,QAAQA,GACb,KAAK,MAAM,OAAOA;AAAA,EACpB;AAAA,EAEA,WAAWC,GAAsBC,GAA2B;AAC1D,SAAK,SAASD,GACd,KAAK,WAAW,WAAA,GAChB,KAAK,WAAW,QAAQC,CAAS;AAAA,EACnC;AAAA,EAEA,iBAAyB;AACvB,WAAO,KAAK,MAAM;AAAA,EACpB;AAAA,EAEA,cAAsB;AACpB,WAAO,KAAK,MAAM,YAAY;AAAA,EAChC;AAAA,EAEA,WAAW;AACT,WAAO;AAAA,MACL,IAAI,KAAK;AAAA,MACT,KAAK,KAAK;AAAA,MACV,OAAO,KAAK;AAAA,MACZ,eAAe,KAAK;AAAA,MACpB,QAAQ,KAAK;AAAA,MACb,MAAM,KAAK;AAAA,MACX,aAAa,KAAK,eAAA;AAAA,MAClB,UAAU,KAAK,YAAA;AAAA,IAAY;AAAA,EAE/B;AAAA,EAEA,UAAgB;ADvMlB,QAAAlB;ACwMI,SAAK,MAAM,MAAA,GACX,KAAK,MAAM,MAAM,KACjBA,IAAA,KAAK,eAAL,QAAAA,EAAiB,cACjB,KAAK,SAAS,WAAA,GACd,KAAK,WAAW,WAAA,GAChBH,EAAO,MAAM,SAAS,KAAK,EAAE,WAAW;AAAA,EAC1C;AACF;AC5MO,SAASsB,IAAwB;AAEtC,SAAO,KAAK,IAAA;AACd;AAeO,SAASC,EAAWC,GAAyB;AAClD,MAAI,CAAC,SAASA,CAAO,KAAKA,IAAU,EAAG,QAAO;AAE9C,QAAMC,IAAO,KAAK,MAAMD,IAAU,EAAE,GAC9BE,IAAO,KAAK,MAAMF,IAAU,EAAE;AACpC,SAAO,GAAGC,CAAI,IAAIC,EAAK,WAAW,SAAS,GAAG,GAAG,CAAC;AACpD;ACvBO,SAASC,IAAuB;AAErC,SAAI,OAAO,SAAW,OAAe,OAAO,aACnC,OAAO,WAAA,IAIT,uCAAuC,QAAQ,SAAS,CAACC,MAAM;AACpE,UAAMC,IAAI,KAAK,OAAA,IAAW,KAAK;AAE/B,YADUD,MAAM,MAAMC,IAAKA,IAAI,IAAM,GAC5B,SAAS,EAAE;AAAA,EACtB,CAAC;AACH;ACbO,MAAMC,IAA0B;AAAA,EACrC;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF,GAOaC,IAA2C;AAAA,EACtD,QAAQ;AAAA,EACR,QAAQ;AAAA,EACR,QAAQ;AAAA,EACR,SAAS;AAAA,EACT,QAAQ;AAAA,EACR,QAAQ;AAAA,EACR,SAAS;AAAA,EACT,SAAS;AACX;AAKO,SAASC,EAAmBtB,GAAsB;AACvD,QAAMuB,IAAYC,EAAiBxB,CAAG;AACtC,SAAOoB,EAAwB,SAASG,CAAiC;AAC3E;AAKO,SAASC,EAAiBxB,GAAqB;AACpD,MAAI;AAQF,UAAMyB,IANU,mBAAmBzB,CAAG,EAGb,MAAM,GAAG,EAAE,CAAC,EAAE,MAAM,GAAG,EAAE,CAAC,EAG5B,MAAM,iBAAiB;AAC9C,WAAOyB,IAAQ,IAAIA,EAAM,CAAC,EAAE,YAAA,CAAa,KAAK;AAAA,EAChD,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AAKO,SAASC,EAAiB1B,GAA4B;AAC3D,QAAMuB,IAAYC,EAAiBxB,CAAG;AACtC,SAAOqB,EAAiBE,CAAS,KAAK;AACxC;AAeO,SAASI,EAAkB3B,GAAoC;AACpE,MAAI,CAACA,KAAO,OAAOA,KAAQ;AACzB,WAAO;AAAA,MACL,OAAO;AAAA,MACP,OAAO;AAAA,IAAA;AAIX,QAAMuB,IAAYC,EAAiBxB,CAAG;AAEtC,MAAI,CAACuB;AACH,WAAO;AAAA,MACL,OAAO;AAAA,MACP,OAAO;AAAA,IAAA;AAIX,MAAI,CAACD,EAAmBtB,CAAG;AACzB,WAAO;AAAA,MACL,OAAO;AAAA,MACP,OAAO,6BAA6BuB,CAAS,wBAAwBH,EAAwB,KAAK,IAAI,CAAC;AAAA,MACvG,WAAAG;AAAA,IAAA;AAIJ,QAAMK,IAAWF,EAAiB1B,CAAG;AAErC,SAAO;AAAA,IACL,OAAO;AAAA,IACP,WAAAuB;AAAA,IACA,UAAUK,KAAY;AAAA,EAAA;AAE1B;ACvGA,MAAMC,IAAY;AAElB,SAASC,IAA6B;AACpC,SAAQ,KAAK,SAAS,IAAID,GAAW,uBAAuB,KAAgB;AAC9E;AAEO,MAAME,EAAY;AAAA,EAevB,cAAc;AAdN,IAAAhC,EAAA;AACA,IAAAA,EAAA;AACA,IAAAA,EAAA;AACA,IAAAA,EAAA,qCAA4C,IAAA;AAE5C,IAAAA,EAAA,kBAA2B;AAAA,MACjC,QAAQ;AAAA,MACR,OAAO;AAAA,MACP,UAAU;AAAA,MACV,KAAK;AAAA,IAAA;AAGC,IAAAA,EAAA,qBAAoD;AAG1D,SAAK,MAAM,IAAI,aAAA,GAEf,KAAK,aAAa,KAAK,IAAI,WAAA,GAC3B,KAAK,WAAW,QAAQ,KAAK,IAAI,WAAW,GAE5C,KAAK,eAAe;AAAA,MAClB,OAAO,KAAK,IAAI,WAAA;AAAA,MAChB,UAAU,KAAK,IAAI,WAAA;AAAA,MACnB,KAAK,KAAK,IAAI,WAAA;AAAA,IAAW,GAG3B,KAAK,aAAa,MAAM,QAAQ,KAAK,UAAU,GAC/C,KAAK,aAAa,SAAS,QAAQ,KAAK,UAAU,GAClD,KAAK,aAAa,IAAI,QAAQ,KAAK,UAAU,GAE7CT,EAAO,KAAK,yBAAyB;AAAA,EACvC;AAAA;AAAA;AAAA;AAAA,EAMQ,eAAqB;ALnD/B,QAAAG;AKoDI,KAAKA,IAAA,KAAK,SAAL,QAAAA,EAAW,SAEZ,KAAK,eACP,aAAa,KAAK,WAAW,GAE/B,KAAK,cAAc,WAAW,MAAM;AAClC,WAAK,UAAA;AAAA,IACP,GAAG,GAAG;AAAA,EACR;AAAA,EAEA,MAAc,YAA2B;AL9D3C,QAAAA;AK+DI,QAAI,CAAC,KAAK,SAAS,GAACA,IAAA,KAAK,SAAL,QAAAA,EAAW,MAAM;AAErC,UAAMuC,IAAQ,KAAK,SAAA;AAEnB,QAAI;AACF,YAAM,KAAK,SAAS,IAAIH,GAAW,cAAc,KAAK,UAAUG,CAAK,CAAC,GACtE1C,EAAO,MAAM,mBAAmB;AAAA,IAClC,SAASgB,GAAO;AACd,MAAAhB,EAAO,MAAM,+BAA+BgB,CAAK;AAAA,IACnD;AAAA,EACF;AAAA,EAEA,MAAM,iBAAgC;AACpC,QAAK,KAAK;AAEV,UAAI;AACF,cAAM2B,IAAY,KAAK,SAAS,IAAIJ,GAAW,YAAY;AAC3D,YAAI,CAACI,EAAW;AAEhB,cAAMD,IAAQ,KAAK,MAAMC,CAAS;AAClC,cAAM,KAAK,aAAaD,CAAK,GAE7B1C,EAAO,KAAK,sBAAsB;AAAA,MACpC,SAASgB,GAAO;AACd,QAAAhB,EAAO,MAAM,+BAA+BgB,CAAK;AAAA,MACnD;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAMA,MAAM,YAAY4B,GAA+C;AAE/D,UAAMC,IAAUD,EAAO,MAAMjB,EAAA;AAE7B,QAAI,KAAK,QAAQ,IAAIkB,CAAO;AAC1B,aAAO,KAAK,QAAQ,IAAIA,CAAO;AAIjC,UAAMC,IAAaT,EAAkBO,EAAO,GAAG;AAC/C,QAAI,CAACE,EAAW,OAAO;AACrB,YAAM9B,IAAQ,IAAI,MAAM8B,EAAW,SAAS,oBAAoB;AAChE,YAAA9C,EAAO,MAAM,4BAA4B8C,EAAW,KAAK,EAAE,GACrD9B;AAAA,IACR;AAEA,UAAMT,IAAgB,KAAK,aAAaqC,EAAO,KAAK,GAE9CG,IAAS,IAAI3C;AAAA,MACjByC;AAAA,MACA,KAAK;AAAA,MACLtC;AAAA,MACAqC,EAAO;AAAA,IAAA;AAGT,WAAIA,EAAO,WAAW,UACpBG,EAAO,UAAUH,EAAO,MAAM,GAE5BA,EAAO,SAAS,UAClBG,EAAO,QAAQH,EAAO,IAAI,GAG5B,MAAMG,EAAO,KAAKH,EAAO,GAAG,GAE5B,KAAK,QAAQ,IAAIC,GAASE,CAAM,GAChC,KAAK,aAAA,GAEL/C,EAAO,KAAK,kBAAkB6C,CAAO,KAAKC,EAAW,SAAS,GAAG,GAC1DC;AAAA,EACT;AAAA,EAEA,SAAS1C,GAAyC;AAChD,WAAO,KAAK,QAAQ,IAAIA,CAAE;AAAA,EAC5B;AAAA,EAEA,YAAYA,GAAqB;AAC/B,UAAM0C,IAAS,KAAK,QAAQ,IAAI1C,CAAE;AAClC,WAAK0C,KAELA,EAAO,QAAA,GACP,KAAK,QAAQ,OAAO1C,CAAE,GACtB,KAAK,aAAA,GAELL,EAAO,KAAK,kBAAkBK,CAAE,EAAE,GAC3B,MAPa;AAAA,EAQtB;AAAA,EAEA,eAAkC;AAChC,WAAO,MAAM,KAAK,KAAK,QAAQ,QAAQ;AAAA,EACzC;AAAA,EAEA,iBAAiBG,GAAsC;AACrD,WAAO,KAAK,aAAA,EAAe,OAAO,CAAA,MAAK,EAAE,UAAUA,CAAK;AAAA,EAC1D;AAAA,EAEA,gBAAgBH,GAAYe,GAA4B;AACtD,UAAM2B,IAAS,KAAK,QAAQ,IAAI1C,CAAE;AAClC,IAAK0C,MAELA,EAAO,WAAW3B,GAAU,KAAK,aAAaA,CAAQ,CAAC,GACvD,KAAK,aAAA;AAAA,EACP;AAAA;AAAA;AAAA;AAAA,EAMA,MAAM,UAAUf,GAAYU,IAAiB,GAAkB;AL5KjE,QAAAZ;AK6KI,UAAM4C,IAAS,KAAK,QAAQ,IAAI1C,CAAE;AAClC,QAAI,CAAC0C,GAAQ;AACX,MAAA/C,EAAO,KAAK,oBAAoBK,CAAE,EAAE;AACpC;AAAA,IACF;AAEA,UAAM2C,IAAkBR,EAAA,GAClBS,IAAe,KAAK,aAAA,EAAe,OAAO,CAAAC,MAAKA,EAAE,UAAU,SAAS,EAAE;AAG5E,QAAI,EAFuBH,EAAO,UAAU,cAEjBE,KAAgBD,GAAiB;AAC1D,MAAAhD,EAAO,KAAK,gCAAgCgD,CAAe,WAAW,IACtE7C,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK,yBAAyB6C,CAAe;AAC/D;AAAA,IACF;AAEA,UAAMD,EAAO,KAAKhC,CAAM;AAAA,EAC1B;AAAA,EAEA,WAAWV,GAAkB;ALhM/B,QAAAF;AKiMI,KAAAA,IAAA,KAAK,QAAQ,IAAIE,CAAE,MAAnB,QAAAF,EAAsB;AAAA,EACxB;AAAA,EAEA,UAAUE,GAAkB;ALpM9B,QAAAF;AKqMI,KAAAA,IAAA,KAAK,QAAQ,IAAIE,CAAE,MAAnB,QAAAF,EAAsB;AAAA,EACxB;AAAA,EAEA,UAAUE,GAAYY,GAAoB;ALxM5C,QAAAd;AKyMI,KAAAA,IAAA,KAAK,QAAQ,IAAIE,CAAE,MAAnB,QAAAF,EAAsB,KAAKc;AAAA,EAC7B;AAAA,EAEA,eAAeZ,GAAY8C,GAAsB;AL5MnD,QAAAhD;AK6MI,KAAAA,IAAA,KAAK,QAAQ,IAAIE,CAAE,MAAnB,QAAAF,EAAsB,UAAUgD,IAChC,KAAK,aAAA;AAAA,EACP;AAAA,EAEA,aAAa9C,GAAY+C,GAAqB;ALjNhD,QAAAjD;AKkNI,KAAAA,IAAA,KAAK,QAAQ,IAAIE,CAAE,MAAnB,QAAAF,EAAsB,QAAQiD,IAC9B,KAAK,aAAA;AAAA,EACP;AAAA,EAEA,UAAgB;AACd,eAAWL,KAAU,KAAK,QAAQ,OAAA;AAChC,MAAAA,EAAO,KAAA;AAAA,EAEX;AAAA;AAAA;AAAA;AAAA,EAMA,IAAI,UAA0B;AAC5B,WAAO,EAAE,GAAG,KAAK,SAAA;AAAA,EACnB;AAAA,EAEA,gBAAgB5B,GAAqB;AACnC,SAAK,SAAS,SAAS,KAAK,IAAI,GAAG,KAAK,IAAI,GAAGA,CAAK,CAAC,GACrD,KAAK,WAAW,KAAK;AAAA,MACnB,KAAK,SAAS;AAAA,MACd,KAAK,IAAI,cAAc;AAAA,IAAA,GAEzB,KAAK,aAAA;AAAA,EACP;AAAA,EAEA,iBAAiBkC,GAAqBlC,GAAqB;AACzD,SAAK,SAASkC,CAAO,IAAI,KAAK,IAAI,GAAG,KAAK,IAAI,GAAGlC,CAAK,CAAC,GACvD,KAAK,aAAakC,CAAO,EAAE,KAAK;AAAA,MAC9B,KAAK,SAASA,CAAO;AAAA,MACrB,KAAK,IAAI,cAAc;AAAA,IAAA,GAEzB,KAAK,aAAA;AAAA,EACP;AAAA,EAEA,iBAAiBA,GAA6B;AAC5C,WAAO,KAAK,SAASA,CAAO;AAAA,EAC9B;AAAA;AAAA;AAAA;AAAA,EAMA,WAAuB;AACrB,UAAMC,IAAuB,CAAA;AAE7B,eAAWP,KAAU,KAAK,QAAQ,OAAA;AAChC,MAAAO,EAAO,KAAKP,EAAO,UAAU;AAG/B,WAAO;AAAA,MACL,cAAc,KAAK,SAAS;AAAA,MAC5B,gBAAgB,EAAE,GAAG,KAAK,SAAA;AAAA,MAC1B,QAAAO;AAAA,MACA,WAAWhC,EAAA;AAAA,MACX,aAAa;AAAA,IAAA;AAAA,EAEjB;AAAA,EAEA,MAAM,aAAaoB,GAAkC;AAKnD,QAHA,KAAK,SAAS,SAASA,EAAM,cAC7B,KAAK,WAAW,KAAK,eAAe,KAAK,SAAS,QAAQ,KAAK,IAAI,WAAW,GAE1EA,EAAM;AACR,iBAAWW,KAAW,CAAC,SAAS,YAAY,KAAK;AAC/C,aAAK,SAASA,CAAO,IAAIX,EAAM,eAAeW,CAAO,GACrD,KAAK,aAAaA,CAAO,EAAE,KAAK,eAAe,KAAK,SAASA,CAAO,GAAG,KAAK,IAAI,WAAW;AAK/F,eAAWE,KAAcb,EAAM;AAC7B,UAAI,CAAC,KAAK,QAAQ,IAAIa,EAAW,EAAE;AACjC,YAAI;AACF,gBAAM,KAAK,YAAY;AAAA,YACrB,IAAIA,EAAW;AAAA,YACf,KAAKA,EAAW;AAAA,YAChB,OAAOA,EAAW;AAAA,YAClB,QAAQA,EAAW;AAAA,YACnB,MAAMA,EAAW;AAAA,UAAA,CAClB;AAAA,QACH,SAASvC,GAAO;AACd,UAAAhB,EAAO,MAAM,2BAA2BuD,EAAW,EAAE,KAAKvC,CAAK;AAAA,QACjE;AAKJ,UAAMwC,IAAgB,IAAI,IAAId,EAAM,OAAO,IAAI,CAAAQ,MAAKA,EAAE,EAAE,CAAC;AACzD,eAAW,CAAC7C,CAAE,KAAK,KAAK;AACtB,MAAKmD,EAAc,IAAInD,CAAE,KACvB,KAAK,YAAYA,CAAE;AAAA,EAGzB;AAAA;AAAA;AAAA;AAAA,EAMA,MAAM,SAAwB;AAC5B,IAAI,KAAK,IAAI,UAAU,gBACrB,MAAM,KAAK,IAAI,OAAA,GACfL,EAAO,KAAK,sBAAsB;AAAA,EAEtC;AAAA,EAEA,IAAI,eAAkC;AACpC,WAAO,KAAK,IAAI;AAAA,EAClB;AAAA;AAAA;AAAA;AAAA,EAMA,UAAgB;AACd,IAAI,KAAK,eACP,aAAa,KAAK,WAAW;AAE/B,eAAW+C,KAAU,KAAK,QAAQ,OAAA;AAChC,MAAAA,EAAO,QAAA;AAET,SAAK,QAAQ,MAAA,GACb,KAAK,IAAI,MAAA,GACT/C,EAAO,KAAK,sBAAsB;AAAA,EACpC;AACF;AC1UO,MAAMyD,EAAkB;AAAA,EAe7B,cAAc;AAdN,IAAAhD,EAAA;AACA,IAAAA,EAAA;AACA,IAAAA,EAAA;AACA;AAAA,IAAAA,EAAA;AACA,IAAAA,EAAA,qCAA4C,IAAA;AAE5C,IAAAA,EAAA,sBAAuB;AACvB;AAAA,IAAAA,EAAA,oBAA6B;AAAA,MACnC,QAAQ;AAAA,MACR,OAAO;AAAA,MACP,UAAU;AAAA,MACV,KAAK;AAAA,IAAA;AAIL,SAAK,MAAM,IAAI,aAAA,GAGf,KAAK,aAAa,KAAK,IAAI,WAAA,GAC3B,KAAK,WAAW,QAAQ,KAAK,IAAI,WAAW,GAE5C,KAAK,SAAS,KAAK,IAAI,WAAA,GACvB,KAAK,OAAO,QAAQ,KAAK,UAAU,GAEnC,KAAK,eAAe;AAAA,MAClB,OAAO,KAAK,IAAI,WAAA;AAAA,MAChB,UAAU,KAAK,IAAI,WAAA;AAAA,MACnB,KAAK,KAAK,IAAI,WAAA;AAAA,IAAW,GAG3B,KAAK,aAAa,MAAM,QAAQ,KAAK,MAAM,GAC3C,KAAK,aAAa,SAAS,QAAQ,KAAK,MAAM,GAC9C,KAAK,aAAa,IAAI,QAAQ,KAAK,MAAM,GAEzCT,EAAO,KAAK,+BAA+B;AAAA,EAC7C;AAAA;AAAA;AAAA;AAAA,EAMA,IAAI,cAAsB;AACxB,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,eAAemB,GAAqB;AAClC,SAAK,eAAe,KAAK,IAAI,GAAG,KAAK,IAAI,GAAGA,CAAK,CAAC,GAClD,KAAK,WAAW,KAAK;AAAA,MACnB,KAAK;AAAA,MACL,KAAK,IAAI,cAAc;AAAA,IAAA;AAAA,EAE3B;AAAA;AAAA;AAAA;AAAA,EAMA,YAAYkC,GAAgClC,GAAqB;AAC/D,UAAMuC,IAAY,KAAK,IAAI,GAAG,KAAK,IAAI,GAAGvC,CAAK,CAAC;AAEhD,IAAIkC,MAAY,YACd,KAAK,WAAW,SAASK,GACzB,KAAK,OAAO,KAAK,wBAAwBA,GAAW,KAAK,IAAI,cAAc,IAAI,MAE/E,KAAK,WAAWL,CAAO,IAAIK,GAC3B,KAAK,aAAaL,CAAO,EAAE,KAAK,wBAAwBK,GAAW,KAAK,IAAI,cAAc,IAAI;AAAA,EAElG;AAAA,EAEA,gBAAgBC,GAA+B;AAC7C,SAAK,aAAa,EAAE,GAAGA,EAAA,GAEvB,KAAK,OAAO,KAAK,eAAeA,EAAQ,QAAQ,KAAK,IAAI,WAAW,GACpE,KAAK,aAAa,MAAM,KAAK,eAAeA,EAAQ,OAAO,KAAK,IAAI,WAAW,GAC/E,KAAK,aAAa,SAAS,KAAK,eAAeA,EAAQ,UAAU,KAAK,IAAI,WAAW,GACrF,KAAK,aAAa,IAAI,KAAK,eAAeA,EAAQ,KAAK,KAAK,IAAI,WAAW;AAAA,EAC7E;AAAA;AAAA;AAAA;AAAA,EAMA,MAAM,WAAWC,GAA0C;AACzD,QAAIb,IAAS,KAAK,QAAQ,IAAIa,EAAQ,OAAO;AAG7C,IAAKb,MACHA,IAAS,IAAI3C;AAAA,MACXwD,EAAQ;AAAA,MACR,KAAK;AAAA,MACL,KAAK,aAAaA,EAAQ,KAAK;AAAA,MAC/BA,EAAQ;AAAA,IAAA,GAGV,MAAMb,EAAO,KAAKa,EAAQ,GAAG,GAC7B,KAAK,QAAQ,IAAIA,EAAQ,SAASb,CAAM,IAG1CA,EAAO,UAAUa,EAAQ,MAAM,GAC/Bb,EAAO,QAAQa,EAAQ,IAAI;AAG3B,UAAMC,KAAWvC,EAAA,IAAkBsC,EAAQ,kBAAkB,KACvDE,IAAiB,KAAK,IAAI,GAAGF,EAAQ,SAASC,CAAO;AAE3D,UAAMd,EAAO,KAAKe,CAAc,GAChC9D,EAAO,MAAM,iBAAiB4D,EAAQ,OAAO,eAAeE,EAAe,QAAQ,CAAC,CAAC,GAAG;AAAA,EAC1F;AAAA,EAEA,YAAYjB,GAAuB;ANtHrC,QAAA1C;AMuHI,KAAAA,IAAA,KAAK,QAAQ,IAAI0C,CAAO,MAAxB,QAAA1C,EAA2B;AAAA,EAC7B;AAAA,EAEA,WAAW0C,GAAuB;AN1HpC,QAAA1C;AM2HI,KAAAA,IAAA,KAAK,QAAQ,IAAI0C,CAAO,MAAxB,QAAA1C,EAA2B;AAAA,EAC7B;AAAA,EAEA,WAAW0C,GAAiB5B,GAAc8C,GAAoBC,GAA6B;AACzF,UAAMjB,IAAS,KAAK,QAAQ,IAAIF,CAAO;AACvC,QAAKE;AAEL,UAAIgB,GAAW;AACb,cAAMF,KAAWvC,EAAA,IAAkB0C,KAAiB;AACpD,QAAAjB,EAAO,KAAK9B,IAAO4C,CAAO;AAAA,MAC5B;AACE,QAAAd,EAAO,KAAK9B,CAAI;AAAA,EAEpB;AAAA,EAEA,kBAAkB4B,GAAiBM,GAAsB;AN1I3D,QAAAhD;AM2II,KAAAA,IAAA,KAAK,QAAQ,IAAI0C,CAAO,MAAxB,QAAA1C,EAA2B,UAAUgD;AAAA,EACvC;AAAA,EAEA,gBAAgBN,GAAiBO,GAAqB;AN9IxD,QAAAjD;AM+II,KAAAA,IAAA,KAAK,QAAQ,IAAI0C,CAAO,MAAxB,QAAA1C,EAA2B,QAAQiD;AAAA,EACrC;AAAA;AAAA;AAAA;AAAA,EAMA,MAAM,UAAUE,GAA0BK,GAAwC;AAEhF,SAAK,gBAAgBA,CAAO;AAG5B,UAAMM,IAAc,IAAI,IAAIX,EAAO,IAAI,CAAAJ,MAAKA,EAAE,EAAE,CAAC;AAGjD,eAAW,CAAC7C,GAAI0C,CAAM,KAAK,KAAK;AAC9B,MAAKkB,EAAY,IAAI5D,CAAE,MACrB0C,EAAO,QAAA,GACP,KAAK,QAAQ,OAAO1C,CAAE;AAK1B,eAAWkD,KAAcD,GAAQ;AAC/B,UAAIP,IAAS,KAAK,QAAQ,IAAIQ,EAAW,EAAE;AAiB3C,UAfKR,MACHA,IAAS,IAAI3C;AAAA,QACXmD,EAAW;AAAA,QACX,KAAK;AAAA,QACL,KAAK,aAAaA,EAAW,KAAK;AAAA,QAClCA,EAAW;AAAA,MAAA,GAGb,MAAMR,EAAO,KAAKQ,EAAW,GAAG,GAChC,KAAK,QAAQ,IAAIA,EAAW,IAAIR,CAAM,IAGxCA,EAAO,UAAUQ,EAAW,MAAM,GAClCR,EAAO,QAAQQ,EAAW,IAAI,GAE1BA,EAAW,WAAW;AACxB,cAAMM,KAAWvC,EAAA,IAAkBiC,EAAW,kBAAkB,KAC1DW,IAAeX,EAAW,cAAcM;AAC9C,cAAMd,EAAO,KAAKmB,CAAY;AAAA,MAChC;AACE,QAAAnB,EAAO,KAAA;AAAA,IAEX;AAEA,IAAA/C,EAAO,KAAK,8BAA8B;AAAA,EAC5C;AAAA;AAAA;AAAA;AAAA,EAMA,UAAgB;AACd,eAAW+C,KAAU,KAAK,QAAQ,OAAA;AAChC,MAAAA,EAAO,KAAA;AAAA,EAEX;AAAA,EAEA,WAAiB;AACf,eAAWA,KAAU,KAAK,QAAQ,OAAA;AAChC,MAAAA,EAAO,QAAA;AAET,SAAK,QAAQ,MAAA,GACb/C,EAAO,KAAK,4BAA4B;AAAA,EAC1C;AAAA;AAAA;AAAA;AAAA,EAMA,MAAM,SAAwB;AAC5B,IAAI,KAAK,IAAI,UAAU,gBACrB,MAAM,KAAK,IAAI,OAAA,GACfA,EAAO,KAAK,yCAAyC;AAAA,EAEzD;AAAA,EAEA,UAAgB;AACd,SAAK,SAAA,GACL,KAAK,IAAI,MAAA,GACTA,EAAO,KAAK,4BAA4B;AAAA,EAC1C;AACF;AClNA,MAAMuC,IAAY,yBACZ4B,IAAc,UAAU5B,CAAS;AAEhC,MAAM6B,EAAc;AAAA,EAOzB,cAAc;AANN,IAAA3D,EAAA,kBAA+B;AAC/B,IAAAA,EAAA,sBAAyC;AACzC,IAAAA,EAAA,gBAAc;AACd,IAAAA,EAAA,sBAAwB;AACxB,IAAAA,EAAA,cAAgB;AAAA,EAET;AAAA,EAEf,eAAe4D,GAA2B;APhC5C,QAAAlE;AOiCI,SAAK,OAAO,IACZ,KAAK,WAAWkE,GAChB,KAAK,SAAS,KAAK,SAEnBlE,IAAA,KAAK,WAAL,QAAAA,EAAa,GAAGgE,GAAa,CAAClE,MAA2B;AACvD,WAAK,gBAAgBA,CAAO;AAAA,IAC9B,IAEAD,EAAO,KAAK,iCAAiC;AAAA,EAC/C;AAAA,EAEA,mBAAmBqE,GAAiC;AP5CtD,QAAAlE;AO6CI,SAAK,OAAO,IACZ,KAAK,eAAekE,GACpB,KAAK,SAAS,KAAK,SAEnBlE,IAAA,KAAK,WAAL,QAAAA,EAAa,GAAGgE,GAAa,CAAClE,MAA2B;AACvD,WAAK,oBAAoBA,CAAO;AAAA,IAClC,IAGA,WAAW,MAAM;AACf,WAAK,KAAK,gBAAgB,EAAE;AAAA,IAC9B,GAAG,GAAI,GAEPD,EAAO,KAAK,qCAAqC;AAAA,EACnD;AAAA;AAAA;AAAA;AAAA,EAMA,IAAI,cAAuB;AACzB,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,eAAesE,GAAwB;AACrC,IAAK,KAAK,SAEV,KAAK,eAAeA,GAEhBA,IACF,KAAK,mBAAA,IAEL,KAAK,kBAAA,GAGPtE,EAAO,KAAK,cAAcsE,IAAU,OAAO,KAAK,EAAE;AAAA,EACpD;AAAA;AAAA;AAAA;AAAA,EAMQ,gBAAgBrE,GAA8B;APvFxD,QAAAE;AOwFI,IAAIF,EAAQ,eAAaE,IAAA,KAAK,SAAL,gBAAAA,EAAW,OAEhCF,EAAQ,SAAS,kBAAkB,KAAK,gBAE1C,KAAK,YAAYA,EAAQ,QAAQ;AAAA,EAErC;AAAA;AAAA;AAAA;AAAA,EAMA,MAAc,oBAAoBA,GAAuC;APpG3E,QAAAE;AOqGI,QAAIF,EAAQ,eAAaE,IAAA,KAAK,SAAL,gBAAAA,EAAW,OAC/B,KAAK;AAIV,cAFAH,EAAO,MAAM,oBAAoBC,EAAQ,IAAI,IAAIA,EAAQ,OAAO,GAExDA,EAAQ,MAAA;AAAA,QACd,KAAK;AACH,gBAAMsE,IAAetE,EAAQ;AAC7B,gBAAM,KAAK,aAAa,UAAUsE,EAAa,QAAQA,EAAa,cAAc;AAClF;AAAA,QAEF,KAAK;AACH,eAAK,aAAa,SAAA;AAClB;AAAA,QAEF,KAAK;AACH,gBAAMC,IAAevE,EAAQ;AAC7B,gBAAM,KAAK,aAAa,UAAUuE,EAAa,QAAQA,EAAa,cAAc;AAClF;AAAA,QAEF,KAAK;AACH,gBAAMC,IAAcxE,EAAQ;AAC5B,gBAAM,KAAK,aAAa,WAAWwE,CAAW;AAC9C;AAAA,QAEF,KAAK;AACH,gBAAMC,IAAezE,EAAQ;AAC7B,eAAK,aAAa,YAAYyE,EAAa,OAAO;AAClD;AAAA,QAEF,KAAK;AACH,gBAAMC,IAAc1E,EAAQ;AAC5B,eAAK,aAAa,WAAW0E,EAAY,OAAO;AAChD;AAAA,QAEF,KAAK;AACH,gBAAMC,IAAc3E,EAAQ;AAC5B,eAAK,aAAa;AAAA,YAChB2E,EAAY;AAAA,YACZA,EAAY;AAAA,YACZA,EAAY;AAAA,YACZA,EAAY;AAAA,UAAA;AAEd;AAAA,QAEF,KAAK;AACH,gBAAMC,IAAa5E,EAAQ;AAC3B,eAAK,aAAa,kBAAkB4E,EAAW,SAASA,EAAW,MAAM;AACzE;AAAA,QAEF,KAAK;AACH,gBAAMC,IAAc7E,EAAQ;AAC5B,eAAK,aAAa,gBAAgB6E,EAAY,SAASA,EAAY,IAAI;AACvE;AAAA,QAEF,KAAK;AACH,gBAAMC,IAAe9E,EAAQ;AAC7B,eAAK,aAAa,YAAY8E,EAAa,SAASA,EAAa,MAAM;AACvE;AAAA,QAEF,KAAK;AACH,eAAK,aAAa,QAAA;AAClB;AAAA,MAAA;AAAA,EAEN;AAAA;AAAA;AAAA;AAAA,EAMQ,KAAKC,GAAyBpB,GAAkBqB,GAA6B;AP3KvF,QAAA9E;AO4KI,QAAI,CAAC,KAAK,OAAQ;AAElB,UAAMF,IAAyB;AAAA,MAC7B,MAAA+E;AAAA,MACA,SAAApB;AAAA,MACA,YAAUzD,IAAA,KAAK,SAAL,gBAAAA,EAAW,OAAM;AAAA,MAC3B,WAAWmB,EAAA;AAAA,IAAc;AAG3B,IAAI2D,IACF,KAAK,OAAO,KAAKd,GAAalE,GAAS,EAAE,YAAY,CAACgF,CAAY,GAAG,IAErE,KAAK,OAAO,KAAKd,GAAalE,CAAO,GAGvCD,EAAO,MAAM,SAASgF,CAAI,IAAIpB,CAAO;AAAA,EACvC;AAAA,EAEQ,sBAAwC;AAC9C,QAAI,CAAC,KAAK;AACR,aAAO,EAAE,QAAQ,CAAA,GAAI,gBAAgB,EAAE,QAAQ,GAAG,OAAO,GAAG,UAAU,GAAG,KAAK,IAAE;AAGlF,UAAMsB,IAAM5D,EAAA,GACNgC,IAA2B,CAAA;AAEjC,eAAWP,KAAU,KAAK,SAAS,aAAA,GAAgB;AACjD,YAAML,IAAQK,EAAO,SAAA;AACrB,MAAAO,EAAO,KAAK;AAAA,QACV,IAAIZ,EAAM;AAAA,QACV,KAAKA,EAAM;AAAA,QACX,OAAOA,EAAM;AAAA,QACb,QAAQA,EAAM;AAAA,QACd,MAAMA,EAAM;AAAA,QACZ,WAAWA,EAAM,kBAAkB;AAAA,QACnC,aAAaK,EAAO,eAAA;AAAA,QACpB,gBAAgBmC;AAAA,MAAA,CACjB;AAAA,IACH;AAEA,WAAO;AAAA,MACL,QAAA5B;AAAA,MACA,gBAAgB,KAAK,SAAS;AAAA,IAAA;AAAA,EAElC;AAAA,EAEQ,qBAA2B;AACjC,UAAMZ,IAAQ,KAAK,oBAAA;AACnB,SAAK,KAAK,cAAcA,CAAK;AAAA,EAC/B;AAAA,EAEQ,oBAA0B;AAChC,SAAK,KAAK,aAAa,EAAE;AAAA,EAC3B;AAAA,EAEQ,YAAYyC,GAAsB;AACxC,UAAMzC,IAAQ,KAAK,oBAAA;AACnB,SAAK,KAAK,cAAcA,GAAOyC,CAAM;AAAA,EACvC;AAAA;AAAA;AAAA;AAAA,EAMA,mBAAmBtC,GAAiB9B,GAAsB;AACxD,QAAI,CAAC,KAAK,gBAAgB,CAAC,KAAK,SAAU;AAE1C,UAAMgC,IAAS,KAAK,SAAS,SAASF,CAAO;AAC7C,QAAI,CAACE,EAAQ;AAEb,UAAMa,IAA4B;AAAA,MAChC,SAAAf;AAAA,MACA,KAAKE,EAAO;AAAA,MACZ,OAAOA,EAAO;AAAA,MACd,QAAQA,EAAO;AAAA,MACf,MAAMA,EAAO;AAAA,MACb,QAAAhC;AAAA,MACA,gBAAgBO,EAAA;AAAA,IAAc;AAGhC,SAAK,KAAK,cAAcsC,CAAO;AAAA,EACjC;AAAA,EAEA,oBAAoBf,GAAiBuC,GAAwB;AAC3D,QAAI,CAAC,KAAK,aAAc;AAExB,UAAMxB,IAA6B,EAAE,SAAAf,GAAS,UAAAuC,EAAA;AAC9C,SAAK,KAAK,eAAexB,CAAO;AAAA,EAClC;AAAA,EAEA,mBAAmBf,GAAuB;AACxC,QAAI,CAAC,KAAK,aAAc;AAExB,UAAMe,IAA4B,EAAE,SAAAf,EAAA;AACpC,SAAK,KAAK,cAAce,CAAO;AAAA,EACjC;AAAA,EAEA,mBAAmBf,GAAiB5B,GAAc8C,GAA0B;AAC1E,QAAI,CAAC,KAAK,aAAc;AAExB,UAAMH,IAA4B;AAAA,MAChC,SAAAf;AAAA,MACA,MAAA5B;AAAA,MACA,WAAA8C;AAAA,MACA,eAAezC,EAAA;AAAA,IAAc;AAE/B,SAAK,KAAK,cAAcsC,CAAO;AAAA,EACjC;AAAA,EAEA,qBAAqBf,GAAiBM,GAAsB;AAC1D,QAAI,CAAC,KAAK,aAAc;AAExB,UAAMS,IAA8B,EAAE,SAAAf,GAAS,QAAAM,EAAA;AAC/C,SAAK,KAAK,gBAAgBS,CAAO;AAAA,EACnC;AAAA,EAEA,mBAAmBf,GAAiBO,GAAqB;AACvD,QAAI,CAAC,KAAK,aAAc;AAExB,UAAMQ,IAA4B,EAAE,SAAAf,GAAS,MAAAO,EAAA;AAC7C,SAAK,KAAK,cAAcQ,CAAO;AAAA,EACjC;AAAA,EAEA,uBAAuBP,GAAgCF,GAAsB;AAC3E,QAAI,CAAC,KAAK,aAAc;AAExB,UAAMS,IAAgC,EAAE,SAAAP,GAAS,QAAAF,EAAA;AACjD,SAAK,KAAK,kBAAkBS,CAAO;AAAA,EACrC;AAAA,EAEA,mBAAyB;AACvB,IAAK,KAAK,gBACV,KAAK,KAAK,YAAY,EAAE;AAAA,EAC1B;AAAA,EAEA,UAAgB;APnTlB,QAAAzD;AOoTI,KAAAA,IAAA,KAAK,WAAL,QAAAA,EAAa,IAAIgE;AAAA,EACnB;AACF;ACtTO,SAASkB,EACdC,GACAC,GACkC;AAClC,MAAIC,IAAW,GACXC,IAAkD;AAEtD,SAAO,YAAyCvF,GAAqB;AACnE,UAAMgF,IAAM,KAAK,IAAA,GACXQ,IAAYH,KAASL,IAAMM;AAEjC,IAAIE,KAAa,KACXD,MACF,aAAaA,CAAS,GACtBA,IAAY,OAEdD,IAAWN,GACXI,EAAG,MAAM,MAAMpF,CAAI,KACTuF,MACVA,IAAY,WAAW,MAAM;AAC3B,MAAAD,IAAW,KAAK,IAAA,GAChBC,IAAY,MACZH,EAAG,MAAM,MAAMpF,CAAI;AAAA,IACrB,GAAGwF,CAAS;AAAA,EAEhB;AACF;AAEO,SAASC,EACdL,GACAC,GACkC;AAClC,MAAIE,IAAkD;AAEtD,SAAO,YAAyCvF,GAAqB;AACnE,IAAIuF,KACF,aAAaA,CAAS,GAExBA,IAAY,WAAW,MAAM;AAC3B,MAAAH,EAAG,MAAM,MAAMpF,CAAI;AAAA,IACrB,GAAGqF,CAAK;AAAA,EACV;AACF;ACjCA,MAAMhD,IAAY;AAElB,SAASC,IAA6B;AACpC,SAAQ,KAAK,SAAS,IAAID,GAAW,uBAAuB,KAAgB;AAC9E;AAiCO,MAAMqD,UAAsB,YAAY;AAAA,EAmB7C,YAAYvB,GAAqBwB,GAAuBC,GAAuC;AAC7F,UAAMA,CAAO;AAnBP,IAAArF,EAAA;AACA,IAAAA,EAAA;AACA,IAAAA,EAAA,wBAAwD;AAkB9D,SAAK,SAAS4D,GACd,KAAK,SAASwB;AAAA,EAChB;AAAA,EAlBA,WAAoB,iBAAqC;AACvD,WAAO,QAAQ,MAAM,YAAY,MAAM,gBAAgB;AAAA,MACrD,IAAI;AAAA,MACJ,OAAO;AAAA,MACP,UAAU,WAAWtD,CAAS;AAAA,MAC9B,SAAS,CAAC,WAAW;AAAA,MACrB,OAAO;AAAA,MACP,QAAQ;AAAA,MACR,WAAW;AAAA,MACX,aAAa;AAAA,MACb,QAAQ;AAAA,IAAA,CACT;AAAA,EACH;AAAA,EAQS,UAAqB;AAC5B,UAAMe,IAAS,KAAK,OAAO,aAAA,EAAe,IAAI,CAAAP,MAAU,KAAK,iBAAiBA,CAAM,CAAC,GAC/EY,IAAU,KAAK,OAAO,SACtBV,IAAeK,EAAO,OAAO,CAAAJ,MAAKA,EAAE,SAAS,EAAE;AAErD,WAAO;AAAA,MACL,QAAAI;AAAA,MACA,SAAS;AAAA,QACP,QAAQ,KAAK,MAAMK,EAAQ,SAAS,GAAG;AAAA,QACvC,OAAO,KAAK,MAAMA,EAAQ,QAAQ,GAAG;AAAA,QACrC,UAAU,KAAK,MAAMA,EAAQ,WAAW,GAAG;AAAA,QAC3C,KAAK,KAAK,MAAMA,EAAQ,MAAM,GAAG;AAAA,MAAA;AAAA,MAEnC,cAAAV;AAAA,MACA,iBAAiBT,EAAA;AAAA,MACjB,aAAa,KAAK,OAAO;AAAA,IAAA;AAAA,EAE7B;AAAA,EAEQ,iBAAiBO,GAAwC;AAC/D,UAAML,IAAQK,EAAO,SAAA,GACfgD,IAAchD,EAAO,eAAA,GACrBiD,IAAWjD,EAAO,YAAA;AAExB,WAAO;AAAA,MACL,IAAIL,EAAM;AAAA,MACV,MAAM,KAAK,gBAAgBA,EAAM,GAAG;AAAA,MACpC,OAAOA,EAAM;AAAA,MACb,WAAWA,EAAM,kBAAkB;AAAA,MACnC,UAAUA,EAAM,kBAAkB;AAAA,MAClC,WAAWA,EAAM,kBAAkB;AAAA,MACnC,WAAWA,EAAM,kBAAkB;AAAA,MACnC,QAAQA,EAAM;AAAA,MACd,eAAe,KAAK,MAAMA,EAAM,SAAS,GAAG;AAAA,MAC5C,MAAMA,EAAM;AAAA,MACZ,aAAAqD;AAAA,MACA,sBAAsBxE,EAAWwE,CAAW;AAAA,MAC5C,UAAAC;AAAA,MACA,mBAAmBzE,EAAWyE,CAAQ;AAAA,MACtC,UAAUA,IAAW,IAAKD,IAAcC,IAAY,MAAM;AAAA,IAAA;AAAA,EAE9D;AAAA,EAEQ,gBAAgBtF,GAAqB;AAC3C,QAAI,CAACA,EAAK,QAAO;AACjB,QAAI;AAEF,YAAMuF,IADU,mBAAmBvF,CAAG,EAChB,MAAM,GAAG;AAE/B,aADiBuF,EAAMA,EAAM,SAAS,CAAC,EACvB,QAAQ,YAAY,EAAE;AAAA,IACxC,QAAQ;AACN,YAAMA,IAAQvF,EAAI,MAAM,GAAG;AAE3B,aADiBuF,EAAMA,EAAM,SAAS,CAAC,EACvB,QAAQ,YAAY,EAAE;AAAA,IACxC;AAAA,EACF;AAAA,EAES,kBAAkBC,GAAoB;AAC7C,UAAM,kBAAkBA,CAAI,GAG5BA,EAAK,KAAK,kBAAkB,EAAE,GAAG,UAAU,CAACC,MAAU;AACpD,YAAM7B,IAAW6B,EAAM,OAA4B;AACnD,WAAK,OAAO,eAAe7B,CAAO,GAClC,KAAK,oBAAoB4B,GAAM5B,CAAO;AAAA,IACxC,CAAC;AAGD,UAAM8B,IAAyBf,EAAS,CAAChC,GAAiBlC,MAAkB;AAC1E,MAAIkC,MAAY,YACd,KAAK,OAAO,gBAAgBlC,CAAK,GACjC,KAAK,OAAO,uBAAuB,UAAUA,CAAK,MAElD,KAAK,OAAO,iBAAiBkC,GAAuBlC,CAAK,GACzD,KAAK,OAAO,uBAAuBkC,GAAuBlC,CAAK;AAAA,IAEnE,GAAG,EAAE;AAEL,IAAA+E,EAAK,KAAK,qBAAqB,EAAE,GAAG,SAAS,CAACC,MAAU;AACtD,YAAM9C,IAAU,EAAE8C,EAAM,aAAa,EAAE,KAAK,SAAS,GAC/ChF,IAAQ,WAAYgF,EAAM,OAA4B,KAAK,IAAI;AACrE,MAAAC,EAAuB/C,GAASlC,CAAK,GACrC,EAAEgF,EAAM,aAAa,EAAE,SAAS,oBAAoB,EAAE,KAAK,GAAG,KAAK,MAAMhF,IAAQ,GAAG,CAAC,GAAG;AAAA,IAC1F,CAAC,GAGD+E,EAAK,KAAK,gBAAgB,EAAE,GAAG,SAAS,MAAM,KAAK,YAAY;AAG/D,UAAM5C,IAAS4C,EAAK,KAAK,aAAa;AAEtC,IAAA5C,EAAO,GAAG,SAAS,iBAAiB,CAAC6C,MAAU;AAC7C,YAAMtD,IAAU,EAAEsD,EAAM,aAAa,EAAE,QAAQ,YAAY,EAAE,KAAK,UAAU;AAC5E,WAAK,YAAYtD,CAAO;AAAA,IAC1B,CAAC,GAEDS,EAAO,GAAG,SAAS,kBAAkB,CAAC6C,MAAU;AAC9C,YAAMtD,IAAU,EAAEsD,EAAM,aAAa,EAAE,QAAQ,YAAY,EAAE,KAAK,UAAU;AAC5E,WAAK,aAAatD,CAAO;AAAA,IAC3B,CAAC,GAEDS,EAAO,GAAG,SAAS,iBAAiB,CAAC6C,MAAU;AAC7C,YAAMtD,IAAU,EAAEsD,EAAM,aAAa,EAAE,QAAQ,YAAY,EAAE,KAAK,UAAU;AAC5E,WAAK,YAAYtD,CAAO;AAAA,IAC1B,CAAC,GAEDS,EAAO,GAAG,SAAS,mBAAmB,CAAC6C,MAAU;AAC/C,YAAMtD,IAAU,EAAEsD,EAAM,aAAa,EAAE,QAAQ,YAAY,EAAE,KAAK,UAAU;AAC5E,WAAK,cAActD,CAAO;AAAA,IAC5B,CAAC,GAEDS,EAAO,GAAG,UAAU,oBAAoB,CAAC6C,MAAU;AACjD,YAAMtD,IAAU,EAAEsD,EAAM,aAAa,EAAE,QAAQ,YAAY,EAAE,KAAK,UAAU,GACtE/C,IAAQ+C,EAAM,OAA4B;AAChD,WAAK,OAAO,aAAatD,GAASO,CAAI,GACtC,KAAK,OAAO,mBAAmBP,GAASO,CAAI;AAAA,IAC9C,CAAC,GAEDE,EAAO,GAAG,UAAU,uBAAuB,CAAC6C,MAAU;AACpD,YAAMtD,IAAU,EAAEsD,EAAM,aAAa,EAAE,KAAK,UAAU,GAChD9C,IAAW8C,EAAM,OAA6B;AACpD,WAAK,OAAO,gBAAgBtD,GAASQ,CAAO;AAAA,IAC9C,CAAC;AAGD,UAAMgD,IAAkBhB,EAAS,CAACxC,GAAiB1B,MAAkB;AACnE,WAAK,OAAO,eAAe0B,GAAS1B,CAAK,GACzC,KAAK,OAAO,qBAAqB0B,GAAS1B,CAAK;AAAA,IACjD,GAAG,EAAE;AAEL,IAAAmC,EAAO,GAAG,SAAS,sBAAsB,CAAC6C,MAAU;AAClD,YAAMtD,IAAU,EAAEsD,EAAM,aAAa,EAAE,QAAQ,YAAY,EAAE,KAAK,UAAU,GACtEhF,IAAQ,WAAYgF,EAAM,OAA4B,KAAK,IAAI;AACrE,MAAAE,EAAgBxD,GAAS1B,CAAK,GAC9B,EAAEgF,EAAM,aAAa,EAAE,SAAS,mBAAmB,EAAE,KAAK,GAAG,KAAK,MAAMhF,IAAQ,GAAG,CAAC,GAAG;AAAA,IACzF,CAAC;AAGD,UAAMmF,IAAgBjB,EAAS,CAACxC,GAAiB5B,MAAiB;AAChE,YAAM8B,IAAS,KAAK,OAAO,SAASF,CAAO,GACrCkB,KAAYhB,KAAA,gBAAAA,EAAQ,WAAU;AACpC,WAAK,OAAO,UAAUF,GAAS5B,CAAI,GACnC,KAAK,OAAO,mBAAmB4B,GAAS5B,GAAM8C,KAAa,EAAK;AAAA,IAClE,GAAG,GAAG;AAEN,IAAAT,EAAO,GAAG,SAAS,oBAAoB,CAAC6C,MAAU;AAChD,YAAMtD,IAAU,EAAEsD,EAAM,aAAa,EAAE,QAAQ,YAAY,EAAE,KAAK,UAAU,GACtEpD,IAAS,KAAK,OAAO,SAASF,CAAO;AAC3C,UAAIE,GAAQ;AAEV,cAAM9B,IADU,WAAYkF,EAAM,OAA4B,KAAK,IAC3C,MAAOpD,EAAO,YAAA;AACtC,QAAAuD,EAAczD,GAAS5B,CAAI;AAAA,MAC7B;AAAA,IACF,CAAC,GAGDiF,EAAK,KAAK,eAAe,EAAE,GAAG,SAAS,MAAM;AAC3C,WAAK,OAAO,QAAA,GACZ,KAAK,OAAO,iBAAA,GACZ,KAAK,OAAA;AAAA,IACP,CAAC,GAED,KAAK,aAAA;AAAA,EACP;AAAA,EAEQ,oBAAoBA,GAAc5B,GAAwB;AAChE,UAAMiC,IAAYL,EAAK,KAAK,kBAAkB;AAC9C,IAAAK,EAAU,YAAY,aAAajC,CAAO,GAC1CiC,EAAU,KAAK,MAAM,EAAE,KAAKjC,IAAU,YAAY,UAAU;AAAA,EAC9D;AAAA,EAEQ,eAAqB;AAC3B,SAAK,YAAA,GACL,KAAK,iBAAiB,YAAY,MAAM;AACtC,WAAK,oBAAA;AAAA,IACP,GAAG,GAAG;AAAA,EACR;AAAA,EAEQ,cAAoB;AAC1B,IAAI,KAAK,mBACP,cAAc,KAAK,cAAc,GACjC,KAAK,iBAAiB;AAAA,EAE1B;AAAA,EAEQ,sBAA4B;AAClC,UAAM4B,IAAO,KAAK;AAClB,QAAI,CAACA,KAAQ,CAACA,EAAK,OAAQ;AAE3B,QAAIjD,IAAe;AAEnB,eAAWF,KAAU,KAAK,OAAO,aAAA,GAAgB;AAC/C,YAAMyD,IAAUN,EAAK,KAAK,6BAA6BnD,EAAO,EAAE,IAAI;AACpE,UAAI,CAACyD,EAAQ,OAAQ;AAErB,YAAMT,IAAchD,EAAO,eAAA,GACrBiD,IAAWjD,EAAO,YAAA,GAClB0D,IAAWT,IAAW,IAAKD,IAAcC,IAAY,MAAM,GAC3DtD,IAAQK,EAAO;AAErB,MAAIL,MAAU,aAAWO,KAEzBuD,EAAQ,KAAK,mBAAmB,EAAE,KAAKjF,EAAWwE,CAAW,CAAC;AAE9D,YAAMW,IAAaF,EAAQ,KAAK,kBAAkB;AAClD,MAAKE,EAAW,GAAG,SAAS,KAC1BA,EAAW,IAAID,CAAQ,GAGzBD,EAAQ,YAAY,4CAA4C,GAChEA,EAAQ,SAAS,MAAM9D,CAAK,EAAE,GAE9B8D,EAAQ,KAAK,eAAe,EAAE,KAAK,YAAY9D,MAAU,aAAaA,MAAU,SAAS,GACzF8D,EAAQ,KAAK,gBAAgB,EAAE,KAAK,YAAY9D,MAAU,SAAS,GACnE8D,EAAQ,KAAK,eAAe,EAAE,KAAK,YAAY9D,MAAU,SAAS;AAAA,IACpE;AAEA,UAAMiE,IAAc,KAAK,OAAO,aAAA,EAAe;AAC/C,IAAAT,EAAK,KAAK,kBAAkB,EAAE,KAAK,GAAGjD,CAAY,IAAI0D,CAAW,UAAU;AAAA,EAC7E;AAAA,EAEA,MAAc,aAA4B;AAQxC,IAPW,IAAI,WAAW;AAAA,MACxB,MAAM;AAAA,MACN,SAAS;AAAA,MACT,UAAU,OAAOC,MAAiB;AAChC,cAAM,KAAK,iBAAiBA,CAAI;AAAA,MAClC;AAAA,IAAA,CACD,EACE,OAAO,EAAI;AAAA,EAChB;AAAA,EAEA,MAAM,iBAAiBA,GAAcpG,IAAoB,SAAwB;AT/SnF,QAAAL,GAAA0G;ASgTI,UAAMhE,IAAUlB,EAAA;AAEhB,QAAI;AACF,YAAM,KAAK,OAAO,YAAY;AAAA,QAC5B,IAAIkB;AAAA,QACJ,KAAK+D;AAAA,QACL,OAAApG;AAAA,QACA,QAAQ;AAAA,QACR,MAAM;AAAA,MAAA,CACP,GAED,KAAK,OAAA,IACLL,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK,UAAU,KAAK,gBAAgByG,CAAI,CAAC;AAAA,IAE7D,SAAS5F,GAAO;AACd,MAAAhB,EAAO,MAAM,wBAAwBgB,CAAK;AAC1C,YAAM8F,IAAe9F,aAAiB,QAAQA,EAAM,UAAU;AAC9D,OAAA6F,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM,mBAAmBC,CAAY;AAAA,IACzD;AAAA,EACF;AAAA,EAEA,MAAc,YAAYjE,GAAgC;AACxD,UAAME,IAAS,KAAK,OAAO,SAASF,CAAO;AAC3C,QAAI,CAACE,EAAQ;AAEb,UAAMhC,IAASgC,EAAO,UAAU,WAAWA,EAAO,mBAAmB;AACrE,UAAM,KAAK,OAAO,UAAUF,GAAS9B,CAAM,GAC3C,KAAK,OAAO,mBAAmB8B,GAAS9B,CAAM;AAAA,EAChD;AAAA,EAEQ,aAAa8B,GAAuB;AAC1C,UAAME,IAAS,KAAK,OAAO,SAASF,CAAO;AAC3C,QAAI,CAACE,EAAQ;AAEb,UAAMqC,IAAWrC,EAAO,eAAA;AACxB,SAAK,OAAO,WAAWF,CAAO,GAC9B,KAAK,OAAO,oBAAoBA,GAASuC,CAAQ;AAAA,EACnD;AAAA,EAEQ,YAAYvC,GAAuB;AACzC,SAAK,OAAO,UAAUA,CAAO,GAC7B,KAAK,OAAO,mBAAmBA,CAAO;AAAA,EACxC;AAAA,EAEQ,cAAcA,GAAuB;AAC3C,SAAK,OAAO,YAAYA,CAAO,GAC/B,KAAK,OAAA;AAAA,EACP;AAAA,EAES,MAAMiD,GAAmD;AAChE,gBAAK,YAAA,GACE,MAAM,MAAMA,CAAO;AAAA,EAC5B;AACF;AClWA,MAAMvD,IAAY;AAEX,MAAMwE,UAA0B,YAAY;AAAA,EAiBjD,YAAY1C,GAA2ByB,GAAuC;AAC5E,UAAMA,CAAO;AAjBP,IAAArF,EAAA;AAkBN,SAAK,SAAS4D;AAAA,EAChB;AAAA,EAjBA,WAAoB,iBAAqC;AACvD,WAAO,QAAQ,MAAM,YAAY,MAAM,gBAAgB;AAAA,MACrD,IAAI;AAAA,MACJ,OAAO;AAAA,MACP,UAAU,WAAW9B,CAAS;AAAA,MAC9B,SAAS,CAAC,kBAAkB;AAAA,MAC5B,OAAO;AAAA,MACP,QAAQ;AAAA,MACR,WAAW;AAAA,MACX,aAAa;AAAA,MACb,QAAQ;AAAA,IAAA,CACT;AAAA,EACH;AAAA,EAOS,UAAU;AACjB,WAAO;AAAA,MACL,QAAQ,KAAK,MAAM,KAAK,OAAO,cAAc,GAAG;AAAA,IAAA;AAAA,EAEpD;AAAA,EAES,kBAAkB2D,GAAoB;AAC7C,UAAM,kBAAkBA,CAAI,GAE5BA,EAAK,KAAK,oBAAoB,EAAE,GAAG,SAAS,CAACC,MAAU;AACrD,YAAMhF,IAAQ,WAAYgF,EAAM,OAA4B,KAAK,IAAI;AACrE,WAAK,OAAO,eAAehF,CAAK,GAChC+E,EAAK,KAAK,mBAAmB,EAAE,KAAK,GAAG,KAAK,MAAM/E,IAAQ,GAAG,CAAC,GAAG,GAGjE,KAAK,WAAWA,CAAK;AAAA,IACvB,CAAC;AAAA,EACH;AAAA,EAEQ,WAAWA,GAAqB;AACtC,iBAAa,QAAQ,GAAGoB,CAAS,kBAAkB,OAAOpB,CAAK,CAAC;AAAA,EAClE;AAAA,EAEA,OAAO,kBAA0B;AAC/B,UAAM6F,IAAQ,aAAa,QAAQ,GAAGzE,CAAS,gBAAgB;AAC/D,WAAOyE,IAAQ,WAAWA,CAAK,IAAI;AAAA,EACrC;AACF;AC3BO,MAAMC,UAAwB,YAAY;AAAA,EAgB/C,YAAYC,GAAyBpB,IAAU,IAAI;AACjD,UAAMA,CAAO;AAhBP,IAAArF,EAAA;AAiBN,SAAK,UAAUyG;AAAA,EACjB;AAAA,EAhBA,WAAoB,iBAAiB;AACnC,WAAO,QAAQ,MAAM,YAAY,MAAM,gBAAgB;AAAA,MACrD,IAAI;AAAA,MACJ,UAAU;AAAA,MACV,OAAO;AAAA,MACP,OAAO;AAAA,MACP,QAAQ;AAAA,MACR,SAAS,CAAC,yBAAyB,SAAS;AAAA,MAC5C,WAAW;AAAA,MACX,MAAM,CAAC,EAAE,aAAa,SAAS,iBAAiB,YAAY,SAAS,UAAA,CAAW;AAAA,IAAA,CACjF;AAAA,EACH;AAAA,EAOS,UAAuB;AAC9B,UAAMC,IAAQ,KAAK,QAAQ,YAAA,GACrBC,IAAQ,KAAK,QAAQ,SAAA;AAE3B,WAAO;AAAA,MACL,OAAOD,EAAM,IAAI,OAAQ,KAAK,gBAAgBE,CAAI,CAAC;AAAA,MACnD,OAAO;AAAA,QACL,OAAOD,EAAM;AAAA,QACb,WAAWA,EAAM;AAAA,MAAA;AAAA,IACnB;AAAA,EAEJ;AAAA,EAEQ,gBAAgBC,GAAwC;AAC9D,WAAO;AAAA,MACL,IAAIA,EAAK;AAAA,MACT,MAAMA,EAAK;AAAA,MACX,KAAKA,EAAK;AAAA,MACV,UAAU9F,EAAW8F,EAAK,QAAQ;AAAA,MAClC,iBAAiBA,EAAK;AAAA,MACtB,MAAMA,EAAK;AAAA,MACX,UAAUA,EAAK;AAAA,MACf,OAAO,KAAK,mBAAmBA,EAAK,IAAI;AAAA,IAAA;AAAA,EAE5C;AAAA,EAEQ,mBAAmBC,GAAwB;AAEjD,UAAMC,IAAYD,EAAK,IAAI,CAAApE,MAAKA,EAAE,aAAa;AAC/C,WAAIqE,EAAU,KAAK,CAAArE,MAAKA,EAAE,SAAS,OAAO,CAAC,IAAU,UACjDqE,EAAU,KAAK,CAAArE,MAAKA,EAAE,SAAS,SAAS,KAAKA,EAAE,SAAS,UAAU,CAAC,IAAU,aAC7EqE,EAAU,KAAK,CAAArE,MAAKA,EAAE,SAAS,KAAK,KAAKA,EAAE,SAAS,QAAQ,CAAC,IAAU,QACpE;AAAA,EACT;AAAA,EAES,kBAAkBgD,GAAoB;AAC7C,UAAM,kBAAkBA,CAAI,GAG5BA,EAAK,KAAK,2BAA2B,EAAE,GAAG,SAAS,KAAK,WAAW,KAAK,IAAI,CAAC,GAG7EA,EAAK,KAAK,iCAAiC,EAAE,GAAG,SAAS,KAAK,iBAAiB,KAAK,IAAI,CAAC,GACzFA,EAAK,KAAK,8BAA8B,EAAE,GAAG,SAAS,KAAK,cAAc,KAAK,IAAI,CAAC,GAEnFlG,EAAO,MAAM,qCAAqC;AAAA,EACpD;AAAA;AAAA;AAAA;AAAA,EAMA,MAAc,WAAWmG,GAAyC;AAChE,IAAAA,EAAM,eAAA,GAEK,IAAI,WAAW;AAAA,MACxB,MAAM;AAAA,MACN,UAAU,OAAOS,MAAiB;AAChC,cAAM,KAAK,iBAAiBA,CAAI;AAAA,MAClC;AAAA,IAAA,CACD,EACE,OAAO,EAAI;AAAA,EAChB;AAAA,EAEA,MAAc,iBAAiBA,GAAcpG,IAAoB,SAAwB;AXhH3F,QAAAL,GAAA0G;AWiHI,QAAI;AACF,YAAMQ,IAAO,MAAM,KAAK,QAAQ,QAAQT,GAAM,QAAWpG,CAAK;AAC9D,WAAK,OAAA,IACLL,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK,qBAAqBkH,EAAK,IAAI;AAAA,IACvD,SAASrG,GAAO;AACd,MAAAhB,EAAO,MAAM,mCAAmCgB,CAAK;AACrD,YAAM8F,IAAe9F,aAAiB,QAAQA,EAAM,UAAU;AAC9D,OAAA6F,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM,wBAAwBC,CAAY;AAAA,IAC9D;AAAA,EACF;AAAA,EAEA,MAAc,iBAAiBX,GAAyC;AX5H1E,QAAAhG,GAAA0G;AW6HI,IAAAV,EAAM,eAAA;AACN,UAAMqB,IAAS,EAAErB,EAAM,aAAa,EAAE,QAAQ,gBAAgB,EAAE,KAAK,SAAS;AAE9E,QAAI;AACF,YAAMsB,IAAa,KAAK,QAAQ,eAAeD,CAAM;AACrD,WAAK,OAAA,IACLrH,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAKsH,IAAa,uBAAuB;AAAA,IAC7D,SAASzG,GAAO;AACd,MAAAhB,EAAO,MAAM,8BAA8BgB,CAAK,IAChD6F,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM;AAAA,IAC1B;AAAA,EACF;AAAA,EAEA,MAAc,cAAcV,GAAyC;AX1IvE,QAAAhG,GAAA0G,GAAAa;AW2II,IAAAvB,EAAM,eAAA;AACN,UAAMqB,IAAS,EAAErB,EAAM,aAAa,EAAE,QAAQ,gBAAgB,EAAE,KAAK,SAAS,GACxEkB,IAAO,KAAK,QAAQ,QAAQG,CAAM;AAExC,QAAI,CAACH,GAAM;AACT,OAAAlH,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM;AACxB;AAAA,IACF;AAWA,QATkB,MAAM,OAAO,QAAQ;AAAA,MACrC,OAAO;AAAA,MACP,SAAS,8CAA8CkH,EAAK,IAAI;AAAA;AAAA,MAEhE,KAAK,MAAM;AAAA,MACX,IAAI,MAAM;AAAA,MACV,YAAY;AAAA,IAAA,CACb;AAGC,UAAI;AACF,aAAK,QAAQ,WAAWG,CAAM,GAC9B,KAAK,OAAA,IACLX,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK,YAAYQ,EAAK,IAAI;AAAA,MAC9C,SAASrG,GAAO;AACd,QAAAhB,EAAO,MAAM,2BAA2BgB,CAAK,IAC7C0G,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM;AAAA,MAC1B;AAAA,EAEJ;AACF;ACjKA,MAAMnF,IAAY,yBACZoF,IAAkB;AAEjB,MAAMC,EAAe;AAAA,EAQ1B,cAAc;AAPN,IAAAnH,EAAA,mCAAsC,IAAA;AACtC,IAAAA,EAAA,uBAAgB;AAEhB,IAAAA,EAAA,uBAAgBkF,EAAS,MAAM;AACrC,WAAK,eAAA;AAAA,IACP,GAAG,GAAG;AAGJ,SAAK,iBAAA;AAAA,EACP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,MAAM,QAAQjF,GAAamH,GAAerH,IAAoB,SAA+B;AAE3F,UAAMsC,IAAaT,EAAkB3B,CAAG;AACxC,QAAI,CAACoC,EAAW;AACd,YAAM,IAAI,MAAMA,EAAW,SAAS,oBAAoB;AAI1D,UAAMgF,IAAWD,KAAQ,KAAK,mBAAmBnH,CAAG,GAG9CqH,IAAgB,KAAK,UAAUrH,CAAG;AACxC,QAAIqH;AACF,YAAM,IAAI,MAAM,uCAAuCA,EAAc,IAAI,EAAE;AAK7E,QADuB,KAAK,WAAWD,CAAQ;AAE7C,YAAM,IAAI,MAAM,oBAAoBA,CAAQ,6BAA6B;AAG3E,UAAM5C,IAAM,KAAK,IAAA,GACXmC,IAAoB;AAAA,MACxB,IAAI1F,EAAA;AAAA,MACJ,KAAAjB;AAAA,MACA,MAAMoH;AAAA,MACN,MAAM,CAAA;AAAA,MACN,UAAU;AAAA,MACV,UAAU;AAAA,MACV,SAAS5C;AAAA,MACT,WAAWA;AAAA,IAAA;AAGb,gBAAK,MAAM,IAAImC,EAAK,IAAIA,CAAI,GAC5B,KAAK,aAAA,GAELrH,EAAO,KAAK,uBAAuBqH,EAAK,IAAI,KAAKA,EAAK,EAAE,GAAG,GACpDA;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAKA,WAAWhH,GAAY2H,GAA4C;AACjE,UAAMX,IAAO,KAAK,MAAM,IAAIhH,CAAE;AAC9B,QAAI,CAACgH;AACH,YAAM,IAAI,MAAM,2BAA2BhH,CAAE,EAAE;AAIjD,QAAI2H,EAAQ,QAAQA,EAAQ,SAASX,EAAK,MAAM;AAC9C,YAAMY,IAAiB,KAAK,WAAWD,EAAQ,IAAI;AACnD,UAAIC,KAAkBA,EAAe,OAAO5H;AAC1C,cAAM,IAAI,MAAM,oBAAoB2H,EAAQ,IAAI,kBAAkB;AAAA,IAEtE;AAGA,QAAIA,EAAQ,OAAOA,EAAQ,QAAQX,EAAK,KAAK;AAC3C,YAAMvE,IAAaT,EAAkB2F,EAAQ,GAAG;AAChD,UAAI,CAAClF,EAAW;AACd,cAAM,IAAI,MAAMA,EAAW,SAAS,oBAAoB;AAG1D,YAAMiF,IAAgB,KAAK,UAAUC,EAAQ,GAAG;AAChD,UAAID,KAAiBA,EAAc,OAAO1H;AACxC,cAAM,IAAI,MAAM,uCAAuC0H,EAAc,IAAI,EAAE;AAAA,IAE/E;AAGA,WAAOC,EAAQ;AAGf,UAAME,IAAU;AAAA,MACd,GAAGb;AAAA,MACH,GAAGW;AAAA,MACH,WAAW,KAAK,IAAA;AAAA,IAAI;AAGtB,gBAAK,MAAM,IAAI3H,GAAI6H,CAAO,GAC1B,KAAK,aAAA,GAELlI,EAAO,KAAK,yBAAyBkI,EAAQ,IAAI,EAAE,GAC5CA;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAKA,WAAW7H,GAAkB;AAC3B,UAAMgH,IAAO,KAAK,MAAM,IAAIhH,CAAE;AAC9B,QAAI,CAACgH;AACH,YAAM,IAAI,MAAM,2BAA2BhH,CAAE,EAAE;AAGjD,SAAK,MAAM,OAAOA,CAAE,GACpB,KAAK,aAAA,GAELL,EAAO,KAAK,yBAAyBqH,EAAK,IAAI,EAAE;AAAA,EAClD;AAAA;AAAA;AAAA;AAAA,EAKA,QAAQhH,GAAqC;AAC3C,WAAO,KAAK,MAAM,IAAIA,CAAE;AAAA,EAC1B;AAAA;AAAA;AAAA;AAAA,EAKA,cAA6B;AAC3B,WAAO,MAAM,KAAK,KAAK,MAAM,QAAQ;AAAA,EACvC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,UAAUK,GAAsC;AAC9C,WAAO,MAAM,KAAK,KAAK,MAAM,OAAA,CAAQ,EAAE,KAAK,CAAA2G,MAAQA,EAAK,QAAQ3G,CAAG;AAAA,EACtE;AAAA;AAAA;AAAA;AAAA,EAKA,WAAWmH,GAAuC;AAChD,WAAO,MAAM,KAAK,KAAK,MAAM,OAAA,CAAQ,EAAE,KAAK,CAAAR,MAAQA,EAAK,SAASQ,CAAI;AAAA,EACxE;AAAA;AAAA;AAAA;AAAA,EAKA,aAAaM,GAA8B;AACzC,UAAMC,IAAaD,EAAM,YAAA;AACzB,WAAO,KAAK,cAAc;AAAA,MAAO,OAC/Bd,EAAK,KAAK,YAAA,EAAc,SAASe,CAAU;AAAA,IAAA;AAAA,EAE/C;AAAA;AAAA;AAAA;AAAA,EAKA,aAAad,GAA+B;AAC1C,WAAIA,EAAK,WAAW,IAAU,KAAK,YAAA,IAE5B,KAAK,cAAc;AAAA,MAAO,CAAAD,MAC/BA,EAAK,KAAK,KAAK,OAAOC,EAAK,SAASe,CAAG,CAAC;AAAA,IAAA;AAAA,EAE5C;AAAA;AAAA;AAAA;AAAA,EAKA,eAA8B;AAC5B,WAAO,KAAK,cAAc,OAAO,CAAAhB,MAAQA,EAAK,QAAQ;AAAA,EACxD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,aAAuB;AACrB,UAAMiB,wBAAa,IAAA;AACnB,gBAAK,MAAM,QAAQ,CAAAjB,MAAQ;AACzB,MAAAA,EAAK,KAAK,QAAQ,CAAAgB,MAAOC,EAAO,IAAID,CAAG,CAAC;AAAA,IAC1C,CAAC,GACM,MAAM,KAAKC,CAAM,EAAE,KAAA;AAAA,EAC5B;AAAA;AAAA;AAAA;AAAA,EAKA,aAAad,GAAgBa,GAAmB;AAC9C,UAAMhB,IAAO,KAAK,QAAQG,CAAM;AAChC,QAAI,CAACH;AACH,YAAM,IAAI,MAAM,2BAA2BG,CAAM,EAAE;AAGrD,IAAKH,EAAK,KAAK,SAASgB,CAAG,MACzBhB,EAAK,KAAK,KAAKgB,CAAG,GAClBhB,EAAK,YAAY,KAAK,IAAA,GACtB,KAAK,aAAA;AAAA,EAET;AAAA;AAAA;AAAA;AAAA,EAKA,kBAAkBG,GAAgBa,GAAmB;AACnD,UAAMhB,IAAO,KAAK,QAAQG,CAAM;AAChC,QAAI,CAACH;AACH,YAAM,IAAI,MAAM,2BAA2BG,CAAM,EAAE;AAGrD,UAAMe,IAAQlB,EAAK,KAAK,QAAQgB,CAAG;AACnC,IAAIE,MAAU,OACZlB,EAAK,KAAK,OAAOkB,GAAO,CAAC,GACzBlB,EAAK,YAAY,KAAK,IAAA,GACtB,KAAK,aAAA;AAAA,EAET;AAAA;AAAA;AAAA;AAAA,EAKA,UAAUmB,GAAgBC,GAAwB;AAChD,QAAIC,IAAQ;AACZ,gBAAK,MAAM,QAAQ,CAAArB,MAAQ;AACzB,YAAMkB,IAAQlB,EAAK,KAAK,QAAQmB,CAAM;AACtC,MAAID,MAAU,OACZlB,EAAK,KAAKkB,CAAK,IAAIE,GACnBpB,EAAK,YAAY,KAAK,IAAA,GACtBqB;AAAA,IAEJ,CAAC,GAEGA,IAAQ,MACV,KAAK,aAAA,GACL1I,EAAO,KAAK,iBAAiBwI,CAAM,QAAQC,CAAM,MAAMC,CAAK,SAAS,IAGhEA;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAKA,UAAUL,GAAqB;AAC7B,QAAIK,IAAQ;AACZ,gBAAK,MAAM,QAAQ,CAAArB,MAAQ;AACzB,YAAMkB,IAAQlB,EAAK,KAAK,QAAQgB,CAAG;AACnC,MAAIE,MAAU,OACZlB,EAAK,KAAK,OAAOkB,GAAO,CAAC,GACzBlB,EAAK,YAAY,KAAK,IAAA,GACtBqB;AAAA,IAEJ,CAAC,GAEGA,IAAQ,MACV,KAAK,aAAA,GACL1I,EAAO,KAAK,iBAAiBqI,CAAG,MAAMK,CAAK,SAAS,IAG/CA;AAAA,EACT;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,eAAelB,GAAyB;AACtC,UAAMH,IAAO,KAAK,QAAQG,CAAM;AAChC,QAAI,CAACH;AACH,YAAM,IAAI,MAAM,2BAA2BG,CAAM,EAAE;AAGrD,WAAAH,EAAK,WAAW,CAACA,EAAK,UACtBA,EAAK,YAAY,KAAK,IAAA,GACtB,KAAK,aAAA,GAEEA,EAAK;AAAA,EACd;AAAA;AAAA;AAAA;AAAA,EAMQ,mBAAyB;AAC/B,QAAI;AACF,YAAML,IAAQ,KAAK,SAAS,IAAIzE,GAAW,cAAc;AACzD,UAAI,CAACyE,GAAO;AACV,QAAAhH,EAAO,KAAK,wCAAwC;AACpD;AAAA,MACF;AAEA,YAAM0C,IAAsB,KAAK,MAAMsE,CAAK;AAG5C,MAAItE,EAAM,YAAYiF,KACpB3H,EAAO,KAAK,6BAA6B0C,EAAM,OAAO,MAAMiF,CAAe,EAAE,GAK/E,KAAK,MAAM,MAAA,GACX,OAAO,OAAOjF,EAAM,KAAK,EAAE,QAAQ,CAAA2E,MAAQ;AACzC,aAAK,MAAM,IAAIA,EAAK,IAAIA,CAAI;AAAA,MAC9B,CAAC,GAEDrH,EAAO,KAAK,mBAAmB,KAAK,MAAM,IAAI,QAAQ;AAAA,IACxD,SAASgB,GAAO;AACd,MAAAhB,EAAO,MAAM,iCAAiCgB,CAAK;AAAA,IACrD;AAAA,EACF;AAAA,EAEQ,iBAAuB;AAC7B,QAAI;AACF,YAAM0B,IAAsB;AAAA,QAC1B,OAAO,OAAO,YAAY,KAAK,KAAK;AAAA,QACpC,WAAW,CAAA;AAAA,QACX,SAASiF;AAAA,QACT,cAAc,KAAK,IAAA;AAAA,MAAI;AAGzB,WAAK,SAAS,IAAIpF,GAAW,gBAAgB,KAAK,UAAUG,CAAK,CAAC,GAClE,KAAK,gBAAgB,IAErB1C,EAAO,MAAM,kBAAkB,KAAK,MAAM,IAAI,QAAQ;AAAA,IACxD,SAASgB,GAAO;AACd,MAAAhB,EAAO,MAAM,iCAAiCgB,CAAK;AAAA,IACrD;AAAA,EACF;AAAA,EAEQ,eAAqB;AAC3B,SAAK,cAAA;AAAA,EACP;AAAA;AAAA;AAAA;AAAA,EAMQ,mBAAmBN,GAAqB;AAC9C,QAAI;AAEF,YAAMuF,IADU,mBAAmBvF,CAAG,EAChB,MAAM,GAAG;AAE/B,aADiBuF,EAAMA,EAAM,SAAS,CAAC,EACvB,QAAQ,YAAY,EAAE;AAAA,IACxC,QAAQ;AACN,aAAO;AAAA,IACT;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,WAAW;AACT,UAAMkB,IAAQ,KAAK,YAAA;AACnB,WAAO;AAAA,MACL,YAAYA,EAAM;AAAA,MAClB,eAAeA,EAAM,OAAO,CAAAwB,MAAKA,EAAE,QAAQ,EAAE;AAAA,MAC7C,eAAexB,EAAM,OAAO,CAACyB,GAAKD,MAAMC,IAAMD,EAAE,UAAU,CAAC;AAAA,MAC3D,UAAU,KAAK,aAAa;AAAA,IAAA;AAAA,EAEhC;AAAA;AAAA;AAAA;AAAA,EAKA,QAAc;AACZ,SAAK,MAAM,MAAA,GACX,KAAK,aAAA,GACL3I,EAAO,KAAK,iBAAiB;AAAA,EAC/B;AAAA;AAAA;AAAA;AAAA,EAKA,UAAgB;AAEd,IAAI,KAAK,iBACP,KAAK,eAAA;AAAA,EAET;AACF;AC1YA,MAAMuC,IAAY;AAGlB,IAAIsG,IAA+B,MAC/BC,IAAiC,MACjCC,IAAqC,MACrCC,IAAwC,MAGxCC,IAAyC,MACzCC,IAAwC,MAGxCC,IAAsC;AAmB1C,MAAM,GAAG,0BAA0B,CAACC,MAAkC;Ab1CtE,MAAAjJ;Aa2CE,UAAQ,IAAI,mBAAmBiJ,CAAQ;AAEvC,QAAMC,MAAOlJ,IAAA,KAAK,SAAL,gBAAAA,EAAW,SAAQ,IAE1BmJ,IAA6B;AAAA,IACjC,cAAc;AAAA,MACZ,MAAM;AAAA,MACN,OAAOD,IAAO,gBAAgB;AAAA,MAC9B,MAAMA,IAAO,qBAAqB;AAAA,MAClC,QAAQ;AAAA,MACR,SAAS,MAAA;AbrDf,YAAAlJ;AaqDqB,gBAAAA,IAAA,OAAO,QAAP,gBAAAA,EAAY;AAAA;AAAA,IAAU;AAAA,EACvC;AAIF,EAAIkJ,MACFC,EAAM,cAAc,IAAI;AAAA,IACtB,MAAM;AAAA,IACN,OAAO;AAAA,IACP,MAAM;AAAA,IACN,QAAQ;AAAA,IACR,SAAS,MAAA;AbhEf,UAAAnJ,GAAA0G;AagEqB,cAAAA,KAAA1G,IAAA,OAAO,QAAP,gBAAAA,EAAY,gBAAZ,gBAAA0G,EAAA,KAAA1G;AAAA;AAAA,EAA0B,IAI7CiJ,EAAS,uBAAuB,IAAI;AAAA,IAClC,MAAM;AAAA,IACN,OAAOC,IAAO,0BAA0B;AAAA,IACxC,MAAMA,IAAO,qBAAqB;AAAA,IAClC,SAAS;AAAA,IACT,OAAAC;AAAA,EAAA;AAEJ,CAAC;AAKD,MAAM,KAAK,QAAQ,MAAM;AACvB,EAAAtJ,EAAO,KAAK,uCAAuC,GACnDuJ,GAAA;AACF,CAAC;AAED,MAAM,KAAK,SAAS,YAAY;AbrFhC,MAAApJ;AasFE,QAAMkJ,MAAOlJ,IAAA,KAAK,SAAL,gBAAAA,EAAW,SAAQ;AAChC,EAAAH,EAAO,KAAK,mCAAmCqJ,IAAO,OAAO,QAAQ,MAAM,GAE3EF,IAAgB,IAAI/E,EAAA,GAEhBiF,IACF,MAAMG,GAAA,IAEN,MAAMC,GAAA,GAGR,OAAO,MAAM;AAAA,IACX,MAAAJ;AAAA,IACA,WAAWA,IAAOK,KAAYC;AAAA,IAC9B,aAAaN,IAAOO,KAAc;AAAA,IAClC,QAAQP,IAAOR,KAAY,SAAYI,KAAgB;AAAA,IACvD,QAAQE,KAAiB;AAAA,IACzB,SAASE,IAAOL,KAAkB,SAAY;AAAA,EAAA,GAGhDa,GAAA,GAEA7J,EAAO,KAAK,6BAA6B;AAC3C,CAAC;AAED,eAAewJ,KAA8B;AAC3C,EAAAR,IAAiB,IAAIpB,EAAA,GACrBiB,IAAW,IAAIpG,EAAA,GACf0G,EAAe,eAAeN,CAAQ,GAEtC,MAAMA,EAAS,eAAA;AACjB;AAEA,eAAeY,KAAkC;AAC/C,EAAAR,IAAe,IAAIxF,EAAA,GACnB0F,EAAe,mBAAmBF,CAAY;AAG9C,QAAMa,IAAc/C,EAAkB,gBAAA;AACtC,EAAAkC,EAAa,eAAea,CAAW;AACzC;AAMA,SAASJ,KAAkB;AACzB,EAAI,CAACb,KAAY,CAACM,MAEdL,KAAYA,EAAS,WACvBA,EAAS,WAAA,KAETA,IAAW,IAAIlD,EAAciD,GAAUM,CAAa,GACpDL,EAAS,OAAO,EAAI;AAExB;AAEA,SAASa,KAAwB;AAC/B,EAAKV,MAEDC,KAAeA,EAAY,WAC7BA,EAAY,WAAA,KAEZA,IAAc,IAAInC,EAAkBkC,CAAY,GAChDC,EAAY,OAAO,EAAI;AAE3B;AAEA,SAASU,KAAoB;AAC3B,EAAKZ,MAEDD,KAAcA,EAAW,WAC3BA,EAAW,WAAA,KAEXA,IAAa,IAAI9B,EAAgB+B,CAAc,GAC/CD,EAAW,OAAO,EAAI;AAE1B;AAQA,SAASc,KAA6B;AACpC,QAAME,IAAc,MAAM;AACxB,IAAAlB,KAAA,QAAAA,EAAU,UACVI,KAAA,QAAAA,EAAc;AAAA,EAChB;AAEA,WAAS,iBAAiB,SAASc,GAAa,EAAE,MAAM,IAAM,GAC9D,SAAS,iBAAiB,WAAWA,GAAa,EAAE,MAAM,IAAM,GAEhE,MAAM,KAAK,eAAeA,CAAW;AACvC;AAMA,SAASR,KAAyB;AAChC,OAAK,SAAS,SAAShH,GAAW,cAAc;AAAA,IAC9C,MAAM;AAAA,IACN,MAAM;AAAA,IACN,OAAO;AAAA,IACP,QAAQ;AAAA,IACR,MAAM;AAAA,IACN,SAAS;AAAA,EAAA,CACV,GAED,KAAK,SAAS,SAASA,GAAW,yBAAyB;AAAA,IACzD,MAAM;AAAA,IACN,MAAM;AAAA,IACN,OAAO;AAAA,IACP,QAAQ;AAAA,IACR,MAAM;AAAA,IACN,SAAS;AAAA,IACT,OAAO;AAAA,MACL,KAAK;AAAA,MACL,KAAK;AAAA,MACL,MAAM;AAAA,IAAA;AAAA,EACR,CACD,GAED,KAAK,SAAS,SAASA,GAAW,gBAAgB;AAAA,IAChD,MAAM;AAAA,IACN,MAAM;AAAA,IACN,OAAO;AAAA,IACP,QAAQ;AAAA,IACR,MAAM;AAAA,IACN,SAAS;AAAA,EAAA,CACV;AACH;AAMA,MAAM,KAAK,aAAa,MAAM;AAC5B,EAAAuG,KAAA,QAAAA,EAAU,SACVC,KAAA,QAAAA,EAAY,SACZG,KAAA,QAAAA,EAAa,SACbC,KAAA,QAAAA,EAAe,WACfN,KAAA,QAAAA,EAAU,WACVI,KAAA,QAAAA,EAAc,WACdD,KAAA,QAAAA,EAAgB;AAClB,CAAC;"}
>>>>>>> 04cbfef55a95e5646b55c99bac7fd7ae47f2bd12
=======
{"version":3,"file":"module.js","sources":["../src/utils/logger.ts","../src/core/StreamingPlayer.ts","../src/utils/time.ts","../src/utils/uuid.ts","../src/utils/audio-validation.ts","../src/core/AudioEngine.ts","../src/core/PlayerAudioEngine.ts","../src/sync/SocketManager.ts","../src/utils/throttle.ts","../src/ui/SoundMixerApp.ts","../src/ui/PlayerVolumePanel.ts","../src/ui/LocalLibraryApp.ts","../src/library/PlaylistManager.ts","../src/library/LibraryManager.ts","../src/module.ts"],"sourcesContent":["const PREFIX = 'ASE';\n\nexport const Logger = {\n  info: (message: string, ...args: unknown[]) => {\n    console.log(`${PREFIX} | ${message}`, ...args);\n  },\n  \n  warn: (message: string, ...args: unknown[]) => {\n    console.warn(`${PREFIX} | ${message}`, ...args);\n  },\n  \n  error: (message: string, ...args: unknown[]) => {\n    console.error(`${PREFIX} | ${message}`, ...args);\n  },\n  \n  debug: (message: string, ...args: unknown[]) => {\n    if (CONFIG?.debug?.audio) {\n      console.debug(`${PREFIX} | ${message}`, ...args);\n    }\n  }\n};","import type { TrackGroup, PlaybackState } from '@t/audio';\nimport { Logger } from '@utils/logger';\n\nexport class StreamingPlayer {\n  readonly id: string;\n  private ctx: AudioContext;\n  private _group: TrackGroup;\n  private _url: string = '';\n  \n  private audio: HTMLAudioElement;\n  private sourceNode: MediaElementAudioSourceNode | null = null;\n  private gainNode: GainNode;\n  private outputNode: GainNode;\n  \n  private _state: PlaybackState = 'stopped';\n  private _volume: number = 1;\n  private _loop: boolean = false;\n  private _ready: boolean = false;\n\n  constructor(\n    id: string,\n    ctx: AudioContext,\n    channelOutput: GainNode,\n    group: TrackGroup = 'music'\n  ) {\n    this.id = id;\n    this.ctx = ctx;\n    this._group = group;\n    \n    this.audio = new Audio();\n    this.audio.crossOrigin = 'anonymous';\n    this.audio.preload = 'auto';\n    \n    this.gainNode = ctx.createGain();\n    this.outputNode = ctx.createGain();\n    \n    this.gainNode.connect(this.outputNode);\n    this.outputNode.connect(channelOutput);\n    \n    this.setupAudioEvents();\n  }\n\n  private setupAudioEvents(): void {\n    this.audio.addEventListener('canplay', () => {\n      this._ready = true;\n      if (this._state === 'loading') {\n        this._state = 'stopped';\n      }\n      Logger.debug(`Track ${this.id} ready to play`);\n    });\n\n    this.audio.addEventListener('ended', () => {\n      if (!this._loop) {\n        this._state = 'stopped';\n        Logger.debug(`Track ${this.id} ended`);\n      }\n    });\n\n    this.audio.addEventListener('error', (e) => {\n      Logger.error(`Track ${this.id} error:`, this.audio.error);\n      this._state = 'stopped';\n    });\n  }\n\n  get state(): PlaybackState {\n    return this._state;\n  }\n\n  get group(): TrackGroup {\n    return this._group;\n  }\n\n  get url(): string {\n    return this._url;\n  }\n\n  get volume(): number {\n    return this._volume;\n  }\n\n  get loop(): boolean {\n    return this._loop;\n  }\n\n  get ready(): boolean {\n    return this._ready;\n  }\n\n  async load(url: string): Promise<void> {\n    this._state = 'loading';\n    this._url = url;\n    this._ready = false;\n\n    return new Promise((resolve, reject) => {\n      const onCanPlay = () => {\n        this.audio.removeEventListener('canplay', onCanPlay);\n        this.audio.removeEventListener('error', onError);\n        \n        // Connect to Web Audio\n        if (!this.sourceNode) {\n          this.sourceNode = this.ctx.createMediaElementSource(this.audio);\n          this.sourceNode.connect(this.gainNode);\n        }\n        \n        this._ready = true;\n        this._state = 'stopped';\n        Logger.debug(`Track loaded: ${this.id}`);\n        resolve();\n      };\n\n      const onError = () => {\n        this.audio.removeEventListener('canplay', onCanPlay);\n        this.audio.removeEventListener('error', onError);\n        this._state = 'stopped';\n        reject(new Error(`Failed to load: ${url}`));\n      };\n\n      this.audio.addEventListener('canplay', onCanPlay, { once: true });\n      this.audio.addEventListener('error', onError, { once: true });\n      \n      this.audio.src = url;\n      this.audio.load();\n    });\n  }\n\n  async play(offset: number = 0): Promise<void> {\n    if (!this._ready) {\n      Logger.warn(`Track ${this.id} not ready`);\n      return;\n    }\n\n    try {\n      this.audio.currentTime = Math.max(0, Math.min(offset, this.audio.duration || 0));\n      this.audio.loop = this._loop;\n      await this.audio.play();\n      this._state = 'playing';\n      Logger.debug(`Track ${this.id} playing from ${offset.toFixed(2)}s`);\n    } catch (error) {\n      Logger.error(`Failed to play ${this.id}:`, error);\n    }\n  }\n\n  pause(): void {\n    if (this._state !== 'playing') return;\n    \n    this.audio.pause();\n    this._state = 'paused';\n    Logger.debug(`Track ${this.id} paused at ${this.audio.currentTime.toFixed(2)}s`);\n  }\n\n  stop(): void {\n    this.audio.pause();\n    this.audio.currentTime = 0;\n    this._state = 'stopped';\n    Logger.debug(`Track ${this.id} stopped`);\n  }\n\n  seek(time: number): void {\n    const safeTime = Math.max(0, Math.min(time, this.audio.duration || 0));\n    this.audio.currentTime = safeTime;\n  }\n\n  setVolume(value: number): void {\n    this._volume = Math.max(0, Math.min(1, value));\n    this.gainNode.gain.setValueAtTime(this._volume, this.ctx.currentTime);\n  }\n\n  setLoop(value: boolean): void {\n    this._loop = value;\n    this.audio.loop = value;\n  }\n\n  setChannel(newGroup: TrackGroup, newOutput: GainNode): void {\n    this._group = newGroup;\n    this.outputNode.disconnect();\n    this.outputNode.connect(newOutput);\n  }\n\n  getCurrentTime(): number {\n    return this.audio.currentTime;\n  }\n\n  getDuration(): number {\n    return this.audio.duration || 0;\n  }\n\n  getState() {\n    return {\n      id: this.id,\n      url: this._url,\n      group: this._group,\n      playbackState: this._state,\n      volume: this._volume,\n      loop: this._loop,\n      currentTime: this.getCurrentTime(),\n      duration: this.getDuration()\n    };\n  }\n\n  dispose(): void {\n    this.audio.pause();\n    this.audio.src = '';\n    this.sourceNode?.disconnect();\n    this.gainNode.disconnect();\n    this.outputNode.disconnect();\n    Logger.debug(`Track ${this.id} disposed`);\n  }\n}","/**\n * Get current server time (for sync calculations)\n */\nexport function getServerTime(): number {\n  // Foundry's game.time.serverTime учитывает offset\n  return Date.now();\n}\n\n/**\n * Calculate playback offset based on start time\n */\nexport function calculateOffset(startedAt: number, pausedAt: number = 0): number {\n  if (pausedAt > 0) {\n    return pausedAt;\n  }\n  return (getServerTime() - startedAt) / 1000;\n}\n\n/**\n * Format seconds to mm:ss\n */\nexport function formatTime(seconds: number): string {\n  if (!isFinite(seconds) || seconds < 0) return '0:00';\n  \n  const mins = Math.floor(seconds / 60);\n  const secs = Math.floor(seconds % 60);\n  return `${mins}:${secs.toString().padStart(2, '0')}`;\n}","/**\n * Generate a UUID v4\n * Based on RFC 4122 standard\n */\nexport function generateUUID(): string {\n  // Use crypto.randomUUID if available (modern browsers/Node 19+)\n  if (typeof crypto !== 'undefined' && crypto.randomUUID) {\n    return crypto.randomUUID();\n  }\n\n  // Fallback: manual UUID v4 generation\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {\n    const r = Math.random() * 16 | 0;\n    const v = c === 'x' ? r : (r & 0x3 | 0x8);\n    return v.toString(16);\n  });\n}\n\n/**\n * Validate UUID format\n */\nexport function isValidUUID(uuid: string): boolean {\n  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;\n  return uuidRegex.test(uuid);\n}\n","/**\n * Поддерживаемые аудио форматы\n */\nexport const SUPPORTED_AUDIO_FORMATS = [\n  '.mp3',\n  '.ogg',\n  '.wav',\n  '.webm',\n  '.m4a',\n  '.aac',\n  '.flac',\n  '.opus'\n] as const;\n\nexport type SupportedAudioFormat = typeof SUPPORTED_AUDIO_FORMATS[number];\n\n/**\n * MIME типы для поддерживаемых форматов\n */\nexport const AUDIO_MIME_TYPES: Record<string, string> = {\n  '.mp3': 'audio/mpeg',\n  '.ogg': 'audio/ogg',\n  '.wav': 'audio/wav',\n  '.webm': 'audio/webm',\n  '.m4a': 'audio/mp4',\n  '.aac': 'audio/aac',\n  '.flac': 'audio/flac',\n  '.opus': 'audio/opus'\n};\n\n/**\n * Проверка, является ли файл поддерживаемым аудио форматом\n */\nexport function isValidAudioFormat(url: string): boolean {\n  const extension = getFileExtension(url);\n  return SUPPORTED_AUDIO_FORMATS.includes(extension as SupportedAudioFormat);\n}\n\n/**\n * Получить расширение файла из URL\n */\nexport function getFileExtension(url: string): string {\n  try {\n    // Decode URL first\n    const decoded = decodeURIComponent(url);\n\n    // Remove query parameters and hash\n    const cleanUrl = decoded.split('?')[0].split('#')[0];\n\n    // Extract extension\n    const match = cleanUrl.match(/\\.([a-z0-9]+)$/i);\n    return match ? `.${match[1].toLowerCase()}` : '';\n  } catch {\n    return '';\n  }\n}\n\n/**\n * Получить MIME тип для аудио файла\n */\nexport function getAudioMimeType(url: string): string | null {\n  const extension = getFileExtension(url);\n  return AUDIO_MIME_TYPES[extension] || null;\n}\n\n/**\n * Валидация результата с деталями ошибки\n */\nexport interface AudioValidationResult {\n  valid: boolean;\n  error?: string;\n  extension?: string;\n  mimeType?: string;\n}\n\n/**\n * Полная валидация аудио файла\n */\nexport function validateAudioFile(url: string): AudioValidationResult {\n  if (!url || typeof url !== 'string') {\n    return {\n      valid: false,\n      error: 'URL is required and must be a string'\n    };\n  }\n\n  const extension = getFileExtension(url);\n\n  if (!extension) {\n    return {\n      valid: false,\n      error: 'Could not extract file extension from URL'\n    };\n  }\n\n  if (!isValidAudioFormat(url)) {\n    return {\n      valid: false,\n      error: `Unsupported audio format: ${extension}. Supported formats: ${SUPPORTED_AUDIO_FORMATS.join(', ')}`,\n      extension\n    };\n  }\n\n  const mimeType = getAudioMimeType(url);\n\n  return {\n    valid: true,\n    extension,\n    mimeType: mimeType || undefined\n  };\n}\n\n/**\n * Проверка поддержки формата браузером\n */\nexport function isBrowserAudioSupported(extension: string): boolean {\n  if (typeof Audio === 'undefined') {\n    return false;\n  }\n\n  const mimeType = AUDIO_MIME_TYPES[extension];\n  if (!mimeType) {\n    return false;\n  }\n\n  const audio = new Audio();\n  const canPlay = audio.canPlayType(mimeType);\n\n  // Returns: '' (no support), 'maybe', 'probably'\n  return canPlay === 'probably' || canPlay === 'maybe';\n}\n","import type { TrackConfig, TrackState, MixerState, TrackGroup, ChannelVolumes } from '@t/audio';\nimport { StreamingPlayer } from './StreamingPlayer';\nimport { Logger } from '@utils/logger';\nimport { getServerTime } from '@utils/time';\nimport { generateUUID } from '@utils/uuid';\nimport { validateAudioFile } from '@utils/audio-validation';\n\nconst MODULE_ID = 'advanced-sound-engine';\n\nfunction getMaxSimultaneous(): number {\n  return (game.settings.get(MODULE_ID, 'maxSimultaneousTracks') as number) || 8;\n}\n\nexport class AudioEngine {\n  private ctx: AudioContext;\n  private masterGain: GainNode;\n  private channelGains: Record<TrackGroup, GainNode>;\n  private players: Map<string, StreamingPlayer> = new Map();\n  \n  private _volumes: ChannelVolumes = {\n    master: 1,\n    music: 1,\n    ambience: 1,\n    sfx: 1\n  };\n  \n  private saveTimeout: ReturnType<typeof setTimeout> | null = null;\n\n  constructor() {\n    this.ctx = new AudioContext();\n    \n    this.masterGain = this.ctx.createGain();\n    this.masterGain.connect(this.ctx.destination);\n    \n    this.channelGains = {\n      music: this.ctx.createGain(),\n      ambience: this.ctx.createGain(),\n      sfx: this.ctx.createGain()\n    };\n    \n    this.channelGains.music.connect(this.masterGain);\n    this.channelGains.ambience.connect(this.masterGain);\n    this.channelGains.sfx.connect(this.masterGain);\n    \n    Logger.info('AudioEngine initialized');\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Persistence (GM only)\n  // ─────────────────────────────────────────────────────────────\n\n  private scheduleSave(): void {\n    if (!game.user?.isGM) return;\n    \n    if (this.saveTimeout) {\n      clearTimeout(this.saveTimeout);\n    }\n    this.saveTimeout = setTimeout(() => {\n      this.saveState();\n    }, 500);\n  }\n\n  private async saveState(): Promise<void> {\n    if (!game.ready || !game.user?.isGM) return;\n    \n    const state = this.getState();\n    \n    try {\n      await game.settings.set(MODULE_ID, 'mixerState', JSON.stringify(state));\n      Logger.debug('Mixer state saved');\n    } catch (error) {\n      Logger.error('Failed to save mixer state:', error);\n    }\n  }\n\n  async loadSavedState(): Promise<void> {\n    if (!game.ready) return;\n    \n    try {\n      const savedJson = game.settings.get(MODULE_ID, 'mixerState') as string;\n      if (!savedJson) return;\n      \n      const state = JSON.parse(savedJson) as MixerState;\n      await this.restoreState(state);\n      \n      Logger.info('Mixer state restored');\n    } catch (error) {\n      Logger.error('Failed to load mixer state:', error);\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Track Management\n  // ─────────────────────────────────────────────────────────────\n\n  async createTrack(config: TrackConfig): Promise<StreamingPlayer> {\n    // Generate UUID if not provided\n    const trackId = config.id || generateUUID();\n\n    if (this.players.has(trackId)) {\n      return this.players.get(trackId)!;\n    }\n\n    // Validate audio file format\n    const validation = validateAudioFile(config.url);\n    if (!validation.valid) {\n      const error = new Error(validation.error || 'Invalid audio file');\n      Logger.error(`Track validation failed: ${validation.error}`);\n      throw error;\n    }\n\n    const channelOutput = this.channelGains[config.group];\n\n    const player = new StreamingPlayer(\n      trackId,\n      this.ctx,\n      channelOutput,\n      config.group\n    );\n\n    if (config.volume !== undefined) {\n      player.setVolume(config.volume);\n    }\n    if (config.loop !== undefined) {\n      player.setLoop(config.loop);\n    }\n\n    await player.load(config.url);\n\n    this.players.set(trackId, player);\n    this.scheduleSave();\n\n    Logger.info(`Track created: ${trackId} (${validation.extension})`);\n    return player;\n  }\n\n  getTrack(id: string): StreamingPlayer | undefined {\n    return this.players.get(id);\n  }\n\n  removeTrack(id: string): boolean {\n    const player = this.players.get(id);\n    if (!player) return false;\n\n    player.dispose();\n    this.players.delete(id);\n    this.scheduleSave();\n    \n    Logger.info(`Track removed: ${id}`);\n    return true;\n  }\n\n  getAllTracks(): StreamingPlayer[] {\n    return Array.from(this.players.values());\n  }\n\n  getTracksByGroup(group: TrackGroup): StreamingPlayer[] {\n    return this.getAllTracks().filter(t => t.group === group);\n  }\n\n  setTrackChannel(id: string, newGroup: TrackGroup): void {\n    const player = this.players.get(id);\n    if (!player) return;\n    \n    player.setChannel(newGroup, this.channelGains[newGroup]);\n    this.scheduleSave();\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Playback Control\n  // ─────────────────────────────────────────────────────────────\n\n  async playTrack(id: string, offset: number = 0): Promise<void> {\n    const player = this.players.get(id);\n    if (!player) {\n      Logger.warn(`Track not found: ${id}`);\n      return;\n    }\n\n    const maxSimultaneous = getMaxSimultaneous();\n    const playingCount = this.getAllTracks().filter(t => t.state === 'playing').length;\n    const isCurrentlyPlaying = player.state === 'playing';\n\n    if (!isCurrentlyPlaying && playingCount >= maxSimultaneous) {\n      Logger.warn(`Maximum simultaneous tracks (${maxSimultaneous}) reached`);\n      ui.notifications?.warn(`Cannot play more than ${maxSimultaneous} tracks simultaneously`);\n      return;\n    }\n\n    await player.play(offset);\n  }\n\n  pauseTrack(id: string): void {\n    this.players.get(id)?.pause();\n  }\n\n  stopTrack(id: string): void {\n    this.players.get(id)?.stop();\n  }\n\n  seekTrack(id: string, time: number): void {\n    this.players.get(id)?.seek(time);\n  }\n\n  setTrackVolume(id: string, volume: number): void {\n    this.players.get(id)?.setVolume(volume);\n    this.scheduleSave();\n  }\n\n  setTrackLoop(id: string, loop: boolean): void {\n    this.players.get(id)?.setLoop(loop);\n    this.scheduleSave();\n  }\n\n  stopAll(): void {\n    for (const player of this.players.values()) {\n      player.stop();\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Volume Control\n  // ─────────────────────────────────────────────────────────────\n\n  get volumes(): ChannelVolumes {\n    return { ...this._volumes };\n  }\n\n  setMasterVolume(value: number): void {\n    this._volumes.master = Math.max(0, Math.min(1, value));\n    this.masterGain.gain.linearRampToValueAtTime(\n      this._volumes.master,\n      this.ctx.currentTime + 0.01\n    );\n    this.scheduleSave();\n  }\n\n  setChannelVolume(channel: TrackGroup, value: number): void {\n    this._volumes[channel] = Math.max(0, Math.min(1, value));\n    this.channelGains[channel].gain.linearRampToValueAtTime(\n      this._volumes[channel],\n      this.ctx.currentTime + 0.01\n    );\n    this.scheduleSave();\n  }\n\n  getChannelVolume(channel: TrackGroup): number {\n    return this._volumes[channel];\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // State\n  // ─────────────────────────────────────────────────────────────\n\n  getState(): MixerState {\n    const tracks: TrackState[] = [];\n    \n    for (const player of this.players.values()) {\n      tracks.push(player.getState());\n    }\n\n    return {\n      masterVolume: this._volumes.master,\n      channelVolumes: { ...this._volumes },\n      tracks,\n      timestamp: getServerTime(),\n      syncEnabled: false\n    };\n  }\n\n  async restoreState(state: MixerState): Promise<void> {\n    // Restore volumes\n    this._volumes.master = state.masterVolume;\n    this.masterGain.gain.setValueAtTime(this._volumes.master, this.ctx.currentTime);\n    \n    if (state.channelVolumes) {\n      for (const channel of ['music', 'ambience', 'sfx'] as TrackGroup[]) {\n        this._volumes[channel] = state.channelVolumes[channel];\n        this.channelGains[channel].gain.setValueAtTime(this._volumes[channel], this.ctx.currentTime);\n      }\n    }\n\n    // Restore tracks (without playing)\n    for (const trackState of state.tracks) {\n      if (!this.players.has(trackState.id)) {\n        try {\n          await this.createTrack({\n            id: trackState.id,\n            url: trackState.url,\n            group: trackState.group,\n            volume: trackState.volume,\n            loop: trackState.loop\n          });\n        } catch (error) {\n          Logger.error(`Failed to restore track ${trackState.id}:`, error);\n        }\n      }\n    }\n\n    // Remove tracks not in state\n    const stateTrackIds = new Set(state.tracks.map(t => t.id));\n    for (const [id] of this.players) {\n      if (!stateTrackIds.has(id)) {\n        this.removeTrack(id);\n      }\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Audio Context\n  // ─────────────────────────────────────────────────────────────\n\n  async resume(): Promise<void> {\n    if (this.ctx.state === 'suspended') {\n      await this.ctx.resume();\n      Logger.info('AudioContext resumed');\n    }\n  }\n\n  get contextState(): AudioContextState {\n    return this.ctx.state;\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Cleanup\n  // ─────────────────────────────────────────────────────────────\n\n  dispose(): void {\n    if (this.saveTimeout) {\n      clearTimeout(this.saveTimeout);\n    }\n    for (const player of this.players.values()) {\n      player.dispose();\n    }\n    this.players.clear();\n    this.ctx.close();\n    Logger.info('AudioEngine disposed');\n  }\n}","import type { TrackGroup, ChannelVolumes, SyncTrackState, TrackPlayPayload } from '@t/audio';\nimport { StreamingPlayer } from './StreamingPlayer';\nimport { Logger } from '@utils/logger';\nimport { getServerTime } from '@utils/time';\n\n/**\n * Упрощенный движок для игроков — только получает команды\n */\nexport class PlayerAudioEngine {\n  private ctx: AudioContext;\n  private masterGain: GainNode;\n  private gmGain: GainNode; // Громкость от GM\n  private channelGains: Record<TrackGroup, GainNode>;\n  private players: Map<string, StreamingPlayer> = new Map();\n  \n  private _localVolume: number = 1; // Личная громкость игрока\n  private _gmVolumes: ChannelVolumes = {\n    master: 1,\n    music: 1,\n    ambience: 1,\n    sfx: 1\n  };\n\n  constructor() {\n    this.ctx = new AudioContext();\n    \n    // Chain: tracks -> channels -> gmGain -> masterGain -> destination\n    this.masterGain = this.ctx.createGain();\n    this.masterGain.connect(this.ctx.destination);\n    \n    this.gmGain = this.ctx.createGain();\n    this.gmGain.connect(this.masterGain);\n    \n    this.channelGains = {\n      music: this.ctx.createGain(),\n      ambience: this.ctx.createGain(),\n      sfx: this.ctx.createGain()\n    };\n    \n    this.channelGains.music.connect(this.gmGain);\n    this.channelGains.ambience.connect(this.gmGain);\n    this.channelGains.sfx.connect(this.gmGain);\n    \n    Logger.info('PlayerAudioEngine initialized');\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Local Volume (Player's personal control)\n  // ─────────────────────────────────────────────────────────────\n\n  get localVolume(): number {\n    return this._localVolume;\n  }\n\n  setLocalVolume(value: number): void {\n    this._localVolume = Math.max(0, Math.min(1, value));\n    this.masterGain.gain.linearRampToValueAtTime(\n      this._localVolume,\n      this.ctx.currentTime + 0.01\n    );\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // GM Volume (from sync)\n  // ─────────────────────────────────────────────────────────────\n\n  setGMVolume(channel: TrackGroup | 'master', value: number): void {\n    const safeValue = Math.max(0, Math.min(1, value));\n    \n    if (channel === 'master') {\n      this._gmVolumes.master = safeValue;\n      this.gmGain.gain.linearRampToValueAtTime(safeValue, this.ctx.currentTime + 0.01);\n    } else {\n      this._gmVolumes[channel] = safeValue;\n      this.channelGains[channel].gain.linearRampToValueAtTime(safeValue, this.ctx.currentTime + 0.01);\n    }\n  }\n\n  setAllGMVolumes(volumes: ChannelVolumes): void {\n    this._gmVolumes = { ...volumes };\n    \n    this.gmGain.gain.setValueAtTime(volumes.master, this.ctx.currentTime);\n    this.channelGains.music.gain.setValueAtTime(volumes.music, this.ctx.currentTime);\n    this.channelGains.ambience.gain.setValueAtTime(volumes.ambience, this.ctx.currentTime);\n    this.channelGains.sfx.gain.setValueAtTime(volumes.sfx, this.ctx.currentTime);\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Track Commands (from GM via socket)\n  // ─────────────────────────────────────────────────────────────\n\n  async handlePlay(payload: TrackPlayPayload): Promise<void> {\n    let player = this.players.get(payload.trackId);\n    \n    // Create if doesn't exist\n    if (!player) {\n      player = new StreamingPlayer(\n        payload.trackId,\n        this.ctx,\n        this.channelGains[payload.group],\n        payload.group\n      );\n      \n      await player.load(payload.url);\n      this.players.set(payload.trackId, player);\n    }\n    \n    player.setVolume(payload.volume);\n    player.setLoop(payload.loop);\n    \n    // Calculate offset based on time elapsed since GM started\n    const elapsed = (getServerTime() - payload.startTimestamp) / 1000;\n    const adjustedOffset = Math.max(0, payload.offset + elapsed);\n    \n    await player.play(adjustedOffset);\n    Logger.debug(`Player: track ${payload.trackId} playing at ${adjustedOffset.toFixed(2)}s`);\n  }\n\n  handlePause(trackId: string): void {\n    this.players.get(trackId)?.pause();\n  }\n\n  handleStop(trackId: string): void {\n    this.players.get(trackId)?.stop();\n  }\n\n  handleSeek(trackId: string, time: number, isPlaying: boolean, seekTimestamp: number): void {\n    const player = this.players.get(trackId);\n    if (!player) return;\n    \n    if (isPlaying) {\n      const elapsed = (getServerTime() - seekTimestamp) / 1000;\n      player.seek(time + elapsed);\n    } else {\n      player.seek(time);\n    }\n  }\n\n  handleTrackVolume(trackId: string, volume: number): void {\n    this.players.get(trackId)?.setVolume(volume);\n  }\n\n  handleTrackLoop(trackId: string, loop: boolean): void {\n    this.players.get(trackId)?.setLoop(loop);\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Sync State (full state from GM)\n  // ─────────────────────────────────────────────────────────────\n\n  async syncState(tracks: SyncTrackState[], volumes: ChannelVolumes): Promise<void> {\n    // Set volumes\n    this.setAllGMVolumes(volumes);\n    \n    // Handle tracks\n    const newTrackIds = new Set(tracks.map(t => t.id));\n    \n    // Remove tracks not in sync\n    for (const [id, player] of this.players) {\n      if (!newTrackIds.has(id)) {\n        player.dispose();\n        this.players.delete(id);\n      }\n    }\n    \n    // Add/update tracks\n    for (const trackState of tracks) {\n      let player = this.players.get(trackState.id);\n      \n      if (!player) {\n        player = new StreamingPlayer(\n          trackState.id,\n          this.ctx,\n          this.channelGains[trackState.group],\n          trackState.group\n        );\n        \n        await player.load(trackState.url);\n        this.players.set(trackState.id, player);\n      }\n      \n      player.setVolume(trackState.volume);\n      player.setLoop(trackState.loop);\n      \n      if (trackState.isPlaying) {\n        const elapsed = (getServerTime() - trackState.startTimestamp) / 1000;\n        const adjustedTime = trackState.currentTime + elapsed;\n        await player.play(adjustedTime);\n      } else {\n        player.stop();\n      }\n    }\n    \n    Logger.info('Player: synced state from GM');\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Sync Off\n  // ─────────────────────────────────────────────────────────────\n\n  stopAll(): void {\n    for (const player of this.players.values()) {\n      player.stop();\n    }\n  }\n\n  clearAll(): void {\n    for (const player of this.players.values()) {\n      player.dispose();\n    }\n    this.players.clear();\n    Logger.info('Player: all tracks cleared');\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Audio Context\n  // ─────────────────────────────────────────────────────────────\n\n  async resume(): Promise<void> {\n    if (this.ctx.state === 'suspended') {\n      await this.ctx.resume();\n      Logger.info('PlayerAudioEngine: AudioContext resumed');\n    }\n  }\n\n  dispose(): void {\n    this.clearAll();\n    this.ctx.close();\n    Logger.info('PlayerAudioEngine disposed');\n  }\n}","import type { \n  SocketMessage, \n  SocketMessageType,\n  SyncStatePayload,\n  SyncTrackState,\n  TrackPlayPayload,\n  TrackPausePayload,\n  TrackStopPayload,\n  TrackSeekPayload,\n  TrackVolumePayload,\n  TrackLoopPayload,\n  ChannelVolumePayload,\n  TrackGroup,\n  ChannelVolumes\n} from '@t/audio';\nimport { AudioEngine } from '@core/AudioEngine';\nimport { PlayerAudioEngine } from '@core/PlayerAudioEngine';\nimport { Logger } from '@utils/logger';\nimport { getServerTime } from '@utils/time';\n\nconst MODULE_ID = 'advanced-sound-engine';\nconst SOCKET_NAME = `module.${MODULE_ID}`;\n\nexport class SocketManager {\n  private gmEngine: AudioEngine | null = null;\n  private playerEngine: PlayerAudioEngine | null = null;\n  private socket: any = null;\n  private _syncEnabled: boolean = false;\n  private isGM: boolean = false;\n\n  constructor() {}\n\n  initializeAsGM(engine: AudioEngine): void {\n    this.isGM = true;\n    this.gmEngine = engine;\n    this.socket = game.socket;\n    \n    this.socket?.on(SOCKET_NAME, (message: SocketMessage) => {\n      this.handleGMMessage(message);\n    });\n    \n    Logger.info('SocketManager initialized as GM');\n  }\n\n  initializeAsPlayer(engine: PlayerAudioEngine): void {\n    this.isGM = false;\n    this.playerEngine = engine;\n    this.socket = game.socket;\n    \n    this.socket?.on(SOCKET_NAME, (message: SocketMessage) => {\n      this.handlePlayerMessage(message);\n    });\n    \n    // Request current state on join\n    setTimeout(() => {\n      this.send('player-ready', {});\n    }, 1000);\n    \n    Logger.info('SocketManager initialized as Player');\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Sync Mode (GM)\n  // ─────────────────────────────────────────────────────────────\n\n  get syncEnabled(): boolean {\n    return this._syncEnabled;\n  }\n\n  setSyncEnabled(enabled: boolean): void {\n    if (!this.isGM) return;\n    \n    this._syncEnabled = enabled;\n    \n    if (enabled) {\n      this.broadcastSyncStart();\n    } else {\n      this.broadcastSyncStop();\n    }\n    \n    Logger.info(`Sync mode: ${enabled ? 'ON' : 'OFF'}`);\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // GM Message Handling\n  // ─────────────────────────────────────────────────────────────\n\n  private handleGMMessage(message: SocketMessage): void {\n    if (message.senderId === game.user?.id) return;\n    \n    if (message.type === 'player-ready' && this._syncEnabled) {\n      // Send current state to newly joined player\n      this.sendStateTo(message.senderId);\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Player Message Handling\n  // ─────────────────────────────────────────────────────────────\n\n  private async handlePlayerMessage(message: SocketMessage): Promise<void> {\n    if (message.senderId === game.user?.id) return;\n    if (!this.playerEngine) return;\n    \n    Logger.debug(`Player received: ${message.type}`, message.payload);\n    \n    switch (message.type) {\n      case 'sync-start':\n        const startPayload = message.payload as SyncStatePayload;\n        await this.playerEngine.syncState(startPayload.tracks, startPayload.channelVolumes);\n        break;\n        \n      case 'sync-stop':\n        this.playerEngine.clearAll();\n        break;\n        \n      case 'sync-state':\n        const statePayload = message.payload as SyncStatePayload;\n        await this.playerEngine.syncState(statePayload.tracks, statePayload.channelVolumes);\n        break;\n        \n      case 'track-play':\n        const playPayload = message.payload as TrackPlayPayload;\n        await this.playerEngine.handlePlay(playPayload);\n        break;\n        \n      case 'track-pause':\n        const pausePayload = message.payload as TrackPausePayload;\n        this.playerEngine.handlePause(pausePayload.trackId);\n        break;\n        \n      case 'track-stop':\n        const stopPayload = message.payload as TrackStopPayload;\n        this.playerEngine.handleStop(stopPayload.trackId);\n        break;\n        \n      case 'track-seek':\n        const seekPayload = message.payload as TrackSeekPayload;\n        this.playerEngine.handleSeek(\n          seekPayload.trackId, \n          seekPayload.time, \n          seekPayload.isPlaying,\n          seekPayload.seekTimestamp\n        );\n        break;\n        \n      case 'track-volume':\n        const volPayload = message.payload as TrackVolumePayload;\n        this.playerEngine.handleTrackVolume(volPayload.trackId, volPayload.volume);\n        break;\n        \n      case 'track-loop':\n        const loopPayload = message.payload as TrackLoopPayload;\n        this.playerEngine.handleTrackLoop(loopPayload.trackId, loopPayload.loop);\n        break;\n        \n      case 'channel-volume':\n        const chVolPayload = message.payload as ChannelVolumePayload;\n        this.playerEngine.setGMVolume(chVolPayload.channel, chVolPayload.volume);\n        break;\n        \n      case 'stop-all':\n        this.playerEngine.stopAll();\n        break;\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // GM Broadcast Methods\n  // ─────────────────────────────────────────────────────────────\n\n  private send(type: SocketMessageType, payload: unknown, targetUserId?: string): void {\n    if (!this.socket) return;\n\n    const message: SocketMessage = {\n      type,\n      payload,\n      senderId: game.user?.id ?? '',\n      timestamp: getServerTime()\n    };\n\n    if (targetUserId) {\n      this.socket.emit(SOCKET_NAME, message, { recipients: [targetUserId] });\n    } else {\n      this.socket.emit(SOCKET_NAME, message);\n    }\n\n    Logger.debug(`Sent: ${type}`, payload);\n  }\n\n  private getCurrentSyncState(): SyncStatePayload {\n    if (!this.gmEngine) {\n      return { tracks: [], channelVolumes: { master: 1, music: 1, ambience: 1, sfx: 1 } };\n    }\n    \n    const now = getServerTime();\n    const tracks: SyncTrackState[] = [];\n    \n    for (const player of this.gmEngine.getAllTracks()) {\n      const state = player.getState();\n      tracks.push({\n        id: state.id,\n        url: state.url,\n        group: state.group,\n        volume: state.volume,\n        loop: state.loop,\n        isPlaying: state.playbackState === 'playing',\n        currentTime: player.getCurrentTime(),\n        startTimestamp: now\n      });\n    }\n    \n    return {\n      tracks,\n      channelVolumes: this.gmEngine.volumes\n    };\n  }\n\n  private broadcastSyncStart(): void {\n    const state = this.getCurrentSyncState();\n    this.send('sync-start', state);\n  }\n\n  private broadcastSyncStop(): void {\n    this.send('sync-stop', {});\n  }\n\n  private sendStateTo(userId: string): void {\n    const state = this.getCurrentSyncState();\n    this.send('sync-state', state, userId);\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // GM Actions (called when GM interacts with mixer)\n  // ─────────────────────────────────────────────────────────────\n\n  broadcastTrackPlay(trackId: string, offset: number): void {\n    if (!this._syncEnabled || !this.gmEngine) return;\n    \n    const player = this.gmEngine.getTrack(trackId);\n    if (!player) return;\n    \n    const payload: TrackPlayPayload = {\n      trackId,\n      url: player.url,\n      group: player.group,\n      volume: player.volume,\n      loop: player.loop,\n      offset,\n      startTimestamp: getServerTime()\n    };\n    \n    this.send('track-play', payload);\n  }\n\n  broadcastTrackPause(trackId: string, pausedAt: number): void {\n    if (!this._syncEnabled) return;\n    \n    const payload: TrackPausePayload = { trackId, pausedAt };\n    this.send('track-pause', payload);\n  }\n\n  broadcastTrackStop(trackId: string): void {\n    if (!this._syncEnabled) return;\n    \n    const payload: TrackStopPayload = { trackId };\n    this.send('track-stop', payload);\n  }\n\n  broadcastTrackSeek(trackId: string, time: number, isPlaying: boolean): void {\n    if (!this._syncEnabled) return;\n    \n    const payload: TrackSeekPayload = {\n      trackId,\n      time,\n      isPlaying,\n      seekTimestamp: getServerTime()\n    };\n    this.send('track-seek', payload);\n  }\n\n  broadcastTrackVolume(trackId: string, volume: number): void {\n    if (!this._syncEnabled) return;\n    \n    const payload: TrackVolumePayload = { trackId, volume };\n    this.send('track-volume', payload);\n  }\n\n  broadcastTrackLoop(trackId: string, loop: boolean): void {\n    if (!this._syncEnabled) return;\n    \n    const payload: TrackLoopPayload = { trackId, loop };\n    this.send('track-loop', payload);\n  }\n\n  broadcastChannelVolume(channel: TrackGroup | 'master', volume: number): void {\n    if (!this._syncEnabled) return;\n    \n    const payload: ChannelVolumePayload = { channel, volume };\n    this.send('channel-volume', payload);\n  }\n\n  broadcastStopAll(): void {\n    if (!this._syncEnabled) return;\n    this.send('stop-all', {});\n  }\n\n  dispose(): void {\n    this.socket?.off(SOCKET_NAME);\n  }\n}","export function throttle<T extends (...args: Parameters<T>) => void>(\n  fn: T,\n  delay: number\n): (...args: Parameters<T>) => void {\n  let lastCall = 0;\n  let timeoutId: ReturnType<typeof setTimeout> | null = null;\n  \n  return function (this: ThisParameterType<T>, ...args: Parameters<T>) {\n    const now = Date.now();\n    const remaining = delay - (now - lastCall);\n    \n    if (remaining <= 0) {\n      if (timeoutId) {\n        clearTimeout(timeoutId);\n        timeoutId = null;\n      }\n      lastCall = now;\n      fn.apply(this, args);\n    } else if (!timeoutId) {\n      timeoutId = setTimeout(() => {\n        lastCall = Date.now();\n        timeoutId = null;\n        fn.apply(this, args);\n      }, remaining);\n    }\n  };\n}\n\nexport function debounce<T extends (...args: Parameters<T>) => void>(\n  fn: T,\n  delay: number\n): (...args: Parameters<T>) => void {\n  let timeoutId: ReturnType<typeof setTimeout> | null = null;\n  \n  return function (this: ThisParameterType<T>, ...args: Parameters<T>) {\n    if (timeoutId) {\n      clearTimeout(timeoutId);\n    }\n    timeoutId = setTimeout(() => {\n      fn.apply(this, args);\n    }, delay);\n  };\n}","import type { TrackGroup } from '@t/audio';\nimport { AudioEngine } from '@core/AudioEngine';\nimport { SocketManager } from '@sync/SocketManager';\nimport { StreamingPlayer } from '@core/StreamingPlayer';\nimport { Logger } from '@utils/logger';\nimport { formatTime } from '@utils/time';\nimport { throttle } from '@utils/throttle';\nimport { generateUUID } from '@utils/uuid';\n\nconst MODULE_ID = 'advanced-sound-engine';\n\nfunction getMaxSimultaneous(): number {\n  return (game.settings.get(MODULE_ID, 'maxSimultaneousTracks') as number) || 8;\n}\n\ninterface MixerData {\n  tracks: TrackViewData[];\n  volumes: {\n    master: number;\n    music: number;\n    ambience: number;\n    sfx: number;\n  };\n  playingCount: number;\n  maxSimultaneous: number;\n  syncEnabled: boolean;\n}\n\ninterface TrackViewData {\n  id: string;\n  name: string;\n  group: TrackGroup;\n  isPlaying: boolean;\n  isPaused: boolean;\n  isStopped: boolean;\n  isLoading: boolean;\n  volume: number;\n  volumePercent: number;\n  loop: boolean;\n  currentTime: number;\n  currentTimeFormatted: string;\n  duration: number;\n  durationFormatted: string;\n  progress: number;\n}\n\nexport class SoundMixerApp extends Application {\n  private engine: AudioEngine;\n  private socket: SocketManager;\n  private updateInterval: ReturnType<typeof setInterval> | null = null;\n\n  static override get defaultOptions(): ApplicationOptions {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      id: 'ase-sound-mixer',\n      title: 'Sound Mixer (GM)',\n      template: `modules/${MODULE_ID}/templates/mixer.hbs`,\n      classes: ['ase-mixer'],\n      width: 550,\n      height: 'auto',\n      resizable: true,\n      minimizable: true,\n      popOut: true\n    }) as ApplicationOptions;\n  }\n\n  constructor(engine: AudioEngine, socket: SocketManager, options?: Partial<ApplicationOptions>) {\n    super(options);\n    this.engine = engine;\n    this.socket = socket;\n  }\n\n  override getData(): MixerData {\n    const tracks = this.engine.getAllTracks().map(player => this.getTrackViewData(player));\n    const volumes = this.engine.volumes;\n    const playingCount = tracks.filter(t => t.isPlaying).length;\n\n    return {\n      tracks,\n      volumes: {\n        master: Math.round(volumes.master * 100),\n        music: Math.round(volumes.music * 100),\n        ambience: Math.round(volumes.ambience * 100),\n        sfx: Math.round(volumes.sfx * 100)\n      },\n      playingCount,\n      maxSimultaneous: getMaxSimultaneous(),\n      syncEnabled: this.socket.syncEnabled\n    };\n  }\n\n  private getTrackViewData(player: StreamingPlayer): TrackViewData {\n    const state = player.getState();\n    const currentTime = player.getCurrentTime();\n    const duration = player.getDuration();\n    \n    return {\n      id: state.id,\n      name: this.extractFileName(state.url),\n      group: state.group,\n      isPlaying: state.playbackState === 'playing',\n      isPaused: state.playbackState === 'paused',\n      isStopped: state.playbackState === 'stopped',\n      isLoading: state.playbackState === 'loading',\n      volume: state.volume,\n      volumePercent: Math.round(state.volume * 100),\n      loop: state.loop,\n      currentTime,\n      currentTimeFormatted: formatTime(currentTime),\n      duration,\n      durationFormatted: formatTime(duration),\n      progress: duration > 0 ? (currentTime / duration) * 100 : 0\n    };\n  }\n\n  private extractFileName(url: string): string {\n    if (!url) return 'Unknown';\n    try {\n      const decoded = decodeURIComponent(url);\n      const parts = decoded.split('/');\n      const fileName = parts[parts.length - 1];\n      return fileName.replace(/\\.[^.]+$/, '');\n    } catch {\n      const parts = url.split('/');\n      const fileName = parts[parts.length - 1];\n      return fileName.replace(/\\.[^.]+$/, '');\n    }\n  }\n\n  override activateListeners(html: JQuery): void {\n    super.activateListeners(html);\n\n    // Sync toggle\n    html.find('#ase-sync-toggle').on('change', (event) => {\n      const enabled = (event.target as HTMLInputElement).checked;\n      this.socket.setSyncEnabled(enabled);\n      this.updateSyncIndicator(html, enabled);\n    });\n\n    // Channel volume sliders\n    const throttledChannelVolume = throttle((channel: string, value: number) => {\n      if (channel === 'master') {\n        this.engine.setMasterVolume(value);\n        this.socket.broadcastChannelVolume('master', value);\n      } else {\n        this.engine.setChannelVolume(channel as TrackGroup, value);\n        this.socket.broadcastChannelVolume(channel as TrackGroup, value);\n      }\n    }, 50);\n\n    html.find('.ase-channel-slider').on('input', (event) => {\n      const channel = $(event.currentTarget).data('channel') as string;\n      const value = parseFloat((event.target as HTMLInputElement).value) / 100;\n      throttledChannelVolume(channel, value);\n      $(event.currentTarget).siblings('.ase-channel-value').text(`${Math.round(value * 100)}%`);\n    });\n\n    // Add track\n    html.find('#ase-add-track').on('click', () => this.onAddTrack());\n\n    // Track controls\n    const tracks = html.find('.ase-tracks');\n    \n    tracks.on('click', '.ase-btn-play', (event) => {\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\n      this.onPlayTrack(trackId);\n    });\n\n    tracks.on('click', '.ase-btn-pause', (event) => {\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\n      this.onPauseTrack(trackId);\n    });\n\n    tracks.on('click', '.ase-btn-stop', (event) => {\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\n      this.onStopTrack(trackId);\n    });\n\n    tracks.on('click', '.ase-btn-remove', (event) => {\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\n      this.onRemoveTrack(trackId);\n    });\n\n    tracks.on('change', '.ase-loop-toggle', (event) => {\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\n      const loop = (event.target as HTMLInputElement).checked;\n      this.engine.setTrackLoop(trackId, loop);\n      this.socket.broadcastTrackLoop(trackId, loop);\n    });\n\n    tracks.on('change', '.ase-channel-select', (event) => {\n      const trackId = $(event.currentTarget).data('track-id') as string;\n      const channel = (event.target as HTMLSelectElement).value as TrackGroup;\n      this.engine.setTrackChannel(trackId, channel);\n    });\n\n    // Volume slider\n    const throttledVolume = throttle((trackId: string, value: number) => {\n      this.engine.setTrackVolume(trackId, value);\n      this.socket.broadcastTrackVolume(trackId, value);\n    }, 50);\n\n    tracks.on('input', '.ase-volume-slider', (event) => {\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\n      const value = parseFloat((event.target as HTMLInputElement).value) / 100;\n      throttledVolume(trackId, value);\n      $(event.currentTarget).siblings('.ase-volume-value').text(`${Math.round(value * 100)}%`);\n    });\n\n    // Seek slider\n    const throttledSeek = throttle((trackId: string, time: number) => {\n      const player = this.engine.getTrack(trackId);\n      const isPlaying = player?.state === 'playing';\n      this.engine.seekTrack(trackId, time);\n      this.socket.broadcastTrackSeek(trackId, time, isPlaying ?? false);\n    }, 100);\n\n    tracks.on('input', '.ase-seek-slider', (event) => {\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\n      const player = this.engine.getTrack(trackId);\n      if (player) {\n        const percent = parseFloat((event.target as HTMLInputElement).value);\n        const time = (percent / 100) * player.getDuration();\n        throttledSeek(trackId, time);\n      }\n    });\n\n    // Stop all\n    html.find('#ase-stop-all').on('click', () => {\n      this.engine.stopAll();\n      this.socket.broadcastStopAll();\n      this.render();\n    });\n\n    this.startUpdates();\n  }\n\n  private updateSyncIndicator(html: JQuery, enabled: boolean): void {\n    const indicator = html.find('.ase-sync-status');\n    indicator.toggleClass('is-active', enabled);\n    indicator.find('span').text(enabled ? 'SYNC ON' : 'SYNC OFF');\n  }\n\n  private startUpdates(): void {\n    this.stopUpdates();\n    this.updateInterval = setInterval(() => {\n      this.updateTrackDisplays();\n    }, 250);\n  }\n\n  private stopUpdates(): void {\n    if (this.updateInterval) {\n      clearInterval(this.updateInterval);\n      this.updateInterval = null;\n    }\n  }\n\n  private updateTrackDisplays(): void {\n    const html = this.element;\n    if (!html || !html.length) return;\n\n    let playingCount = 0;\n\n    for (const player of this.engine.getAllTracks()) {\n      const trackEl = html.find(`.ase-track[data-track-id=\"${player.id}\"]`);\n      if (!trackEl.length) continue;\n\n      const currentTime = player.getCurrentTime();\n      const duration = player.getDuration();\n      const progress = duration > 0 ? (currentTime / duration) * 100 : 0;\n      const state = player.state;\n\n      if (state === 'playing') playingCount++;\n\n      trackEl.find('.ase-time-current').text(formatTime(currentTime));\n      \n      const seekSlider = trackEl.find('.ase-seek-slider');\n      if (!seekSlider.is(':active')) {\n        seekSlider.val(progress);\n      }\n\n      trackEl.removeClass('is-playing is-paused is-stopped is-loading');\n      trackEl.addClass(`is-${state}`);\n      \n      trackEl.find('.ase-btn-play').prop('disabled', state === 'playing' || state === 'loading');\n      trackEl.find('.ase-btn-pause').prop('disabled', state !== 'playing');\n      trackEl.find('.ase-btn-stop').prop('disabled', state === 'stopped');\n    }\n\n    const totalTracks = this.engine.getAllTracks().length;\n    html.find('.ase-track-count').text(`${playingCount}/${totalTracks} playing`);\n  }\n\n  private async onAddTrack(): Promise<void> {\n    const fp = new FilePicker({\n      type: 'audio',\n      current: '',\n      callback: async (path: string) => {\n        await this.addTrackFromPath(path);\n      }\n    });\n    fp.render(true);\n  }\n\n  async addTrackFromPath(path: string, group: TrackGroup = 'music'): Promise<void> {\n    const trackId = generateUUID();\n\n    try {\n      await this.engine.createTrack({\n        id: trackId,\n        url: path,\n        group,\n        volume: 1,\n        loop: false\n      });\n\n      this.render();\n      ui.notifications?.info(`Added: ${this.extractFileName(path)}`);\n\n    } catch (error) {\n      Logger.error('Failed to add track:', error);\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n      ui.notifications?.error(`Failed to load: ${errorMessage}`);\n    }\n  }\n\n  private async onPlayTrack(trackId: string): Promise<void> {\n    const player = this.engine.getTrack(trackId);\n    if (!player) return;\n\n    const offset = player.state === 'paused' ? player.getCurrentTime() : 0;\n    await this.engine.playTrack(trackId, offset);\n    this.socket.broadcastTrackPlay(trackId, offset);\n  }\n\n  private onPauseTrack(trackId: string): void {\n    const player = this.engine.getTrack(trackId);\n    if (!player) return;\n    \n    const pausedAt = player.getCurrentTime();\n    this.engine.pauseTrack(trackId);\n    this.socket.broadcastTrackPause(trackId, pausedAt);\n  }\n\n  private onStopTrack(trackId: string): void {\n    this.engine.stopTrack(trackId);\n    this.socket.broadcastTrackStop(trackId);\n  }\n\n  private onRemoveTrack(trackId: string): void {\n    this.engine.removeTrack(trackId);\n    this.render();\n  }\n\n  override close(options?: Application.CloseOptions): Promise<void> {\n    this.stopUpdates();\n    return super.close(options);\n  }\n}","import { PlayerAudioEngine } from '@core/PlayerAudioEngine';\nimport { Logger } from '@utils/logger';\n\nconst MODULE_ID = 'advanced-sound-engine';\n\nexport class PlayerVolumePanel extends Application {\n  private engine: PlayerAudioEngine;\n\n  static override get defaultOptions(): ApplicationOptions {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      id: 'ase-player-volume',\n      title: 'Sound Volume',\n      template: `modules/${MODULE_ID}/templates/player-volume.hbs`,\n      classes: ['ase-player-panel'],\n      width: 200,\n      height: 'auto',\n      resizable: false,\n      minimizable: true,\n      popOut: true\n    }) as ApplicationOptions;\n  }\n\n  constructor(engine: PlayerAudioEngine, options?: Partial<ApplicationOptions>) {\n    super(options);\n    this.engine = engine;\n  }\n\n  override getData() {\n    return {\n      volume: Math.round(this.engine.localVolume * 100)\n    };\n  }\n\n  override activateListeners(html: JQuery): void {\n    super.activateListeners(html);\n\n    html.find('.ase-volume-slider').on('input', (event) => {\n      const value = parseFloat((event.target as HTMLInputElement).value) / 100;\n      this.engine.setLocalVolume(value);\n      html.find('.ase-volume-value').text(`${Math.round(value * 100)}%`);\n      \n      // Save preference\n      this.saveVolume(value);\n    });\n  }\n\n  private saveVolume(value: number): void {\n    localStorage.setItem(`${MODULE_ID}-player-volume`, String(value));\n  }\n\n  static loadSavedVolume(): number {\n    const saved = localStorage.getItem(`${MODULE_ID}-player-volume`);\n    return saved ? parseFloat(saved) : 1;\n  }\n}","import type { LibraryItem, Playlist } from '@t/library';\nimport type { TrackGroup } from '@t/audio';\nimport { LibraryManager } from '@lib/LibraryManager';\nimport { Logger } from '@utils/logger';\nimport { formatTime } from '@utils/time';\n\nconst MODULE_ID = 'advanced-sound-engine';\n\ninterface LibraryData {\n  items: LibraryItemViewData[];\n  playlists: PlaylistViewData[];\n  favorites: FavoriteViewData[];\n  stats: {\n    total: number;\n    favorites: number;\n    playlists: number;\n  };\n}\n\ninterface LibraryItemViewData {\n  id: string;\n  name: string;\n  url: string;\n  duration: string;\n  durationSeconds: number;\n  tags: string[];\n  favorite: boolean;\n  group: string;\n}\n\ninterface PlaylistViewData {\n  id: string;\n  name: string;\n  itemCount: number;\n  favorite: boolean;\n  selected?: boolean;\n}\n\ninterface FavoriteViewData {\n  id: string;\n  name: string;\n  type: 'track' | 'playlist';\n}\n\nexport class LocalLibraryApp extends Application {\n  private library: LibraryManager;\n\n  static override get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      id: 'local-library',\n      template: 'modules/advanced-sound-engine/templates/library.hbs',\n      title: 'Sound Library',\n      width: 1100,\n      height: 700,\n      classes: ['advanced-sound-engine', 'library'],\n      resizable: true,\n      tabs: [{ navSelector: '.tabs', contentSelector: '.content', initial: 'library' }]\n    });\n  }\n\n  constructor(library: LibraryManager, options = {}) {\n    super(options);\n    this.library = library;\n  }\n\n  override getData(): LibraryData {\n    const items = this.library.getAllItems();\n    const playlists = this.library.playlists.getAllPlaylists();\n    const stats = this.library.getStats();\n\n    // Build favorites list (tracks + playlists)\n    const favoriteItems = this.library.getFavorites();\n    const favoritePlaylists = this.library.playlists.getFavoritePlaylists();\n    const favorites: FavoriteViewData[] = [\n      ...favoriteItems.map(item => ({\n        id: item.id,\n        name: item.name,\n        type: 'track' as const\n      })),\n      ...favoritePlaylists.map(playlist => ({\n        id: playlist.id,\n        name: playlist.name,\n        type: 'playlist' as const\n      }))\n    ];\n\n    return {\n      items: items.map(item => this.getItemViewData(item)),\n      playlists: playlists.map(p => this.getPlaylistViewData(p)),\n      favorites,\n      stats: {\n        total: stats.totalItems,\n        favorites: stats.favoriteItems,\n        playlists: stats.playlists\n      }\n    };\n  }\n\n  private getPlaylistViewData(playlist: Playlist): PlaylistViewData {\n    return {\n      id: playlist.id,\n      name: playlist.name,\n      itemCount: playlist.items.length,\n      favorite: playlist.favorite,\n      selected: false\n    };\n  }\n\n  private getItemViewData(item: LibraryItem): LibraryItemViewData {\n    return {\n      id: item.id,\n      name: item.name,\n      url: item.url,\n      duration: formatTime(item.duration),\n      durationSeconds: item.duration,\n      tags: item.tags,\n      favorite: item.favorite,\n      group: this.inferGroupFromTags(item.tags)\n    };\n  }\n\n  private inferGroupFromTags(tags: string[]): string {\n    // Try to infer group from tags if possible\n    const lowerTags = tags.map(t => t.toLowerCase());\n    if (lowerTags.some(t => t.includes('music'))) return 'music';\n    if (lowerTags.some(t => t.includes('ambient') || t.includes('ambience'))) return 'ambience';\n    if (lowerTags.some(t => t.includes('sfx') || t.includes('effect'))) return 'sfx';\n    return 'music'; // default\n  }\n\n  override activateListeners(html: JQuery): void {\n    super.activateListeners(html);\n\n    // Add track button\n    html.find('[data-action=\"add-track\"]').on('click', this.onAddTrack.bind(this));\n\n    // Track actions\n    html.find('[data-action=\"toggle-favorite\"]').on('click', this.onToggleFavorite.bind(this));\n    html.find('[data-action=\"delete-track\"]').on('click', this.onDeleteTrack.bind(this));\n\n    // Playlist actions\n    html.find('[data-action=\"create-playlist\"]').on('click', this.onCreatePlaylist.bind(this));\n    html.find('[data-action=\"toggle-playlist-favorite\"]').on('click', this.onTogglePlaylistFavorite.bind(this));\n\n    // Favorite actions\n    html.find('[data-action=\"remove-from-favorites\"]').on('click', this.onRemoveFromFavorites.bind(this));\n\n    Logger.debug('LocalLibraryApp listeners activated');\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Event Handlers\n  // ─────────────────────────────────────────────────────────────\n\n  private async onAddTrack(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n\n    const fp = new FilePicker({\n      type: 'audio',\n      callback: async (path: string) => {\n        await this.addTrackFromPath(path);\n      }\n    });\n    fp.render(true);\n  }\n\n  private async addTrackFromPath(path: string, group: TrackGroup = 'music'): Promise<void> {\n    try {\n      const item = await this.library.addItem(path, undefined, group);\n      this.render();\n      ui.notifications?.info(`Added to library: ${item.name}`);\n    } catch (error) {\n      Logger.error('Failed to add track to library:', error);\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n      ui.notifications?.error(`Failed to add track: ${errorMessage}`);\n    }\n  }\n\n  private async onToggleFavorite(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n    const itemId = $(event.currentTarget).closest('[data-item-id]').data('item-id') as string;\n\n    try {\n      const isFavorite = this.library.toggleFavorite(itemId);\n      this.render();\n      ui.notifications?.info(isFavorite ? 'Added to favorites' : 'Removed from favorites');\n    } catch (error) {\n      Logger.error('Failed to toggle favorite:', error);\n      ui.notifications?.error('Failed to update favorite status');\n    }\n  }\n\n  private async onDeleteTrack(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n    const itemId = $(event.currentTarget).closest('[data-item-id]').data('item-id') as string;\n    const item = this.library.getItem(itemId);\n\n    if (!item) {\n      ui.notifications?.error('Track not found');\n      return;\n    }\n\n    const confirmed = await Dialog.confirm({\n      title: 'Delete Track',\n      content: `<p>Are you sure you want to delete <strong>${item.name}</strong> from the library?</p>\n                <p class=\"notification warning\">This will remove it from all playlists and favorites.</p>`,\n      yes: () => true,\n      no: () => false,\n      defaultYes: false\n    });\n\n    if (confirmed) {\n      try {\n        this.library.removeItem(itemId);\n        this.render();\n        ui.notifications?.info(`Deleted: ${item.name}`);\n      } catch (error) {\n        Logger.error('Failed to delete track:', error);\n        ui.notifications?.error('Failed to delete track');\n      }\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Playlist Event Handlers\n  // ─────────────────────────────────────────────────────────────\n\n  private async onCreatePlaylist(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n\n    const name = await this.promptPlaylistName();\n    if (!name) return;\n\n    try {\n      const playlist = this.library.playlists.createPlaylist(name);\n      this.render();\n      ui.notifications?.info(`Created playlist: ${playlist.name}`);\n    } catch (error) {\n      Logger.error('Failed to create playlist:', error);\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n      ui.notifications?.error(`Failed to create playlist: ${errorMessage}`);\n    }\n  }\n\n  private async onTogglePlaylistFavorite(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const playlistId = $(event.currentTarget).closest('[data-playlist-id]').data('playlist-id') as string;\n\n    try {\n      const isFavorite = this.library.playlists.togglePlaylistFavorite(playlistId);\n      this.render();\n      ui.notifications?.info(isFavorite ? 'Added to favorites' : 'Removed from favorites');\n    } catch (error) {\n      Logger.error('Failed to toggle playlist favorite:', error);\n      ui.notifications?.error('Failed to update favorite status');\n    }\n  }\n\n  private async onRemoveFromFavorites(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const favoriteId = $(event.currentTarget).closest('[data-favorite-id]').data('favorite-id') as string;\n    const favoriteType = $(event.currentTarget).closest('[data-favorite-type]').data('favorite-type') as string;\n\n    try {\n      if (favoriteType === 'track') {\n        this.library.toggleFavorite(favoriteId);\n      } else if (favoriteType === 'playlist') {\n        this.library.playlists.togglePlaylistFavorite(favoriteId);\n      }\n      this.render();\n      ui.notifications?.info('Removed from favorites');\n    } catch (error) {\n      Logger.error('Failed to remove from favorites:', error);\n      ui.notifications?.error('Failed to remove from favorites');\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Utilities\n  // ─────────────────────────────────────────────────────────────\n\n  private async promptPlaylistName(): Promise<string | null> {\n    return new Promise((resolve) => {\n      new Dialog({\n        title: 'Create Playlist',\n        content: `\n          <form>\n            <div class=\"form-group\">\n              <label>Playlist Name:</label>\n              <input type=\"text\" name=\"playlist-name\" autofocus />\n            </div>\n          </form>\n        `,\n        buttons: {\n          create: {\n            icon: '<i class=\"fas fa-check\"></i>',\n            label: 'Create',\n            callback: (html: JQuery) => {\n              const name = (html.find('[name=\"playlist-name\"]').val() as string || '').trim();\n              resolve(name || null);\n            }\n          },\n          cancel: {\n            icon: '<i class=\"fas fa-times\"></i>',\n            label: 'Cancel',\n            callback: () => resolve(null)\n          }\n        },\n        default: 'create'\n      }).render(true);\n    });\n  }\n}\n","import type { Playlist, PlaylistItem } from '@t/library';\nimport type { TrackGroup } from '@t/audio';\nimport { generateUUID } from '@utils/uuid';\nimport { Logger } from '@utils/logger';\n\nexport class PlaylistManager {\n  private playlists: Map<string, Playlist> = new Map();\n  private onChangeCallback?: () => void;\n\n  constructor(onChangeCallback?: () => void) {\n    this.onChangeCallback = onChangeCallback;\n  }\n\n  /**\n   * Notify about changes (triggers save)\n   */\n  private notifyChange(): void {\n    if (this.onChangeCallback) {\n      this.onChangeCallback();\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // CRUD Operations - Playlists\n  // ─────────────────────────────────────────────────────────────\n\n  /**\n   * Create new playlist\n   */\n  createPlaylist(name: string, description?: string): Playlist {\n    // Check for duplicate names\n    const existing = this.findByName(name);\n    if (existing) {\n      throw new Error(`Playlist with name \"${name}\" already exists`);\n    }\n\n    const now = Date.now();\n    const playlist: Playlist = {\n      id: generateUUID(),\n      name,\n      description,\n      items: [],\n      createdAt: now,\n      updatedAt: now,\n      favorite: false\n    };\n\n    this.playlists.set(playlist.id, playlist);\n    this.notifyChange();\n    Logger.info(`Playlist created: ${playlist.name} (${playlist.id})`);\n\n    return playlist;\n  }\n\n  /**\n   * Update playlist metadata\n   */\n  updatePlaylist(id: string, updates: Partial<Pick<Playlist, 'name' | 'description' | 'favorite'>>): Playlist {\n    const playlist = this.playlists.get(id);\n    if (!playlist) {\n      throw new Error(`Playlist not found: ${id}`);\n    }\n\n    // Validate name uniqueness if changing name\n    if (updates.name && updates.name !== playlist.name) {\n      const existing = this.findByName(updates.name);\n      if (existing && existing.id !== id) {\n        throw new Error(`Playlist with name \"${updates.name}\" already exists`);\n      }\n    }\n\n    // Update playlist\n    const updated = {\n      ...playlist,\n      ...updates,\n      updatedAt: Date.now()\n    };\n\n    this.playlists.set(id, updated);\n    this.notifyChange();\n    Logger.info(`Playlist updated: ${updated.name}`);\n\n    return updated;\n  }\n\n  /**\n   * Delete playlist\n   */\n  deletePlaylist(id: string): void {\n    const playlist = this.playlists.get(id);\n    if (!playlist) {\n      throw new Error(`Playlist not found: ${id}`);\n    }\n\n    this.playlists.delete(id);\n    this.notifyChange();\n    Logger.info(`Playlist deleted: ${playlist.name}`);\n  }\n\n  /**\n   * Get playlist by ID\n   */\n  getPlaylist(id: string): Playlist | undefined {\n    return this.playlists.get(id);\n  }\n\n  /**\n   * Get all playlists\n   */\n  getAllPlaylists(): Playlist[] {\n    return Array.from(this.playlists.values());\n  }\n\n  /**\n   * Find playlist by name\n   */\n  findByName(name: string): Playlist | undefined {\n    return Array.from(this.playlists.values()).find(p => p.name === name);\n  }\n\n  /**\n   * Get favorite playlists\n   */\n  getFavoritePlaylists(): Playlist[] {\n    return this.getAllPlaylists().filter(p => p.favorite);\n  }\n\n  /**\n   * Toggle playlist favorite status\n   */\n  togglePlaylistFavorite(id: string): boolean {\n    const playlist = this.getPlaylist(id);\n    if (!playlist) {\n      throw new Error(`Playlist not found: ${id}`);\n    }\n\n    playlist.favorite = !playlist.favorite;\n    playlist.updatedAt = Date.now();\n    this.notifyChange();\n\n    return playlist.favorite;\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // CRUD Operations - Playlist Items\n  // ─────────────────────────────────────────────────────────────\n\n  /**\n   * Add track to playlist\n   */\n  addTrackToPlaylist(\n    playlistId: string,\n    libraryItemId: string,\n    group: TrackGroup,\n    options?: Partial<Omit<PlaylistItem, 'id' | 'libraryItemId' | 'group' | 'order'>>\n  ): PlaylistItem {\n    const playlist = this.getPlaylist(playlistId);\n    if (!playlist) {\n      throw new Error(`Playlist not found: ${playlistId}`);\n    }\n\n    // Check if track already exists in playlist\n    const exists = playlist.items.find(item => item.libraryItemId === libraryItemId);\n    if (exists) {\n      throw new Error('Track already exists in this playlist');\n    }\n\n    // Create new playlist item\n    const item: PlaylistItem = {\n      id: generateUUID(),\n      libraryItemId,\n      group,\n      volume: options?.volume ?? 1.0,\n      loop: options?.loop ?? false,\n      order: playlist.items.length,\n      fadeIn: options?.fadeIn,\n      fadeOut: options?.fadeOut\n    };\n\n    playlist.items.push(item);\n    playlist.updatedAt = Date.now();\n    this.notifyChange();\n\n    Logger.debug(`Track added to playlist ${playlist.name}: ${libraryItemId}`);\n\n    return item;\n  }\n\n  /**\n   * Remove track from playlist\n   */\n  removeTrackFromPlaylist(playlistId: string, playlistItemId: string): void {\n    const playlist = this.getPlaylist(playlistId);\n    if (!playlist) {\n      throw new Error(`Playlist not found: ${playlistId}`);\n    }\n\n    const index = playlist.items.findIndex(item => item.id === playlistItemId);\n    if (index === -1) {\n      throw new Error(`Playlist item not found: ${playlistItemId}`);\n    }\n\n    playlist.items.splice(index, 1);\n\n    // Reorder remaining items\n    this.reorderPlaylistItems(playlist);\n\n    playlist.updatedAt = Date.now();\n    this.notifyChange();\n    Logger.debug(`Track removed from playlist ${playlist.name}`);\n  }\n\n  /**\n   * Remove all tracks with specific library item ID from playlist\n   */\n  removeLibraryItemFromPlaylist(playlistId: string, libraryItemId: string): number {\n    const playlist = this.getPlaylist(playlistId);\n    if (!playlist) {\n      throw new Error(`Playlist not found: ${playlistId}`);\n    }\n\n    const initialLength = playlist.items.length;\n    playlist.items = playlist.items.filter(item => item.libraryItemId !== libraryItemId);\n    const removed = initialLength - playlist.items.length;\n\n    if (removed > 0) {\n      this.reorderPlaylistItems(playlist);\n      playlist.updatedAt = Date.now();\n      this.notifyChange();\n      Logger.debug(`Removed ${removed} instances of library item ${libraryItemId} from playlist ${playlist.name}`);\n    }\n\n    return removed;\n  }\n\n  /**\n   * Remove library item from all playlists\n   */\n  removeLibraryItemFromAllPlaylists(libraryItemId: string): number {\n    let totalRemoved = 0;\n\n    this.playlists.forEach(playlist => {\n      const initialLength = playlist.items.length;\n      playlist.items = playlist.items.filter(item => item.libraryItemId !== libraryItemId);\n      const removed = initialLength - playlist.items.length;\n\n      if (removed > 0) {\n        this.reorderPlaylistItems(playlist);\n        playlist.updatedAt = Date.now();\n        totalRemoved += removed;\n      }\n    });\n\n    if (totalRemoved > 0) {\n      this.notifyChange();\n      Logger.info(`Removed library item ${libraryItemId} from ${totalRemoved} playlist(s)`);\n    }\n\n    return totalRemoved;\n  }\n\n  /**\n   * Update playlist item\n   */\n  updatePlaylistItem(\n    playlistId: string,\n    playlistItemId: string,\n    updates: Partial<Omit<PlaylistItem, 'id' | 'libraryItemId' | 'order'>>\n  ): PlaylistItem {\n    const playlist = this.getPlaylist(playlistId);\n    if (!playlist) {\n      throw new Error(`Playlist not found: ${playlistId}`);\n    }\n\n    const item = playlist.items.find(i => i.id === playlistItemId);\n    if (!item) {\n      throw new Error(`Playlist item not found: ${playlistItemId}`);\n    }\n\n    // Update item\n    Object.assign(item, updates);\n    playlist.updatedAt = Date.now();\n    this.notifyChange();\n\n    Logger.debug(`Playlist item updated in ${playlist.name}`);\n\n    return item;\n  }\n\n  /**\n   * Reorder track in playlist\n   */\n  reorderTrack(playlistId: string, playlistItemId: string, newOrder: number): void {\n    const playlist = this.getPlaylist(playlistId);\n    if (!playlist) {\n      throw new Error(`Playlist not found: ${playlistId}`);\n    }\n\n    const itemIndex = playlist.items.findIndex(i => i.id === playlistItemId);\n    if (itemIndex === -1) {\n      throw new Error(`Playlist item not found: ${playlistItemId}`);\n    }\n\n    // Validate new order\n    if (newOrder < 0 || newOrder >= playlist.items.length) {\n      throw new Error(`Invalid order: ${newOrder}`);\n    }\n\n    // Remove item from current position\n    const [item] = playlist.items.splice(itemIndex, 1);\n\n    // Insert at new position\n    playlist.items.splice(newOrder, 0, item);\n\n    // Reorder all items\n    this.reorderPlaylistItems(playlist);\n\n    playlist.updatedAt = Date.now();\n    this.notifyChange();\n    Logger.debug(`Track reordered in playlist ${playlist.name}`);\n  }\n\n  /**\n   * Get tracks in playlist\n   */\n  getPlaylistTracks(playlistId: string): PlaylistItem[] {\n    const playlist = this.getPlaylist(playlistId);\n    if (!playlist) {\n      throw new Error(`Playlist not found: ${playlistId}`);\n    }\n\n    return [...playlist.items].sort((a, b) => a.order - b.order);\n  }\n\n  /**\n   * Get playlists containing a specific library item\n   */\n  getPlaylistsContainingItem(libraryItemId: string): Playlist[] {\n    return this.getAllPlaylists().filter(playlist =>\n      playlist.items.some(item => item.libraryItemId === libraryItemId)\n    );\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Persistence\n  // ─────────────────────────────────────────────────────────────\n\n  /**\n   * Load playlists from state object\n   */\n  load(playlistsData: Record<string, Playlist>): void {\n    this.playlists.clear();\n\n    Object.values(playlistsData).forEach(playlist => {\n      // Ensure items are properly ordered\n      playlist.items.sort((a, b) => a.order - b.order);\n      this.playlists.set(playlist.id, playlist);\n    });\n\n    Logger.info(`PlaylistManager loaded: ${this.playlists.size} playlists`);\n  }\n\n  /**\n   * Export playlists to state object\n   */\n  export(): Record<string, Playlist> {\n    return Object.fromEntries(this.playlists);\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Utilities\n  // ─────────────────────────────────────────────────────────────\n\n  /**\n   * Reorder playlist items to ensure consecutive order values\n   */\n  private reorderPlaylistItems(playlist: Playlist): void {\n    playlist.items.forEach((item, index) => {\n      item.order = index;\n    });\n  }\n\n  /**\n   * Get statistics\n   */\n  getStats() {\n    const playlists = this.getAllPlaylists();\n    return {\n      totalPlaylists: playlists.length,\n      favoritePlaylists: playlists.filter(p => p.favorite).length,\n      totalTracks: playlists.reduce((sum, p) => sum + p.items.length, 0),\n      averageTracksPerPlaylist: playlists.length > 0\n        ? Math.round(playlists.reduce((sum, p) => sum + p.items.length, 0) / playlists.length)\n        : 0\n    };\n  }\n\n  /**\n   * Clear all playlists\n   */\n  clear(): void {\n    this.playlists.clear();\n    Logger.warn('All playlists cleared');\n  }\n}\n","import type { LibraryItem, LibraryState } from '@t/library';\nimport type { TrackGroup } from '@t/audio';\nimport { generateUUID } from '@utils/uuid';\nimport { validateAudioFile } from '@utils/audio-validation';\nimport { Logger } from '@utils/logger';\nimport { debounce } from '@utils/throttle';\nimport { PlaylistManager } from './PlaylistManager';\n\nconst MODULE_ID = 'advanced-sound-engine';\nconst LIBRARY_VERSION = 1;\n\nexport class LibraryManager {\n  private items: Map<string, LibraryItem> = new Map();\n  private saveScheduled = false;\n  public readonly playlists: PlaylistManager;\n\n  private debouncedSave = debounce(() => {\n    this.saveToSettings();\n  }, 500);\n\n  constructor() {\n    this.playlists = new PlaylistManager(() => this.scheduleSave());\n    this.loadFromSettings();\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // CRUD Operations\n  // ─────────────────────────────────────────────────────────────\n\n  /**\n   * Add new item to library\n   */\n  async addItem(url: string, name?: string, group: TrackGroup = 'music'): Promise<LibraryItem> {\n    // Validate audio format\n    const validation = validateAudioFile(url);\n    if (!validation.valid) {\n      throw new Error(validation.error || 'Invalid audio file');\n    }\n\n    // Generate name from filename if not provided\n    const itemName = name || this.extractNameFromUrl(url);\n\n    // Check for duplicates by URL\n    const existingByUrl = this.findByUrl(url);\n    if (existingByUrl) {\n      throw new Error(`Track with this URL already exists: ${existingByUrl.name}`);\n    }\n\n    // Check for duplicates by name\n    const existingByName = this.findByName(itemName);\n    if (existingByName) {\n      throw new Error(`Track with name \"${itemName}\" already exists in library`);\n    }\n\n    const now = Date.now();\n    const item: LibraryItem = {\n      id: generateUUID(),\n      url,\n      name: itemName,\n      tags: [],\n      duration: 0,\n      favorite: false,\n      addedAt: now,\n      updatedAt: now\n    };\n\n    this.items.set(item.id, item);\n    this.scheduleSave();\n\n    Logger.info(`Library item added: ${item.name} (${item.id})`);\n    return item;\n  }\n\n  /**\n   * Update existing item\n   */\n  updateItem(id: string, updates: Partial<LibraryItem>): LibraryItem {\n    const item = this.items.get(id);\n    if (!item) {\n      throw new Error(`Library item not found: ${id}`);\n    }\n\n    // Validate name uniqueness if changing name\n    if (updates.name && updates.name !== item.name) {\n      const existingByName = this.findByName(updates.name);\n      if (existingByName && existingByName.id !== id) {\n        throw new Error(`Track with name \"${updates.name}\" already exists`);\n      }\n    }\n\n    // Validate URL uniqueness if changing URL\n    if (updates.url && updates.url !== item.url) {\n      const validation = validateAudioFile(updates.url);\n      if (!validation.valid) {\n        throw new Error(validation.error || 'Invalid audio file');\n      }\n\n      const existingByUrl = this.findByUrl(updates.url);\n      if (existingByUrl && existingByUrl.id !== id) {\n        throw new Error(`Track with this URL already exists: ${existingByUrl.name}`);\n      }\n    }\n\n    // Prevent ID change\n    delete updates.id;\n\n    // Update item\n    const updated = {\n      ...item,\n      ...updates,\n      updatedAt: Date.now()\n    };\n\n    this.items.set(id, updated);\n    this.scheduleSave();\n\n    Logger.info(`Library item updated: ${updated.name}`);\n    return updated;\n  }\n\n  /**\n   * Remove item from library\n   */\n  removeItem(id: string): void {\n    const item = this.items.get(id);\n    if (!item) {\n      throw new Error(`Library item not found: ${id}`);\n    }\n\n    // Remove from all playlists first\n    this.playlists.removeLibraryItemFromAllPlaylists(id);\n\n    this.items.delete(id);\n    this.scheduleSave();\n\n    Logger.info(`Library item removed: ${item.name}`);\n  }\n\n  /**\n   * Get item by ID\n   */\n  getItem(id: string): LibraryItem | undefined {\n    return this.items.get(id);\n  }\n\n  /**\n   * Get all items\n   */\n  getAllItems(): LibraryItem[] {\n    return Array.from(this.items.values());\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Search & Filter\n  // ─────────────────────────────────────────────────────────────\n\n  /**\n   * Find item by URL\n   */\n  findByUrl(url: string): LibraryItem | undefined {\n    return Array.from(this.items.values()).find(item => item.url === url);\n  }\n\n  /**\n   * Find item by name\n   */\n  findByName(name: string): LibraryItem | undefined {\n    return Array.from(this.items.values()).find(item => item.name === name);\n  }\n\n  /**\n   * Search items by query\n   */\n  searchByName(query: string): LibraryItem[] {\n    const lowerQuery = query.toLowerCase();\n    return this.getAllItems().filter(item =>\n      item.name.toLowerCase().includes(lowerQuery)\n    );\n  }\n\n  /**\n   * Filter items by tags (OR logic)\n   */\n  filterByTags(tags: string[]): LibraryItem[] {\n    if (tags.length === 0) return this.getAllItems();\n\n    return this.getAllItems().filter(item =>\n      item.tags.some(tag => tags.includes(tag))\n    );\n  }\n\n  /**\n   * Get favorite items\n   */\n  getFavorites(): LibraryItem[] {\n    return this.getAllItems().filter(item => item.favorite);\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Tags Management\n  // ─────────────────────────────────────────────────────────────\n\n  /**\n   * Get all unique tags\n   */\n  getAllTags(): string[] {\n    const tagSet = new Set<string>();\n    this.items.forEach(item => {\n      item.tags.forEach(tag => tagSet.add(tag));\n    });\n    return Array.from(tagSet).sort();\n  }\n\n  /**\n   * Add tag to item\n   */\n  addTagToItem(itemId: string, tag: string): void {\n    const item = this.getItem(itemId);\n    if (!item) {\n      throw new Error(`Library item not found: ${itemId}`);\n    }\n\n    if (!item.tags.includes(tag)) {\n      item.tags.push(tag);\n      item.updatedAt = Date.now();\n      this.scheduleSave();\n    }\n  }\n\n  /**\n   * Remove tag from item\n   */\n  removeTagFromItem(itemId: string, tag: string): void {\n    const item = this.getItem(itemId);\n    if (!item) {\n      throw new Error(`Library item not found: ${itemId}`);\n    }\n\n    const index = item.tags.indexOf(tag);\n    if (index !== -1) {\n      item.tags.splice(index, 1);\n      item.updatedAt = Date.now();\n      this.scheduleSave();\n    }\n  }\n\n  /**\n   * Rename tag globally\n   */\n  renameTag(oldTag: string, newTag: string): number {\n    let count = 0;\n    this.items.forEach(item => {\n      const index = item.tags.indexOf(oldTag);\n      if (index !== -1) {\n        item.tags[index] = newTag;\n        item.updatedAt = Date.now();\n        count++;\n      }\n    });\n\n    if (count > 0) {\n      this.scheduleSave();\n      Logger.info(`Tag renamed: \"${oldTag}\" → \"${newTag}\" (${count} items)`);\n    }\n\n    return count;\n  }\n\n  /**\n   * Delete tag globally\n   */\n  deleteTag(tag: string): number {\n    let count = 0;\n    this.items.forEach(item => {\n      const index = item.tags.indexOf(tag);\n      if (index !== -1) {\n        item.tags.splice(index, 1);\n        item.updatedAt = Date.now();\n        count++;\n      }\n    });\n\n    if (count > 0) {\n      this.scheduleSave();\n      Logger.info(`Tag deleted: \"${tag}\" (${count} items)`);\n    }\n\n    return count;\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Favorites\n  // ─────────────────────────────────────────────────────────────\n\n  /**\n   * Toggle favorite status\n   */\n  toggleFavorite(itemId: string): boolean {\n    const item = this.getItem(itemId);\n    if (!item) {\n      throw new Error(`Library item not found: ${itemId}`);\n    }\n\n    item.favorite = !item.favorite;\n    item.updatedAt = Date.now();\n    this.scheduleSave();\n\n    return item.favorite;\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Persistence\n  // ─────────────────────────────────────────────────────────────\n\n  private loadFromSettings(): void {\n    try {\n      const saved = game.settings.get(MODULE_ID, 'libraryState') as string;\n      if (!saved) {\n        Logger.info('No saved library state, starting fresh');\n        return;\n      }\n\n      const state: LibraryState = JSON.parse(saved);\n\n      // Migrate if needed\n      if (state.version !== LIBRARY_VERSION) {\n        Logger.warn(`Library version mismatch: ${state.version} → ${LIBRARY_VERSION}`);\n        // Add migration logic here if needed\n      }\n\n      // Load items\n      this.items.clear();\n      Object.values(state.items).forEach(item => {\n        this.items.set(item.id, item);\n      });\n\n      // Load playlists\n      this.playlists.load(state.playlists || {});\n\n      Logger.info(`Library loaded: ${this.items.size} items, ${this.playlists.getAllPlaylists().length} playlists`);\n    } catch (error) {\n      Logger.error('Failed to load library state:', error);\n    }\n  }\n\n  private saveToSettings(): void {\n    try {\n      const state: LibraryState = {\n        items: Object.fromEntries(this.items),\n        playlists: this.playlists.export(),\n        version: LIBRARY_VERSION,\n        lastModified: Date.now()\n      };\n\n      game.settings.set(MODULE_ID, 'libraryState', JSON.stringify(state));\n      this.saveScheduled = false;\n\n      Logger.debug(`Library saved: ${this.items.size} items, ${this.playlists.getAllPlaylists().length} playlists`);\n    } catch (error) {\n      Logger.error('Failed to save library state:', error);\n    }\n  }\n\n  private scheduleSave(): void {\n    this.debouncedSave();\n  }\n\n  // ─────────────────────────────────────────────────────────────\n  // Utilities\n  // ─────────────────────────────────────────────────────────────\n\n  private extractNameFromUrl(url: string): string {\n    try {\n      const decoded = decodeURIComponent(url);\n      const parts = decoded.split('/');\n      const filename = parts[parts.length - 1];\n      return filename.replace(/\\.[^.]+$/, ''); // Remove extension\n    } catch {\n      return 'Unknown Track';\n    }\n  }\n\n  /**\n   * Get library statistics\n   */\n  getStats() {\n    const items = this.getAllItems();\n    const playlistStats = this.playlists.getStats();\n\n    return {\n      totalItems: items.length,\n      favoriteItems: items.filter(i => i.favorite).length,\n      totalDuration: items.reduce((sum, i) => sum + i.duration, 0),\n      tagCount: this.getAllTags().length,\n      playlists: playlistStats.totalPlaylists\n    };\n  }\n\n  /**\n   * Clear all library data\n   */\n  clear(): void {\n    this.items.clear();\n    this.playlists.clear();\n    this.scheduleSave();\n    Logger.warn('Library cleared');\n  }\n\n  /**\n   * Dispose resources\n   */\n  dispose(): void {\n    // Save immediately before disposing\n    if (this.saveScheduled) {\n      this.saveToSettings();\n    }\n  }\n}\n","import '../styles/sound-engine.scss';\nimport { AudioEngine } from '@core/AudioEngine';\nimport { PlayerAudioEngine } from '@core/PlayerAudioEngine';\nimport { SocketManager } from '@sync/SocketManager';\nimport { SoundMixerApp } from '@ui/SoundMixerApp';\nimport { PlayerVolumePanel } from '@ui/PlayerVolumePanel';\nimport { LocalLibraryApp } from '@ui/LocalLibraryApp';\nimport { LibraryManager } from '@lib/LibraryManager';\nimport { Logger } from '@utils/logger';\n\nconst MODULE_ID = 'advanced-sound-engine';\n\n// GM\nlet gmEngine: AudioEngine | null = null;\nlet mixerApp: SoundMixerApp | null = null;\nlet libraryApp: LocalLibraryApp | null = null;\nlet libraryManager: LibraryManager | null = null;\n\n// Player\nlet playerEngine: PlayerAudioEngine | null = null;\nlet volumePanel: PlayerVolumePanel | null = null;\n\n// Shared\nlet socketManager: SocketManager | null = null;\n\ndeclare global {\n  interface Window {\n    ASE: {\n      isGM: boolean;\n      openPanel: () => void;\n      openLibrary?: () => void;\n      engine?: AudioEngine | PlayerAudioEngine;\n      socket?: SocketManager;\n      library?: LibraryManager;\n    };\n  }\n}\n\n// ─────────────────────────────────────────────────────────────\n// Control Button (в начале файла, после импортов)\n// ─────────────────────────────────────────────────────────────\n\nHooks.on('getSceneControlButtons', (controls: Record<string, any>) => {\n  console.log('ASE: Hook fired', controls);\n\n  const isGM = game.user?.isGM ?? false;\n\n  const tools: Record<string, any> = {\n    'open-panel': {\n      name: 'open-panel',\n      title: isGM ? 'Sound Mixer' : 'Sound Volume',\n      icon: isGM ? 'fas fa-sliders-h' : 'fas fa-volume-up',\n      button: true,\n      onClick: () => window.ASE?.openPanel()\n    }\n  };\n\n  // Add library button for GM\n  if (isGM) {\n    tools['open-library'] = {\n      name: 'open-library',\n      title: 'Sound Library',\n      icon: 'fas fa-book',\n      button: true,\n      onClick: () => window.ASE?.openLibrary?.()\n    };\n  }\n\n  controls['advanced-sound-engine'] = {\n    name: 'advanced-sound-engine',\n    title: isGM ? 'Advanced Sound Engine' : 'Sound Volume',\n    icon: isGM ? 'fas fa-sliders-h' : 'fas fa-volume-up',\n    visible: true,\n    tools\n  };\n});\n// ─────────────────────────────────────────────────────────────\n// Initialization\n// ─────────────────────────────────────────────────────────────\n\nHooks.once('init', () => {\n  Logger.info('Initializing Advanced Sound Engine...');\n  registerSettings();\n});\n\nHooks.once('ready', async () => {\n  const isGM = game.user?.isGM ?? false;\n  Logger.info(`Starting Advanced Sound Engine (${isGM ? 'GM' : 'Player'})...`);\n  \n  socketManager = new SocketManager();\n  \n  if (isGM) {\n    await initializeGM();\n  } else {\n    await initializePlayer();\n  }\n  \n  window.ASE = {\n    isGM,\n    openPanel: isGM ? openMixer : openVolumePanel,\n    openLibrary: isGM ? openLibrary : undefined,\n    engine: isGM ? gmEngine ?? undefined : playerEngine ?? undefined,\n    socket: socketManager ?? undefined,\n    library: isGM ? libraryManager ?? undefined : undefined\n  };\n  \n  setupAutoplayHandler();\n    \n  Logger.info('Advanced Sound Engine ready');\n});\n\nasync function initializeGM(): Promise<void> {\n  libraryManager = new LibraryManager();\n  gmEngine = new AudioEngine();\n  socketManager!.initializeAsGM(gmEngine);\n\n  await gmEngine.loadSavedState();\n}\n\nasync function initializePlayer(): Promise<void> {\n  playerEngine = new PlayerAudioEngine();\n  socketManager!.initializeAsPlayer(playerEngine);\n  \n  // Restore saved local volume\n  const savedVolume = PlayerVolumePanel.loadSavedVolume();\n  playerEngine.setLocalVolume(savedVolume);\n}\n\n// ─────────────────────────────────────────────────────────────\n// Panels\n// ─────────────────────────────────────────────────────────────\n\nfunction openMixer(): void {\n  if (!gmEngine || !socketManager) return;\n  \n  if (mixerApp && mixerApp.rendered) {\n    mixerApp.bringToTop();\n  } else {\n    mixerApp = new SoundMixerApp(gmEngine, socketManager);\n    mixerApp.render(true);\n  }\n}\n\nfunction openVolumePanel(): void {\n  if (!playerEngine) return;\n\n  if (volumePanel && volumePanel.rendered) {\n    volumePanel.bringToTop();\n  } else {\n    volumePanel = new PlayerVolumePanel(playerEngine);\n    volumePanel.render(true);\n  }\n}\n\nfunction openLibrary(): void {\n  if (!libraryManager) return;\n\n  if (libraryApp && libraryApp.rendered) {\n    libraryApp.bringToTop();\n  } else {\n    libraryApp = new LocalLibraryApp(libraryManager);\n    libraryApp.render(true);\n  }\n}\n\n\n\n// ─────────────────────────────────────────────────────────────\n// Autoplay Policy Handler\n// ─────────────────────────────────────────────────────────────\n\nfunction setupAutoplayHandler(): void {\n  const resumeAudio = () => {\n    gmEngine?.resume();\n    playerEngine?.resume();\n  };\n  \n  document.addEventListener('click', resumeAudio, { once: true });\n  document.addEventListener('keydown', resumeAudio, { once: true });\n  \n  Hooks.once('canvasReady', resumeAudio);\n}\n\n// ─────────────────────────────────────────────────────────────\n// Settings\n// ─────────────────────────────────────────────────────────────\n\nfunction registerSettings(): void {\n  game.settings.register(MODULE_ID, 'mixerState', {\n    name: 'Mixer State',\n    hint: 'Internal storage for mixer state',\n    scope: 'world',\n    config: false,\n    type: String,\n    default: ''\n  });\n\n  game.settings.register(MODULE_ID, 'maxSimultaneousTracks', {\n    name: 'Maximum Simultaneous Tracks',\n    hint: 'Maximum number of tracks that can play simultaneously (1-32)',\n    scope: 'world',\n    config: true,\n    type: Number,\n    default: 16,\n    range: {\n      min: 1,\n      max: 32,\n      step: 1\n    }\n  });\n\n  game.settings.register(MODULE_ID, 'libraryState', {\n    name: 'Library State',\n    hint: 'Internal storage for library items and playlists',\n    scope: 'world',\n    config: false,\n    type: String,\n    default: ''\n  });\n}\n\n// ─────────────────────────────────────────────────────────────\n// Cleanup\n// ─────────────────────────────────────────────────────────────\n\nHooks.once('closeGame', () => {\n  mixerApp?.close();\n  libraryApp?.close();\n  volumePanel?.close();\n  socketManager?.dispose();\n  gmEngine?.dispose();\n  playerEngine?.dispose();\n  libraryManager?.dispose();\n});"],"names":["PREFIX","Logger","message","args","_a","StreamingPlayer","id","ctx","channelOutput","group","__publicField","e","url","resolve","reject","onCanPlay","onError","offset","error","time","safeTime","value","newGroup","newOutput","getServerTime","formatTime","seconds","mins","secs","generateUUID","c","r","SUPPORTED_AUDIO_FORMATS","AUDIO_MIME_TYPES","isValidAudioFormat","extension","getFileExtension","match","getAudioMimeType","validateAudioFile","mimeType","MODULE_ID","getMaxSimultaneous","AudioEngine","state","savedJson","config","trackId","validation","player","t","maxSimultaneous","playingCount","volume","loop","channel","tracks","trackState","stateTrackIds","PlayerAudioEngine","safeValue","volumes","payload","elapsed","adjustedOffset","isPlaying","seekTimestamp","newTrackIds","adjustedTime","SOCKET_NAME","SocketManager","engine","enabled","startPayload","statePayload","playPayload","pausePayload","stopPayload","seekPayload","volPayload","loopPayload","chVolPayload","type","targetUserId","now","userId","pausedAt","throttle","fn","delay","lastCall","timeoutId","remaining","debounce","SoundMixerApp","socket","options","currentTime","duration","parts","html","event","throttledChannelVolume","throttledVolume","throttledSeek","indicator","trackEl","progress","seekSlider","totalTracks","path","_b","errorMessage","PlayerVolumePanel","saved","LocalLibraryApp","library","items","playlists","stats","favoriteItems","favoritePlaylists","favorites","item","playlist","p","tags","lowerTags","itemId","isFavorite","_c","name","playlistId","favoriteId","favoriteType","PlaylistManager","onChangeCallback","description","updates","existing","updated","libraryItemId","playlistItemId","index","initialLength","removed","totalRemoved","i","newOrder","itemIndex","b","playlistsData","sum","LIBRARY_VERSION","LibraryManager","itemName","existingByUrl","existingByName","query","lowerQuery","tag","tagSet","oldTag","newTag","count","playlistStats","gmEngine","mixerApp","libraryApp","libraryManager","playerEngine","volumePanel","socketManager","controls","isGM","tools","registerSettings","initializeGM","initializePlayer","openMixer","openVolumePanel","openLibrary","setupAutoplayHandler","savedVolume","resumeAudio"],"mappings":"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"}
>>>>>>> 8fb7c96024bde7f7faccf475e960cd4be96586a3
