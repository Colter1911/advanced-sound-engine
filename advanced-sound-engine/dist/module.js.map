{"version":3,"file":"module.js","sources":["../src/utils/logger.ts","../src/core/StreamingPlayer.ts","../src/utils/time.ts","../src/utils/uuid.ts","../src/utils/audio-validation.ts","../src/core/AudioEngine.ts","../src/core/PlayerAudioEngine.ts","../src/sync/SocketManager.ts","../src/ui/PlayerVolumePanel.ts","../src/ui/LocalLibraryApp.ts","../src/utils/throttle.ts","../src/ui/SoundMixerApp.ts","../src/ui/AdvancedSoundEngineApp.ts","../src/library/PlaylistManager.ts","../src/library/LibraryManager.ts","../src/queue/PlaybackQueueManager.ts","../src/main.ts"],"sourcesContent":["const PREFIX = 'ASE';\r\n\r\nexport const Logger = {\r\n  info: (message: string, ...args: unknown[]) => {\r\n    console.log(`${PREFIX} | ${message}`, ...args);\r\n  },\r\n  \r\n  warn: (message: string, ...args: unknown[]) => {\r\n    console.warn(`${PREFIX} | ${message}`, ...args);\r\n  },\r\n  \r\n  error: (message: string, ...args: unknown[]) => {\r\n    console.error(`${PREFIX} | ${message}`, ...args);\r\n  },\r\n  \r\n  debug: (message: string, ...args: unknown[]) => {\r\n    if (CONFIG?.debug?.audio) {\r\n      console.debug(`${PREFIX} | ${message}`, ...args);\r\n    }\r\n  }\r\n};","import type { TrackGroup, PlaybackState } from '@t/audio';\r\nimport { Logger } from '@utils/logger';\r\n\r\nexport class StreamingPlayer {\r\n  readonly id: string;\r\n  private ctx: AudioContext;\r\n  private _group: TrackGroup;\r\n  private _url: string = '';\r\n  \r\n  private audio: HTMLAudioElement;\r\n  private sourceNode: MediaElementAudioSourceNode | null = null;\r\n  private gainNode: GainNode;\r\n  private outputNode: GainNode;\r\n  \r\n  private _state: PlaybackState = 'stopped';\r\n  private _volume: number = 1;\r\n  private _loop: boolean = false;\r\n  private _ready: boolean = false;\r\n\r\n  constructor(\r\n    id: string,\r\n    ctx: AudioContext,\r\n    channelOutput: GainNode,\r\n    group: TrackGroup = 'music'\r\n  ) {\r\n    this.id = id;\r\n    this.ctx = ctx;\r\n    this._group = group;\r\n    \r\n    this.audio = new Audio();\r\n    this.audio.crossOrigin = 'anonymous';\r\n    this.audio.preload = 'auto';\r\n    \r\n    this.gainNode = ctx.createGain();\r\n    this.outputNode = ctx.createGain();\r\n    \r\n    this.gainNode.connect(this.outputNode);\r\n    this.outputNode.connect(channelOutput);\r\n    \r\n    this.setupAudioEvents();\r\n  }\r\n\r\n  private setupAudioEvents(): void {\r\n    this.audio.addEventListener('canplay', () => {\r\n      this._ready = true;\r\n      if (this._state === 'loading') {\r\n        this._state = 'stopped';\r\n      }\r\n      Logger.debug(`Track ${this.id} ready to play`);\r\n    });\r\n\r\n    this.audio.addEventListener('ended', () => {\r\n      if (!this._loop) {\r\n        this._state = 'stopped';\r\n        Logger.debug(`Track ${this.id} ended`);\r\n      }\r\n    });\r\n\r\n    this.audio.addEventListener('error', (e) => {\r\n      Logger.error(`Track ${this.id} error:`, this.audio.error);\r\n      this._state = 'stopped';\r\n    });\r\n  }\r\n\r\n  get state(): PlaybackState {\r\n    return this._state;\r\n  }\r\n\r\n  get group(): TrackGroup {\r\n    return this._group;\r\n  }\r\n\r\n  get url(): string {\r\n    return this._url;\r\n  }\r\n\r\n  get volume(): number {\r\n    return this._volume;\r\n  }\r\n\r\n  get loop(): boolean {\r\n    return this._loop;\r\n  }\r\n\r\n  get ready(): boolean {\r\n    return this._ready;\r\n  }\r\n\r\n  async load(url: string): Promise<void> {\r\n    this._state = 'loading';\r\n    this._url = url;\r\n    this._ready = false;\r\n\r\n    return new Promise((resolve, reject) => {\r\n      const onCanPlay = () => {\r\n        this.audio.removeEventListener('canplay', onCanPlay);\r\n        this.audio.removeEventListener('error', onError);\r\n        \r\n        // Connect to Web Audio\r\n        if (!this.sourceNode) {\r\n          this.sourceNode = this.ctx.createMediaElementSource(this.audio);\r\n          this.sourceNode.connect(this.gainNode);\r\n        }\r\n        \r\n        this._ready = true;\r\n        this._state = 'stopped';\r\n        Logger.debug(`Track loaded: ${this.id}`);\r\n        resolve();\r\n      };\r\n\r\n      const onError = () => {\r\n        this.audio.removeEventListener('canplay', onCanPlay);\r\n        this.audio.removeEventListener('error', onError);\r\n        this._state = 'stopped';\r\n        reject(new Error(`Failed to load: ${url}`));\r\n      };\r\n\r\n      this.audio.addEventListener('canplay', onCanPlay, { once: true });\r\n      this.audio.addEventListener('error', onError, { once: true });\r\n      \r\n      this.audio.src = url;\r\n      this.audio.load();\r\n    });\r\n  }\r\n\r\n  async play(offset: number = 0): Promise<void> {\r\n    if (!this._ready) {\r\n      Logger.warn(`Track ${this.id} not ready`);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      this.audio.currentTime = Math.max(0, Math.min(offset, this.audio.duration || 0));\r\n      this.audio.loop = this._loop;\r\n      await this.audio.play();\r\n      this._state = 'playing';\r\n      Logger.debug(`Track ${this.id} playing from ${offset.toFixed(2)}s`);\r\n    } catch (error) {\r\n      Logger.error(`Failed to play ${this.id}:`, error);\r\n    }\r\n  }\r\n\r\n  pause(): void {\r\n    if (this._state !== 'playing') return;\r\n    \r\n    this.audio.pause();\r\n    this._state = 'paused';\r\n    Logger.debug(`Track ${this.id} paused at ${this.audio.currentTime.toFixed(2)}s`);\r\n  }\r\n\r\n  stop(): void {\r\n    this.audio.pause();\r\n    this.audio.currentTime = 0;\r\n    this._state = 'stopped';\r\n    Logger.debug(`Track ${this.id} stopped`);\r\n  }\r\n\r\n  seek(time: number): void {\r\n    const safeTime = Math.max(0, Math.min(time, this.audio.duration || 0));\r\n    this.audio.currentTime = safeTime;\r\n  }\r\n\r\n  setVolume(value: number): void {\r\n    this._volume = Math.max(0, Math.min(1, value));\r\n    this.gainNode.gain.setValueAtTime(this._volume, this.ctx.currentTime);\r\n  }\r\n\r\n  setLoop(value: boolean): void {\r\n    this._loop = value;\r\n    this.audio.loop = value;\r\n  }\r\n\r\n  setChannel(newGroup: TrackGroup, newOutput: GainNode): void {\r\n    this._group = newGroup;\r\n    this.outputNode.disconnect();\r\n    this.outputNode.connect(newOutput);\r\n  }\r\n\r\n  getCurrentTime(): number {\r\n    return this.audio.currentTime;\r\n  }\r\n\r\n  getDuration(): number {\r\n    return this.audio.duration || 0;\r\n  }\r\n\r\n  getState() {\r\n    return {\r\n      id: this.id,\r\n      url: this._url,\r\n      group: this._group,\r\n      playbackState: this._state,\r\n      volume: this._volume,\r\n      loop: this._loop,\r\n      currentTime: this.getCurrentTime(),\r\n      duration: this.getDuration()\r\n    };\r\n  }\r\n\r\n  dispose(): void {\r\n    this.audio.pause();\r\n    this.audio.src = '';\r\n    this.sourceNode?.disconnect();\r\n    this.gainNode.disconnect();\r\n    this.outputNode.disconnect();\r\n    Logger.debug(`Track ${this.id} disposed`);\r\n  }\r\n}","/**\r\n * Get current server time (for sync calculations)\r\n */\r\nexport function getServerTime(): number {\r\n  // Foundry's game.time.serverTime учитывает offset\r\n  return Date.now();\r\n}\r\n\r\n/**\r\n * Calculate playback offset based on start time\r\n */\r\nexport function calculateOffset(startedAt: number, pausedAt: number = 0): number {\r\n  if (pausedAt > 0) {\r\n    return pausedAt;\r\n  }\r\n  return (getServerTime() - startedAt) / 1000;\r\n}\r\n\r\n/**\r\n * Format seconds to mm:ss\r\n */\r\nexport function formatTime(seconds: number): string {\r\n  if (!isFinite(seconds) || seconds < 0) return '0:00';\r\n  \r\n  const mins = Math.floor(seconds / 60);\r\n  const secs = Math.floor(seconds % 60);\r\n  return `${mins}:${secs.toString().padStart(2, '0')}`;\r\n}","/**\r\n * Generate a UUID v4\r\n * Based on RFC 4122 standard\r\n */\r\nexport function generateUUID(): string {\r\n  // Use crypto.randomUUID if available (modern browsers/Node 19+)\r\n  if (typeof crypto !== 'undefined' && crypto.randomUUID) {\r\n    return crypto.randomUUID();\r\n  }\r\n\r\n  // Fallback: manual UUID v4 generation\r\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {\r\n    const r = Math.random() * 16 | 0;\r\n    const v = c === 'x' ? r : (r & 0x3 | 0x8);\r\n    return v.toString(16);\r\n  });\r\n}\r\n\r\n/**\r\n * Validate UUID format\r\n */\r\nexport function isValidUUID(uuid: string): boolean {\r\n  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;\r\n  return uuidRegex.test(uuid);\r\n}\r\n","/**\r\n * Поддерживаемые аудио форматы\r\n */\r\nexport const SUPPORTED_AUDIO_FORMATS = [\r\n  '.mp3',\r\n  '.ogg',\r\n  '.wav',\r\n  '.webm',\r\n  '.m4a',\r\n  '.aac',\r\n  '.flac',\r\n  '.opus'\r\n] as const;\r\n\r\nexport type SupportedAudioFormat = typeof SUPPORTED_AUDIO_FORMATS[number];\r\n\r\n/**\r\n * MIME типы для поддерживаемых форматов\r\n */\r\nexport const AUDIO_MIME_TYPES: Record<string, string> = {\r\n  '.mp3': 'audio/mpeg',\r\n  '.ogg': 'audio/ogg',\r\n  '.wav': 'audio/wav',\r\n  '.webm': 'audio/webm',\r\n  '.m4a': 'audio/mp4',\r\n  '.aac': 'audio/aac',\r\n  '.flac': 'audio/flac',\r\n  '.opus': 'audio/opus'\r\n};\r\n\r\n/**\r\n * Проверка, является ли файл поддерживаемым аудио форматом\r\n */\r\nexport function isValidAudioFormat(url: string): boolean {\r\n  const extension = getFileExtension(url);\r\n  return SUPPORTED_AUDIO_FORMATS.includes(extension as SupportedAudioFormat);\r\n}\r\n\r\n/**\r\n * Получить расширение файла из URL\r\n */\r\nexport function getFileExtension(url: string): string {\r\n  try {\r\n    // Decode URL first\r\n    const decoded = decodeURIComponent(url);\r\n\r\n    // Remove query parameters and hash\r\n    const cleanUrl = decoded.split('?')[0].split('#')[0];\r\n\r\n    // Extract extension\r\n    const match = cleanUrl.match(/\\.([a-z0-9]+)$/i);\r\n    return match ? `.${match[1].toLowerCase()}` : '';\r\n  } catch {\r\n    return '';\r\n  }\r\n}\r\n\r\n/**\r\n * Получить MIME тип для аудио файла\r\n */\r\nexport function getAudioMimeType(url: string): string | null {\r\n  const extension = getFileExtension(url);\r\n  return AUDIO_MIME_TYPES[extension] || null;\r\n}\r\n\r\n/**\r\n * Валидация результата с деталями ошибки\r\n */\r\nexport interface AudioValidationResult {\r\n  valid: boolean;\r\n  error?: string;\r\n  extension?: string;\r\n  mimeType?: string;\r\n}\r\n\r\n/**\r\n * Полная валидация аудио файла\r\n */\r\nexport function validateAudioFile(url: string): AudioValidationResult {\r\n  if (!url || typeof url !== 'string') {\r\n    return {\r\n      valid: false,\r\n      error: 'URL is required and must be a string'\r\n    };\r\n  }\r\n\r\n  const extension = getFileExtension(url);\r\n\r\n  if (!extension) {\r\n    return {\r\n      valid: false,\r\n      error: 'Could not extract file extension from URL'\r\n    };\r\n  }\r\n\r\n  if (!isValidAudioFormat(url)) {\r\n    return {\r\n      valid: false,\r\n      error: `Unsupported audio format: ${extension}. Supported formats: ${SUPPORTED_AUDIO_FORMATS.join(', ')}`,\r\n      extension\r\n    };\r\n  }\r\n\r\n  const mimeType = getAudioMimeType(url);\r\n\r\n  return {\r\n    valid: true,\r\n    extension,\r\n    mimeType: mimeType || undefined\r\n  };\r\n}\r\n\r\n/**\r\n * Проверка поддержки формата браузером\r\n */\r\nexport function isBrowserAudioSupported(extension: string): boolean {\r\n  if (typeof Audio === 'undefined') {\r\n    return false;\r\n  }\r\n\r\n  const mimeType = AUDIO_MIME_TYPES[extension];\r\n  if (!mimeType) {\r\n    return false;\r\n  }\r\n\r\n  const audio = new Audio();\r\n  const canPlay = audio.canPlayType(mimeType);\r\n\r\n  // Returns: '' (no support), 'maybe', 'probably'\r\n  return canPlay === 'probably' || canPlay === 'maybe';\r\n}\r\n","import type { TrackConfig, TrackState, MixerState, TrackGroup, ChannelVolumes } from '@t/audio';\r\nimport { StreamingPlayer } from './StreamingPlayer';\r\nimport { Logger } from '@utils/logger';\r\nimport { getServerTime } from '@utils/time';\r\nimport { generateUUID } from '@utils/uuid';\r\nimport { validateAudioFile } from '@utils/audio-validation';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\n\r\nfunction getMaxSimultaneous(): number {\r\n  return (game.settings.get(MODULE_ID, 'maxSimultaneousTracks') as number) || 8;\r\n}\r\n\r\nexport class AudioEngine {\r\n  private ctx: AudioContext;\r\n  private masterGain: GainNode;\r\n  private channelGains: Record<TrackGroup, GainNode>;\r\n  private players: Map<string, StreamingPlayer> = new Map();\r\n  \r\n  private _volumes: ChannelVolumes = {\r\n    master: 1,\r\n    music: 1,\r\n    ambience: 1,\r\n    sfx: 1\r\n  };\r\n  \r\n  private saveTimeout: ReturnType<typeof setTimeout> | null = null;\r\n\r\n  constructor() {\r\n    this.ctx = new AudioContext();\r\n    \r\n    this.masterGain = this.ctx.createGain();\r\n    this.masterGain.connect(this.ctx.destination);\r\n    \r\n    this.channelGains = {\r\n      music: this.ctx.createGain(),\r\n      ambience: this.ctx.createGain(),\r\n      sfx: this.ctx.createGain()\r\n    };\r\n    \r\n    this.channelGains.music.connect(this.masterGain);\r\n    this.channelGains.ambience.connect(this.masterGain);\r\n    this.channelGains.sfx.connect(this.masterGain);\r\n    \r\n    Logger.info('AudioEngine initialized');\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Persistence (GM only)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private scheduleSave(): void {\r\n    if (!game.user?.isGM) return;\r\n    \r\n    if (this.saveTimeout) {\r\n      clearTimeout(this.saveTimeout);\r\n    }\r\n    this.saveTimeout = setTimeout(() => {\r\n      this.saveState();\r\n    }, 500);\r\n  }\r\n\r\n  private async saveState(): Promise<void> {\r\n    if (!game.ready || !game.user?.isGM) return;\r\n    \r\n    const state = this.getState();\r\n    \r\n    try {\r\n      await game.settings.set(MODULE_ID, 'mixerState', JSON.stringify(state));\r\n      Logger.debug('Mixer state saved');\r\n    } catch (error) {\r\n      Logger.error('Failed to save mixer state:', error);\r\n    }\r\n  }\r\n\r\n  async loadSavedState(): Promise<void> {\r\n    if (!game.ready) return;\r\n    \r\n    try {\r\n      const savedJson = game.settings.get(MODULE_ID, 'mixerState') as string;\r\n      if (!savedJson) return;\r\n      \r\n      const state = JSON.parse(savedJson) as MixerState;\r\n      await this.restoreState(state);\r\n      \r\n      Logger.info('Mixer state restored');\r\n    } catch (error) {\r\n      Logger.error('Failed to load mixer state:', error);\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Track Management\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  async createTrack(config: TrackConfig): Promise<StreamingPlayer> {\r\n    // Generate UUID if not provided\r\n    const trackId = config.id || generateUUID();\r\n\r\n    if (this.players.has(trackId)) {\r\n      return this.players.get(trackId)!;\r\n    }\r\n\r\n    // Validate audio file format\r\n    const validation = validateAudioFile(config.url);\r\n    if (!validation.valid) {\r\n      const error = new Error(validation.error || 'Invalid audio file');\r\n      Logger.error(`Track validation failed: ${validation.error}`);\r\n      throw error;\r\n    }\r\n\r\n    const channelOutput = this.channelGains[config.group];\r\n\r\n    const player = new StreamingPlayer(\r\n      trackId,\r\n      this.ctx,\r\n      channelOutput,\r\n      config.group\r\n    );\r\n\r\n    if (config.volume !== undefined) {\r\n      player.setVolume(config.volume);\r\n    }\r\n    if (config.loop !== undefined) {\r\n      player.setLoop(config.loop);\r\n    }\r\n\r\n    await player.load(config.url);\r\n\r\n    this.players.set(trackId, player);\r\n    this.scheduleSave();\r\n\r\n    Logger.info(`Track created: ${trackId} (${validation.extension})`);\r\n    return player;\r\n  }\r\n\r\n  getTrack(id: string): StreamingPlayer | undefined {\r\n    return this.players.get(id);\r\n  }\r\n\r\n  removeTrack(id: string): boolean {\r\n    const player = this.players.get(id);\r\n    if (!player) return false;\r\n\r\n    player.dispose();\r\n    this.players.delete(id);\r\n    this.scheduleSave();\r\n    \r\n    Logger.info(`Track removed: ${id}`);\r\n    return true;\r\n  }\r\n\r\n  getAllTracks(): StreamingPlayer[] {\r\n    return Array.from(this.players.values());\r\n  }\r\n\r\n  getTracksByGroup(group: TrackGroup): StreamingPlayer[] {\r\n    return this.getAllTracks().filter(t => t.group === group);\r\n  }\r\n\r\n  setTrackChannel(id: string, newGroup: TrackGroup): void {\r\n    const player = this.players.get(id);\r\n    if (!player) return;\r\n    \r\n    player.setChannel(newGroup, this.channelGains[newGroup]);\r\n    this.scheduleSave();\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Playback Control\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  async playTrack(id: string, offset: number = 0): Promise<void> {\r\n    const player = this.players.get(id);\r\n    if (!player) {\r\n      Logger.warn(`Track not found: ${id}`);\r\n      return;\r\n    }\r\n\r\n    const maxSimultaneous = getMaxSimultaneous();\r\n    const playingCount = this.getAllTracks().filter(t => t.state === 'playing').length;\r\n    const isCurrentlyPlaying = player.state === 'playing';\r\n\r\n    if (!isCurrentlyPlaying && playingCount >= maxSimultaneous) {\r\n      Logger.warn(`Maximum simultaneous tracks (${maxSimultaneous}) reached`);\r\n      ui.notifications?.warn(`Cannot play more than ${maxSimultaneous} tracks simultaneously`);\r\n      return;\r\n    }\r\n\r\n    await player.play(offset);\r\n  }\r\n\r\n  pauseTrack(id: string): void {\r\n    this.players.get(id)?.pause();\r\n  }\r\n\r\n  stopTrack(id: string): void {\r\n    this.players.get(id)?.stop();\r\n  }\r\n\r\n  seekTrack(id: string, time: number): void {\r\n    this.players.get(id)?.seek(time);\r\n  }\r\n\r\n  setTrackVolume(id: string, volume: number): void {\r\n    this.players.get(id)?.setVolume(volume);\r\n    this.scheduleSave();\r\n  }\r\n\r\n  setTrackLoop(id: string, loop: boolean): void {\r\n    this.players.get(id)?.setLoop(loop);\r\n    this.scheduleSave();\r\n  }\r\n\r\n  stopAll(): void {\r\n    for (const player of this.players.values()) {\r\n      player.stop();\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Volume Control\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  get volumes(): ChannelVolumes {\r\n    return { ...this._volumes };\r\n  }\r\n\r\n  setMasterVolume(value: number): void {\r\n    this._volumes.master = Math.max(0, Math.min(1, value));\r\n    this.masterGain.gain.linearRampToValueAtTime(\r\n      this._volumes.master,\r\n      this.ctx.currentTime + 0.01\r\n    );\r\n    this.scheduleSave();\r\n  }\r\n\r\n  setChannelVolume(channel: TrackGroup, value: number): void {\r\n    this._volumes[channel] = Math.max(0, Math.min(1, value));\r\n    this.channelGains[channel].gain.linearRampToValueAtTime(\r\n      this._volumes[channel],\r\n      this.ctx.currentTime + 0.01\r\n    );\r\n    this.scheduleSave();\r\n  }\r\n\r\n  getChannelVolume(channel: TrackGroup): number {\r\n    return this._volumes[channel];\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // State\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  getState(): MixerState {\r\n    const tracks: TrackState[] = [];\r\n    \r\n    for (const player of this.players.values()) {\r\n      tracks.push(player.getState());\r\n    }\r\n\r\n    return {\r\n      masterVolume: this._volumes.master,\r\n      channelVolumes: { ...this._volumes },\r\n      tracks,\r\n      timestamp: getServerTime(),\r\n      syncEnabled: false\r\n    };\r\n  }\r\n\r\n  async restoreState(state: MixerState): Promise<void> {\r\n    // Restore volumes\r\n    this._volumes.master = state.masterVolume;\r\n    this.masterGain.gain.setValueAtTime(this._volumes.master, this.ctx.currentTime);\r\n    \r\n    if (state.channelVolumes) {\r\n      for (const channel of ['music', 'ambience', 'sfx'] as TrackGroup[]) {\r\n        this._volumes[channel] = state.channelVolumes[channel];\r\n        this.channelGains[channel].gain.setValueAtTime(this._volumes[channel], this.ctx.currentTime);\r\n      }\r\n    }\r\n\r\n    // Restore tracks (without playing)\r\n    for (const trackState of state.tracks) {\r\n      if (!this.players.has(trackState.id)) {\r\n        try {\r\n          await this.createTrack({\r\n            id: trackState.id,\r\n            url: trackState.url,\r\n            group: trackState.group,\r\n            volume: trackState.volume,\r\n            loop: trackState.loop\r\n          });\r\n        } catch (error) {\r\n          Logger.error(`Failed to restore track ${trackState.id}:`, error);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Remove tracks not in state\r\n    const stateTrackIds = new Set(state.tracks.map(t => t.id));\r\n    for (const [id] of this.players) {\r\n      if (!stateTrackIds.has(id)) {\r\n        this.removeTrack(id);\r\n      }\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Audio Context\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  async resume(): Promise<void> {\r\n    if (this.ctx.state === 'suspended') {\r\n      await this.ctx.resume();\r\n      Logger.info('AudioContext resumed');\r\n    }\r\n  }\r\n\r\n  get contextState(): AudioContextState {\r\n    return this.ctx.state;\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Cleanup\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  dispose(): void {\r\n    if (this.saveTimeout) {\r\n      clearTimeout(this.saveTimeout);\r\n    }\r\n    for (const player of this.players.values()) {\r\n      player.dispose();\r\n    }\r\n    this.players.clear();\r\n    this.ctx.close();\r\n    Logger.info('AudioEngine disposed');\r\n  }\r\n}","import type { TrackGroup, ChannelVolumes, SyncTrackState, TrackPlayPayload } from '@t/audio';\r\nimport { StreamingPlayer } from './StreamingPlayer';\r\nimport { Logger } from '@utils/logger';\r\nimport { getServerTime } from '@utils/time';\r\n\r\n/**\r\n * Упрощенный движок для игроков — только получает команды\r\n */\r\nexport class PlayerAudioEngine {\r\n  private ctx: AudioContext;\r\n  private masterGain: GainNode;\r\n  private gmGain: GainNode; // Громкость от GM\r\n  private channelGains: Record<TrackGroup, GainNode>;\r\n  private players: Map<string, StreamingPlayer> = new Map();\r\n\r\n  private _localVolume: number = 1; // Личная громкость игрока\r\n  private _gmVolumes: ChannelVolumes = {\r\n    master: 1,\r\n    music: 1,\r\n    ambience: 1,\r\n    sfx: 1\r\n  };\r\n\r\n  constructor() {\r\n    this.ctx = new AudioContext();\r\n\r\n    // Chain: tracks -> channels -> gmGain -> masterGain -> destination\r\n    this.masterGain = this.ctx.createGain();\r\n    this.masterGain.connect(this.ctx.destination);\r\n\r\n    this.gmGain = this.ctx.createGain();\r\n    this.gmGain.connect(this.masterGain);\r\n\r\n    this.channelGains = {\r\n      music: this.ctx.createGain(),\r\n      ambience: this.ctx.createGain(),\r\n      sfx: this.ctx.createGain()\r\n    };\r\n\r\n    this.channelGains.music.connect(this.gmGain);\r\n    this.channelGains.ambience.connect(this.gmGain);\r\n    this.channelGains.sfx.connect(this.gmGain);\r\n\r\n    Logger.info('PlayerAudioEngine initialized');\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Local Volume (Player's personal control)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  get localVolume(): number {\r\n    return this._localVolume;\r\n  }\r\n\r\n  setLocalVolume(value: number): void {\r\n    this._localVolume = Math.max(0, Math.min(1, value));\r\n    this.masterGain.gain.linearRampToValueAtTime(\r\n      this._localVolume,\r\n      this.ctx.currentTime + 0.01\r\n    );\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // GM Volume (from sync)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  setGMVolume(channel: TrackGroup | 'master', value: number): void {\r\n    const safeValue = Math.max(0, Math.min(1, value));\r\n\r\n    if (channel === 'master') {\r\n      this._gmVolumes.master = safeValue;\r\n      this.gmGain.gain.linearRampToValueAtTime(safeValue, this.ctx.currentTime + 0.01);\r\n    } else {\r\n      this._gmVolumes[channel] = safeValue;\r\n      this.channelGains[channel].gain.linearRampToValueAtTime(safeValue, this.ctx.currentTime + 0.01);\r\n    }\r\n  }\r\n\r\n  setAllGMVolumes(volumes: ChannelVolumes): void {\r\n    this._gmVolumes = { ...volumes };\r\n\r\n    this.gmGain.gain.setValueAtTime(volumes.master, this.ctx.currentTime);\r\n    this.channelGains.music.gain.setValueAtTime(volumes.music, this.ctx.currentTime);\r\n    this.channelGains.ambience.gain.setValueAtTime(volumes.ambience, this.ctx.currentTime);\r\n    this.channelGains.sfx.gain.setValueAtTime(volumes.sfx, this.ctx.currentTime);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Local Playback Control (Interface Compliance)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  async playTrack(id: string, offset: number = 0): Promise<void> {\r\n    const player = this.players.get(id);\r\n    if (player) {\r\n      await player.play(offset);\r\n    } else {\r\n      Logger.warn(`PlayerAudioEngine: Track ${id} not found locally.`);\r\n    }\r\n  }\r\n\r\n  pauseTrack(id: string): void {\r\n    this.players.get(id)?.pause();\r\n  }\r\n\r\n  stopTrack(id: string): void {\r\n    this.players.get(id)?.stop();\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Track Commands (from GM via socket)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  async handlePlay(payload: TrackPlayPayload): Promise<void> {\r\n    let player = this.players.get(payload.trackId);\r\n\r\n    // Create if doesn't exist\r\n    if (!player) {\r\n      player = new StreamingPlayer(\r\n        payload.trackId,\r\n        this.ctx,\r\n        this.channelGains[payload.group],\r\n        payload.group\r\n      );\r\n\r\n      await player.load(payload.url);\r\n      this.players.set(payload.trackId, player);\r\n    }\r\n\r\n    player.setVolume(payload.volume);\r\n    player.setLoop(payload.loop);\r\n\r\n    // Calculate offset based on time elapsed since GM started\r\n    const elapsed = (getServerTime() - payload.startTimestamp) / 1000;\r\n    const adjustedOffset = Math.max(0, payload.offset + elapsed);\r\n\r\n    await player.play(adjustedOffset);\r\n    Logger.debug(`Player: track ${payload.trackId} playing at ${adjustedOffset.toFixed(2)}s`);\r\n  }\r\n\r\n  handlePause(trackId: string): void {\r\n    this.players.get(trackId)?.pause();\r\n  }\r\n\r\n  handleStop(trackId: string): void {\r\n    this.players.get(trackId)?.stop();\r\n  }\r\n\r\n  handleSeek(trackId: string, time: number, isPlaying: boolean, seekTimestamp: number): void {\r\n    const player = this.players.get(trackId);\r\n    if (!player) return;\r\n\r\n    if (isPlaying) {\r\n      const elapsed = (getServerTime() - seekTimestamp) / 1000;\r\n      player.seek(time + elapsed);\r\n    } else {\r\n      player.seek(time);\r\n    }\r\n  }\r\n\r\n  handleTrackVolume(trackId: string, volume: number): void {\r\n    this.players.get(trackId)?.setVolume(volume);\r\n  }\r\n\r\n  handleTrackLoop(trackId: string, loop: boolean): void {\r\n    this.players.get(trackId)?.setLoop(loop);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Sync State (full state from GM)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  async syncState(tracks: SyncTrackState[], volumes: ChannelVolumes): Promise<void> {\r\n    // Set volumes\r\n    this.setAllGMVolumes(volumes);\r\n\r\n    // Handle tracks\r\n    const newTrackIds = new Set(tracks.map(t => t.id));\r\n\r\n    // Remove tracks not in sync\r\n    for (const [id, player] of this.players) {\r\n      if (!newTrackIds.has(id)) {\r\n        player.dispose();\r\n        this.players.delete(id);\r\n      }\r\n    }\r\n\r\n    // Add/update tracks\r\n    for (const trackState of tracks) {\r\n      let player = this.players.get(trackState.id);\r\n\r\n      if (!player) {\r\n        player = new StreamingPlayer(\r\n          trackState.id,\r\n          this.ctx,\r\n          this.channelGains[trackState.group],\r\n          trackState.group\r\n        );\r\n\r\n        await player.load(trackState.url);\r\n        this.players.set(trackState.id, player);\r\n      }\r\n\r\n      player.setVolume(trackState.volume);\r\n      player.setLoop(trackState.loop);\r\n\r\n      if (trackState.isPlaying) {\r\n        const elapsed = (getServerTime() - trackState.startTimestamp) / 1000;\r\n        const adjustedTime = trackState.currentTime + elapsed;\r\n        await player.play(adjustedTime);\r\n      } else {\r\n        player.stop();\r\n      }\r\n    }\r\n\r\n    Logger.info('Player: synced state from GM');\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Sync Off\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  stopAll(): void {\r\n    for (const player of this.players.values()) {\r\n      player.stop();\r\n    }\r\n  }\r\n\r\n  clearAll(): void {\r\n    for (const player of this.players.values()) {\r\n      player.dispose();\r\n    }\r\n    this.players.clear();\r\n    Logger.info('Player: all tracks cleared');\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Audio Context\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  async resume(): Promise<void> {\r\n    if (this.ctx.state === 'suspended') {\r\n      await this.ctx.resume();\r\n      Logger.info('PlayerAudioEngine: AudioContext resumed');\r\n    }\r\n  }\r\n\r\n  dispose(): void {\r\n    this.clearAll();\r\n    this.ctx.close();\r\n    Logger.info('PlayerAudioEngine disposed');\r\n  }\r\n}","import type { \r\n  SocketMessage, \r\n  SocketMessageType,\r\n  SyncStatePayload,\r\n  SyncTrackState,\r\n  TrackPlayPayload,\r\n  TrackPausePayload,\r\n  TrackStopPayload,\r\n  TrackSeekPayload,\r\n  TrackVolumePayload,\r\n  TrackLoopPayload,\r\n  ChannelVolumePayload,\r\n  TrackGroup,\r\n  ChannelVolumes\r\n} from '@t/audio';\r\nimport { AudioEngine } from '@core/AudioEngine';\r\nimport { PlayerAudioEngine } from '@core/PlayerAudioEngine';\r\nimport { Logger } from '@utils/logger';\r\nimport { getServerTime } from '@utils/time';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\nconst SOCKET_NAME = `module.${MODULE_ID}`;\r\n\r\nexport class SocketManager {\r\n  private gmEngine: AudioEngine | null = null;\r\n  private playerEngine: PlayerAudioEngine | null = null;\r\n  private socket: any = null;\r\n  private _syncEnabled: boolean = false;\r\n  private isGM: boolean = false;\r\n\r\n  constructor() {}\r\n\r\n  initializeAsGM(engine: AudioEngine): void {\r\n    this.isGM = true;\r\n    this.gmEngine = engine;\r\n    this.socket = game.socket;\r\n    \r\n    this.socket?.on(SOCKET_NAME, (message: SocketMessage) => {\r\n      this.handleGMMessage(message);\r\n    });\r\n    \r\n    Logger.info('SocketManager initialized as GM');\r\n  }\r\n\r\n  initializeAsPlayer(engine: PlayerAudioEngine): void {\r\n    this.isGM = false;\r\n    this.playerEngine = engine;\r\n    this.socket = game.socket;\r\n    \r\n    this.socket?.on(SOCKET_NAME, (message: SocketMessage) => {\r\n      this.handlePlayerMessage(message);\r\n    });\r\n    \r\n    // Request current state on join\r\n    setTimeout(() => {\r\n      this.send('player-ready', {});\r\n    }, 1000);\r\n    \r\n    Logger.info('SocketManager initialized as Player');\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Sync Mode (GM)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  get syncEnabled(): boolean {\r\n    return this._syncEnabled;\r\n  }\r\n\r\n  setSyncEnabled(enabled: boolean): void {\r\n    if (!this.isGM) return;\r\n    \r\n    this._syncEnabled = enabled;\r\n    \r\n    if (enabled) {\r\n      this.broadcastSyncStart();\r\n    } else {\r\n      this.broadcastSyncStop();\r\n    }\r\n    \r\n    Logger.info(`Sync mode: ${enabled ? 'ON' : 'OFF'}`);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // GM Message Handling\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private handleGMMessage(message: SocketMessage): void {\r\n    if (message.senderId === game.user?.id) return;\r\n    \r\n    if (message.type === 'player-ready' && this._syncEnabled) {\r\n      // Send current state to newly joined player\r\n      this.sendStateTo(message.senderId);\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Player Message Handling\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async handlePlayerMessage(message: SocketMessage): Promise<void> {\r\n    if (message.senderId === game.user?.id) return;\r\n    if (!this.playerEngine) return;\r\n    \r\n    Logger.debug(`Player received: ${message.type}`, message.payload);\r\n    \r\n    switch (message.type) {\r\n      case 'sync-start':\r\n        const startPayload = message.payload as SyncStatePayload;\r\n        await this.playerEngine.syncState(startPayload.tracks, startPayload.channelVolumes);\r\n        break;\r\n        \r\n      case 'sync-stop':\r\n        this.playerEngine.clearAll();\r\n        break;\r\n        \r\n      case 'sync-state':\r\n        const statePayload = message.payload as SyncStatePayload;\r\n        await this.playerEngine.syncState(statePayload.tracks, statePayload.channelVolumes);\r\n        break;\r\n        \r\n      case 'track-play':\r\n        const playPayload = message.payload as TrackPlayPayload;\r\n        await this.playerEngine.handlePlay(playPayload);\r\n        break;\r\n        \r\n      case 'track-pause':\r\n        const pausePayload = message.payload as TrackPausePayload;\r\n        this.playerEngine.handlePause(pausePayload.trackId);\r\n        break;\r\n        \r\n      case 'track-stop':\r\n        const stopPayload = message.payload as TrackStopPayload;\r\n        this.playerEngine.handleStop(stopPayload.trackId);\r\n        break;\r\n        \r\n      case 'track-seek':\r\n        const seekPayload = message.payload as TrackSeekPayload;\r\n        this.playerEngine.handleSeek(\r\n          seekPayload.trackId, \r\n          seekPayload.time, \r\n          seekPayload.isPlaying,\r\n          seekPayload.seekTimestamp\r\n        );\r\n        break;\r\n        \r\n      case 'track-volume':\r\n        const volPayload = message.payload as TrackVolumePayload;\r\n        this.playerEngine.handleTrackVolume(volPayload.trackId, volPayload.volume);\r\n        break;\r\n        \r\n      case 'track-loop':\r\n        const loopPayload = message.payload as TrackLoopPayload;\r\n        this.playerEngine.handleTrackLoop(loopPayload.trackId, loopPayload.loop);\r\n        break;\r\n        \r\n      case 'channel-volume':\r\n        const chVolPayload = message.payload as ChannelVolumePayload;\r\n        this.playerEngine.setGMVolume(chVolPayload.channel, chVolPayload.volume);\r\n        break;\r\n        \r\n      case 'stop-all':\r\n        this.playerEngine.stopAll();\r\n        break;\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // GM Broadcast Methods\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private send(type: SocketMessageType, payload: unknown, targetUserId?: string): void {\r\n    if (!this.socket) return;\r\n\r\n    const message: SocketMessage = {\r\n      type,\r\n      payload,\r\n      senderId: game.user?.id ?? '',\r\n      timestamp: getServerTime()\r\n    };\r\n\r\n    if (targetUserId) {\r\n      this.socket.emit(SOCKET_NAME, message, { recipients: [targetUserId] });\r\n    } else {\r\n      this.socket.emit(SOCKET_NAME, message);\r\n    }\r\n\r\n    Logger.debug(`Sent: ${type}`, payload);\r\n  }\r\n\r\n  private getCurrentSyncState(): SyncStatePayload {\r\n    if (!this.gmEngine) {\r\n      return { tracks: [], channelVolumes: { master: 1, music: 1, ambience: 1, sfx: 1 } };\r\n    }\r\n    \r\n    const now = getServerTime();\r\n    const tracks: SyncTrackState[] = [];\r\n    \r\n    for (const player of this.gmEngine.getAllTracks()) {\r\n      const state = player.getState();\r\n      tracks.push({\r\n        id: state.id,\r\n        url: state.url,\r\n        group: state.group,\r\n        volume: state.volume,\r\n        loop: state.loop,\r\n        isPlaying: state.playbackState === 'playing',\r\n        currentTime: player.getCurrentTime(),\r\n        startTimestamp: now\r\n      });\r\n    }\r\n    \r\n    return {\r\n      tracks,\r\n      channelVolumes: this.gmEngine.volumes\r\n    };\r\n  }\r\n\r\n  private broadcastSyncStart(): void {\r\n    const state = this.getCurrentSyncState();\r\n    this.send('sync-start', state);\r\n  }\r\n\r\n  private broadcastSyncStop(): void {\r\n    this.send('sync-stop', {});\r\n  }\r\n\r\n  private sendStateTo(userId: string): void {\r\n    const state = this.getCurrentSyncState();\r\n    this.send('sync-state', state, userId);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // GM Actions (called when GM interacts with mixer)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  broadcastTrackPlay(trackId: string, offset: number): void {\r\n    if (!this._syncEnabled || !this.gmEngine) return;\r\n    \r\n    const player = this.gmEngine.getTrack(trackId);\r\n    if (!player) return;\r\n    \r\n    const payload: TrackPlayPayload = {\r\n      trackId,\r\n      url: player.url,\r\n      group: player.group,\r\n      volume: player.volume,\r\n      loop: player.loop,\r\n      offset,\r\n      startTimestamp: getServerTime()\r\n    };\r\n    \r\n    this.send('track-play', payload);\r\n  }\r\n\r\n  broadcastTrackPause(trackId: string, pausedAt: number): void {\r\n    if (!this._syncEnabled) return;\r\n    \r\n    const payload: TrackPausePayload = { trackId, pausedAt };\r\n    this.send('track-pause', payload);\r\n  }\r\n\r\n  broadcastTrackStop(trackId: string): void {\r\n    if (!this._syncEnabled) return;\r\n    \r\n    const payload: TrackStopPayload = { trackId };\r\n    this.send('track-stop', payload);\r\n  }\r\n\r\n  broadcastTrackSeek(trackId: string, time: number, isPlaying: boolean): void {\r\n    if (!this._syncEnabled) return;\r\n    \r\n    const payload: TrackSeekPayload = {\r\n      trackId,\r\n      time,\r\n      isPlaying,\r\n      seekTimestamp: getServerTime()\r\n    };\r\n    this.send('track-seek', payload);\r\n  }\r\n\r\n  broadcastTrackVolume(trackId: string, volume: number): void {\r\n    if (!this._syncEnabled) return;\r\n    \r\n    const payload: TrackVolumePayload = { trackId, volume };\r\n    this.send('track-volume', payload);\r\n  }\r\n\r\n  broadcastTrackLoop(trackId: string, loop: boolean): void {\r\n    if (!this._syncEnabled) return;\r\n    \r\n    const payload: TrackLoopPayload = { trackId, loop };\r\n    this.send('track-loop', payload);\r\n  }\r\n\r\n  broadcastChannelVolume(channel: TrackGroup | 'master', volume: number): void {\r\n    if (!this._syncEnabled) return;\r\n    \r\n    const payload: ChannelVolumePayload = { channel, volume };\r\n    this.send('channel-volume', payload);\r\n  }\r\n\r\n  broadcastStopAll(): void {\r\n    if (!this._syncEnabled) return;\r\n    this.send('stop-all', {});\r\n  }\r\n\r\n  dispose(): void {\r\n    this.socket?.off(SOCKET_NAME);\r\n  }\r\n}","import { PlayerAudioEngine } from '@core/PlayerAudioEngine';\r\nimport { Logger } from '@utils/logger';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\n\r\nexport class PlayerVolumePanel extends Application {\r\n  private engine: PlayerAudioEngine;\r\n\r\n  static override get defaultOptions(): ApplicationOptions {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'ase-player-volume',\r\n      title: 'Sound Volume',\r\n      template: `modules/${MODULE_ID}/templates/player-volume.hbs`,\r\n      classes: ['ase-player-panel'],\r\n      width: 200,\r\n      height: 'auto',\r\n      resizable: false,\r\n      minimizable: true,\r\n      popOut: true\r\n    }) as ApplicationOptions;\r\n  }\r\n\r\n  constructor(engine: PlayerAudioEngine, options?: Partial<ApplicationOptions>) {\r\n    super(options);\r\n    this.engine = engine;\r\n  }\r\n\r\n  override getData() {\r\n    return {\r\n      volume: Math.round(this.engine.localVolume * 100)\r\n    };\r\n  }\r\n\r\n  override activateListeners(html: JQuery): void {\r\n    super.activateListeners(html);\r\n\r\n    html.find('.ase-volume-slider').on('input', (event) => {\r\n      const value = parseFloat((event.target as HTMLInputElement).value) / 100;\r\n      this.engine.setLocalVolume(value);\r\n      html.find('.ase-volume-value').text(`${Math.round(value * 100)}%`);\r\n      \r\n      // Save preference\r\n      this.saveVolume(value);\r\n    });\r\n  }\r\n\r\n  private saveVolume(value: number): void {\r\n    localStorage.setItem(`${MODULE_ID}-player-volume`, String(value));\r\n  }\r\n\r\n  static loadSavedVolume(): number {\r\n    const saved = localStorage.getItem(`${MODULE_ID}-player-volume`);\r\n    return saved ? parseFloat(saved) : 1;\r\n  }\r\n}","import type { LibraryItem, Playlist } from '@t/library';\r\nimport type { TrackGroup } from '@t/audio';\r\nimport { LibraryManager } from '@lib/LibraryManager';\r\nimport { Logger } from '@utils/logger';\r\nimport { formatTime } from '@utils/time';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\n\r\ninterface FilterState {\r\n  searchQuery: string;\r\n  selectedChannels: Set<TrackGroup>;\r\n  selectedPlaylistId: string | null;\r\n  selectedTags: Set<string>;\r\n  sortBy: 'name-asc' | 'name-desc' | 'date-asc' | 'date-desc' | 'duration-asc' | 'duration-desc';\r\n}\r\n\r\ninterface LibraryData {\r\n  items: LibraryItemViewData[];\r\n  playlists: PlaylistViewData[];\r\n  favorites: FavoriteViewData[];\r\n  tags: TagViewData[];\r\n  stats: {\r\n    totalItems: number;\r\n    favoriteItems: number;\r\n    playlists: number;\r\n    tagCount: number;\r\n  };\r\n  searchQuery: string;\r\n  filters: {\r\n    music: boolean;\r\n    ambience: boolean;\r\n    sfx: boolean;\r\n  };\r\n  selectedPlaylistId: string | null;\r\n  sortBy: string;\r\n  hasActiveFilters: boolean;\r\n}\r\n\r\ninterface TagViewData {\r\n  name: string;\r\n  value: string;\r\n  selected: boolean;\r\n}\r\n\r\ninterface LibraryItemViewData {\r\n  id: string;\r\n  name: string;\r\n  url: string;\r\n  duration: string;\r\n  durationFormatted: string;\r\n  durationSeconds: number;\r\n  tags: string[];\r\n  favorite: boolean;\r\n  group: string;\r\n  inQueue: boolean;\r\n}\r\n\r\ninterface PlaylistViewData {\r\n  id: string;\r\n  name: string;\r\n  itemCount: number;\r\n  trackCount: number; // Alias for template\r\n  favorite: boolean;\r\n  inQueue: boolean;\r\n  selected?: boolean;\r\n}\r\n\r\ninterface FavoriteViewData {\r\n  id: string;\r\n  name: string;\r\n  type: 'track' | 'playlist';\r\n  group?: string; // music/ambience/sfx for tracks\r\n  inQueue?: boolean;\r\n}\r\n\r\nexport class LocalLibraryApp extends Application {\r\n  private library: LibraryManager;\r\n  private filterState: FilterState;\r\n\r\n  static override get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'local-library',\r\n      template: 'modules/advanced-sound-engine/templates/library.hbs',\r\n      title: 'Sound Library',\r\n      width: 1100,\r\n      height: 700,\r\n      classes: ['advanced-sound-engine', 'library'],\r\n      resizable: true,\r\n      tabs: [{ navSelector: '.tabs', contentSelector: '.content', initial: 'library' }]\r\n    });\r\n  }\r\n\r\n  private parentApp: any; // Using any to avoid circular import issues for now, or use interface\r\n\r\n  constructor(library: LibraryManager, parentApp: any, options = {}) {\r\n    super(options);\r\n    this.library = library;\r\n    this.parentApp = parentApp;\r\n    this.filterState = {\r\n      searchQuery: '',\r\n      selectedChannels: new Set(['music', 'ambience', 'sfx']),\r\n      selectedPlaylistId: null,\r\n      selectedTags: new Set(),\r\n      // Default sort\r\n      sortBy: 'date-desc'\r\n    } as any;\r\n  }\r\n\r\n  // Helper to request scroll persistence\r\n  private persistScroll(): void {\r\n    if (this.parentApp) {\r\n      this.parentApp.persistScrollOnce = true;\r\n    }\r\n  }\r\n\r\n  // Override render to delegate to main app\r\n  override render(force?: boolean, options?: any): any {\r\n    // If we are part of the unified app, we just trigger the main app to update\r\n    if (window.ASE?.openPanel) {\r\n      window.ASE.openPanel('library', true);\r\n      return;\r\n    }\r\n    return super.render(force, options);\r\n  }\r\n\r\n  override getData(): LibraryData {\r\n    let items = this.library.getAllItems();\r\n    const playlists = this.library.playlists.getAllPlaylists();\r\n    const allTags = this.library.getAllTags();\r\n    const stats = this.library.getStats();\r\n\r\n    // Trigger background scan for missing durations (run once per session)\r\n    this.library.scanMissingDurations().then(() => {\r\n      // If items were updated, we might want to re-render, but usually scheduleSave will trigger an event? \r\n      // For now, we rely on the next interaction or auto-refresh if we implement signals.\r\n      // Or we can force a render if updates happened. \r\n      // But scanMissingDurations is async and we don't await it here to avoid blocking UI.\r\n    });\r\n\r\n    // Apply filters\r\n    items = this.applyFilters(items);\r\n\r\n    // Apply sorting\r\n    items = this.applySorting(items);\r\n\r\n    // Build favorites list (tracks + playlists)\r\n    // Use the ordered list from LibraryManager\r\n    const orderedFavorites = this.library.getOrderedFavorites();\r\n\r\n    const favorites: FavoriteViewData[] = orderedFavorites.map((entry): FavoriteViewData | null => {\r\n      const inQueue = entry.type === 'track'\r\n        ? (window.ASE?.queue?.hasItem(entry.id) ?? false)\r\n        : (window.ASE?.queue?.getItems().some(q => q.playlistId === entry.id) ?? false);\r\n\r\n      if (entry.type === 'track') {\r\n        const item = this.library.getItem(entry.id);\r\n        if (!item) return null; // Should be handled by getOrderedFavorites cleanup\r\n\r\n        return {\r\n          id: item.id,\r\n          name: item.name,\r\n          type: 'track' as const,\r\n          group: this.inferGroupFromTags(item.tags),\r\n          inQueue\r\n        };\r\n      } else {\r\n        const playlist = this.library.playlists.getPlaylist(entry.id);\r\n        if (!playlist) return null;\r\n\r\n        return {\r\n          id: playlist.id,\r\n          name: playlist.name,\r\n          type: 'playlist' as const,\r\n          inQueue\r\n        };\r\n      }\r\n    }).filter((f): f is FavoriteViewData => f !== null);\r\n\r\n    // Build tags list with selection state, ensuring selected and recent tags are visible\r\n    const tagSet = new Set(allTags);\r\n    this.filterState.selectedTags.forEach(t => tagSet.add(t));\r\n\r\n    const tags: TagViewData[] = Array.from(tagSet).sort().map(tag => {\r\n      // Normalize: ensure no leading #\r\n      const normalizedTag = tag.startsWith('#') ? tag.substring(1) : tag;\r\n      const isSelected = this.filterState.selectedTags.has(tag) || this.filterState.selectedTags.has(normalizedTag);\r\n      return {\r\n        name: normalizedTag, // Display name (without #)\r\n        value: normalizedTag, // Data value (also normalized for consistency)\r\n        selected: isSelected\r\n      };\r\n    });\r\n\r\n    // Build playlists with selection state\r\n    const playlistsViewData = playlists.map(p => ({\r\n      ...this.getPlaylistViewData(p),\r\n      selected: p.id === this.filterState.selectedPlaylistId\r\n    }));\r\n\r\n    // Check if any filters are active (if NOT all channels are selected, or other filters exist)\r\n    const allChannelsSelected = this.filterState.selectedChannels.size === 3; // Assuming 3 channels\r\n    const hasActiveFilters = !!(\r\n      this.filterState.searchQuery ||\r\n      !allChannelsSelected ||\r\n      this.filterState.selectedPlaylistId ||\r\n      this.filterState.selectedTags.size > 0\r\n    );\r\n\r\n    return {\r\n      items: items.map(item => this.getItemViewData(item)),\r\n      playlists: playlistsViewData,\r\n      favorites,\r\n      tags,\r\n      stats: {\r\n        totalItems: stats.totalItems,\r\n        favoriteItems: stats.favoriteItems,\r\n        playlists: stats.playlists,\r\n        tagCount: stats.tagCount\r\n      },\r\n      // Filter state for UI\r\n      searchQuery: this.filterState.searchQuery,\r\n      filters: {\r\n        music: this.filterState.selectedChannels.has('music'),\r\n        ambience: this.filterState.selectedChannels.has('ambience'),\r\n        sfx: this.filterState.selectedChannels.has('sfx')\r\n      },\r\n      selectedPlaylistId: this.filterState.selectedPlaylistId,\r\n      sortBy: this.filterState.sortBy,\r\n      hasActiveFilters\r\n    };\r\n  }\r\n\r\n  private getPlaylistViewData(playlist: Playlist): PlaylistViewData {\r\n    // Check if playlist is in queue\r\n    const inQueue = window.ASE?.queue?.getItems().some(\r\n      item => item.playlistId === playlist.id\r\n    ) ?? false;\r\n\r\n    return {\r\n      id: playlist.id,\r\n      name: playlist.name,\r\n      itemCount: playlist.items.length,\r\n      trackCount: playlist.items.length, // Alias for template\r\n      favorite: playlist.favorite,\r\n      inQueue,\r\n      selected: false\r\n    };\r\n  }\r\n\r\n  private getItemViewData(item: LibraryItem): LibraryItemViewData {\r\n    const inQueue = window.ASE?.queue?.hasItem(item.id) ?? false;\r\n    const durationFormatted = formatTime(item.duration);\r\n\r\n    return {\r\n      id: item.id,\r\n      name: item.name,\r\n      url: item.url,\r\n      duration: durationFormatted,\r\n      durationFormatted,\r\n      durationSeconds: item.duration,\r\n      tags: item.tags,\r\n      favorite: item.favorite,\r\n      group: item.group || 'music',\r\n      inQueue\r\n    };\r\n  }\r\n\r\n  private inferGroupFromTags(tags: string[]): string {\r\n    // Try to infer group from tags if possible\r\n    const lowerTags = tags.map(t => t.toLowerCase());\r\n    if (lowerTags.some(t => t.includes('music'))) return 'music';\r\n    if (lowerTags.some(t => t.includes('ambient') || t.includes('ambience'))) return 'ambience';\r\n    if (lowerTags.some(t => t.includes('sfx') || t.includes('effect'))) return 'sfx';\r\n    return 'music'; // default\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Filtering & Sorting\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private applyFilters(items: LibraryItem[]): LibraryItem[] {\r\n    let filtered = items;\r\n\r\n    // Search filter\r\n    if (this.filterState.searchQuery) {\r\n      const query = this.filterState.searchQuery.toLowerCase();\r\n      filtered = filtered.filter(item =>\r\n        item.name.toLowerCase().includes(query) ||\r\n        item.tags.some(tag => tag.toLowerCase().includes(query))\r\n      );\r\n    }\r\n\r\n    // Channel filter (OR logic: Show item if its group is in selectedChannels)\r\n    // If no channels selected, show all items (default behavior)\r\n    if (this.filterState.selectedChannels.size > 0) {\r\n      filtered = filtered.filter(item => {\r\n        const group = (item.group || 'music') as TrackGroup;\r\n        return this.filterState.selectedChannels.has(group);\r\n      });\r\n    }\r\n    // If no channels selected, show all items (don't filter)\r\n\r\n    // Playlist filter\r\n    if (this.filterState.selectedPlaylistId) {\r\n      const playlist = this.library.playlists.getPlaylist(this.filterState.selectedPlaylistId);\r\n      if (playlist) {\r\n        const playlistItemIds = new Set(playlist.items.map(i => i.libraryItemId));\r\n        filtered = filtered.filter(item => playlistItemIds.has(item.id));\r\n      }\r\n    }\r\n\r\n    // Tags filter (AND logic - show items that have ALL selected tags)\r\n    if (this.filterState.selectedTags.size > 0) {\r\n      const selectedTagsArray = Array.from(this.filterState.selectedTags);\r\n      filtered = filtered.filter(item =>\r\n        selectedTagsArray.every(tag => item.tags.includes(tag))\r\n      );\r\n    }\r\n\r\n    return filtered;\r\n  }\r\n\r\n  private applySorting(items: LibraryItem[]): LibraryItem[] {\r\n    const sorted = [...items];\r\n\r\n    switch (this.filterState.sortBy) {\r\n      case 'name-asc':\r\n        sorted.sort((a, b) => a.name.localeCompare(b.name));\r\n        break;\r\n      case 'name-desc':\r\n        sorted.sort((a, b) => b.name.localeCompare(a.name));\r\n        break;\r\n      case 'date-asc':\r\n        sorted.sort((a, b) => a.addedAt - b.addedAt);\r\n        break;\r\n      case 'date-desc':\r\n        sorted.sort((a, b) => b.addedAt - a.addedAt);\r\n        break;\r\n      case 'duration-asc':\r\n        sorted.sort((a, b) => a.duration - b.duration);\r\n        break;\r\n      case 'duration-desc':\r\n        sorted.sort((a, b) => b.duration - a.duration);\r\n        break;\r\n    }\r\n\r\n    return sorted;\r\n  }\r\n\r\n  override activateListeners(html: JQuery): void {\r\n    super.activateListeners(html);\r\n\r\n    // Toolbar actions\r\n    html.find('[data-action=\"add-track\"]').on('click', this.onAddTrack.bind(this));\r\n    // Listen for KeyDown (Enter) for search execution\r\n    html.find('.ase-search-input').on('keydown', this.onSearchKeydown.bind(this));\r\n    // Listen for 'input' to manage X button visibility and auto-reset on empty\r\n    html.find('.ase-search-input').on('input', this.onSearchInput.bind(this));\r\n    html.find('.ase-search-clear').on('click', this.onClearSearch.bind(this));\r\n    html.find('[data-action=\"filter-channel\"]').on('click', this._onFilterChannel.bind(this));\r\n    html.find('[data-action=\"sort-change\"]').on('change', this.onChangeSort.bind(this));\r\n    html.find('[data-action=\"clear-filters\"]').on('click', this.onClearFilters.bind(this));\r\n\r\n    // Tag actions\r\n    html.find('[data-action=\"toggle-tag\"]').on('click', this.onToggleTag.bind(this));\r\n    html.find('[data-action=\"add-tag\"]').on('click', this.onAddTag.bind(this));\r\n\r\n    // Track actions\r\n    html.find('[data-action=\"play-track\"]').on('click', this.onPlayTrack.bind(this));\r\n    html.find('[data-action=\"pause-track\"]').on('click', this.onPauseTrack.bind(this));\r\n    html.find('[data-action=\"stop-track\"]').on('click', this.onStopTrack.bind(this));\r\n    html.find('[data-action=\"add-to-queue\"]').on('click', this.onAddToQueue.bind(this));\r\n    html.find('[data-action=\"toggle-favorite\"]').on('click', this.onToggleFavorite.bind(this));\r\n    html.find('[data-action=\"add-to-playlist\"]').on('click', this.onAddToPlaylist.bind(this));\r\n    html.find('[data-action=\"track-menu\"]').on('click', this.onTrackMenu.bind(this));\r\n\r\n    // In-track tag management\r\n    html.find('[data-action=\"add-tag-to-track\"]').on('click', this.onAddTagToTrack.bind(this));\r\n\r\n    // Channel dropdown\r\n    html.find('[data-action=\"channel-dropdown\"]').on('click', this.onChannelDropdown.bind(this));\r\n\r\n    // Delete track\r\n    html.find('[data-action=\"delete-track\"]').on('click', this.onDeleteTrack.bind(this));\r\n\r\n    // Track context menu (right-click)\r\n    html.find('.ase-track-player-item').on('contextmenu', this.onTrackContext.bind(this));\r\n\r\n    // Tag context menu on track (right-click on tag)\r\n    html.find('.ase-track-tags .ase-tag').on('contextmenu', this.onTrackTagContext.bind(this));\r\n\r\n    // Playlist actions\r\n    html.find('[data-action=\"select-playlist\"]').on('click', this.onSelectPlaylist.bind(this));\r\n    html.find('[data-action=\"create-playlist\"]').on('click', this.onCreatePlaylist.bind(this));\r\n    html.find('[data-action=\"toggle-playlist-favorite\"]').on('click', this.onTogglePlaylistFavorite.bind(this));\r\n    html.find('[data-action=\"toggle-playlist-queue\"]').on('click', this.onTogglePlaylistQueue.bind(this));\r\n    html.find('[data-action=\"playlist-menu\"]').on('click', this.onPlaylistMenu.bind(this));\r\n    html.find('.ase-list-item[data-playlist-id]').on('contextmenu', this.onPlaylistContext.bind(this));\r\n\r\n    // Favorite actions\r\n    html.find('[data-action=\"remove-from-favorites\"]').on('click', this.onRemoveFromFavorites.bind(this));\r\n    html.find('[data-action=\"toggle-favorite-queue\"]').on('click', this.onToggleFavoriteQueue.bind(this));\r\n\r\n    // Drag and drop\r\n    this.setupDragAndDrop(html);\r\n    this.setupFoundryDragDrop(html);\r\n\r\n    // Track hover highlighting for playlists\r\n    html.find('.ase-track-player-item').on('mouseenter', (event: JQuery.MouseEnterEvent) => {\r\n      const trackId = $(event.currentTarget).data('item-id');\r\n      if (trackId) {\r\n        this.highlightPlaylistsContainingTrack(trackId);\r\n      }\r\n    });\r\n\r\n    html.find('.ase-track-player-item').on('mouseleave', () => {\r\n      this.clearPlaylistHighlights();\r\n    });\r\n\r\n    // Custom Context Menu for GLOBAL tags only (in top panel)\r\n    html.find('.ase-tags-inline .ase-tag').on('contextmenu', this.onTagContext.bind(this));\r\n\r\n    Logger.debug('LocalLibraryApp listeners activated');\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Event Handlers\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async onAddTrack(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n\r\n    const fp = new FilePicker({\r\n      type: 'audio',\r\n      callback: async (path: string) => {\r\n        await this.addTrackFromPath(path);\r\n      }\r\n    });\r\n    fp.render(true);\r\n  }\r\n\r\n  private async addTrackFromPath(path: string, group: TrackGroup = 'music'): Promise<void> {\r\n    try {\r\n      // Get currently selected tags\r\n      const selectedTags = Array.from(this.filterState.selectedTags);\r\n\r\n      const item = await this.library.addItem(path, undefined, group, selectedTags);\r\n      this.persistScroll();\r\n      this.render();\r\n      ui.notifications?.info(`Added to library: ${item.name}`);\r\n    } catch (error) {\r\n      Logger.error('Failed to add track to library:', error);\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      ui.notifications?.error(`Failed to add track: ${errorMessage}`);\r\n    }\r\n  }\r\n\r\n  private async onToggleFavorite(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n    const itemId = $(event.currentTarget).closest('[data-item-id]').data('item-id') as string;\r\n\r\n    try {\r\n      this.persistScroll();\r\n      const isFavorite = this.library.toggleFavorite(itemId);\r\n      this.render();\r\n      ui.notifications?.info(isFavorite ? 'Added to favorites' : 'Removed from favorites');\r\n    } catch (error) {\r\n      Logger.error('Failed to toggle favorite:', error);\r\n      ui.notifications?.error('Failed to update favorite status');\r\n    }\r\n  }\r\n\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Playlist Event Handlers\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async onCreatePlaylist(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n\r\n    const name = await this.promptPlaylistName();\r\n    if (!name) return;\r\n\r\n    try {\r\n      const playlist = this.library.playlists.createPlaylist(name);\r\n      // Create playlist -> might want to scroll to it? Or keep position?\r\n      // User: \"actions in zone of tracks\". Playlists are separate zone. \r\n      // But adding playlist shouldn't jump list to top? Let's persist.\r\n      this.persistScroll();\r\n      this.render();\r\n      ui.notifications?.info(`Created playlist: ${playlist.name}`);\r\n    } catch (error) {\r\n      Logger.error('Failed to create playlist:', error);\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      ui.notifications?.error(`Failed to create playlist: ${errorMessage}`);\r\n    }\r\n  }\r\n\r\n  private async onTogglePlaylistFavorite(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n\r\n    const playlistId = $(event.currentTarget).closest('[data-playlist-id]').data('playlist-id') as string;\r\n\r\n    try {\r\n      this.persistScroll();\r\n      const isFavorite = this.library.playlists.togglePlaylistFavorite(playlistId);\r\n      this.render();\r\n      ui.notifications?.info(isFavorite ? 'Added to favorites' : 'Removed from favorites');\r\n    } catch (error) {\r\n      Logger.error('Failed to toggle playlist favorite:', error);\r\n      ui.notifications?.error('Failed to update favorite status');\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Toolbar Event Handlers\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private onSearchInput(event: JQuery.TriggeredEvent): void {\r\n    const val = ($(event.currentTarget).val() as string || '');\r\n    const trimmedVal = val.trim();\r\n\r\n    // If field becomes empty and search was active, reset search\r\n    if (!trimmedVal && this.filterState.searchQuery) {\r\n      this.filterState.searchQuery = '';\r\n      this.render();\r\n    }\r\n  }\r\n\r\n  private onSearchKeydown(event: JQuery.KeyDownEvent): void {\r\n    if (event.key === 'Enter') {\r\n      event.preventDefault();\r\n      const query = ($(event.currentTarget).val() as string || '').trim().toLowerCase();\r\n      if (this.filterState.searchQuery !== query) {\r\n        this.filterState.searchQuery = query;\r\n        this.render();\r\n      }\r\n    }\r\n  }\r\n\r\n  private onClearSearch(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    this.filterState.searchQuery = '';\r\n    const wrapper = $(event.currentTarget).closest('.ase-search-input-wrapper');\r\n    wrapper.find('.ase-search-input').val('');\r\n    this.render(); // Re-render to show all items\r\n  }\r\n\r\n  private _onFilterChannel(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    const btn = $(event.currentTarget);\r\n    const channel = btn.data('channel') as TrackGroup;\r\n\r\n    // Toggle logic: If clicked, toggle it.\r\n    if (this.filterState.selectedChannels.has(channel)) {\r\n      this.filterState.selectedChannels.delete(channel);\r\n      btn.removeClass('active');\r\n    } else {\r\n      this.filterState.selectedChannels.add(channel);\r\n      btn.addClass('active');\r\n    }\r\n\r\n    // Pass true to force render because complex logic might need re-evaluation of the list\r\n    // OR implement client-side hiding for this too if feeling brave. \r\n    // Given 3 checkboxes, re-render is safer to ensure correct combinatorics.\r\n    this.render();\r\n    Logger.debug('Filter channel toggled:', channel, this.filterState.selectedChannels);\r\n  }\r\n\r\n  private onChangeSort(event: JQuery.ChangeEvent): void {\r\n    const sortValue = $(event.currentTarget).val() as FilterState['sortBy'];\r\n    this.filterState.sortBy = sortValue;\r\n    this.render();\r\n    Logger.debug('Sort changed:', sortValue);\r\n  }\r\n\r\n  private onClearFilters(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n\r\n    // Reset all filters except channels (as requested: \"clear button... resets all except sound channels\")\r\n    this.filterState.searchQuery = '';\r\n    this.filterState.selectedPlaylistId = null;\r\n    this.filterState.selectedTags.clear();\r\n\r\n    // channels remain as is? \"Kнопка clear... сбрасывает все фильтры кроме каналов звука\"\r\n    // \"All Tracks\" button usually means SHOW ALL. \r\n    // IF the button is named \"All Tracks\" (in template it is \"Clear Filters\" or similar?), let's verify.\r\n    // Template says: <button ... data-action=\"clear-filters\">All Tracks</button>\r\n    // So YES, it should reset eveything relative to \"viewing a slice\", but the user EXPLICITLY said:\r\n    // \"except sound channels... they work separately\".\r\n\r\n    // So we DO NOT reset selectedChannels.\r\n\r\n    this.render();\r\n    ui.notifications?.info('Filters cleared (Channels preserved)');\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Tag Event Handlers\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private onToggleTag(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    // Use the right click context menu for edit/delete\r\n    // Left click just toggles filter\r\n    const tag = String($(event.currentTarget).data('tag')); // String() fixes numeric coercion\r\n\r\n    console.log('[ASE] onToggleTag called with tag:', tag);\r\n    console.log('[ASE] Current selectedTags:', Array.from(this.filterState.selectedTags));\r\n\r\n    if (this.filterState.selectedTags.has(tag)) {\r\n      this.filterState.selectedTags.delete(tag);\r\n      console.log('[ASE] Tag deselected');\r\n    } else {\r\n      this.filterState.selectedTags.add(tag);\r\n      console.log('[ASE] Tag selected');\r\n    }\r\n\r\n    this.render();\r\n  }\r\n\r\n  private onTagContext(event: JQuery.ContextMenuEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const tag = String($(event.currentTarget).data('tag')); // String() fixes numeric coercion\r\n\r\n    // Create a custom context menu appended to body to avoid clipping\r\n    const menuHtml = `\r\n      <div id=\"ase-custom-context-menu\" style=\"position: fixed; z-index: 10000; background: #222; border: 1px solid #444; border-radius: 4px; padding: 5px 0;\">\r\n        <div class=\"ase-ctx-item\" data-action=\"edit\" style=\"padding: 5px 15px; cursor: pointer; color: white;\">\r\n            <i class=\"fas fa-edit\" style=\"margin-right: 5px;\"></i> Edit\r\n        </div>\r\n        <div class=\"ase-ctx-item\" data-action=\"delete\" style=\"padding: 5px 15px; cursor: pointer; color: #ff6666;\">\r\n            <i class=\"fas fa-trash\" style=\"margin-right: 5px;\"></i> Delete\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n    // Remove existing\r\n    $('#ase-custom-context-menu').remove();\r\n\r\n    const menu = $(menuHtml);\r\n    $('body').append(menu);\r\n\r\n    // Position\r\n    menu.css({\r\n      top: event.clientY,\r\n      left: event.clientX\r\n    });\r\n\r\n    // Handlers\r\n    menu.find('[data-action=\"edit\"]').on('click', () => {\r\n      this.renameTag(tag);\r\n      menu.remove();\r\n    });\r\n\r\n    menu.find('[data-action=\"delete\"]').on('click', () => {\r\n      this.deleteTag(tag);\r\n      menu.remove();\r\n    });\r\n\r\n    // Initial Hover effect\r\n    menu.find('.ase-ctx-item').hover(\r\n      function () { $(this).css('background', '#333'); },\r\n      function () { $(this).css('background', 'transparent'); }\r\n    );\r\n\r\n    // Close on click elsewhere\r\n    $(document).one('click', () => {\r\n      menu.remove();\r\n    });\r\n\r\n    console.log('Opened context menu for tag:', tag);\r\n  }\r\n\r\n  private async onAddTag(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n\r\n    const rawTagName = await this.promptTagName();\r\n    if (!rawTagName) return;\r\n\r\n    // Normalize: trim and remove leading # if user added it\r\n    const tagName = rawTagName.trim().replace(/^#/, '');\r\n    if (!tagName) return;\r\n\r\n    console.log('[ASE] onAddTag: normalized tagName =', tagName);\r\n\r\n    // Add to selectedTags for immediate visual feedback\r\n    this.filterState.selectedTags.add(tagName);\r\n\r\n    // Add to library persistent tags\r\n    this.library.addCustomTag(tagName);\r\n\r\n    console.log('[ASE] onAddTag: selectedTags now =', Array.from(this.filterState.selectedTags));\r\n    console.log('[ASE] onAddTag: allTags from library =', this.library.getAllTags());\r\n\r\n    this.render();\r\n    ui.notifications?.info(`Tag \"${tagName}\" added.`);\r\n  }\r\n\r\n  // Helper for Context Menu Callbacks to ensure `this` binding and argument passing\r\n  private _onRenameTag(header: JQuery): void {\r\n    const tag = header.data('tag');\r\n    this.renameTag(tag);\r\n  }\r\n\r\n  private _onDeleteTag(header: JQuery): void {\r\n    const tag = header.data('tag');\r\n    this.deleteTag(tag);\r\n  }\r\n\r\n  // Correcting selector/listener activation for Context Menu if needed\r\n  // Foundry ContextMenu usually works fine. If z-index issue, it's CSS.\r\n  // We will force high z-index via CSS injection or ensure fixed position.\r\n  // BUT: user said \"Buttons don't work\". \r\n  // This usually means the callback failed or `this` yielded undefined.\r\n  // The inline arrow functions `() => this.renameTag(tag)` in `activateListeners` SHOULD be fine if `this` is correct.\r\n  // Let's verify `activateListeners`.\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Tag Management Logic\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async renameTag(oldTag: string): Promise<void> {\r\n    const newTag = await this.promptTagName(oldTag);\r\n    if (!newTag || newTag === oldTag) return;\r\n\r\n    // Use LibraryManager's method\r\n    const count = this.library.renameTag(oldTag, newTag);\r\n\r\n    // Also update filter state if selected\r\n    if (this.filterState.selectedTags.has(oldTag)) {\r\n      this.filterState.selectedTags.delete(oldTag);\r\n      this.filterState.selectedTags.add(newTag);\r\n    }\r\n\r\n    if (count > 0) {\r\n      // Renaming tag does not necessarily keep scroll unless it was a tag list interaction?\r\n      // User said \"zone of tracks with tracks\". Tag list is separate. \r\n      // But renaming right from track context menu? Let's enabling it generally.\r\n      // Actually user said \"zone of tracks\". Let's persist.\r\n      this.persistScroll();\r\n      this.render();\r\n      ui.notifications?.info(`Renamed tag \"${oldTag}\" to \"${newTag}\" on ${count} tracks.`);\r\n    }\r\n  }\r\n\r\n  private async deleteTag(tag: string): Promise<void> {\r\n    const tagStr = String(tag); // Ensure string for numeric tags\r\n    console.log('[ASE] deleteTag called for:', tagStr);\r\n\r\n    const confirm = await Dialog.confirm({\r\n      title: \"Delete Tag\",\r\n      content: `Are you sure you want to delete tag \"${tagStr}\" from all tracks?`\r\n    });\r\n    if (!confirm) return;\r\n\r\n    // Use LibraryManager's method\r\n    const count = this.library.deleteTag(tagStr);\r\n\r\n    // Remove from filter\r\n    this.filterState.selectedTags.delete(tagStr);\r\n\r\n    // Always re-render\r\n    this.persistScroll();\r\n    this.render();\r\n    ui.notifications?.info(count > 0 ? `Deleted tag \"${tagStr}\" from ${count} tracks.` : `Deleted custom tag \"${tagStr}\".`);\r\n  }\r\n\r\n  private async promptTagName(current: string = \"\"): Promise<string | null> {\r\n    return new Promise((resolve) => {\r\n      new Dialog({\r\n        title: current ? \"Rename Tag\" : \"New Tag\",\r\n        content: `<input type=\"text\" id=\"tag-name\" value=\"${current}\" style=\"width:100%;box-sizing:border-box;\"/>`,\r\n        buttons: {\r\n          ok: {\r\n            label: \"OK\",\r\n            callback: (html: JQuery) => resolve(html.find('#tag-name').val() as string)\r\n          }\r\n        },\r\n        default: \"ok\",\r\n        close: () => resolve(null)\r\n      }).render(true);\r\n    });\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Track Event Handlers (Extended)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private onPlayTrack(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const itemId = $(event.currentTarget).data('item-id') as string;\r\n\r\n    Logger.debug('Play track:', itemId);\r\n    Logger.debug('Play track:', itemId);\r\n    window.ASE.engine?.playTrack(itemId);\r\n    // Also add to queue if needed? \r\n    // User requested \"Play adds to list of reproduction\".\r\n    // window.ASE.engine?.addToQueue(itemId); // TODO: Implement Queue\r\n    this.persistScroll();\r\n  }\r\n\r\n  private onStopTrack(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const itemId = $(event.currentTarget).data('item-id') as string;\r\n\r\n    Logger.debug('Stop track:', itemId);\r\n    window.ASE.engine?.stopTrack(itemId);\r\n    this.persistScroll();\r\n  }\r\n\r\n  private onPauseTrack(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const itemId = $(event.currentTarget).data('item-id') as string;\r\n    Logger.debug('Pause track:', itemId);\r\n    window.ASE.engine?.pauseTrack(itemId);\r\n    this.persistScroll();\r\n  }\r\n\r\n  private onAddToQueue(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const itemId = String($(event.currentTarget).data('item-id'));\r\n\r\n    if (!window.ASE?.queue) {\r\n      Logger.warn('Queue manager not available');\r\n      return;\r\n    }\r\n\r\n    // Get item details to determine group\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) {\r\n      Logger.warn('Item not found:', itemId);\r\n      return;\r\n    }\r\n\r\n    // Toggle: if already in queue, remove; otherwise add\r\n    if (window.ASE.queue.hasItem(itemId)) {\r\n      window.ASE.queue.removeByLibraryItemId(itemId);\r\n      Logger.debug('Removed from queue:', itemId);\r\n      ui.notifications?.info(`\"${item.name}\" removed from queue`);\r\n    } else {\r\n      window.ASE.queue.addItem(itemId, {\r\n        group: item.group || 'music',\r\n        volume: 1,\r\n        loop: false\r\n      });\r\n      Logger.debug('Added to queue:', itemId);\r\n      ui.notifications?.info(`\"${item.name}\" added to queue`);\r\n    }\r\n\r\n    this.persistScroll();\r\n    this.render();\r\n  }\r\n\r\n  private async onAddTagToTrack(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const itemId = $(event.currentTarget).data('item-id') as string;\r\n    Logger.debug('Add tag to track:', itemId);\r\n\r\n    // Open tag editor dialog\r\n    this.showTagEditor(itemId);\r\n  }\r\n\r\n  private async onAddToPlaylist(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const itemId = $(event.currentTarget).data('item-id') as string;\r\n    const item = this.library.getItem(itemId);\r\n\r\n    if (!item) {\r\n      ui.notifications?.error('Track not found');\r\n      return;\r\n    }\r\n\r\n    const playlists = this.library.playlists.getAllPlaylists();\r\n    if (playlists.length === 0) {\r\n      ui.notifications?.warn('No playlists available. Create one first.');\r\n      return;\r\n    }\r\n\r\n    // Show playlist selection dialog\r\n    const selectedPlaylistId = await this.promptPlaylistSelection(playlists);\r\n    if (!selectedPlaylistId) return;\r\n\r\n    try {\r\n      const group = this.inferGroupFromTags(item.tags) as TrackGroup;\r\n      this.library.playlists.addTrackToPlaylist(selectedPlaylistId, itemId, group);\r\n      this.render();\r\n      ui.notifications?.info(`Added \"${item.name}\" to playlist`);\r\n    } catch (error) {\r\n      Logger.error('Failed to add track to playlist:', error);\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      ui.notifications?.error(`Failed to add to playlist: ${errorMessage}`);\r\n    }\r\n  }\r\n\r\n  private onTrackMenu(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    // Context menu is now handled by right-click\r\n    // This button can trigger the same menu programmatically\r\n    const itemId = $(event.currentTarget).data('item-id') as string;\r\n    const trackElement = $(event.currentTarget).closest('.ase-track-player-item');\r\n\r\n    // Trigger a contextmenu event on the track item\r\n    const contextMenuEvent = new MouseEvent('contextmenu', {\r\n      bubbles: true,\r\n      cancelable: true,\r\n      view: window,\r\n      clientX: event.clientX,\r\n      clientY: event.clientY\r\n    });\r\n    trackElement[0]?.dispatchEvent(contextMenuEvent);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Favorites Event Handlers\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private onRemoveFromFavorites(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n\r\n    const favoriteId = String($(event.currentTarget).data('favorite-id'));\r\n    const favoriteType = String($(event.currentTarget).data('favorite-type'));\r\n\r\n    Logger.debug('Remove from favorites:', favoriteId, favoriteType);\r\n\r\n    if (favoriteType === 'playlist') {\r\n      const playlist = this.library.playlists.getPlaylist(favoriteId);\r\n      if (playlist) {\r\n        this.library.playlists.updatePlaylist(favoriteId, { favorite: false });\r\n        ui.notifications?.info(`Removed \"${playlist.name}\" from favorites`);\r\n      }\r\n    } else {\r\n      const item = this.library.getItem(favoriteId);\r\n      if (item) {\r\n        this.library.toggleFavorite(favoriteId);\r\n        ui.notifications?.info(`Removed \"${item.name}\" from favorites`);\r\n      }\r\n    }\r\n\r\n    this.persistScroll();\r\n    this.render();\r\n  }\r\n\r\n  private onToggleFavoriteQueue(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n\r\n    const favoriteId = String($(event.currentTarget).data('favorite-id'));\r\n    const favoriteType = String($(event.currentTarget).data('favorite-type'));\r\n\r\n    if (!window.ASE?.queue) {\r\n      Logger.warn('Queue manager not available');\r\n      return;\r\n    }\r\n\r\n    if (favoriteType === 'playlist') {\r\n      // Delegate to playlist queue handler\r\n      const playlist = this.library.playlists.getPlaylist(favoriteId);\r\n      if (!playlist) return;\r\n\r\n      const inQueue = window.ASE.queue.getItems().some(item => item.playlistId === favoriteId);\r\n\r\n      if (inQueue) {\r\n        const itemsToRemove = window.ASE.queue.getItems().filter(item => item.playlistId === favoriteId);\r\n        itemsToRemove.forEach(item => window.ASE!.queue!.removeItem(item.id));\r\n        ui.notifications?.info(`Removed \"${playlist.name}\" from queue`);\r\n      } else {\r\n        const playlistItems = playlist.items.map(pItem => ({\r\n          libraryItemId: pItem.libraryItemId,\r\n          group: pItem.group || 'music' as const,\r\n          volume: pItem.volume,\r\n          loop: pItem.loop\r\n        }));\r\n        window.ASE.queue.addPlaylist(favoriteId, playlistItems);\r\n        ui.notifications?.info(`Added \"${playlist.name}\" to queue`);\r\n      }\r\n    } else {\r\n      // Track\r\n      const item = this.library.getItem(favoriteId);\r\n      if (!item) return;\r\n\r\n      const inQueue = window.ASE.queue.hasItem(favoriteId);\r\n\r\n      if (inQueue) {\r\n        const queueItems = window.ASE.queue.getItems().filter(q => q.libraryItemId === favoriteId);\r\n        queueItems.forEach(q => window.ASE!.queue!.removeItem(q.id));\r\n        ui.notifications?.info(`Removed \"${item.name}\" from queue`);\r\n      } else {\r\n        window.ASE.queue.addItem(favoriteId, {\r\n          group: this.inferGroupFromTags(item.tags) as any,\r\n          volume: 1,\r\n          loop: false\r\n        });\r\n        ui.notifications?.info(`Added \"${item.name}\" to queue`);\r\n      }\r\n    }\r\n\r\n    this.persistScroll();\r\n    this.render();\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Track Control Handlers\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private onChannelDropdown(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n\r\n    const itemId = String($(event.currentTarget).data('item-id'));\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) return;\r\n\r\n    const currentGroup = item.group || 'music';\r\n    const channels = ['music', 'ambience', 'sfx'];\r\n\r\n    // Create dropdown menu\r\n    const menu = $(`\r\n      <div class=\"ase-dropdown-menu\" style=\"position: fixed; z-index: 9999; background: #1e283d; border: 1px solid #334155; border-radius: 4px; min-width: 100px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);\">\r\n        ${channels.map(ch => `\r\n          <div class=\"ase-dropdown-item\" data-channel=\"${ch}\" style=\"padding: 8px 12px; cursor: pointer; color: ${ch === currentGroup ? 'var(--accent-cyan)' : '#94a3b8'}; font-size: 12px;\">\r\n            ${ch.charAt(0).toUpperCase() + ch.slice(1)}\r\n          </div>\r\n        `).join('')}\r\n      </div>\r\n    `);\r\n\r\n    const rect = (event.currentTarget as HTMLElement).getBoundingClientRect();\r\n    menu.css({ top: rect.bottom + 2, left: rect.left });\r\n\r\n    $('body').append(menu);\r\n\r\n    menu.find('.ase-dropdown-item').on('click', (e) => {\r\n      const newChannel = $(e.currentTarget).data('channel') as string;\r\n      this.updateTrackChannel(itemId, newChannel);\r\n      menu.remove();\r\n    });\r\n\r\n    // Close on outside click\r\n    setTimeout(() => {\r\n      $(document).one('click', () => menu.remove());\r\n    }, 10);\r\n  }\r\n\r\n  private updateTrackChannel(itemId: string, channel: string): void {\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) return;\r\n\r\n    // Update group field directly (not as a tag)\r\n    this.library.updateItem(itemId, { group: channel as TrackGroup });\r\n    this.persistScroll();\r\n    this.render();\r\n    ui.notifications?.info(`Channel set to ${channel}`);\r\n  }\r\n\r\n  private onDeleteTrack(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n\r\n    const itemId = String($(event.currentTarget).data('item-id'));\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) return;\r\n\r\n    const isInPlaylist = !!this.filterState.selectedPlaylistId;\r\n\r\n    const dialogData: any = {\r\n      title: isInPlaylist ? 'Manage Track' : 'Delete Track',\r\n      content: `<p>${isInPlaylist ? `What would you like to do with \"${item.name}\"?` : `Are you sure you want to delete \"${item.name}\"?`}</p>`,\r\n      buttons: {},\r\n      default: 'cancel'\r\n    };\r\n\r\n    if (isInPlaylist) {\r\n      dialogData.buttons.removeFromPlaylist = {\r\n        icon: '<i class=\"fas fa-minus-circle\"></i>',\r\n        label: 'Remove from Playlist',\r\n        callback: () => {\r\n          if (this.filterState.selectedPlaylistId) {\r\n            this.removeTrackFromPlaylist(this.filterState.selectedPlaylistId, itemId);\r\n          }\r\n        }\r\n      };\r\n    }\r\n\r\n    dialogData.buttons.delete = {\r\n      icon: '<i class=\"fas fa-trash\"></i>',\r\n      label: isInPlaylist ? 'Delete Track (Global)' : 'Delete',\r\n      callback: () => {\r\n        this.library.removeItem(itemId);\r\n        this.render();\r\n        ui.notifications?.info(`Deleted \"${item.name}\"`);\r\n      }\r\n    };\r\n\r\n    dialogData.buttons.cancel = {\r\n      icon: '<i class=\"fas fa-times\"></i>',\r\n      label: 'Cancel'\r\n    };\r\n\r\n    new Dialog(dialogData).render(true);\r\n  }\r\n\r\n  private onTrackContext(event: JQuery.ContextMenuEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n\r\n    const itemId = String($(event.currentTarget).data('item-id'));\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) return;\r\n\r\n    // Remove existing menus\r\n    $('.ase-context-menu').remove();\r\n\r\n    const isInPlaylist = !!this.filterState.selectedPlaylistId;\r\n    const deleteLabel = 'Delete Track';\r\n\r\n    let menuHtml = `\r\n      <div class=\"ase-context-menu\" style=\"position: fixed; z-index: 9999; background: #1e283d; border: 1px solid #334155; border-radius: 4px; min-width: 150px; box-shadow: 0 4px 12px rgba(0,0,0,0.4);\">\r\n        <div class=\"ase-menu-item\" data-action=\"rename\" style=\"padding: 8px 12px; cursor: pointer; color: #e5e5e5; font-size: 12px;\">\r\n          <i class=\"fa-solid fa-pen\" style=\"width: 16px;\"></i> Rename\r\n        </div>\r\n        <div class=\"ase-menu-item\" data-action=\"add-to-playlist\" style=\"padding: 8px 12px; cursor: pointer; color: #e5e5e5; font-size: 12px;\">\r\n          <i class=\"fa-solid fa-list\" style=\"width: 16px;\"></i> Add to Playlist\r\n        </div>`;\r\n\r\n    if (isInPlaylist) {\r\n      menuHtml += `\r\n        <div class=\"ase-menu-item\" data-action=\"remove-from-playlist\" style=\"padding: 8px 12px; cursor: pointer; color: #e5e5e5; font-size: 12px;\">\r\n          <i class=\"fa-solid fa-minus-circle\" style=\"width: 16px;\"></i> Remove from Playlist\r\n        </div>`;\r\n    }\r\n\r\n    menuHtml += `\r\n        <div class=\"ase-menu-item\" data-action=\"edit-tags\" style=\"padding: 8px 12px; cursor: pointer; color: #e5e5e5; font-size: 12px;\">\r\n          <i class=\"fa-solid fa-tags\" style=\"width: 16px;\"></i> Edit Tags\r\n        </div>\r\n        <div style=\"border-top: 1px solid #334155; margin: 4px 0;\"></div>\r\n        <div class=\"ase-menu-item\" data-action=\"delete\" style=\"padding: 8px 12px; cursor: pointer; color: #f87171; font-size: 12px;\">\r\n          <i class=\"fa-solid fa-trash\" style=\"width: 16px;\"></i> ${deleteLabel}\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n    const menu = $(menuHtml);\r\n\r\n    menu.css({ top: event.clientY, left: event.clientX });\r\n    $('body').append(menu);\r\n\r\n    menu.find('.ase-menu-item').on('mouseenter', (e) => $(e.currentTarget).css('background', '#2d3a52'));\r\n    menu.find('.ase-menu-item').on('mouseleave', (e) => $(e.currentTarget).css('background', 'transparent'));\r\n\r\n    menu.find('[data-action=\"rename\"]').on('click', async () => {\r\n      menu.remove();\r\n      await this.renameTrack(itemId);\r\n    });\r\n\r\n    menu.find('[data-action=\"add-to-playlist\"]').on('click', async () => {\r\n      menu.remove();\r\n      await this.addTrackToPlaylistDialog(itemId);\r\n    });\r\n\r\n    if (isInPlaylist) {\r\n      menu.find('[data-action=\"remove-from-playlist\"]').on('click', async () => {\r\n        menu.remove();\r\n        if (this.filterState.selectedPlaylistId) {\r\n          await this.removeTrackFromPlaylist(this.filterState.selectedPlaylistId, itemId);\r\n        }\r\n      });\r\n    }\r\n\r\n    menu.find('[data-action=\"edit-tags\"]').on('click', () => {\r\n      menu.remove();\r\n      this.showTagEditor(itemId);\r\n    });\r\n\r\n    menu.find('[data-action=\"delete\"]').on('click', () => {\r\n      menu.remove();\r\n      this.onDeleteTrack({ preventDefault: () => { }, stopPropagation: () => { }, currentTarget: $(`<div data-item-id=\"${itemId}\">`)[0] } as any);\r\n    });\r\n\r\n    setTimeout(() => {\r\n      $(document).one('click', () => menu.remove());\r\n    }, 10);\r\n  }\r\n\r\n  private onTrackTagContext(event: JQuery.ContextMenuEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n\r\n    const tagName = String($(event.currentTarget).data('tag'));\r\n    const itemId = String($(event.currentTarget).data('item-id'));\r\n\r\n    $('.ase-context-menu').remove();\r\n\r\n    const menu = $(`\r\n      <div class=\"ase-context-menu\" style=\"position: fixed; z-index: 9999; background: #1e283d; border: 1px solid #334155; border-radius: 4px; min-width: 120px; box-shadow: 0 4px 12px rgba(0,0,0,0.4);\">\r\n        <div class=\"ase-menu-item\" data-action=\"remove-tag\" style=\"padding: 8px 12px; cursor: pointer; color: #f87171; font-size: 12px;\">\r\n          <i class=\"fa-solid fa-times\" style=\"width: 16px;\"></i> Remove Tag\r\n        </div>\r\n      </div>\r\n    `);\r\n\r\n    menu.css({ top: event.clientY, left: event.clientX });\r\n    $('body').append(menu);\r\n\r\n    menu.find('.ase-menu-item').on('mouseenter', (e) => $(e.currentTarget).css('background', '#2d3a52'));\r\n    menu.find('.ase-menu-item').on('mouseleave', (e) => $(e.currentTarget).css('background', 'transparent'));\r\n\r\n    menu.find('[data-action=\"remove-tag\"]').on('click', () => {\r\n      menu.remove();\r\n      this.library.removeTagFromItem(itemId, tagName);\r\n      this.render();\r\n      ui.notifications?.info(`Removed tag \"${tagName}\"`);\r\n    });\r\n\r\n    setTimeout(() => {\r\n      $(document).one('click', () => menu.remove());\r\n    }, 10);\r\n  }\r\n\r\n  private async renameTrack(itemId: string): Promise<void> {\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) return;\r\n\r\n    const newName = await this.promptInput('Rename Track', 'Track Name:', item.name);\r\n    if (newName && newName !== item.name) {\r\n      this.library.updateItem(itemId, { name: newName });\r\n      this.render();\r\n      ui.notifications?.info(`Renamed to \"${newName}\"`);\r\n    }\r\n  }\r\n\r\n  private async addTrackToPlaylistDialog(itemId: string): Promise<void> {\r\n    const playlists = this.library.playlists.getAllPlaylists();\r\n    if (playlists.length === 0) {\r\n      ui.notifications?.warn('No playlists available. Create one first.');\r\n      return;\r\n    }\r\n\r\n    const selectedPlaylistId = await this.promptPlaylistSelection(playlists);\r\n    if (!selectedPlaylistId) return;\r\n\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) return;\r\n\r\n    const group = this.inferGroupFromTags(item.tags) as TrackGroup;\r\n    this.library.playlists.addTrackToPlaylist(selectedPlaylistId, itemId, group);\r\n    this.render();\r\n    ui.notifications?.info(`Added \"${item.name}\" to playlist`);\r\n  }\r\n\r\n  private showTagEditor(itemId: string): void {\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) return;\r\n\r\n    const allTags = this.library.getAllTags();\r\n    const currentTags = new Set(item.tags);\r\n\r\n    const content = `\r\n      <form>\r\n        <div style=\"max-height: 300px; overflow-y: auto;\">\r\n          ${allTags.map(tag => `\r\n            <div class=\"form-group\" style=\"margin: 5px 0;\">\r\n              <label style=\"display: flex; align-items: center; gap: 8px; cursor: pointer;\">\r\n                <input type=\"checkbox\" name=\"tag\" value=\"${tag}\" ${currentTags.has(tag) ? 'checked' : ''}>\r\n                <span>#${tag}</span>\r\n              </label>\r\n            </div>\r\n          `).join('')}\r\n        </div>\r\n        <div class=\"form-group\" style=\"margin-top: 10px;\">\r\n          <input type=\"text\" name=\"newTag\" placeholder=\"Add new tag...\" style=\"width: 100%;\">\r\n        </div>\r\n      </form>\r\n    `;\r\n\r\n    new Dialog({\r\n      title: `Edit Tags: ${item.name}`,\r\n      content,\r\n      buttons: {\r\n        save: {\r\n          icon: '<i class=\"fas fa-save\"></i>',\r\n          label: 'Save',\r\n          callback: (html: JQuery) => {\r\n            const selectedTags: string[] = [];\r\n            html.find('input[name=\"tag\"]:checked').each((_, el) => {\r\n              selectedTags.push($(el).val() as string);\r\n            });\r\n\r\n            const newTag = (html.find('input[name=\"newTag\"]').val() as string)?.trim();\r\n            if (newTag) {\r\n              selectedTags.push(newTag);\r\n              this.library.addCustomTag(newTag);\r\n            }\r\n\r\n            this.library.updateItem(itemId, { tags: selectedTags });\r\n            this.render();\r\n          }\r\n        },\r\n        cancel: {\r\n          icon: '<i class=\"fas fa-times\"></i>',\r\n          label: 'Cancel'\r\n        }\r\n      },\r\n      default: 'save'\r\n    }).render(true);\r\n  }\r\n\r\n  private async promptInput(title: string, label: string, defaultValue: string = ''): Promise<string | null> {\r\n    return new Promise((resolve) => {\r\n      new Dialog({\r\n        title,\r\n        content: `\r\n          <form>\r\n            <div class=\"form-group\">\r\n              <label>${label}</label>\r\n              <input type=\"text\" name=\"input\" value=\"${defaultValue}\" autofocus style=\"width: 100%;\">\r\n            </div>\r\n          </form>\r\n        `,\r\n        buttons: {\r\n          ok: {\r\n            icon: '<i class=\"fas fa-check\"></i>',\r\n            label: 'OK',\r\n            callback: (html: JQuery) => {\r\n              const value = html.find('input[name=\"input\"]').val() as string;\r\n              resolve(value?.trim() || null);\r\n            }\r\n          },\r\n          cancel: {\r\n            icon: '<i class=\"fas fa-times\"></i>',\r\n            label: 'Cancel',\r\n            callback: () => resolve(null)\r\n          }\r\n        },\r\n        default: 'ok'\r\n      }).render(true);\r\n    });\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Playlist Event Handlers (Extended)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private onSelectPlaylist(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    const playlistId = $(event.currentTarget).data('playlist-id') as string;\r\n\r\n    // Toggle playlist filter\r\n    if (this.filterState.selectedPlaylistId === playlistId) {\r\n      // Deselect if clicking the same playlist\r\n      this.filterState.selectedPlaylistId = null;\r\n    } else {\r\n      this.filterState.selectedPlaylistId = playlistId;\r\n    }\r\n\r\n    this.render();\r\n    Logger.debug('Select playlist:', playlistId);\r\n  }\r\n\r\n  private onPlaylistMenu(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    // Context menu is now handled by right-click\r\n    // This button can trigger the same menu programmatically\r\n    const playlistId = $(event.currentTarget).data('playlist-id') as string;\r\n    const playlistElement = $(event.currentTarget).closest('.ase-list-item');\r\n\r\n    // Trigger a contextmenu event on the playlist item\r\n    const contextMenuEvent = new MouseEvent('contextmenu', {\r\n      bubbles: true,\r\n      cancelable: true,\r\n      view: window,\r\n      clientX: event.clientX,\r\n      clientY: event.clientY\r\n    });\r\n    playlistElement[0]?.dispatchEvent(contextMenuEvent);\r\n  }\r\n\r\n  private onTogglePlaylistQueue(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n\r\n    const playlistId = String($(event.currentTarget).data('playlist-id'));\r\n    const playlist = this.library.playlists.getPlaylist(playlistId);\r\n\r\n    if (!playlist || !window.ASE?.queue) {\r\n      Logger.warn('Cannot toggle playlist queue: playlist or queue not available');\r\n      return;\r\n    }\r\n\r\n    // Check if already in queue (by playlistId)\r\n    const inQueue = window.ASE.queue.getItems().some(item => item.playlistId === playlistId);\r\n\r\n    if (inQueue) {\r\n      // Remove all items from this playlist\r\n      const itemsToRemove = window.ASE.queue.getItems().filter(item => item.playlistId === playlistId);\r\n      itemsToRemove.forEach(item => window.ASE!.queue!.removeItem(item.id));\r\n      ui.notifications?.info(`Removed \"${playlist.name}\" from queue`);\r\n    } else {\r\n      // Add all playlist items to queue\r\n      const playlistItems = playlist.items.map(pItem => {\r\n        const libraryItem = this.library.getItem(pItem.libraryItemId);\r\n        return {\r\n          libraryItemId: pItem.libraryItemId,\r\n          group: pItem.group || 'music' as const,\r\n          volume: pItem.volume,\r\n          loop: pItem.loop\r\n        };\r\n      }).filter(item => item.libraryItemId);\r\n\r\n      window.ASE.queue.addPlaylist(playlistId, playlistItems);\r\n      ui.notifications?.info(`Added \"${playlist.name}\" (${playlist.items.length} tracks) to queue`);\r\n    }\r\n\r\n    this.render();\r\n  }\r\n\r\n  private onPlaylistContext(event: JQuery.ContextMenuEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n\r\n    const playlistId = String($(event.currentTarget).data('playlist-id'));\r\n    const playlist = this.library.playlists.getPlaylist(playlistId);\r\n\r\n    if (!playlist) return;\r\n\r\n    // Create a custom context menu appended to body to avoid clipping\r\n\r\n    const menuHtml = `\r\n      <div id=\"ase-custom-context-menu\" style=\"position: fixed; z-index: 10000; background: #222; border: 1px solid #444; border-radius: 4px; padding: 5px 0;\">\r\n        <div class=\"ase-ctx-item\" data-action=\"edit\" style=\"padding: 5px 15px; cursor: pointer; color: white;\">\r\n            <i class=\"fas fa-edit\" style=\"margin-right: 5px;\"></i> Rename\r\n        </div>\r\n        <div class=\"ase-ctx-item\" data-action=\"delete\" style=\"padding: 5px 15px; cursor: pointer; color: #ff6666;\">\r\n            <i class=\"fas fa-trash\" style=\"margin-right: 5px;\"></i> Delete\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n    // Remove existing\r\n    $('#ase-custom-context-menu').remove();\r\n\r\n    const menu = $(menuHtml);\r\n    $('body').append(menu);\r\n\r\n    // Position\r\n    menu.css({\r\n      top: event.clientY,\r\n      left: event.clientX\r\n    });\r\n\r\n    // Hover effect\r\n    menu.find('.ase-ctx-item').on('mouseenter', function () {\r\n      $(this).css('background-color', '#333');\r\n    }).on('mouseleave', function () {\r\n      $(this).css('background-color', 'transparent');\r\n    });\r\n\r\n    // Handle clicks\r\n    menu.find('[data-action=\"edit\"]').on('click', () => {\r\n      menu.remove();\r\n      this.renamePlaylist(playlistId);\r\n    });\r\n\r\n    menu.find('[data-action=\"delete\"]').on('click', () => {\r\n      menu.remove();\r\n      this.deletePlaylist(playlistId);\r\n    });\r\n\r\n    // Close on click outside\r\n    setTimeout(() => {\r\n      $(document).one('click', () => menu.remove());\r\n    }, 50);\r\n  }\r\n\r\n  private async renamePlaylist(playlistId: string): Promise<void> {\r\n    const playlist = this.library.playlists.getPlaylist(playlistId);\r\n    if (!playlist) return;\r\n\r\n    const newName = await this.promptPlaylistName(playlist.name);\r\n    if (!newName || newName === playlist.name) return;\r\n\r\n    this.library.playlists.updatePlaylist(playlistId, { name: newName });\r\n    this.persistScroll();\r\n    this.render();\r\n    ui.notifications?.info(`Renamed playlist to \"${newName}\"`);\r\n  }\r\n\r\n  private async deletePlaylist(playlistId: string): Promise<void> {\r\n    const playlist = this.library.playlists.getPlaylist(playlistId);\r\n    if (!playlist) return;\r\n\r\n    const confirm = await Dialog.confirm({\r\n      title: \"Delete Playlist\",\r\n      content: `Are you sure you want to delete playlist \"${playlist.name}\"?`\r\n    });\r\n\r\n    if (!confirm) return;\r\n\r\n    this.library.playlists.deletePlaylist(playlistId);\r\n\r\n    // Clear selection if this was selected\r\n    if (this.filterState.selectedPlaylistId === playlistId) {\r\n      this.filterState.selectedPlaylistId = null;\r\n    }\r\n\r\n    this.render();\r\n    ui.notifications?.info(`Deleted playlist \"${playlist.name}\"`);\r\n  }\r\n\r\n  private async promptPlaylistName(current: string = \"\"): Promise<string | null> {\r\n    return new Promise((resolve) => {\r\n      new Dialog({\r\n        title: current ? \"Rename Playlist\" : \"New Playlist\",\r\n        content: `\r\n          <form>\r\n            <div class=\"form-group\">\r\n              <label>Playlist Name:</label>\r\n              <input type=\"text\" name=\"playlistName\" value=\"${current}\" autofocus style=\"width: 100%;\">\r\n            </div>\r\n          </form>\r\n        `,\r\n        buttons: {\r\n          ok: {\r\n            icon: '<i class=\"fas fa-check\"></i>',\r\n            label: \"OK\",\r\n            callback: (html: JQuery) => {\r\n              const name = html.find('[name=\"playlistName\"]').val() as string;\r\n              resolve(name?.trim() || null);\r\n            }\r\n          },\r\n          cancel: {\r\n            icon: '<i class=\"fas fa-times\"></i>',\r\n            label: \"Cancel\",\r\n            callback: () => resolve(null)\r\n          }\r\n        },\r\n        default: \"ok\"\r\n      }).render(true);\r\n    });\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Drag and Drop\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private setupDragAndDrop(html: JQuery): void {\r\n    // Drag start\r\n    html.find('.ase-track-player-item[draggable=\"true\"]').on('dragstart', (event: JQuery.DragStartEvent) => {\r\n      const itemId = $(event.currentTarget).find('[data-item-id]').data('item-id') as string || $(event.currentTarget).data('item-id') as string;\r\n      // Note: Data-item-id might be on the action button/icon, but for the row it should be on the row or accessible.\r\n      // In template: <div class=\"ase-track-player-item\"> doesn't have data-item-id directly? \r\n      // Let's check template.\r\n      // Template: <div class=\"ase-track-player-item\"> inside each item. \r\n      // Actually, my template rewrite in 751:\r\n      // {{#each items}} <div class=\"ase-track-player-item\"> ... <div class=\"ase-track-actions\"> <i ... data-item-id=\"{{this.id}}\"> \r\n      // The row itself DOES NOT have data-item-id in the rewrite! \r\n      // I NEED TO ADD IT TO THE TEMPLATE OR FIND IT.\r\n      // I will assume I will fix the template to include data-item-id on the row, or find it inside.\r\n      // For now, let's find it inside.\r\n      const id = $(event.currentTarget).find('[data-item-id]').first().data('item-id') as string;\r\n\r\n      event.originalEvent!.dataTransfer!.effectAllowed = 'copy';\r\n      event.originalEvent!.dataTransfer!.setData('text/plain', id);\r\n      $(event.currentTarget).addClass('dragging');\r\n    });\r\n\r\n    // Drag end\r\n    html.find('.ase-track-player-item[draggable=\"true\"]').on('dragend', (event: JQuery.DragEndEvent) => {\r\n      $(event.currentTarget).removeClass('dragging');\r\n    });\r\n\r\n    // Drop zones (playlists)\r\n    html.find('.ase-list-item[data-playlist-id]').on('dragover', (event: JQuery.DragOverEvent) => {\r\n      event.preventDefault();\r\n      event.originalEvent!.dataTransfer!.dropEffect = 'copy';\r\n      $(event.currentTarget).addClass('drag-over');\r\n    });\r\n\r\n    html.find('.ase-list-item[data-playlist-id]').on('dragleave', (event: JQuery.DragLeaveEvent) => {\r\n      $(event.currentTarget).removeClass('drag-over');\r\n    });\r\n\r\n    html.find('.ase-list-item[data-playlist-id]').on('drop', async (event: JQuery.DropEvent) => {\r\n      event.preventDefault();\r\n      const itemId = event.originalEvent!.dataTransfer!.getData('text/plain');\r\n      const playlistId = $(event.currentTarget).data('playlist-id') as string;\r\n      $(event.currentTarget).removeClass('drag-over');\r\n\r\n      // Check if this is a playlist reorder drop (dragging a playlist onto another)\r\n      const draggedPlaylistId = event.originalEvent!.dataTransfer!.getData('application/x-playlist-id');\r\n      if (draggedPlaylistId && draggedPlaylistId !== playlistId) {\r\n        await this.handlePlaylistReorder(draggedPlaylistId, playlistId);\r\n        return;\r\n      }\r\n\r\n      await this.handleDropTrackToPlaylist(itemId, playlistId);\r\n    });\r\n\r\n    // Playlist reordering - drag start\r\n    html.find('.ase-list-item[data-playlist-id][draggable=\"true\"]').on('dragstart', (event: JQuery.DragStartEvent) => {\r\n      const playlistId = String($(event.currentTarget).data('playlist-id'));\r\n      event.originalEvent!.dataTransfer!.effectAllowed = 'move';\r\n      event.originalEvent!.dataTransfer!.setData('application/x-playlist-id', playlistId);\r\n      $(event.currentTarget).addClass('dragging');\r\n    });\r\n\r\n    html.find('.ase-list-item[data-playlist-id][draggable=\"true\"]').on('dragend', (event: JQuery.DragEndEvent) => {\r\n      $(event.currentTarget).removeClass('dragging');\r\n      html.find('.ase-list-item').removeClass('drag-over drag-above drag-below');\r\n    });\r\n\r\n    // Favorites reordering - drag start\r\n    html.find('.ase-favorite-item[draggable=\"true\"]').on('dragstart', (event: JQuery.DragStartEvent) => {\r\n      const favoriteId = String($(event.currentTarget).data('favorite-id'));\r\n      const favoriteType = String($(event.currentTarget).data('favorite-type'));\r\n      event.originalEvent!.dataTransfer!.effectAllowed = 'move';\r\n      event.originalEvent!.dataTransfer!.setData('application/x-favorite-id', favoriteId);\r\n      event.originalEvent!.dataTransfer!.setData('application/x-favorite-type', favoriteType);\r\n      $(event.currentTarget).addClass('dragging');\r\n    });\r\n\r\n    html.find('.ase-favorite-item[draggable=\"true\"]').on('dragend', (event: JQuery.DragEndEvent) => {\r\n      $(event.currentTarget).removeClass('dragging');\r\n      html.find('.ase-favorite-item').removeClass('drag-over drag-above drag-below');\r\n    });\r\n\r\n    // Visual feedback for playlist insertion position\r\n    html.find('.ase-list-item[data-playlist-id]').on('dragover', (event: JQuery.DragOverEvent) => {\r\n      const draggedPlaylistId = event.originalEvent!.dataTransfer!.types.includes('application/x-playlist-id');\r\n      if (!draggedPlaylistId) return; // Not a playlist drag\r\n\r\n      event.preventDefault();\r\n      event.originalEvent!.dataTransfer!.dropEffect = 'move';\r\n\r\n      const rect = (event.currentTarget as HTMLElement).getBoundingClientRect();\r\n      const midY = rect.top + rect.height / 2;\r\n      const isAbove = event.clientY! < midY;\r\n\r\n      $(event.currentTarget).removeClass('drag-above drag-below');\r\n      $(event.currentTarget).addClass(isAbove ? 'drag-above' : 'drag-below');\r\n    });\r\n\r\n    // Visual feedback for favorites insertion position\r\n    html.find('.ase-favorite-item').on('dragover', (event: JQuery.DragOverEvent) => {\r\n      const hasFavoriteId = event.originalEvent!.dataTransfer!.types.includes('application/x-favorite-id');\r\n      if (!hasFavoriteId) return; // Not a favorite drag\r\n\r\n      event.preventDefault();\r\n      event.originalEvent!.dataTransfer!.dropEffect = 'move';\r\n\r\n      const rect = (event.currentTarget as HTMLElement).getBoundingClientRect();\r\n      const midY = rect.top + rect.height / 2;\r\n      const isAbove = event.clientY! < midY;\r\n\r\n      $(event.currentTarget).removeClass('drag-above drag-below');\r\n      $(event.currentTarget).addClass(isAbove ? 'drag-above' : 'drag-below');\r\n    });\r\n\r\n    html.find('.ase-favorite-item').on('drop', async (event: JQuery.DropEvent) => {\r\n      event.preventDefault();\r\n      const favoriteId = String($(event.currentTarget).data('favorite-id'));\r\n      const favoriteType = String($(event.currentTarget).data('favorite-type'));\r\n\r\n      $(event.currentTarget).removeClass('drag-above drag-below dragging');\r\n\r\n      const draggedId = event.originalEvent!.dataTransfer!.getData('application/x-favorite-id');\r\n      const draggedType = event.originalEvent!.dataTransfer!.getData('application/x-favorite-type');\r\n\r\n      if (draggedId && draggedType && (draggedId !== favoriteId || draggedType !== favoriteType)) {\r\n        await this.handleFavoriteReorder(draggedId, draggedType as 'track' | 'playlist', favoriteId, favoriteType as 'track' | 'playlist');\r\n      }\r\n    });\r\n\r\n    // Drop zone from OS (Main Library Area)\r\n    html.find('.ase-content-area').on('dragover', (event: JQuery.DragOverEvent) => {\r\n      event.preventDefault();\r\n      $(event.currentTarget).addClass('drag-over-import');\r\n    });\r\n\r\n    html.find('.ase-content-area').on('dragleave', (event: JQuery.DragLeaveEvent) => {\r\n      $(event.currentTarget).removeClass('drag-over-import');\r\n    });\r\n\r\n    html.find('.ase-content-area').on('drop', async (event: JQuery.DropEvent) => {\r\n      event.preventDefault();\r\n      $(event.currentTarget).removeClass('drag-over-import');\r\n\r\n      // Handle files from OS\r\n      const files = event.originalEvent?.dataTransfer?.files;\r\n      if (files && files.length > 0) {\r\n        Logger.debug(`Dropped ${files.length} files from OS`);\r\n        // Processing files...\r\n        // Note: Foundry FilePicker/Upload API is needed here.\r\n        // For now, we simulate the drop if it's external, or handle internal drops logic separately.\r\n\r\n        // Check if it's an internal drag (track item)\r\n        // If dataTransfer has 'text/plain' equal to item ID, it's internal.\r\n        const internalId = event.originalEvent?.dataTransfer?.getData('text/plain');\r\n        if (internalId && !files.length) {\r\n          // Internal drop on main area -> Maybe remove from current playlist if we are in one? \r\n          // Currently do nothing.\r\n          return;\r\n        }\r\n\r\n        // Real file upload\r\n        await this.handleFileUpload(files);\r\n      }\r\n    });\r\n  }\r\n\r\n  private async handlePlaylistReorder(draggedId: string, targetId: string): Promise<void> {\r\n    // Get current playlists order\r\n    const playlists = this.library.playlists.getAllPlaylists();\r\n    const draggedIndex = playlists.findIndex(p => p.id === draggedId);\r\n    const targetIndex = playlists.findIndex(p => p.id === targetId);\r\n\r\n    if (draggedIndex === -1 || targetIndex === -1) return;\r\n\r\n    // Reorder\r\n    const [dragged] = playlists.splice(draggedIndex, 1);\r\n    playlists.splice(targetIndex, 0, dragged);\r\n\r\n    // Update order in library (need to save the new order)\r\n    this.library.playlists.reorderPlaylists(playlists.map(p => p.id));\r\n\r\n    this.render();\r\n    Logger.debug(`Reordered playlist ${draggedId} to position ${targetIndex}`);\r\n  }\r\n\r\n  private async handleFavoriteReorder(\r\n    draggedId: string,\r\n    draggedType: 'track' | 'playlist',\r\n    targetId: string,\r\n    targetType: 'track' | 'playlist'\r\n  ): Promise<void> {\r\n    const favorites = this.library.getOrderedFavorites();\r\n    const draggedIndex = favorites.findIndex(f => f.id === draggedId && f.type === draggedType);\r\n    const targetIndex = favorites.findIndex(f => f.id === targetId && f.type === targetType); // Drop ON this item\r\n\r\n    if (draggedIndex === -1 || targetIndex === -1) return;\r\n\r\n    // Remove dragged item\r\n    const [draggedItem] = favorites.splice(draggedIndex, 1);\r\n\r\n    // Insert at target index (shift others down)\r\n    favorites.splice(targetIndex, 0, draggedItem);\r\n\r\n    // Update library\r\n    this.library.reorderFavorites(favorites);\r\n    this.render();\r\n    Logger.debug(`Reordered favorite ${draggedId} to position ${targetIndex}`);\r\n  }\r\n\r\n  private async handleFileUpload(files: FileList): Promise<void> {\r\n    if (!game.user?.isGM) {\r\n      ui.notifications?.warn('Only GM can upload files.');\r\n      return;\r\n    }\r\n\r\n    // Validate audio files\r\n    const audioFiles = Array.from(files).filter(file => {\r\n      const ext = file.name.split('.').pop()?.toLowerCase();\r\n      return ['mp3', 'ogg', 'wav', 'flac', 'webm', 'm4a', 'aac'].includes(ext || '');\r\n    });\r\n\r\n    if (audioFiles.length === 0) {\r\n      ui.notifications?.warn('No valid audio files found. Supported formats: mp3, ogg, wav, flac, webm, m4a, aac');\r\n      return;\r\n    }\r\n\r\n    // Upload to dedicated ase_audio folder (separate from worlds and modules)\r\n    const targetSource = 'data';\r\n    const targetDir = 'ase_audio';\r\n\r\n    // Ensure directory exists (create if needed)\r\n    try {\r\n      await FilePicker.createDirectory(targetSource, targetDir, {});\r\n    } catch (err) {\r\n      // Directory might already exist, ignore error\r\n      Logger.debug('Directory creation skipped (might already exist):', err);\r\n    }\r\n\r\n    let importedCount = 0;\r\n    let failedCount = 0;\r\n\r\n    for (const file of audioFiles) {\r\n      try {\r\n        // Upload file to server\r\n        const response = await FilePicker.upload(targetSource, targetDir, file, {}) as any;\r\n        if (response.path) {\r\n          // Smart channel detection based on filename\r\n          const channel = this.detectChannelFromFilename(file.name);\r\n\r\n          // Get selected tags\r\n          const selectedTags = Array.from(this.filterState.selectedTags);\r\n\r\n          // Add to library\r\n          const track = await this.library.addItem(\r\n            response.path,\r\n            file.name.split('.')[0], // Remove extension\r\n            channel,\r\n            selectedTags\r\n          );\r\n\r\n          // Add to active playlist if one is selected\r\n          if (this.filterState.selectedPlaylistId) {\r\n            try {\r\n              this.library.playlists.addTrackToPlaylist(\r\n                this.filterState.selectedPlaylistId,\r\n                track.id,\r\n                channel\r\n              );\r\n            } catch (err) {\r\n              // Track might already be in playlist, ignore\r\n            }\r\n          }\r\n\r\n          importedCount++;\r\n        }\r\n      } catch (err) {\r\n        Logger.error(`Failed to upload ${file.name}:`, err);\r\n        failedCount++;\r\n      }\r\n    }\r\n\r\n    // Show summary notification\r\n    if (importedCount > 0) {\r\n      const playlistMsg = this.filterState.selectedPlaylistId\r\n        ? ` and added to active playlist`\r\n        : '';\r\n      ui.notifications?.info(`Imported ${importedCount} file(s)${playlistMsg}`);\r\n      this.render();\r\n    }\r\n\r\n    if (failedCount > 0) {\r\n      ui.notifications?.warn(`Failed to import ${failedCount} file(s)`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Smart channel detection based on filename keywords\r\n   */\r\n  private detectChannelFromFilename(filename: string): TrackGroup {\r\n    const lowerName = filename.toLowerCase();\r\n\r\n    // Music keywords\r\n    const musicKeywords = ['music', 'song', 'theme', 'bgm', 'soundtrack', 'score', 'melody', 'музык'];\r\n    if (musicKeywords.some(keyword => lowerName.includes(keyword))) {\r\n      return 'music';\r\n    }\r\n\r\n    // Ambience keywords\r\n    const ambienceKeywords = ['ambient', 'ambience', 'atmosphere', 'environment', 'background', 'nature', 'wind', 'rain', 'forest', 'cave', 'амбиент', 'окружен'];\r\n    if (ambienceKeywords.some(keyword => lowerName.includes(keyword))) {\r\n      return 'ambience';\r\n    }\r\n\r\n    // SFX keywords\r\n    const sfxKeywords = ['sfx', 'sound', 'effect', 'fx', 'hit', 'impact', 'explosion', 'spell', 'attack', 'footstep', 'door', 'sword', 'интерфейс', 'эффект'];\r\n    if (sfxKeywords.some(keyword => lowerName.includes(keyword))) {\r\n      return 'sfx';\r\n    }\r\n\r\n    // Default to music if no keywords detected\r\n    return 'music';\r\n  }\r\n\r\n  private async handleDropTrackToPlaylist(itemId: string, playlistId: string): Promise<void> {\r\n    const item = this.library.getItem(itemId);\r\n    const playlist = this.library.playlists.getPlaylist(playlistId);\r\n\r\n    if (!item || !playlist) {\r\n      ui.notifications?.error('Track or playlist not found');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const group = this.inferGroupFromTags(item.tags) as TrackGroup;\r\n      this.library.playlists.addTrackToPlaylist(playlistId, itemId, group);\r\n      this.render();\r\n      ui.notifications?.info(`Added \"${item.name}\" to \"${playlist.name}\"`);\r\n    } catch (error) {\r\n      Logger.error('Failed to add track to playlist:', error);\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      ui.notifications?.error(`Failed to add to playlist: ${errorMessage}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Setup drag-and-drop handler for Foundry native playlists\r\n   * Allows dragging PlaylistSound items into ASE library\r\n   */\r\n  private setupFoundryDragDrop(html: JQuery): void {\r\n    const dropZone = html.find('.ase-track-player-list');\r\n    if (!dropZone.length) return;\r\n\r\n    // Prevent default drag over to allow drop\r\n    dropZone.on('dragover', (event: JQuery.DragOverEvent) => {\r\n      event.preventDefault();\r\n      event.originalEvent!.dataTransfer!.dropEffect = 'copy';\r\n      dropZone.addClass('drag-over');\r\n    });\r\n\r\n    // Remove visual feedback on drag leave\r\n    dropZone.on('dragleave', (event: JQuery.DragLeaveEvent) => {\r\n      // Only remove if leaving the drop zone itself (not child elements)\r\n      if (event.currentTarget === event.target) {\r\n        dropZone.removeClass('drag-over');\r\n      }\r\n    });\r\n\r\n    // Handle drop\r\n    dropZone.on('drop', async (event: JQuery.DropEvent) => {\r\n      event.preventDefault();\r\n      dropZone.removeClass('drag-over');\r\n\r\n      await this.handleFoundryPlaylistDrop(event.originalEvent!);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle drop event from Foundry playlist\r\n   * Routes to appropriate handler based on type (single track vs full playlist)\r\n   */\r\n  private async handleFoundryPlaylistDrop(event: DragEvent): Promise<void> {\r\n    try {\r\n      // Extract drag data using Foundry's helper (V10+)\r\n      const dragData = TextEditor.getDragEventData(event) as any;\r\n\r\n      if (!dragData) {\r\n        Logger.debug('No drag data found, ignoring');\r\n        return;\r\n      }\r\n\r\n      Logger.debug('Foundry drop detected:', dragData.type);\r\n\r\n      // Route by type\r\n      if (dragData.type === 'PlaylistSound') {\r\n        await this.handlePlaylistSoundImport(dragData);\r\n\r\n\r\n      } else if (dragData.type === 'Playlist') {\r\n        await this.handlePlaylistImport(dragData);\r\n      } else {\r\n        Logger.debug(`Unsupported drop type: ${dragData.type}`);\r\n      }\r\n\r\n    } catch (error) {\r\n      Logger.error('Failed to handle Foundry playlist drop:', error);\r\n      ui.notifications?.error('Failed to import track from playlist');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Import single PlaylistSound track\r\n   */\r\n  private async handlePlaylistSoundImport(dragData: any): Promise<void> {\r\n    // Resolve UUID to get the actual PlaylistSound document\r\n    const sound = await fromUuid(dragData.uuid) as any;\r\n\r\n    if (!sound) {\r\n      ui.notifications?.error('Failed to resolve playlist sound');\r\n      return;\r\n    }\r\n\r\n    // Extract audio path and name\r\n    const audioPath = sound.path || sound.sound?.path;\r\n    const soundName = sound.name;\r\n\r\n    if (!audioPath) {\r\n      ui.notifications?.error('Playlist sound has no audio file path');\r\n      return;\r\n    }\r\n\r\n    // Check if already exists\r\n    const existing = this.library.findByUrl(audioPath);\r\n    if (existing) {\r\n      ui.notifications?.warn(`Track \"${soundName}\" already exists in library`);\r\n      return;\r\n    }\r\n\r\n    // Determine channel (use track channel, or default to 'music')\r\n    const channel = this.mapFoundryChannelToASE(sound.channel);\r\n\r\n    // Add to library\r\n    // Get selected tags\r\n    const selectedTags = Array.from(this.filterState.selectedTags);\r\n\r\n    // Add to library\r\n    const newTrack = await this.library.addItem(audioPath, soundName, channel, selectedTags);\r\n\r\n    // If a playlist is currently selected, add the track to it automatically\r\n    if (this.filterState.selectedPlaylistId) {\r\n      try {\r\n        this.library.playlists.addTrackToPlaylist(\r\n          this.filterState.selectedPlaylistId,\r\n          newTrack.id,\r\n          channel\r\n        );\r\n        const playlist = this.library.playlists.getPlaylist(this.filterState.selectedPlaylistId);\r\n        ui.notifications?.info(`Added \"${soundName}\" to library and playlist \"${playlist?.name}\"`);\r\n      } catch (err) {\r\n        // Track might already be in playlist, just notify about library add\r\n        ui.notifications?.info(`Added \"${soundName}\" to library`);\r\n      }\r\n    } else {\r\n      ui.notifications?.info(`Added \"${soundName}\" to library`);\r\n    }\r\n\r\n    this.render();\r\n  }\r\n\r\n  /**\r\n   * Import entire Playlist with all tracks\r\n   */\r\n  private async handlePlaylistImport(dragData: any): Promise<void> {\r\n    try {\r\n      const playlist = await fromUuid(dragData.uuid) as any;\r\n\r\n      if (!playlist) {\r\n        ui.notifications?.error('Failed to resolve Foundry playlist');\r\n        return;\r\n      }\r\n\r\n      Logger.info(`Importing Foundry playlist: ${playlist.name} (${playlist.sounds.size} tracks)`);\r\n\r\n      const playlistName = this.generateUniquePlaylistName(playlist.name);\r\n      const asePlaylist = this.library.playlists.createPlaylist(playlistName);\r\n\r\n      let addedCount = 0;\r\n      let skippedCount = 0;\r\n\r\n      for (const sound of playlist.sounds) {\r\n        const audioPath = sound.path || sound.sound?.path;\r\n        if (!audioPath) {\r\n          Logger.warn(`Skipping sound \"${sound.name}\" - no path`);\r\n          continue;\r\n        }\r\n\r\n        // Resolve channel with inheritance\r\n        const foundryChannel = sound.channel || playlist.channel;\r\n\r\n        // Map Foundry channels to ASE channels\r\n        let channel: TrackGroup = 'music'; // default\r\n        if (foundryChannel === 'environment') {\r\n          channel = 'ambience';\r\n        } else if (foundryChannel === 'interface') {\r\n          channel = 'sfx';\r\n        } else if (foundryChannel === 'music' || !foundryChannel) {\r\n          channel = 'music';\r\n        }\r\n\r\n        let trackId = this.library.findByUrl(audioPath)?.id;\r\n\r\n        if (!trackId) {\r\n          try {\r\n            // Get selected tags\r\n            const selectedTags = Array.from(this.filterState.selectedTags);\r\n            // Log once per playlist import to avoid spam? Or just log.\r\n            // Logger.debug(`[ASE] PlaylistImport: Adding track with tags: ${JSON.stringify(selectedTags)}`);\r\n\r\n            const track = await this.library.addItem(audioPath, sound.name, channel, selectedTags);\r\n            trackId = track.id;\r\n            addedCount++;\r\n          } catch (err) {\r\n            Logger.error(`Failed to add track \"${sound.name}\":`, err);\r\n            continue;\r\n          }\r\n        } else {\r\n          skippedCount++;\r\n        }\r\n\r\n        this.library.playlists.addTrackToPlaylist(asePlaylist.id, trackId, channel);\r\n      }\r\n\r\n      const message = `Imported playlist \"${playlistName}\": ${addedCount} new tracks${skippedCount > 0 ? `, ${skippedCount} already in library` : ''}`;\r\n      ui.notifications?.info(message);\r\n      this.render();\r\n\r\n    } catch (error) {\r\n      Logger.error('Failed to import Foundry playlist:', error);\r\n      ui.notifications?.error('Failed to import playlist');\r\n    }\r\n  }\r\n\r\n  private resolveFoundryChannel(sound: any, playlist: any): TrackGroup {\r\n    const effectiveChannel = sound.channel || sound.fadeIn?.type || playlist.channel || playlist.mode;\r\n\r\n    return this.mapFoundryChannelToASE(effectiveChannel);\r\n  }\r\n\r\n  private mapFoundryChannelToASE(foundryChannel: string | number | null | undefined): TrackGroup {\r\n    if (!foundryChannel && foundryChannel !== 0) return 'music';\r\n\r\n    // Convert to string for comparison\r\n    const channelStr = String(foundryChannel).toLowerCase();\r\n\r\n    // Foundry uses numeric constants (CONST.AUDIO_CHANNELS):\r\n    // 0 or \"0\" = music\r\n    // 1 or \"1\" = environment  \r\n    // 2 or \"2\" = interface\r\n    const channelMap: Record<string, TrackGroup> = {\r\n      '0': 'music',\r\n      '1': 'ambience',\r\n      '2': 'sfx',\r\n      'music': 'music',\r\n      'environment': 'ambience',\r\n      'interface': 'sfx'\r\n    };\r\n\r\n    const mapped = channelMap[channelStr] || 'music';\r\n\r\n    return mapped;\r\n  }\r\n\r\n  private generateUniquePlaylistName(baseName: string): string {\r\n    const existingPlaylists = this.library.playlists.getAllPlaylists();\r\n    const existingNames = new Set(existingPlaylists.map(p => p.name));\r\n\r\n    if (!existingNames.has(baseName)) return baseName;\r\n\r\n    let counter = 2;\r\n    while (existingNames.has(`${baseName} (${counter})`)) {\r\n      counter++;\r\n    }\r\n\r\n    return `${baseName} (${counter})`;\r\n  }\r\n\r\n  private async removeTrackFromPlaylist(playlistId: string, trackId: string): Promise<void> {\r\n    try {\r\n      this.library.playlists.removeLibraryItemFromPlaylist(playlistId, trackId);\r\n      this.render();\r\n      ui.notifications?.info('Removed track from playlist');\r\n    } catch (error) {\r\n      Logger.error('Failed to remove track from playlist:', error);\r\n      ui.notifications?.error('Failed to remove track from playlist');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Highlight playlists in sidebar that contain the specified track\r\n   */\r\n  private highlightPlaylistsContainingTrack(trackId: string): void {\r\n    const playlists = this.library.playlists.getAllPlaylists();\r\n\r\n    // Find playlists containing this track\r\n    const containingPlaylists = playlists.filter(playlist =>\r\n      playlist.items.some(item => item.libraryItemId === trackId)\r\n    );\r\n\r\n    // Highlight them in the UI\r\n    containingPlaylists.forEach(playlist => {\r\n      $(`[data-playlist-id=\"${playlist.id}\"]`).addClass('highlight-contains-track');\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear all playlist highlights\r\n   */\r\n  private clearPlaylistHighlights(): void {\r\n    $('.highlight-contains-track').removeClass('highlight-contains-track');\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Context Menus\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private setupContextMenus(html: JQuery): void {\r\n    // Track context menu\r\n    new ContextMenu(html, '.track-item', [\r\n      {\r\n        name: 'Edit Name',\r\n        icon: '<i class=\"fas fa-edit\"></i>',\r\n        callback: (target: JQuery | HTMLElement) => {\r\n          const li = $(target);\r\n          const itemId = li.data('item-id') as string;\r\n          this.onEditTrackName(itemId);\r\n        }\r\n      },\r\n      {\r\n        name: 'Edit Tags',\r\n        icon: '<i class=\"fas fa-tags\"></i>',\r\n        callback: (target: JQuery | HTMLElement) => {\r\n          const li = $(target);\r\n          const itemId = li.data('item-id') as string;\r\n          this.onEditTrackTags(itemId);\r\n        }\r\n      },\r\n      {\r\n        name: 'Add to Playlist',\r\n        icon: '<i class=\"fas fa-list-ul\"></i>',\r\n        callback: (target: JQuery | HTMLElement) => {\r\n          const li = $(target);\r\n          const itemId = li.data('item-id') as string;\r\n          this.handleAddToPlaylistFromContext(itemId);\r\n        }\r\n      },\r\n      {\r\n        name: 'Toggle Favorite',\r\n        icon: '<i class=\"fas fa-star\"></i>',\r\n        callback: (target: JQuery | HTMLElement) => {\r\n          const li = $(target);\r\n          const itemId = li.data('item-id') as string;\r\n          try {\r\n            const isFavorite = this.library.toggleFavorite(itemId);\r\n            this.persistScroll();\r\n            this.render();\r\n            ui.notifications?.info(isFavorite ? 'Added to favorites' : 'Removed from favorites');\r\n          } catch (error) {\r\n            Logger.error('Failed to toggle favorite:', error);\r\n            ui.notifications?.error('Failed to update favorite status');\r\n          }\r\n        }\r\n      },\r\n      {\r\n        name: 'Delete Track',\r\n        icon: '<i class=\"fas fa-trash\"></i>',\r\n        callback: (target: JQuery | HTMLElement) => {\r\n          const li = $(target);\r\n          const itemId = li.data('item-id') as string;\r\n          this.onDeleteTrackConfirm(itemId);\r\n        }\r\n      }\r\n    ]);\r\n\r\n    // Playlist context menu\r\n    new ContextMenu(html, '.playlist-item', [\r\n      {\r\n        name: 'Rename Playlist',\r\n        icon: '<i class=\"fas fa-edit\"></i>',\r\n        callback: (target: JQuery | HTMLElement) => {\r\n          const li = $(target);\r\n          const playlistId = li.data('playlist-id') as string;\r\n          this.onRenamePlaylist(playlistId);\r\n        }\r\n      },\r\n      {\r\n        name: 'Edit Description',\r\n        icon: '<i class=\"fas fa-align-left\"></i>',\r\n        callback: (target: JQuery | HTMLElement) => {\r\n          const li = $(target);\r\n          const playlistId = li.data('playlist-id') as string;\r\n          this.onEditPlaylistDescription(playlistId);\r\n        }\r\n      },\r\n      {\r\n        name: 'View Contents',\r\n        icon: '<i class=\"fas fa-list\"></i>',\r\n        callback: (target: JQuery | HTMLElement) => {\r\n          const li = $(target);\r\n          const playlistId = li.data('playlist-id') as string;\r\n          this.onViewPlaylistContents(playlistId);\r\n        }\r\n      },\r\n      {\r\n        name: 'Clear Playlist',\r\n        icon: '<i class=\"fas fa-eraser\"></i>',\r\n        callback: (target: JQuery | HTMLElement) => {\r\n          const li = $(target);\r\n          const playlistId = li.data('playlist-id') as string;\r\n          this.onClearPlaylist(playlistId);\r\n        }\r\n      },\r\n      {\r\n        name: 'Delete Playlist',\r\n        icon: '<i class=\"fas fa-trash\"></i>',\r\n        callback: (target: JQuery | HTMLElement) => {\r\n          const li = $(target);\r\n          const playlistId = li.data('playlist-id') as string;\r\n          this.onDeletePlaylistConfirm(playlistId);\r\n        }\r\n      }\r\n    ]);\r\n\r\n    // Tag context menu\r\n    new ContextMenu(html, '.tag-chip:not(.mini)', [\r\n      {\r\n        name: 'Rename Tag',\r\n        icon: '<i class=\"fas fa-edit\"></i>',\r\n        callback: (target: JQuery | HTMLElement) => {\r\n          const li = $(target);\r\n          const tagName = li.data('tag') as string;\r\n          this.onRenameTag(tagName);\r\n        }\r\n      },\r\n      {\r\n        name: 'Delete Tag',\r\n        icon: '<i class=\"fas fa-trash\"></i>',\r\n        callback: (target: JQuery | HTMLElement) => {\r\n          const li = $(target);\r\n          const tagName = li.data('tag') as string;\r\n          this.onDeleteTag(tagName);\r\n        }\r\n      }\r\n    ]);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Context Menu Handlers - Tracks\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async onEditTrackName(itemId: string): Promise<void> {\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) {\r\n      ui.notifications?.error('Track not found');\r\n      return;\r\n    }\r\n\r\n    const newName = await this.promptTextInput('Edit Track Name', 'Track Name', item.name);\r\n    if (!newName || newName === item.name) return;\r\n\r\n    try {\r\n      this.library.updateItem(itemId, { name: newName });\r\n      this.persistScroll();\r\n      this.render();\r\n      ui.notifications?.info(`Renamed to: ${newName}`);\r\n    } catch (error) {\r\n      Logger.error('Failed to rename track:', error);\r\n      ui.notifications?.error('Failed to rename track');\r\n    }\r\n  }\r\n\r\n  private async onEditTrackTags(itemId: string): Promise<void> {\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) {\r\n      ui.notifications?.error('Track not found');\r\n      return;\r\n    }\r\n\r\n    const tagsString = await this.promptTextInput(\r\n      'Edit Tags',\r\n      'Tags (comma-separated)',\r\n      item.tags.join(', ')\r\n    );\r\n    if (tagsString === null) return;\r\n\r\n    // Parse tags\r\n    const newTags = tagsString\r\n      .split(',')\r\n      .map(t => t.trim())\r\n      .filter(t => t.length > 0);\r\n\r\n    try {\r\n      this.library.updateItem(itemId, { tags: newTags });\r\n      this.persistScroll();\r\n      this.render();\r\n      ui.notifications?.info('Tags updated');\r\n    } catch (error) {\r\n      Logger.error('Failed to update tags:', error);\r\n      ui.notifications?.error('Failed to update tags');\r\n    }\r\n  }\r\n\r\n  private async onDeleteTrackConfirm(itemId: string): Promise<void> {\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) {\r\n      ui.notifications?.error('Track not found');\r\n      return;\r\n    }\r\n\r\n    const confirmed = await Dialog.confirm({\r\n      title: 'Delete Track',\r\n      content: `<p>Are you sure you want to delete <strong>${item.name}</strong> from the library?</p>\r\n                <p class=\"notification warning\">This will remove it from all playlists and favorites.</p>`,\r\n      yes: () => true,\r\n      no: () => false,\r\n      defaultYes: false\r\n    });\r\n\r\n    if (confirmed) {\r\n      try {\r\n        this.library.removeItem(itemId);\r\n        this.persistScroll();\r\n        this.render();\r\n        ui.notifications?.info(`Deleted: ${item.name}`);\r\n      } catch (error) {\r\n        Logger.error('Failed to delete track:', error);\r\n        ui.notifications?.error('Failed to delete track');\r\n      }\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Context Menu Handlers - Playlists\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async onRenamePlaylist(playlistId: string): Promise<void> {\r\n    const playlist = this.library.playlists.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      ui.notifications?.error('Playlist not found');\r\n      return;\r\n    }\r\n\r\n    const newName = await this.promptTextInput('Rename Playlist', 'Playlist Name', playlist.name);\r\n    if (!newName || newName === playlist.name) return;\r\n\r\n    try {\r\n      this.library.playlists.updatePlaylist(playlistId, { name: newName });\r\n      this.render();\r\n      ui.notifications?.info(`Renamed to: ${newName}`);\r\n    } catch (error) {\r\n      Logger.error('Failed to rename playlist:', error);\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      ui.notifications?.error(`Failed to rename playlist: ${errorMessage}`);\r\n    }\r\n  }\r\n\r\n  private async onEditPlaylistDescription(playlistId: string): Promise<void> {\r\n    const playlist = this.library.playlists.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      ui.notifications?.error('Playlist not found');\r\n      return;\r\n    }\r\n\r\n    const description = await this.promptTextInput(\r\n      'Edit Description',\r\n      'Description',\r\n      playlist.description || ''\r\n    );\r\n    if (description === null) return;\r\n\r\n    try {\r\n      this.library.playlists.updatePlaylist(playlistId, { description: description || undefined });\r\n      this.render();\r\n      ui.notifications?.info('Description updated');\r\n    } catch (error) {\r\n      Logger.error('Failed to update description:', error);\r\n      ui.notifications?.error('Failed to update description');\r\n    }\r\n  }\r\n\r\n  private async onViewPlaylistContents(playlistId: string): Promise<void> {\r\n    const playlist = this.library.playlists.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      ui.notifications?.error('Playlist not found');\r\n      return;\r\n    }\r\n\r\n    const items = playlist.items\r\n      .sort((a, b) => a.order - b.order)\r\n      .map((playlistItem, index) => {\r\n        const libraryItem = this.library.getItem(playlistItem.libraryItemId);\r\n        const name = libraryItem?.name || 'Unknown';\r\n        return `<li><strong>${index + 1}.</strong> ${name}</li>`;\r\n      })\r\n      .join('');\r\n\r\n    const content = `\r\n      <div>\r\n        <p><strong>${playlist.name}</strong></p>\r\n        ${playlist.description ? `<p><em>${playlist.description}</em></p>` : ''}\r\n        <p>Total tracks: ${playlist.items.length}</p>\r\n        ${playlist.items.length > 0 ? `<ul class=\"playlist-contents-list\">${items}</ul>` : '<p>No tracks in playlist</p>'}\r\n      </div>\r\n    `;\r\n\r\n    new Dialog({\r\n      title: 'Playlist Contents',\r\n      content,\r\n      buttons: {\r\n        close: {\r\n          icon: '<i class=\"fas fa-times\"></i>',\r\n          label: 'Close'\r\n        }\r\n      },\r\n      default: 'close'\r\n    }).render(true);\r\n  }\r\n\r\n  private async onClearPlaylist(playlistId: string): Promise<void> {\r\n    const playlist = this.library.playlists.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      ui.notifications?.error('Playlist not found');\r\n      return;\r\n    }\r\n\r\n    if (playlist.items.length === 0) {\r\n      ui.notifications?.warn('Playlist is already empty');\r\n      return;\r\n    }\r\n\r\n    const confirmed = await Dialog.confirm({\r\n      title: 'Clear Playlist',\r\n      content: `<p>Are you sure you want to remove all ${playlist.items.length} tracks from <strong>${playlist.name}</strong>?</p>\r\n                <p class=\"notification warning\">This cannot be undone.</p>`,\r\n      yes: () => true,\r\n      no: () => false,\r\n      defaultYes: false\r\n    });\r\n\r\n    if (confirmed) {\r\n      try {\r\n        // Remove all items\r\n        const itemIds = [...playlist.items.map(i => i.id)];\r\n        itemIds.forEach(itemId => {\r\n          try {\r\n            this.library.playlists.removeTrackFromPlaylist(playlistId, itemId);\r\n          } catch (error) {\r\n            Logger.error('Failed to remove item:', error);\r\n          }\r\n        });\r\n\r\n        this.render();\r\n        ui.notifications?.info(`Cleared playlist: ${playlist.name}`);\r\n      } catch (error) {\r\n        Logger.error('Failed to clear playlist:', error);\r\n        ui.notifications?.error('Failed to clear playlist');\r\n      }\r\n    }\r\n  }\r\n\r\n  private async onDeletePlaylistConfirm(playlistId: string): Promise<void> {\r\n    const playlist = this.library.playlists.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      ui.notifications?.error('Playlist not found');\r\n      return;\r\n    }\r\n\r\n    const confirmed = await Dialog.confirm({\r\n      title: 'Delete Playlist',\r\n      content: `<p>Are you sure you want to delete <strong>${playlist.name}</strong>?</p>\r\n                <p class=\"notification info\">The tracks will remain in your library.</p>`,\r\n      yes: () => true,\r\n      no: () => false,\r\n      defaultYes: false\r\n    });\r\n\r\n    if (confirmed) {\r\n      try {\r\n        // Clear playlist filter if this playlist is selected\r\n        if (this.filterState.selectedPlaylistId === playlistId) {\r\n          this.filterState.selectedPlaylistId = null;\r\n        }\r\n\r\n        this.library.playlists.deletePlaylist(playlistId);\r\n        this.render();\r\n        ui.notifications?.info(`Deleted playlist: ${playlist.name}`);\r\n      } catch (error) {\r\n        Logger.error('Failed to delete playlist:', error);\r\n        ui.notifications?.error('Failed to delete playlist');\r\n      }\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Context Menu Handlers - Tags\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async onRenameTag(oldTagName: string): Promise<void> {\r\n    const newTagName = await this.promptTextInput('Rename Tag', 'New Tag Name', oldTagName);\r\n    if (!newTagName || newTagName === oldTagName) return;\r\n\r\n    try {\r\n      // Find all items with this tag and update them\r\n      const items = this.library.getAllItems().filter(item => item.tags.includes(oldTagName));\r\n\r\n      items.forEach(item => {\r\n        const updatedTags = item.tags.map(tag => tag === oldTagName ? newTagName : tag);\r\n        this.library.updateItem(item.id, { tags: updatedTags });\r\n      });\r\n\r\n      // Update filter state if tag is selected\r\n      if (this.filterState.selectedTags.has(oldTagName)) {\r\n        this.filterState.selectedTags.delete(oldTagName);\r\n        this.filterState.selectedTags.add(newTagName);\r\n      }\r\n\r\n      this.render();\r\n      ui.notifications?.info(`Renamed tag \"${oldTagName}\" to \"${newTagName}\" in ${items.length} track(s)`);\r\n    } catch (error) {\r\n      Logger.error('Failed to rename tag:', error);\r\n      ui.notifications?.error('Failed to rename tag');\r\n    }\r\n  }\r\n\r\n  private async onDeleteTag(tagName: string): Promise<void> {\r\n    const items = this.library.getAllItems().filter(item => item.tags.includes(tagName));\r\n\r\n    const confirmed = await Dialog.confirm({\r\n      title: 'Delete Tag',\r\n      content: `<p>Are you sure you want to delete the tag <strong>${tagName}</strong>?</p>\r\n                <p class=\"notification warning\">This will remove the tag from ${items.length} track(s).</p>`,\r\n      yes: () => true,\r\n      no: () => false,\r\n      defaultYes: false\r\n    });\r\n\r\n    if (confirmed) {\r\n      try {\r\n        items.forEach(item => {\r\n          const updatedTags = item.tags.filter(tag => tag !== tagName);\r\n          this.library.updateItem(item.id, { tags: updatedTags });\r\n        });\r\n\r\n        // Remove from filter state if selected\r\n        this.filterState.selectedTags.delete(tagName);\r\n\r\n        this.render();\r\n        ui.notifications?.info(`Deleted tag \"${tagName}\" from ${items.length} track(s)`);\r\n      } catch (error) {\r\n        Logger.error('Failed to delete tag:', error);\r\n        ui.notifications?.error('Failed to delete tag');\r\n      }\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Utilities\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n\r\n\r\n  private async promptPlaylistSelection(playlists: Playlist[]): Promise<string | null> {\r\n    const options = playlists.map(p =>\r\n      `<option value=\"${p.id}\">${p.name} (${p.items.length} tracks)</option>`\r\n    ).join('');\r\n\r\n    return new Promise((resolve) => {\r\n      new Dialog({\r\n        title: 'Add to Playlist',\r\n        content: `\r\n          <form>\r\n            <div class=\"form-group\">\r\n              <label>Select Playlist:</label>\r\n              <select name=\"playlist-id\">\r\n                ${options}\r\n              </select>\r\n            </div>\r\n          </form>\r\n        `,\r\n        buttons: {\r\n          add: {\r\n            icon: '<i class=\"fas fa-plus\"></i>',\r\n            label: 'Add',\r\n            callback: (html: JQuery) => {\r\n              const playlistId = html.find('[name=\"playlist-id\"]').val() as string;\r\n              resolve(playlistId || null);\r\n            }\r\n          },\r\n          cancel: {\r\n            icon: '<i class=\"fas fa-times\"></i>',\r\n            label: 'Cancel',\r\n            callback: () => resolve(null)\r\n          }\r\n        },\r\n        default: 'add'\r\n      }).render(true);\r\n    });\r\n  }\r\n\r\n  private async promptTextInput(\r\n    title: string,\r\n    label: string,\r\n    defaultValue: string = ''\r\n  ): Promise<string | null> {\r\n    return new Promise((resolve) => {\r\n      new Dialog({\r\n        title,\r\n        content: `\r\n          <form>\r\n            <div class=\"form-group\">\r\n              <label>${label}:</label>\r\n              <input type=\"text\" name=\"text-input\" value=\"${defaultValue}\" autofocus />\r\n            </div>\r\n          </form>\r\n        `,\r\n        buttons: {\r\n          save: {\r\n            icon: '<i class=\"fas fa-check\"></i>',\r\n            label: 'Save',\r\n            callback: (html: JQuery) => {\r\n              const value = (html.find('[name=\"text-input\"]').val() as string || '').trim();\r\n              resolve(value || null);\r\n            }\r\n          },\r\n          cancel: {\r\n            icon: '<i class=\"fas fa-times\"></i>',\r\n            label: 'Cancel',\r\n            callback: () => resolve(null)\r\n          }\r\n        },\r\n        default: 'save'\r\n      }).render(true);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle adding track to playlist from context menu\r\n   */\r\n  private async handleAddToPlaylistFromContext(itemId: string): Promise<void> {\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) return;\r\n\r\n    const playlists = this.library.playlists.getAllPlaylists();\r\n    if (playlists.length === 0) {\r\n      ui.notifications?.warn('No playlists available. Create one first.');\r\n      return;\r\n    }\r\n\r\n    const selectedPlaylistId = await this.promptPlaylistSelection(playlists);\r\n    if (!selectedPlaylistId) return;\r\n\r\n    try {\r\n      const group = this.inferGroupFromTags(item.tags) as any;\r\n      this.library.playlists.addTrackToPlaylist(selectedPlaylistId, itemId, group);\r\n      this.render();\r\n      ui.notifications?.info(`Added \"${item.name}\" to playlist`);\r\n    } catch (error) {\r\n      Logger.error('Failed to add track to playlist:', error);\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      ui.notifications?.error(`Failed to add to playlist: ${errorMessage}`);\r\n    }\r\n  }\r\n}\r\n","export function throttle<T extends (...args: Parameters<T>) => void>(\r\n  fn: T,\r\n  delay: number\r\n): (...args: Parameters<T>) => void {\r\n  let lastCall = 0;\r\n  let timeoutId: ReturnType<typeof setTimeout> | null = null;\r\n  \r\n  return function (this: ThisParameterType<T>, ...args: Parameters<T>) {\r\n    const now = Date.now();\r\n    const remaining = delay - (now - lastCall);\r\n    \r\n    if (remaining <= 0) {\r\n      if (timeoutId) {\r\n        clearTimeout(timeoutId);\r\n        timeoutId = null;\r\n      }\r\n      lastCall = now;\r\n      fn.apply(this, args);\r\n    } else if (!timeoutId) {\r\n      timeoutId = setTimeout(() => {\r\n        lastCall = Date.now();\r\n        timeoutId = null;\r\n        fn.apply(this, args);\r\n      }, remaining);\r\n    }\r\n  };\r\n}\r\n\r\nexport function debounce<T extends (...args: Parameters<T>) => void>(\r\n  fn: T,\r\n  delay: number\r\n): (...args: Parameters<T>) => void {\r\n  let timeoutId: ReturnType<typeof setTimeout> | null = null;\r\n  \r\n  return function (this: ThisParameterType<T>, ...args: Parameters<T>) {\r\n    if (timeoutId) {\r\n      clearTimeout(timeoutId);\r\n    }\r\n    timeoutId = setTimeout(() => {\r\n      fn.apply(this, args);\r\n    }, delay);\r\n  };\r\n}","import type { TrackGroup } from '@t/audio';\r\nimport { AudioEngine } from '@core/AudioEngine';\r\nimport { SocketManager } from '@sync/SocketManager';\r\nimport { StreamingPlayer } from '@core/StreamingPlayer';\r\nimport { Logger } from '@utils/logger';\r\nimport { formatTime } from '@utils/time';\r\nimport { throttle } from '@utils/throttle';\r\nimport { generateUUID } from '@utils/uuid';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\n\r\nfunction getMaxSimultaneous(): number {\r\n  return (game.settings.get(MODULE_ID, 'maxSimultaneousTracks') as number) || 8;\r\n}\r\n\r\ninterface MixerData {\r\n  tracks: TrackViewData[];\r\n  volumes: {\r\n    master: number;\r\n    music: number;\r\n    ambience: number;\r\n    sfx: number;\r\n  };\r\n  playingCount: number;\r\n  maxSimultaneous: number;\r\n  syncEnabled: boolean; // Reverted the CSS variable insertion here to maintain valid TypeScript syntax\r\n}\r\n\r\ninterface TrackViewData {\r\n  id: string;\r\n  name: string;\r\n  group: TrackGroup;\r\n  isPlaying: boolean;\r\n  isPaused: boolean;\r\n  isStopped: boolean;\r\n  isLoading: boolean;\r\n  volume: number;\r\n  volumePercent: number;\r\n  loop: boolean;\r\n  currentTime: number;\r\n  currentTimeFormatted: string;\r\n  duration: number;\r\n  durationFormatted: string;\r\n  progress: number;\r\n}\r\n\r\nexport class SoundMixerApp extends Application {\r\n  private engine: AudioEngine;\r\n  private socket: SocketManager;\r\n  private updateInterval: ReturnType<typeof setInterval> | null = null;\r\n\r\n  static override get defaultOptions(): ApplicationOptions {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'ase-sound-mixer',\r\n      title: 'Sound Mixer (GM)',\r\n      template: `modules/${MODULE_ID}/templates/mixer.hbs`,\r\n      classes: ['ase-mixer'],\r\n      width: 550,\r\n      height: 'auto',\r\n      resizable: true,\r\n      minimizable: true,\r\n      popOut: true\r\n    }) as ApplicationOptions;\r\n  }\r\n\r\n  constructor(engine: AudioEngine, socket: SocketManager, options?: Partial<ApplicationOptions>) {\r\n    super(options);\r\n    this.engine = engine;\r\n    this.socket = socket;\r\n  }\r\n\r\n  override getData(): MixerData {\r\n    const tracks = this.engine.getAllTracks().map(player => this.getTrackViewData(player));\r\n    const volumes = this.engine.volumes;\r\n    const playingCount = tracks.filter(t => t.isPlaying).length;\r\n\r\n    return {\r\n      tracks,\r\n      volumes: {\r\n        master: Math.round(volumes.master * 100),\r\n        music: Math.round(volumes.music * 100),\r\n        ambience: Math.round(volumes.ambience * 100),\r\n        sfx: Math.round(volumes.sfx * 100)\r\n      },\r\n      playingCount,\r\n      maxSimultaneous: getMaxSimultaneous(),\r\n      syncEnabled: this.socket.syncEnabled\r\n    };\r\n  }\r\n\r\n  private getTrackViewData(player: StreamingPlayer): TrackViewData {\r\n    const state = player.getState();\r\n    const currentTime = player.getCurrentTime();\r\n    const duration = player.getDuration();\r\n\r\n    return {\r\n      id: state.id,\r\n      name: this.extractFileName(state.url),\r\n      group: state.group,\r\n      isPlaying: state.playbackState === 'playing',\r\n      isPaused: state.playbackState === 'paused',\r\n      isStopped: state.playbackState === 'stopped',\r\n      isLoading: state.playbackState === 'loading',\r\n      volume: state.volume,\r\n      volumePercent: Math.round(state.volume * 100),\r\n      loop: state.loop,\r\n      currentTime,\r\n      currentTimeFormatted: formatTime(currentTime),\r\n      duration,\r\n      durationFormatted: formatTime(duration),\r\n      progress: duration > 0 ? (currentTime / duration) * 100 : 0\r\n    };\r\n  }\r\n\r\n  private extractFileName(url: string): string {\r\n    if (!url) return 'Unknown';\r\n    try {\r\n      const decoded = decodeURIComponent(url);\r\n      const parts = decoded.split('/');\r\n      const fileName = parts[parts.length - 1];\r\n      return fileName.replace(/\\.[^.]+$/, '');\r\n    } catch {\r\n      const parts = url.split('/');\r\n      const fileName = parts[parts.length - 1];\r\n      return fileName.replace(/\\.[^.]+$/, '');\r\n    }\r\n  }\r\n\r\n  override activateListeners(html: JQuery): void {\r\n    super.activateListeners(html);\r\n\r\n    // Sync toggle\r\n    html.find('#ase-sync-toggle').on('change', (event) => {\r\n      const enabled = (event.target as HTMLInputElement).checked;\r\n      this.socket.setSyncEnabled(enabled);\r\n      this.updateSyncIndicator(html, enabled);\r\n    });\r\n\r\n    // Channel volume sliders\r\n    const throttledChannelBroadcast = throttle((channel: string, value: number) => {\r\n      if (channel === 'master') {\r\n        this.socket.broadcastChannelVolume('master', value);\r\n      } else {\r\n        this.socket.broadcastChannelVolume(channel as TrackGroup, value);\r\n      }\r\n    }, 50);\r\n\r\n    html.find('.ase-channel-slider').on('input', (event) => {\r\n      const channel = $(event.currentTarget).data('channel') as string;\r\n      const value = parseFloat((event.target as HTMLInputElement).value) / 100;\r\n\r\n      // Update local engine immediately to prevent UI jitter/reset on re-render\r\n      if (channel === 'master') {\r\n        this.engine.setMasterVolume(value);\r\n      } else {\r\n        this.engine.setChannelVolume(channel as TrackGroup, value);\r\n      }\r\n\r\n      throttledChannelBroadcast(channel, value);\r\n      $(event.currentTarget).siblings('.ase-channel-value').text(`${Math.round(value * 100)}%`);\r\n    });\r\n\r\n    // Add track\r\n    html.find('#ase-add-track').on('click', () => this.onAddTrack());\r\n\r\n    // Track controls\r\n    const tracks = html.find('.ase-tracks');\r\n\r\n    tracks.on('click', '.ase-btn-play', (event) => {\r\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\r\n      this.onPlayTrack(trackId);\r\n    });\r\n\r\n    tracks.on('click', '.ase-btn-pause', (event) => {\r\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\r\n      this.onPauseTrack(trackId);\r\n    });\r\n\r\n    tracks.on('click', '.ase-btn-stop', (event) => {\r\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\r\n      this.onStopTrack(trackId);\r\n    });\r\n\r\n    tracks.on('click', '.ase-btn-remove', (event) => {\r\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\r\n      this.onRemoveTrack(trackId);\r\n    });\r\n\r\n    tracks.on('change', '.ase-loop-toggle', (event) => {\r\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\r\n      const loop = (event.target as HTMLInputElement).checked;\r\n      this.engine.setTrackLoop(trackId, loop);\r\n      this.socket.broadcastTrackLoop(trackId, loop);\r\n    });\r\n\r\n    tracks.on('change', '.ase-channel-select', (event) => {\r\n      const trackId = $(event.currentTarget).data('track-id') as string;\r\n      const channel = (event.target as HTMLSelectElement).value as TrackGroup;\r\n      this.engine.setTrackChannel(trackId, channel);\r\n    });\r\n\r\n    // Volume slider\r\n    const throttledVolumeBroadcast = throttle((trackId: string, value: number) => {\r\n      this.socket.broadcastTrackVolume(trackId, value);\r\n    }, 50);\r\n\r\n    tracks.on('input', '.ase-volume-slider', (event) => {\r\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\r\n      const value = parseFloat((event.target as HTMLInputElement).value) / 100;\r\n\r\n      this.engine.setTrackVolume(trackId, value); // Decoupled engine update from throttle\r\n      throttledVolumeBroadcast(trackId, value);\r\n\r\n      $(event.currentTarget).siblings('.ase-volume-value').text(`${Math.round(value * 100)}%`);\r\n    });\r\n\r\n    // Seek slider\r\n    const throttledSeek = throttle((trackId: string, time: number) => {\r\n      const player = this.engine.getTrack(trackId);\r\n      const isPlaying = player?.state === 'playing';\r\n      this.engine.seekTrack(trackId, time);\r\n      this.socket.broadcastTrackSeek(trackId, time, isPlaying ?? false);\r\n    }, 100);\r\n\r\n    tracks.on('input', '.ase-seek-slider', (event) => {\r\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\r\n      const player = this.engine.getTrack(trackId);\r\n      if (player) {\r\n        const percent = parseFloat((event.target as HTMLInputElement).value);\r\n        const time = (percent / 100) * player.getDuration();\r\n        throttledSeek(trackId, time);\r\n      }\r\n    });\r\n\r\n    // Stop all\r\n    html.find('#ase-stop-all').on('click', () => {\r\n      this.engine.stopAll();\r\n      this.socket.broadcastStopAll();\r\n      this.render();\r\n    });\r\n\r\n    this.startUpdates();\r\n  }\r\n\r\n  private updateSyncIndicator(html: JQuery, enabled: boolean): void {\r\n    const indicator = html.find('.ase-sync-status');\r\n    indicator.toggleClass('is-active', enabled);\r\n    indicator.find('span').text(enabled ? 'SYNC ON' : 'SYNC OFF');\r\n  }\r\n\r\n  private startUpdates(): void {\r\n    this.stopUpdates();\r\n    this.updateInterval = setInterval(() => {\r\n      this.updateTrackDisplays();\r\n    }, 250);\r\n  }\r\n\r\n  private stopUpdates(): void {\r\n    if (this.updateInterval) {\r\n      clearInterval(this.updateInterval);\r\n      this.updateInterval = null;\r\n    }\r\n  }\r\n\r\n  private updateTrackDisplays(): void {\r\n    const html = this.element;\r\n    if (!html || !html.length) return;\r\n\r\n    let playingCount = 0;\r\n\r\n    for (const player of this.engine.getAllTracks()) {\r\n      const trackEl = html.find(`.ase-track[data-track-id=\"${player.id}\"]`);\r\n      if (!trackEl.length) continue;\r\n\r\n      const currentTime = player.getCurrentTime();\r\n      const duration = player.getDuration();\r\n      const progress = duration > 0 ? (currentTime / duration) * 100 : 0;\r\n      const state = player.state;\r\n\r\n      if (state === 'playing') playingCount++;\r\n\r\n      trackEl.find('.ase-time-current').text(formatTime(currentTime));\r\n\r\n      const seekSlider = trackEl.find('.ase-seek-slider');\r\n      if (!seekSlider.is(':active')) {\r\n        seekSlider.val(progress);\r\n      }\r\n\r\n      trackEl.removeClass('is-playing is-paused is-stopped is-loading');\r\n      trackEl.addClass(`is-${state}`);\r\n\r\n      trackEl.find('.ase-btn-play').prop('disabled', state === 'playing' || state === 'loading');\r\n      trackEl.find('.ase-btn-pause').prop('disabled', state !== 'playing');\r\n      trackEl.find('.ase-btn-stop').prop('disabled', state === 'stopped');\r\n    }\r\n\r\n    const totalTracks = this.engine.getAllTracks().length;\r\n    html.find('.ase-track-count').text(`${playingCount}/${totalTracks} playing`);\r\n  }\r\n\r\n  private async onAddTrack(): Promise<void> {\r\n    const fp = new FilePicker({\r\n      type: 'audio',\r\n      current: '',\r\n      callback: async (path: string) => {\r\n        await this.addTrackFromPath(path);\r\n      }\r\n    });\r\n    fp.render(true);\r\n  }\r\n\r\n  async addTrackFromPath(path: string, group: TrackGroup = 'music'): Promise<void> {\r\n    const trackId = generateUUID();\r\n\r\n    try {\r\n      await this.engine.createTrack({\r\n        id: trackId,\r\n        url: path,\r\n        group,\r\n        volume: 1,\r\n        loop: false\r\n      });\r\n\r\n      this.render();\r\n      ui.notifications?.info(`Added: ${this.extractFileName(path)}`);\r\n\r\n    } catch (error) {\r\n      Logger.error('Failed to add track:', error);\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      ui.notifications?.error(`Failed to load: ${errorMessage}`);\r\n    }\r\n  }\r\n\r\n  private async onPlayTrack(trackId: string): Promise<void> {\r\n    const player = this.engine.getTrack(trackId);\r\n    if (!player) return;\r\n\r\n    const offset = player.state === 'paused' ? player.getCurrentTime() : 0;\r\n    await this.engine.playTrack(trackId, offset);\r\n    this.socket.broadcastTrackPlay(trackId, offset);\r\n  }\r\n\r\n  private onPauseTrack(trackId: string): void {\r\n    const player = this.engine.getTrack(trackId);\r\n    if (!player) return;\r\n\r\n    const pausedAt = player.getCurrentTime();\r\n    this.engine.pauseTrack(trackId);\r\n    this.socket.broadcastTrackPause(trackId, pausedAt);\r\n  }\r\n\r\n  private onStopTrack(trackId: string): void {\r\n    this.engine.stopTrack(trackId);\r\n    this.socket.broadcastTrackStop(trackId);\r\n  }\r\n\r\n  private onRemoveTrack(trackId: string): void {\r\n    this.engine.removeTrack(trackId);\r\n    this.render();\r\n  }\r\n\r\n  override close(options?: Application.CloseOptions): Promise<void> {\r\n    this.stopUpdates();\r\n    return super.close(options);\r\n  }\r\n}","import { AudioEngine } from '@core/AudioEngine';\r\nimport { SocketManager } from '@sync/SocketManager';\r\nimport { LibraryManager } from '@lib/LibraryManager';\r\nimport { LocalLibraryApp } from './LocalLibraryApp';\r\nimport { SoundMixerApp } from './SoundMixerApp';\r\nimport { Logger } from '@utils/logger';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\n\r\ninterface AppState {\r\n    activeTab: 'mixer' | 'library' | 'online' | 'sfx';\r\n    syncEnabled: boolean;\r\n}\r\n\r\nexport class AdvancedSoundEngineApp extends Application {\r\n    private engine: AudioEngine;\r\n    private socket: SocketManager;\r\n    private libraryManager: LibraryManager;\r\n\r\n    // Sub-apps (Controllers)\r\n    private libraryApp: LocalLibraryApp;\r\n    private mixerApp: SoundMixerApp; // We might need to refactor this later, but for now we'll wrap it\r\n\r\n    public state: AppState = {\r\n        activeTab: 'library', // Default to library as per user focus\r\n        syncEnabled: false\r\n    };\r\n\r\n    constructor(engine: AudioEngine, socket: SocketManager, libraryManager: LibraryManager, options: any = {}) {\r\n        super(options);\r\n        this.engine = engine;\r\n        this.socket = socket;\r\n        this.libraryManager = libraryManager;\r\n\r\n        // Initialize sub-controllers\r\n        // Note: We pass this app instance or handle delegation\r\n        this.libraryApp = new LocalLibraryApp(this.libraryManager, this);\r\n        this.mixerApp = new SoundMixerApp(this.engine, this.socket);\r\n    }\r\n\r\n    static override get defaultOptions() {\r\n        return foundry.utils.mergeObject(super.defaultOptions, {\r\n            id: 'advanced-sound-engine-app',\r\n            title: 'Advanced Sound Engine',\r\n            template: `modules/${MODULE_ID}/templates/main-app.hbs`,\r\n            width: 1200, // Wider for the concepts\r\n            height: 800,\r\n            classes: ['ase-window-layout'],\r\n            resizable: true,\r\n            popOut: true,\r\n            tabs: [] // We handle tabs manually\r\n        }) as any;\r\n    }\r\n\r\n    override async getData(): Promise<any> {\r\n        const volumes = this.engine.volumes;\r\n\r\n        // Helper to check channel status\r\n        const getChannelStatus = (group: 'music' | 'ambience' | 'sfx') => {\r\n            const tracks = this.engine.getTracksByGroup(group);\r\n            if (tracks.length === 0) return { playing: false, paused: false };\r\n\r\n            const isPlaying = tracks.some(t => t.state === 'playing');\r\n            const isPaused = tracks.some(t => t.state === 'paused');\r\n\r\n            return { playing: isPlaying, paused: isPaused && !isPlaying };\r\n        };\r\n\r\n        const status = {\r\n            music: getChannelStatus('music'),\r\n            ambience: getChannelStatus('ambience'),\r\n            sfx: getChannelStatus('sfx')\r\n        };\r\n\r\n        // Get content for the active tab\r\n        let tabContent = '';\r\n        if (this.state.activeTab === 'library') {\r\n            const libData = await this.libraryApp.getData();\r\n            tabContent = await renderTemplate('modules/advanced-sound-engine/templates/library.hbs', libData as any);\r\n        } else if (this.state.activeTab === 'mixer') {\r\n            const mixerData = await this.mixerApp.getData();\r\n            tabContent = await renderTemplate(`modules/${MODULE_ID}/templates/mixer.hbs`, mixerData as any);\r\n        }\r\n\r\n        return {\r\n            activeTab: this.state.activeTab,\r\n            tabContent,\r\n            status,\r\n            volumes: {\r\n                master: Math.round(volumes.master * 100),\r\n                music: Math.round(volumes.music * 100),\r\n                ambience: Math.round(volumes.ambience * 100),\r\n                sfx: Math.round(volumes.sfx * 100)\r\n            },\r\n            syncEnabled: this.socket.syncEnabled\r\n        };\r\n    }\r\n\r\n    public persistScrollOnce = false;\r\n    private _scrollLibrary = { tracks: 0, playlists: 0, favorites: 0 };\r\n\r\n    protected override async _render(force?: boolean, options?: any): Promise<void> {\r\n        // Save Scroll (only if explicitly requested via flag)\r\n        if (this.state.activeTab === 'library' && this.persistScrollOnce && this.element && this.element.length) {\r\n            const trackScroll = this.element.find('.ase-track-player-list').scrollTop() || 0;\r\n            if (trackScroll > 0) this._scrollLibrary.tracks = trackScroll;\r\n\r\n            this._scrollLibrary.playlists = this.element.find('.ase-list-group').first().scrollTop() || 0;\r\n            this._scrollLibrary.favorites = this.element.find('.ase-favorites-section .ase-list-group').scrollTop() || 0;\r\n        }\r\n\r\n        await super._render(force, options);\r\n\r\n        // Restore or Reset Scroll\r\n        if (this.state.activeTab === 'library') {\r\n            const el = this.element;\r\n            if (el && el.length) {\r\n                if (this.persistScrollOnce) {\r\n                    el.find('.ase-track-player-list').scrollTop(this._scrollLibrary.tracks);\r\n                    el.find('.ase-list-group').first().scrollTop(this._scrollLibrary.playlists);\r\n                    el.find('.ase-favorites-section .ase-list-group').scrollTop(this._scrollLibrary.favorites);\r\n                    this.persistScrollOnce = false;\r\n                } else {\r\n                    // Explicit reset to 0\r\n                    el.find('.ase-track-player-list').scrollTop(0);\r\n                    el.find('.ase-list-group').first().scrollTop(0);\r\n                    el.find('.ase-favorites-section .ase-list-group').scrollTop(0);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    override activateListeners(html: JQuery): void {\r\n        super.activateListeners(html);\r\n\r\n        // Tab Navigation\r\n        html.find('.ase-tab').on('click', this.onTabSwitch.bind(this));\r\n\r\n        // Footer Controls (A7)\r\n        html.find('[data-action=\"toggle-sync\"]').on('click', this.onToggleSync.bind(this));\r\n        html.find('[data-action=\"global-play\"]').on('click', this.onGlobalPlay.bind(this));\r\n        html.find('[data-action=\"global-pause\"]').on('click', this.onGlobalPause.bind(this));\r\n        html.find('[data-action=\"global-stop\"]').on('click', this.onGlobalStop.bind(this));\r\n\r\n        // Mixer Sliders (Inputs)\r\n        html.find('.ase-volume-slider').on('input', this.onVolumeInput.bind(this));\r\n\r\n\r\n        // Delegate listeners to sub-apps\r\n        if (this.state.activeTab === 'library') {\r\n            this.libraryApp.activateListeners(html);\r\n        } else if (this.state.activeTab === 'mixer') {\r\n            this.mixerApp.activateListeners(html);\r\n        }\r\n    }\r\n\r\n    private async onTabSwitch(event: JQuery.ClickEvent): Promise<void> {\r\n        event.preventDefault();\r\n        const tabName = $(event.currentTarget).data('tab');\r\n        if (this.state.activeTab === tabName) return;\r\n\r\n        this.state.activeTab = tabName;\r\n        this.render(true);\r\n    }\r\n\r\n    // Footer Actions\r\n    private onToggleSync(event: JQuery.ClickEvent): void {\r\n        const enabled = !this.socket.syncEnabled;\r\n        this.socket.setSyncEnabled(enabled);\r\n        this.state.syncEnabled = enabled;\r\n\r\n        // Update UI\r\n        this.render(); // Re-render to ensure all sync indicators update (button + toggle)\r\n    }\r\n\r\n    private onGlobalPlay(): void {\r\n        this.engine.resume();\r\n        // Resume all paused tracks\r\n        // TODO: This logic probably belongs in AudioEngine as resumeAll()\r\n        const tracks = this.engine.getAllTracks();\r\n        for (const track of tracks) {\r\n            if (track.state === 'paused') {\r\n                track.play();\r\n            }\r\n        }\r\n        Logger.debug('Global Play/Resume Clicked');\r\n        this.render();\r\n    }\r\n\r\n    private onGlobalPause(): void {\r\n        // Pause all playing tracks\r\n        const tracks = this.engine.getAllTracks();\r\n        for (const track of tracks) {\r\n            if (track.state === 'playing') {\r\n                track.pause();\r\n            }\r\n        }\r\n        Logger.debug('Global Pause Clicked');\r\n        this.render();\r\n    }\r\n\r\n    private onGlobalStop(): void {\r\n        this.engine.stopAll();\r\n        // this.socket.broadcastStopAll(); // Logic handled in SoundMixerApp usually\r\n        this.render(); // Update UI\r\n    }\r\n\r\n    private onVolumeInput(event: JQuery.TriggeredEvent): void {\r\n        const input = event.currentTarget as HTMLInputElement;\r\n        const value = parseFloat(input.value) / 100;\r\n        const channel = $(input).data('channel') as 'music' | 'ambience' | 'sfx' | undefined;\r\n\r\n        if (channel) {\r\n            this.engine.setChannelVolume(channel, value);\r\n            this.socket.broadcastChannelVolume(channel, value);\r\n        } else {\r\n            // Master\r\n            this.engine.setMasterVolume(value);\r\n            this.socket.broadcastChannelVolume('master', value);\r\n        }\r\n\r\n        // Update text locally for responsiveness\r\n        $(input).siblings('.ase-percentage').text(`${Math.round(value * 100)}%`);\r\n        $(input).siblings('.ase-master-perc').text(`${Math.round(value * 100)}%`);\r\n    }\r\n}\r\n","import type { Playlist, PlaylistItem } from '@t/library';\r\nimport type { TrackGroup } from '@t/audio';\r\nimport { generateUUID } from '@utils/uuid';\r\nimport { Logger } from '@utils/logger';\r\n\r\nexport class PlaylistManager {\r\n  private playlists: Map<string, Playlist> = new Map();\r\n  private onChangeCallback?: () => void;\r\n\r\n  constructor(onChangeCallback?: () => void) {\r\n    this.onChangeCallback = onChangeCallback;\r\n  }\r\n\r\n  /**\r\n   * Notify about changes (triggers save)\r\n   */\r\n  private notifyChange(): void {\r\n    if (this.onChangeCallback) {\r\n      this.onChangeCallback();\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // CRUD Operations - Playlists\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  /**\r\n   * Create new playlist\r\n   */\r\n  createPlaylist(name: string, description?: string): Playlist {\r\n    // Check for duplicate names\r\n    const existing = this.findByName(name);\r\n    if (existing) {\r\n      throw new Error(`Playlist with name \"${name}\" already exists`);\r\n    }\r\n\r\n    const now = Date.now();\r\n    const playlist: Playlist = {\r\n      id: generateUUID(),\r\n      name,\r\n      description,\r\n      items: [],\r\n      createdAt: now,\r\n      updatedAt: now,\r\n      favorite: false\r\n    };\r\n\r\n    this.playlists.set(playlist.id, playlist);\r\n    this.notifyChange();\r\n    Logger.info(`Playlist created: ${playlist.name} (${playlist.id})`);\r\n\r\n    return playlist;\r\n  }\r\n\r\n  /**\r\n   * Update playlist metadata\r\n   */\r\n  updatePlaylist(id: string, updates: Partial<Pick<Playlist, 'name' | 'description' | 'favorite'>>): Playlist {\r\n    const playlist = this.playlists.get(id);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${id}`);\r\n    }\r\n\r\n    // Validate name uniqueness if changing name\r\n    if (updates.name && updates.name !== playlist.name) {\r\n      const existing = this.findByName(updates.name);\r\n      if (existing && existing.id !== id) {\r\n        throw new Error(`Playlist with name \"${updates.name}\" already exists`);\r\n      }\r\n    }\r\n\r\n    // Update playlist\r\n    const updated = {\r\n      ...playlist,\r\n      ...updates,\r\n      updatedAt: Date.now()\r\n    };\r\n\r\n    this.playlists.set(id, updated);\r\n    this.notifyChange();\r\n    Logger.info(`Playlist updated: ${updated.name}`);\r\n\r\n    return updated;\r\n  }\r\n\r\n  /**\r\n   * Delete playlist\r\n   */\r\n  deletePlaylist(id: string): void {\r\n    const playlist = this.playlists.get(id);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${id}`);\r\n    }\r\n\r\n    this.playlists.delete(id);\r\n    this.notifyChange();\r\n    Logger.info(`Playlist deleted: ${playlist.name}`);\r\n  }\r\n\r\n  /**\r\n   * Get playlist by ID\r\n   */\r\n  getPlaylist(id: string): Playlist | undefined {\r\n    return this.playlists.get(id);\r\n  }\r\n\r\n  /**\r\n   * Get all playlists\r\n   */\r\n  getAllPlaylists(): Playlist[] {\r\n    return Array.from(this.playlists.values());\r\n  }\r\n\r\n  /**\r\n   * Find playlist by name\r\n   */\r\n  findByName(name: string): Playlist | undefined {\r\n    return Array.from(this.playlists.values()).find(p => p.name === name);\r\n  }\r\n\r\n  /**\r\n   * Get favorite playlists\r\n   */\r\n  getFavoritePlaylists(): Playlist[] {\r\n    return this.getAllPlaylists().filter(p => p.favorite);\r\n  }\r\n\r\n  /**\r\n   * Reorder playlists based on new order array of IDs\r\n   */\r\n  reorderPlaylists(orderedIds: string[]): void {\r\n    const newMap = new Map<string, Playlist>();\r\n\r\n    // First, add playlists in the new order\r\n    orderedIds.forEach(id => {\r\n      const playlist = this.playlists.get(id);\r\n      if (playlist) {\r\n        newMap.set(id, playlist);\r\n      }\r\n    });\r\n\r\n    // Add any remaining playlists that weren't in the order array\r\n    this.playlists.forEach((playlist, id) => {\r\n      if (!newMap.has(id)) {\r\n        newMap.set(id, playlist);\r\n      }\r\n    });\r\n\r\n    this.playlists = newMap;\r\n    this.notifyChange();\r\n    Logger.info('Playlists reordered');\r\n  }\r\n\r\n\r\n  /**\r\n   * Toggle playlist favorite status\r\n   */\r\n  togglePlaylistFavorite(id: string): boolean {\r\n    const playlist = this.getPlaylist(id);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${id}`);\r\n    }\r\n\r\n    playlist.favorite = !playlist.favorite;\r\n    playlist.updatedAt = Date.now();\r\n    this.notifyChange();\r\n\r\n    return playlist.favorite;\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // CRUD Operations - Playlist Items\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  /**\r\n   * Add track to playlist\r\n   */\r\n  addTrackToPlaylist(\r\n    playlistId: string,\r\n    libraryItemId: string,\r\n    group: TrackGroup,\r\n    options?: Partial<Omit<PlaylistItem, 'id' | 'libraryItemId' | 'group' | 'order'>>\r\n  ): PlaylistItem {\r\n    const playlist = this.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${playlistId}`);\r\n    }\r\n\r\n    // Check if track already exists in playlist\r\n    const exists = playlist.items.find(item => item.libraryItemId === libraryItemId);\r\n    if (exists) {\r\n      throw new Error('Track already exists in this playlist');\r\n    }\r\n\r\n    // Create new playlist item\r\n    const item: PlaylistItem = {\r\n      id: generateUUID(),\r\n      libraryItemId,\r\n      group,\r\n      volume: options?.volume ?? 1.0,\r\n      loop: options?.loop ?? false,\r\n      order: playlist.items.length,\r\n      fadeIn: options?.fadeIn,\r\n      fadeOut: options?.fadeOut\r\n    };\r\n\r\n    playlist.items.push(item);\r\n    playlist.updatedAt = Date.now();\r\n    this.notifyChange();\r\n\r\n    Logger.debug(`Track added to playlist ${playlist.name}: ${libraryItemId}`);\r\n\r\n    return item;\r\n  }\r\n\r\n  /**\r\n   * Remove track from playlist\r\n   */\r\n  removeTrackFromPlaylist(playlistId: string, playlistItemId: string): void {\r\n    const playlist = this.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${playlistId}`);\r\n    }\r\n\r\n    const index = playlist.items.findIndex(item => item.id === playlistItemId);\r\n    if (index === -1) {\r\n      throw new Error(`Playlist item not found: ${playlistItemId}`);\r\n    }\r\n\r\n    playlist.items.splice(index, 1);\r\n\r\n    // Reorder remaining items\r\n    this.reorderPlaylistItems(playlist);\r\n\r\n    playlist.updatedAt = Date.now();\r\n    this.notifyChange();\r\n    Logger.debug(`Track removed from playlist ${playlist.name}`);\r\n  }\r\n\r\n  /**\r\n   * Remove all tracks with specific library item ID from playlist\r\n   */\r\n  removeLibraryItemFromPlaylist(playlistId: string, libraryItemId: string): number {\r\n    const playlist = this.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${playlistId}`);\r\n    }\r\n\r\n    const initialLength = playlist.items.length;\r\n    playlist.items = playlist.items.filter(item => item.libraryItemId !== libraryItemId);\r\n    const removed = initialLength - playlist.items.length;\r\n\r\n    if (removed > 0) {\r\n      this.reorderPlaylistItems(playlist);\r\n      playlist.updatedAt = Date.now();\r\n      this.notifyChange();\r\n      Logger.debug(`Removed ${removed} instances of library item ${libraryItemId} from playlist ${playlist.name}`);\r\n    }\r\n\r\n    return removed;\r\n  }\r\n\r\n  /**\r\n   * Remove library item from all playlists\r\n   */\r\n  removeLibraryItemFromAllPlaylists(libraryItemId: string): number {\r\n    let totalRemoved = 0;\r\n\r\n    this.playlists.forEach(playlist => {\r\n      const initialLength = playlist.items.length;\r\n      playlist.items = playlist.items.filter(item => item.libraryItemId !== libraryItemId);\r\n      const removed = initialLength - playlist.items.length;\r\n\r\n      if (removed > 0) {\r\n        this.reorderPlaylistItems(playlist);\r\n        playlist.updatedAt = Date.now();\r\n        totalRemoved += removed;\r\n      }\r\n    });\r\n\r\n    if (totalRemoved > 0) {\r\n      this.notifyChange();\r\n      Logger.info(`Removed library item ${libraryItemId} from ${totalRemoved} playlist(s)`);\r\n    }\r\n\r\n    return totalRemoved;\r\n  }\r\n\r\n  /**\r\n   * Update playlist item\r\n   */\r\n  updatePlaylistItem(\r\n    playlistId: string,\r\n    playlistItemId: string,\r\n    updates: Partial<Omit<PlaylistItem, 'id' | 'libraryItemId' | 'order'>>\r\n  ): PlaylistItem {\r\n    const playlist = this.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${playlistId}`);\r\n    }\r\n\r\n    const item = playlist.items.find(i => i.id === playlistItemId);\r\n    if (!item) {\r\n      throw new Error(`Playlist item not found: ${playlistItemId}`);\r\n    }\r\n\r\n    // Update item\r\n    Object.assign(item, updates);\r\n    playlist.updatedAt = Date.now();\r\n    this.notifyChange();\r\n\r\n    Logger.debug(`Playlist item updated in ${playlist.name}`);\r\n\r\n    return item;\r\n  }\r\n\r\n  /**\r\n   * Reorder track in playlist\r\n   */\r\n  reorderTrack(playlistId: string, playlistItemId: string, newOrder: number): void {\r\n    const playlist = this.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${playlistId}`);\r\n    }\r\n\r\n    const itemIndex = playlist.items.findIndex(i => i.id === playlistItemId);\r\n    if (itemIndex === -1) {\r\n      throw new Error(`Playlist item not found: ${playlistItemId}`);\r\n    }\r\n\r\n    // Validate new order\r\n    if (newOrder < 0 || newOrder >= playlist.items.length) {\r\n      throw new Error(`Invalid order: ${newOrder}`);\r\n    }\r\n\r\n    // Remove item from current position\r\n    const [item] = playlist.items.splice(itemIndex, 1);\r\n\r\n    // Insert at new position\r\n    playlist.items.splice(newOrder, 0, item);\r\n\r\n    // Reorder all items\r\n    this.reorderPlaylistItems(playlist);\r\n\r\n    playlist.updatedAt = Date.now();\r\n    this.notifyChange();\r\n    Logger.debug(`Track reordered in playlist ${playlist.name}`);\r\n  }\r\n\r\n  /**\r\n   * Get tracks in playlist\r\n   */\r\n  getPlaylistTracks(playlistId: string): PlaylistItem[] {\r\n    const playlist = this.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${playlistId}`);\r\n    }\r\n\r\n    return [...playlist.items].sort((a, b) => a.order - b.order);\r\n  }\r\n\r\n  /**\r\n   * Get playlists containing a specific library item\r\n   */\r\n  getPlaylistsContainingItem(libraryItemId: string): Playlist[] {\r\n    return this.getAllPlaylists().filter(playlist =>\r\n      playlist.items.some(item => item.libraryItemId === libraryItemId)\r\n    );\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Persistence\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  /**\r\n   * Load playlists from state object\r\n   */\r\n  load(playlistsData: Record<string, Playlist>): void {\r\n    this.playlists.clear();\r\n\r\n    Object.values(playlistsData).forEach(playlist => {\r\n      // Ensure items are properly ordered\r\n      playlist.items.sort((a, b) => a.order - b.order);\r\n      this.playlists.set(playlist.id, playlist);\r\n    });\r\n\r\n    Logger.info(`PlaylistManager loaded: ${this.playlists.size} playlists`);\r\n  }\r\n\r\n  /**\r\n   * Export playlists to state object\r\n   */\r\n  export(): Record<string, Playlist> {\r\n    return Object.fromEntries(this.playlists);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Utilities\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  /**\r\n   * Reorder playlist items to ensure consecutive order values\r\n   */\r\n  private reorderPlaylistItems(playlist: Playlist): void {\r\n    playlist.items.forEach((item, index) => {\r\n      item.order = index;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get statistics\r\n   */\r\n  getStats() {\r\n    const playlists = this.getAllPlaylists();\r\n    return {\r\n      totalPlaylists: playlists.length,\r\n      favoritePlaylists: playlists.filter(p => p.favorite).length,\r\n      totalTracks: playlists.reduce((sum, p) => sum + p.items.length, 0),\r\n      averageTracksPerPlaylist: playlists.length > 0\r\n        ? Math.round(playlists.reduce((sum, p) => sum + p.items.length, 0) / playlists.length)\r\n        : 0\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Clear all playlists\r\n   */\r\n  clear(): void {\r\n    this.playlists.clear();\r\n    Logger.warn('All playlists cleared');\r\n  }\r\n}\r\n","import type { LibraryItem, LibraryState } from '@t/library';\r\nimport type { TrackGroup } from '@t/audio';\r\nimport { generateUUID } from '@utils/uuid';\r\nimport { validateAudioFile } from '@utils/audio-validation';\r\nimport { Logger } from '@utils/logger';\r\nimport { debounce } from '@utils/throttle';\r\nimport { PlaylistManager } from './PlaylistManager';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\nconst LIBRARY_VERSION = 1;\r\n\r\nexport class LibraryManager {\r\n  private items: Map<string, LibraryItem> = new Map();\r\n  private customTags: Set<string> = new Set();\r\n  private favoritesOrder: Array<{ id: string, type: 'track' | 'playlist', addedAt: number }> = [];\r\n  private saveScheduled = false;\r\n  public readonly playlists: PlaylistManager;\r\n\r\n  // New property to track if we've initiated a scan this session\r\n  private hasScannedDurations = false;\r\n\r\n  private debouncedSave = debounce(() => {\r\n    this.saveToSettings();\r\n  }, 500);\r\n\r\n  constructor() {\r\n    this.playlists = new PlaylistManager(() => this.scheduleSave());\r\n    this.loadFromSettings();\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // CRUD Operations\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  /**\r\n   * Add new item to library\r\n   */\r\n  async addItem(url: string, name?: string, group: TrackGroup = 'music', tags: string[] = []): Promise<LibraryItem> {\r\n    // Validate audio format\r\n    const validation = validateAudioFile(url);\r\n    if (!validation.valid) {\r\n      throw new Error(validation.error || 'Invalid audio file');\r\n    }\r\n\r\n    // Generate name from filename if not provided\r\n    const itemName = name || this.extractNameFromUrl(url);\r\n\r\n    // Check for duplicates by URL\r\n    const existingByUrl = this.findByUrl(url);\r\n    if (existingByUrl) {\r\n      throw new Error(`Track with this URL already exists: ${existingByUrl.name}`);\r\n    }\r\n\r\n    // Check for duplicates by name\r\n    const existingByName = this.findByName(itemName);\r\n    if (existingByName) {\r\n      throw new Error(`Track with name \"${itemName}\" already exists in library`);\r\n    }\r\n\r\n    const now = Date.now();\r\n    const item: LibraryItem = {\r\n      id: generateUUID(),\r\n      url,\r\n      name: itemName,\r\n      tags: tags,\r\n      group: group,\r\n      duration: 0,\r\n      favorite: false,\r\n      addedAt: now,\r\n      updatedAt: now\r\n    };\r\n\r\n    // Asynchronously extract duration\r\n    const audio = new Audio(url);\r\n    audio.addEventListener('loadedmetadata', () => {\r\n      if (audio.duration && isFinite(audio.duration)) {\r\n        item.duration = Math.round(audio.duration);\r\n        this.scheduleSave();\r\n        Logger.info(`Updated duration for ${item.name}: ${item.duration}s`);\r\n      }\r\n    });\r\n    // Handle error to avoid hanging if file is invalid/unreachable (though we don't block return)\r\n    audio.addEventListener('error', (e) => {\r\n      Logger.warn(`Failed to extract duration for ${item.name}:`, e);\r\n    });\r\n\r\n    this.items.set(item.id, item);\r\n    this.scheduleSave();\r\n\r\n    Logger.info(`Library item added: ${item.name} (${item.id})`);\r\n    return item;\r\n  }\r\n\r\n  /**\r\n   * Update existing item\r\n   */\r\n  updateItem(id: string, updates: Partial<LibraryItem>): LibraryItem {\r\n    const item = this.items.get(id);\r\n    if (!item) {\r\n      throw new Error(`Library item not found: ${id}`);\r\n    }\r\n\r\n    // Validate name uniqueness if changing name\r\n    if (updates.name && updates.name !== item.name) {\r\n      const existingByName = this.findByName(updates.name);\r\n      if (existingByName && existingByName.id !== id) {\r\n        throw new Error(`Track with name \"${updates.name}\" already exists`);\r\n      }\r\n    }\r\n\r\n    // Validate URL uniqueness if changing URL\r\n    if (updates.url && updates.url !== item.url) {\r\n      const validation = validateAudioFile(updates.url);\r\n      if (!validation.valid) {\r\n        throw new Error(validation.error || 'Invalid audio file');\r\n      }\r\n\r\n      const existingByUrl = this.findByUrl(updates.url);\r\n      if (existingByUrl && existingByUrl.id !== id) {\r\n        throw new Error(`Track with this URL already exists: ${existingByUrl.name}`);\r\n      }\r\n    }\r\n\r\n    // Prevent ID change\r\n    delete updates.id;\r\n\r\n    // Update item\r\n    const updated = {\r\n      ...item,\r\n      ...updates,\r\n      updatedAt: Date.now()\r\n    };\r\n\r\n    this.items.set(id, updated);\r\n    this.scheduleSave();\r\n\r\n    Logger.info(`Library item updated: ${updated.name}`);\r\n    return updated;\r\n  }\r\n\r\n  /**\r\n   * Remove item from library\r\n   */\r\n  removeItem(id: string): void {\r\n    const item = this.items.get(id);\r\n    if (!item) {\r\n      throw new Error(`Library item not found: ${id}`);\r\n    }\r\n\r\n    // Remove from all playlists first\r\n    this.playlists.removeLibraryItemFromAllPlaylists(id);\r\n\r\n    this.items.delete(id);\r\n    this.scheduleSave();\r\n\r\n    Logger.info(`Library item removed: ${item.name}`);\r\n  }\r\n\r\n  /**\r\n   * Get item by ID\r\n   */\r\n  getItem(id: string): LibraryItem | undefined {\r\n    return this.items.get(id);\r\n  }\r\n\r\n  /**\r\n   * Get all items\r\n   */\r\n  getAllItems(): LibraryItem[] {\r\n    return Array.from(this.items.values());\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Search & Filter\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  /**\r\n   * Find item by URL\r\n   */\r\n  findByUrl(url: string): LibraryItem | undefined {\r\n    return Array.from(this.items.values()).find(item => item.url === url);\r\n  }\r\n\r\n  /**\r\n   * Find item by name\r\n   */\r\n  findByName(name: string): LibraryItem | undefined {\r\n    return Array.from(this.items.values()).find(item => item.name === name);\r\n  }\r\n\r\n  /**\r\n   * Search items by query\r\n   */\r\n  searchByName(query: string): LibraryItem[] {\r\n    const lowerQuery = query.toLowerCase();\r\n    return this.getAllItems().filter(item =>\r\n      item.name.toLowerCase().includes(lowerQuery)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Filter items by tags (OR logic)\r\n   */\r\n  filterByTags(tags: string[]): LibraryItem[] {\r\n    if (tags.length === 0) return this.getAllItems();\r\n\r\n    return this.getAllItems().filter(item =>\r\n      item.tags.some(tag => tags.includes(tag))\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get favorite items (sorted by favoritesOrder)\r\n   */\r\n  getFavorites(): LibraryItem[] {\r\n    return this.getAllItems().filter(item => item.favorite);\r\n  }\r\n\r\n  /**\r\n   * Get ordered favorites list (tracks + playlists)\r\n   */\r\n  getOrderedFavorites(): Array<{ id: string, type: 'track' | 'playlist', addedAt: number }> {\r\n    // Clean up orphaned entries and ensure all favorites are in the order list\r\n    const validFavorites: Array<{ id: string, type: 'track' | 'playlist', addedAt: number }> = [];\r\n\r\n    // First, include items from the order list that still exist\r\n    for (const entry of this.favoritesOrder) {\r\n      if (entry.type === 'track') {\r\n        const item = this.items.get(entry.id);\r\n        if (item && item.favorite) {\r\n          validFavorites.push(entry);\r\n        }\r\n      } else {\r\n        const playlist = this.playlists.getPlaylist(entry.id);\r\n        if (playlist && playlist.favorite) {\r\n          validFavorites.push(entry);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Add any favorites not in the order list (at the beginning = newest)\r\n    const inOrderSet = new Set(validFavorites.map(f => `${f.type}:${f.id}`));\r\n\r\n    // Tracks\r\n    for (const item of this.getAllItems()) {\r\n      if (item.favorite && !inOrderSet.has(`track:${item.id}`)) {\r\n        validFavorites.unshift({ id: item.id, type: 'track', addedAt: Date.now() });\r\n      }\r\n    }\r\n\r\n    // Playlists\r\n    for (const playlist of this.playlists.getFavoritePlaylists()) {\r\n      if (!inOrderSet.has(`playlist:${playlist.id}`)) {\r\n        validFavorites.unshift({ id: playlist.id, type: 'playlist', addedAt: Date.now() });\r\n      }\r\n    }\r\n\r\n    this.favoritesOrder = validFavorites;\r\n    return validFavorites;\r\n  }\r\n\r\n  /**\r\n   * Reorder favorites based on new order array\r\n   */\r\n  reorderFavorites(orderedItems: Array<{ id: string, type: 'track' | 'playlist' }>): void {\r\n    const now = Date.now();\r\n    this.favoritesOrder = orderedItems.map(item => ({\r\n      id: item.id,\r\n      type: item.type,\r\n      addedAt: this.favoritesOrder.find(f => f.id === item.id && f.type === item.type)?.addedAt ?? now\r\n    }));\r\n    this.scheduleSave();\r\n    Logger.info('Favorites reordered');\r\n  }\r\n\r\n  /**\r\n   * Add item to favorites order (at the beginning = newest)\r\n   */\r\n  addToFavoritesOrder(id: string, type: 'track' | 'playlist'): void {\r\n    // Remove if already exists\r\n    this.favoritesOrder = this.favoritesOrder.filter(f => !(f.id === id && f.type === type));\r\n    // Add at beginning (newest first)\r\n    this.favoritesOrder.unshift({ id, type, addedAt: Date.now() });\r\n    this.scheduleSave();\r\n  }\r\n\r\n  /**\r\n   * Remove item from favorites order\r\n   */\r\n  removeFromFavoritesOrder(id: string, type: 'track' | 'playlist'): void {\r\n    this.favoritesOrder = this.favoritesOrder.filter(f => !(f.id === id && f.type === type));\r\n    this.scheduleSave();\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Tags Management\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  /**\r\n   * Get all unique tags\r\n   */\r\n  getAllTags(): string[] {\r\n    const tagSet = new Set<string>(this.customTags);\r\n    this.items.forEach(item => {\r\n      item.tags.forEach(tag => tagSet.add(tag));\r\n    });\r\n    return Array.from(tagSet).sort();\r\n  }\r\n\r\n  /**\r\n   * Add a custom tag explicitly (even if not used on any track)\r\n   */\r\n  addCustomTag(tag: string): void {\r\n    // Normalize: trim and remove leading #\r\n    const normalizedTag = tag.trim().replace(/^#/, '');\r\n    if (normalizedTag && !this.customTags.has(normalizedTag)) {\r\n      this.customTags.add(normalizedTag);\r\n      this.scheduleSave();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add tag to item\r\n   */\r\n  addTagToItem(itemId: string, tag: string): void {\r\n    const item = this.getItem(itemId);\r\n    if (!item) {\r\n      throw new Error(`Library item not found: ${itemId}`);\r\n    }\r\n\r\n    if (!item.tags.includes(tag)) {\r\n      item.tags.push(tag);\r\n      item.updatedAt = Date.now();\r\n      this.scheduleSave();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove tag from item\r\n   */\r\n  removeTagFromItem(itemId: string, tag: string): void {\r\n    const item = this.getItem(itemId);\r\n    if (!item) {\r\n      throw new Error(`Library item not found: ${itemId}`);\r\n    }\r\n\r\n    const index = item.tags.indexOf(tag);\r\n    if (index !== -1) {\r\n      item.tags.splice(index, 1);\r\n      item.updatedAt = Date.now();\r\n      this.scheduleSave();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Rename tag globally\r\n   */\r\n  renameTag(oldTag: string, newTag: string): number {\r\n    let count = 0;\r\n    this.items.forEach(item => {\r\n      const index = item.tags.indexOf(oldTag);\r\n      if (index !== -1) {\r\n        item.tags[index] = newTag;\r\n        item.updatedAt = Date.now();\r\n        count++;\r\n      }\r\n    });\r\n\r\n    if (count > 0) {\r\n      if (this.customTags.has(oldTag)) {\r\n        this.customTags.delete(oldTag);\r\n        this.customTags.add(newTag);\r\n      }\r\n      this.scheduleSave();\r\n      Logger.info(`Tag renamed: \"${oldTag}\" → \"${newTag}\" (${count} items)`);\r\n    } else if (this.customTags.has(oldTag)) {\r\n      // Renaming a tag that is ONLY in customTags (no items)\r\n      this.customTags.delete(oldTag);\r\n      this.customTags.add(newTag);\r\n      this.scheduleSave();\r\n      Logger.info(`Custom tag renamed: \"${oldTag}\" → \"${newTag}\"`);\r\n    }\r\n\r\n    return count;\r\n  }\r\n\r\n  /**\r\n   * Delete tag globally\r\n   */\r\n  deleteTag(tag: string): number {\r\n    let count = 0;\r\n    this.items.forEach(item => {\r\n      const index = item.tags.indexOf(tag);\r\n      if (index !== -1) {\r\n        item.tags.splice(index, 1);\r\n        item.updatedAt = Date.now();\r\n        count++;\r\n      }\r\n    });\r\n\r\n    if (count > 0) {\r\n      if (this.customTags.has(tag)) {\r\n        this.customTags.delete(tag);\r\n      }\r\n      this.scheduleSave();\r\n      Logger.info(`Tag deleted: \"${tag}\" (${count} items)`);\r\n    } else if (this.customTags.has(tag)) {\r\n      // Deleting a tag that is ONLY in customTags\r\n      this.customTags.delete(tag);\r\n      this.scheduleSave();\r\n      Logger.info(`Custom tag deleted: \"${tag}\"`);\r\n    }\r\n\r\n    return count;\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Favorites\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  /**\r\n   * Toggle favorite status\r\n   */\r\n  toggleFavorite(itemId: string): boolean {\r\n    const item = this.getItem(itemId);\r\n    if (!item) {\r\n      throw new Error(`Library item not found: ${itemId}`);\r\n    }\r\n\r\n    item.favorite = !item.favorite;\r\n    item.updatedAt = Date.now();\r\n\r\n    // Update favorites order\r\n    if (item.favorite) {\r\n      this.addToFavoritesOrder(itemId, 'track');\r\n    } else {\r\n      this.removeFromFavoritesOrder(itemId, 'track');\r\n    }\r\n\r\n    this.scheduleSave();\r\n\r\n    return item.favorite;\r\n  }\r\n\r\n\r\n  /**\r\n   * Scan library for items with missing duration (0) and try to extract it.\r\n   * Run this once per session or on demand.\r\n   */\r\n  public async scanMissingDurations(): Promise<void> {\r\n    if (this.hasScannedDurations) return;\r\n    this.hasScannedDurations = true;\r\n\r\n    const missing = Array.from(this.items.values()).filter(i => !i.duration || i.duration === 0);\r\n    if (missing.length === 0) return;\r\n\r\n    Logger.info(`Scanning ${missing.length} items for missing duration...`);\r\n    let updatedCount = 0;\r\n\r\n    // Process in batches to avoid network spam\r\n    const batchSize = 5;\r\n    for (let i = 0; i < missing.length; i += batchSize) {\r\n      const batch = missing.slice(i, i + batchSize);\r\n      await Promise.all(batch.map(item => new Promise<void>((resolve) => {\r\n        const audio = new Audio(item.url);\r\n\r\n        const cleanup = () => {\r\n          audio.onloadedmetadata = null;\r\n          audio.onerror = null;\r\n          resolve();\r\n        };\r\n\r\n        audio.onloadedmetadata = () => {\r\n          if (audio.duration && isFinite(audio.duration)) {\r\n            item.duration = Math.round(audio.duration);\r\n            updatedCount++;\r\n            // Don't save immediately for each item, batch it\r\n          }\r\n          cleanup();\r\n        };\r\n\r\n        audio.onerror = () => {\r\n          // Logger.warn(`Failed to extract duration for ${item.name} during scan`); // Optional: don't spam logs\r\n          cleanup();\r\n        };\r\n\r\n        // Timeout to prevent hanging\r\n        setTimeout(cleanup, 5000);\r\n      })));\r\n    }\r\n\r\n    if (updatedCount > 0) {\r\n      Logger.info(`Updated duration for ${updatedCount} items.`);\r\n      this.scheduleSave();\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Persistence\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private loadFromSettings(): void {\r\n    try {\r\n      const saved = (game.settings as any)?.get(MODULE_ID, 'libraryState') as string;\r\n      if (!saved) {\r\n        Logger.info('No saved library state, starting fresh');\r\n        return;\r\n      }\r\n\r\n      const state: LibraryState = JSON.parse(saved);\r\n\r\n      // Migrate if needed\r\n      if (state.version !== LIBRARY_VERSION) {\r\n        Logger.warn(`Library version mismatch: ${state.version} → ${LIBRARY_VERSION}`);\r\n        // Add migration logic here if needed\r\n      }\r\n\r\n      // Load items\r\n      this.items.clear();\r\n      Object.values(state.items).forEach(item => {\r\n        this.items.set(item.id, item);\r\n      });\r\n\r\n      // Load custom tags\r\n      this.customTags = new Set(state.customTags || []);\r\n\r\n      // Load playlists\r\n      this.playlists.load(state.playlists || {});\r\n\r\n      // Load favorites order\r\n      this.favoritesOrder = (state as any).favoritesOrder || [];\r\n\r\n      Logger.info(`Library loaded: ${this.items.size} items, ${this.playlists.getAllPlaylists().length} playlists, ${this.customTags.size} custom tags`);\r\n    } catch (error) {\r\n      Logger.error('Failed to load library state:', error);\r\n    }\r\n  }\r\n\r\n  private saveToSettings(): void {\r\n    try {\r\n      const state: LibraryState = {\r\n        items: Object.fromEntries(this.items),\r\n        playlists: this.playlists.export(),\r\n        customTags: Array.from(this.customTags),\r\n        favoritesOrder: this.favoritesOrder,\r\n        version: LIBRARY_VERSION,\r\n        lastModified: Date.now()\r\n      } as any;\r\n\r\n      (game.settings as any)?.set(MODULE_ID, 'libraryState', JSON.stringify(state));\r\n      this.saveScheduled = false;\r\n\r\n      Logger.debug(`Library saved: ${this.items.size} items, ${this.playlists.getAllPlaylists().length} playlists`);\r\n    } catch (error) {\r\n      Logger.error('Failed to save library state:', error);\r\n    }\r\n  }\r\n\r\n  private scheduleSave(): void {\r\n    this.debouncedSave();\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Utilities\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private extractNameFromUrl(url: string): string {\r\n    try {\r\n      const decoded = decodeURIComponent(url);\r\n      const parts = decoded.split('/');\r\n      const filename = parts[parts.length - 1];\r\n      return filename.replace(/\\.[^.]+$/, ''); // Remove extension\r\n    } catch {\r\n      return 'Unknown Track';\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get library statistics\r\n   */\r\n  getStats() {\r\n    const items = this.getAllItems();\r\n    const playlistStats = this.playlists.getStats();\r\n\r\n    return {\r\n      totalItems: items.length,\r\n      favoriteItems: items.filter(i => i.favorite).length,\r\n      totalDuration: items.reduce((sum, i) => sum + i.duration, 0),\r\n      tagCount: this.getAllTags().length,\r\n      playlists: playlistStats.totalPlaylists\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Clear all library data\r\n   */\r\n  clear(): void {\r\n    this.items.clear();\r\n    this.playlists.clear();\r\n    this.scheduleSave();\r\n    Logger.warn('Library cleared');\r\n  }\r\n\r\n  /**\r\n   * Dispose resources\r\n   */\r\n  dispose(): void {\r\n    // Save immediately before disposing\r\n    if (this.saveScheduled) {\r\n      this.saveToSettings();\r\n    }\r\n  }\r\n}\r\n","import type { QueueItem, PlaybackQueueState } from '@t/queue';\r\nimport type { TrackGroup } from '@t/audio';\r\nimport { Logger } from '../utils/logger';\r\n\r\ntype QueueEventType = 'add' | 'remove' | 'change' | 'active';\r\ntype QueueEventCallback = (data: { item?: QueueItem; items?: QueueItem[] }) => void;\r\n\r\n/**\r\n * Manages the runtime playback queue\r\n * This is NOT persisted - it's a session-level working set for the mixer\r\n */\r\nexport class PlaybackQueueManager {\r\n    private items: QueueItem[] = [];\r\n    private activeItemId: string | null = null;\r\n    private eventListeners: Map<QueueEventType, Set<QueueEventCallback>> = new Map();\r\n\r\n    constructor() {\r\n        Logger.info('PlaybackQueueManager initialized');\r\n    }\r\n\r\n    // ─────────────────────────────────────────────────────────────\r\n    // Core Operations\r\n    // ─────────────────────────────────────────────────────────────\r\n\r\n    /**\r\n     * Add a library item to the queue\r\n     */\r\n    addItem(libraryItemId: string, options?: Partial<Omit<QueueItem, 'id' | 'libraryItemId' | 'addedAt'>>): QueueItem {\r\n        const item: QueueItem = {\r\n            id: foundry.utils.randomID(),\r\n            libraryItemId,\r\n            group: options?.group ?? 'music',\r\n            addedAt: Date.now(),\r\n            state: 'stopped',\r\n            volume: options?.volume ?? 1,\r\n            loop: options?.loop ?? false,\r\n            playlistId: options?.playlistId,\r\n        };\r\n\r\n        this.items.push(item);\r\n        this.emit('add', { item });\r\n        this.emit('change', { items: this.items });\r\n\r\n        Logger.debug('Added to queue:', item.id, libraryItemId);\r\n        return item;\r\n    }\r\n\r\n    /**\r\n     * Add all items from a playlist to the queue\r\n     */\r\n    addPlaylist(playlistId: string, playlistItems: Array<{ libraryItemId: string; group: TrackGroup; volume?: number; loop?: boolean }>): QueueItem[] {\r\n        const added: QueueItem[] = [];\r\n\r\n        for (const pItem of playlistItems) {\r\n            const queueItem = this.addItem(pItem.libraryItemId, {\r\n                playlistId,\r\n                group: pItem.group,\r\n                volume: pItem.volume,\r\n                loop: pItem.loop,\r\n            });\r\n            added.push(queueItem);\r\n        }\r\n\r\n        return added;\r\n    }\r\n\r\n    /**\r\n     * Remove an item from the queue\r\n     */\r\n    removeItem(queueItemId: string): boolean {\r\n        const index = this.items.findIndex(i => i.id === queueItemId);\r\n        if (index === -1) return false;\r\n\r\n        const [removed] = this.items.splice(index, 1);\r\n\r\n        if (this.activeItemId === queueItemId) {\r\n            this.activeItemId = null;\r\n            this.emit('active', { item: undefined });\r\n        }\r\n\r\n        this.emit('remove', { item: removed });\r\n        this.emit('change', { items: this.items });\r\n\r\n        Logger.debug('Removed from queue:', queueItemId);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Clear all items from the queue\r\n     */\r\n    clearQueue(): void {\r\n        this.items = [];\r\n        this.activeItemId = null;\r\n        this.emit('change', { items: [] });\r\n        this.emit('active', { item: undefined });\r\n        Logger.debug('Queue cleared');\r\n    }\r\n\r\n    // ─────────────────────────────────────────────────────────────\r\n    // Playback Control\r\n    // ─────────────────────────────────────────────────────────────\r\n\r\n    /**\r\n     * Set the currently active (playing) item\r\n     */\r\n    setActive(queueItemId: string | null): void {\r\n        if (queueItemId && !this.items.find(i => i.id === queueItemId)) {\r\n            Logger.warn('Cannot set active: item not in queue', queueItemId);\r\n            return;\r\n        }\r\n\r\n        this.activeItemId = queueItemId;\r\n        const item = this.getActive();\r\n        this.emit('active', { item: item ?? undefined });\r\n        Logger.debug('Active item set:', queueItemId);\r\n    }\r\n\r\n    /**\r\n     * Get the currently active item\r\n     */\r\n    getActive(): QueueItem | null {\r\n        if (!this.activeItemId) return null;\r\n        return this.items.find(i => i.id === this.activeItemId) ?? null;\r\n    }\r\n\r\n    /**\r\n     * Get the next item in the queue (after active)\r\n     */\r\n    getNext(): QueueItem | null {\r\n        if (!this.activeItemId) return this.items[0] ?? null;\r\n\r\n        const currentIndex = this.items.findIndex(i => i.id === this.activeItemId);\r\n        if (currentIndex === -1 || currentIndex >= this.items.length - 1) return null;\r\n\r\n        return this.items[currentIndex + 1];\r\n    }\r\n\r\n    /**\r\n     * Get the previous item in the queue (before active)\r\n     */\r\n    getPrevious(): QueueItem | null {\r\n        if (!this.activeItemId) return null;\r\n\r\n        const currentIndex = this.items.findIndex(i => i.id === this.activeItemId);\r\n        if (currentIndex <= 0) return null;\r\n\r\n        return this.items[currentIndex - 1];\r\n    }\r\n\r\n    /**\r\n     * Update the state of a queue item\r\n     */\r\n    updateItemState(queueItemId: string, state: QueueItem['state']): void {\r\n        const item = this.items.find(i => i.id === queueItemId);\r\n        if (item) {\r\n            item.state = state;\r\n            this.emit('change', { items: this.items });\r\n        }\r\n    }\r\n\r\n    // ─────────────────────────────────────────────────────────────\r\n    // State Access\r\n    // ─────────────────────────────────────────────────────────────\r\n\r\n    /**\r\n     * Get all items in the queue\r\n     */\r\n    getItems(): QueueItem[] {\r\n        return [...this.items];\r\n    }\r\n\r\n    /**\r\n     * Get full queue state\r\n     */\r\n    getState(): PlaybackQueueState {\r\n        return {\r\n            items: [...this.items],\r\n            activeItemId: this.activeItemId,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Check if an item is in the queue\r\n     */\r\n    hasItem(libraryItemId: string): boolean {\r\n        return this.items.some(i => i.libraryItemId === libraryItemId);\r\n    }\r\n\r\n    /**\r\n     * Remove all queue items that reference a specific library item\r\n     */\r\n    removeByLibraryItemId(libraryItemId: string): boolean {\r\n        const toRemove = this.items.filter(i => i.libraryItemId === libraryItemId);\r\n        if (toRemove.length === 0) return false;\r\n\r\n        for (const item of toRemove) {\r\n            this.removeItem(item.id);\r\n        }\r\n        return true;\r\n    }\r\n\r\n    // ─────────────────────────────────────────────────────────────\r\n    // Event System\r\n    // ─────────────────────────────────────────────────────────────\r\n\r\n    on(event: QueueEventType, callback: QueueEventCallback): void {\r\n        if (!this.eventListeners.has(event)) {\r\n            this.eventListeners.set(event, new Set());\r\n        }\r\n        this.eventListeners.get(event)!.add(callback);\r\n    }\r\n\r\n    off(event: QueueEventType, callback: QueueEventCallback): void {\r\n        this.eventListeners.get(event)?.delete(callback);\r\n    }\r\n\r\n    private emit(event: QueueEventType, data: { item?: QueueItem; items?: QueueItem[] }): void {\r\n        this.eventListeners.get(event)?.forEach(cb => cb(data));\r\n    }\r\n}\r\n","import '../styles/sound-engine.scss';\r\nimport { AudioEngine } from '@core/AudioEngine';\r\nimport { PlayerAudioEngine } from '@core/PlayerAudioEngine';\r\nimport { SocketManager } from '@sync/SocketManager';\r\nimport { SoundMixerApp } from '@ui/SoundMixerApp';\r\nimport { PlayerVolumePanel } from '@ui/PlayerVolumePanel';\r\nimport { LocalLibraryApp } from '@ui/LocalLibraryApp';\r\nimport { AdvancedSoundEngineApp } from '@ui/AdvancedSoundEngineApp';\r\nimport { LibraryManager } from '@lib/LibraryManager';\r\nimport { PlaybackQueueManager } from './queue/PlaybackQueueManager';\r\nimport { Logger } from '@utils/logger';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\n\r\n// GM\r\n// GM\r\nlet gmEngine: AudioEngine | null = null;\r\nlet mainApp: AdvancedSoundEngineApp | null = null;\r\nlet libraryManager: LibraryManager | null = null;\r\n\r\n// Player\r\nlet playerEngine: PlayerAudioEngine | null = null;\r\nlet volumePanel: PlayerVolumePanel | null = null;\r\n\r\n// Shared\r\nlet socketManager: SocketManager | null = null;\r\n\r\ndeclare global {\r\n  interface Window {\r\n    ASE: {\r\n      isGM: boolean;\r\n      openPanel: (tab?: string, forceRender?: boolean) => void;\r\n      openLibrary?: () => void;\r\n      engine?: AudioEngine | PlayerAudioEngine;\r\n      socket?: SocketManager;\r\n      library?: LibraryManager;\r\n      queue?: PlaybackQueueManager;\r\n    };\r\n  }\r\n}\r\n\r\n\r\n\r\n// Add button to scene controls\r\n// Add button to scene controls\r\nHooks.on('getSceneControlButtons' as any, (controls: any[]) => {\r\n  try {\r\n    const isGM = game.user?.isGM ?? false;\r\n\r\n    const aseTools: any[] = [\r\n      {\r\n        name: 'ase-open-mixer',\r\n        title: isGM ? 'Open Sound Mixer' : 'Open Sound Volume',\r\n        icon: isGM ? 'fas fa-sliders-h' : 'fas fa-volume-up',\r\n        button: true,\r\n        onClick: () => {\r\n          console.log('ASE | Button clicked: Open Mixer/Volume');\r\n          if (window.ASE) {\r\n            console.log('ASE | Window.ASE exists', window.ASE);\r\n            window.ASE.openPanel();\r\n          } else {\r\n            console.error('ASE | Window.ASE is undefined!');\r\n          }\r\n        }\r\n      }\r\n    ];\r\n\r\n    if (isGM) {\r\n      aseTools.push({\r\n        name: 'ase-open-library',\r\n        title: 'Open Sound Library',\r\n        icon: 'fas fa-book-open',\r\n        button: true,\r\n        onClick: () => {\r\n          console.log('ASE | Button clicked: Open Library');\r\n          if (window.ASE && window.ASE.openLibrary) {\r\n            window.ASE.openLibrary();\r\n          } else {\r\n            console.error('ASE | Window.ASE or openLibrary undefined');\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n    // Debug what we received\r\n    console.log('ASE | getSceneControlButtons called with:', controls);\r\n\r\n    // V13+ Compatibility: controls might be an object/record instead of an array\r\n    if (!Array.isArray(controls) && typeof controls === 'object' && controls !== null) {\r\n      console.log('ASE | Detected non-array controls structure (V13?)');\r\n\r\n      // Check if \"sounds\" exists as a property\r\n      const soundsLayer = (controls as any).sounds;\r\n\r\n      if (soundsLayer && Array.isArray(soundsLayer.tools)) {\r\n        soundsLayer.tools.push(...aseTools);\r\n        console.log('ASE | Added tools to \"sounds\" layer (V13 Object Mode)');\r\n      } else {\r\n        // Fallback: Add as a new property\r\n        (controls as any)['advanced-sound-engine'] = {\r\n          name: 'advanced-sound-engine',\r\n          title: 'Advanced Sound Engine',\r\n          icon: 'fas fa-music',\r\n          visible: true,\r\n          tools: aseTools\r\n        };\r\n        console.log('ASE | Created dedicated control group (V13 Object Mode)');\r\n      }\r\n      return;\r\n    }\r\n\r\n    // V10-V12 Compatibility: controls is an array\r\n    if (Array.isArray(controls)) {\r\n      // Try to find the \"sounds\" layer control group\r\n      const soundsLayer = controls.find(c => c.name === 'sounds');\r\n\r\n      if (soundsLayer) {\r\n        // Add our tools to the existing sounds layer\r\n        soundsLayer.tools.push(...aseTools);\r\n        console.log('ASE | Added tools to \"sounds\" layer');\r\n      } else {\r\n        // Fallback: Create a dedicated group if \"sounds\" layer is missing\r\n        controls.push({\r\n          name: 'advanced-sound-engine',\r\n          title: 'Advanced Sound Engine',\r\n          icon: 'fas fa-music',\r\n          visible: true,\r\n          tools: aseTools\r\n        });\r\n        console.log('ASE | Created dedicated control group');\r\n      }\r\n    } else {\r\n      console.warn('ASE | Unknown controls structure:', controls);\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('ASE | Failed to initialize scene controls:', error);\r\n  }\r\n});\r\n\r\n// Manually bind click listeners in case standard onClick fails (V13 compat)\r\nHooks.on('renderSceneControls', (controls: any, html: any) => {\r\n  try {\r\n    // Detect if html is jQuery or native Element\r\n    // In V13+, hooks might return native HTMLElements.\r\n    // jQuery objects have a .jquery property or .find method.\r\n\r\n    const findElement = (selector: string): HTMLElement | null => {\r\n      if (typeof html.find === 'function') {\r\n        const el = html.find(selector);\r\n        return el.length ? el[0] : null;\r\n      } else if (html instanceof HTMLElement) {\r\n        return html.querySelector(selector);\r\n      } else if (html.length && html[0] instanceof HTMLElement) {\r\n        // Maybe an array of elements or jQuery-like structure without .find?\r\n        // Unlikely for renderSceneControls which usually passes the container, but possible.\r\n        return (html[0] as HTMLElement).querySelector(selector) ?? null;\r\n      }\r\n      return null;\r\n    };\r\n\r\n    const mixerBtn = findElement('[data-tool=\"ase-open-mixer\"]');\r\n    if (mixerBtn) {\r\n      // Use native events for maximum compatibility\r\n      mixerBtn.onclick = (event: any) => {\r\n        event.preventDefault();\r\n        event.stopPropagation();\r\n        console.log('ASE | Manual click handler (native): Open Mixer');\r\n        window.ASE?.openPanel();\r\n      };\r\n      console.log('ASE | Bound manual click listener to mixer button');\r\n    }\r\n\r\n    const libraryBtn = findElement('[data-tool=\"ase-open-library\"]');\r\n    if (libraryBtn) {\r\n      // Use native events for maximum compatibility\r\n      libraryBtn.onclick = (event: any) => {\r\n        event.preventDefault();\r\n        event.stopPropagation();\r\n        console.log('ASE | Manual click handler (native): Open Library');\r\n        window.ASE?.openLibrary?.();\r\n      };\r\n      console.log('ASE | Bound manual click listener to library button');\r\n    }\r\n  } catch (error) {\r\n    console.warn('ASE | Failed to bind manual click listeners:', error);\r\n  }\r\n});\r\n// ─────────────────────────────────────────────────────────────\r\n// Initialization\r\n// ─────────────────────────────────────────────────────────────\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// Handlebars Helpers\r\n// ─────────────────────────────────────────────────────────────\r\n\r\nfunction registerHandlebarsHelpers(): void {\r\n  // Format duration from seconds to MM:SS\r\n  Handlebars.registerHelper('formatDuration', (seconds: number): string => {\r\n    if (!seconds || seconds <= 0) return '--:--';\r\n\r\n    const minutes = Math.floor(seconds / 60);\r\n    const secs = Math.floor(seconds % 60);\r\n    return `${minutes}:${secs.toString().padStart(2, '0')}`;\r\n  });\r\n\r\n  // Check equality (for {{#if (eq a b)}})\r\n  Handlebars.registerHelper('eq', (a: any, b: any): boolean => {\r\n    return a === b;\r\n  });\r\n}\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// Init Hooks\r\n// ─────────────────────────────────────────────────────────────\r\n\r\nHooks.once('init', () => {\r\n  Logger.info('Initializing Advanced Sound Engine...');\r\n  registerSettings();\r\n  registerHandlebarsHelpers();\r\n});\r\n\r\nHooks.once('ready', async () => {\r\n  const isGM = game.user?.isGM ?? false;\r\n  Logger.info(`Starting Advanced Sound Engine (${isGM ? 'GM' : 'Player'})...`);\r\n\r\n  socketManager = new SocketManager();\r\n\r\n  if (isGM) {\r\n    await initializeGM();\r\n  } else {\r\n    await initializePlayer();\r\n  }\r\n\r\n  // Initialize queue manager (runtime, no persistence)\r\n  const queueManager = new PlaybackQueueManager();\r\n\r\n  window.ASE = {\r\n    isGM,\r\n    openPanel: isGM ? openMainApp : openVolumePanel,\r\n    openLibrary: () => isGM && openMainApp('library'),\r\n    engine: isGM ? gmEngine ?? undefined : playerEngine ?? undefined,\r\n    socket: socketManager ?? undefined,\r\n    library: isGM ? libraryManager ?? undefined : undefined,\r\n    queue: queueManager\r\n  };\r\n\r\n  setupAutoplayHandler();\r\n\r\n  Logger.info('Advanced Sound Engine ready');\r\n});\r\n\r\nasync function initializeGM(): Promise<void> {\r\n  libraryManager = new LibraryManager();\r\n  gmEngine = new AudioEngine();\r\n  socketManager!.initializeAsGM(gmEngine);\r\n\r\n  await gmEngine.loadSavedState();\r\n}\r\n\r\nasync function initializePlayer(): Promise<void> {\r\n  playerEngine = new PlayerAudioEngine();\r\n  socketManager!.initializeAsPlayer(playerEngine);\r\n\r\n  // Restore saved local volume\r\n  const savedVolume = PlayerVolumePanel.loadSavedVolume();\r\n  playerEngine.setLocalVolume(savedVolume);\r\n}\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// Panels\r\n// ─────────────────────────────────────────────────────────────\r\n// Open main app with specific tab\r\nfunction openMainApp(tab?: string, forceRender: boolean = false): void {\r\n  if (!gmEngine || !socketManager || !libraryManager) return;\r\n\r\n  if (mainApp && mainApp.rendered) {\r\n    if (tab && mainApp.state.activeTab !== tab) {\r\n      mainApp.state.activeTab = tab as any;\r\n      forceRender = true;\r\n    }\r\n\r\n    if (forceRender) {\r\n      mainApp.render(false); // Re-render content, keep window position\r\n    } else {\r\n      mainApp.bringToTop();\r\n    }\r\n  } else {\r\n    mainApp = new AdvancedSoundEngineApp(gmEngine, socketManager, libraryManager);\r\n    if (tab) mainApp.state.activeTab = tab as any;\r\n    mainApp.render(true);\r\n  }\r\n}\r\n\r\nfunction openVolumePanel(): void {\r\n  if (!playerEngine) return;\r\n\r\n  if (volumePanel && volumePanel.rendered) {\r\n    volumePanel.bringToTop();\r\n  } else {\r\n    volumePanel = new PlayerVolumePanel(playerEngine);\r\n    volumePanel.render(true);\r\n  }\r\n}\r\n\r\n// Old openLibrary removed/redirected\r\nfunction openLibrary(): void {\r\n  openMainApp('library');\r\n}\r\n\r\n\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// Autoplay Policy Handler\r\n// ─────────────────────────────────────────────────────────────\r\n\r\nfunction setupAutoplayHandler(): void {\r\n  const resumeAudio = () => {\r\n    gmEngine?.resume();\r\n    playerEngine?.resume();\r\n  };\r\n\r\n  document.addEventListener('click', resumeAudio, { once: true });\r\n  document.addEventListener('keydown', resumeAudio, { once: true });\r\n\r\n  Hooks.once('canvasReady', resumeAudio);\r\n}\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// Settings\r\n// ─────────────────────────────────────────────────────────────\r\n\r\nfunction registerSettings(): void {\r\n  game.settings.register(MODULE_ID as any, 'mixerState', {\r\n    name: 'Mixer State',\r\n    hint: 'Internal storage for mixer state',\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: ''\r\n  });\r\n\r\n  game.settings.register(MODULE_ID as any, 'maxSimultaneousTracks', {\r\n    name: 'Maximum Simultaneous Tracks',\r\n    hint: 'Maximum number of tracks that can play simultaneously (1-32)',\r\n    scope: 'world',\r\n    config: true,\r\n    type: Number,\r\n    default: 16,\r\n    range: {\r\n      min: 1,\r\n      max: 32,\r\n      step: 1\r\n    }\r\n  });\r\n\r\n  game.settings.register(MODULE_ID as any, 'libraryState', {\r\n    name: 'Library State',\r\n    hint: 'Internal storage for library items and playlists',\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: ''\r\n  });\r\n}\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// Cleanup\r\n// ─────────────────────────────────────────────────────────────\r\n\r\nHooks.once('closeGame' as any, () => {\r\n  mainApp?.close();\r\n  volumePanel?.close();\r\n  socketManager?.dispose();\r\n  gmEngine?.dispose();\r\n  playerEngine?.dispose();\r\n  libraryManager?.dispose();\r\n});"],"names":["PREFIX","Logger","message","args","_a","StreamingPlayer","id","ctx","channelOutput","group","__publicField","e","url","resolve","reject","onCanPlay","onError","offset","error","time","safeTime","value","newGroup","newOutput","getServerTime","formatTime","seconds","mins","secs","generateUUID","c","r","SUPPORTED_AUDIO_FORMATS","AUDIO_MIME_TYPES","isValidAudioFormat","extension","getFileExtension","match","getAudioMimeType","validateAudioFile","mimeType","MODULE_ID","getMaxSimultaneous","AudioEngine","state","savedJson","config","trackId","validation","player","maxSimultaneous","playingCount","t","volume","loop","channel","tracks","trackState","stateTrackIds","PlayerAudioEngine","safeValue","volumes","payload","elapsed","adjustedOffset","isPlaying","seekTimestamp","newTrackIds","adjustedTime","SOCKET_NAME","SocketManager","engine","enabled","startPayload","statePayload","playPayload","pausePayload","stopPayload","seekPayload","volPayload","loopPayload","chVolPayload","type","targetUserId","now","userId","pausedAt","PlayerVolumePanel","options","html","event","saved","LocalLibraryApp","library","parentApp","force","items","playlists","allTags","stats","favorites","entry","_b","_c","_d","inQueue","q","item","playlist","f","tagSet","tags","tag","normalizedTag","isSelected","playlistsViewData","p","allChannelsSelected","hasActiveFilters","durationFormatted","lowerTags","filtered","query","playlistItemIds","i","selectedTagsArray","sorted","b","path","selectedTags","errorMessage","itemId","isFavorite","name","playlistId","btn","sortValue","menuHtml","menu","rawTagName","tagName","header","oldTag","newTag","count","tagStr","current","selectedPlaylistId","trackElement","contextMenuEvent","favoriteId","favoriteType","_e","playlistItems","pItem","currentGroup","channels","ch","rect","newChannel","isInPlaylist","dialogData","deleteLabel","newName","currentTags","content","_","el","title","label","defaultValue","playlistElement","draggedPlaylistId","midY","isAbove","draggedId","draggedType","files","targetId","draggedIndex","targetIndex","dragged","targetType","draggedItem","audioFiles","file","ext","targetSource","targetDir","err","importedCount","failedCount","response","track","playlistMsg","filename","lowerName","keyword","dropZone","dragData","_f","_g","sound","audioPath","soundName","newTrack","playlistName","asePlaylist","addedCount","skippedCount","foundryChannel","effectiveChannel","channelStr","baseName","existingPlaylists","existingNames","counter","target","tagsString","newTags","description","a","playlistItem","index","libraryItem","oldTagName","newTagName","updatedTags","throttle","fn","delay","lastCall","timeoutId","remaining","debounce","SoundMixerApp","socket","currentTime","duration","parts","throttledChannelBroadcast","throttledVolumeBroadcast","throttledSeek","indicator","trackEl","progress","seekSlider","totalTracks","AdvancedSoundEngineApp","libraryManager","getChannelStatus","isPaused","status","tabContent","libData","mixerData","trackScroll","tabName","input","PlaylistManager","onChangeCallback","updates","existing","updated","orderedIds","newMap","libraryItemId","playlistItemId","initialLength","removed","totalRemoved","newOrder","itemIndex","playlistsData","sum","LIBRARY_VERSION","LibraryManager","itemName","existingByUrl","audio","existingByName","lowerQuery","validFavorites","inOrderSet","orderedItems","missing","updatedCount","batchSize","batch","cleanup","playlistStats","PlaybackQueueManager","added","queueItem","queueItemId","currentIndex","toRemove","callback","data","cb","gmEngine","mainApp","playerEngine","volumePanel","socketManager","controls","isGM","aseTools","soundsLayer","findElement","selector","mixerBtn","libraryBtn","registerHandlebarsHelpers","minutes","registerSettings","initializeGM","initializePlayer","queueManager","openMainApp","openVolumePanel","setupAutoplayHandler","savedVolume","tab","forceRender","resumeAudio"],"mappings":"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"}