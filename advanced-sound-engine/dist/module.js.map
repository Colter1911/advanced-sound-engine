{"version":3,"file":"module.js","sources":["../src/utils/logger.ts","../src/core/StreamingPlayer.ts","../src/utils/time.ts","../src/utils/uuid.ts","../src/utils/audio-validation.ts","../src/core/AudioEngine.ts","../src/core/PlayerAudioEngine.ts","../src/sync/SocketManager.ts","../src/ui/PlayerVolumePanel.ts","../src/ui/LocalLibraryApp.ts","../src/utils/throttle.ts","../src/ui/SoundMixerApp.ts","../src/ui/AdvancedSoundEngineApp.ts","../src/library/PlaylistManager.ts","../src/library/LibraryManager.ts","../src/module.ts"],"sourcesContent":["const PREFIX = 'ASE';\r\n\r\nexport const Logger = {\r\n  info: (message: string, ...args: unknown[]) => {\r\n    console.log(`${PREFIX} | ${message}`, ...args);\r\n  },\r\n  \r\n  warn: (message: string, ...args: unknown[]) => {\r\n    console.warn(`${PREFIX} | ${message}`, ...args);\r\n  },\r\n  \r\n  error: (message: string, ...args: unknown[]) => {\r\n    console.error(`${PREFIX} | ${message}`, ...args);\r\n  },\r\n  \r\n  debug: (message: string, ...args: unknown[]) => {\r\n    if (CONFIG?.debug?.audio) {\r\n      console.debug(`${PREFIX} | ${message}`, ...args);\r\n    }\r\n  }\r\n};","import type { TrackGroup, PlaybackState } from '@t/audio';\r\nimport { Logger } from '@utils/logger';\r\n\r\nexport class StreamingPlayer {\r\n  readonly id: string;\r\n  private ctx: AudioContext;\r\n  private _group: TrackGroup;\r\n  private _url: string = '';\r\n  \r\n  private audio: HTMLAudioElement;\r\n  private sourceNode: MediaElementAudioSourceNode | null = null;\r\n  private gainNode: GainNode;\r\n  private outputNode: GainNode;\r\n  \r\n  private _state: PlaybackState = 'stopped';\r\n  private _volume: number = 1;\r\n  private _loop: boolean = false;\r\n  private _ready: boolean = false;\r\n\r\n  constructor(\r\n    id: string,\r\n    ctx: AudioContext,\r\n    channelOutput: GainNode,\r\n    group: TrackGroup = 'music'\r\n  ) {\r\n    this.id = id;\r\n    this.ctx = ctx;\r\n    this._group = group;\r\n    \r\n    this.audio = new Audio();\r\n    this.audio.crossOrigin = 'anonymous';\r\n    this.audio.preload = 'auto';\r\n    \r\n    this.gainNode = ctx.createGain();\r\n    this.outputNode = ctx.createGain();\r\n    \r\n    this.gainNode.connect(this.outputNode);\r\n    this.outputNode.connect(channelOutput);\r\n    \r\n    this.setupAudioEvents();\r\n  }\r\n\r\n  private setupAudioEvents(): void {\r\n    this.audio.addEventListener('canplay', () => {\r\n      this._ready = true;\r\n      if (this._state === 'loading') {\r\n        this._state = 'stopped';\r\n      }\r\n      Logger.debug(`Track ${this.id} ready to play`);\r\n    });\r\n\r\n    this.audio.addEventListener('ended', () => {\r\n      if (!this._loop) {\r\n        this._state = 'stopped';\r\n        Logger.debug(`Track ${this.id} ended`);\r\n      }\r\n    });\r\n\r\n    this.audio.addEventListener('error', (e) => {\r\n      Logger.error(`Track ${this.id} error:`, this.audio.error);\r\n      this._state = 'stopped';\r\n    });\r\n  }\r\n\r\n  get state(): PlaybackState {\r\n    return this._state;\r\n  }\r\n\r\n  get group(): TrackGroup {\r\n    return this._group;\r\n  }\r\n\r\n  get url(): string {\r\n    return this._url;\r\n  }\r\n\r\n  get volume(): number {\r\n    return this._volume;\r\n  }\r\n\r\n  get loop(): boolean {\r\n    return this._loop;\r\n  }\r\n\r\n  get ready(): boolean {\r\n    return this._ready;\r\n  }\r\n\r\n  async load(url: string): Promise<void> {\r\n    this._state = 'loading';\r\n    this._url = url;\r\n    this._ready = false;\r\n\r\n    return new Promise((resolve, reject) => {\r\n      const onCanPlay = () => {\r\n        this.audio.removeEventListener('canplay', onCanPlay);\r\n        this.audio.removeEventListener('error', onError);\r\n        \r\n        // Connect to Web Audio\r\n        if (!this.sourceNode) {\r\n          this.sourceNode = this.ctx.createMediaElementSource(this.audio);\r\n          this.sourceNode.connect(this.gainNode);\r\n        }\r\n        \r\n        this._ready = true;\r\n        this._state = 'stopped';\r\n        Logger.debug(`Track loaded: ${this.id}`);\r\n        resolve();\r\n      };\r\n\r\n      const onError = () => {\r\n        this.audio.removeEventListener('canplay', onCanPlay);\r\n        this.audio.removeEventListener('error', onError);\r\n        this._state = 'stopped';\r\n        reject(new Error(`Failed to load: ${url}`));\r\n      };\r\n\r\n      this.audio.addEventListener('canplay', onCanPlay, { once: true });\r\n      this.audio.addEventListener('error', onError, { once: true });\r\n      \r\n      this.audio.src = url;\r\n      this.audio.load();\r\n    });\r\n  }\r\n\r\n  async play(offset: number = 0): Promise<void> {\r\n    if (!this._ready) {\r\n      Logger.warn(`Track ${this.id} not ready`);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      this.audio.currentTime = Math.max(0, Math.min(offset, this.audio.duration || 0));\r\n      this.audio.loop = this._loop;\r\n      await this.audio.play();\r\n      this._state = 'playing';\r\n      Logger.debug(`Track ${this.id} playing from ${offset.toFixed(2)}s`);\r\n    } catch (error) {\r\n      Logger.error(`Failed to play ${this.id}:`, error);\r\n    }\r\n  }\r\n\r\n  pause(): void {\r\n    if (this._state !== 'playing') return;\r\n    \r\n    this.audio.pause();\r\n    this._state = 'paused';\r\n    Logger.debug(`Track ${this.id} paused at ${this.audio.currentTime.toFixed(2)}s`);\r\n  }\r\n\r\n  stop(): void {\r\n    this.audio.pause();\r\n    this.audio.currentTime = 0;\r\n    this._state = 'stopped';\r\n    Logger.debug(`Track ${this.id} stopped`);\r\n  }\r\n\r\n  seek(time: number): void {\r\n    const safeTime = Math.max(0, Math.min(time, this.audio.duration || 0));\r\n    this.audio.currentTime = safeTime;\r\n  }\r\n\r\n  setVolume(value: number): void {\r\n    this._volume = Math.max(0, Math.min(1, value));\r\n    this.gainNode.gain.setValueAtTime(this._volume, this.ctx.currentTime);\r\n  }\r\n\r\n  setLoop(value: boolean): void {\r\n    this._loop = value;\r\n    this.audio.loop = value;\r\n  }\r\n\r\n  setChannel(newGroup: TrackGroup, newOutput: GainNode): void {\r\n    this._group = newGroup;\r\n    this.outputNode.disconnect();\r\n    this.outputNode.connect(newOutput);\r\n  }\r\n\r\n  getCurrentTime(): number {\r\n    return this.audio.currentTime;\r\n  }\r\n\r\n  getDuration(): number {\r\n    return this.audio.duration || 0;\r\n  }\r\n\r\n  getState() {\r\n    return {\r\n      id: this.id,\r\n      url: this._url,\r\n      group: this._group,\r\n      playbackState: this._state,\r\n      volume: this._volume,\r\n      loop: this._loop,\r\n      currentTime: this.getCurrentTime(),\r\n      duration: this.getDuration()\r\n    };\r\n  }\r\n\r\n  dispose(): void {\r\n    this.audio.pause();\r\n    this.audio.src = '';\r\n    this.sourceNode?.disconnect();\r\n    this.gainNode.disconnect();\r\n    this.outputNode.disconnect();\r\n    Logger.debug(`Track ${this.id} disposed`);\r\n  }\r\n}","/**\r\n * Get current server time (for sync calculations)\r\n */\r\nexport function getServerTime(): number {\r\n  // Foundry's game.time.serverTime учитывает offset\r\n  return Date.now();\r\n}\r\n\r\n/**\r\n * Calculate playback offset based on start time\r\n */\r\nexport function calculateOffset(startedAt: number, pausedAt: number = 0): number {\r\n  if (pausedAt > 0) {\r\n    return pausedAt;\r\n  }\r\n  return (getServerTime() - startedAt) / 1000;\r\n}\r\n\r\n/**\r\n * Format seconds to mm:ss\r\n */\r\nexport function formatTime(seconds: number): string {\r\n  if (!isFinite(seconds) || seconds < 0) return '0:00';\r\n  \r\n  const mins = Math.floor(seconds / 60);\r\n  const secs = Math.floor(seconds % 60);\r\n  return `${mins}:${secs.toString().padStart(2, '0')}`;\r\n}","/**\r\n * Generate a UUID v4\r\n * Based on RFC 4122 standard\r\n */\r\nexport function generateUUID(): string {\r\n  // Use crypto.randomUUID if available (modern browsers/Node 19+)\r\n  if (typeof crypto !== 'undefined' && crypto.randomUUID) {\r\n    return crypto.randomUUID();\r\n  }\r\n\r\n  // Fallback: manual UUID v4 generation\r\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {\r\n    const r = Math.random() * 16 | 0;\r\n    const v = c === 'x' ? r : (r & 0x3 | 0x8);\r\n    return v.toString(16);\r\n  });\r\n}\r\n\r\n/**\r\n * Validate UUID format\r\n */\r\nexport function isValidUUID(uuid: string): boolean {\r\n  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;\r\n  return uuidRegex.test(uuid);\r\n}\r\n","/**\r\n * Поддерживаемые аудио форматы\r\n */\r\nexport const SUPPORTED_AUDIO_FORMATS = [\r\n  '.mp3',\r\n  '.ogg',\r\n  '.wav',\r\n  '.webm',\r\n  '.m4a',\r\n  '.aac',\r\n  '.flac',\r\n  '.opus'\r\n] as const;\r\n\r\nexport type SupportedAudioFormat = typeof SUPPORTED_AUDIO_FORMATS[number];\r\n\r\n/**\r\n * MIME типы для поддерживаемых форматов\r\n */\r\nexport const AUDIO_MIME_TYPES: Record<string, string> = {\r\n  '.mp3': 'audio/mpeg',\r\n  '.ogg': 'audio/ogg',\r\n  '.wav': 'audio/wav',\r\n  '.webm': 'audio/webm',\r\n  '.m4a': 'audio/mp4',\r\n  '.aac': 'audio/aac',\r\n  '.flac': 'audio/flac',\r\n  '.opus': 'audio/opus'\r\n};\r\n\r\n/**\r\n * Проверка, является ли файл поддерживаемым аудио форматом\r\n */\r\nexport function isValidAudioFormat(url: string): boolean {\r\n  const extension = getFileExtension(url);\r\n  return SUPPORTED_AUDIO_FORMATS.includes(extension as SupportedAudioFormat);\r\n}\r\n\r\n/**\r\n * Получить расширение файла из URL\r\n */\r\nexport function getFileExtension(url: string): string {\r\n  try {\r\n    // Decode URL first\r\n    const decoded = decodeURIComponent(url);\r\n\r\n    // Remove query parameters and hash\r\n    const cleanUrl = decoded.split('?')[0].split('#')[0];\r\n\r\n    // Extract extension\r\n    const match = cleanUrl.match(/\\.([a-z0-9]+)$/i);\r\n    return match ? `.${match[1].toLowerCase()}` : '';\r\n  } catch {\r\n    return '';\r\n  }\r\n}\r\n\r\n/**\r\n * Получить MIME тип для аудио файла\r\n */\r\nexport function getAudioMimeType(url: string): string | null {\r\n  const extension = getFileExtension(url);\r\n  return AUDIO_MIME_TYPES[extension] || null;\r\n}\r\n\r\n/**\r\n * Валидация результата с деталями ошибки\r\n */\r\nexport interface AudioValidationResult {\r\n  valid: boolean;\r\n  error?: string;\r\n  extension?: string;\r\n  mimeType?: string;\r\n}\r\n\r\n/**\r\n * Полная валидация аудио файла\r\n */\r\nexport function validateAudioFile(url: string): AudioValidationResult {\r\n  if (!url || typeof url !== 'string') {\r\n    return {\r\n      valid: false,\r\n      error: 'URL is required and must be a string'\r\n    };\r\n  }\r\n\r\n  const extension = getFileExtension(url);\r\n\r\n  if (!extension) {\r\n    return {\r\n      valid: false,\r\n      error: 'Could not extract file extension from URL'\r\n    };\r\n  }\r\n\r\n  if (!isValidAudioFormat(url)) {\r\n    return {\r\n      valid: false,\r\n      error: `Unsupported audio format: ${extension}. Supported formats: ${SUPPORTED_AUDIO_FORMATS.join(', ')}`,\r\n      extension\r\n    };\r\n  }\r\n\r\n  const mimeType = getAudioMimeType(url);\r\n\r\n  return {\r\n    valid: true,\r\n    extension,\r\n    mimeType: mimeType || undefined\r\n  };\r\n}\r\n\r\n/**\r\n * Проверка поддержки формата браузером\r\n */\r\nexport function isBrowserAudioSupported(extension: string): boolean {\r\n  if (typeof Audio === 'undefined') {\r\n    return false;\r\n  }\r\n\r\n  const mimeType = AUDIO_MIME_TYPES[extension];\r\n  if (!mimeType) {\r\n    return false;\r\n  }\r\n\r\n  const audio = new Audio();\r\n  const canPlay = audio.canPlayType(mimeType);\r\n\r\n  // Returns: '' (no support), 'maybe', 'probably'\r\n  return canPlay === 'probably' || canPlay === 'maybe';\r\n}\r\n","import type { TrackConfig, TrackState, MixerState, TrackGroup, ChannelVolumes } from '@t/audio';\r\nimport { StreamingPlayer } from './StreamingPlayer';\r\nimport { Logger } from '@utils/logger';\r\nimport { getServerTime } from '@utils/time';\r\nimport { generateUUID } from '@utils/uuid';\r\nimport { validateAudioFile } from '@utils/audio-validation';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\n\r\nfunction getMaxSimultaneous(): number {\r\n  return (game.settings.get(MODULE_ID, 'maxSimultaneousTracks') as number) || 8;\r\n}\r\n\r\nexport class AudioEngine {\r\n  private ctx: AudioContext;\r\n  private masterGain: GainNode;\r\n  private channelGains: Record<TrackGroup, GainNode>;\r\n  private players: Map<string, StreamingPlayer> = new Map();\r\n  \r\n  private _volumes: ChannelVolumes = {\r\n    master: 1,\r\n    music: 1,\r\n    ambience: 1,\r\n    sfx: 1\r\n  };\r\n  \r\n  private saveTimeout: ReturnType<typeof setTimeout> | null = null;\r\n\r\n  constructor() {\r\n    this.ctx = new AudioContext();\r\n    \r\n    this.masterGain = this.ctx.createGain();\r\n    this.masterGain.connect(this.ctx.destination);\r\n    \r\n    this.channelGains = {\r\n      music: this.ctx.createGain(),\r\n      ambience: this.ctx.createGain(),\r\n      sfx: this.ctx.createGain()\r\n    };\r\n    \r\n    this.channelGains.music.connect(this.masterGain);\r\n    this.channelGains.ambience.connect(this.masterGain);\r\n    this.channelGains.sfx.connect(this.masterGain);\r\n    \r\n    Logger.info('AudioEngine initialized');\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Persistence (GM only)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private scheduleSave(): void {\r\n    if (!game.user?.isGM) return;\r\n    \r\n    if (this.saveTimeout) {\r\n      clearTimeout(this.saveTimeout);\r\n    }\r\n    this.saveTimeout = setTimeout(() => {\r\n      this.saveState();\r\n    }, 500);\r\n  }\r\n\r\n  private async saveState(): Promise<void> {\r\n    if (!game.ready || !game.user?.isGM) return;\r\n    \r\n    const state = this.getState();\r\n    \r\n    try {\r\n      await game.settings.set(MODULE_ID, 'mixerState', JSON.stringify(state));\r\n      Logger.debug('Mixer state saved');\r\n    } catch (error) {\r\n      Logger.error('Failed to save mixer state:', error);\r\n    }\r\n  }\r\n\r\n  async loadSavedState(): Promise<void> {\r\n    if (!game.ready) return;\r\n    \r\n    try {\r\n      const savedJson = game.settings.get(MODULE_ID, 'mixerState') as string;\r\n      if (!savedJson) return;\r\n      \r\n      const state = JSON.parse(savedJson) as MixerState;\r\n      await this.restoreState(state);\r\n      \r\n      Logger.info('Mixer state restored');\r\n    } catch (error) {\r\n      Logger.error('Failed to load mixer state:', error);\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Track Management\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  async createTrack(config: TrackConfig): Promise<StreamingPlayer> {\r\n    // Generate UUID if not provided\r\n    const trackId = config.id || generateUUID();\r\n\r\n    if (this.players.has(trackId)) {\r\n      return this.players.get(trackId)!;\r\n    }\r\n\r\n    // Validate audio file format\r\n    const validation = validateAudioFile(config.url);\r\n    if (!validation.valid) {\r\n      const error = new Error(validation.error || 'Invalid audio file');\r\n      Logger.error(`Track validation failed: ${validation.error}`);\r\n      throw error;\r\n    }\r\n\r\n    const channelOutput = this.channelGains[config.group];\r\n\r\n    const player = new StreamingPlayer(\r\n      trackId,\r\n      this.ctx,\r\n      channelOutput,\r\n      config.group\r\n    );\r\n\r\n    if (config.volume !== undefined) {\r\n      player.setVolume(config.volume);\r\n    }\r\n    if (config.loop !== undefined) {\r\n      player.setLoop(config.loop);\r\n    }\r\n\r\n    await player.load(config.url);\r\n\r\n    this.players.set(trackId, player);\r\n    this.scheduleSave();\r\n\r\n    Logger.info(`Track created: ${trackId} (${validation.extension})`);\r\n    return player;\r\n  }\r\n\r\n  getTrack(id: string): StreamingPlayer | undefined {\r\n    return this.players.get(id);\r\n  }\r\n\r\n  removeTrack(id: string): boolean {\r\n    const player = this.players.get(id);\r\n    if (!player) return false;\r\n\r\n    player.dispose();\r\n    this.players.delete(id);\r\n    this.scheduleSave();\r\n    \r\n    Logger.info(`Track removed: ${id}`);\r\n    return true;\r\n  }\r\n\r\n  getAllTracks(): StreamingPlayer[] {\r\n    return Array.from(this.players.values());\r\n  }\r\n\r\n  getTracksByGroup(group: TrackGroup): StreamingPlayer[] {\r\n    return this.getAllTracks().filter(t => t.group === group);\r\n  }\r\n\r\n  setTrackChannel(id: string, newGroup: TrackGroup): void {\r\n    const player = this.players.get(id);\r\n    if (!player) return;\r\n    \r\n    player.setChannel(newGroup, this.channelGains[newGroup]);\r\n    this.scheduleSave();\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Playback Control\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  async playTrack(id: string, offset: number = 0): Promise<void> {\r\n    const player = this.players.get(id);\r\n    if (!player) {\r\n      Logger.warn(`Track not found: ${id}`);\r\n      return;\r\n    }\r\n\r\n    const maxSimultaneous = getMaxSimultaneous();\r\n    const playingCount = this.getAllTracks().filter(t => t.state === 'playing').length;\r\n    const isCurrentlyPlaying = player.state === 'playing';\r\n\r\n    if (!isCurrentlyPlaying && playingCount >= maxSimultaneous) {\r\n      Logger.warn(`Maximum simultaneous tracks (${maxSimultaneous}) reached`);\r\n      ui.notifications?.warn(`Cannot play more than ${maxSimultaneous} tracks simultaneously`);\r\n      return;\r\n    }\r\n\r\n    await player.play(offset);\r\n  }\r\n\r\n  pauseTrack(id: string): void {\r\n    this.players.get(id)?.pause();\r\n  }\r\n\r\n  stopTrack(id: string): void {\r\n    this.players.get(id)?.stop();\r\n  }\r\n\r\n  seekTrack(id: string, time: number): void {\r\n    this.players.get(id)?.seek(time);\r\n  }\r\n\r\n  setTrackVolume(id: string, volume: number): void {\r\n    this.players.get(id)?.setVolume(volume);\r\n    this.scheduleSave();\r\n  }\r\n\r\n  setTrackLoop(id: string, loop: boolean): void {\r\n    this.players.get(id)?.setLoop(loop);\r\n    this.scheduleSave();\r\n  }\r\n\r\n  stopAll(): void {\r\n    for (const player of this.players.values()) {\r\n      player.stop();\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Volume Control\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  get volumes(): ChannelVolumes {\r\n    return { ...this._volumes };\r\n  }\r\n\r\n  setMasterVolume(value: number): void {\r\n    this._volumes.master = Math.max(0, Math.min(1, value));\r\n    this.masterGain.gain.linearRampToValueAtTime(\r\n      this._volumes.master,\r\n      this.ctx.currentTime + 0.01\r\n    );\r\n    this.scheduleSave();\r\n  }\r\n\r\n  setChannelVolume(channel: TrackGroup, value: number): void {\r\n    this._volumes[channel] = Math.max(0, Math.min(1, value));\r\n    this.channelGains[channel].gain.linearRampToValueAtTime(\r\n      this._volumes[channel],\r\n      this.ctx.currentTime + 0.01\r\n    );\r\n    this.scheduleSave();\r\n  }\r\n\r\n  getChannelVolume(channel: TrackGroup): number {\r\n    return this._volumes[channel];\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // State\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  getState(): MixerState {\r\n    const tracks: TrackState[] = [];\r\n    \r\n    for (const player of this.players.values()) {\r\n      tracks.push(player.getState());\r\n    }\r\n\r\n    return {\r\n      masterVolume: this._volumes.master,\r\n      channelVolumes: { ...this._volumes },\r\n      tracks,\r\n      timestamp: getServerTime(),\r\n      syncEnabled: false\r\n    };\r\n  }\r\n\r\n  async restoreState(state: MixerState): Promise<void> {\r\n    // Restore volumes\r\n    this._volumes.master = state.masterVolume;\r\n    this.masterGain.gain.setValueAtTime(this._volumes.master, this.ctx.currentTime);\r\n    \r\n    if (state.channelVolumes) {\r\n      for (const channel of ['music', 'ambience', 'sfx'] as TrackGroup[]) {\r\n        this._volumes[channel] = state.channelVolumes[channel];\r\n        this.channelGains[channel].gain.setValueAtTime(this._volumes[channel], this.ctx.currentTime);\r\n      }\r\n    }\r\n\r\n    // Restore tracks (without playing)\r\n    for (const trackState of state.tracks) {\r\n      if (!this.players.has(trackState.id)) {\r\n        try {\r\n          await this.createTrack({\r\n            id: trackState.id,\r\n            url: trackState.url,\r\n            group: trackState.group,\r\n            volume: trackState.volume,\r\n            loop: trackState.loop\r\n          });\r\n        } catch (error) {\r\n          Logger.error(`Failed to restore track ${trackState.id}:`, error);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Remove tracks not in state\r\n    const stateTrackIds = new Set(state.tracks.map(t => t.id));\r\n    for (const [id] of this.players) {\r\n      if (!stateTrackIds.has(id)) {\r\n        this.removeTrack(id);\r\n      }\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Audio Context\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  async resume(): Promise<void> {\r\n    if (this.ctx.state === 'suspended') {\r\n      await this.ctx.resume();\r\n      Logger.info('AudioContext resumed');\r\n    }\r\n  }\r\n\r\n  get contextState(): AudioContextState {\r\n    return this.ctx.state;\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Cleanup\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  dispose(): void {\r\n    if (this.saveTimeout) {\r\n      clearTimeout(this.saveTimeout);\r\n    }\r\n    for (const player of this.players.values()) {\r\n      player.dispose();\r\n    }\r\n    this.players.clear();\r\n    this.ctx.close();\r\n    Logger.info('AudioEngine disposed');\r\n  }\r\n}","import type { TrackGroup, ChannelVolumes, SyncTrackState, TrackPlayPayload } from '@t/audio';\r\nimport { StreamingPlayer } from './StreamingPlayer';\r\nimport { Logger } from '@utils/logger';\r\nimport { getServerTime } from '@utils/time';\r\n\r\n/**\r\n * Упрощенный движок для игроков — только получает команды\r\n */\r\nexport class PlayerAudioEngine {\r\n  private ctx: AudioContext;\r\n  private masterGain: GainNode;\r\n  private gmGain: GainNode; // Громкость от GM\r\n  private channelGains: Record<TrackGroup, GainNode>;\r\n  private players: Map<string, StreamingPlayer> = new Map();\r\n  \r\n  private _localVolume: number = 1; // Личная громкость игрока\r\n  private _gmVolumes: ChannelVolumes = {\r\n    master: 1,\r\n    music: 1,\r\n    ambience: 1,\r\n    sfx: 1\r\n  };\r\n\r\n  constructor() {\r\n    this.ctx = new AudioContext();\r\n    \r\n    // Chain: tracks -> channels -> gmGain -> masterGain -> destination\r\n    this.masterGain = this.ctx.createGain();\r\n    this.masterGain.connect(this.ctx.destination);\r\n    \r\n    this.gmGain = this.ctx.createGain();\r\n    this.gmGain.connect(this.masterGain);\r\n    \r\n    this.channelGains = {\r\n      music: this.ctx.createGain(),\r\n      ambience: this.ctx.createGain(),\r\n      sfx: this.ctx.createGain()\r\n    };\r\n    \r\n    this.channelGains.music.connect(this.gmGain);\r\n    this.channelGains.ambience.connect(this.gmGain);\r\n    this.channelGains.sfx.connect(this.gmGain);\r\n    \r\n    Logger.info('PlayerAudioEngine initialized');\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Local Volume (Player's personal control)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  get localVolume(): number {\r\n    return this._localVolume;\r\n  }\r\n\r\n  setLocalVolume(value: number): void {\r\n    this._localVolume = Math.max(0, Math.min(1, value));\r\n    this.masterGain.gain.linearRampToValueAtTime(\r\n      this._localVolume,\r\n      this.ctx.currentTime + 0.01\r\n    );\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // GM Volume (from sync)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  setGMVolume(channel: TrackGroup | 'master', value: number): void {\r\n    const safeValue = Math.max(0, Math.min(1, value));\r\n    \r\n    if (channel === 'master') {\r\n      this._gmVolumes.master = safeValue;\r\n      this.gmGain.gain.linearRampToValueAtTime(safeValue, this.ctx.currentTime + 0.01);\r\n    } else {\r\n      this._gmVolumes[channel] = safeValue;\r\n      this.channelGains[channel].gain.linearRampToValueAtTime(safeValue, this.ctx.currentTime + 0.01);\r\n    }\r\n  }\r\n\r\n  setAllGMVolumes(volumes: ChannelVolumes): void {\r\n    this._gmVolumes = { ...volumes };\r\n    \r\n    this.gmGain.gain.setValueAtTime(volumes.master, this.ctx.currentTime);\r\n    this.channelGains.music.gain.setValueAtTime(volumes.music, this.ctx.currentTime);\r\n    this.channelGains.ambience.gain.setValueAtTime(volumes.ambience, this.ctx.currentTime);\r\n    this.channelGains.sfx.gain.setValueAtTime(volumes.sfx, this.ctx.currentTime);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Track Commands (from GM via socket)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  async handlePlay(payload: TrackPlayPayload): Promise<void> {\r\n    let player = this.players.get(payload.trackId);\r\n    \r\n    // Create if doesn't exist\r\n    if (!player) {\r\n      player = new StreamingPlayer(\r\n        payload.trackId,\r\n        this.ctx,\r\n        this.channelGains[payload.group],\r\n        payload.group\r\n      );\r\n      \r\n      await player.load(payload.url);\r\n      this.players.set(payload.trackId, player);\r\n    }\r\n    \r\n    player.setVolume(payload.volume);\r\n    player.setLoop(payload.loop);\r\n    \r\n    // Calculate offset based on time elapsed since GM started\r\n    const elapsed = (getServerTime() - payload.startTimestamp) / 1000;\r\n    const adjustedOffset = Math.max(0, payload.offset + elapsed);\r\n    \r\n    await player.play(adjustedOffset);\r\n    Logger.debug(`Player: track ${payload.trackId} playing at ${adjustedOffset.toFixed(2)}s`);\r\n  }\r\n\r\n  handlePause(trackId: string): void {\r\n    this.players.get(trackId)?.pause();\r\n  }\r\n\r\n  handleStop(trackId: string): void {\r\n    this.players.get(trackId)?.stop();\r\n  }\r\n\r\n  handleSeek(trackId: string, time: number, isPlaying: boolean, seekTimestamp: number): void {\r\n    const player = this.players.get(trackId);\r\n    if (!player) return;\r\n    \r\n    if (isPlaying) {\r\n      const elapsed = (getServerTime() - seekTimestamp) / 1000;\r\n      player.seek(time + elapsed);\r\n    } else {\r\n      player.seek(time);\r\n    }\r\n  }\r\n\r\n  handleTrackVolume(trackId: string, volume: number): void {\r\n    this.players.get(trackId)?.setVolume(volume);\r\n  }\r\n\r\n  handleTrackLoop(trackId: string, loop: boolean): void {\r\n    this.players.get(trackId)?.setLoop(loop);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Sync State (full state from GM)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  async syncState(tracks: SyncTrackState[], volumes: ChannelVolumes): Promise<void> {\r\n    // Set volumes\r\n    this.setAllGMVolumes(volumes);\r\n    \r\n    // Handle tracks\r\n    const newTrackIds = new Set(tracks.map(t => t.id));\r\n    \r\n    // Remove tracks not in sync\r\n    for (const [id, player] of this.players) {\r\n      if (!newTrackIds.has(id)) {\r\n        player.dispose();\r\n        this.players.delete(id);\r\n      }\r\n    }\r\n    \r\n    // Add/update tracks\r\n    for (const trackState of tracks) {\r\n      let player = this.players.get(trackState.id);\r\n      \r\n      if (!player) {\r\n        player = new StreamingPlayer(\r\n          trackState.id,\r\n          this.ctx,\r\n          this.channelGains[trackState.group],\r\n          trackState.group\r\n        );\r\n        \r\n        await player.load(trackState.url);\r\n        this.players.set(trackState.id, player);\r\n      }\r\n      \r\n      player.setVolume(trackState.volume);\r\n      player.setLoop(trackState.loop);\r\n      \r\n      if (trackState.isPlaying) {\r\n        const elapsed = (getServerTime() - trackState.startTimestamp) / 1000;\r\n        const adjustedTime = trackState.currentTime + elapsed;\r\n        await player.play(adjustedTime);\r\n      } else {\r\n        player.stop();\r\n      }\r\n    }\r\n    \r\n    Logger.info('Player: synced state from GM');\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Sync Off\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  stopAll(): void {\r\n    for (const player of this.players.values()) {\r\n      player.stop();\r\n    }\r\n  }\r\n\r\n  clearAll(): void {\r\n    for (const player of this.players.values()) {\r\n      player.dispose();\r\n    }\r\n    this.players.clear();\r\n    Logger.info('Player: all tracks cleared');\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Audio Context\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  async resume(): Promise<void> {\r\n    if (this.ctx.state === 'suspended') {\r\n      await this.ctx.resume();\r\n      Logger.info('PlayerAudioEngine: AudioContext resumed');\r\n    }\r\n  }\r\n\r\n  dispose(): void {\r\n    this.clearAll();\r\n    this.ctx.close();\r\n    Logger.info('PlayerAudioEngine disposed');\r\n  }\r\n}","import type { \r\n  SocketMessage, \r\n  SocketMessageType,\r\n  SyncStatePayload,\r\n  SyncTrackState,\r\n  TrackPlayPayload,\r\n  TrackPausePayload,\r\n  TrackStopPayload,\r\n  TrackSeekPayload,\r\n  TrackVolumePayload,\r\n  TrackLoopPayload,\r\n  ChannelVolumePayload,\r\n  TrackGroup,\r\n  ChannelVolumes\r\n} from '@t/audio';\r\nimport { AudioEngine } from '@core/AudioEngine';\r\nimport { PlayerAudioEngine } from '@core/PlayerAudioEngine';\r\nimport { Logger } from '@utils/logger';\r\nimport { getServerTime } from '@utils/time';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\nconst SOCKET_NAME = `module.${MODULE_ID}`;\r\n\r\nexport class SocketManager {\r\n  private gmEngine: AudioEngine | null = null;\r\n  private playerEngine: PlayerAudioEngine | null = null;\r\n  private socket: any = null;\r\n  private _syncEnabled: boolean = false;\r\n  private isGM: boolean = false;\r\n\r\n  constructor() {}\r\n\r\n  initializeAsGM(engine: AudioEngine): void {\r\n    this.isGM = true;\r\n    this.gmEngine = engine;\r\n    this.socket = game.socket;\r\n    \r\n    this.socket?.on(SOCKET_NAME, (message: SocketMessage) => {\r\n      this.handleGMMessage(message);\r\n    });\r\n    \r\n    Logger.info('SocketManager initialized as GM');\r\n  }\r\n\r\n  initializeAsPlayer(engine: PlayerAudioEngine): void {\r\n    this.isGM = false;\r\n    this.playerEngine = engine;\r\n    this.socket = game.socket;\r\n    \r\n    this.socket?.on(SOCKET_NAME, (message: SocketMessage) => {\r\n      this.handlePlayerMessage(message);\r\n    });\r\n    \r\n    // Request current state on join\r\n    setTimeout(() => {\r\n      this.send('player-ready', {});\r\n    }, 1000);\r\n    \r\n    Logger.info('SocketManager initialized as Player');\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Sync Mode (GM)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  get syncEnabled(): boolean {\r\n    return this._syncEnabled;\r\n  }\r\n\r\n  setSyncEnabled(enabled: boolean): void {\r\n    if (!this.isGM) return;\r\n    \r\n    this._syncEnabled = enabled;\r\n    \r\n    if (enabled) {\r\n      this.broadcastSyncStart();\r\n    } else {\r\n      this.broadcastSyncStop();\r\n    }\r\n    \r\n    Logger.info(`Sync mode: ${enabled ? 'ON' : 'OFF'}`);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // GM Message Handling\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private handleGMMessage(message: SocketMessage): void {\r\n    if (message.senderId === game.user?.id) return;\r\n    \r\n    if (message.type === 'player-ready' && this._syncEnabled) {\r\n      // Send current state to newly joined player\r\n      this.sendStateTo(message.senderId);\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Player Message Handling\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async handlePlayerMessage(message: SocketMessage): Promise<void> {\r\n    if (message.senderId === game.user?.id) return;\r\n    if (!this.playerEngine) return;\r\n    \r\n    Logger.debug(`Player received: ${message.type}`, message.payload);\r\n    \r\n    switch (message.type) {\r\n      case 'sync-start':\r\n        const startPayload = message.payload as SyncStatePayload;\r\n        await this.playerEngine.syncState(startPayload.tracks, startPayload.channelVolumes);\r\n        break;\r\n        \r\n      case 'sync-stop':\r\n        this.playerEngine.clearAll();\r\n        break;\r\n        \r\n      case 'sync-state':\r\n        const statePayload = message.payload as SyncStatePayload;\r\n        await this.playerEngine.syncState(statePayload.tracks, statePayload.channelVolumes);\r\n        break;\r\n        \r\n      case 'track-play':\r\n        const playPayload = message.payload as TrackPlayPayload;\r\n        await this.playerEngine.handlePlay(playPayload);\r\n        break;\r\n        \r\n      case 'track-pause':\r\n        const pausePayload = message.payload as TrackPausePayload;\r\n        this.playerEngine.handlePause(pausePayload.trackId);\r\n        break;\r\n        \r\n      case 'track-stop':\r\n        const stopPayload = message.payload as TrackStopPayload;\r\n        this.playerEngine.handleStop(stopPayload.trackId);\r\n        break;\r\n        \r\n      case 'track-seek':\r\n        const seekPayload = message.payload as TrackSeekPayload;\r\n        this.playerEngine.handleSeek(\r\n          seekPayload.trackId, \r\n          seekPayload.time, \r\n          seekPayload.isPlaying,\r\n          seekPayload.seekTimestamp\r\n        );\r\n        break;\r\n        \r\n      case 'track-volume':\r\n        const volPayload = message.payload as TrackVolumePayload;\r\n        this.playerEngine.handleTrackVolume(volPayload.trackId, volPayload.volume);\r\n        break;\r\n        \r\n      case 'track-loop':\r\n        const loopPayload = message.payload as TrackLoopPayload;\r\n        this.playerEngine.handleTrackLoop(loopPayload.trackId, loopPayload.loop);\r\n        break;\r\n        \r\n      case 'channel-volume':\r\n        const chVolPayload = message.payload as ChannelVolumePayload;\r\n        this.playerEngine.setGMVolume(chVolPayload.channel, chVolPayload.volume);\r\n        break;\r\n        \r\n      case 'stop-all':\r\n        this.playerEngine.stopAll();\r\n        break;\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // GM Broadcast Methods\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private send(type: SocketMessageType, payload: unknown, targetUserId?: string): void {\r\n    if (!this.socket) return;\r\n\r\n    const message: SocketMessage = {\r\n      type,\r\n      payload,\r\n      senderId: game.user?.id ?? '',\r\n      timestamp: getServerTime()\r\n    };\r\n\r\n    if (targetUserId) {\r\n      this.socket.emit(SOCKET_NAME, message, { recipients: [targetUserId] });\r\n    } else {\r\n      this.socket.emit(SOCKET_NAME, message);\r\n    }\r\n\r\n    Logger.debug(`Sent: ${type}`, payload);\r\n  }\r\n\r\n  private getCurrentSyncState(): SyncStatePayload {\r\n    if (!this.gmEngine) {\r\n      return { tracks: [], channelVolumes: { master: 1, music: 1, ambience: 1, sfx: 1 } };\r\n    }\r\n    \r\n    const now = getServerTime();\r\n    const tracks: SyncTrackState[] = [];\r\n    \r\n    for (const player of this.gmEngine.getAllTracks()) {\r\n      const state = player.getState();\r\n      tracks.push({\r\n        id: state.id,\r\n        url: state.url,\r\n        group: state.group,\r\n        volume: state.volume,\r\n        loop: state.loop,\r\n        isPlaying: state.playbackState === 'playing',\r\n        currentTime: player.getCurrentTime(),\r\n        startTimestamp: now\r\n      });\r\n    }\r\n    \r\n    return {\r\n      tracks,\r\n      channelVolumes: this.gmEngine.volumes\r\n    };\r\n  }\r\n\r\n  private broadcastSyncStart(): void {\r\n    const state = this.getCurrentSyncState();\r\n    this.send('sync-start', state);\r\n  }\r\n\r\n  private broadcastSyncStop(): void {\r\n    this.send('sync-stop', {});\r\n  }\r\n\r\n  private sendStateTo(userId: string): void {\r\n    const state = this.getCurrentSyncState();\r\n    this.send('sync-state', state, userId);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // GM Actions (called when GM interacts with mixer)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  broadcastTrackPlay(trackId: string, offset: number): void {\r\n    if (!this._syncEnabled || !this.gmEngine) return;\r\n    \r\n    const player = this.gmEngine.getTrack(trackId);\r\n    if (!player) return;\r\n    \r\n    const payload: TrackPlayPayload = {\r\n      trackId,\r\n      url: player.url,\r\n      group: player.group,\r\n      volume: player.volume,\r\n      loop: player.loop,\r\n      offset,\r\n      startTimestamp: getServerTime()\r\n    };\r\n    \r\n    this.send('track-play', payload);\r\n  }\r\n\r\n  broadcastTrackPause(trackId: string, pausedAt: number): void {\r\n    if (!this._syncEnabled) return;\r\n    \r\n    const payload: TrackPausePayload = { trackId, pausedAt };\r\n    this.send('track-pause', payload);\r\n  }\r\n\r\n  broadcastTrackStop(trackId: string): void {\r\n    if (!this._syncEnabled) return;\r\n    \r\n    const payload: TrackStopPayload = { trackId };\r\n    this.send('track-stop', payload);\r\n  }\r\n\r\n  broadcastTrackSeek(trackId: string, time: number, isPlaying: boolean): void {\r\n    if (!this._syncEnabled) return;\r\n    \r\n    const payload: TrackSeekPayload = {\r\n      trackId,\r\n      time,\r\n      isPlaying,\r\n      seekTimestamp: getServerTime()\r\n    };\r\n    this.send('track-seek', payload);\r\n  }\r\n\r\n  broadcastTrackVolume(trackId: string, volume: number): void {\r\n    if (!this._syncEnabled) return;\r\n    \r\n    const payload: TrackVolumePayload = { trackId, volume };\r\n    this.send('track-volume', payload);\r\n  }\r\n\r\n  broadcastTrackLoop(trackId: string, loop: boolean): void {\r\n    if (!this._syncEnabled) return;\r\n    \r\n    const payload: TrackLoopPayload = { trackId, loop };\r\n    this.send('track-loop', payload);\r\n  }\r\n\r\n  broadcastChannelVolume(channel: TrackGroup | 'master', volume: number): void {\r\n    if (!this._syncEnabled) return;\r\n    \r\n    const payload: ChannelVolumePayload = { channel, volume };\r\n    this.send('channel-volume', payload);\r\n  }\r\n\r\n  broadcastStopAll(): void {\r\n    if (!this._syncEnabled) return;\r\n    this.send('stop-all', {});\r\n  }\r\n\r\n  dispose(): void {\r\n    this.socket?.off(SOCKET_NAME);\r\n  }\r\n}","import { PlayerAudioEngine } from '@core/PlayerAudioEngine';\r\nimport { Logger } from '@utils/logger';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\n\r\nexport class PlayerVolumePanel extends Application {\r\n  private engine: PlayerAudioEngine;\r\n\r\n  static override get defaultOptions(): ApplicationOptions {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'ase-player-volume',\r\n      title: 'Sound Volume',\r\n      template: `modules/${MODULE_ID}/templates/player-volume.hbs`,\r\n      classes: ['ase-player-panel'],\r\n      width: 200,\r\n      height: 'auto',\r\n      resizable: false,\r\n      minimizable: true,\r\n      popOut: true\r\n    }) as ApplicationOptions;\r\n  }\r\n\r\n  constructor(engine: PlayerAudioEngine, options?: Partial<ApplicationOptions>) {\r\n    super(options);\r\n    this.engine = engine;\r\n  }\r\n\r\n  override getData() {\r\n    return {\r\n      volume: Math.round(this.engine.localVolume * 100)\r\n    };\r\n  }\r\n\r\n  override activateListeners(html: JQuery): void {\r\n    super.activateListeners(html);\r\n\r\n    html.find('.ase-volume-slider').on('input', (event) => {\r\n      const value = parseFloat((event.target as HTMLInputElement).value) / 100;\r\n      this.engine.setLocalVolume(value);\r\n      html.find('.ase-volume-value').text(`${Math.round(value * 100)}%`);\r\n      \r\n      // Save preference\r\n      this.saveVolume(value);\r\n    });\r\n  }\r\n\r\n  private saveVolume(value: number): void {\r\n    localStorage.setItem(`${MODULE_ID}-player-volume`, String(value));\r\n  }\r\n\r\n  static loadSavedVolume(): number {\r\n    const saved = localStorage.getItem(`${MODULE_ID}-player-volume`);\r\n    return saved ? parseFloat(saved) : 1;\r\n  }\r\n}","import type { LibraryItem, Playlist } from '@t/library';\r\nimport type { TrackGroup } from '@t/audio';\r\nimport { LibraryManager } from '@lib/LibraryManager';\r\nimport { Logger } from '@utils/logger';\r\nimport { formatTime } from '@utils/time';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\n\r\ninterface FilterState {\r\n  searchQuery: string;\r\n  selectedChannels: Set<TrackGroup>;\r\n  selectedPlaylistId: string | null;\r\n  selectedTags: Set<string>;\r\n  sortBy: 'name-asc' | 'name-desc' | 'date-asc' | 'date-desc' | 'duration-asc' | 'duration-desc';\r\n}\r\n\r\ninterface LibraryData {\r\n  items: LibraryItemViewData[];\r\n  playlists: PlaylistViewData[];\r\n  favorites: FavoriteViewData[];\r\n  tags: TagViewData[];\r\n  stats: {\r\n    totalItems: number;\r\n    favoriteItems: number;\r\n    playlists: number;\r\n    tagCount: number;\r\n  };\r\n  searchQuery: string;\r\n  filters: {\r\n    music: boolean;\r\n    ambience: boolean;\r\n    sfx: boolean;\r\n  };\r\n  selectedPlaylistId: string | null;\r\n  sortBy: string;\r\n  hasActiveFilters: boolean;\r\n}\r\n\r\ninterface TagViewData {\r\n  name: string;\r\n  selected: boolean;\r\n}\r\n\r\ninterface LibraryItemViewData {\r\n  id: string;\r\n  name: string;\r\n  url: string;\r\n  duration: string;\r\n  durationSeconds: number;\r\n  tags: string[];\r\n  favorite: boolean;\r\n  group: string;\r\n}\r\n\r\ninterface PlaylistViewData {\r\n  id: string;\r\n  name: string;\r\n  itemCount: number;\r\n  favorite: boolean;\r\n  selected?: boolean;\r\n}\r\n\r\ninterface FavoriteViewData {\r\n  id: string;\r\n  name: string;\r\n  type: 'track' | 'playlist';\r\n}\r\n\r\nexport class LocalLibraryApp extends Application {\r\n  private library: LibraryManager;\r\n  private filterState: FilterState;\r\n\r\n  static override get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'local-library',\r\n      template: 'modules/advanced-sound-engine/templates/library.hbs',\r\n      title: 'Sound Library',\r\n      width: 1100,\r\n      height: 700,\r\n      classes: ['advanced-sound-engine', 'library'],\r\n      resizable: true,\r\n      tabs: [{ navSelector: '.tabs', contentSelector: '.content', initial: 'library' }]\r\n    });\r\n  }\r\n\r\n  constructor(library: LibraryManager, options = {}) {\r\n    super(options);\r\n    this.library = library;\r\n    this.filterState = {\r\n      searchQuery: '',\r\n      selectedChannels: new Set(['music', 'ambience', 'sfx']), // Default all selected? Or none? User said \"Green for active\". Usually start with all or none. Let's start with all.\r\n      selectedPlaylistId: null,\r\n      selectedTags: new Set(),\r\n      sortBy: 'date-desc'\r\n    };\r\n  }\r\n\r\n  override getData(): LibraryData {\r\n    let items = this.library.getAllItems();\r\n    const playlists = this.library.playlists.getAllPlaylists();\r\n    const allTags = this.library.getAllTags();\r\n    const stats = this.library.getStats();\r\n\r\n    // Apply filters\r\n    items = this.applyFilters(items);\r\n\r\n    // Apply sorting\r\n    items = this.applySorting(items);\r\n\r\n    // Build favorites list (tracks + playlists)\r\n    const favoriteItems = this.library.getFavorites();\r\n    const favoritePlaylists = this.library.playlists.getFavoritePlaylists();\r\n    const favorites: FavoriteViewData[] = [\r\n      ...favoriteItems.map(item => ({\r\n        id: item.id,\r\n        name: item.name,\r\n        type: 'track' as const\r\n      })),\r\n      ...favoritePlaylists.map(playlist => ({\r\n        id: playlist.id,\r\n        name: playlist.name,\r\n        type: 'playlist' as const\r\n      }))\r\n    ];\r\n\r\n    // Build tags list with selection state\r\n    const tags: TagViewData[] = allTags.map(tag => ({\r\n      name: tag,\r\n      selected: this.filterState.selectedTags.has(tag)\r\n    }));\r\n\r\n    // Build playlists with selection state\r\n    const playlistsViewData = playlists.map(p => ({\r\n      ...this.getPlaylistViewData(p),\r\n      selected: p.id === this.filterState.selectedPlaylistId\r\n    }));\r\n\r\n    // Check if any filters are active (if NOT all channels are selected, or other filters exist)\r\n    const allChannelsSelected = this.filterState.selectedChannels.size === 3; // Assuming 3 channels\r\n    const hasActiveFilters = !!(\r\n      this.filterState.searchQuery ||\r\n      !allChannelsSelected ||\r\n      this.filterState.selectedPlaylistId ||\r\n      this.filterState.selectedTags.size > 0\r\n    );\r\n\r\n    return {\r\n      items: items.map(item => this.getItemViewData(item)),\r\n      playlists: playlistsViewData,\r\n      favorites,\r\n      tags,\r\n      stats: {\r\n        totalItems: stats.totalItems,\r\n        favoriteItems: stats.favoriteItems,\r\n        playlists: stats.playlists,\r\n        tagCount: stats.tagCount\r\n      },\r\n      // Filter state for UI\r\n      searchQuery: this.filterState.searchQuery,\r\n      filters: {\r\n        music: this.filterState.selectedChannels.has('music'),\r\n        ambience: this.filterState.selectedChannels.has('ambience'),\r\n        sfx: this.filterState.selectedChannels.has('sfx')\r\n      },\r\n      selectedPlaylistId: this.filterState.selectedPlaylistId,\r\n      sortBy: this.filterState.sortBy,\r\n      hasActiveFilters\r\n    };\r\n  }\r\n\r\n  private getPlaylistViewData(playlist: Playlist): PlaylistViewData {\r\n    return {\r\n      id: playlist.id,\r\n      name: playlist.name,\r\n      itemCount: playlist.items.length,\r\n      favorite: playlist.favorite,\r\n      selected: false\r\n    };\r\n  }\r\n\r\n  private getItemViewData(item: LibraryItem): LibraryItemViewData {\r\n    return {\r\n      id: item.id,\r\n      name: item.name,\r\n      url: item.url,\r\n      duration: formatTime(item.duration),\r\n      durationSeconds: item.duration,\r\n      tags: item.tags,\r\n      favorite: item.favorite,\r\n      group: this.inferGroupFromTags(item.tags)\r\n    };\r\n  }\r\n\r\n  private inferGroupFromTags(tags: string[]): string {\r\n    // Try to infer group from tags if possible\r\n    const lowerTags = tags.map(t => t.toLowerCase());\r\n    if (lowerTags.some(t => t.includes('music'))) return 'music';\r\n    if (lowerTags.some(t => t.includes('ambient') || t.includes('ambience'))) return 'ambience';\r\n    if (lowerTags.some(t => t.includes('sfx') || t.includes('effect'))) return 'sfx';\r\n    return 'music'; // default\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Filtering & Sorting\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private applyFilters(items: LibraryItem[]): LibraryItem[] {\r\n    let filtered = items;\r\n\r\n    // Search filter\r\n    if (this.filterState.searchQuery) {\r\n      const query = this.filterState.searchQuery.toLowerCase();\r\n      filtered = filtered.filter(item =>\r\n        item.name.toLowerCase().includes(query) ||\r\n        item.tags.some(tag => tag.toLowerCase().includes(query))\r\n      );\r\n    }\r\n\r\n    // Channel filter (OR logic: Show item if its group is in selectedChannels)\r\n    if (this.filterState.selectedChannels.size > 0) {\r\n      filtered = filtered.filter(item => {\r\n        const group = this.inferGroupFromTags(item.tags) as TrackGroup;\r\n        return this.filterState.selectedChannels.has(group);\r\n      });\r\n    } else {\r\n      // If no channels selected, strictly show nothing? Or all? \r\n      // Usually if checkboxes, unchecked means don't show.\r\n      filtered = [];\r\n    }\r\n\r\n    // Playlist filter\r\n    if (this.filterState.selectedPlaylistId) {\r\n      const playlist = this.library.playlists.getPlaylist(this.filterState.selectedPlaylistId);\r\n      if (playlist) {\r\n        const playlistItemIds = new Set(playlist.items.map(i => i.libraryItemId));\r\n        filtered = filtered.filter(item => playlistItemIds.has(item.id));\r\n      }\r\n    }\r\n\r\n    // Tags filter (OR logic - show items with ANY of the selected tags)\r\n    if (this.filterState.selectedTags.size > 0) {\r\n      filtered = filtered.filter(item =>\r\n        item.tags.some(tag => this.filterState.selectedTags.has(tag))\r\n      );\r\n    }\r\n\r\n    return filtered;\r\n  }\r\n\r\n  private applySorting(items: LibraryItem[]): LibraryItem[] {\r\n    const sorted = [...items];\r\n\r\n    switch (this.filterState.sortBy) {\r\n      case 'name-asc':\r\n        sorted.sort((a, b) => a.name.localeCompare(b.name));\r\n        break;\r\n      case 'name-desc':\r\n        sorted.sort((a, b) => b.name.localeCompare(a.name));\r\n        break;\r\n      case 'date-asc':\r\n        sorted.sort((a, b) => a.addedAt - b.addedAt);\r\n        break;\r\n      case 'date-desc':\r\n        sorted.sort((a, b) => b.addedAt - a.addedAt);\r\n        break;\r\n      case 'duration-asc':\r\n        sorted.sort((a, b) => a.duration - b.duration);\r\n        break;\r\n      case 'duration-desc':\r\n        sorted.sort((a, b) => b.duration - a.duration);\r\n        break;\r\n    }\r\n\r\n    return sorted;\r\n  }\r\n\r\n  override activateListeners(html: JQuery): void {\r\n    super.activateListeners(html);\r\n\r\n    // Toolbar actions\r\n    html.find('[data-action=\"add-track\"]').on('click', this.onAddTrack.bind(this));\r\n    html.find('[data-action=\"search\"]').on('input', this.onSearch.bind(this));\r\n    html.find('[data-action=\"filter-channel\"]').on('click', this.onFilterChannel.bind(this));\r\n    html.find('[data-action=\"change-sort\"]').on('change', this.onChangeSort.bind(this));\r\n    html.find('[data-action=\"clear-filters\"]').on('click', this.onClearFilters.bind(this));\r\n\r\n    // Tag actions\r\n    html.find('[data-action=\"toggle-tag\"]').on('click', this.onToggleTag.bind(this));\r\n    html.find('[data-action=\"add-tag\"]').on('click', this.onAddTag.bind(this));\r\n\r\n    // Track actions\r\n    html.find('[data-action=\"play-track\"]').on('click', this.onPlayTrack.bind(this));\r\n    html.find('[data-action=\"pause-track\"]').on('click', this.onPauseTrack.bind(this));\r\n    html.find('[data-action=\"stop-track\"]').on('click', this.onStopTrack.bind(this));\r\n    html.find('[data-action=\"add-to-queue\"]').on('click', this.onAddToQueue.bind(this));\r\n    html.find('[data-action=\"toggle-favorite\"]').on('click', this.onToggleFavorite.bind(this));\r\n    html.find('[data-action=\"add-to-playlist\"]').on('click', this.onAddToPlaylist.bind(this));\r\n    html.find('[data-action=\"track-menu\"]').on('click', this.onTrackMenu.bind(this));\r\n\r\n    // In-track tag management\r\n    html.find('[data-action=\"add-tag-to-track\"]').on('click', this.onAddTagToTrack.bind(this));\r\n\r\n    // Playlist actions\r\n    html.find('[data-action=\"select-playlist\"]').on('click', this.onSelectPlaylist.bind(this));\r\n    html.find('[data-action=\"create-playlist\"]').on('click', this.onCreatePlaylist.bind(this));\r\n    html.find('[data-action=\"toggle-playlist-favorite\"]').on('click', this.onTogglePlaylistFavorite.bind(this));\r\n    html.find('[data-action=\"playlist-menu\"]').on('click', this.onPlaylistMenu.bind(this));\r\n\r\n    // Favorite actions\r\n    html.find('[data-action=\"remove-from-favorites\"]').on('click', this.onRemoveFromFavorites.bind(this));\r\n\r\n    // Drag and drop\r\n    this.setupDragAndDrop(html);\r\n\r\n    // Context menus\r\n    this.setupContextMenus(html);\r\n\r\n    Logger.debug('LocalLibraryApp listeners activated');\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Event Handlers\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async onAddTrack(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n\r\n    const fp = new FilePicker({\r\n      type: 'audio',\r\n      callback: async (path: string) => {\r\n        await this.addTrackFromPath(path);\r\n      }\r\n    });\r\n    fp.render(true);\r\n  }\r\n\r\n  private async addTrackFromPath(path: string, group: TrackGroup = 'music'): Promise<void> {\r\n    try {\r\n      const item = await this.library.addItem(path, undefined, group);\r\n      this.render();\r\n      ui.notifications?.info(`Added to library: ${item.name}`);\r\n    } catch (error) {\r\n      Logger.error('Failed to add track to library:', error);\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      ui.notifications?.error(`Failed to add track: ${errorMessage}`);\r\n    }\r\n  }\r\n\r\n  private async onToggleFavorite(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n    const itemId = $(event.currentTarget).closest('[data-item-id]').data('item-id') as string;\r\n\r\n    try {\r\n      const isFavorite = this.library.toggleFavorite(itemId);\r\n      this.render();\r\n      ui.notifications?.info(isFavorite ? 'Added to favorites' : 'Removed from favorites');\r\n    } catch (error) {\r\n      Logger.error('Failed to toggle favorite:', error);\r\n      ui.notifications?.error('Failed to update favorite status');\r\n    }\r\n  }\r\n\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Playlist Event Handlers\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async onCreatePlaylist(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n\r\n    const name = await this.promptPlaylistName();\r\n    if (!name) return;\r\n\r\n    try {\r\n      const playlist = this.library.playlists.createPlaylist(name);\r\n      this.render();\r\n      ui.notifications?.info(`Created playlist: ${playlist.name}`);\r\n    } catch (error) {\r\n      Logger.error('Failed to create playlist:', error);\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      ui.notifications?.error(`Failed to create playlist: ${errorMessage}`);\r\n    }\r\n  }\r\n\r\n  private async onTogglePlaylistFavorite(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n\r\n    const playlistId = $(event.currentTarget).closest('[data-playlist-id]').data('playlist-id') as string;\r\n\r\n    try {\r\n      const isFavorite = this.library.playlists.togglePlaylistFavorite(playlistId);\r\n      this.render();\r\n      ui.notifications?.info(isFavorite ? 'Added to favorites' : 'Removed from favorites');\r\n    } catch (error) {\r\n      Logger.error('Failed to toggle playlist favorite:', error);\r\n      ui.notifications?.error('Failed to update favorite status');\r\n    }\r\n  }\r\n\r\n  private async onRemoveFromFavorites(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n\r\n    const favoriteId = $(event.currentTarget).closest('[data-favorite-id]').data('favorite-id') as string;\r\n    const favoriteType = $(event.currentTarget).closest('[data-favorite-type]').data('favorite-type') as string;\r\n\r\n    try {\r\n      if (favoriteType === 'track') {\r\n        this.library.toggleFavorite(favoriteId);\r\n      } else if (favoriteType === 'playlist') {\r\n        this.library.playlists.togglePlaylistFavorite(favoriteId);\r\n      }\r\n      this.render();\r\n      ui.notifications?.info('Removed from favorites');\r\n    } catch (error) {\r\n      Logger.error('Failed to remove from favorites:', error);\r\n      ui.notifications?.error('Failed to remove from favorites');\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Toolbar Event Handlers\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private onSearch(event: JQuery.TriggeredEvent): void {\r\n    const query = ($(event.currentTarget).val() as string || '').trim();\r\n    this.filterState.searchQuery = query;\r\n    this.render();\r\n    Logger.debug('Search:', query);\r\n  }\r\n\r\n  private onFilterChannel(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    const channel = $(event.currentTarget).data('channel') as TrackGroup;\r\n\r\n    if (this.filterState.selectedChannels.has(channel)) {\r\n      this.filterState.selectedChannels.delete(channel);\r\n    } else {\r\n      this.filterState.selectedChannels.add(channel);\r\n    }\r\n\r\n    this.render();\r\n    Logger.debug('Filter channel toggled:', channel);\r\n  }\r\n\r\n  private onChangeSort(event: JQuery.ChangeEvent): void {\r\n    const sortValue = $(event.currentTarget).val() as FilterState['sortBy'];\r\n    this.filterState.sortBy = sortValue;\r\n    this.render();\r\n    Logger.debug('Sort changed:', sortValue);\r\n  }\r\n\r\n  private onClearFilters(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n\r\n    // Reset all filters except sortBy\r\n    this.filterState.searchQuery = '';\r\n    this.filterState.selectedChannels = new Set(['music', 'ambience', 'sfx']); // Reset to all\r\n    this.filterState.selectedPlaylistId = null;\r\n    this.filterState.selectedTags.clear();\r\n\r\n    this.render();\r\n    ui.notifications?.info('Filters cleared');\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Tag Event Handlers\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private onToggleTag(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    const tag = $(event.currentTarget).data('tag') as string;\r\n\r\n    if (this.filterState.selectedTags.has(tag)) {\r\n      this.filterState.selectedTags.delete(tag);\r\n    } else {\r\n      this.filterState.selectedTags.add(tag);\r\n    }\r\n\r\n    this.render();\r\n    Logger.debug('Toggle tag:', tag, 'Selected tags:', Array.from(this.filterState.selectedTags));\r\n  }\r\n\r\n  private async onAddTag(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n\r\n    const tagName = await this.promptTagName();\r\n    if (!tagName) return;\r\n\r\n    // Tags are automatically created when added to tracks\r\n    // This is just a placeholder for future tag management\r\n    Logger.debug('Add tag:', tagName);\r\n    ui.notifications?.info(`Tag \"${tagName}\" will be available once assigned to tracks`);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Track Event Handlers (Extended)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private onPlayTrack(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const itemId = $(event.currentTarget).data('item-id') as string;\r\n\r\n    Logger.debug('Play track:', itemId);\r\n    Logger.debug('Play track:', itemId);\r\n    window.ASE.engine?.playTrack(itemId);\r\n    // Also add to queue if needed? \r\n    // User requested \"Play adds to list of reproduction\".\r\n    // window.ASE.engine?.addToQueue(itemId); // TODO: Implement Queue\r\n  }\r\n\r\n  private onStopTrack(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const itemId = $(event.currentTarget).data('item-id') as string;\r\n\r\n    Logger.debug('Stop track:', itemId);\r\n    window.ASE.engine?.stopTrack(itemId);\r\n  }\r\n\r\n  private onPauseTrack(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const itemId = $(event.currentTarget).data('item-id') as string;\r\n    Logger.debug('Pause track:', itemId);\r\n    window.ASE.engine?.pauseTrack(itemId);\r\n  }\r\n\r\n  private onAddToQueue(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const itemId = $(event.currentTarget).data('item-id') as string;\r\n    Logger.debug('Add to queue:', itemId);\r\n    // Implementation depends on Queue manager\r\n    ui.notifications?.info('Added to queue (Simulated)');\r\n  }\r\n\r\n  private async onAddTagToTrack(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const itemId = $(event.currentTarget).data('item-id') as string;\r\n    Logger.debug('Add tag to track:', itemId);\r\n\r\n    // Open dialog to select or create tags for this track\r\n    // Implementation placeholder\r\n    ui.notifications?.info('Tag selection dialog coming soon');\r\n  }\r\n\r\n  private async onAddToPlaylist(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const itemId = $(event.currentTarget).data('item-id') as string;\r\n    const item = this.library.getItem(itemId);\r\n\r\n    if (!item) {\r\n      ui.notifications?.error('Track not found');\r\n      return;\r\n    }\r\n\r\n    const playlists = this.library.playlists.getAllPlaylists();\r\n    if (playlists.length === 0) {\r\n      ui.notifications?.warn('No playlists available. Create one first.');\r\n      return;\r\n    }\r\n\r\n    // Show playlist selection dialog\r\n    const selectedPlaylistId = await this.promptPlaylistSelection(playlists);\r\n    if (!selectedPlaylistId) return;\r\n\r\n    try {\r\n      const group = this.inferGroupFromTags(item.tags) as TrackGroup;\r\n      this.library.playlists.addTrackToPlaylist(selectedPlaylistId, itemId, group);\r\n      this.render();\r\n      ui.notifications?.info(`Added \"${item.name}\" to playlist`);\r\n    } catch (error) {\r\n      Logger.error('Failed to add track to playlist:', error);\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      ui.notifications?.error(`Failed to add to playlist: ${errorMessage}`);\r\n    }\r\n  }\r\n\r\n  private onTrackMenu(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    // Context menu is now handled by right-click\r\n    // This button can trigger the same menu programmatically\r\n    const itemId = $(event.currentTarget).data('item-id') as string;\r\n    const trackElement = $(event.currentTarget).closest('.track-item');\r\n\r\n    // Trigger a contextmenu event on the track item\r\n    const contextMenuEvent = new MouseEvent('contextmenu', {\r\n      bubbles: true,\r\n      cancelable: true,\r\n      view: window,\r\n      clientX: event.clientX,\r\n      clientY: event.clientY\r\n    });\r\n    trackElement[0]?.dispatchEvent(contextMenuEvent);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Playlist Event Handlers (Extended)\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private onSelectPlaylist(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    const playlistId = $(event.currentTarget).data('playlist-id') as string;\r\n\r\n    // Toggle playlist filter\r\n    if (this.filterState.selectedPlaylistId === playlistId) {\r\n      // Deselect if clicking the same playlist\r\n      this.filterState.selectedPlaylistId = null;\r\n    } else {\r\n      this.filterState.selectedPlaylistId = playlistId;\r\n    }\r\n\r\n    this.render();\r\n    Logger.debug('Select playlist:', playlistId);\r\n  }\r\n\r\n  private onPlaylistMenu(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    // Context menu is now handled by right-click\r\n    // This button can trigger the same menu programmatically\r\n    const playlistId = $(event.currentTarget).data('playlist-id') as string;\r\n    const playlistElement = $(event.currentTarget).closest('.playlist-item');\r\n\r\n    // Trigger a contextmenu event on the playlist item\r\n    const contextMenuEvent = new MouseEvent('contextmenu', {\r\n      bubbles: true,\r\n      cancelable: true,\r\n      view: window,\r\n      clientX: event.clientX,\r\n      clientY: event.clientY\r\n    });\r\n    playlistElement[0]?.dispatchEvent(contextMenuEvent);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Drag and Drop\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private setupDragAndDrop(html: JQuery): void {\r\n    // Drag start\r\n    html.find('.track-item[draggable=\"true\"]').on('dragstart', (event: JQuery.DragStartEvent) => {\r\n      const itemId = $(event.currentTarget).data('item-id') as string;\r\n      event.originalEvent!.dataTransfer!.effectAllowed = 'copy';\r\n      event.originalEvent!.dataTransfer!.setData('text/plain', itemId);\r\n      $(event.currentTarget).addClass('dragging');\r\n    });\r\n\r\n    // Drag end\r\n    html.find('.track-item[draggable=\"true\"]').on('dragend', (event: JQuery.DragEndEvent) => {\r\n      $(event.currentTarget).removeClass('dragging');\r\n    });\r\n\r\n    // Drop zones (playlists)\r\n    html.find('.playlist-item').on('dragover', (event: JQuery.DragOverEvent) => {\r\n      event.preventDefault();\r\n      event.originalEvent!.dataTransfer!.dropEffect = 'copy';\r\n      $(event.currentTarget).addClass('drag-over');\r\n    });\r\n\r\n    html.find('.playlist-item').on('dragleave', (event: JQuery.DragLeaveEvent) => {\r\n      $(event.currentTarget).removeClass('drag-over');\r\n    });\r\n\r\n    html.find('.playlist-item').on('drop', async (event: JQuery.DropEvent) => {\r\n      event.preventDefault();\r\n      const itemId = event.originalEvent!.dataTransfer!.getData('text/plain');\r\n      const playlistId = $(event.currentTarget).data('playlist-id') as string;\r\n      $(event.currentTarget).removeClass('drag-over');\r\n\r\n      await this.handleDropTrackToPlaylist(itemId, playlistId);\r\n    });\r\n\r\n    // Drop zone from OS (Main Library Area)\r\n    html.find('.library-main').on('dragover', (event: JQuery.DragOverEvent) => {\r\n      event.preventDefault();\r\n      $(event.currentTarget).addClass('drag-over-import');\r\n    });\r\n\r\n    html.find('.library-main').on('dragleave', (event: JQuery.DragLeaveEvent) => {\r\n      $(event.currentTarget).removeClass('drag-over-import');\r\n    });\r\n\r\n    html.find('.library-main').on('drop', async (event: JQuery.DropEvent) => {\r\n      event.preventDefault();\r\n      $(event.currentTarget).removeClass('drag-over-import');\r\n\r\n      // Handle files from OS\r\n      const files = event.originalEvent?.dataTransfer?.files;\r\n      if (files && files.length > 0) {\r\n        Logger.debug(`Dropped ${files.length} files from OS`);\r\n        // Processing files...\r\n        // Note: Foundry FilePicker/Upload API is needed here.\r\n        // For now, we simulate the drop if it's external, or handle internal drops logic separately.\r\n\r\n        // Check if it's an internal drag (track item)\r\n        // If dataTransfer has 'text/plain' equal to item ID, it's internal.\r\n        const internalId = event.originalEvent?.dataTransfer?.getData('text/plain');\r\n        if (internalId && !files.length) {\r\n          // Internal drop on main area -> Maybe remove from current playlist if we are in one? \r\n          // Currently do nothing.\r\n          return;\r\n        }\r\n\r\n        // Real file upload\r\n        await this.handleFileUpload(files);\r\n      }\r\n    });\r\n  }\r\n\r\n  private async handleDropTrackToPlaylist(itemId: string, playlistId: string): Promise<void> {\r\n    const item = this.library.getItem(itemId);\r\n    const playlist = this.library.playlists.getPlaylist(playlistId);\r\n\r\n    if (!item || !playlist) {\r\n      ui.notifications?.error('Track or playlist not found');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const group = this.inferGroupFromTags(item.tags) as TrackGroup;\r\n      this.library.playlists.addTrackToPlaylist(playlistId, itemId, group);\r\n      this.render();\r\n      ui.notifications?.info(`Added \"${item.name}\" to \"${playlist.name}\"`);\r\n    } catch (error) {\r\n      Logger.error('Failed to add track to playlist:', error);\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      ui.notifications?.error(`Failed to add to playlist: ${errorMessage}`);\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Context Menus\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private setupContextMenus(html: JQuery): void {\r\n    // Track context menu\r\n    new ContextMenu(html, '.track-item', [\r\n      {\r\n        name: 'Edit Name',\r\n        icon: '<i class=\"fas fa-edit\"></i>',\r\n        callback: async (li: JQuery) => {\r\n          const itemId = li.data('item-id') as string;\r\n          await this.onEditTrackName(itemId);\r\n        }\r\n      },\r\n      {\r\n        name: 'Edit Tags',\r\n        icon: '<i class=\"fas fa-tags\"></i>',\r\n        callback: async (li: JQuery) => {\r\n          const itemId = li.data('item-id') as string;\r\n          await this.onEditTrackTags(itemId);\r\n        }\r\n      },\r\n      {\r\n        name: 'Add to Playlist',\r\n        icon: '<i class=\"fas fa-list-ul\"></i>',\r\n        callback: async (li: JQuery) => {\r\n          const itemId = li.data('item-id') as string;\r\n          const item = this.library.getItem(itemId);\r\n          if (!item) return;\r\n\r\n          const playlists = this.library.playlists.getAllPlaylists();\r\n          if (playlists.length === 0) {\r\n            ui.notifications?.warn('No playlists available. Create one first.');\r\n            return;\r\n          }\r\n\r\n          const selectedPlaylistId = await this.promptPlaylistSelection(playlists);\r\n          if (!selectedPlaylistId) return;\r\n\r\n          try {\r\n            const group = this.inferGroupFromTags(item.tags) as TrackGroup;\r\n            this.library.playlists.addTrackToPlaylist(selectedPlaylistId, itemId, group);\r\n            this.render();\r\n            ui.notifications?.info(`Added \"${item.name}\" to playlist`);\r\n          } catch (error) {\r\n            Logger.error('Failed to add track to playlist:', error);\r\n            const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n            ui.notifications?.error(`Failed to add to playlist: ${errorMessage}`);\r\n          }\r\n        }\r\n      },\r\n      {\r\n        name: 'Toggle Favorite',\r\n        icon: '<i class=\"fas fa-star\"></i>',\r\n        callback: (li: JQuery) => {\r\n          const itemId = li.data('item-id') as string;\r\n          try {\r\n            const isFavorite = this.library.toggleFavorite(itemId);\r\n            this.render();\r\n            ui.notifications?.info(isFavorite ? 'Added to favorites' : 'Removed from favorites');\r\n          } catch (error) {\r\n            Logger.error('Failed to toggle favorite:', error);\r\n            ui.notifications?.error('Failed to update favorite status');\r\n          }\r\n        }\r\n      },\r\n      {\r\n        name: 'Delete Track',\r\n        icon: '<i class=\"fas fa-trash\"></i>',\r\n        callback: async (li: JQuery) => {\r\n          const itemId = li.data('item-id') as string;\r\n          await this.onDeleteTrackConfirm(itemId);\r\n        }\r\n      }\r\n    ]);\r\n\r\n    // Playlist context menu\r\n    new ContextMenu(html, '.playlist-item', [\r\n      {\r\n        name: 'Rename Playlist',\r\n        icon: '<i class=\"fas fa-edit\"></i>',\r\n        callback: async (li: JQuery) => {\r\n          const playlistId = li.data('playlist-id') as string;\r\n          await this.onRenamePlaylist(playlistId);\r\n        }\r\n      },\r\n      {\r\n        name: 'Edit Description',\r\n        icon: '<i class=\"fas fa-align-left\"></i>',\r\n        callback: async (li: JQuery) => {\r\n          const playlistId = li.data('playlist-id') as string;\r\n          await this.onEditPlaylistDescription(playlistId);\r\n        }\r\n      },\r\n      {\r\n        name: 'View Contents',\r\n        icon: '<i class=\"fas fa-list\"></i>',\r\n        callback: async (li: JQuery) => {\r\n          const playlistId = li.data('playlist-id') as string;\r\n          await this.onViewPlaylistContents(playlistId);\r\n        }\r\n      },\r\n      {\r\n        name: 'Clear Playlist',\r\n        icon: '<i class=\"fas fa-eraser\"></i>',\r\n        callback: async (li: JQuery) => {\r\n          const playlistId = li.data('playlist-id') as string;\r\n          await this.onClearPlaylist(playlistId);\r\n        }\r\n      },\r\n      {\r\n        name: 'Delete Playlist',\r\n        icon: '<i class=\"fas fa-trash\"></i>',\r\n        callback: async (li: JQuery) => {\r\n          const playlistId = li.data('playlist-id') as string;\r\n          await this.onDeletePlaylistConfirm(playlistId);\r\n        }\r\n      }\r\n    ]);\r\n\r\n    // Tag context menu\r\n    new ContextMenu(html, '.tag-chip:not(.mini)', [\r\n      {\r\n        name: 'Rename Tag',\r\n        icon: '<i class=\"fas fa-edit\"></i>',\r\n        callback: async (li: JQuery) => {\r\n          const tagName = li.data('tag') as string;\r\n          await this.onRenameTag(tagName);\r\n        }\r\n      },\r\n      {\r\n        name: 'Delete Tag',\r\n        icon: '<i class=\"fas fa-trash\"></i>',\r\n        callback: async (li: JQuery) => {\r\n          const tagName = li.data('tag') as string;\r\n          await this.onDeleteTag(tagName);\r\n        }\r\n      }\r\n    ]);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Context Menu Handlers - Tracks\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async onEditTrackName(itemId: string): Promise<void> {\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) {\r\n      ui.notifications?.error('Track not found');\r\n      return;\r\n    }\r\n\r\n    const newName = await this.promptTextInput('Edit Track Name', 'Track Name', item.name);\r\n    if (!newName || newName === item.name) return;\r\n\r\n    try {\r\n      this.library.updateItem(itemId, { name: newName });\r\n      this.render();\r\n      ui.notifications?.info(`Renamed to: ${newName}`);\r\n    } catch (error) {\r\n      Logger.error('Failed to rename track:', error);\r\n      ui.notifications?.error('Failed to rename track');\r\n    }\r\n  }\r\n\r\n  private async onEditTrackTags(itemId: string): Promise<void> {\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) {\r\n      ui.notifications?.error('Track not found');\r\n      return;\r\n    }\r\n\r\n    const tagsString = await this.promptTextInput(\r\n      'Edit Tags',\r\n      'Tags (comma-separated)',\r\n      item.tags.join(', ')\r\n    );\r\n    if (tagsString === null) return;\r\n\r\n    // Parse tags\r\n    const newTags = tagsString\r\n      .split(',')\r\n      .map(t => t.trim())\r\n      .filter(t => t.length > 0);\r\n\r\n    try {\r\n      this.library.updateItem(itemId, { tags: newTags });\r\n      this.render();\r\n      ui.notifications?.info('Tags updated');\r\n    } catch (error) {\r\n      Logger.error('Failed to update tags:', error);\r\n      ui.notifications?.error('Failed to update tags');\r\n    }\r\n  }\r\n\r\n  private async onDeleteTrackConfirm(itemId: string): Promise<void> {\r\n    const item = this.library.getItem(itemId);\r\n    if (!item) {\r\n      ui.notifications?.error('Track not found');\r\n      return;\r\n    }\r\n\r\n    const confirmed = await Dialog.confirm({\r\n      title: 'Delete Track',\r\n      content: `<p>Are you sure you want to delete <strong>${item.name}</strong> from the library?</p>\r\n                <p class=\"notification warning\">This will remove it from all playlists and favorites.</p>`,\r\n      yes: () => true,\r\n      no: () => false,\r\n      defaultYes: false\r\n    });\r\n\r\n    if (confirmed) {\r\n      try {\r\n        this.library.removeItem(itemId);\r\n        this.render();\r\n        ui.notifications?.info(`Deleted: ${item.name}`);\r\n      } catch (error) {\r\n        Logger.error('Failed to delete track:', error);\r\n        ui.notifications?.error('Failed to delete track');\r\n      }\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Context Menu Handlers - Playlists\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async onRenamePlaylist(playlistId: string): Promise<void> {\r\n    const playlist = this.library.playlists.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      ui.notifications?.error('Playlist not found');\r\n      return;\r\n    }\r\n\r\n    const newName = await this.promptTextInput('Rename Playlist', 'Playlist Name', playlist.name);\r\n    if (!newName || newName === playlist.name) return;\r\n\r\n    try {\r\n      this.library.playlists.updatePlaylist(playlistId, { name: newName });\r\n      this.render();\r\n      ui.notifications?.info(`Renamed to: ${newName}`);\r\n    } catch (error) {\r\n      Logger.error('Failed to rename playlist:', error);\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      ui.notifications?.error(`Failed to rename playlist: ${errorMessage}`);\r\n    }\r\n  }\r\n\r\n  private async onEditPlaylistDescription(playlistId: string): Promise<void> {\r\n    const playlist = this.library.playlists.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      ui.notifications?.error('Playlist not found');\r\n      return;\r\n    }\r\n\r\n    const description = await this.promptTextInput(\r\n      'Edit Description',\r\n      'Description',\r\n      playlist.description || ''\r\n    );\r\n    if (description === null) return;\r\n\r\n    try {\r\n      this.library.playlists.updatePlaylist(playlistId, { description: description || undefined });\r\n      this.render();\r\n      ui.notifications?.info('Description updated');\r\n    } catch (error) {\r\n      Logger.error('Failed to update description:', error);\r\n      ui.notifications?.error('Failed to update description');\r\n    }\r\n  }\r\n\r\n  private async onViewPlaylistContents(playlistId: string): Promise<void> {\r\n    const playlist = this.library.playlists.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      ui.notifications?.error('Playlist not found');\r\n      return;\r\n    }\r\n\r\n    const items = playlist.items\r\n      .sort((a, b) => a.order - b.order)\r\n      .map((playlistItem, index) => {\r\n        const libraryItem = this.library.getItem(playlistItem.libraryItemId);\r\n        const name = libraryItem?.name || 'Unknown';\r\n        return `<li><strong>${index + 1}.</strong> ${name}</li>`;\r\n      })\r\n      .join('');\r\n\r\n    const content = `\r\n      <div>\r\n        <p><strong>${playlist.name}</strong></p>\r\n        ${playlist.description ? `<p><em>${playlist.description}</em></p>` : ''}\r\n        <p>Total tracks: ${playlist.items.length}</p>\r\n        ${playlist.items.length > 0 ? `<ul class=\"playlist-contents-list\">${items}</ul>` : '<p>No tracks in playlist</p>'}\r\n      </div>\r\n    `;\r\n\r\n    new Dialog({\r\n      title: 'Playlist Contents',\r\n      content,\r\n      buttons: {\r\n        close: {\r\n          icon: '<i class=\"fas fa-times\"></i>',\r\n          label: 'Close'\r\n        }\r\n      },\r\n      default: 'close'\r\n    }).render(true);\r\n  }\r\n\r\n  private async onClearPlaylist(playlistId: string): Promise<void> {\r\n    const playlist = this.library.playlists.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      ui.notifications?.error('Playlist not found');\r\n      return;\r\n    }\r\n\r\n    if (playlist.items.length === 0) {\r\n      ui.notifications?.warn('Playlist is already empty');\r\n      return;\r\n    }\r\n\r\n    const confirmed = await Dialog.confirm({\r\n      title: 'Clear Playlist',\r\n      content: `<p>Are you sure you want to remove all ${playlist.items.length} tracks from <strong>${playlist.name}</strong>?</p>\r\n                <p class=\"notification warning\">This cannot be undone.</p>`,\r\n      yes: () => true,\r\n      no: () => false,\r\n      defaultYes: false\r\n    });\r\n\r\n    if (confirmed) {\r\n      try {\r\n        // Remove all items\r\n        const itemIds = [...playlist.items.map(i => i.id)];\r\n        itemIds.forEach(itemId => {\r\n          try {\r\n            this.library.playlists.removeTrackFromPlaylist(playlistId, itemId);\r\n          } catch (error) {\r\n            Logger.error('Failed to remove item:', error);\r\n          }\r\n        });\r\n\r\n        this.render();\r\n        ui.notifications?.info(`Cleared playlist: ${playlist.name}`);\r\n      } catch (error) {\r\n        Logger.error('Failed to clear playlist:', error);\r\n        ui.notifications?.error('Failed to clear playlist');\r\n      }\r\n    }\r\n  }\r\n\r\n  private async onDeletePlaylistConfirm(playlistId: string): Promise<void> {\r\n    const playlist = this.library.playlists.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      ui.notifications?.error('Playlist not found');\r\n      return;\r\n    }\r\n\r\n    const confirmed = await Dialog.confirm({\r\n      title: 'Delete Playlist',\r\n      content: `<p>Are you sure you want to delete <strong>${playlist.name}</strong>?</p>\r\n                <p class=\"notification info\">The tracks will remain in your library.</p>`,\r\n      yes: () => true,\r\n      no: () => false,\r\n      defaultYes: false\r\n    });\r\n\r\n    if (confirmed) {\r\n      try {\r\n        // Clear playlist filter if this playlist is selected\r\n        if (this.filterState.selectedPlaylistId === playlistId) {\r\n          this.filterState.selectedPlaylistId = null;\r\n        }\r\n\r\n        this.library.playlists.deletePlaylist(playlistId);\r\n        this.render();\r\n        ui.notifications?.info(`Deleted playlist: ${playlist.name}`);\r\n      } catch (error) {\r\n        Logger.error('Failed to delete playlist:', error);\r\n        ui.notifications?.error('Failed to delete playlist');\r\n      }\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Context Menu Handlers - Tags\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async onRenameTag(oldTagName: string): Promise<void> {\r\n    const newTagName = await this.promptTextInput('Rename Tag', 'New Tag Name', oldTagName);\r\n    if (!newTagName || newTagName === oldTagName) return;\r\n\r\n    try {\r\n      // Find all items with this tag and update them\r\n      const items = this.library.getAllItems().filter(item => item.tags.includes(oldTagName));\r\n\r\n      items.forEach(item => {\r\n        const updatedTags = item.tags.map(tag => tag === oldTagName ? newTagName : tag);\r\n        this.library.updateItem(item.id, { tags: updatedTags });\r\n      });\r\n\r\n      // Update filter state if tag is selected\r\n      if (this.filterState.selectedTags.has(oldTagName)) {\r\n        this.filterState.selectedTags.delete(oldTagName);\r\n        this.filterState.selectedTags.add(newTagName);\r\n      }\r\n\r\n      this.render();\r\n      ui.notifications?.info(`Renamed tag \"${oldTagName}\" to \"${newTagName}\" in ${items.length} track(s)`);\r\n    } catch (error) {\r\n      Logger.error('Failed to rename tag:', error);\r\n      ui.notifications?.error('Failed to rename tag');\r\n    }\r\n  }\r\n\r\n  private async onDeleteTag(tagName: string): Promise<void> {\r\n    const items = this.library.getAllItems().filter(item => item.tags.includes(tagName));\r\n\r\n    const confirmed = await Dialog.confirm({\r\n      title: 'Delete Tag',\r\n      content: `<p>Are you sure you want to delete the tag <strong>${tagName}</strong>?</p>\r\n                <p class=\"notification warning\">This will remove the tag from ${items.length} track(s).</p>`,\r\n      yes: () => true,\r\n      no: () => false,\r\n      defaultYes: false\r\n    });\r\n\r\n    if (confirmed) {\r\n      try {\r\n        items.forEach(item => {\r\n          const updatedTags = item.tags.filter(tag => tag !== tagName);\r\n          this.library.updateItem(item.id, { tags: updatedTags });\r\n        });\r\n\r\n        // Remove from filter state if selected\r\n        this.filterState.selectedTags.delete(tagName);\r\n\r\n        this.render();\r\n        ui.notifications?.info(`Deleted tag \"${tagName}\" from ${items.length} track(s)`);\r\n      } catch (error) {\r\n        Logger.error('Failed to delete tag:', error);\r\n        ui.notifications?.error('Failed to delete tag');\r\n      }\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Utilities\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private async promptTagName(): Promise<string | null> {\r\n    return new Promise((resolve) => {\r\n      new Dialog({\r\n        title: 'Add Tag',\r\n        content: `\r\n          <form>\r\n            <div class=\"form-group\">\r\n              <label>Tag Name:</label>\r\n              <input type=\"text\" name=\"tag-name\" placeholder=\"#Dramatic\" autofocus />\r\n            </div>\r\n          </form>\r\n        `,\r\n        buttons: {\r\n          create: {\r\n            icon: '<i class=\"fas fa-check\"></i>',\r\n            label: 'Add',\r\n            callback: (html: JQuery) => {\r\n              let name = (html.find('[name=\"tag-name\"]').val() as string || '').trim();\r\n              // Remove # prefix if present\r\n              if (name.startsWith('#')) {\r\n                name = name.substring(1);\r\n              }\r\n              resolve(name || null);\r\n            }\r\n          },\r\n          cancel: {\r\n            icon: '<i class=\"fas fa-times\"></i>',\r\n            label: 'Cancel',\r\n            callback: () => resolve(null)\r\n          }\r\n        },\r\n        default: 'create'\r\n      }).render(true);\r\n    });\r\n  }\r\n\r\n  private async promptPlaylistSelection(playlists: Playlist[]): Promise<string | null> {\r\n    const options = playlists.map(p =>\r\n      `<option value=\"${p.id}\">${p.name} (${p.items.length} tracks)</option>`\r\n    ).join('');\r\n\r\n    return new Promise((resolve) => {\r\n      new Dialog({\r\n        title: 'Add to Playlist',\r\n        content: `\r\n          <form>\r\n            <div class=\"form-group\">\r\n              <label>Select Playlist:</label>\r\n              <select name=\"playlist-id\">\r\n                ${options}\r\n              </select>\r\n            </div>\r\n          </form>\r\n        `,\r\n        buttons: {\r\n          add: {\r\n            icon: '<i class=\"fas fa-plus\"></i>',\r\n            label: 'Add',\r\n            callback: (html: JQuery) => {\r\n              const playlistId = html.find('[name=\"playlist-id\"]').val() as string;\r\n              resolve(playlistId || null);\r\n            }\r\n          },\r\n          cancel: {\r\n            icon: '<i class=\"fas fa-times\"></i>',\r\n            label: 'Cancel',\r\n            callback: () => resolve(null)\r\n          }\r\n        },\r\n        default: 'add'\r\n      }).render(true);\r\n    });\r\n  }\r\n\r\n  private async promptPlaylistName(): Promise<string | null> {\r\n    return new Promise((resolve) => {\r\n      new Dialog({\r\n        title: 'Create Playlist',\r\n        content: `\r\n          <form>\r\n            <div class=\"form-group\">\r\n              <label>Playlist Name:</label>\r\n              <input type=\"text\" name=\"playlist-name\" autofocus />\r\n            </div>\r\n          </form>\r\n        `,\r\n        buttons: {\r\n          create: {\r\n            icon: '<i class=\"fas fa-check\"></i>',\r\n            label: 'Create',\r\n            callback: (html: JQuery) => {\r\n              const name = (html.find('[name=\"playlist-name\"]').val() as string || '').trim();\r\n              resolve(name || null);\r\n            }\r\n          },\r\n          cancel: {\r\n            icon: '<i class=\"fas fa-times\"></i>',\r\n            label: 'Cancel',\r\n            callback: () => resolve(null)\r\n          }\r\n        },\r\n        default: 'create'\r\n      }).render(true);\r\n    });\r\n  }\r\n\r\n  private async promptTextInput(\r\n    title: string,\r\n    label: string,\r\n    defaultValue: string = ''\r\n  ): Promise<string | null> {\r\n    return new Promise((resolve) => {\r\n      new Dialog({\r\n        title,\r\n        content: `\r\n          <form>\r\n            <div class=\"form-group\">\r\n              <label>${label}:</label>\r\n              <input type=\"text\" name=\"text-input\" value=\"${defaultValue}\" autofocus />\r\n            </div>\r\n          </form>\r\n        `,\r\n        buttons: {\r\n          save: {\r\n            icon: '<i class=\"fas fa-check\"></i>',\r\n            label: 'Save',\r\n            callback: (html: JQuery) => {\r\n              const value = (html.find('[name=\"text-input\"]').val() as string || '').trim();\r\n              resolve(value || null);\r\n            }\r\n          },\r\n          cancel: {\r\n            icon: '<i class=\"fas fa-times\"></i>',\r\n            label: 'Cancel',\r\n            callback: () => resolve(null)\r\n          }\r\n        },\r\n        default: 'save'\r\n      }).render(true);\r\n    });\r\n  }\r\n}\r\n","export function throttle<T extends (...args: Parameters<T>) => void>(\r\n  fn: T,\r\n  delay: number\r\n): (...args: Parameters<T>) => void {\r\n  let lastCall = 0;\r\n  let timeoutId: ReturnType<typeof setTimeout> | null = null;\r\n  \r\n  return function (this: ThisParameterType<T>, ...args: Parameters<T>) {\r\n    const now = Date.now();\r\n    const remaining = delay - (now - lastCall);\r\n    \r\n    if (remaining <= 0) {\r\n      if (timeoutId) {\r\n        clearTimeout(timeoutId);\r\n        timeoutId = null;\r\n      }\r\n      lastCall = now;\r\n      fn.apply(this, args);\r\n    } else if (!timeoutId) {\r\n      timeoutId = setTimeout(() => {\r\n        lastCall = Date.now();\r\n        timeoutId = null;\r\n        fn.apply(this, args);\r\n      }, remaining);\r\n    }\r\n  };\r\n}\r\n\r\nexport function debounce<T extends (...args: Parameters<T>) => void>(\r\n  fn: T,\r\n  delay: number\r\n): (...args: Parameters<T>) => void {\r\n  let timeoutId: ReturnType<typeof setTimeout> | null = null;\r\n  \r\n  return function (this: ThisParameterType<T>, ...args: Parameters<T>) {\r\n    if (timeoutId) {\r\n      clearTimeout(timeoutId);\r\n    }\r\n    timeoutId = setTimeout(() => {\r\n      fn.apply(this, args);\r\n    }, delay);\r\n  };\r\n}","import type { TrackGroup } from '@t/audio';\r\nimport { AudioEngine } from '@core/AudioEngine';\r\nimport { SocketManager } from '@sync/SocketManager';\r\nimport { StreamingPlayer } from '@core/StreamingPlayer';\r\nimport { Logger } from '@utils/logger';\r\nimport { formatTime } from '@utils/time';\r\nimport { throttle } from '@utils/throttle';\r\nimport { generateUUID } from '@utils/uuid';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\n\r\nfunction getMaxSimultaneous(): number {\r\n  return (game.settings.get(MODULE_ID, 'maxSimultaneousTracks') as number) || 8;\r\n}\r\n\r\ninterface MixerData {\r\n  tracks: TrackViewData[];\r\n  volumes: {\r\n    master: number;\r\n    music: number;\r\n    ambience: number;\r\n    sfx: number;\r\n  };\r\n  playingCount: number;\r\n  maxSimultaneous: number;\r\n  syncEnabled: boolean;\r\n}\r\n\r\ninterface TrackViewData {\r\n  id: string;\r\n  name: string;\r\n  group: TrackGroup;\r\n  isPlaying: boolean;\r\n  isPaused: boolean;\r\n  isStopped: boolean;\r\n  isLoading: boolean;\r\n  volume: number;\r\n  volumePercent: number;\r\n  loop: boolean;\r\n  currentTime: number;\r\n  currentTimeFormatted: string;\r\n  duration: number;\r\n  durationFormatted: string;\r\n  progress: number;\r\n}\r\n\r\nexport class SoundMixerApp extends Application {\r\n  private engine: AudioEngine;\r\n  private socket: SocketManager;\r\n  private updateInterval: ReturnType<typeof setInterval> | null = null;\r\n\r\n  static override get defaultOptions(): ApplicationOptions {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'ase-sound-mixer',\r\n      title: 'Sound Mixer (GM)',\r\n      template: `modules/${MODULE_ID}/templates/mixer.hbs`,\r\n      classes: ['ase-mixer'],\r\n      width: 550,\r\n      height: 'auto',\r\n      resizable: true,\r\n      minimizable: true,\r\n      popOut: true\r\n    }) as ApplicationOptions;\r\n  }\r\n\r\n  constructor(engine: AudioEngine, socket: SocketManager, options?: Partial<ApplicationOptions>) {\r\n    super(options);\r\n    this.engine = engine;\r\n    this.socket = socket;\r\n  }\r\n\r\n  override getData(): MixerData {\r\n    const tracks = this.engine.getAllTracks().map(player => this.getTrackViewData(player));\r\n    const volumes = this.engine.volumes;\r\n    const playingCount = tracks.filter(t => t.isPlaying).length;\r\n\r\n    return {\r\n      tracks,\r\n      volumes: {\r\n        master: Math.round(volumes.master * 100),\r\n        music: Math.round(volumes.music * 100),\r\n        ambience: Math.round(volumes.ambience * 100),\r\n        sfx: Math.round(volumes.sfx * 100)\r\n      },\r\n      playingCount,\r\n      maxSimultaneous: getMaxSimultaneous(),\r\n      syncEnabled: this.socket.syncEnabled\r\n    };\r\n  }\r\n\r\n  private getTrackViewData(player: StreamingPlayer): TrackViewData {\r\n    const state = player.getState();\r\n    const currentTime = player.getCurrentTime();\r\n    const duration = player.getDuration();\r\n    \r\n    return {\r\n      id: state.id,\r\n      name: this.extractFileName(state.url),\r\n      group: state.group,\r\n      isPlaying: state.playbackState === 'playing',\r\n      isPaused: state.playbackState === 'paused',\r\n      isStopped: state.playbackState === 'stopped',\r\n      isLoading: state.playbackState === 'loading',\r\n      volume: state.volume,\r\n      volumePercent: Math.round(state.volume * 100),\r\n      loop: state.loop,\r\n      currentTime,\r\n      currentTimeFormatted: formatTime(currentTime),\r\n      duration,\r\n      durationFormatted: formatTime(duration),\r\n      progress: duration > 0 ? (currentTime / duration) * 100 : 0\r\n    };\r\n  }\r\n\r\n  private extractFileName(url: string): string {\r\n    if (!url) return 'Unknown';\r\n    try {\r\n      const decoded = decodeURIComponent(url);\r\n      const parts = decoded.split('/');\r\n      const fileName = parts[parts.length - 1];\r\n      return fileName.replace(/\\.[^.]+$/, '');\r\n    } catch {\r\n      const parts = url.split('/');\r\n      const fileName = parts[parts.length - 1];\r\n      return fileName.replace(/\\.[^.]+$/, '');\r\n    }\r\n  }\r\n\r\n  override activateListeners(html: JQuery): void {\r\n    super.activateListeners(html);\r\n\r\n    // Sync toggle\r\n    html.find('#ase-sync-toggle').on('change', (event) => {\r\n      const enabled = (event.target as HTMLInputElement).checked;\r\n      this.socket.setSyncEnabled(enabled);\r\n      this.updateSyncIndicator(html, enabled);\r\n    });\r\n\r\n    // Channel volume sliders\r\n    const throttledChannelVolume = throttle((channel: string, value: number) => {\r\n      if (channel === 'master') {\r\n        this.engine.setMasterVolume(value);\r\n        this.socket.broadcastChannelVolume('master', value);\r\n      } else {\r\n        this.engine.setChannelVolume(channel as TrackGroup, value);\r\n        this.socket.broadcastChannelVolume(channel as TrackGroup, value);\r\n      }\r\n    }, 50);\r\n\r\n    html.find('.ase-channel-slider').on('input', (event) => {\r\n      const channel = $(event.currentTarget).data('channel') as string;\r\n      const value = parseFloat((event.target as HTMLInputElement).value) / 100;\r\n      throttledChannelVolume(channel, value);\r\n      $(event.currentTarget).siblings('.ase-channel-value').text(`${Math.round(value * 100)}%`);\r\n    });\r\n\r\n    // Add track\r\n    html.find('#ase-add-track').on('click', () => this.onAddTrack());\r\n\r\n    // Track controls\r\n    const tracks = html.find('.ase-tracks');\r\n    \r\n    tracks.on('click', '.ase-btn-play', (event) => {\r\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\r\n      this.onPlayTrack(trackId);\r\n    });\r\n\r\n    tracks.on('click', '.ase-btn-pause', (event) => {\r\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\r\n      this.onPauseTrack(trackId);\r\n    });\r\n\r\n    tracks.on('click', '.ase-btn-stop', (event) => {\r\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\r\n      this.onStopTrack(trackId);\r\n    });\r\n\r\n    tracks.on('click', '.ase-btn-remove', (event) => {\r\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\r\n      this.onRemoveTrack(trackId);\r\n    });\r\n\r\n    tracks.on('change', '.ase-loop-toggle', (event) => {\r\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\r\n      const loop = (event.target as HTMLInputElement).checked;\r\n      this.engine.setTrackLoop(trackId, loop);\r\n      this.socket.broadcastTrackLoop(trackId, loop);\r\n    });\r\n\r\n    tracks.on('change', '.ase-channel-select', (event) => {\r\n      const trackId = $(event.currentTarget).data('track-id') as string;\r\n      const channel = (event.target as HTMLSelectElement).value as TrackGroup;\r\n      this.engine.setTrackChannel(trackId, channel);\r\n    });\r\n\r\n    // Volume slider\r\n    const throttledVolume = throttle((trackId: string, value: number) => {\r\n      this.engine.setTrackVolume(trackId, value);\r\n      this.socket.broadcastTrackVolume(trackId, value);\r\n    }, 50);\r\n\r\n    tracks.on('input', '.ase-volume-slider', (event) => {\r\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\r\n      const value = parseFloat((event.target as HTMLInputElement).value) / 100;\r\n      throttledVolume(trackId, value);\r\n      $(event.currentTarget).siblings('.ase-volume-value').text(`${Math.round(value * 100)}%`);\r\n    });\r\n\r\n    // Seek slider\r\n    const throttledSeek = throttle((trackId: string, time: number) => {\r\n      const player = this.engine.getTrack(trackId);\r\n      const isPlaying = player?.state === 'playing';\r\n      this.engine.seekTrack(trackId, time);\r\n      this.socket.broadcastTrackSeek(trackId, time, isPlaying ?? false);\r\n    }, 100);\r\n\r\n    tracks.on('input', '.ase-seek-slider', (event) => {\r\n      const trackId = $(event.currentTarget).closest('.ase-track').data('track-id');\r\n      const player = this.engine.getTrack(trackId);\r\n      if (player) {\r\n        const percent = parseFloat((event.target as HTMLInputElement).value);\r\n        const time = (percent / 100) * player.getDuration();\r\n        throttledSeek(trackId, time);\r\n      }\r\n    });\r\n\r\n    // Stop all\r\n    html.find('#ase-stop-all').on('click', () => {\r\n      this.engine.stopAll();\r\n      this.socket.broadcastStopAll();\r\n      this.render();\r\n    });\r\n\r\n    this.startUpdates();\r\n  }\r\n\r\n  private updateSyncIndicator(html: JQuery, enabled: boolean): void {\r\n    const indicator = html.find('.ase-sync-status');\r\n    indicator.toggleClass('is-active', enabled);\r\n    indicator.find('span').text(enabled ? 'SYNC ON' : 'SYNC OFF');\r\n  }\r\n\r\n  private startUpdates(): void {\r\n    this.stopUpdates();\r\n    this.updateInterval = setInterval(() => {\r\n      this.updateTrackDisplays();\r\n    }, 250);\r\n  }\r\n\r\n  private stopUpdates(): void {\r\n    if (this.updateInterval) {\r\n      clearInterval(this.updateInterval);\r\n      this.updateInterval = null;\r\n    }\r\n  }\r\n\r\n  private updateTrackDisplays(): void {\r\n    const html = this.element;\r\n    if (!html || !html.length) return;\r\n\r\n    let playingCount = 0;\r\n\r\n    for (const player of this.engine.getAllTracks()) {\r\n      const trackEl = html.find(`.ase-track[data-track-id=\"${player.id}\"]`);\r\n      if (!trackEl.length) continue;\r\n\r\n      const currentTime = player.getCurrentTime();\r\n      const duration = player.getDuration();\r\n      const progress = duration > 0 ? (currentTime / duration) * 100 : 0;\r\n      const state = player.state;\r\n\r\n      if (state === 'playing') playingCount++;\r\n\r\n      trackEl.find('.ase-time-current').text(formatTime(currentTime));\r\n      \r\n      const seekSlider = trackEl.find('.ase-seek-slider');\r\n      if (!seekSlider.is(':active')) {\r\n        seekSlider.val(progress);\r\n      }\r\n\r\n      trackEl.removeClass('is-playing is-paused is-stopped is-loading');\r\n      trackEl.addClass(`is-${state}`);\r\n      \r\n      trackEl.find('.ase-btn-play').prop('disabled', state === 'playing' || state === 'loading');\r\n      trackEl.find('.ase-btn-pause').prop('disabled', state !== 'playing');\r\n      trackEl.find('.ase-btn-stop').prop('disabled', state === 'stopped');\r\n    }\r\n\r\n    const totalTracks = this.engine.getAllTracks().length;\r\n    html.find('.ase-track-count').text(`${playingCount}/${totalTracks} playing`);\r\n  }\r\n\r\n  private async onAddTrack(): Promise<void> {\r\n    const fp = new FilePicker({\r\n      type: 'audio',\r\n      current: '',\r\n      callback: async (path: string) => {\r\n        await this.addTrackFromPath(path);\r\n      }\r\n    });\r\n    fp.render(true);\r\n  }\r\n\r\n  async addTrackFromPath(path: string, group: TrackGroup = 'music'): Promise<void> {\r\n    const trackId = generateUUID();\r\n\r\n    try {\r\n      await this.engine.createTrack({\r\n        id: trackId,\r\n        url: path,\r\n        group,\r\n        volume: 1,\r\n        loop: false\r\n      });\r\n\r\n      this.render();\r\n      ui.notifications?.info(`Added: ${this.extractFileName(path)}`);\r\n\r\n    } catch (error) {\r\n      Logger.error('Failed to add track:', error);\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      ui.notifications?.error(`Failed to load: ${errorMessage}`);\r\n    }\r\n  }\r\n\r\n  private async onPlayTrack(trackId: string): Promise<void> {\r\n    const player = this.engine.getTrack(trackId);\r\n    if (!player) return;\r\n\r\n    const offset = player.state === 'paused' ? player.getCurrentTime() : 0;\r\n    await this.engine.playTrack(trackId, offset);\r\n    this.socket.broadcastTrackPlay(trackId, offset);\r\n  }\r\n\r\n  private onPauseTrack(trackId: string): void {\r\n    const player = this.engine.getTrack(trackId);\r\n    if (!player) return;\r\n    \r\n    const pausedAt = player.getCurrentTime();\r\n    this.engine.pauseTrack(trackId);\r\n    this.socket.broadcastTrackPause(trackId, pausedAt);\r\n  }\r\n\r\n  private onStopTrack(trackId: string): void {\r\n    this.engine.stopTrack(trackId);\r\n    this.socket.broadcastTrackStop(trackId);\r\n  }\r\n\r\n  private onRemoveTrack(trackId: string): void {\r\n    this.engine.removeTrack(trackId);\r\n    this.render();\r\n  }\r\n\r\n  override close(options?: Application.CloseOptions): Promise<void> {\r\n    this.stopUpdates();\r\n    return super.close(options);\r\n  }\r\n}","import { AudioEngine } from '@core/AudioEngine';\r\nimport { SocketManager } from '@sync/SocketManager';\r\nimport { LibraryManager } from '@lib/LibraryManager';\r\nimport { LocalLibraryApp } from './LocalLibraryApp';\r\nimport { SoundMixerApp } from './SoundMixerApp';\r\nimport { Logger } from '@utils/logger';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\n\r\ninterface AppState {\r\n    activeTab: 'mixer' | 'library' | 'online' | 'sfx';\r\n    syncEnabled: boolean;\r\n}\r\n\r\nexport class AdvancedSoundEngineApp extends Application {\r\n    private engine: AudioEngine;\r\n    private socket: SocketManager;\r\n    private libraryManager: LibraryManager;\r\n\r\n    // Sub-apps (Controllers)\r\n    private libraryApp: LocalLibraryApp;\r\n    private mixerApp: SoundMixerApp; // We might need to refactor this later, but for now we'll wrap it\r\n\r\n    private state: AppState = {\r\n        activeTab: 'library', // Default to library as per user focus\r\n        syncEnabled: false\r\n    };\r\n\r\n    constructor(engine: AudioEngine, socket: SocketManager, libraryManager: LibraryManager, options?: Partial<ApplicationOptions>) {\r\n        super(options);\r\n        this.engine = engine;\r\n        this.socket = socket;\r\n        this.libraryManager = libraryManager;\r\n\r\n        // Initialize sub-controllers\r\n        // Note: We pass this app instance or handle delegation\r\n        this.libraryApp = new LocalLibraryApp(this.libraryManager);\r\n        this.mixerApp = new SoundMixerApp(this.engine, this.socket);\r\n    }\r\n\r\n    static override get defaultOptions(): ApplicationOptions {\r\n        return foundry.utils.mergeObject(super.defaultOptions, {\r\n            id: 'advanced-sound-engine-app',\r\n            title: 'Advanced Sound Engine',\r\n            template: `modules/${MODULE_ID}/templates/main-app.hbs`,\r\n            width: 1200, // Wider for the concepts\r\n            height: 800,\r\n            classes: ['ase-window-layout'],\r\n            resizable: true,\r\n            popOut: true,\r\n            tabs: [] // We handle tabs manually\r\n        }) as ApplicationOptions;\r\n    }\r\n\r\n    override async getData(): Promise<any> {\r\n        const volumes = this.engine.volumes;\r\n\r\n        // Get content for the active tab\r\n        // This is a bit tricky with Handlebars. We need to render the sub-template to a string.\r\n        let tabContent = '';\r\n\r\n        if (this.state.activeTab === 'library') {\r\n            // We need to get the data from the library app and render its template\r\n            const libData = await this.libraryApp.getData();\r\n            tabContent = await renderTemplate('modules/advanced-sound-engine/templates/library.hbs', libData);\r\n        } else if (this.state.activeTab === 'mixer') {\r\n            const mixerData = await this.mixerApp.getData();\r\n            tabContent = await renderTemplate(`modules/${MODULE_ID}/templates/mixer.hbs`, mixerData);\r\n        }\r\n\r\n        return {\r\n            activeTab: this.state.activeTab,\r\n            tabContent,\r\n            volumes: {\r\n                master: Math.round(volumes.master * 100)\r\n            },\r\n            syncEnabled: this.socket.syncEnabled\r\n        };\r\n    }\r\n\r\n    override activateListeners(html: JQuery): void {\r\n        super.activateListeners(html);\r\n\r\n        // Tab Navigation\r\n        html.find('.ase-nav-tab').on('click', this.onTabSwitch.bind(this));\r\n\r\n        // Footer Controls (A7)\r\n        html.find('[data-action=\"toggle-sync\"]').on('click', this.onToggleSync.bind(this));\r\n        html.find('[data-action=\"global-play\"]').on('click', this.onGlobalPlay.bind(this));\r\n        html.find('[data-action=\"global-pause\"]').on('click', this.onGlobalPause.bind(this));\r\n        html.find('[data-action=\"global-stop\"]').on('click', this.onGlobalStop.bind(this));\r\n\r\n        // Master Volume\r\n        html.find('.master-slider').on('input', this.onMasterVolumeInput.bind(this));\r\n\r\n        // Delegate listeners to sub-apps\r\n        if (this.state.activeTab === 'library') {\r\n            this.libraryApp.activateListeners(html); // CAUTION: This might attach listeners to the whole window.\r\n            // LocalLibraryApp needs to be careful not to rely on `this.element` being the root if it assumes specific scoping.\r\n            // Since we inject the HTML, `html` here covers the whole window. `LocalLibraryApp` selectors should be specific enough.\r\n        } else if (this.state.activeTab === 'mixer') {\r\n            this.mixerApp.activateListeners(html);\r\n        }\r\n    }\r\n\r\n    private async onTabSwitch(event: JQuery.ClickEvent): Promise<void> {\r\n        event.preventDefault();\r\n        const tabName = $(event.currentTarget).data('tab');\r\n        if (this.state.activeTab === tabName) return;\r\n\r\n        this.state.activeTab = tabName;\r\n        this.render(true); // Re-render the whole app to switch tabs\r\n    }\r\n\r\n    // Footer Actions\r\n    private onToggleSync(event: JQuery.ClickEvent): void {\r\n        const enabled = !this.socket.syncEnabled;\r\n        this.socket.setSyncEnabled(enabled);\r\n        this.state.syncEnabled = enabled;\r\n\r\n        // Update UI partially if possible, or re-render\r\n        const btn = $(event.currentTarget);\r\n        btn.toggleClass('active', enabled);\r\n        btn.find('.sync-text').text(`SYNC ${enabled ? 'ON' : 'OFF'}`);\r\n    }\r\n\r\n    private onGlobalPlay(): void {\r\n        // Resume audio context if needed\r\n        this.engine.resume();\r\n        // For now, this might just unpause the active tracks?\r\n        // Concept: \"Play\" button in footer usually resumes playback of the active playlist/queue\r\n        // If nothing is playing, it might do nothing.\r\n        // For now, let's treat it as \"Resume All\"\r\n        // TODO: Implement queue logic\r\n        Logger.debug('Global Play Clicked');\r\n    }\r\n\r\n    private onGlobalPause(): void {\r\n        // Pause all\r\n        // this.engine.pauseAll(); // Assuming engine has this?\r\n        Logger.debug('Global Pause Clicked');\r\n    }\r\n\r\n    private onGlobalStop(): void {\r\n        this.engine.stopAll();\r\n        // this.socket.broadcastStopAll(); // Logic handled in SoundMixerApp usually\r\n        this.render(); // Update UI\r\n    }\r\n\r\n    private onMasterVolumeInput(event: JQuery.TriggeredEvent): void {\r\n        const value = parseFloat((event.target as HTMLInputElement).value) / 100;\r\n        this.engine.setMasterVolume(value);\r\n        this.socket.broadcastChannelVolume('master', value);\r\n        $(event.currentTarget).siblings('.value-text').text(`${Math.round(value * 100)}%`);\r\n    }\r\n}\r\n","import type { Playlist, PlaylistItem } from '@t/library';\r\nimport type { TrackGroup } from '@t/audio';\r\nimport { generateUUID } from '@utils/uuid';\r\nimport { Logger } from '@utils/logger';\r\n\r\nexport class PlaylistManager {\r\n  private playlists: Map<string, Playlist> = new Map();\r\n  private onChangeCallback?: () => void;\r\n\r\n  constructor(onChangeCallback?: () => void) {\r\n    this.onChangeCallback = onChangeCallback;\r\n  }\r\n\r\n  /**\r\n   * Notify about changes (triggers save)\r\n   */\r\n  private notifyChange(): void {\r\n    if (this.onChangeCallback) {\r\n      this.onChangeCallback();\r\n    }\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // CRUD Operations - Playlists\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  /**\r\n   * Create new playlist\r\n   */\r\n  createPlaylist(name: string, description?: string): Playlist {\r\n    // Check for duplicate names\r\n    const existing = this.findByName(name);\r\n    if (existing) {\r\n      throw new Error(`Playlist with name \"${name}\" already exists`);\r\n    }\r\n\r\n    const now = Date.now();\r\n    const playlist: Playlist = {\r\n      id: generateUUID(),\r\n      name,\r\n      description,\r\n      items: [],\r\n      createdAt: now,\r\n      updatedAt: now,\r\n      favorite: false\r\n    };\r\n\r\n    this.playlists.set(playlist.id, playlist);\r\n    this.notifyChange();\r\n    Logger.info(`Playlist created: ${playlist.name} (${playlist.id})`);\r\n\r\n    return playlist;\r\n  }\r\n\r\n  /**\r\n   * Update playlist metadata\r\n   */\r\n  updatePlaylist(id: string, updates: Partial<Pick<Playlist, 'name' | 'description' | 'favorite'>>): Playlist {\r\n    const playlist = this.playlists.get(id);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${id}`);\r\n    }\r\n\r\n    // Validate name uniqueness if changing name\r\n    if (updates.name && updates.name !== playlist.name) {\r\n      const existing = this.findByName(updates.name);\r\n      if (existing && existing.id !== id) {\r\n        throw new Error(`Playlist with name \"${updates.name}\" already exists`);\r\n      }\r\n    }\r\n\r\n    // Update playlist\r\n    const updated = {\r\n      ...playlist,\r\n      ...updates,\r\n      updatedAt: Date.now()\r\n    };\r\n\r\n    this.playlists.set(id, updated);\r\n    this.notifyChange();\r\n    Logger.info(`Playlist updated: ${updated.name}`);\r\n\r\n    return updated;\r\n  }\r\n\r\n  /**\r\n   * Delete playlist\r\n   */\r\n  deletePlaylist(id: string): void {\r\n    const playlist = this.playlists.get(id);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${id}`);\r\n    }\r\n\r\n    this.playlists.delete(id);\r\n    this.notifyChange();\r\n    Logger.info(`Playlist deleted: ${playlist.name}`);\r\n  }\r\n\r\n  /**\r\n   * Get playlist by ID\r\n   */\r\n  getPlaylist(id: string): Playlist | undefined {\r\n    return this.playlists.get(id);\r\n  }\r\n\r\n  /**\r\n   * Get all playlists\r\n   */\r\n  getAllPlaylists(): Playlist[] {\r\n    return Array.from(this.playlists.values());\r\n  }\r\n\r\n  /**\r\n   * Find playlist by name\r\n   */\r\n  findByName(name: string): Playlist | undefined {\r\n    return Array.from(this.playlists.values()).find(p => p.name === name);\r\n  }\r\n\r\n  /**\r\n   * Get favorite playlists\r\n   */\r\n  getFavoritePlaylists(): Playlist[] {\r\n    return this.getAllPlaylists().filter(p => p.favorite);\r\n  }\r\n\r\n  /**\r\n   * Toggle playlist favorite status\r\n   */\r\n  togglePlaylistFavorite(id: string): boolean {\r\n    const playlist = this.getPlaylist(id);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${id}`);\r\n    }\r\n\r\n    playlist.favorite = !playlist.favorite;\r\n    playlist.updatedAt = Date.now();\r\n    this.notifyChange();\r\n\r\n    return playlist.favorite;\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // CRUD Operations - Playlist Items\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  /**\r\n   * Add track to playlist\r\n   */\r\n  addTrackToPlaylist(\r\n    playlistId: string,\r\n    libraryItemId: string,\r\n    group: TrackGroup,\r\n    options?: Partial<Omit<PlaylistItem, 'id' | 'libraryItemId' | 'group' | 'order'>>\r\n  ): PlaylistItem {\r\n    const playlist = this.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${playlistId}`);\r\n    }\r\n\r\n    // Check if track already exists in playlist\r\n    const exists = playlist.items.find(item => item.libraryItemId === libraryItemId);\r\n    if (exists) {\r\n      throw new Error('Track already exists in this playlist');\r\n    }\r\n\r\n    // Create new playlist item\r\n    const item: PlaylistItem = {\r\n      id: generateUUID(),\r\n      libraryItemId,\r\n      group,\r\n      volume: options?.volume ?? 1.0,\r\n      loop: options?.loop ?? false,\r\n      order: playlist.items.length,\r\n      fadeIn: options?.fadeIn,\r\n      fadeOut: options?.fadeOut\r\n    };\r\n\r\n    playlist.items.push(item);\r\n    playlist.updatedAt = Date.now();\r\n    this.notifyChange();\r\n\r\n    Logger.debug(`Track added to playlist ${playlist.name}: ${libraryItemId}`);\r\n\r\n    return item;\r\n  }\r\n\r\n  /**\r\n   * Remove track from playlist\r\n   */\r\n  removeTrackFromPlaylist(playlistId: string, playlistItemId: string): void {\r\n    const playlist = this.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${playlistId}`);\r\n    }\r\n\r\n    const index = playlist.items.findIndex(item => item.id === playlistItemId);\r\n    if (index === -1) {\r\n      throw new Error(`Playlist item not found: ${playlistItemId}`);\r\n    }\r\n\r\n    playlist.items.splice(index, 1);\r\n\r\n    // Reorder remaining items\r\n    this.reorderPlaylistItems(playlist);\r\n\r\n    playlist.updatedAt = Date.now();\r\n    this.notifyChange();\r\n    Logger.debug(`Track removed from playlist ${playlist.name}`);\r\n  }\r\n\r\n  /**\r\n   * Remove all tracks with specific library item ID from playlist\r\n   */\r\n  removeLibraryItemFromPlaylist(playlistId: string, libraryItemId: string): number {\r\n    const playlist = this.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${playlistId}`);\r\n    }\r\n\r\n    const initialLength = playlist.items.length;\r\n    playlist.items = playlist.items.filter(item => item.libraryItemId !== libraryItemId);\r\n    const removed = initialLength - playlist.items.length;\r\n\r\n    if (removed > 0) {\r\n      this.reorderPlaylistItems(playlist);\r\n      playlist.updatedAt = Date.now();\r\n      this.notifyChange();\r\n      Logger.debug(`Removed ${removed} instances of library item ${libraryItemId} from playlist ${playlist.name}`);\r\n    }\r\n\r\n    return removed;\r\n  }\r\n\r\n  /**\r\n   * Remove library item from all playlists\r\n   */\r\n  removeLibraryItemFromAllPlaylists(libraryItemId: string): number {\r\n    let totalRemoved = 0;\r\n\r\n    this.playlists.forEach(playlist => {\r\n      const initialLength = playlist.items.length;\r\n      playlist.items = playlist.items.filter(item => item.libraryItemId !== libraryItemId);\r\n      const removed = initialLength - playlist.items.length;\r\n\r\n      if (removed > 0) {\r\n        this.reorderPlaylistItems(playlist);\r\n        playlist.updatedAt = Date.now();\r\n        totalRemoved += removed;\r\n      }\r\n    });\r\n\r\n    if (totalRemoved > 0) {\r\n      this.notifyChange();\r\n      Logger.info(`Removed library item ${libraryItemId} from ${totalRemoved} playlist(s)`);\r\n    }\r\n\r\n    return totalRemoved;\r\n  }\r\n\r\n  /**\r\n   * Update playlist item\r\n   */\r\n  updatePlaylistItem(\r\n    playlistId: string,\r\n    playlistItemId: string,\r\n    updates: Partial<Omit<PlaylistItem, 'id' | 'libraryItemId' | 'order'>>\r\n  ): PlaylistItem {\r\n    const playlist = this.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${playlistId}`);\r\n    }\r\n\r\n    const item = playlist.items.find(i => i.id === playlistItemId);\r\n    if (!item) {\r\n      throw new Error(`Playlist item not found: ${playlistItemId}`);\r\n    }\r\n\r\n    // Update item\r\n    Object.assign(item, updates);\r\n    playlist.updatedAt = Date.now();\r\n    this.notifyChange();\r\n\r\n    Logger.debug(`Playlist item updated in ${playlist.name}`);\r\n\r\n    return item;\r\n  }\r\n\r\n  /**\r\n   * Reorder track in playlist\r\n   */\r\n  reorderTrack(playlistId: string, playlistItemId: string, newOrder: number): void {\r\n    const playlist = this.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${playlistId}`);\r\n    }\r\n\r\n    const itemIndex = playlist.items.findIndex(i => i.id === playlistItemId);\r\n    if (itemIndex === -1) {\r\n      throw new Error(`Playlist item not found: ${playlistItemId}`);\r\n    }\r\n\r\n    // Validate new order\r\n    if (newOrder < 0 || newOrder >= playlist.items.length) {\r\n      throw new Error(`Invalid order: ${newOrder}`);\r\n    }\r\n\r\n    // Remove item from current position\r\n    const [item] = playlist.items.splice(itemIndex, 1);\r\n\r\n    // Insert at new position\r\n    playlist.items.splice(newOrder, 0, item);\r\n\r\n    // Reorder all items\r\n    this.reorderPlaylistItems(playlist);\r\n\r\n    playlist.updatedAt = Date.now();\r\n    this.notifyChange();\r\n    Logger.debug(`Track reordered in playlist ${playlist.name}`);\r\n  }\r\n\r\n  /**\r\n   * Get tracks in playlist\r\n   */\r\n  getPlaylistTracks(playlistId: string): PlaylistItem[] {\r\n    const playlist = this.getPlaylist(playlistId);\r\n    if (!playlist) {\r\n      throw new Error(`Playlist not found: ${playlistId}`);\r\n    }\r\n\r\n    return [...playlist.items].sort((a, b) => a.order - b.order);\r\n  }\r\n\r\n  /**\r\n   * Get playlists containing a specific library item\r\n   */\r\n  getPlaylistsContainingItem(libraryItemId: string): Playlist[] {\r\n    return this.getAllPlaylists().filter(playlist =>\r\n      playlist.items.some(item => item.libraryItemId === libraryItemId)\r\n    );\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Persistence\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  /**\r\n   * Load playlists from state object\r\n   */\r\n  load(playlistsData: Record<string, Playlist>): void {\r\n    this.playlists.clear();\r\n\r\n    Object.values(playlistsData).forEach(playlist => {\r\n      // Ensure items are properly ordered\r\n      playlist.items.sort((a, b) => a.order - b.order);\r\n      this.playlists.set(playlist.id, playlist);\r\n    });\r\n\r\n    Logger.info(`PlaylistManager loaded: ${this.playlists.size} playlists`);\r\n  }\r\n\r\n  /**\r\n   * Export playlists to state object\r\n   */\r\n  export(): Record<string, Playlist> {\r\n    return Object.fromEntries(this.playlists);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Utilities\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  /**\r\n   * Reorder playlist items to ensure consecutive order values\r\n   */\r\n  private reorderPlaylistItems(playlist: Playlist): void {\r\n    playlist.items.forEach((item, index) => {\r\n      item.order = index;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get statistics\r\n   */\r\n  getStats() {\r\n    const playlists = this.getAllPlaylists();\r\n    return {\r\n      totalPlaylists: playlists.length,\r\n      favoritePlaylists: playlists.filter(p => p.favorite).length,\r\n      totalTracks: playlists.reduce((sum, p) => sum + p.items.length, 0),\r\n      averageTracksPerPlaylist: playlists.length > 0\r\n        ? Math.round(playlists.reduce((sum, p) => sum + p.items.length, 0) / playlists.length)\r\n        : 0\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Clear all playlists\r\n   */\r\n  clear(): void {\r\n    this.playlists.clear();\r\n    Logger.warn('All playlists cleared');\r\n  }\r\n}\r\n","import type { LibraryItem, LibraryState } from '@t/library';\r\nimport type { TrackGroup } from '@t/audio';\r\nimport { generateUUID } from '@utils/uuid';\r\nimport { validateAudioFile } from '@utils/audio-validation';\r\nimport { Logger } from '@utils/logger';\r\nimport { debounce } from '@utils/throttle';\r\nimport { PlaylistManager } from './PlaylistManager';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\nconst LIBRARY_VERSION = 1;\r\n\r\nexport class LibraryManager {\r\n  private items: Map<string, LibraryItem> = new Map();\r\n  private saveScheduled = false;\r\n  public readonly playlists: PlaylistManager;\r\n\r\n  private debouncedSave = debounce(() => {\r\n    this.saveToSettings();\r\n  }, 500);\r\n\r\n  constructor() {\r\n    this.playlists = new PlaylistManager(() => this.scheduleSave());\r\n    this.loadFromSettings();\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // CRUD Operations\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  /**\r\n   * Add new item to library\r\n   */\r\n  async addItem(url: string, name?: string, group: TrackGroup = 'music'): Promise<LibraryItem> {\r\n    // Validate audio format\r\n    const validation = validateAudioFile(url);\r\n    if (!validation.valid) {\r\n      throw new Error(validation.error || 'Invalid audio file');\r\n    }\r\n\r\n    // Generate name from filename if not provided\r\n    const itemName = name || this.extractNameFromUrl(url);\r\n\r\n    // Check for duplicates by URL\r\n    const existingByUrl = this.findByUrl(url);\r\n    if (existingByUrl) {\r\n      throw new Error(`Track with this URL already exists: ${existingByUrl.name}`);\r\n    }\r\n\r\n    // Check for duplicates by name\r\n    const existingByName = this.findByName(itemName);\r\n    if (existingByName) {\r\n      throw new Error(`Track with name \"${itemName}\" already exists in library`);\r\n    }\r\n\r\n    const now = Date.now();\r\n    const item: LibraryItem = {\r\n      id: generateUUID(),\r\n      url,\r\n      name: itemName,\r\n      tags: [],\r\n      duration: 0,\r\n      favorite: false,\r\n      addedAt: now,\r\n      updatedAt: now\r\n    };\r\n\r\n    this.items.set(item.id, item);\r\n    this.scheduleSave();\r\n\r\n    Logger.info(`Library item added: ${item.name} (${item.id})`);\r\n    return item;\r\n  }\r\n\r\n  /**\r\n   * Update existing item\r\n   */\r\n  updateItem(id: string, updates: Partial<LibraryItem>): LibraryItem {\r\n    const item = this.items.get(id);\r\n    if (!item) {\r\n      throw new Error(`Library item not found: ${id}`);\r\n    }\r\n\r\n    // Validate name uniqueness if changing name\r\n    if (updates.name && updates.name !== item.name) {\r\n      const existingByName = this.findByName(updates.name);\r\n      if (existingByName && existingByName.id !== id) {\r\n        throw new Error(`Track with name \"${updates.name}\" already exists`);\r\n      }\r\n    }\r\n\r\n    // Validate URL uniqueness if changing URL\r\n    if (updates.url && updates.url !== item.url) {\r\n      const validation = validateAudioFile(updates.url);\r\n      if (!validation.valid) {\r\n        throw new Error(validation.error || 'Invalid audio file');\r\n      }\r\n\r\n      const existingByUrl = this.findByUrl(updates.url);\r\n      if (existingByUrl && existingByUrl.id !== id) {\r\n        throw new Error(`Track with this URL already exists: ${existingByUrl.name}`);\r\n      }\r\n    }\r\n\r\n    // Prevent ID change\r\n    delete updates.id;\r\n\r\n    // Update item\r\n    const updated = {\r\n      ...item,\r\n      ...updates,\r\n      updatedAt: Date.now()\r\n    };\r\n\r\n    this.items.set(id, updated);\r\n    this.scheduleSave();\r\n\r\n    Logger.info(`Library item updated: ${updated.name}`);\r\n    return updated;\r\n  }\r\n\r\n  /**\r\n   * Remove item from library\r\n   */\r\n  removeItem(id: string): void {\r\n    const item = this.items.get(id);\r\n    if (!item) {\r\n      throw new Error(`Library item not found: ${id}`);\r\n    }\r\n\r\n    // Remove from all playlists first\r\n    this.playlists.removeLibraryItemFromAllPlaylists(id);\r\n\r\n    this.items.delete(id);\r\n    this.scheduleSave();\r\n\r\n    Logger.info(`Library item removed: ${item.name}`);\r\n  }\r\n\r\n  /**\r\n   * Get item by ID\r\n   */\r\n  getItem(id: string): LibraryItem | undefined {\r\n    return this.items.get(id);\r\n  }\r\n\r\n  /**\r\n   * Get all items\r\n   */\r\n  getAllItems(): LibraryItem[] {\r\n    return Array.from(this.items.values());\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Search & Filter\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  /**\r\n   * Find item by URL\r\n   */\r\n  findByUrl(url: string): LibraryItem | undefined {\r\n    return Array.from(this.items.values()).find(item => item.url === url);\r\n  }\r\n\r\n  /**\r\n   * Find item by name\r\n   */\r\n  findByName(name: string): LibraryItem | undefined {\r\n    return Array.from(this.items.values()).find(item => item.name === name);\r\n  }\r\n\r\n  /**\r\n   * Search items by query\r\n   */\r\n  searchByName(query: string): LibraryItem[] {\r\n    const lowerQuery = query.toLowerCase();\r\n    return this.getAllItems().filter(item =>\r\n      item.name.toLowerCase().includes(lowerQuery)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Filter items by tags (OR logic)\r\n   */\r\n  filterByTags(tags: string[]): LibraryItem[] {\r\n    if (tags.length === 0) return this.getAllItems();\r\n\r\n    return this.getAllItems().filter(item =>\r\n      item.tags.some(tag => tags.includes(tag))\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get favorite items\r\n   */\r\n  getFavorites(): LibraryItem[] {\r\n    return this.getAllItems().filter(item => item.favorite);\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Tags Management\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  /**\r\n   * Get all unique tags\r\n   */\r\n  getAllTags(): string[] {\r\n    const tagSet = new Set<string>();\r\n    this.items.forEach(item => {\r\n      item.tags.forEach(tag => tagSet.add(tag));\r\n    });\r\n    return Array.from(tagSet).sort();\r\n  }\r\n\r\n  /**\r\n   * Add tag to item\r\n   */\r\n  addTagToItem(itemId: string, tag: string): void {\r\n    const item = this.getItem(itemId);\r\n    if (!item) {\r\n      throw new Error(`Library item not found: ${itemId}`);\r\n    }\r\n\r\n    if (!item.tags.includes(tag)) {\r\n      item.tags.push(tag);\r\n      item.updatedAt = Date.now();\r\n      this.scheduleSave();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove tag from item\r\n   */\r\n  removeTagFromItem(itemId: string, tag: string): void {\r\n    const item = this.getItem(itemId);\r\n    if (!item) {\r\n      throw new Error(`Library item not found: ${itemId}`);\r\n    }\r\n\r\n    const index = item.tags.indexOf(tag);\r\n    if (index !== -1) {\r\n      item.tags.splice(index, 1);\r\n      item.updatedAt = Date.now();\r\n      this.scheduleSave();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Rename tag globally\r\n   */\r\n  renameTag(oldTag: string, newTag: string): number {\r\n    let count = 0;\r\n    this.items.forEach(item => {\r\n      const index = item.tags.indexOf(oldTag);\r\n      if (index !== -1) {\r\n        item.tags[index] = newTag;\r\n        item.updatedAt = Date.now();\r\n        count++;\r\n      }\r\n    });\r\n\r\n    if (count > 0) {\r\n      this.scheduleSave();\r\n      Logger.info(`Tag renamed: \"${oldTag}\" → \"${newTag}\" (${count} items)`);\r\n    }\r\n\r\n    return count;\r\n  }\r\n\r\n  /**\r\n   * Delete tag globally\r\n   */\r\n  deleteTag(tag: string): number {\r\n    let count = 0;\r\n    this.items.forEach(item => {\r\n      const index = item.tags.indexOf(tag);\r\n      if (index !== -1) {\r\n        item.tags.splice(index, 1);\r\n        item.updatedAt = Date.now();\r\n        count++;\r\n      }\r\n    });\r\n\r\n    if (count > 0) {\r\n      this.scheduleSave();\r\n      Logger.info(`Tag deleted: \"${tag}\" (${count} items)`);\r\n    }\r\n\r\n    return count;\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Favorites\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  /**\r\n   * Toggle favorite status\r\n   */\r\n  toggleFavorite(itemId: string): boolean {\r\n    const item = this.getItem(itemId);\r\n    if (!item) {\r\n      throw new Error(`Library item not found: ${itemId}`);\r\n    }\r\n\r\n    item.favorite = !item.favorite;\r\n    item.updatedAt = Date.now();\r\n    this.scheduleSave();\r\n\r\n    return item.favorite;\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Persistence\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private loadFromSettings(): void {\r\n    try {\r\n      const saved = game.settings.get(MODULE_ID, 'libraryState') as string;\r\n      if (!saved) {\r\n        Logger.info('No saved library state, starting fresh');\r\n        return;\r\n      }\r\n\r\n      const state: LibraryState = JSON.parse(saved);\r\n\r\n      // Migrate if needed\r\n      if (state.version !== LIBRARY_VERSION) {\r\n        Logger.warn(`Library version mismatch: ${state.version} → ${LIBRARY_VERSION}`);\r\n        // Add migration logic here if needed\r\n      }\r\n\r\n      // Load items\r\n      this.items.clear();\r\n      Object.values(state.items).forEach(item => {\r\n        this.items.set(item.id, item);\r\n      });\r\n\r\n      // Load playlists\r\n      this.playlists.load(state.playlists || {});\r\n\r\n      Logger.info(`Library loaded: ${this.items.size} items, ${this.playlists.getAllPlaylists().length} playlists`);\r\n    } catch (error) {\r\n      Logger.error('Failed to load library state:', error);\r\n    }\r\n  }\r\n\r\n  private saveToSettings(): void {\r\n    try {\r\n      const state: LibraryState = {\r\n        items: Object.fromEntries(this.items),\r\n        playlists: this.playlists.export(),\r\n        version: LIBRARY_VERSION,\r\n        lastModified: Date.now()\r\n      };\r\n\r\n      game.settings.set(MODULE_ID, 'libraryState', JSON.stringify(state));\r\n      this.saveScheduled = false;\r\n\r\n      Logger.debug(`Library saved: ${this.items.size} items, ${this.playlists.getAllPlaylists().length} playlists`);\r\n    } catch (error) {\r\n      Logger.error('Failed to save library state:', error);\r\n    }\r\n  }\r\n\r\n  private scheduleSave(): void {\r\n    this.debouncedSave();\r\n  }\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // Utilities\r\n  // ─────────────────────────────────────────────────────────────\r\n\r\n  private extractNameFromUrl(url: string): string {\r\n    try {\r\n      const decoded = decodeURIComponent(url);\r\n      const parts = decoded.split('/');\r\n      const filename = parts[parts.length - 1];\r\n      return filename.replace(/\\.[^.]+$/, ''); // Remove extension\r\n    } catch {\r\n      return 'Unknown Track';\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get library statistics\r\n   */\r\n  getStats() {\r\n    const items = this.getAllItems();\r\n    const playlistStats = this.playlists.getStats();\r\n\r\n    return {\r\n      totalItems: items.length,\r\n      favoriteItems: items.filter(i => i.favorite).length,\r\n      totalDuration: items.reduce((sum, i) => sum + i.duration, 0),\r\n      tagCount: this.getAllTags().length,\r\n      playlists: playlistStats.totalPlaylists\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Clear all library data\r\n   */\r\n  clear(): void {\r\n    this.items.clear();\r\n    this.playlists.clear();\r\n    this.scheduleSave();\r\n    Logger.warn('Library cleared');\r\n  }\r\n\r\n  /**\r\n   * Dispose resources\r\n   */\r\n  dispose(): void {\r\n    // Save immediately before disposing\r\n    if (this.saveScheduled) {\r\n      this.saveToSettings();\r\n    }\r\n  }\r\n}\r\n","import '../styles/sound-engine.scss';\r\nimport { AudioEngine } from '@core/AudioEngine';\r\nimport { PlayerAudioEngine } from '@core/PlayerAudioEngine';\r\nimport { SocketManager } from '@sync/SocketManager';\r\nimport { SoundMixerApp } from '@ui/SoundMixerApp';\r\nimport { PlayerVolumePanel } from '@ui/PlayerVolumePanel';\r\nimport { LocalLibraryApp } from '@ui/LocalLibraryApp';\r\nimport { AdvancedSoundEngineApp } from '@ui/AdvancedSoundEngineApp';\r\nimport { LibraryManager } from '@lib/LibraryManager';\r\nimport { Logger } from '@utils/logger';\r\n\r\nconst MODULE_ID = 'advanced-sound-engine';\r\n\r\n// GM\r\n// GM\r\nlet gmEngine: AudioEngine | null = null;\r\nlet mainApp: AdvancedSoundEngineApp | null = null;\r\nlet libraryManager: LibraryManager | null = null;\r\n\r\n// Player\r\nlet playerEngine: PlayerAudioEngine | null = null;\r\nlet volumePanel: PlayerVolumePanel | null = null;\r\n\r\n// Shared\r\nlet socketManager: SocketManager | null = null;\r\n\r\ndeclare global {\r\n  interface Window {\r\n    ASE: {\r\n      isGM: boolean;\r\n      openPanel: (tab?: string) => void;\r\n      openLibrary?: () => void;\r\n      engine?: AudioEngine | PlayerAudioEngine;\r\n      socket?: SocketManager;\r\n      library?: LibraryManager;\r\n    };\r\n  }\r\n}\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// Control Button (в начале файла, после импортов)\r\n// ─────────────────────────────────────────────────────────────\r\n\r\nHooks.on('getSceneControlButtons', (controls: Record<string, any>) => {\r\n  console.log('ASE: Hook fired', controls);\r\n\r\n  const isGM = game.user?.isGM ?? false;\r\n\r\n  const tools: Record<string, any> = {\r\n    'open-panel': {\r\n      name: 'open-panel',\r\n      title: isGM ? 'Sound Mixer' : 'Sound Volume',\r\n      icon: isGM ? 'fas fa-sliders-h' : 'fas fa-volume-up',\r\n      button: true,\r\n      onClick: () => window.ASE?.openPanel()\r\n    }\r\n  };\r\n\r\n  // Add library button for GM (Shortcut to Library Tab)\r\n  if (isGM) {\r\n    tools['open-library'] = {\r\n      name: 'open-library',\r\n      title: 'Sound Library',\r\n      icon: 'fas fa-book',\r\n      button: true,\r\n      onClick: () => window.ASE?.openPanel('library')\r\n    };\r\n  }\r\n\r\n  controls['advanced-sound-engine'] = {\r\n    name: 'advanced-sound-engine',\r\n    title: isGM ? 'Advanced Sound Engine' : 'Sound Volume',\r\n    icon: isGM ? 'fas fa-sliders-h' : 'fas fa-volume-up',\r\n    visible: true,\r\n    tools\r\n  };\r\n});\r\n// ─────────────────────────────────────────────────────────────\r\n// Initialization\r\n// ─────────────────────────────────────────────────────────────\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// Handlebars Helpers\r\n// ─────────────────────────────────────────────────────────────\r\n\r\nfunction registerHandlebarsHelpers(): void {\r\n  // Format duration from seconds to MM:SS\r\n  Handlebars.registerHelper('formatDuration', (seconds: number): string => {\r\n    if (!seconds || seconds <= 0) return '--:--';\r\n\r\n    const minutes = Math.floor(seconds / 60);\r\n    const secs = Math.floor(seconds % 60);\r\n    return `${minutes}:${secs.toString().padStart(2, '0')}`;\r\n  });\r\n\r\n  // Check equality (for {{#if (eq a b)}})\r\n  Handlebars.registerHelper('eq', (a: any, b: any): boolean => {\r\n    return a === b;\r\n  });\r\n}\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// Init Hooks\r\n// ─────────────────────────────────────────────────────────────\r\n\r\nHooks.once('init', () => {\r\n  Logger.info('Initializing Advanced Sound Engine...');\r\n  registerSettings();\r\n  registerHandlebarsHelpers();\r\n});\r\n\r\nHooks.once('ready', async () => {\r\n  const isGM = game.user?.isGM ?? false;\r\n  Logger.info(`Starting Advanced Sound Engine (${isGM ? 'GM' : 'Player'})...`);\r\n\r\n  socketManager = new SocketManager();\r\n\r\n  if (isGM) {\r\n    await initializeGM();\r\n  } else {\r\n    await initializePlayer();\r\n  }\r\n\r\n  window.ASE = {\r\n    isGM,\r\n    isGM,\r\n    openPanel: isGM ? openMainApp : openVolumePanel,\r\n    openLibrary: () => isGM && openMainApp('library'),\r\n    engine: isGM ? gmEngine ?? undefined : playerEngine ?? undefined,\r\n    socket: socketManager ?? undefined,\r\n    library: isGM ? libraryManager ?? undefined : undefined\r\n  };\r\n\r\n  setupAutoplayHandler();\r\n\r\n  Logger.info('Advanced Sound Engine ready');\r\n});\r\n\r\nasync function initializeGM(): Promise<void> {\r\n  libraryManager = new LibraryManager();\r\n  gmEngine = new AudioEngine();\r\n  socketManager!.initializeAsGM(gmEngine);\r\n\r\n  await gmEngine.loadSavedState();\r\n}\r\n\r\nasync function initializePlayer(): Promise<void> {\r\n  playerEngine = new PlayerAudioEngine();\r\n  socketManager!.initializeAsPlayer(playerEngine);\r\n\r\n  // Restore saved local volume\r\n  const savedVolume = PlayerVolumePanel.loadSavedVolume();\r\n  playerEngine.setLocalVolume(savedVolume);\r\n}\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// Panels\r\n// ─────────────────────────────────────────────────────────────\r\n\r\nfunction openMainApp(tab: 'mixer' | 'library' = 'mixer'): void {\r\n  if (!gmEngine || !socketManager || !libraryManager) return;\r\n\r\n  if (mainApp && mainApp.rendered) {\r\n    mainApp.bringToTop();\r\n    // Switch tab if needed (assuming public method or we re-render with state update)\r\n    // For now, simpler to just focus. Ideally mainApp.activateTab(tab)\r\n  } else {\r\n    mainApp = new AdvancedSoundEngineApp(gmEngine, socketManager, libraryManager);\r\n    mainApp.render(true);\r\n  }\r\n}\r\n\r\nfunction openVolumePanel(): void {\r\n  if (!playerEngine) return;\r\n\r\n  if (volumePanel && volumePanel.rendered) {\r\n    volumePanel.bringToTop();\r\n  } else {\r\n    volumePanel = new PlayerVolumePanel(playerEngine);\r\n    volumePanel.render(true);\r\n  }\r\n}\r\n\r\n// Old openLibrary removed/redirected\r\nfunction openLibrary(): void {\r\n  openMainApp('library');\r\n}\r\n\r\n\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// Autoplay Policy Handler\r\n// ─────────────────────────────────────────────────────────────\r\n\r\nfunction setupAutoplayHandler(): void {\r\n  const resumeAudio = () => {\r\n    gmEngine?.resume();\r\n    playerEngine?.resume();\r\n  };\r\n\r\n  document.addEventListener('click', resumeAudio, { once: true });\r\n  document.addEventListener('keydown', resumeAudio, { once: true });\r\n\r\n  Hooks.once('canvasReady', resumeAudio);\r\n}\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// Settings\r\n// ─────────────────────────────────────────────────────────────\r\n\r\nfunction registerSettings(): void {\r\n  game.settings.register(MODULE_ID, 'mixerState', {\r\n    name: 'Mixer State',\r\n    hint: 'Internal storage for mixer state',\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: ''\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'maxSimultaneousTracks', {\r\n    name: 'Maximum Simultaneous Tracks',\r\n    hint: 'Maximum number of tracks that can play simultaneously (1-32)',\r\n    scope: 'world',\r\n    config: true,\r\n    type: Number,\r\n    default: 16,\r\n    range: {\r\n      min: 1,\r\n      max: 32,\r\n      step: 1\r\n    }\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'libraryState', {\r\n    name: 'Library State',\r\n    hint: 'Internal storage for library items and playlists',\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: ''\r\n  });\r\n}\r\n\r\n// ─────────────────────────────────────────────────────────────\r\n// Cleanup\r\n// ─────────────────────────────────────────────────────────────\r\n\r\nHooks.once('closeGame', () => {\r\n  mainApp?.close();\r\n  volumePanel?.close();\r\n  socketManager?.dispose();\r\n  gmEngine?.dispose();\r\n  playerEngine?.dispose();\r\n  libraryManager?.dispose();\r\n});"],"names":["PREFIX","Logger","message","args","_a","StreamingPlayer","id","ctx","channelOutput","group","__publicField","e","url","resolve","reject","onCanPlay","onError","offset","error","time","safeTime","value","newGroup","newOutput","getServerTime","formatTime","seconds","mins","secs","generateUUID","r","SUPPORTED_AUDIO_FORMATS","AUDIO_MIME_TYPES","isValidAudioFormat","extension","getFileExtension","match","getAudioMimeType","validateAudioFile","mimeType","MODULE_ID","getMaxSimultaneous","AudioEngine","state","savedJson","config","trackId","validation","player","maxSimultaneous","playingCount","t","volume","loop","channel","tracks","trackState","stateTrackIds","PlayerAudioEngine","safeValue","volumes","payload","elapsed","adjustedOffset","isPlaying","seekTimestamp","newTrackIds","adjustedTime","SOCKET_NAME","SocketManager","engine","enabled","startPayload","statePayload","playPayload","pausePayload","stopPayload","seekPayload","volPayload","loopPayload","chVolPayload","type","targetUserId","now","userId","pausedAt","PlayerVolumePanel","options","html","event","saved","LocalLibraryApp","library","items","playlists","allTags","stats","favoriteItems","favoritePlaylists","favorites","item","playlist","tags","tag","playlistsViewData","allChannelsSelected","hasActiveFilters","lowerTags","filtered","query","playlistItemIds","i","sorted","a","b","path","_b","errorMessage","itemId","isFavorite","name","playlistId","favoriteId","favoriteType","sortValue","tagName","_c","_d","selectedPlaylistId","trackElement","contextMenuEvent","playlistElement","files","li","newName","tagsString","newTags","description","playlistItem","index","libraryItem","content","oldTagName","newTagName","updatedTags","p","title","label","defaultValue","throttle","fn","delay","lastCall","timeoutId","remaining","debounce","SoundMixerApp","socket","currentTime","duration","parts","throttledChannelVolume","throttledVolume","throttledSeek","indicator","trackEl","progress","seekSlider","totalTracks","AdvancedSoundEngineApp","libraryManager","tabContent","libData","mixerData","tabName","btn","PlaylistManager","onChangeCallback","updates","existing","updated","libraryItemId","playlistItemId","initialLength","removed","totalRemoved","newOrder","itemIndex","playlistsData","sum","LIBRARY_VERSION","LibraryManager","itemName","existingByUrl","existingByName","lowerQuery","tagSet","oldTag","newTag","count","playlistStats","gmEngine","mainApp","playerEngine","volumePanel","socketManager","controls","isGM","tools","registerHandlebarsHelpers","minutes","registerSettings","initializeGM","initializePlayer","openMainApp","openVolumePanel","setupAutoplayHandler","savedVolume","tab","resumeAudio"],"mappings":";;;AAAA,MAAMA,IAAS,OAEFC,IAAS;AAAA,EACpB,MAAM,CAACC,MAAoBC,MAAoB;AAC7C,YAAQ,IAAI,GAAGH,CAAM,MAAME,CAAO,IAAI,GAAGC,CAAI;AAAA,EAC/C;AAAA,EAEA,MAAM,CAACD,MAAoBC,MAAoB;AAC7C,YAAQ,KAAK,GAAGH,CAAM,MAAME,CAAO,IAAI,GAAGC,CAAI;AAAA,EAChD;AAAA,EAEA,OAAO,CAACD,MAAoBC,MAAoB;AAC9C,YAAQ,MAAM,GAAGH,CAAM,MAAME,CAAO,IAAI,GAAGC,CAAI;AAAA,EACjD;AAAA,EAEA,OAAO,CAACD,MAAoBC,MAAoB;AAflD,QAAAC;AAgBI,KAAIA,IAAA,iCAAQ,UAAR,QAAAA,EAAe,SACjB,QAAQ,MAAM,GAAGJ,CAAM,MAAME,CAAO,IAAI,GAAGC,CAAI;AAAA,EAEnD;AACF;ACjBO,MAAME,EAAgB;AAAA,EAgB3B,YACEC,GACAC,GACAC,GACAC,IAAoB,SACpB;AApBO,IAAAC,EAAA;AACD,IAAAA,EAAA;AACA,IAAAA,EAAA;AACA,IAAAA,EAAA,cAAe;AAEf,IAAAA,EAAA;AACA,IAAAA,EAAA,oBAAiD;AACjD,IAAAA,EAAA;AACA,IAAAA,EAAA;AAEA,IAAAA,EAAA,gBAAwB;AACxB,IAAAA,EAAA,iBAAkB;AAClB,IAAAA,EAAA,eAAiB;AACjB,IAAAA,EAAA,gBAAkB;AAQxB,SAAK,KAAKJ,GACV,KAAK,MAAMC,GACX,KAAK,SAASE,GAEd,KAAK,QAAQ,IAAI,MAAA,GACjB,KAAK,MAAM,cAAc,aACzB,KAAK,MAAM,UAAU,QAErB,KAAK,WAAWF,EAAI,WAAA,GACpB,KAAK,aAAaA,EAAI,WAAA,GAEtB,KAAK,SAAS,QAAQ,KAAK,UAAU,GACrC,KAAK,WAAW,QAAQC,CAAa,GAErC,KAAK,iBAAA;AAAA,EACP;AAAA,EAEQ,mBAAyB;AAC/B,SAAK,MAAM,iBAAiB,WAAW,MAAM;AAC3C,WAAK,SAAS,IACV,KAAK,WAAW,cAClB,KAAK,SAAS,YAEhBP,EAAO,MAAM,SAAS,KAAK,EAAE,gBAAgB;AAAA,IAC/C,CAAC,GAED,KAAK,MAAM,iBAAiB,SAAS,MAAM;AACzC,MAAK,KAAK,UACR,KAAK,SAAS,WACdA,EAAO,MAAM,SAAS,KAAK,EAAE,QAAQ;AAAA,IAEzC,CAAC,GAED,KAAK,MAAM,iBAAiB,SAAS,CAACU,MAAM;AAC1C,MAAAV,EAAO,MAAM,SAAS,KAAK,EAAE,WAAW,KAAK,MAAM,KAAK,GACxD,KAAK,SAAS;AAAA,IAChB,CAAC;AAAA,EACH;AAAA,EAEA,IAAI,QAAuB;AACzB,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,IAAI,QAAoB;AACtB,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,IAAI,MAAc;AAChB,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,IAAI,SAAiB;AACnB,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,IAAI,OAAgB;AAClB,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,IAAI,QAAiB;AACnB,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,MAAM,KAAKW,GAA4B;AACrC,gBAAK,SAAS,WACd,KAAK,OAAOA,GACZ,KAAK,SAAS,IAEP,IAAI,QAAQ,CAACC,GAASC,MAAW;AACtC,YAAMC,IAAY,MAAM;AACtB,aAAK,MAAM,oBAAoB,WAAWA,CAAS,GACnD,KAAK,MAAM,oBAAoB,SAASC,CAAO,GAG1C,KAAK,eACR,KAAK,aAAa,KAAK,IAAI,yBAAyB,KAAK,KAAK,GAC9D,KAAK,WAAW,QAAQ,KAAK,QAAQ,IAGvC,KAAK,SAAS,IACd,KAAK,SAAS,WACdf,EAAO,MAAM,iBAAiB,KAAK,EAAE,EAAE,GACvCY,EAAA;AAAA,MACF,GAEMG,IAAU,MAAM;AACpB,aAAK,MAAM,oBAAoB,WAAWD,CAAS,GACnD,KAAK,MAAM,oBAAoB,SAASC,CAAO,GAC/C,KAAK,SAAS,WACdF,EAAO,IAAI,MAAM,mBAAmBF,CAAG,EAAE,CAAC;AAAA,MAC5C;AAEA,WAAK,MAAM,iBAAiB,WAAWG,GAAW,EAAE,MAAM,IAAM,GAChE,KAAK,MAAM,iBAAiB,SAASC,GAAS,EAAE,MAAM,IAAM,GAE5D,KAAK,MAAM,MAAMJ,GACjB,KAAK,MAAM,KAAA;AAAA,IACb,CAAC;AAAA,EACH;AAAA,EAEA,MAAM,KAAKK,IAAiB,GAAkB;AAC5C,QAAI,CAAC,KAAK,QAAQ;AAChB,MAAAhB,EAAO,KAAK,SAAS,KAAK,EAAE,YAAY;AACxC;AAAA,IACF;AAEA,QAAI;AACF,WAAK,MAAM,cAAc,KAAK,IAAI,GAAG,KAAK,IAAIgB,GAAQ,KAAK,MAAM,YAAY,CAAC,CAAC,GAC/E,KAAK,MAAM,OAAO,KAAK,OACvB,MAAM,KAAK,MAAM,KAAA,GACjB,KAAK,SAAS,WACdhB,EAAO,MAAM,SAAS,KAAK,EAAE,iBAAiBgB,EAAO,QAAQ,CAAC,CAAC,GAAG;AAAA,IACpE,SAASC,GAAO;AACd,MAAAjB,EAAO,MAAM,kBAAkB,KAAK,EAAE,KAAKiB,CAAK;AAAA,IAClD;AAAA,EACF;AAAA,EAEA,QAAc;AACZ,IAAI,KAAK,WAAW,cAEpB,KAAK,MAAM,MAAA,GACX,KAAK,SAAS,UACdjB,EAAO,MAAM,SAAS,KAAK,EAAE,cAAc,KAAK,MAAM,YAAY,QAAQ,CAAC,CAAC,GAAG;AAAA,EACjF;AAAA,EAEA,OAAa;AACX,SAAK,MAAM,MAAA,GACX,KAAK,MAAM,cAAc,GACzB,KAAK,SAAS,WACdA,EAAO,MAAM,SAAS,KAAK,EAAE,UAAU;AAAA,EACzC;AAAA,EAEA,KAAKkB,GAAoB;AACvB,UAAMC,IAAW,KAAK,IAAI,GAAG,KAAK,IAAID,GAAM,KAAK,MAAM,YAAY,CAAC,CAAC;AACrE,SAAK,MAAM,cAAcC;AAAA,EAC3B;AAAA,EAEA,UAAUC,GAAqB;AAC7B,SAAK,UAAU,KAAK,IAAI,GAAG,KAAK,IAAI,GAAGA,CAAK,CAAC,GAC7C,KAAK,SAAS,KAAK,eAAe,KAAK,SAAS,KAAK,IAAI,WAAW;AAAA,EACtE;AAAA,EAEA,QAAQA,GAAsB;AAC5B,SAAK,QAAQA,GACb,KAAK,MAAM,OAAOA;AAAA,EACpB;AAAA,EAEA,WAAWC,GAAsBC,GAA2B;AAC1D,SAAK,SAASD,GACd,KAAK,WAAW,WAAA,GAChB,KAAK,WAAW,QAAQC,CAAS;AAAA,EACnC;AAAA,EAEA,iBAAyB;AACvB,WAAO,KAAK,MAAM;AAAA,EACpB;AAAA,EAEA,cAAsB;AACpB,WAAO,KAAK,MAAM,YAAY;AAAA,EAChC;AAAA,EAEA,WAAW;AACT,WAAO;AAAA,MACL,IAAI,KAAK;AAAA,MACT,KAAK,KAAK;AAAA,MACV,OAAO,KAAK;AAAA,MACZ,eAAe,KAAK;AAAA,MACpB,QAAQ,KAAK;AAAA,MACb,MAAM,KAAK;AAAA,MACX,aAAa,KAAK,eAAA;AAAA,MAClB,UAAU,KAAK,YAAA;AAAA,IAAY;AAAA,EAE/B;AAAA,EAEA,UAAgB;ADvMlB,QAAAnB;ACwMI,SAAK,MAAM,MAAA,GACX,KAAK,MAAM,MAAM,KACjBA,IAAA,KAAK,eAAL,QAAAA,EAAiB,cACjB,KAAK,SAAS,WAAA,GACd,KAAK,WAAW,WAAA,GAChBH,EAAO,MAAM,SAAS,KAAK,EAAE,WAAW;AAAA,EAC1C;AACF;AC5MO,SAASuB,IAAwB;AAEtC,SAAO,KAAK,IAAA;AACd;AAeO,SAASC,EAAWC,GAAyB;AAClD,MAAI,CAAC,SAASA,CAAO,KAAKA,IAAU,EAAG,QAAO;AAE9C,QAAMC,IAAO,KAAK,MAAMD,IAAU,EAAE,GAC9BE,IAAO,KAAK,MAAMF,IAAU,EAAE;AACpC,SAAO,GAAGC,CAAI,IAAIC,EAAK,WAAW,SAAS,GAAG,GAAG,CAAC;AACpD;ACvBO,SAASC,IAAuB;AAErC,SAAI,OAAO,SAAW,OAAe,OAAO,aACnC,OAAO,WAAA,IAIT,uCAAuC,QAAQ,SAAS,CAAC,MAAM;AACpE,UAAMC,IAAI,KAAK,OAAA,IAAW,KAAK;AAE/B,YADU,MAAM,MAAMA,IAAKA,IAAI,IAAM,GAC5B,SAAS,EAAE;AAAA,EACtB,CAAC;AACH;ACbO,MAAMC,IAA0B;AAAA,EACrC;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF,GAOaC,IAA2C;AAAA,EACtD,QAAQ;AAAA,EACR,QAAQ;AAAA,EACR,QAAQ;AAAA,EACR,SAAS;AAAA,EACT,QAAQ;AAAA,EACR,QAAQ;AAAA,EACR,SAAS;AAAA,EACT,SAAS;AACX;AAKO,SAASC,EAAmBrB,GAAsB;AACvD,QAAMsB,IAAYC,EAAiBvB,CAAG;AACtC,SAAOmB,EAAwB,SAASG,CAAiC;AAC3E;AAKO,SAASC,EAAiBvB,GAAqB;AACpD,MAAI;AAQF,UAAMwB,IANU,mBAAmBxB,CAAG,EAGb,MAAM,GAAG,EAAE,CAAC,EAAE,MAAM,GAAG,EAAE,CAAC,EAG5B,MAAM,iBAAiB;AAC9C,WAAOwB,IAAQ,IAAIA,EAAM,CAAC,EAAE,YAAA,CAAa,KAAK;AAAA,EAChD,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AAKO,SAASC,EAAiBzB,GAA4B;AAC3D,QAAMsB,IAAYC,EAAiBvB,CAAG;AACtC,SAAOoB,EAAiBE,CAAS,KAAK;AACxC;AAeO,SAASI,EAAkB1B,GAAoC;AACpE,MAAI,CAACA,KAAO,OAAOA,KAAQ;AACzB,WAAO;AAAA,MACL,OAAO;AAAA,MACP,OAAO;AAAA,IAAA;AAIX,QAAMsB,IAAYC,EAAiBvB,CAAG;AAEtC,MAAI,CAACsB;AACH,WAAO;AAAA,MACL,OAAO;AAAA,MACP,OAAO;AAAA,IAAA;AAIX,MAAI,CAACD,EAAmBrB,CAAG;AACzB,WAAO;AAAA,MACL,OAAO;AAAA,MACP,OAAO,6BAA6BsB,CAAS,wBAAwBH,EAAwB,KAAK,IAAI,CAAC;AAAA,MACvG,WAAAG;AAAA,IAAA;AAIJ,QAAMK,IAAWF,EAAiBzB,CAAG;AAErC,SAAO;AAAA,IACL,OAAO;AAAA,IACP,WAAAsB;AAAA,IACA,UAAUK,KAAY;AAAA,EAAA;AAE1B;ACvGA,MAAMC,IAAY;AAElB,SAASC,IAA6B;AACpC,SAAQ,KAAK,SAAS,IAAID,GAAW,uBAAuB,KAAgB;AAC9E;AAEO,MAAME,EAAY;AAAA,EAevB,cAAc;AAdN,IAAAhC,EAAA;AACA,IAAAA,EAAA;AACA,IAAAA,EAAA;AACA,IAAAA,EAAA,qCAA4C,IAAA;AAE5C,IAAAA,EAAA,kBAA2B;AAAA,MACjC,QAAQ;AAAA,MACR,OAAO;AAAA,MACP,UAAU;AAAA,MACV,KAAK;AAAA,IAAA;AAGC,IAAAA,EAAA,qBAAoD;AAG1D,SAAK,MAAM,IAAI,aAAA,GAEf,KAAK,aAAa,KAAK,IAAI,WAAA,GAC3B,KAAK,WAAW,QAAQ,KAAK,IAAI,WAAW,GAE5C,KAAK,eAAe;AAAA,MAClB,OAAO,KAAK,IAAI,WAAA;AAAA,MAChB,UAAU,KAAK,IAAI,WAAA;AAAA,MACnB,KAAK,KAAK,IAAI,WAAA;AAAA,IAAW,GAG3B,KAAK,aAAa,MAAM,QAAQ,KAAK,UAAU,GAC/C,KAAK,aAAa,SAAS,QAAQ,KAAK,UAAU,GAClD,KAAK,aAAa,IAAI,QAAQ,KAAK,UAAU,GAE7CT,EAAO,KAAK,yBAAyB;AAAA,EACvC;AAAA;AAAA;AAAA;AAAA,EAMQ,eAAqB;ALnD/B,QAAAG;AKoDI,KAAKA,IAAA,KAAK,SAAL,QAAAA,EAAW,SAEZ,KAAK,eACP,aAAa,KAAK,WAAW,GAE/B,KAAK,cAAc,WAAW,MAAM;AAClC,WAAK,UAAA;AAAA,IACP,GAAG,GAAG;AAAA,EACR;AAAA,EAEA,MAAc,YAA2B;AL9D3C,QAAAA;AK+DI,QAAI,CAAC,KAAK,SAAS,GAACA,IAAA,KAAK,SAAL,QAAAA,EAAW,MAAM;AAErC,UAAMuC,IAAQ,KAAK,SAAA;AAEnB,QAAI;AACF,YAAM,KAAK,SAAS,IAAIH,GAAW,cAAc,KAAK,UAAUG,CAAK,CAAC,GACtE1C,EAAO,MAAM,mBAAmB;AAAA,IAClC,SAASiB,GAAO;AACd,MAAAjB,EAAO,MAAM,+BAA+BiB,CAAK;AAAA,IACnD;AAAA,EACF;AAAA,EAEA,MAAM,iBAAgC;AACpC,QAAK,KAAK;AAEV,UAAI;AACF,cAAM0B,IAAY,KAAK,SAAS,IAAIJ,GAAW,YAAY;AAC3D,YAAI,CAACI,EAAW;AAEhB,cAAMD,IAAQ,KAAK,MAAMC,CAAS;AAClC,cAAM,KAAK,aAAaD,CAAK,GAE7B1C,EAAO,KAAK,sBAAsB;AAAA,MACpC,SAASiB,GAAO;AACd,QAAAjB,EAAO,MAAM,+BAA+BiB,CAAK;AAAA,MACnD;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAMA,MAAM,YAAY2B,GAA+C;AAE/D,UAAMC,IAAUD,EAAO,MAAMhB,EAAA;AAE7B,QAAI,KAAK,QAAQ,IAAIiB,CAAO;AAC1B,aAAO,KAAK,QAAQ,IAAIA,CAAO;AAIjC,UAAMC,IAAaT,EAAkBO,EAAO,GAAG;AAC/C,QAAI,CAACE,EAAW,OAAO;AACrB,YAAM7B,IAAQ,IAAI,MAAM6B,EAAW,SAAS,oBAAoB;AAChE,YAAA9C,EAAO,MAAM,4BAA4B8C,EAAW,KAAK,EAAE,GACrD7B;AAAA,IACR;AAEA,UAAMV,IAAgB,KAAK,aAAaqC,EAAO,KAAK,GAE9CG,IAAS,IAAI3C;AAAA,MACjByC;AAAA,MACA,KAAK;AAAA,MACLtC;AAAA,MACAqC,EAAO;AAAA,IAAA;AAGT,WAAIA,EAAO,WAAW,UACpBG,EAAO,UAAUH,EAAO,MAAM,GAE5BA,EAAO,SAAS,UAClBG,EAAO,QAAQH,EAAO,IAAI,GAG5B,MAAMG,EAAO,KAAKH,EAAO,GAAG,GAE5B,KAAK,QAAQ,IAAIC,GAASE,CAAM,GAChC,KAAK,aAAA,GAEL/C,EAAO,KAAK,kBAAkB6C,CAAO,KAAKC,EAAW,SAAS,GAAG,GAC1DC;AAAA,EACT;AAAA,EAEA,SAAS1C,GAAyC;AAChD,WAAO,KAAK,QAAQ,IAAIA,CAAE;AAAA,EAC5B;AAAA,EAEA,YAAYA,GAAqB;AAC/B,UAAM0C,IAAS,KAAK,QAAQ,IAAI1C,CAAE;AAClC,WAAK0C,KAELA,EAAO,QAAA,GACP,KAAK,QAAQ,OAAO1C,CAAE,GACtB,KAAK,aAAA,GAELL,EAAO,KAAK,kBAAkBK,CAAE,EAAE,GAC3B,MAPa;AAAA,EAQtB;AAAA,EAEA,eAAkC;AAChC,WAAO,MAAM,KAAK,KAAK,QAAQ,QAAQ;AAAA,EACzC;AAAA,EAEA,iBAAiBG,GAAsC;AACrD,WAAO,KAAK,aAAA,EAAe,OAAO,CAAA,MAAK,EAAE,UAAUA,CAAK;AAAA,EAC1D;AAAA,EAEA,gBAAgBH,GAAYgB,GAA4B;AACtD,UAAM0B,IAAS,KAAK,QAAQ,IAAI1C,CAAE;AAClC,IAAK0C,MAELA,EAAO,WAAW1B,GAAU,KAAK,aAAaA,CAAQ,CAAC,GACvD,KAAK,aAAA;AAAA,EACP;AAAA;AAAA;AAAA;AAAA,EAMA,MAAM,UAAUhB,GAAYW,IAAiB,GAAkB;AL5KjE,QAAAb;AK6KI,UAAM4C,IAAS,KAAK,QAAQ,IAAI1C,CAAE;AAClC,QAAI,CAAC0C,GAAQ;AACX,MAAA/C,EAAO,KAAK,oBAAoBK,CAAE,EAAE;AACpC;AAAA,IACF;AAEA,UAAM2C,IAAkBR,EAAA,GAClBS,IAAe,KAAK,aAAA,EAAe,OAAO,CAAAC,MAAKA,EAAE,UAAU,SAAS,EAAE;AAG5E,QAAI,EAFuBH,EAAO,UAAU,cAEjBE,KAAgBD,GAAiB;AAC1D,MAAAhD,EAAO,KAAK,gCAAgCgD,CAAe,WAAW,IACtE7C,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK,yBAAyB6C,CAAe;AAC/D;AAAA,IACF;AAEA,UAAMD,EAAO,KAAK/B,CAAM;AAAA,EAC1B;AAAA,EAEA,WAAWX,GAAkB;ALhM/B,QAAAF;AKiMI,KAAAA,IAAA,KAAK,QAAQ,IAAIE,CAAE,MAAnB,QAAAF,EAAsB;AAAA,EACxB;AAAA,EAEA,UAAUE,GAAkB;ALpM9B,QAAAF;AKqMI,KAAAA,IAAA,KAAK,QAAQ,IAAIE,CAAE,MAAnB,QAAAF,EAAsB;AAAA,EACxB;AAAA,EAEA,UAAUE,GAAYa,GAAoB;ALxM5C,QAAAf;AKyMI,KAAAA,IAAA,KAAK,QAAQ,IAAIE,CAAE,MAAnB,QAAAF,EAAsB,KAAKe;AAAA,EAC7B;AAAA,EAEA,eAAeb,GAAY8C,GAAsB;AL5MnD,QAAAhD;AK6MI,KAAAA,IAAA,KAAK,QAAQ,IAAIE,CAAE,MAAnB,QAAAF,EAAsB,UAAUgD,IAChC,KAAK,aAAA;AAAA,EACP;AAAA,EAEA,aAAa9C,GAAY+C,GAAqB;ALjNhD,QAAAjD;AKkNI,KAAAA,IAAA,KAAK,QAAQ,IAAIE,CAAE,MAAnB,QAAAF,EAAsB,QAAQiD,IAC9B,KAAK,aAAA;AAAA,EACP;AAAA,EAEA,UAAgB;AACd,eAAWL,KAAU,KAAK,QAAQ,OAAA;AAChC,MAAAA,EAAO,KAAA;AAAA,EAEX;AAAA;AAAA;AAAA;AAAA,EAMA,IAAI,UAA0B;AAC5B,WAAO,EAAE,GAAG,KAAK,SAAA;AAAA,EACnB;AAAA,EAEA,gBAAgB3B,GAAqB;AACnC,SAAK,SAAS,SAAS,KAAK,IAAI,GAAG,KAAK,IAAI,GAAGA,CAAK,CAAC,GACrD,KAAK,WAAW,KAAK;AAAA,MACnB,KAAK,SAAS;AAAA,MACd,KAAK,IAAI,cAAc;AAAA,IAAA,GAEzB,KAAK,aAAA;AAAA,EACP;AAAA,EAEA,iBAAiBiC,GAAqBjC,GAAqB;AACzD,SAAK,SAASiC,CAAO,IAAI,KAAK,IAAI,GAAG,KAAK,IAAI,GAAGjC,CAAK,CAAC,GACvD,KAAK,aAAaiC,CAAO,EAAE,KAAK;AAAA,MAC9B,KAAK,SAASA,CAAO;AAAA,MACrB,KAAK,IAAI,cAAc;AAAA,IAAA,GAEzB,KAAK,aAAA;AAAA,EACP;AAAA,EAEA,iBAAiBA,GAA6B;AAC5C,WAAO,KAAK,SAASA,CAAO;AAAA,EAC9B;AAAA;AAAA;AAAA;AAAA,EAMA,WAAuB;AACrB,UAAMC,IAAuB,CAAA;AAE7B,eAAWP,KAAU,KAAK,QAAQ,OAAA;AAChC,MAAAO,EAAO,KAAKP,EAAO,UAAU;AAG/B,WAAO;AAAA,MACL,cAAc,KAAK,SAAS;AAAA,MAC5B,gBAAgB,EAAE,GAAG,KAAK,SAAA;AAAA,MAC1B,QAAAO;AAAA,MACA,WAAW/B,EAAA;AAAA,MACX,aAAa;AAAA,IAAA;AAAA,EAEjB;AAAA,EAEA,MAAM,aAAamB,GAAkC;AAKnD,QAHA,KAAK,SAAS,SAASA,EAAM,cAC7B,KAAK,WAAW,KAAK,eAAe,KAAK,SAAS,QAAQ,KAAK,IAAI,WAAW,GAE1EA,EAAM;AACR,iBAAWW,KAAW,CAAC,SAAS,YAAY,KAAK;AAC/C,aAAK,SAASA,CAAO,IAAIX,EAAM,eAAeW,CAAO,GACrD,KAAK,aAAaA,CAAO,EAAE,KAAK,eAAe,KAAK,SAASA,CAAO,GAAG,KAAK,IAAI,WAAW;AAK/F,eAAWE,KAAcb,EAAM;AAC7B,UAAI,CAAC,KAAK,QAAQ,IAAIa,EAAW,EAAE;AACjC,YAAI;AACF,gBAAM,KAAK,YAAY;AAAA,YACrB,IAAIA,EAAW;AAAA,YACf,KAAKA,EAAW;AAAA,YAChB,OAAOA,EAAW;AAAA,YAClB,QAAQA,EAAW;AAAA,YACnB,MAAMA,EAAW;AAAA,UAAA,CAClB;AAAA,QACH,SAAStC,GAAO;AACd,UAAAjB,EAAO,MAAM,2BAA2BuD,EAAW,EAAE,KAAKtC,CAAK;AAAA,QACjE;AAKJ,UAAMuC,IAAgB,IAAI,IAAId,EAAM,OAAO,IAAI,CAAAQ,MAAKA,EAAE,EAAE,CAAC;AACzD,eAAW,CAAC7C,CAAE,KAAK,KAAK;AACtB,MAAKmD,EAAc,IAAInD,CAAE,KACvB,KAAK,YAAYA,CAAE;AAAA,EAGzB;AAAA;AAAA;AAAA;AAAA,EAMA,MAAM,SAAwB;AAC5B,IAAI,KAAK,IAAI,UAAU,gBACrB,MAAM,KAAK,IAAI,OAAA,GACfL,EAAO,KAAK,sBAAsB;AAAA,EAEtC;AAAA,EAEA,IAAI,eAAkC;AACpC,WAAO,KAAK,IAAI;AAAA,EAClB;AAAA;AAAA;AAAA;AAAA,EAMA,UAAgB;AACd,IAAI,KAAK,eACP,aAAa,KAAK,WAAW;AAE/B,eAAW+C,KAAU,KAAK,QAAQ,OAAA;AAChC,MAAAA,EAAO,QAAA;AAET,SAAK,QAAQ,MAAA,GACb,KAAK,IAAI,MAAA,GACT/C,EAAO,KAAK,sBAAsB;AAAA,EACpC;AACF;AC1UO,MAAMyD,EAAkB;AAAA,EAe7B,cAAc;AAdN,IAAAhD,EAAA;AACA,IAAAA,EAAA;AACA,IAAAA,EAAA;AACA;AAAA,IAAAA,EAAA;AACA,IAAAA,EAAA,qCAA4C,IAAA;AAE5C,IAAAA,EAAA,sBAAuB;AACvB;AAAA,IAAAA,EAAA,oBAA6B;AAAA,MACnC,QAAQ;AAAA,MACR,OAAO;AAAA,MACP,UAAU;AAAA,MACV,KAAK;AAAA,IAAA;AAIL,SAAK,MAAM,IAAI,aAAA,GAGf,KAAK,aAAa,KAAK,IAAI,WAAA,GAC3B,KAAK,WAAW,QAAQ,KAAK,IAAI,WAAW,GAE5C,KAAK,SAAS,KAAK,IAAI,WAAA,GACvB,KAAK,OAAO,QAAQ,KAAK,UAAU,GAEnC,KAAK,eAAe;AAAA,MAClB,OAAO,KAAK,IAAI,WAAA;AAAA,MAChB,UAAU,KAAK,IAAI,WAAA;AAAA,MACnB,KAAK,KAAK,IAAI,WAAA;AAAA,IAAW,GAG3B,KAAK,aAAa,MAAM,QAAQ,KAAK,MAAM,GAC3C,KAAK,aAAa,SAAS,QAAQ,KAAK,MAAM,GAC9C,KAAK,aAAa,IAAI,QAAQ,KAAK,MAAM,GAEzCT,EAAO,KAAK,+BAA+B;AAAA,EAC7C;AAAA;AAAA;AAAA;AAAA,EAMA,IAAI,cAAsB;AACxB,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,eAAeoB,GAAqB;AAClC,SAAK,eAAe,KAAK,IAAI,GAAG,KAAK,IAAI,GAAGA,CAAK,CAAC,GAClD,KAAK,WAAW,KAAK;AAAA,MACnB,KAAK;AAAA,MACL,KAAK,IAAI,cAAc;AAAA,IAAA;AAAA,EAE3B;AAAA;AAAA;AAAA;AAAA,EAMA,YAAYiC,GAAgCjC,GAAqB;AAC/D,UAAMsC,IAAY,KAAK,IAAI,GAAG,KAAK,IAAI,GAAGtC,CAAK,CAAC;AAEhD,IAAIiC,MAAY,YACd,KAAK,WAAW,SAASK,GACzB,KAAK,OAAO,KAAK,wBAAwBA,GAAW,KAAK,IAAI,cAAc,IAAI,MAE/E,KAAK,WAAWL,CAAO,IAAIK,GAC3B,KAAK,aAAaL,CAAO,EAAE,KAAK,wBAAwBK,GAAW,KAAK,IAAI,cAAc,IAAI;AAAA,EAElG;AAAA,EAEA,gBAAgBC,GAA+B;AAC7C,SAAK,aAAa,EAAE,GAAGA,EAAA,GAEvB,KAAK,OAAO,KAAK,eAAeA,EAAQ,QAAQ,KAAK,IAAI,WAAW,GACpE,KAAK,aAAa,MAAM,KAAK,eAAeA,EAAQ,OAAO,KAAK,IAAI,WAAW,GAC/E,KAAK,aAAa,SAAS,KAAK,eAAeA,EAAQ,UAAU,KAAK,IAAI,WAAW,GACrF,KAAK,aAAa,IAAI,KAAK,eAAeA,EAAQ,KAAK,KAAK,IAAI,WAAW;AAAA,EAC7E;AAAA;AAAA;AAAA;AAAA,EAMA,MAAM,WAAWC,GAA0C;AACzD,QAAIb,IAAS,KAAK,QAAQ,IAAIa,EAAQ,OAAO;AAG7C,IAAKb,MACHA,IAAS,IAAI3C;AAAA,MACXwD,EAAQ;AAAA,MACR,KAAK;AAAA,MACL,KAAK,aAAaA,EAAQ,KAAK;AAAA,MAC/BA,EAAQ;AAAA,IAAA,GAGV,MAAMb,EAAO,KAAKa,EAAQ,GAAG,GAC7B,KAAK,QAAQ,IAAIA,EAAQ,SAASb,CAAM,IAG1CA,EAAO,UAAUa,EAAQ,MAAM,GAC/Bb,EAAO,QAAQa,EAAQ,IAAI;AAG3B,UAAMC,KAAWtC,EAAA,IAAkBqC,EAAQ,kBAAkB,KACvDE,IAAiB,KAAK,IAAI,GAAGF,EAAQ,SAASC,CAAO;AAE3D,UAAMd,EAAO,KAAKe,CAAc,GAChC9D,EAAO,MAAM,iBAAiB4D,EAAQ,OAAO,eAAeE,EAAe,QAAQ,CAAC,CAAC,GAAG;AAAA,EAC1F;AAAA,EAEA,YAAYjB,GAAuB;ANtHrC,QAAA1C;AMuHI,KAAAA,IAAA,KAAK,QAAQ,IAAI0C,CAAO,MAAxB,QAAA1C,EAA2B;AAAA,EAC7B;AAAA,EAEA,WAAW0C,GAAuB;AN1HpC,QAAA1C;AM2HI,KAAAA,IAAA,KAAK,QAAQ,IAAI0C,CAAO,MAAxB,QAAA1C,EAA2B;AAAA,EAC7B;AAAA,EAEA,WAAW0C,GAAiB3B,GAAc6C,GAAoBC,GAA6B;AACzF,UAAMjB,IAAS,KAAK,QAAQ,IAAIF,CAAO;AACvC,QAAKE;AAEL,UAAIgB,GAAW;AACb,cAAMF,KAAWtC,EAAA,IAAkByC,KAAiB;AACpD,QAAAjB,EAAO,KAAK7B,IAAO2C,CAAO;AAAA,MAC5B;AACE,QAAAd,EAAO,KAAK7B,CAAI;AAAA,EAEpB;AAAA,EAEA,kBAAkB2B,GAAiBM,GAAsB;AN1I3D,QAAAhD;AM2II,KAAAA,IAAA,KAAK,QAAQ,IAAI0C,CAAO,MAAxB,QAAA1C,EAA2B,UAAUgD;AAAA,EACvC;AAAA,EAEA,gBAAgBN,GAAiBO,GAAqB;AN9IxD,QAAAjD;AM+II,KAAAA,IAAA,KAAK,QAAQ,IAAI0C,CAAO,MAAxB,QAAA1C,EAA2B,QAAQiD;AAAA,EACrC;AAAA;AAAA;AAAA;AAAA,EAMA,MAAM,UAAUE,GAA0BK,GAAwC;AAEhF,SAAK,gBAAgBA,CAAO;AAG5B,UAAMM,IAAc,IAAI,IAAIX,EAAO,IAAI,CAAAJ,MAAKA,EAAE,EAAE,CAAC;AAGjD,eAAW,CAAC7C,GAAI0C,CAAM,KAAK,KAAK;AAC9B,MAAKkB,EAAY,IAAI5D,CAAE,MACrB0C,EAAO,QAAA,GACP,KAAK,QAAQ,OAAO1C,CAAE;AAK1B,eAAWkD,KAAcD,GAAQ;AAC/B,UAAIP,IAAS,KAAK,QAAQ,IAAIQ,EAAW,EAAE;AAiB3C,UAfKR,MACHA,IAAS,IAAI3C;AAAA,QACXmD,EAAW;AAAA,QACX,KAAK;AAAA,QACL,KAAK,aAAaA,EAAW,KAAK;AAAA,QAClCA,EAAW;AAAA,MAAA,GAGb,MAAMR,EAAO,KAAKQ,EAAW,GAAG,GAChC,KAAK,QAAQ,IAAIA,EAAW,IAAIR,CAAM,IAGxCA,EAAO,UAAUQ,EAAW,MAAM,GAClCR,EAAO,QAAQQ,EAAW,IAAI,GAE1BA,EAAW,WAAW;AACxB,cAAMM,KAAWtC,EAAA,IAAkBgC,EAAW,kBAAkB,KAC1DW,IAAeX,EAAW,cAAcM;AAC9C,cAAMd,EAAO,KAAKmB,CAAY;AAAA,MAChC;AACE,QAAAnB,EAAO,KAAA;AAAA,IAEX;AAEA,IAAA/C,EAAO,KAAK,8BAA8B;AAAA,EAC5C;AAAA;AAAA;AAAA;AAAA,EAMA,UAAgB;AACd,eAAW+C,KAAU,KAAK,QAAQ,OAAA;AAChC,MAAAA,EAAO,KAAA;AAAA,EAEX;AAAA,EAEA,WAAiB;AACf,eAAWA,KAAU,KAAK,QAAQ,OAAA;AAChC,MAAAA,EAAO,QAAA;AAET,SAAK,QAAQ,MAAA,GACb/C,EAAO,KAAK,4BAA4B;AAAA,EAC1C;AAAA;AAAA;AAAA;AAAA,EAMA,MAAM,SAAwB;AAC5B,IAAI,KAAK,IAAI,UAAU,gBACrB,MAAM,KAAK,IAAI,OAAA,GACfA,EAAO,KAAK,yCAAyC;AAAA,EAEzD;AAAA,EAEA,UAAgB;AACd,SAAK,SAAA,GACL,KAAK,IAAI,MAAA,GACTA,EAAO,KAAK,4BAA4B;AAAA,EAC1C;AACF;AClNA,MAAMuC,IAAY,yBACZ4B,IAAc,UAAU5B,CAAS;AAEhC,MAAM6B,EAAc;AAAA,EAOzB,cAAc;AANN,IAAA3D,EAAA,kBAA+B;AAC/B,IAAAA,EAAA,sBAAyC;AACzC,IAAAA,EAAA,gBAAc;AACd,IAAAA,EAAA,sBAAwB;AACxB,IAAAA,EAAA,cAAgB;AAAA,EAET;AAAA,EAEf,eAAe4D,GAA2B;APhC5C,QAAAlE;AOiCI,SAAK,OAAO,IACZ,KAAK,WAAWkE,GAChB,KAAK,SAAS,KAAK,SAEnBlE,IAAA,KAAK,WAAL,QAAAA,EAAa,GAAGgE,GAAa,CAAClE,MAA2B;AACvD,WAAK,gBAAgBA,CAAO;AAAA,IAC9B,IAEAD,EAAO,KAAK,iCAAiC;AAAA,EAC/C;AAAA,EAEA,mBAAmBqE,GAAiC;AP5CtD,QAAAlE;AO6CI,SAAK,OAAO,IACZ,KAAK,eAAekE,GACpB,KAAK,SAAS,KAAK,SAEnBlE,IAAA,KAAK,WAAL,QAAAA,EAAa,GAAGgE,GAAa,CAAClE,MAA2B;AACvD,WAAK,oBAAoBA,CAAO;AAAA,IAClC,IAGA,WAAW,MAAM;AACf,WAAK,KAAK,gBAAgB,EAAE;AAAA,IAC9B,GAAG,GAAI,GAEPD,EAAO,KAAK,qCAAqC;AAAA,EACnD;AAAA;AAAA;AAAA;AAAA,EAMA,IAAI,cAAuB;AACzB,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,eAAesE,GAAwB;AACrC,IAAK,KAAK,SAEV,KAAK,eAAeA,GAEhBA,IACF,KAAK,mBAAA,IAEL,KAAK,kBAAA,GAGPtE,EAAO,KAAK,cAAcsE,IAAU,OAAO,KAAK,EAAE;AAAA,EACpD;AAAA;AAAA;AAAA;AAAA,EAMQ,gBAAgBrE,GAA8B;APvFxD,QAAAE;AOwFI,IAAIF,EAAQ,eAAaE,IAAA,KAAK,SAAL,gBAAAA,EAAW,OAEhCF,EAAQ,SAAS,kBAAkB,KAAK,gBAE1C,KAAK,YAAYA,EAAQ,QAAQ;AAAA,EAErC;AAAA;AAAA;AAAA;AAAA,EAMA,MAAc,oBAAoBA,GAAuC;APpG3E,QAAAE;AOqGI,QAAIF,EAAQ,eAAaE,IAAA,KAAK,SAAL,gBAAAA,EAAW,OAC/B,KAAK;AAIV,cAFAH,EAAO,MAAM,oBAAoBC,EAAQ,IAAI,IAAIA,EAAQ,OAAO,GAExDA,EAAQ,MAAA;AAAA,QACd,KAAK;AACH,gBAAMsE,IAAetE,EAAQ;AAC7B,gBAAM,KAAK,aAAa,UAAUsE,EAAa,QAAQA,EAAa,cAAc;AAClF;AAAA,QAEF,KAAK;AACH,eAAK,aAAa,SAAA;AAClB;AAAA,QAEF,KAAK;AACH,gBAAMC,IAAevE,EAAQ;AAC7B,gBAAM,KAAK,aAAa,UAAUuE,EAAa,QAAQA,EAAa,cAAc;AAClF;AAAA,QAEF,KAAK;AACH,gBAAMC,IAAcxE,EAAQ;AAC5B,gBAAM,KAAK,aAAa,WAAWwE,CAAW;AAC9C;AAAA,QAEF,KAAK;AACH,gBAAMC,IAAezE,EAAQ;AAC7B,eAAK,aAAa,YAAYyE,EAAa,OAAO;AAClD;AAAA,QAEF,KAAK;AACH,gBAAMC,IAAc1E,EAAQ;AAC5B,eAAK,aAAa,WAAW0E,EAAY,OAAO;AAChD;AAAA,QAEF,KAAK;AACH,gBAAMC,IAAc3E,EAAQ;AAC5B,eAAK,aAAa;AAAA,YAChB2E,EAAY;AAAA,YACZA,EAAY;AAAA,YACZA,EAAY;AAAA,YACZA,EAAY;AAAA,UAAA;AAEd;AAAA,QAEF,KAAK;AACH,gBAAMC,IAAa5E,EAAQ;AAC3B,eAAK,aAAa,kBAAkB4E,EAAW,SAASA,EAAW,MAAM;AACzE;AAAA,QAEF,KAAK;AACH,gBAAMC,IAAc7E,EAAQ;AAC5B,eAAK,aAAa,gBAAgB6E,EAAY,SAASA,EAAY,IAAI;AACvE;AAAA,QAEF,KAAK;AACH,gBAAMC,IAAe9E,EAAQ;AAC7B,eAAK,aAAa,YAAY8E,EAAa,SAASA,EAAa,MAAM;AACvE;AAAA,QAEF,KAAK;AACH,eAAK,aAAa,QAAA;AAClB;AAAA,MAAA;AAAA,EAEN;AAAA;AAAA;AAAA;AAAA,EAMQ,KAAKC,GAAyBpB,GAAkBqB,GAA6B;AP3KvF,QAAA9E;AO4KI,QAAI,CAAC,KAAK,OAAQ;AAElB,UAAMF,IAAyB;AAAA,MAC7B,MAAA+E;AAAA,MACA,SAAApB;AAAA,MACA,YAAUzD,IAAA,KAAK,SAAL,gBAAAA,EAAW,OAAM;AAAA,MAC3B,WAAWoB,EAAA;AAAA,IAAc;AAG3B,IAAI0D,IACF,KAAK,OAAO,KAAKd,GAAalE,GAAS,EAAE,YAAY,CAACgF,CAAY,GAAG,IAErE,KAAK,OAAO,KAAKd,GAAalE,CAAO,GAGvCD,EAAO,MAAM,SAASgF,CAAI,IAAIpB,CAAO;AAAA,EACvC;AAAA,EAEQ,sBAAwC;AAC9C,QAAI,CAAC,KAAK;AACR,aAAO,EAAE,QAAQ,CAAA,GAAI,gBAAgB,EAAE,QAAQ,GAAG,OAAO,GAAG,UAAU,GAAG,KAAK,IAAE;AAGlF,UAAMsB,IAAM3D,EAAA,GACN+B,IAA2B,CAAA;AAEjC,eAAWP,KAAU,KAAK,SAAS,aAAA,GAAgB;AACjD,YAAML,IAAQK,EAAO,SAAA;AACrB,MAAAO,EAAO,KAAK;AAAA,QACV,IAAIZ,EAAM;AAAA,QACV,KAAKA,EAAM;AAAA,QACX,OAAOA,EAAM;AAAA,QACb,QAAQA,EAAM;AAAA,QACd,MAAMA,EAAM;AAAA,QACZ,WAAWA,EAAM,kBAAkB;AAAA,QACnC,aAAaK,EAAO,eAAA;AAAA,QACpB,gBAAgBmC;AAAA,MAAA,CACjB;AAAA,IACH;AAEA,WAAO;AAAA,MACL,QAAA5B;AAAA,MACA,gBAAgB,KAAK,SAAS;AAAA,IAAA;AAAA,EAElC;AAAA,EAEQ,qBAA2B;AACjC,UAAMZ,IAAQ,KAAK,oBAAA;AACnB,SAAK,KAAK,cAAcA,CAAK;AAAA,EAC/B;AAAA,EAEQ,oBAA0B;AAChC,SAAK,KAAK,aAAa,EAAE;AAAA,EAC3B;AAAA,EAEQ,YAAYyC,GAAsB;AACxC,UAAMzC,IAAQ,KAAK,oBAAA;AACnB,SAAK,KAAK,cAAcA,GAAOyC,CAAM;AAAA,EACvC;AAAA;AAAA;AAAA;AAAA,EAMA,mBAAmBtC,GAAiB7B,GAAsB;AACxD,QAAI,CAAC,KAAK,gBAAgB,CAAC,KAAK,SAAU;AAE1C,UAAM+B,IAAS,KAAK,SAAS,SAASF,CAAO;AAC7C,QAAI,CAACE,EAAQ;AAEb,UAAMa,IAA4B;AAAA,MAChC,SAAAf;AAAA,MACA,KAAKE,EAAO;AAAA,MACZ,OAAOA,EAAO;AAAA,MACd,QAAQA,EAAO;AAAA,MACf,MAAMA,EAAO;AAAA,MACb,QAAA/B;AAAA,MACA,gBAAgBO,EAAA;AAAA,IAAc;AAGhC,SAAK,KAAK,cAAcqC,CAAO;AAAA,EACjC;AAAA,EAEA,oBAAoBf,GAAiBuC,GAAwB;AAC3D,QAAI,CAAC,KAAK,aAAc;AAExB,UAAMxB,IAA6B,EAAE,SAAAf,GAAS,UAAAuC,EAAA;AAC9C,SAAK,KAAK,eAAexB,CAAO;AAAA,EAClC;AAAA,EAEA,mBAAmBf,GAAuB;AACxC,QAAI,CAAC,KAAK,aAAc;AAExB,UAAMe,IAA4B,EAAE,SAAAf,EAAA;AACpC,SAAK,KAAK,cAAce,CAAO;AAAA,EACjC;AAAA,EAEA,mBAAmBf,GAAiB3B,GAAc6C,GAA0B;AAC1E,QAAI,CAAC,KAAK,aAAc;AAExB,UAAMH,IAA4B;AAAA,MAChC,SAAAf;AAAA,MACA,MAAA3B;AAAA,MACA,WAAA6C;AAAA,MACA,eAAexC,EAAA;AAAA,IAAc;AAE/B,SAAK,KAAK,cAAcqC,CAAO;AAAA,EACjC;AAAA,EAEA,qBAAqBf,GAAiBM,GAAsB;AAC1D,QAAI,CAAC,KAAK,aAAc;AAExB,UAAMS,IAA8B,EAAE,SAAAf,GAAS,QAAAM,EAAA;AAC/C,SAAK,KAAK,gBAAgBS,CAAO;AAAA,EACnC;AAAA,EAEA,mBAAmBf,GAAiBO,GAAqB;AACvD,QAAI,CAAC,KAAK,aAAc;AAExB,UAAMQ,IAA4B,EAAE,SAAAf,GAAS,MAAAO,EAAA;AAC7C,SAAK,KAAK,cAAcQ,CAAO;AAAA,EACjC;AAAA,EAEA,uBAAuBP,GAAgCF,GAAsB;AAC3E,QAAI,CAAC,KAAK,aAAc;AAExB,UAAMS,IAAgC,EAAE,SAAAP,GAAS,QAAAF,EAAA;AACjD,SAAK,KAAK,kBAAkBS,CAAO;AAAA,EACrC;AAAA,EAEA,mBAAyB;AACvB,IAAK,KAAK,gBACV,KAAK,KAAK,YAAY,EAAE;AAAA,EAC1B;AAAA,EAEA,UAAgB;APnTlB,QAAAzD;AOoTI,KAAAA,IAAA,KAAK,WAAL,QAAAA,EAAa,IAAIgE;AAAA,EACnB;AACF;ACnTA,MAAM5B,IAAY;AAEX,MAAM8C,UAA0B,YAAY;AAAA,EAiBjD,YAAYhB,GAA2BiB,GAAuC;AAC5E,UAAMA,CAAO;AAjBP,IAAA7E,EAAA;AAkBN,SAAK,SAAS4D;AAAA,EAChB;AAAA,EAjBA,WAAoB,iBAAqC;AACvD,WAAO,QAAQ,MAAM,YAAY,MAAM,gBAAgB;AAAA,MACrD,IAAI;AAAA,MACJ,OAAO;AAAA,MACP,UAAU,WAAW9B,CAAS;AAAA,MAC9B,SAAS,CAAC,kBAAkB;AAAA,MAC5B,OAAO;AAAA,MACP,QAAQ;AAAA,MACR,WAAW;AAAA,MACX,aAAa;AAAA,MACb,QAAQ;AAAA,IAAA,CACT;AAAA,EACH;AAAA,EAOS,UAAU;AACjB,WAAO;AAAA,MACL,QAAQ,KAAK,MAAM,KAAK,OAAO,cAAc,GAAG;AAAA,IAAA;AAAA,EAEpD;AAAA,EAES,kBAAkBgD,GAAoB;AAC7C,UAAM,kBAAkBA,CAAI,GAE5BA,EAAK,KAAK,oBAAoB,EAAE,GAAG,SAAS,CAACC,MAAU;AACrD,YAAMpE,IAAQ,WAAYoE,EAAM,OAA4B,KAAK,IAAI;AACrE,WAAK,OAAO,eAAepE,CAAK,GAChCmE,EAAK,KAAK,mBAAmB,EAAE,KAAK,GAAG,KAAK,MAAMnE,IAAQ,GAAG,CAAC,GAAG,GAGjE,KAAK,WAAWA,CAAK;AAAA,IACvB,CAAC;AAAA,EACH;AAAA,EAEQ,WAAWA,GAAqB;AACtC,iBAAa,QAAQ,GAAGmB,CAAS,kBAAkB,OAAOnB,CAAK,CAAC;AAAA,EAClE;AAAA,EAEA,OAAO,kBAA0B;AAC/B,UAAMqE,IAAQ,aAAa,QAAQ,GAAGlD,CAAS,gBAAgB;AAC/D,WAAOkD,IAAQ,WAAWA,CAAK,IAAI;AAAA,EACrC;AACF;ACcO,MAAMC,UAAwB,YAAY;AAAA,EAiB/C,YAAYC,GAAyBL,IAAU,IAAI;AACjD,UAAMA,CAAO;AAjBP,IAAA7E,EAAA;AACA,IAAAA,EAAA;AAiBN,SAAK,UAAUkF,GACf,KAAK,cAAc;AAAA,MACjB,aAAa;AAAA,MACb,kBAAkB,oBAAI,IAAI,CAAC,SAAS,YAAY,KAAK,CAAC;AAAA;AAAA,MACtD,oBAAoB;AAAA,MACpB,kCAAkB,IAAA;AAAA,MAClB,QAAQ;AAAA,IAAA;AAAA,EAEZ;AAAA,EAvBA,WAAoB,iBAAiB;AACnC,WAAO,QAAQ,MAAM,YAAY,MAAM,gBAAgB;AAAA,MACrD,IAAI;AAAA,MACJ,UAAU;AAAA,MACV,OAAO;AAAA,MACP,OAAO;AAAA,MACP,QAAQ;AAAA,MACR,SAAS,CAAC,yBAAyB,SAAS;AAAA,MAC5C,WAAW;AAAA,MACX,MAAM,CAAC,EAAE,aAAa,SAAS,iBAAiB,YAAY,SAAS,UAAA,CAAW;AAAA,IAAA,CACjF;AAAA,EACH;AAAA,EAcS,UAAuB;AAC9B,QAAIC,IAAQ,KAAK,QAAQ,YAAA;AACzB,UAAMC,IAAY,KAAK,QAAQ,UAAU,gBAAA,GACnCC,IAAU,KAAK,QAAQ,WAAA,GACvBC,IAAQ,KAAK,QAAQ,SAAA;AAG3B,IAAAH,IAAQ,KAAK,aAAaA,CAAK,GAG/BA,IAAQ,KAAK,aAAaA,CAAK;AAG/B,UAAMI,IAAgB,KAAK,QAAQ,aAAA,GAC7BC,IAAoB,KAAK,QAAQ,UAAU,qBAAA,GAC3CC,IAAgC;AAAA,MACpC,GAAGF,EAAc,IAAI,CAAAG,OAAS;AAAA,QAC5B,IAAIA,EAAK;AAAA,QACT,MAAMA,EAAK;AAAA,QACX,MAAM;AAAA,MAAA,EACN;AAAA,MACF,GAAGF,EAAkB,IAAI,CAAAG,OAAa;AAAA,QACpC,IAAIA,EAAS;AAAA,QACb,MAAMA,EAAS;AAAA,QACf,MAAM;AAAA,MAAA,EACN;AAAA,IAAA,GAIEC,IAAsBP,EAAQ,IAAI,CAAAQ,OAAQ;AAAA,MAC9C,MAAMA;AAAA,MACN,UAAU,KAAK,YAAY,aAAa,IAAIA,CAAG;AAAA,IAAA,EAC/C,GAGIC,IAAoBV,EAAU,IAAI,CAAA,OAAM;AAAA,MAC5C,GAAG,KAAK,oBAAoB,CAAC;AAAA,MAC7B,UAAU,EAAE,OAAO,KAAK,YAAY;AAAA,IAAA,EACpC,GAGIW,IAAsB,KAAK,YAAY,iBAAiB,SAAS,GACjEC,IAAmB,CAAC,EACxB,KAAK,YAAY,eACjB,CAACD,KACD,KAAK,YAAY,sBACjB,KAAK,YAAY,aAAa,OAAO;AAGvC,WAAO;AAAA,MACL,OAAOZ,EAAM,IAAI,OAAQ,KAAK,gBAAgBO,CAAI,CAAC;AAAA,MACnD,WAAWI;AAAA,MACX,WAAAL;AAAA,MACA,MAAAG;AAAA,MACA,OAAO;AAAA,QACL,YAAYN,EAAM;AAAA,QAClB,eAAeA,EAAM;AAAA,QACrB,WAAWA,EAAM;AAAA,QACjB,UAAUA,EAAM;AAAA,MAAA;AAAA;AAAA,MAGlB,aAAa,KAAK,YAAY;AAAA,MAC9B,SAAS;AAAA,QACP,OAAO,KAAK,YAAY,iBAAiB,IAAI,OAAO;AAAA,QACpD,UAAU,KAAK,YAAY,iBAAiB,IAAI,UAAU;AAAA,QAC1D,KAAK,KAAK,YAAY,iBAAiB,IAAI,KAAK;AAAA,MAAA;AAAA,MAElD,oBAAoB,KAAK,YAAY;AAAA,MACrC,QAAQ,KAAK,YAAY;AAAA,MACzB,kBAAAU;AAAA,IAAA;AAAA,EAEJ;AAAA,EAEQ,oBAAoBL,GAAsC;AAChE,WAAO;AAAA,MACL,IAAIA,EAAS;AAAA,MACb,MAAMA,EAAS;AAAA,MACf,WAAWA,EAAS,MAAM;AAAA,MAC1B,UAAUA,EAAS;AAAA,MACnB,UAAU;AAAA,IAAA;AAAA,EAEd;AAAA,EAEQ,gBAAgBD,GAAwC;AAC9D,WAAO;AAAA,MACL,IAAIA,EAAK;AAAA,MACT,MAAMA,EAAK;AAAA,MACX,KAAKA,EAAK;AAAA,MACV,UAAU3E,EAAW2E,EAAK,QAAQ;AAAA,MAClC,iBAAiBA,EAAK;AAAA,MACtB,MAAMA,EAAK;AAAA,MACX,UAAUA,EAAK;AAAA,MACf,OAAO,KAAK,mBAAmBA,EAAK,IAAI;AAAA,IAAA;AAAA,EAE5C;AAAA,EAEQ,mBAAmBE,GAAwB;AAEjD,UAAMK,IAAYL,EAAK,IAAI,CAAAnD,MAAKA,EAAE,aAAa;AAC/C,WAAIwD,EAAU,KAAK,CAAAxD,MAAKA,EAAE,SAAS,OAAO,CAAC,IAAU,UACjDwD,EAAU,KAAK,CAAAxD,MAAKA,EAAE,SAAS,SAAS,KAAKA,EAAE,SAAS,UAAU,CAAC,IAAU,aAC7EwD,EAAU,KAAK,CAAAxD,MAAKA,EAAE,SAAS,KAAK,KAAKA,EAAE,SAAS,QAAQ,CAAC,IAAU,QACpE;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAMQ,aAAa0C,GAAqC;AACxD,QAAIe,IAAWf;AAGf,QAAI,KAAK,YAAY,aAAa;AAChC,YAAMgB,IAAQ,KAAK,YAAY,YAAY,YAAA;AAC3C,MAAAD,IAAWA,EAAS;AAAA,QAAO,OACzBR,EAAK,KAAK,YAAA,EAAc,SAASS,CAAK,KACtCT,EAAK,KAAK,KAAK,CAAAG,MAAOA,EAAI,cAAc,SAASM,CAAK,CAAC;AAAA,MAAA;AAAA,IAE3D;AAeA,QAZI,KAAK,YAAY,iBAAiB,OAAO,IAC3CD,IAAWA,EAAS,OAAO,CAAAR,MAAQ;AACjC,YAAM3F,IAAQ,KAAK,mBAAmB2F,EAAK,IAAI;AAC/C,aAAO,KAAK,YAAY,iBAAiB,IAAI3F,CAAK;AAAA,IACpD,CAAC,IAIDmG,IAAW,CAAA,GAIT,KAAK,YAAY,oBAAoB;AACvC,YAAMP,IAAW,KAAK,QAAQ,UAAU,YAAY,KAAK,YAAY,kBAAkB;AACvF,UAAIA,GAAU;AACZ,cAAMS,IAAkB,IAAI,IAAIT,EAAS,MAAM,IAAI,CAAAU,MAAKA,EAAE,aAAa,CAAC;AACxE,QAAAH,IAAWA,EAAS,OAAO,CAAAR,MAAQU,EAAgB,IAAIV,EAAK,EAAE,CAAC;AAAA,MACjE;AAAA,IACF;AAGA,WAAI,KAAK,YAAY,aAAa,OAAO,MACvCQ,IAAWA,EAAS;AAAA,MAAO,CAAAR,MACzBA,EAAK,KAAK,KAAK,CAAAG,MAAO,KAAK,YAAY,aAAa,IAAIA,CAAG,CAAC;AAAA,IAAA,IAIzDK;AAAA,EACT;AAAA,EAEQ,aAAaf,GAAqC;AACxD,UAAMmB,IAAS,CAAC,GAAGnB,CAAK;AAExB,YAAQ,KAAK,YAAY,QAAA;AAAA,MACvB,KAAK;AACH,QAAAmB,EAAO,KAAK,CAACC,GAAGC,MAAMD,EAAE,KAAK,cAAcC,EAAE,IAAI,CAAC;AAClD;AAAA,MACF,KAAK;AACH,QAAAF,EAAO,KAAK,CAACC,GAAGC,MAAMA,EAAE,KAAK,cAAcD,EAAE,IAAI,CAAC;AAClD;AAAA,MACF,KAAK;AACH,QAAAD,EAAO,KAAK,CAACC,GAAGC,MAAMD,EAAE,UAAUC,EAAE,OAAO;AAC3C;AAAA,MACF,KAAK;AACH,QAAAF,EAAO,KAAK,CAACC,GAAGC,MAAMA,EAAE,UAAUD,EAAE,OAAO;AAC3C;AAAA,MACF,KAAK;AACH,QAAAD,EAAO,KAAK,CAACC,GAAGC,MAAMD,EAAE,WAAWC,EAAE,QAAQ;AAC7C;AAAA,MACF,KAAK;AACH,QAAAF,EAAO,KAAK,CAACC,GAAGC,MAAMA,EAAE,WAAWD,EAAE,QAAQ;AAC7C;AAAA,IAAA;AAGJ,WAAOD;AAAA,EACT;AAAA,EAES,kBAAkBxB,GAAoB;AAC7C,UAAM,kBAAkBA,CAAI,GAG5BA,EAAK,KAAK,2BAA2B,EAAE,GAAG,SAAS,KAAK,WAAW,KAAK,IAAI,CAAC,GAC7EA,EAAK,KAAK,wBAAwB,EAAE,GAAG,SAAS,KAAK,SAAS,KAAK,IAAI,CAAC,GACxEA,EAAK,KAAK,gCAAgC,EAAE,GAAG,SAAS,KAAK,gBAAgB,KAAK,IAAI,CAAC,GACvFA,EAAK,KAAK,6BAA6B,EAAE,GAAG,UAAU,KAAK,aAAa,KAAK,IAAI,CAAC,GAClFA,EAAK,KAAK,+BAA+B,EAAE,GAAG,SAAS,KAAK,eAAe,KAAK,IAAI,CAAC,GAGrFA,EAAK,KAAK,4BAA4B,EAAE,GAAG,SAAS,KAAK,YAAY,KAAK,IAAI,CAAC,GAC/EA,EAAK,KAAK,yBAAyB,EAAE,GAAG,SAAS,KAAK,SAAS,KAAK,IAAI,CAAC,GAGzEA,EAAK,KAAK,4BAA4B,EAAE,GAAG,SAAS,KAAK,YAAY,KAAK,IAAI,CAAC,GAC/EA,EAAK,KAAK,6BAA6B,EAAE,GAAG,SAAS,KAAK,aAAa,KAAK,IAAI,CAAC,GACjFA,EAAK,KAAK,4BAA4B,EAAE,GAAG,SAAS,KAAK,YAAY,KAAK,IAAI,CAAC,GAC/EA,EAAK,KAAK,8BAA8B,EAAE,GAAG,SAAS,KAAK,aAAa,KAAK,IAAI,CAAC,GAClFA,EAAK,KAAK,iCAAiC,EAAE,GAAG,SAAS,KAAK,iBAAiB,KAAK,IAAI,CAAC,GACzFA,EAAK,KAAK,iCAAiC,EAAE,GAAG,SAAS,KAAK,gBAAgB,KAAK,IAAI,CAAC,GACxFA,EAAK,KAAK,4BAA4B,EAAE,GAAG,SAAS,KAAK,YAAY,KAAK,IAAI,CAAC,GAG/EA,EAAK,KAAK,kCAAkC,EAAE,GAAG,SAAS,KAAK,gBAAgB,KAAK,IAAI,CAAC,GAGzFA,EAAK,KAAK,iCAAiC,EAAE,GAAG,SAAS,KAAK,iBAAiB,KAAK,IAAI,CAAC,GACzFA,EAAK,KAAK,iCAAiC,EAAE,GAAG,SAAS,KAAK,iBAAiB,KAAK,IAAI,CAAC,GACzFA,EAAK,KAAK,0CAA0C,EAAE,GAAG,SAAS,KAAK,yBAAyB,KAAK,IAAI,CAAC,GAC1GA,EAAK,KAAK,+BAA+B,EAAE,GAAG,SAAS,KAAK,eAAe,KAAK,IAAI,CAAC,GAGrFA,EAAK,KAAK,uCAAuC,EAAE,GAAG,SAAS,KAAK,sBAAsB,KAAK,IAAI,CAAC,GAGpG,KAAK,iBAAiBA,CAAI,GAG1B,KAAK,kBAAkBA,CAAI,GAE3BvF,EAAO,MAAM,qCAAqC;AAAA,EACpD;AAAA;AAAA;AAAA;AAAA,EAMA,MAAc,WAAWwF,GAAyC;AAChE,IAAAA,EAAM,eAAA,GAEK,IAAI,WAAW;AAAA,MACxB,MAAM;AAAA,MACN,UAAU,OAAO0B,MAAiB;AAChC,cAAM,KAAK,iBAAiBA,CAAI;AAAA,MAClC;AAAA,IAAA,CACD,EACE,OAAO,EAAI;AAAA,EAChB;AAAA,EAEA,MAAc,iBAAiBA,GAAc1G,IAAoB,SAAwB;AThV3F,QAAAL,GAAAgH;ASiVI,QAAI;AACF,YAAMhB,IAAO,MAAM,KAAK,QAAQ,QAAQe,GAAM,QAAW1G,CAAK;AAC9D,WAAK,OAAA,IACLL,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK,qBAAqBgG,EAAK,IAAI;AAAA,IACvD,SAASlF,GAAO;AACd,MAAAjB,EAAO,MAAM,mCAAmCiB,CAAK;AACrD,YAAMmG,IAAenG,aAAiB,QAAQA,EAAM,UAAU;AAC9D,OAAAkG,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM,wBAAwBC,CAAY;AAAA,IAC9D;AAAA,EACF;AAAA,EAEA,MAAc,iBAAiB5B,GAAyC;AT5V1E,QAAArF,GAAAgH;AS6VI,IAAA3B,EAAM,eAAA;AACN,UAAM6B,IAAS,EAAE7B,EAAM,aAAa,EAAE,QAAQ,gBAAgB,EAAE,KAAK,SAAS;AAE9E,QAAI;AACF,YAAM8B,IAAa,KAAK,QAAQ,eAAeD,CAAM;AACrD,WAAK,OAAA,IACLlH,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAKmH,IAAa,uBAAuB;AAAA,IAC7D,SAASrG,GAAO;AACd,MAAAjB,EAAO,MAAM,8BAA8BiB,CAAK,IAChDkG,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM;AAAA,IAC1B;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAOA,MAAc,iBAAiB3B,GAAyC;AT/W1E,QAAArF,GAAAgH;ASgXI,IAAA3B,EAAM,eAAA;AAEN,UAAM+B,IAAO,MAAM,KAAK,mBAAA;AACxB,QAAKA;AAEL,UAAI;AACF,cAAMnB,IAAW,KAAK,QAAQ,UAAU,eAAemB,CAAI;AAC3D,aAAK,OAAA,IACLpH,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK,qBAAqBiG,EAAS,IAAI;AAAA,MAC3D,SAASnF,GAAO;AACd,QAAAjB,EAAO,MAAM,8BAA8BiB,CAAK;AAChD,cAAMmG,IAAenG,aAAiB,QAAQA,EAAM,UAAU;AAC9D,SAAAkG,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM,8BAA8BC,CAAY;AAAA,MACpE;AAAA,EACF;AAAA,EAEA,MAAc,yBAAyB5B,GAAyC;AThYlF,QAAArF,GAAAgH;ASiYI,IAAA3B,EAAM,eAAA,GACNA,EAAM,gBAAA;AAEN,UAAMgC,IAAa,EAAEhC,EAAM,aAAa,EAAE,QAAQ,oBAAoB,EAAE,KAAK,aAAa;AAE1F,QAAI;AACF,YAAM8B,IAAa,KAAK,QAAQ,UAAU,uBAAuBE,CAAU;AAC3E,WAAK,OAAA,IACLrH,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAKmH,IAAa,uBAAuB;AAAA,IAC7D,SAASrG,GAAO;AACd,MAAAjB,EAAO,MAAM,uCAAuCiB,CAAK,IACzDkG,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM;AAAA,IAC1B;AAAA,EACF;AAAA,EAEA,MAAc,sBAAsB3B,GAAyC;AThZ/E,QAAArF,GAAAgH;ASiZI,IAAA3B,EAAM,eAAA,GACNA,EAAM,gBAAA;AAEN,UAAMiC,IAAa,EAAEjC,EAAM,aAAa,EAAE,QAAQ,oBAAoB,EAAE,KAAK,aAAa,GACpFkC,IAAe,EAAElC,EAAM,aAAa,EAAE,QAAQ,sBAAsB,EAAE,KAAK,eAAe;AAEhG,QAAI;AACF,MAAIkC,MAAiB,UACnB,KAAK,QAAQ,eAAeD,CAAU,IAC7BC,MAAiB,cAC1B,KAAK,QAAQ,UAAU,uBAAuBD,CAAU,GAE1D,KAAK,OAAA,IACLtH,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK;AAAA,IACzB,SAASc,GAAO;AACd,MAAAjB,EAAO,MAAM,oCAAoCiB,CAAK,IACtDkG,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM;AAAA,IAC1B;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAMQ,SAAS3B,GAAoC;AACnD,UAAMoB,KAAS,EAAEpB,EAAM,aAAa,EAAE,IAAA,KAAmB,IAAI,KAAA;AAC7D,SAAK,YAAY,cAAcoB,GAC/B,KAAK,OAAA,GACL5G,EAAO,MAAM,WAAW4G,CAAK;AAAA,EAC/B;AAAA,EAEQ,gBAAgBpB,GAAgC;AACtD,IAAAA,EAAM,eAAA;AACN,UAAMnC,IAAU,EAAEmC,EAAM,aAAa,EAAE,KAAK,SAAS;AAErD,IAAI,KAAK,YAAY,iBAAiB,IAAInC,CAAO,IAC/C,KAAK,YAAY,iBAAiB,OAAOA,CAAO,IAEhD,KAAK,YAAY,iBAAiB,IAAIA,CAAO,GAG/C,KAAK,OAAA,GACLrD,EAAO,MAAM,2BAA2BqD,CAAO;AAAA,EACjD;AAAA,EAEQ,aAAamC,GAAiC;AACpD,UAAMmC,IAAY,EAAEnC,EAAM,aAAa,EAAE,IAAA;AACzC,SAAK,YAAY,SAASmC,GAC1B,KAAK,OAAA,GACL3H,EAAO,MAAM,iBAAiB2H,CAAS;AAAA,EACzC;AAAA,EAEQ,eAAenC,GAAgC;ATrczD,QAAArF;ASscI,IAAAqF,EAAM,eAAA,GAGN,KAAK,YAAY,cAAc,IAC/B,KAAK,YAAY,mBAAmB,oBAAI,IAAI,CAAC,SAAS,YAAY,KAAK,CAAC,GACxE,KAAK,YAAY,qBAAqB,MACtC,KAAK,YAAY,aAAa,MAAA,GAE9B,KAAK,OAAA,IACLrF,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK;AAAA,EACzB;AAAA;AAAA;AAAA;AAAA,EAMQ,YAAYqF,GAAgC;AAClD,IAAAA,EAAM,eAAA;AACN,UAAMc,IAAM,EAAEd,EAAM,aAAa,EAAE,KAAK,KAAK;AAE7C,IAAI,KAAK,YAAY,aAAa,IAAIc,CAAG,IACvC,KAAK,YAAY,aAAa,OAAOA,CAAG,IAExC,KAAK,YAAY,aAAa,IAAIA,CAAG,GAGvC,KAAK,OAAA,GACLtG,EAAO,MAAM,eAAesG,GAAK,kBAAkB,MAAM,KAAK,KAAK,YAAY,YAAY,CAAC;AAAA,EAC9F;AAAA,EAEA,MAAc,SAASd,GAAyC;ATpelE,QAAArF;ASqeI,IAAAqF,EAAM,eAAA;AAEN,UAAMoC,IAAU,MAAM,KAAK,cAAA;AAC3B,IAAKA,MAIL5H,EAAO,MAAM,YAAY4H,CAAO,IAChCzH,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK,QAAQyH,CAAO;AAAA,EACxC;AAAA;AAAA;AAAA;AAAA,EAMQ,YAAYpC,GAAgC;ATpftD,QAAArF;ASqfI,IAAAqF,EAAM,eAAA,GACNA,EAAM,gBAAA;AACN,UAAM6B,IAAS,EAAE7B,EAAM,aAAa,EAAE,KAAK,SAAS;AAEpD,IAAAxF,EAAO,MAAM,eAAeqH,CAAM,GAClCrH,EAAO,MAAM,eAAeqH,CAAM,IAClClH,IAAA,OAAO,IAAI,WAAX,QAAAA,EAAmB,UAAUkH;AAAA,EAI/B;AAAA,EAEQ,YAAY7B,GAAgC;ATjgBtD,QAAArF;ASkgBI,IAAAqF,EAAM,eAAA,GACNA,EAAM,gBAAA;AACN,UAAM6B,IAAS,EAAE7B,EAAM,aAAa,EAAE,KAAK,SAAS;AAEpD,IAAAxF,EAAO,MAAM,eAAeqH,CAAM,IAClClH,IAAA,OAAO,IAAI,WAAX,QAAAA,EAAmB,UAAUkH;AAAA,EAC/B;AAAA,EAEQ,aAAa7B,GAAgC;AT1gBvD,QAAArF;AS2gBI,IAAAqF,EAAM,eAAA,GACNA,EAAM,gBAAA;AACN,UAAM6B,IAAS,EAAE7B,EAAM,aAAa,EAAE,KAAK,SAAS;AACpD,IAAAxF,EAAO,MAAM,gBAAgBqH,CAAM,IACnClH,IAAA,OAAO,IAAI,WAAX,QAAAA,EAAmB,WAAWkH;AAAA,EAChC;AAAA,EAEQ,aAAa7B,GAAgC;ATlhBvD,QAAArF;ASmhBI,IAAAqF,EAAM,eAAA,GACNA,EAAM,gBAAA;AACN,UAAM6B,IAAS,EAAE7B,EAAM,aAAa,EAAE,KAAK,SAAS;AACpD,IAAAxF,EAAO,MAAM,iBAAiBqH,CAAM,IAEpClH,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK;AAAA,EACzB;AAAA,EAEA,MAAc,gBAAgBqF,GAAyC;AT3hBzE,QAAArF;AS4hBI,IAAAqF,EAAM,eAAA,GACNA,EAAM,gBAAA;AACN,UAAM6B,IAAS,EAAE7B,EAAM,aAAa,EAAE,KAAK,SAAS;AACpD,IAAAxF,EAAO,MAAM,qBAAqBqH,CAAM,IAIxClH,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK;AAAA,EACzB;AAAA,EAEA,MAAc,gBAAgBqF,GAAyC;ATtiBzE,QAAArF,GAAAgH,GAAAU,GAAAC;ASuiBI,IAAAtC,EAAM,eAAA,GACNA,EAAM,gBAAA;AACN,UAAM6B,IAAS,EAAE7B,EAAM,aAAa,EAAE,KAAK,SAAS,GAC9CW,IAAO,KAAK,QAAQ,QAAQkB,CAAM;AAExC,QAAI,CAAClB,GAAM;AACT,OAAAhG,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM;AACxB;AAAA,IACF;AAEA,UAAM0F,IAAY,KAAK,QAAQ,UAAU,gBAAA;AACzC,QAAIA,EAAU,WAAW,GAAG;AAC1B,OAAAsB,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK;AACvB;AAAA,IACF;AAGA,UAAMY,IAAqB,MAAM,KAAK,wBAAwBlC,CAAS;AACvE,QAAKkC;AAEL,UAAI;AACF,cAAMvH,IAAQ,KAAK,mBAAmB2F,EAAK,IAAI;AAC/C,aAAK,QAAQ,UAAU,mBAAmB4B,GAAoBV,GAAQ7G,CAAK,GAC3E,KAAK,OAAA,IACLqH,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK,UAAU1B,EAAK,IAAI;AAAA,MAC5C,SAASlF,GAAO;AACd,QAAAjB,EAAO,MAAM,oCAAoCiB,CAAK;AACtD,cAAMmG,IAAenG,aAAiB,QAAQA,EAAM,UAAU;AAC9D,SAAA6G,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM,8BAA8BV,CAAY;AAAA,MACpE;AAAA,EACF;AAAA,EAEQ,YAAY5B,GAAgC;ATvkBtD,QAAArF;ASwkBI,IAAAqF,EAAM,eAAA,GACNA,EAAM,gBAAA,GAGS,EAAEA,EAAM,aAAa,EAAE,KAAK,SAAS;AACpD,UAAMwC,IAAe,EAAExC,EAAM,aAAa,EAAE,QAAQ,aAAa,GAG3DyC,IAAmB,IAAI,WAAW,eAAe;AAAA,MACrD,SAAS;AAAA,MACT,YAAY;AAAA,MACZ,MAAM;AAAA,MACN,SAASzC,EAAM;AAAA,MACf,SAASA,EAAM;AAAA,IAAA,CAChB;AACD,KAAArF,IAAA6H,EAAa,CAAC,MAAd,QAAA7H,EAAiB,cAAc8H;AAAA,EACjC;AAAA;AAAA;AAAA;AAAA,EAMQ,iBAAiBzC,GAAgC;AACvD,IAAAA,EAAM,eAAA;AACN,UAAMgC,IAAa,EAAEhC,EAAM,aAAa,EAAE,KAAK,aAAa;AAG5D,IAAI,KAAK,YAAY,uBAAuBgC,IAE1C,KAAK,YAAY,qBAAqB,OAEtC,KAAK,YAAY,qBAAqBA,GAGxC,KAAK,OAAA,GACLxH,EAAO,MAAM,oBAAoBwH,CAAU;AAAA,EAC7C;AAAA,EAEQ,eAAehC,GAAgC;AT9mBzD,QAAArF;AS+mBI,IAAAqF,EAAM,eAAA,GACNA,EAAM,gBAAA,GAGa,EAAEA,EAAM,aAAa,EAAE,KAAK,aAAa;AAC5D,UAAM0C,IAAkB,EAAE1C,EAAM,aAAa,EAAE,QAAQ,gBAAgB,GAGjEyC,IAAmB,IAAI,WAAW,eAAe;AAAA,MACrD,SAAS;AAAA,MACT,YAAY;AAAA,MACZ,MAAM;AAAA,MACN,SAASzC,EAAM;AAAA,MACf,SAASA,EAAM;AAAA,IAAA,CAChB;AACD,KAAArF,IAAA+H,EAAgB,CAAC,MAAjB,QAAA/H,EAAoB,cAAc8H;AAAA,EACpC;AAAA;AAAA;AAAA;AAAA,EAMQ,iBAAiB1C,GAAoB;AAE3C,IAAAA,EAAK,KAAK,+BAA+B,EAAE,GAAG,aAAa,CAACC,MAAiC;AAC3F,YAAM6B,IAAS,EAAE7B,EAAM,aAAa,EAAE,KAAK,SAAS;AACpD,MAAAA,EAAM,cAAe,aAAc,gBAAgB,QACnDA,EAAM,cAAe,aAAc,QAAQ,cAAc6B,CAAM,GAC/D,EAAE7B,EAAM,aAAa,EAAE,SAAS,UAAU;AAAA,IAC5C,CAAC,GAGDD,EAAK,KAAK,+BAA+B,EAAE,GAAG,WAAW,CAACC,MAA+B;AACvF,QAAEA,EAAM,aAAa,EAAE,YAAY,UAAU;AAAA,IAC/C,CAAC,GAGDD,EAAK,KAAK,gBAAgB,EAAE,GAAG,YAAY,CAACC,MAAgC;AAC1E,MAAAA,EAAM,eAAA,GACNA,EAAM,cAAe,aAAc,aAAa,QAChD,EAAEA,EAAM,aAAa,EAAE,SAAS,WAAW;AAAA,IAC7C,CAAC,GAEDD,EAAK,KAAK,gBAAgB,EAAE,GAAG,aAAa,CAACC,MAAiC;AAC5E,QAAEA,EAAM,aAAa,EAAE,YAAY,WAAW;AAAA,IAChD,CAAC,GAEDD,EAAK,KAAK,gBAAgB,EAAE,GAAG,QAAQ,OAAOC,MAA4B;AACxE,MAAAA,EAAM,eAAA;AACN,YAAM6B,IAAS7B,EAAM,cAAe,aAAc,QAAQ,YAAY,GAChEgC,IAAa,EAAEhC,EAAM,aAAa,EAAE,KAAK,aAAa;AAC5D,QAAEA,EAAM,aAAa,EAAE,YAAY,WAAW,GAE9C,MAAM,KAAK,0BAA0B6B,GAAQG,CAAU;AAAA,IACzD,CAAC,GAGDjC,EAAK,KAAK,eAAe,EAAE,GAAG,YAAY,CAACC,MAAgC;AACzE,MAAAA,EAAM,eAAA,GACN,EAAEA,EAAM,aAAa,EAAE,SAAS,kBAAkB;AAAA,IACpD,CAAC,GAEDD,EAAK,KAAK,eAAe,EAAE,GAAG,aAAa,CAACC,MAAiC;AAC3E,QAAEA,EAAM,aAAa,EAAE,YAAY,kBAAkB;AAAA,IACvD,CAAC,GAEDD,EAAK,KAAK,eAAe,EAAE,GAAG,QAAQ,OAAOC,MAA4B;ATjrB7E,UAAArF,GAAAgH,GAAAU,GAAAC;ASkrBM,MAAAtC,EAAM,eAAA,GACN,EAAEA,EAAM,aAAa,EAAE,YAAY,kBAAkB;AAGrD,YAAM2C,KAAQhB,KAAAhH,IAAAqF,EAAM,kBAAN,gBAAArF,EAAqB,iBAArB,gBAAAgH,EAAmC;AACjD,UAAIgB,KAASA,EAAM,SAAS,GAAG;AAS7B,YARAnI,EAAO,MAAM,WAAWmI,EAAM,MAAM,gBAAgB,KAOjCL,KAAAD,IAAArC,EAAM,kBAAN,gBAAAqC,EAAqB,iBAArB,gBAAAC,EAAmC,QAAQ,kBAC5C,CAACK,EAAM;AAGvB;AAIF,cAAM,KAAK,iBAAiBA,CAAK;AAAA,MACnC;AAAA,IACF,CAAC;AAAA,EACH;AAAA,EAEA,MAAc,0BAA0Bd,GAAgBG,GAAmC;AT5sB7F,QAAArH,GAAAgH,GAAAU;AS6sBI,UAAM1B,IAAO,KAAK,QAAQ,QAAQkB,CAAM,GAClCjB,IAAW,KAAK,QAAQ,UAAU,YAAYoB,CAAU;AAE9D,QAAI,CAACrB,KAAQ,CAACC,GAAU;AACtB,OAAAjG,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM;AACxB;AAAA,IACF;AAEA,QAAI;AACF,YAAMK,IAAQ,KAAK,mBAAmB2F,EAAK,IAAI;AAC/C,WAAK,QAAQ,UAAU,mBAAmBqB,GAAYH,GAAQ7G,CAAK,GACnE,KAAK,OAAA,IACL2G,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK,UAAUhB,EAAK,IAAI,SAASC,EAAS,IAAI;AAAA,IAClE,SAASnF,GAAO;AACd,MAAAjB,EAAO,MAAM,oCAAoCiB,CAAK;AACtD,YAAMmG,IAAenG,aAAiB,QAAQA,EAAM,UAAU;AAC9D,OAAA4G,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM,8BAA8BT,CAAY;AAAA,IACpE;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAMQ,kBAAkB7B,GAAoB;AAE5C,QAAI,YAAYA,GAAM,eAAe;AAAA,MACnC;AAAA,QACE,MAAM;AAAA,QACN,MAAM;AAAA,QACN,UAAU,OAAO6C,MAAe;AAC9B,gBAAMf,IAASe,EAAG,KAAK,SAAS;AAChC,gBAAM,KAAK,gBAAgBf,CAAM;AAAA,QACnC;AAAA,MAAA;AAAA,MAEF;AAAA,QACE,MAAM;AAAA,QACN,MAAM;AAAA,QACN,UAAU,OAAOe,MAAe;AAC9B,gBAAMf,IAASe,EAAG,KAAK,SAAS;AAChC,gBAAM,KAAK,gBAAgBf,CAAM;AAAA,QACnC;AAAA,MAAA;AAAA,MAEF;AAAA,QACE,MAAM;AAAA,QACN,MAAM;AAAA,QACN,UAAU,OAAOe,MAAe;AT3vBxC,cAAAjI,GAAAgH,GAAAU;AS4vBU,gBAAMR,IAASe,EAAG,KAAK,SAAS,GAC1BjC,IAAO,KAAK,QAAQ,QAAQkB,CAAM;AACxC,cAAI,CAAClB,EAAM;AAEX,gBAAMN,IAAY,KAAK,QAAQ,UAAU,gBAAA;AACzC,cAAIA,EAAU,WAAW,GAAG;AAC1B,aAAA1F,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK;AACvB;AAAA,UACF;AAEA,gBAAM4H,IAAqB,MAAM,KAAK,wBAAwBlC,CAAS;AACvE,cAAKkC;AAEL,gBAAI;AACF,oBAAMvH,IAAQ,KAAK,mBAAmB2F,EAAK,IAAI;AAC/C,mBAAK,QAAQ,UAAU,mBAAmB4B,GAAoBV,GAAQ7G,CAAK,GAC3E,KAAK,OAAA,IACL2G,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK,UAAUhB,EAAK,IAAI;AAAA,YAC5C,SAASlF,GAAO;AACd,cAAAjB,EAAO,MAAM,oCAAoCiB,CAAK;AACtD,oBAAMmG,IAAenG,aAAiB,QAAQA,EAAM,UAAU;AAC9D,eAAA4G,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM,8BAA8BT,CAAY;AAAA,YACpE;AAAA,QACF;AAAA,MAAA;AAAA,MAEF;AAAA,QACE,MAAM;AAAA,QACN,MAAM;AAAA,QACN,UAAU,CAACgB,MAAe;ATxxBlC,cAAAjI,GAAAgH;ASyxBU,gBAAME,IAASe,EAAG,KAAK,SAAS;AAChC,cAAI;AACF,kBAAMd,IAAa,KAAK,QAAQ,eAAeD,CAAM;AACrD,iBAAK,OAAA,IACLlH,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAKmH,IAAa,uBAAuB;AAAA,UAC7D,SAASrG,GAAO;AACd,YAAAjB,EAAO,MAAM,8BAA8BiB,CAAK,IAChDkG,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM;AAAA,UAC1B;AAAA,QACF;AAAA,MAAA;AAAA,MAEF;AAAA,QACE,MAAM;AAAA,QACN,MAAM;AAAA,QACN,UAAU,OAAOiB,MAAe;AAC9B,gBAAMf,IAASe,EAAG,KAAK,SAAS;AAChC,gBAAM,KAAK,qBAAqBf,CAAM;AAAA,QACxC;AAAA,MAAA;AAAA,IACF,CACD,GAGD,IAAI,YAAY9B,GAAM,kBAAkB;AAAA,MACtC;AAAA,QACE,MAAM;AAAA,QACN,MAAM;AAAA,QACN,UAAU,OAAO6C,MAAe;AAC9B,gBAAMZ,IAAaY,EAAG,KAAK,aAAa;AACxC,gBAAM,KAAK,iBAAiBZ,CAAU;AAAA,QACxC;AAAA,MAAA;AAAA,MAEF;AAAA,QACE,MAAM;AAAA,QACN,MAAM;AAAA,QACN,UAAU,OAAOY,MAAe;AAC9B,gBAAMZ,IAAaY,EAAG,KAAK,aAAa;AACxC,gBAAM,KAAK,0BAA0BZ,CAAU;AAAA,QACjD;AAAA,MAAA;AAAA,MAEF;AAAA,QACE,MAAM;AAAA,QACN,MAAM;AAAA,QACN,UAAU,OAAOY,MAAe;AAC9B,gBAAMZ,IAAaY,EAAG,KAAK,aAAa;AACxC,gBAAM,KAAK,uBAAuBZ,CAAU;AAAA,QAC9C;AAAA,MAAA;AAAA,MAEF;AAAA,QACE,MAAM;AAAA,QACN,MAAM;AAAA,QACN,UAAU,OAAOY,MAAe;AAC9B,gBAAMZ,IAAaY,EAAG,KAAK,aAAa;AACxC,gBAAM,KAAK,gBAAgBZ,CAAU;AAAA,QACvC;AAAA,MAAA;AAAA,MAEF;AAAA,QACE,MAAM;AAAA,QACN,MAAM;AAAA,QACN,UAAU,OAAOY,MAAe;AAC9B,gBAAMZ,IAAaY,EAAG,KAAK,aAAa;AACxC,gBAAM,KAAK,wBAAwBZ,CAAU;AAAA,QAC/C;AAAA,MAAA;AAAA,IACF,CACD,GAGD,IAAI,YAAYjC,GAAM,wBAAwB;AAAA,MAC5C;AAAA,QACE,MAAM;AAAA,QACN,MAAM;AAAA,QACN,UAAU,OAAO6C,MAAe;AAC9B,gBAAMR,IAAUQ,EAAG,KAAK,KAAK;AAC7B,gBAAM,KAAK,YAAYR,CAAO;AAAA,QAChC;AAAA,MAAA;AAAA,MAEF;AAAA,QACE,MAAM;AAAA,QACN,MAAM;AAAA,QACN,UAAU,OAAOQ,MAAe;AAC9B,gBAAMR,IAAUQ,EAAG,KAAK,KAAK;AAC7B,gBAAM,KAAK,YAAYR,CAAO;AAAA,QAChC;AAAA,MAAA;AAAA,IACF,CACD;AAAA,EACH;AAAA;AAAA;AAAA;AAAA,EAMA,MAAc,gBAAgBP,GAA+B;ATn3B/D,QAAAlH,GAAAgH,GAAAU;ASo3BI,UAAM1B,IAAO,KAAK,QAAQ,QAAQkB,CAAM;AACxC,QAAI,CAAClB,GAAM;AACT,OAAAhG,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM;AACxB;AAAA,IACF;AAEA,UAAMkI,IAAU,MAAM,KAAK,gBAAgB,mBAAmB,cAAclC,EAAK,IAAI;AACrF,QAAI,GAACkC,KAAWA,MAAYlC,EAAK;AAEjC,UAAI;AACF,aAAK,QAAQ,WAAWkB,GAAQ,EAAE,MAAMgB,GAAS,GACjD,KAAK,OAAA,IACLlB,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK,eAAekB,CAAO;AAAA,MAC/C,SAASpH,GAAO;AACd,QAAAjB,EAAO,MAAM,2BAA2BiB,CAAK,IAC7C4G,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM;AAAA,MAC1B;AAAA,EACF;AAAA,EAEA,MAAc,gBAAgBR,GAA+B;ATv4B/D,QAAAlH,GAAAgH,GAAAU;ASw4BI,UAAM1B,IAAO,KAAK,QAAQ,QAAQkB,CAAM;AACxC,QAAI,CAAClB,GAAM;AACT,OAAAhG,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM;AACxB;AAAA,IACF;AAEA,UAAMmI,IAAa,MAAM,KAAK;AAAA,MAC5B;AAAA,MACA;AAAA,MACAnC,EAAK,KAAK,KAAK,IAAI;AAAA,IAAA;AAErB,QAAImC,MAAe,KAAM;AAGzB,UAAMC,IAAUD,EACb,MAAM,GAAG,EACT,IAAI,CAAApF,MAAKA,EAAE,KAAA,CAAM,EACjB,OAAO,CAAAA,MAAKA,EAAE,SAAS,CAAC;AAE3B,QAAI;AACF,WAAK,QAAQ,WAAWmE,GAAQ,EAAE,MAAMkB,GAAS,GACjD,KAAK,OAAA,IACLpB,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK;AAAA,IACzB,SAASlG,GAAO;AACd,MAAAjB,EAAO,MAAM,0BAA0BiB,CAAK,IAC5C4G,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM;AAAA,IAC1B;AAAA,EACF;AAAA,EAEA,MAAc,qBAAqBR,GAA+B;ATr6BpE,QAAAlH,GAAAgH,GAAAU;ASs6BI,UAAM1B,IAAO,KAAK,QAAQ,QAAQkB,CAAM;AACxC,QAAI,CAAClB,GAAM;AACT,OAAAhG,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM;AACxB;AAAA,IACF;AAWA,QATkB,MAAM,OAAO,QAAQ;AAAA,MACrC,OAAO;AAAA,MACP,SAAS,8CAA8CgG,EAAK,IAAI;AAAA;AAAA,MAEhE,KAAK,MAAM;AAAA,MACX,IAAI,MAAM;AAAA,MACV,YAAY;AAAA,IAAA,CACb;AAGC,UAAI;AACF,aAAK,QAAQ,WAAWkB,CAAM,GAC9B,KAAK,OAAA,IACLF,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK,YAAYhB,EAAK,IAAI;AAAA,MAC9C,SAASlF,GAAO;AACd,QAAAjB,EAAO,MAAM,2BAA2BiB,CAAK,IAC7C4G,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM;AAAA,MAC1B;AAAA,EAEJ;AAAA;AAAA;AAAA;AAAA,EAMA,MAAc,iBAAiBL,GAAmC;ATr8BpE,QAAArH,GAAAgH,GAAAU;ASs8BI,UAAMzB,IAAW,KAAK,QAAQ,UAAU,YAAYoB,CAAU;AAC9D,QAAI,CAACpB,GAAU;AACb,OAAAjG,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM;AACxB;AAAA,IACF;AAEA,UAAMkI,IAAU,MAAM,KAAK,gBAAgB,mBAAmB,iBAAiBjC,EAAS,IAAI;AAC5F,QAAI,GAACiC,KAAWA,MAAYjC,EAAS;AAErC,UAAI;AACF,aAAK,QAAQ,UAAU,eAAeoB,GAAY,EAAE,MAAMa,GAAS,GACnE,KAAK,OAAA,IACLlB,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK,eAAekB,CAAO;AAAA,MAC/C,SAASpH,GAAO;AACd,QAAAjB,EAAO,MAAM,8BAA8BiB,CAAK;AAChD,cAAMmG,IAAenG,aAAiB,QAAQA,EAAM,UAAU;AAC9D,SAAA4G,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM,8BAA8BT,CAAY;AAAA,MACpE;AAAA,EACF;AAAA,EAEA,MAAc,0BAA0BI,GAAmC;AT19B7E,QAAArH,GAAAgH,GAAAU;AS29BI,UAAMzB,IAAW,KAAK,QAAQ,UAAU,YAAYoB,CAAU;AAC9D,QAAI,CAACpB,GAAU;AACb,OAAAjG,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM;AACxB;AAAA,IACF;AAEA,UAAMqI,IAAc,MAAM,KAAK;AAAA,MAC7B;AAAA,MACA;AAAA,MACApC,EAAS,eAAe;AAAA,IAAA;AAE1B,QAAIoC,MAAgB;AAEpB,UAAI;AACF,aAAK,QAAQ,UAAU,eAAehB,GAAY,EAAE,aAAagB,KAAe,QAAW,GAC3F,KAAK,OAAA,IACLrB,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK;AAAA,MACzB,SAASlG,GAAO;AACd,QAAAjB,EAAO,MAAM,iCAAiCiB,CAAK,IACnD4G,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM;AAAA,MAC1B;AAAA,EACF;AAAA,EAEA,MAAc,uBAAuBL,GAAmC;ATl/B1E,QAAArH;ASm/BI,UAAMiG,IAAW,KAAK,QAAQ,UAAU,YAAYoB,CAAU;AAC9D,QAAI,CAACpB,GAAU;AACb,OAAAjG,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM;AACxB;AAAA,IACF;AAEA,UAAMyF,IAAQQ,EAAS,MACpB,KAAK,CAACY,GAAGC,MAAMD,EAAE,QAAQC,EAAE,KAAK,EAChC,IAAI,CAACwB,GAAcC,MAAU;AAC5B,YAAMC,IAAc,KAAK,QAAQ,QAAQF,EAAa,aAAa,GAC7DlB,KAAOoB,KAAA,gBAAAA,EAAa,SAAQ;AAClC,aAAO,eAAeD,IAAQ,CAAC,cAAcnB,CAAI;AAAA,IACnD,CAAC,EACA,KAAK,EAAE,GAEJqB,IAAU;AAAA;AAAA,qBAECxC,EAAS,IAAI;AAAA,UACxBA,EAAS,cAAc,UAAUA,EAAS,WAAW,cAAc,EAAE;AAAA,2BACpDA,EAAS,MAAM,MAAM;AAAA,UACtCA,EAAS,MAAM,SAAS,IAAI,sCAAsCR,CAAK,UAAU,8BAA8B;AAAA;AAAA;AAIrH,QAAI,OAAO;AAAA,MACT,OAAO;AAAA,MACP,SAAAgD;AAAA,MACA,SAAS;AAAA,QACP,OAAO;AAAA,UACL,MAAM;AAAA,UACN,OAAO;AAAA,QAAA;AAAA,MACT;AAAA,MAEF,SAAS;AAAA,IAAA,CACV,EAAE,OAAO,EAAI;AAAA,EAChB;AAAA,EAEA,MAAc,gBAAgBpB,GAAmC;ATxhCnE,QAAArH,GAAAgH,GAAAU,GAAAC;ASyhCI,UAAM1B,IAAW,KAAK,QAAQ,UAAU,YAAYoB,CAAU;AAC9D,QAAI,CAACpB,GAAU;AACb,OAAAjG,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM;AACxB;AAAA,IACF;AAEA,QAAIiG,EAAS,MAAM,WAAW,GAAG;AAC/B,OAAAe,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK;AACvB;AAAA,IACF;AAWA,QATkB,MAAM,OAAO,QAAQ;AAAA,MACrC,OAAO;AAAA,MACP,SAAS,0CAA0Cf,EAAS,MAAM,MAAM,wBAAwBA,EAAS,IAAI;AAAA;AAAA,MAE7G,KAAK,MAAM;AAAA,MACX,IAAI,MAAM;AAAA,MACV,YAAY;AAAA,IAAA,CACb;AAGC,UAAI;AAGF,QADgB,CAAC,GAAGA,EAAS,MAAM,IAAI,CAAAU,MAAKA,EAAE,EAAE,CAAC,EACzC,QAAQ,CAAAO,MAAU;AACxB,cAAI;AACF,iBAAK,QAAQ,UAAU,wBAAwBG,GAAYH,CAAM;AAAA,UACnE,SAASpG,GAAO;AACd,YAAAjB,EAAO,MAAM,0BAA0BiB,CAAK;AAAA,UAC9C;AAAA,QACF,CAAC,GAED,KAAK,OAAA,IACL4G,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK,qBAAqBzB,EAAS,IAAI;AAAA,MAC3D,SAASnF,GAAO;AACd,QAAAjB,EAAO,MAAM,6BAA6BiB,CAAK,IAC/C6G,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM;AAAA,MAC1B;AAAA,EAEJ;AAAA,EAEA,MAAc,wBAAwBN,GAAmC;ATlkC3E,QAAArH,GAAAgH,GAAAU;ASmkCI,UAAMzB,IAAW,KAAK,QAAQ,UAAU,YAAYoB,CAAU;AAC9D,QAAI,CAACpB,GAAU;AACb,OAAAjG,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM;AACxB;AAAA,IACF;AAWA,QATkB,MAAM,OAAO,QAAQ;AAAA,MACrC,OAAO;AAAA,MACP,SAAS,8CAA8CiG,EAAS,IAAI;AAAA;AAAA,MAEpE,KAAK,MAAM;AAAA,MACX,IAAI,MAAM;AAAA,MACV,YAAY;AAAA,IAAA,CACb;AAGC,UAAI;AAEF,QAAI,KAAK,YAAY,uBAAuBoB,MAC1C,KAAK,YAAY,qBAAqB,OAGxC,KAAK,QAAQ,UAAU,eAAeA,CAAU,GAChD,KAAK,OAAA,IACLL,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK,qBAAqBf,EAAS,IAAI;AAAA,MAC3D,SAASnF,GAAO;AACd,QAAAjB,EAAO,MAAM,8BAA8BiB,CAAK,IAChD4G,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM;AAAA,MAC1B;AAAA,EAEJ;AAAA;AAAA;AAAA;AAAA,EAMA,MAAc,YAAYgB,GAAmC;ATvmC/D,QAAA1I,GAAAgH;ASwmCI,UAAM2B,IAAa,MAAM,KAAK,gBAAgB,cAAc,gBAAgBD,CAAU;AACtF,QAAI,GAACC,KAAcA,MAAeD;AAElC,UAAI;AAEF,cAAMjD,IAAQ,KAAK,QAAQ,YAAA,EAAc,OAAO,CAAAO,MAAQA,EAAK,KAAK,SAAS0C,CAAU,CAAC;AAEtF,QAAAjD,EAAM,QAAQ,CAAAO,MAAQ;AACpB,gBAAM4C,IAAc5C,EAAK,KAAK,IAAI,OAAOG,MAAQuC,IAAaC,IAAaxC,CAAG;AAC9E,eAAK,QAAQ,WAAWH,EAAK,IAAI,EAAE,MAAM4C,GAAa;AAAA,QACxD,CAAC,GAGG,KAAK,YAAY,aAAa,IAAIF,CAAU,MAC9C,KAAK,YAAY,aAAa,OAAOA,CAAU,GAC/C,KAAK,YAAY,aAAa,IAAIC,CAAU,IAG9C,KAAK,OAAA,IACL3I,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK,gBAAgB0I,CAAU,SAASC,CAAU,QAAQlD,EAAM,MAAM;AAAA,MAC1F,SAAS3E,GAAO;AACd,QAAAjB,EAAO,MAAM,yBAAyBiB,CAAK,IAC3CkG,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM;AAAA,MAC1B;AAAA,EACF;AAAA,EAEA,MAAc,YAAYS,GAAgC;ATloC5D,QAAAzH,GAAAgH;ASmoCI,UAAMvB,IAAQ,KAAK,QAAQ,YAAA,EAAc,OAAO,CAAAO,MAAQA,EAAK,KAAK,SAASyB,CAAO,CAAC;AAWnF,QATkB,MAAM,OAAO,QAAQ;AAAA,MACrC,OAAO;AAAA,MACP,SAAS,sDAAsDA,CAAO;AAAA,gFACIhC,EAAM,MAAM;AAAA,MACtF,KAAK,MAAM;AAAA,MACX,IAAI,MAAM;AAAA,MACV,YAAY;AAAA,IAAA,CACb;AAGC,UAAI;AACF,QAAAA,EAAM,QAAQ,CAAAO,MAAQ;AACpB,gBAAM4C,IAAc5C,EAAK,KAAK,OAAO,CAAAG,MAAOA,MAAQsB,CAAO;AAC3D,eAAK,QAAQ,WAAWzB,EAAK,IAAI,EAAE,MAAM4C,GAAa;AAAA,QACxD,CAAC,GAGD,KAAK,YAAY,aAAa,OAAOnB,CAAO,GAE5C,KAAK,OAAA,IACLzH,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK,gBAAgByH,CAAO,UAAUhC,EAAM,MAAM;AAAA,MACtE,SAAS3E,GAAO;AACd,QAAAjB,EAAO,MAAM,yBAAyBiB,CAAK,IAC3CkG,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM;AAAA,MAC1B;AAAA,EAEJ;AAAA;AAAA;AAAA;AAAA,EAMA,MAAc,gBAAwC;AACpD,WAAO,IAAI,QAAQ,CAACvG,MAAY;AAC9B,UAAI,OAAO;AAAA,QACT,OAAO;AAAA,QACP,SAAS;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,QAQT,SAAS;AAAA,UACP,QAAQ;AAAA,YACN,MAAM;AAAA,YACN,OAAO;AAAA,YACP,UAAU,CAAC2E,MAAiB;AAC1B,kBAAIgC,KAAQhC,EAAK,KAAK,mBAAmB,EAAE,IAAA,KAAmB,IAAI,KAAA;AAElE,cAAIgC,EAAK,WAAW,GAAG,MACrBA,IAAOA,EAAK,UAAU,CAAC,IAEzB3G,EAAQ2G,KAAQ,IAAI;AAAA,YACtB;AAAA,UAAA;AAAA,UAEF,QAAQ;AAAA,YACN,MAAM;AAAA,YACN,OAAO;AAAA,YACP,UAAU,MAAM3G,EAAQ,IAAI;AAAA,UAAA;AAAA,QAC9B;AAAA,QAEF,SAAS;AAAA,MAAA,CACV,EAAE,OAAO,EAAI;AAAA,IAChB,CAAC;AAAA,EACH;AAAA,EAEA,MAAc,wBAAwBiF,GAA+C;AACnF,UAAMP,IAAUO,EAAU;AAAA,MAAI,CAAAmD,MAC5B,kBAAkBA,EAAE,EAAE,KAAKA,EAAE,IAAI,KAAKA,EAAE,MAAM,MAAM;AAAA,IAAA,EACpD,KAAK,EAAE;AAET,WAAO,IAAI,QAAQ,CAACpI,MAAY;AAC9B,UAAI,OAAO;AAAA,QACT,OAAO;AAAA,QACP,SAAS;AAAA;AAAA;AAAA;AAAA;AAAA,kBAKC0E,CAAO;AAAA;AAAA;AAAA;AAAA;AAAA,QAKjB,SAAS;AAAA,UACP,KAAK;AAAA,YACH,MAAM;AAAA,YACN,OAAO;AAAA,YACP,UAAU,CAACC,MAAiB;AAC1B,oBAAMiC,IAAajC,EAAK,KAAK,sBAAsB,EAAE,IAAA;AACrD,cAAA3E,EAAQ4G,KAAc,IAAI;AAAA,YAC5B;AAAA,UAAA;AAAA,UAEF,QAAQ;AAAA,YACN,MAAM;AAAA,YACN,OAAO;AAAA,YACP,UAAU,MAAM5G,EAAQ,IAAI;AAAA,UAAA;AAAA,QAC9B;AAAA,QAEF,SAAS;AAAA,MAAA,CACV,EAAE,OAAO,EAAI;AAAA,IAChB,CAAC;AAAA,EACH;AAAA,EAEA,MAAc,qBAA6C;AACzD,WAAO,IAAI,QAAQ,CAACA,MAAY;AAC9B,UAAI,OAAO;AAAA,QACT,OAAO;AAAA,QACP,SAAS;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,QAQT,SAAS;AAAA,UACP,QAAQ;AAAA,YACN,MAAM;AAAA,YACN,OAAO;AAAA,YACP,UAAU,CAAC2E,MAAiB;AAC1B,oBAAMgC,KAAQhC,EAAK,KAAK,wBAAwB,EAAE,IAAA,KAAmB,IAAI,KAAA;AACzE,cAAA3E,EAAQ2G,KAAQ,IAAI;AAAA,YACtB;AAAA,UAAA;AAAA,UAEF,QAAQ;AAAA,YACN,MAAM;AAAA,YACN,OAAO;AAAA,YACP,UAAU,MAAM3G,EAAQ,IAAI;AAAA,UAAA;AAAA,QAC9B;AAAA,QAEF,SAAS;AAAA,MAAA,CACV,EAAE,OAAO,EAAI;AAAA,IAChB,CAAC;AAAA,EACH;AAAA,EAEA,MAAc,gBACZqI,GACAC,GACAC,IAAuB,IACC;AACxB,WAAO,IAAI,QAAQ,CAACvI,MAAY;AAC9B,UAAI,OAAO;AAAA,QACT,OAAAqI;AAAA,QACA,SAAS;AAAA;AAAA;AAAA,uBAGMC,CAAK;AAAA,4DACgCC,CAAY;AAAA;AAAA;AAAA;AAAA,QAIhE,SAAS;AAAA,UACP,MAAM;AAAA,YACJ,MAAM;AAAA,YACN,OAAO;AAAA,YACP,UAAU,CAAC5D,MAAiB;AAC1B,oBAAMnE,KAASmE,EAAK,KAAK,qBAAqB,EAAE,IAAA,KAAmB,IAAI,KAAA;AACvE,cAAA3E,EAAQQ,KAAS,IAAI;AAAA,YACvB;AAAA,UAAA;AAAA,UAEF,QAAQ;AAAA,YACN,MAAM;AAAA,YACN,OAAO;AAAA,YACP,UAAU,MAAMR,EAAQ,IAAI;AAAA,UAAA;AAAA,QAC9B;AAAA,QAEF,SAAS;AAAA,MAAA,CACV,EAAE,OAAO,EAAI;AAAA,IAChB,CAAC;AAAA,EACH;AACF;AClzCO,SAASwI,EACdC,GACAC,GACkC;AAClC,MAAIC,IAAW,GACXC,IAAkD;AAEtD,SAAO,YAAyCtJ,GAAqB;AACnE,UAAMgF,IAAM,KAAK,IAAA,GACXuE,IAAYH,KAASpE,IAAMqE;AAEjC,IAAIE,KAAa,KACXD,MACF,aAAaA,CAAS,GACtBA,IAAY,OAEdD,IAAWrE,GACXmE,EAAG,MAAM,MAAMnJ,CAAI,KACTsJ,MACVA,IAAY,WAAW,MAAM;AAC3B,MAAAD,IAAW,KAAK,IAAA,GAChBC,IAAY,MACZH,EAAG,MAAM,MAAMnJ,CAAI;AAAA,IACrB,GAAGuJ,CAAS;AAAA,EAEhB;AACF;AAEO,SAASC,EACdL,GACAC,GACkC;AAClC,MAAIE,IAAkD;AAEtD,SAAO,YAAyCtJ,GAAqB;AACnE,IAAIsJ,KACF,aAAaA,CAAS,GAExBA,IAAY,WAAW,MAAM;AAC3B,MAAAH,EAAG,MAAM,MAAMnJ,CAAI;AAAA,IACrB,GAAGoJ,CAAK;AAAA,EACV;AACF;ACjCA,MAAM/G,IAAY;AAElB,SAASC,KAA6B;AACpC,SAAQ,KAAK,SAAS,IAAID,GAAW,uBAAuB,KAAgB;AAC9E;AAiCO,MAAMoH,WAAsB,YAAY;AAAA,EAmB7C,YAAYtF,GAAqBuF,GAAuBtE,GAAuC;AAC7F,UAAMA,CAAO;AAnBP,IAAA7E,EAAA;AACA,IAAAA,EAAA;AACA,IAAAA,EAAA,wBAAwD;AAkB9D,SAAK,SAAS4D,GACd,KAAK,SAASuF;AAAA,EAChB;AAAA,EAlBA,WAAoB,iBAAqC;AACvD,WAAO,QAAQ,MAAM,YAAY,MAAM,gBAAgB;AAAA,MACrD,IAAI;AAAA,MACJ,OAAO;AAAA,MACP,UAAU,WAAWrH,CAAS;AAAA,MAC9B,SAAS,CAAC,WAAW;AAAA,MACrB,OAAO;AAAA,MACP,QAAQ;AAAA,MACR,WAAW;AAAA,MACX,aAAa;AAAA,MACb,QAAQ;AAAA,IAAA,CACT;AAAA,EACH;AAAA,EAQS,UAAqB;AAC5B,UAAMe,IAAS,KAAK,OAAO,aAAA,EAAe,IAAI,CAAAP,MAAU,KAAK,iBAAiBA,CAAM,CAAC,GAC/EY,IAAU,KAAK,OAAO,SACtBV,IAAeK,EAAO,OAAO,CAAAJ,MAAKA,EAAE,SAAS,EAAE;AAErD,WAAO;AAAA,MACL,QAAAI;AAAA,MACA,SAAS;AAAA,QACP,QAAQ,KAAK,MAAMK,EAAQ,SAAS,GAAG;AAAA,QACvC,OAAO,KAAK,MAAMA,EAAQ,QAAQ,GAAG;AAAA,QACrC,UAAU,KAAK,MAAMA,EAAQ,WAAW,GAAG;AAAA,QAC3C,KAAK,KAAK,MAAMA,EAAQ,MAAM,GAAG;AAAA,MAAA;AAAA,MAEnC,cAAAV;AAAA,MACA,iBAAiBT,GAAA;AAAA,MACjB,aAAa,KAAK,OAAO;AAAA,IAAA;AAAA,EAE7B;AAAA,EAEQ,iBAAiBO,GAAwC;AAC/D,UAAML,IAAQK,EAAO,SAAA,GACf8G,IAAc9G,EAAO,eAAA,GACrB+G,IAAW/G,EAAO,YAAA;AAExB,WAAO;AAAA,MACL,IAAIL,EAAM;AAAA,MACV,MAAM,KAAK,gBAAgBA,EAAM,GAAG;AAAA,MACpC,OAAOA,EAAM;AAAA,MACb,WAAWA,EAAM,kBAAkB;AAAA,MACnC,UAAUA,EAAM,kBAAkB;AAAA,MAClC,WAAWA,EAAM,kBAAkB;AAAA,MACnC,WAAWA,EAAM,kBAAkB;AAAA,MACnC,QAAQA,EAAM;AAAA,MACd,eAAe,KAAK,MAAMA,EAAM,SAAS,GAAG;AAAA,MAC5C,MAAMA,EAAM;AAAA,MACZ,aAAAmH;AAAA,MACA,sBAAsBrI,EAAWqI,CAAW;AAAA,MAC5C,UAAAC;AAAA,MACA,mBAAmBtI,EAAWsI,CAAQ;AAAA,MACtC,UAAUA,IAAW,IAAKD,IAAcC,IAAY,MAAM;AAAA,IAAA;AAAA,EAE9D;AAAA,EAEQ,gBAAgBnJ,GAAqB;AAC3C,QAAI,CAACA,EAAK,QAAO;AACjB,QAAI;AAEF,YAAMoJ,IADU,mBAAmBpJ,CAAG,EAChB,MAAM,GAAG;AAE/B,aADiBoJ,EAAMA,EAAM,SAAS,CAAC,EACvB,QAAQ,YAAY,EAAE;AAAA,IACxC,QAAQ;AACN,YAAMA,IAAQpJ,EAAI,MAAM,GAAG;AAE3B,aADiBoJ,EAAMA,EAAM,SAAS,CAAC,EACvB,QAAQ,YAAY,EAAE;AAAA,IACxC;AAAA,EACF;AAAA,EAES,kBAAkBxE,GAAoB;AAC7C,UAAM,kBAAkBA,CAAI,GAG5BA,EAAK,KAAK,kBAAkB,EAAE,GAAG,UAAU,CAACC,MAAU;AACpD,YAAMlB,IAAWkB,EAAM,OAA4B;AACnD,WAAK,OAAO,eAAelB,CAAO,GAClC,KAAK,oBAAoBiB,GAAMjB,CAAO;AAAA,IACxC,CAAC;AAGD,UAAM0F,IAAyBZ,EAAS,CAAC/F,GAAiBjC,MAAkB;AAC1E,MAAIiC,MAAY,YACd,KAAK,OAAO,gBAAgBjC,CAAK,GACjC,KAAK,OAAO,uBAAuB,UAAUA,CAAK,MAElD,KAAK,OAAO,iBAAiBiC,GAAuBjC,CAAK,GACzD,KAAK,OAAO,uBAAuBiC,GAAuBjC,CAAK;AAAA,IAEnE,GAAG,EAAE;AAEL,IAAAmE,EAAK,KAAK,qBAAqB,EAAE,GAAG,SAAS,CAACC,MAAU;AACtD,YAAMnC,IAAU,EAAEmC,EAAM,aAAa,EAAE,KAAK,SAAS,GAC/CpE,IAAQ,WAAYoE,EAAM,OAA4B,KAAK,IAAI;AACrE,MAAAwE,EAAuB3G,GAASjC,CAAK,GACrC,EAAEoE,EAAM,aAAa,EAAE,SAAS,oBAAoB,EAAE,KAAK,GAAG,KAAK,MAAMpE,IAAQ,GAAG,CAAC,GAAG;AAAA,IAC1F,CAAC,GAGDmE,EAAK,KAAK,gBAAgB,EAAE,GAAG,SAAS,MAAM,KAAK,YAAY;AAG/D,UAAMjC,IAASiC,EAAK,KAAK,aAAa;AAEtC,IAAAjC,EAAO,GAAG,SAAS,iBAAiB,CAACkC,MAAU;AAC7C,YAAM3C,IAAU,EAAE2C,EAAM,aAAa,EAAE,QAAQ,YAAY,EAAE,KAAK,UAAU;AAC5E,WAAK,YAAY3C,CAAO;AAAA,IAC1B,CAAC,GAEDS,EAAO,GAAG,SAAS,kBAAkB,CAACkC,MAAU;AAC9C,YAAM3C,IAAU,EAAE2C,EAAM,aAAa,EAAE,QAAQ,YAAY,EAAE,KAAK,UAAU;AAC5E,WAAK,aAAa3C,CAAO;AAAA,IAC3B,CAAC,GAEDS,EAAO,GAAG,SAAS,iBAAiB,CAACkC,MAAU;AAC7C,YAAM3C,IAAU,EAAE2C,EAAM,aAAa,EAAE,QAAQ,YAAY,EAAE,KAAK,UAAU;AAC5E,WAAK,YAAY3C,CAAO;AAAA,IAC1B,CAAC,GAEDS,EAAO,GAAG,SAAS,mBAAmB,CAACkC,MAAU;AAC/C,YAAM3C,IAAU,EAAE2C,EAAM,aAAa,EAAE,QAAQ,YAAY,EAAE,KAAK,UAAU;AAC5E,WAAK,cAAc3C,CAAO;AAAA,IAC5B,CAAC,GAEDS,EAAO,GAAG,UAAU,oBAAoB,CAACkC,MAAU;AACjD,YAAM3C,IAAU,EAAE2C,EAAM,aAAa,EAAE,QAAQ,YAAY,EAAE,KAAK,UAAU,GACtEpC,IAAQoC,EAAM,OAA4B;AAChD,WAAK,OAAO,aAAa3C,GAASO,CAAI,GACtC,KAAK,OAAO,mBAAmBP,GAASO,CAAI;AAAA,IAC9C,CAAC,GAEDE,EAAO,GAAG,UAAU,uBAAuB,CAACkC,MAAU;AACpD,YAAM3C,IAAU,EAAE2C,EAAM,aAAa,EAAE,KAAK,UAAU,GAChDnC,IAAWmC,EAAM,OAA6B;AACpD,WAAK,OAAO,gBAAgB3C,GAASQ,CAAO;AAAA,IAC9C,CAAC;AAGD,UAAM4G,IAAkBb,EAAS,CAACvG,GAAiBzB,MAAkB;AACnE,WAAK,OAAO,eAAeyB,GAASzB,CAAK,GACzC,KAAK,OAAO,qBAAqByB,GAASzB,CAAK;AAAA,IACjD,GAAG,EAAE;AAEL,IAAAkC,EAAO,GAAG,SAAS,sBAAsB,CAACkC,MAAU;AAClD,YAAM3C,IAAU,EAAE2C,EAAM,aAAa,EAAE,QAAQ,YAAY,EAAE,KAAK,UAAU,GACtEpE,IAAQ,WAAYoE,EAAM,OAA4B,KAAK,IAAI;AACrE,MAAAyE,EAAgBpH,GAASzB,CAAK,GAC9B,EAAEoE,EAAM,aAAa,EAAE,SAAS,mBAAmB,EAAE,KAAK,GAAG,KAAK,MAAMpE,IAAQ,GAAG,CAAC,GAAG;AAAA,IACzF,CAAC;AAGD,UAAM8I,IAAgBd,EAAS,CAACvG,GAAiB3B,MAAiB;AAChE,YAAM6B,IAAS,KAAK,OAAO,SAASF,CAAO,GACrCkB,KAAYhB,KAAA,gBAAAA,EAAQ,WAAU;AACpC,WAAK,OAAO,UAAUF,GAAS3B,CAAI,GACnC,KAAK,OAAO,mBAAmB2B,GAAS3B,GAAM6C,KAAa,EAAK;AAAA,IAClE,GAAG,GAAG;AAEN,IAAAT,EAAO,GAAG,SAAS,oBAAoB,CAACkC,MAAU;AAChD,YAAM3C,IAAU,EAAE2C,EAAM,aAAa,EAAE,QAAQ,YAAY,EAAE,KAAK,UAAU,GACtEzC,IAAS,KAAK,OAAO,SAASF,CAAO;AAC3C,UAAIE,GAAQ;AAEV,cAAM7B,IADU,WAAYsE,EAAM,OAA4B,KAAK,IAC3C,MAAOzC,EAAO,YAAA;AACtC,QAAAmH,EAAcrH,GAAS3B,CAAI;AAAA,MAC7B;AAAA,IACF,CAAC,GAGDqE,EAAK,KAAK,eAAe,EAAE,GAAG,SAAS,MAAM;AAC3C,WAAK,OAAO,QAAA,GACZ,KAAK,OAAO,iBAAA,GACZ,KAAK,OAAA;AAAA,IACP,CAAC,GAED,KAAK,aAAA;AAAA,EACP;AAAA,EAEQ,oBAAoBA,GAAcjB,GAAwB;AAChE,UAAM6F,IAAY5E,EAAK,KAAK,kBAAkB;AAC9C,IAAA4E,EAAU,YAAY,aAAa7F,CAAO,GAC1C6F,EAAU,KAAK,MAAM,EAAE,KAAK7F,IAAU,YAAY,UAAU;AAAA,EAC9D;AAAA,EAEQ,eAAqB;AAC3B,SAAK,YAAA,GACL,KAAK,iBAAiB,YAAY,MAAM;AACtC,WAAK,oBAAA;AAAA,IACP,GAAG,GAAG;AAAA,EACR;AAAA,EAEQ,cAAoB;AAC1B,IAAI,KAAK,mBACP,cAAc,KAAK,cAAc,GACjC,KAAK,iBAAiB;AAAA,EAE1B;AAAA,EAEQ,sBAA4B;AAClC,UAAMiB,IAAO,KAAK;AAClB,QAAI,CAACA,KAAQ,CAACA,EAAK,OAAQ;AAE3B,QAAItC,IAAe;AAEnB,eAAWF,KAAU,KAAK,OAAO,aAAA,GAAgB;AAC/C,YAAMqH,IAAU7E,EAAK,KAAK,6BAA6BxC,EAAO,EAAE,IAAI;AACpE,UAAI,CAACqH,EAAQ,OAAQ;AAErB,YAAMP,IAAc9G,EAAO,eAAA,GACrB+G,IAAW/G,EAAO,YAAA,GAClBsH,IAAWP,IAAW,IAAKD,IAAcC,IAAY,MAAM,GAC3DpH,IAAQK,EAAO;AAErB,MAAIL,MAAU,aAAWO,KAEzBmH,EAAQ,KAAK,mBAAmB,EAAE,KAAK5I,EAAWqI,CAAW,CAAC;AAE9D,YAAMS,IAAaF,EAAQ,KAAK,kBAAkB;AAClD,MAAKE,EAAW,GAAG,SAAS,KAC1BA,EAAW,IAAID,CAAQ,GAGzBD,EAAQ,YAAY,4CAA4C,GAChEA,EAAQ,SAAS,MAAM1H,CAAK,EAAE,GAE9B0H,EAAQ,KAAK,eAAe,EAAE,KAAK,YAAY1H,MAAU,aAAaA,MAAU,SAAS,GACzF0H,EAAQ,KAAK,gBAAgB,EAAE,KAAK,YAAY1H,MAAU,SAAS,GACnE0H,EAAQ,KAAK,eAAe,EAAE,KAAK,YAAY1H,MAAU,SAAS;AAAA,IACpE;AAEA,UAAM6H,IAAc,KAAK,OAAO,aAAA,EAAe;AAC/C,IAAAhF,EAAK,KAAK,kBAAkB,EAAE,KAAK,GAAGtC,CAAY,IAAIsH,CAAW,UAAU;AAAA,EAC7E;AAAA,EAEA,MAAc,aAA4B;AAQxC,IAPW,IAAI,WAAW;AAAA,MACxB,MAAM;AAAA,MACN,SAAS;AAAA,MACT,UAAU,OAAOrD,MAAiB;AAChC,cAAM,KAAK,iBAAiBA,CAAI;AAAA,MAClC;AAAA,IAAA,CACD,EACE,OAAO,EAAI;AAAA,EAChB;AAAA,EAEA,MAAM,iBAAiBA,GAAc1G,IAAoB,SAAwB;AX/SnF,QAAAL,GAAAgH;AWgTI,UAAMtE,IAAUjB,EAAA;AAEhB,QAAI;AACF,YAAM,KAAK,OAAO,YAAY;AAAA,QAC5B,IAAIiB;AAAA,QACJ,KAAKqE;AAAA,QACL,OAAA1G;AAAA,QACA,QAAQ;AAAA,QACR,MAAM;AAAA,MAAA,CACP,GAED,KAAK,OAAA,IACLL,IAAA,GAAG,kBAAH,QAAAA,EAAkB,KAAK,UAAU,KAAK,gBAAgB+G,CAAI,CAAC;AAAA,IAE7D,SAASjG,GAAO;AACd,MAAAjB,EAAO,MAAM,wBAAwBiB,CAAK;AAC1C,YAAMmG,IAAenG,aAAiB,QAAQA,EAAM,UAAU;AAC9D,OAAAkG,IAAA,GAAG,kBAAH,QAAAA,EAAkB,MAAM,mBAAmBC,CAAY;AAAA,IACzD;AAAA,EACF;AAAA,EAEA,MAAc,YAAYvE,GAAgC;AACxD,UAAME,IAAS,KAAK,OAAO,SAASF,CAAO;AAC3C,QAAI,CAACE,EAAQ;AAEb,UAAM/B,IAAS+B,EAAO,UAAU,WAAWA,EAAO,mBAAmB;AACrE,UAAM,KAAK,OAAO,UAAUF,GAAS7B,CAAM,GAC3C,KAAK,OAAO,mBAAmB6B,GAAS7B,CAAM;AAAA,EAChD;AAAA,EAEQ,aAAa6B,GAAuB;AAC1C,UAAME,IAAS,KAAK,OAAO,SAASF,CAAO;AAC3C,QAAI,CAACE,EAAQ;AAEb,UAAMqC,IAAWrC,EAAO,eAAA;AACxB,SAAK,OAAO,WAAWF,CAAO,GAC9B,KAAK,OAAO,oBAAoBA,GAASuC,CAAQ;AAAA,EACnD;AAAA,EAEQ,YAAYvC,GAAuB;AACzC,SAAK,OAAO,UAAUA,CAAO,GAC7B,KAAK,OAAO,mBAAmBA,CAAO;AAAA,EACxC;AAAA,EAEQ,cAAcA,GAAuB;AAC3C,SAAK,OAAO,YAAYA,CAAO,GAC/B,KAAK,OAAA;AAAA,EACP;AAAA,EAES,MAAMyC,GAAmD;AAChE,gBAAK,YAAA,GACE,MAAM,MAAMA,CAAO;AAAA,EAC5B;AACF;AC9VA,MAAM/C,IAAY;AAOX,MAAMiI,WAA+B,YAAY;AAAA,EAcpD,YAAYnG,GAAqBuF,GAAuBa,GAAgCnF,GAAuC;AAC3H,UAAMA,CAAO;AAdT,IAAA7E,EAAA;AACA,IAAAA,EAAA;AACA,IAAAA,EAAA;AAGA;AAAA,IAAAA,EAAA;AACA,IAAAA,EAAA;AAEA;AAAA,IAAAA,EAAA,eAAkB;AAAA,MACtB,WAAW;AAAA;AAAA,MACX,aAAa;AAAA,IAAA;AAKb,SAAK,SAAS4D,GACd,KAAK,SAASuF,GACd,KAAK,iBAAiBa,GAItB,KAAK,aAAa,IAAI/E,EAAgB,KAAK,cAAc,GACzD,KAAK,WAAW,IAAIiE,GAAc,KAAK,QAAQ,KAAK,MAAM;AAAA,EAC9D;AAAA,EAEA,WAAoB,iBAAqC;AACrD,WAAO,QAAQ,MAAM,YAAY,MAAM,gBAAgB;AAAA,MACnD,IAAI;AAAA,MACJ,OAAO;AAAA,MACP,UAAU,WAAWpH,CAAS;AAAA,MAC9B,OAAO;AAAA;AAAA,MACP,QAAQ;AAAA,MACR,SAAS,CAAC,mBAAmB;AAAA,MAC7B,WAAW;AAAA,MACX,QAAQ;AAAA,MACR,MAAM,CAAA;AAAA;AAAA,IAAC,CACV;AAAA,EACL;AAAA,EAEA,MAAe,UAAwB;AACnC,UAAMoB,IAAU,KAAK,OAAO;AAI5B,QAAI+G,IAAa;AAEjB,QAAI,KAAK,MAAM,cAAc,WAAW;AAEpC,YAAMC,IAAU,MAAM,KAAK,WAAW,QAAA;AACtC,MAAAD,IAAa,MAAM,eAAe,uDAAuDC,CAAO;AAAA,IACpG,WAAW,KAAK,MAAM,cAAc,SAAS;AACzC,YAAMC,IAAY,MAAM,KAAK,SAAS,QAAA;AACtC,MAAAF,IAAa,MAAM,eAAe,WAAWnI,CAAS,wBAAwBqI,CAAS;AAAA,IAC3F;AAEA,WAAO;AAAA,MACH,WAAW,KAAK,MAAM;AAAA,MACtB,YAAAF;AAAA,MACA,SAAS;AAAA,QACL,QAAQ,KAAK,MAAM/G,EAAQ,SAAS,GAAG;AAAA,MAAA;AAAA,MAE3C,aAAa,KAAK,OAAO;AAAA,IAAA;AAAA,EAEjC;AAAA,EAES,kBAAkB4B,GAAoB;AAC3C,UAAM,kBAAkBA,CAAI,GAG5BA,EAAK,KAAK,cAAc,EAAE,GAAG,SAAS,KAAK,YAAY,KAAK,IAAI,CAAC,GAGjEA,EAAK,KAAK,6BAA6B,EAAE,GAAG,SAAS,KAAK,aAAa,KAAK,IAAI,CAAC,GACjFA,EAAK,KAAK,6BAA6B,EAAE,GAAG,SAAS,KAAK,aAAa,KAAK,IAAI,CAAC,GACjFA,EAAK,KAAK,8BAA8B,EAAE,GAAG,SAAS,KAAK,cAAc,KAAK,IAAI,CAAC,GACnFA,EAAK,KAAK,6BAA6B,EAAE,GAAG,SAAS,KAAK,aAAa,KAAK,IAAI,CAAC,GAGjFA,EAAK,KAAK,gBAAgB,EAAE,GAAG,SAAS,KAAK,oBAAoB,KAAK,IAAI,CAAC,GAGvE,KAAK,MAAM,cAAc,YACzB,KAAK,WAAW,kBAAkBA,CAAI,IAG/B,KAAK,MAAM,cAAc,WAChC,KAAK,SAAS,kBAAkBA,CAAI;AAAA,EAE5C;AAAA,EAEA,MAAc,YAAYC,GAAyC;AAC/D,IAAAA,EAAM,eAAA;AACN,UAAMqF,IAAU,EAAErF,EAAM,aAAa,EAAE,KAAK,KAAK;AACjD,IAAI,KAAK,MAAM,cAAcqF,MAE7B,KAAK,MAAM,YAAYA,GACvB,KAAK,OAAO,EAAI;AAAA,EACpB;AAAA;AAAA,EAGQ,aAAarF,GAAgC;AACjD,UAAMlB,IAAU,CAAC,KAAK,OAAO;AAC7B,SAAK,OAAO,eAAeA,CAAO,GAClC,KAAK,MAAM,cAAcA;AAGzB,UAAMwG,IAAM,EAAEtF,EAAM,aAAa;AACjC,IAAAsF,EAAI,YAAY,UAAUxG,CAAO,GACjCwG,EAAI,KAAK,YAAY,EAAE,KAAK,QAAQxG,IAAU,OAAO,KAAK,EAAE;AAAA,EAChE;AAAA,EAEQ,eAAqB;AAEzB,SAAK,OAAO,OAAA,GAMZtE,EAAO,MAAM,qBAAqB;AAAA,EACtC;AAAA,EAEQ,gBAAsB;AAG1B,IAAAA,EAAO,MAAM,sBAAsB;AAAA,EACvC;AAAA,EAEQ,eAAqB;AACzB,SAAK,OAAO,QAAA,GAEZ,KAAK,OAAA;AAAA,EACT;AAAA,EAEQ,oBAAoBwF,GAAoC;AAC5D,UAAMpE,IAAQ,WAAYoE,EAAM,OAA4B,KAAK,IAAI;AACrE,SAAK,OAAO,gBAAgBpE,CAAK,GACjC,KAAK,OAAO,uBAAuB,UAAUA,CAAK,GAClD,EAAEoE,EAAM,aAAa,EAAE,SAAS,aAAa,EAAE,KAAK,GAAG,KAAK,MAAMpE,IAAQ,GAAG,CAAC,GAAG;AAAA,EACrF;AACJ;ACtJO,MAAM2J,GAAgB;AAAA,EAI3B,YAAYC,GAA+B;AAHnC,IAAAvK,EAAA,uCAAuC,IAAA;AACvC,IAAAA,EAAA;AAGN,SAAK,mBAAmBuK;AAAA,EAC1B;AAAA;AAAA;AAAA;AAAA,EAKQ,eAAqB;AAC3B,IAAI,KAAK,oBACP,KAAK,iBAAA;AAAA,EAET;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,eAAezD,GAAciB,GAAgC;AAG3D,QADiB,KAAK,WAAWjB,CAAI;AAEnC,YAAM,IAAI,MAAM,uBAAuBA,CAAI,kBAAkB;AAG/D,UAAMrC,IAAM,KAAK,IAAA,GACXkB,IAAqB;AAAA,MACzB,IAAIxE,EAAA;AAAA,MACJ,MAAA2F;AAAA,MACA,aAAAiB;AAAA,MACA,OAAO,CAAA;AAAA,MACP,WAAWtD;AAAA,MACX,WAAWA;AAAA,MACX,UAAU;AAAA,IAAA;AAGZ,gBAAK,UAAU,IAAIkB,EAAS,IAAIA,CAAQ,GACxC,KAAK,aAAA,GACLpG,EAAO,KAAK,qBAAqBoG,EAAS,IAAI,KAAKA,EAAS,EAAE,GAAG,GAE1DA;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAKA,eAAe/F,GAAY4K,GAAiF;AAC1G,UAAM7E,IAAW,KAAK,UAAU,IAAI/F,CAAE;AACtC,QAAI,CAAC+F;AACH,YAAM,IAAI,MAAM,uBAAuB/F,CAAE,EAAE;AAI7C,QAAI4K,EAAQ,QAAQA,EAAQ,SAAS7E,EAAS,MAAM;AAClD,YAAM8E,IAAW,KAAK,WAAWD,EAAQ,IAAI;AAC7C,UAAIC,KAAYA,EAAS,OAAO7K;AAC9B,cAAM,IAAI,MAAM,uBAAuB4K,EAAQ,IAAI,kBAAkB;AAAA,IAEzE;AAGA,UAAME,IAAU;AAAA,MACd,GAAG/E;AAAA,MACH,GAAG6E;AAAA,MACH,WAAW,KAAK,IAAA;AAAA,IAAI;AAGtB,gBAAK,UAAU,IAAI5K,GAAI8K,CAAO,GAC9B,KAAK,aAAA,GACLnL,EAAO,KAAK,qBAAqBmL,EAAQ,IAAI,EAAE,GAExCA;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAKA,eAAe9K,GAAkB;AAC/B,UAAM+F,IAAW,KAAK,UAAU,IAAI/F,CAAE;AACtC,QAAI,CAAC+F;AACH,YAAM,IAAI,MAAM,uBAAuB/F,CAAE,EAAE;AAG7C,SAAK,UAAU,OAAOA,CAAE,GACxB,KAAK,aAAA,GACLL,EAAO,KAAK,qBAAqBoG,EAAS,IAAI,EAAE;AAAA,EAClD;AAAA;AAAA;AAAA;AAAA,EAKA,YAAY/F,GAAkC;AAC5C,WAAO,KAAK,UAAU,IAAIA,CAAE;AAAA,EAC9B;AAAA;AAAA;AAAA;AAAA,EAKA,kBAA8B;AAC5B,WAAO,MAAM,KAAK,KAAK,UAAU,QAAQ;AAAA,EAC3C;AAAA;AAAA;AAAA;AAAA,EAKA,WAAWkH,GAAoC;AAC7C,WAAO,MAAM,KAAK,KAAK,UAAU,OAAA,CAAQ,EAAE,KAAK,CAAAyB,MAAKA,EAAE,SAASzB,CAAI;AAAA,EACtE;AAAA;AAAA;AAAA;AAAA,EAKA,uBAAmC;AACjC,WAAO,KAAK,kBAAkB,OAAO,CAAAyB,MAAKA,EAAE,QAAQ;AAAA,EACtD;AAAA;AAAA;AAAA;AAAA,EAKA,uBAAuB3I,GAAqB;AAC1C,UAAM+F,IAAW,KAAK,YAAY/F,CAAE;AACpC,QAAI,CAAC+F;AACH,YAAM,IAAI,MAAM,uBAAuB/F,CAAE,EAAE;AAG7C,WAAA+F,EAAS,WAAW,CAACA,EAAS,UAC9BA,EAAS,YAAY,KAAK,IAAA,GAC1B,KAAK,aAAA,GAEEA,EAAS;AAAA,EAClB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,mBACEoB,GACA4D,GACA5K,GACA8E,GACc;AACd,UAAMc,IAAW,KAAK,YAAYoB,CAAU;AAC5C,QAAI,CAACpB;AACH,YAAM,IAAI,MAAM,uBAAuBoB,CAAU,EAAE;AAKrD,QADepB,EAAS,MAAM,KAAK,CAAAD,MAAQA,EAAK,kBAAkBiF,CAAa;AAE7E,YAAM,IAAI,MAAM,uCAAuC;AAIzD,UAAMjF,IAAqB;AAAA,MACzB,IAAIvE,EAAA;AAAA,MACJ,eAAAwJ;AAAA,MACA,OAAA5K;AAAA,MACA,SAAQ8E,KAAA,gBAAAA,EAAS,WAAU;AAAA,MAC3B,OAAMA,KAAA,gBAAAA,EAAS,SAAQ;AAAA,MACvB,OAAOc,EAAS,MAAM;AAAA,MACtB,QAAQd,KAAA,gBAAAA,EAAS;AAAA,MACjB,SAASA,KAAA,gBAAAA,EAAS;AAAA,IAAA;AAGpB,WAAAc,EAAS,MAAM,KAAKD,CAAI,GACxBC,EAAS,YAAY,KAAK,IAAA,GAC1B,KAAK,aAAA,GAELpG,EAAO,MAAM,2BAA2BoG,EAAS,IAAI,KAAKgF,CAAa,EAAE,GAElEjF;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAKA,wBAAwBqB,GAAoB6D,GAA8B;AACxE,UAAMjF,IAAW,KAAK,YAAYoB,CAAU;AAC5C,QAAI,CAACpB;AACH,YAAM,IAAI,MAAM,uBAAuBoB,CAAU,EAAE;AAGrD,UAAMkB,IAAQtC,EAAS,MAAM,UAAU,CAAAD,MAAQA,EAAK,OAAOkF,CAAc;AACzE,QAAI3C,MAAU;AACZ,YAAM,IAAI,MAAM,4BAA4B2C,CAAc,EAAE;AAG9D,IAAAjF,EAAS,MAAM,OAAOsC,GAAO,CAAC,GAG9B,KAAK,qBAAqBtC,CAAQ,GAElCA,EAAS,YAAY,KAAK,IAAA,GAC1B,KAAK,aAAA,GACLpG,EAAO,MAAM,+BAA+BoG,EAAS,IAAI,EAAE;AAAA,EAC7D;AAAA;AAAA;AAAA;AAAA,EAKA,8BAA8BoB,GAAoB4D,GAA+B;AAC/E,UAAMhF,IAAW,KAAK,YAAYoB,CAAU;AAC5C,QAAI,CAACpB;AACH,YAAM,IAAI,MAAM,uBAAuBoB,CAAU,EAAE;AAGrD,UAAM8D,IAAgBlF,EAAS,MAAM;AACrC,IAAAA,EAAS,QAAQA,EAAS,MAAM,OAAO,CAAAD,MAAQA,EAAK,kBAAkBiF,CAAa;AACnF,UAAMG,IAAUD,IAAgBlF,EAAS,MAAM;AAE/C,WAAImF,IAAU,MACZ,KAAK,qBAAqBnF,CAAQ,GAClCA,EAAS,YAAY,KAAK,IAAA,GAC1B,KAAK,aAAA,GACLpG,EAAO,MAAM,WAAWuL,CAAO,8BAA8BH,CAAa,kBAAkBhF,EAAS,IAAI,EAAE,IAGtGmF;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAKA,kCAAkCH,GAA+B;AAC/D,QAAII,IAAe;AAEnB,gBAAK,UAAU,QAAQ,CAAApF,MAAY;AACjC,YAAMkF,IAAgBlF,EAAS,MAAM;AACrC,MAAAA,EAAS,QAAQA,EAAS,MAAM,OAAO,CAAAD,MAAQA,EAAK,kBAAkBiF,CAAa;AACnF,YAAMG,IAAUD,IAAgBlF,EAAS,MAAM;AAE/C,MAAImF,IAAU,MACZ,KAAK,qBAAqBnF,CAAQ,GAClCA,EAAS,YAAY,KAAK,IAAA,GAC1BoF,KAAgBD;AAAA,IAEpB,CAAC,GAEGC,IAAe,MACjB,KAAK,aAAA,GACLxL,EAAO,KAAK,wBAAwBoL,CAAa,SAASI,CAAY,cAAc,IAG/EA;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAKA,mBACEhE,GACA6D,GACAJ,GACc;AACd,UAAM7E,IAAW,KAAK,YAAYoB,CAAU;AAC5C,QAAI,CAACpB;AACH,YAAM,IAAI,MAAM,uBAAuBoB,CAAU,EAAE;AAGrD,UAAMrB,IAAOC,EAAS,MAAM,KAAK,CAAAU,MAAKA,EAAE,OAAOuE,CAAc;AAC7D,QAAI,CAAClF;AACH,YAAM,IAAI,MAAM,4BAA4BkF,CAAc,EAAE;AAI9D,kBAAO,OAAOlF,GAAM8E,CAAO,GAC3B7E,EAAS,YAAY,KAAK,IAAA,GAC1B,KAAK,aAAA,GAELpG,EAAO,MAAM,4BAA4BoG,EAAS,IAAI,EAAE,GAEjDD;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAKA,aAAaqB,GAAoB6D,GAAwBI,GAAwB;AAC/E,UAAMrF,IAAW,KAAK,YAAYoB,CAAU;AAC5C,QAAI,CAACpB;AACH,YAAM,IAAI,MAAM,uBAAuBoB,CAAU,EAAE;AAGrD,UAAMkE,IAAYtF,EAAS,MAAM,UAAU,CAAAU,MAAKA,EAAE,OAAOuE,CAAc;AACvE,QAAIK,MAAc;AAChB,YAAM,IAAI,MAAM,4BAA4BL,CAAc,EAAE;AAI9D,QAAII,IAAW,KAAKA,KAAYrF,EAAS,MAAM;AAC7C,YAAM,IAAI,MAAM,kBAAkBqF,CAAQ,EAAE;AAI9C,UAAM,CAACtF,CAAI,IAAIC,EAAS,MAAM,OAAOsF,GAAW,CAAC;AAGjD,IAAAtF,EAAS,MAAM,OAAOqF,GAAU,GAAGtF,CAAI,GAGvC,KAAK,qBAAqBC,CAAQ,GAElCA,EAAS,YAAY,KAAK,IAAA,GAC1B,KAAK,aAAA,GACLpG,EAAO,MAAM,+BAA+BoG,EAAS,IAAI,EAAE;AAAA,EAC7D;AAAA;AAAA;AAAA;AAAA,EAKA,kBAAkBoB,GAAoC;AACpD,UAAMpB,IAAW,KAAK,YAAYoB,CAAU;AAC5C,QAAI,CAACpB;AACH,YAAM,IAAI,MAAM,uBAAuBoB,CAAU,EAAE;AAGrD,WAAO,CAAC,GAAGpB,EAAS,KAAK,EAAE,KAAK,CAACY,GAAGC,MAAMD,EAAE,QAAQC,EAAE,KAAK;AAAA,EAC7D;AAAA;AAAA;AAAA;AAAA,EAKA,2BAA2BmE,GAAmC;AAC5D,WAAO,KAAK,kBAAkB;AAAA,MAAO,OACnChF,EAAS,MAAM,KAAK,CAAAD,MAAQA,EAAK,kBAAkBiF,CAAa;AAAA,IAAA;AAAA,EAEpE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,KAAKO,GAA+C;AAClD,SAAK,UAAU,MAAA,GAEf,OAAO,OAAOA,CAAa,EAAE,QAAQ,CAAAvF,MAAY;AAE/C,MAAAA,EAAS,MAAM,KAAK,CAACY,GAAGC,MAAMD,EAAE,QAAQC,EAAE,KAAK,GAC/C,KAAK,UAAU,IAAIb,EAAS,IAAIA,CAAQ;AAAA,IAC1C,CAAC,GAEDpG,EAAO,KAAK,2BAA2B,KAAK,UAAU,IAAI,YAAY;AAAA,EACxE;AAAA;AAAA;AAAA;AAAA,EAKA,SAAmC;AACjC,WAAO,OAAO,YAAY,KAAK,SAAS;AAAA,EAC1C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASQ,qBAAqBoG,GAA0B;AACrD,IAAAA,EAAS,MAAM,QAAQ,CAACD,GAAMuC,MAAU;AACtC,MAAAvC,EAAK,QAAQuC;AAAA,IACf,CAAC;AAAA,EACH;AAAA;AAAA;AAAA;AAAA,EAKA,WAAW;AACT,UAAM7C,IAAY,KAAK,gBAAA;AACvB,WAAO;AAAA,MACL,gBAAgBA,EAAU;AAAA,MAC1B,mBAAmBA,EAAU,OAAO,CAAAmD,MAAKA,EAAE,QAAQ,EAAE;AAAA,MACrD,aAAanD,EAAU,OAAO,CAAC+F,GAAK5C,MAAM4C,IAAM5C,EAAE,MAAM,QAAQ,CAAC;AAAA,MACjE,0BAA0BnD,EAAU,SAAS,IACzC,KAAK,MAAMA,EAAU,OAAO,CAAC+F,GAAK5C,MAAM4C,IAAM5C,EAAE,MAAM,QAAQ,CAAC,IAAInD,EAAU,MAAM,IACnF;AAAA,IAAA;AAAA,EAER;AAAA;AAAA;AAAA;AAAA,EAKA,QAAc;AACZ,SAAK,UAAU,MAAA,GACf7F,EAAO,KAAK,uBAAuB;AAAA,EACrC;AACF;AC5YA,MAAMuC,IAAY,yBACZsJ,IAAkB;AAEjB,MAAMC,GAAe;AAAA,EAS1B,cAAc;AARN,IAAArL,EAAA,mCAAsC,IAAA;AACtC,IAAAA,EAAA,uBAAgB;AACR,IAAAA,EAAA;AAER,IAAAA,EAAA,uBAAgBiJ,EAAS,MAAM;AACrC,WAAK,eAAA;AAAA,IACP,GAAG,GAAG;AAGJ,SAAK,YAAY,IAAIqB,GAAgB,MAAM,KAAK,cAAc,GAC9D,KAAK,iBAAA;AAAA,EACP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,MAAM,QAAQpK,GAAa4G,GAAe/G,IAAoB,SAA+B;AAE3F,UAAMsC,IAAaT,EAAkB1B,CAAG;AACxC,QAAI,CAACmC,EAAW;AACd,YAAM,IAAI,MAAMA,EAAW,SAAS,oBAAoB;AAI1D,UAAMiJ,IAAWxE,KAAQ,KAAK,mBAAmB5G,CAAG,GAG9CqL,IAAgB,KAAK,UAAUrL,CAAG;AACxC,QAAIqL;AACF,YAAM,IAAI,MAAM,uCAAuCA,EAAc,IAAI,EAAE;AAK7E,QADuB,KAAK,WAAWD,CAAQ;AAE7C,YAAM,IAAI,MAAM,oBAAoBA,CAAQ,6BAA6B;AAG3E,UAAM7G,IAAM,KAAK,IAAA,GACXiB,IAAoB;AAAA,MACxB,IAAIvE,EAAA;AAAA,MACJ,KAAAjB;AAAA,MACA,MAAMoL;AAAA,MACN,MAAM,CAAA;AAAA,MACN,UAAU;AAAA,MACV,UAAU;AAAA,MACV,SAAS7G;AAAA,MACT,WAAWA;AAAA,IAAA;AAGb,gBAAK,MAAM,IAAIiB,EAAK,IAAIA,CAAI,GAC5B,KAAK,aAAA,GAELnG,EAAO,KAAK,uBAAuBmG,EAAK,IAAI,KAAKA,EAAK,EAAE,GAAG,GACpDA;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAKA,WAAW9F,GAAY4K,GAA4C;AACjE,UAAM9E,IAAO,KAAK,MAAM,IAAI9F,CAAE;AAC9B,QAAI,CAAC8F;AACH,YAAM,IAAI,MAAM,2BAA2B9F,CAAE,EAAE;AAIjD,QAAI4K,EAAQ,QAAQA,EAAQ,SAAS9E,EAAK,MAAM;AAC9C,YAAM8F,IAAiB,KAAK,WAAWhB,EAAQ,IAAI;AACnD,UAAIgB,KAAkBA,EAAe,OAAO5L;AAC1C,cAAM,IAAI,MAAM,oBAAoB4K,EAAQ,IAAI,kBAAkB;AAAA,IAEtE;AAGA,QAAIA,EAAQ,OAAOA,EAAQ,QAAQ9E,EAAK,KAAK;AAC3C,YAAMrD,IAAaT,EAAkB4I,EAAQ,GAAG;AAChD,UAAI,CAACnI,EAAW;AACd,cAAM,IAAI,MAAMA,EAAW,SAAS,oBAAoB;AAG1D,YAAMkJ,IAAgB,KAAK,UAAUf,EAAQ,GAAG;AAChD,UAAIe,KAAiBA,EAAc,OAAO3L;AACxC,cAAM,IAAI,MAAM,uCAAuC2L,EAAc,IAAI,EAAE;AAAA,IAE/E;AAGA,WAAOf,EAAQ;AAGf,UAAME,IAAU;AAAA,MACd,GAAGhF;AAAA,MACH,GAAG8E;AAAA,MACH,WAAW,KAAK,IAAA;AAAA,IAAI;AAGtB,gBAAK,MAAM,IAAI5K,GAAI8K,CAAO,GAC1B,KAAK,aAAA,GAELnL,EAAO,KAAK,yBAAyBmL,EAAQ,IAAI,EAAE,GAC5CA;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAKA,WAAW9K,GAAkB;AAC3B,UAAM8F,IAAO,KAAK,MAAM,IAAI9F,CAAE;AAC9B,QAAI,CAAC8F;AACH,YAAM,IAAI,MAAM,2BAA2B9F,CAAE,EAAE;AAIjD,SAAK,UAAU,kCAAkCA,CAAE,GAEnD,KAAK,MAAM,OAAOA,CAAE,GACpB,KAAK,aAAA,GAELL,EAAO,KAAK,yBAAyBmG,EAAK,IAAI,EAAE;AAAA,EAClD;AAAA;AAAA;AAAA;AAAA,EAKA,QAAQ9F,GAAqC;AAC3C,WAAO,KAAK,MAAM,IAAIA,CAAE;AAAA,EAC1B;AAAA;AAAA;AAAA;AAAA,EAKA,cAA6B;AAC3B,WAAO,MAAM,KAAK,KAAK,MAAM,QAAQ;AAAA,EACvC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,UAAUM,GAAsC;AAC9C,WAAO,MAAM,KAAK,KAAK,MAAM,OAAA,CAAQ,EAAE,KAAK,CAAAwF,MAAQA,EAAK,QAAQxF,CAAG;AAAA,EACtE;AAAA;AAAA;AAAA;AAAA,EAKA,WAAW4G,GAAuC;AAChD,WAAO,MAAM,KAAK,KAAK,MAAM,OAAA,CAAQ,EAAE,KAAK,CAAApB,MAAQA,EAAK,SAASoB,CAAI;AAAA,EACxE;AAAA;AAAA;AAAA;AAAA,EAKA,aAAaX,GAA8B;AACzC,UAAMsF,IAAatF,EAAM,YAAA;AACzB,WAAO,KAAK,cAAc;AAAA,MAAO,OAC/BT,EAAK,KAAK,YAAA,EAAc,SAAS+F,CAAU;AAAA,IAAA;AAAA,EAE/C;AAAA;AAAA;AAAA;AAAA,EAKA,aAAa7F,GAA+B;AAC1C,WAAIA,EAAK,WAAW,IAAU,KAAK,YAAA,IAE5B,KAAK,cAAc;AAAA,MAAO,CAAAF,MAC/BA,EAAK,KAAK,KAAK,OAAOE,EAAK,SAASC,CAAG,CAAC;AAAA,IAAA;AAAA,EAE5C;AAAA;AAAA;AAAA;AAAA,EAKA,eAA8B;AAC5B,WAAO,KAAK,cAAc,OAAO,CAAAH,MAAQA,EAAK,QAAQ;AAAA,EACxD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,aAAuB;AACrB,UAAMgG,wBAAa,IAAA;AACnB,gBAAK,MAAM,QAAQ,CAAAhG,MAAQ;AACzB,MAAAA,EAAK,KAAK,QAAQ,CAAAG,MAAO6F,EAAO,IAAI7F,CAAG,CAAC;AAAA,IAC1C,CAAC,GACM,MAAM,KAAK6F,CAAM,EAAE,KAAA;AAAA,EAC5B;AAAA;AAAA;AAAA;AAAA,EAKA,aAAa9E,GAAgBf,GAAmB;AAC9C,UAAMH,IAAO,KAAK,QAAQkB,CAAM;AAChC,QAAI,CAAClB;AACH,YAAM,IAAI,MAAM,2BAA2BkB,CAAM,EAAE;AAGrD,IAAKlB,EAAK,KAAK,SAASG,CAAG,MACzBH,EAAK,KAAK,KAAKG,CAAG,GAClBH,EAAK,YAAY,KAAK,IAAA,GACtB,KAAK,aAAA;AAAA,EAET;AAAA;AAAA;AAAA;AAAA,EAKA,kBAAkBkB,GAAgBf,GAAmB;AACnD,UAAMH,IAAO,KAAK,QAAQkB,CAAM;AAChC,QAAI,CAAClB;AACH,YAAM,IAAI,MAAM,2BAA2BkB,CAAM,EAAE;AAGrD,UAAMqB,IAAQvC,EAAK,KAAK,QAAQG,CAAG;AACnC,IAAIoC,MAAU,OACZvC,EAAK,KAAK,OAAOuC,GAAO,CAAC,GACzBvC,EAAK,YAAY,KAAK,IAAA,GACtB,KAAK,aAAA;AAAA,EAET;AAAA;AAAA;AAAA;AAAA,EAKA,UAAUiG,GAAgBC,GAAwB;AAChD,QAAIC,IAAQ;AACZ,gBAAK,MAAM,QAAQ,CAAAnG,MAAQ;AACzB,YAAMuC,IAAQvC,EAAK,KAAK,QAAQiG,CAAM;AACtC,MAAI1D,MAAU,OACZvC,EAAK,KAAKuC,CAAK,IAAI2D,GACnBlG,EAAK,YAAY,KAAK,IAAA,GACtBmG;AAAA,IAEJ,CAAC,GAEGA,IAAQ,MACV,KAAK,aAAA,GACLtM,EAAO,KAAK,iBAAiBoM,CAAM,QAAQC,CAAM,MAAMC,CAAK,SAAS,IAGhEA;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAKA,UAAUhG,GAAqB;AAC7B,QAAIgG,IAAQ;AACZ,gBAAK,MAAM,QAAQ,CAAAnG,MAAQ;AACzB,YAAMuC,IAAQvC,EAAK,KAAK,QAAQG,CAAG;AACnC,MAAIoC,MAAU,OACZvC,EAAK,KAAK,OAAOuC,GAAO,CAAC,GACzBvC,EAAK,YAAY,KAAK,IAAA,GACtBmG;AAAA,IAEJ,CAAC,GAEGA,IAAQ,MACV,KAAK,aAAA,GACLtM,EAAO,KAAK,iBAAiBsG,CAAG,MAAMgG,CAAK,SAAS,IAG/CA;AAAA,EACT;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,eAAejF,GAAyB;AACtC,UAAMlB,IAAO,KAAK,QAAQkB,CAAM;AAChC,QAAI,CAAClB;AACH,YAAM,IAAI,MAAM,2BAA2BkB,CAAM,EAAE;AAGrD,WAAAlB,EAAK,WAAW,CAACA,EAAK,UACtBA,EAAK,YAAY,KAAK,IAAA,GACtB,KAAK,aAAA,GAEEA,EAAK;AAAA,EACd;AAAA;AAAA;AAAA;AAAA,EAMQ,mBAAyB;AAC/B,QAAI;AACF,YAAMV,IAAQ,KAAK,SAAS,IAAIlD,GAAW,cAAc;AACzD,UAAI,CAACkD,GAAO;AACV,QAAAzF,EAAO,KAAK,wCAAwC;AACpD;AAAA,MACF;AAEA,YAAM0C,IAAsB,KAAK,MAAM+C,CAAK;AAG5C,MAAI/C,EAAM,YAAYmJ,KACpB7L,EAAO,KAAK,6BAA6B0C,EAAM,OAAO,MAAMmJ,CAAe,EAAE,GAK/E,KAAK,MAAM,MAAA,GACX,OAAO,OAAOnJ,EAAM,KAAK,EAAE,QAAQ,CAAAyD,MAAQ;AACzC,aAAK,MAAM,IAAIA,EAAK,IAAIA,CAAI;AAAA,MAC9B,CAAC,GAGD,KAAK,UAAU,KAAKzD,EAAM,aAAa,CAAA,CAAE,GAEzC1C,EAAO,KAAK,mBAAmB,KAAK,MAAM,IAAI,WAAW,KAAK,UAAU,gBAAA,EAAkB,MAAM,YAAY;AAAA,IAC9G,SAASiB,GAAO;AACd,MAAAjB,EAAO,MAAM,iCAAiCiB,CAAK;AAAA,IACrD;AAAA,EACF;AAAA,EAEQ,iBAAuB;AAC7B,QAAI;AACF,YAAMyB,IAAsB;AAAA,QAC1B,OAAO,OAAO,YAAY,KAAK,KAAK;AAAA,QACpC,WAAW,KAAK,UAAU,OAAA;AAAA,QAC1B,SAASmJ;AAAA,QACT,cAAc,KAAK,IAAA;AAAA,MAAI;AAGzB,WAAK,SAAS,IAAItJ,GAAW,gBAAgB,KAAK,UAAUG,CAAK,CAAC,GAClE,KAAK,gBAAgB,IAErB1C,EAAO,MAAM,kBAAkB,KAAK,MAAM,IAAI,WAAW,KAAK,UAAU,gBAAA,EAAkB,MAAM,YAAY;AAAA,IAC9G,SAASiB,GAAO;AACd,MAAAjB,EAAO,MAAM,iCAAiCiB,CAAK;AAAA,IACrD;AAAA,EACF;AAAA,EAEQ,eAAqB;AAC3B,SAAK,cAAA;AAAA,EACP;AAAA;AAAA;AAAA;AAAA,EAMQ,mBAAmBN,GAAqB;AAC9C,QAAI;AAEF,YAAMoJ,IADU,mBAAmBpJ,CAAG,EAChB,MAAM,GAAG;AAE/B,aADiBoJ,EAAMA,EAAM,SAAS,CAAC,EACvB,QAAQ,YAAY,EAAE;AAAA,IACxC,QAAQ;AACN,aAAO;AAAA,IACT;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,WAAW;AACT,UAAMnE,IAAQ,KAAK,YAAA,GACb2G,IAAgB,KAAK,UAAU,SAAA;AAErC,WAAO;AAAA,MACL,YAAY3G,EAAM;AAAA,MAClB,eAAeA,EAAM,OAAO,CAAAkB,MAAKA,EAAE,QAAQ,EAAE;AAAA,MAC7C,eAAelB,EAAM,OAAO,CAACgG,GAAK,MAAMA,IAAM,EAAE,UAAU,CAAC;AAAA,MAC3D,UAAU,KAAK,WAAA,EAAa;AAAA,MAC5B,WAAWW,EAAc;AAAA,IAAA;AAAA,EAE7B;AAAA;AAAA;AAAA;AAAA,EAKA,QAAc;AACZ,SAAK,MAAM,MAAA,GACX,KAAK,UAAU,MAAA,GACf,KAAK,aAAA,GACLvM,EAAO,KAAK,iBAAiB;AAAA,EAC/B;AAAA;AAAA;AAAA;AAAA,EAKA,UAAgB;AAEd,IAAI,KAAK,iBACP,KAAK,eAAA;AAAA,EAET;AACF;ACtZA,MAAMuC,IAAY;AAIlB,IAAIiK,IAA+B,MAC/BC,IAAyC,MACzChC,IAAwC,MAGxCiC,IAAyC,MACzCC,IAAwC,MAGxCC,IAAsC;AAmB1C,MAAM,GAAG,0BAA0B,CAACC,MAAkC;Af3CtE,MAAA1M;Ae4CE,UAAQ,IAAI,mBAAmB0M,CAAQ;AAEvC,QAAMC,MAAO3M,IAAA,KAAK,SAAL,gBAAAA,EAAW,SAAQ,IAE1B4M,IAA6B;AAAA,IACjC,cAAc;AAAA,MACZ,MAAM;AAAA,MACN,OAAOD,IAAO,gBAAgB;AAAA,MAC9B,MAAMA,IAAO,qBAAqB;AAAA,MAClC,QAAQ;AAAA,MACR,SAAS,MAAA;AftDf,YAAA3M;AesDqB,gBAAAA,IAAA,OAAO,QAAP,gBAAAA,EAAY;AAAA;AAAA,IAAU;AAAA,EACvC;AAIF,EAAI2M,MACFC,EAAM,cAAc,IAAI;AAAA,IACtB,MAAM;AAAA,IACN,OAAO;AAAA,IACP,MAAM;AAAA,IACN,QAAQ;AAAA,IACR,SAAS,MAAA;AfjEf,UAAA5M;AeiEqB,cAAAA,IAAA,OAAO,QAAP,gBAAAA,EAAY,UAAU;AAAA;AAAA,EAAS,IAIlD0M,EAAS,uBAAuB,IAAI;AAAA,IAClC,MAAM;AAAA,IACN,OAAOC,IAAO,0BAA0B;AAAA,IACxC,MAAMA,IAAO,qBAAqB;AAAA,IAClC,SAAS;AAAA,IACT,OAAAC;AAAA,EAAA;AAEJ,CAAC;AASD,SAASC,KAAkC;AAEzC,aAAW,eAAe,kBAAkB,CAACvL,MAA4B;AACvE,QAAI,CAACA,KAAWA,KAAW,EAAG,QAAO;AAErC,UAAMwL,IAAU,KAAK,MAAMxL,IAAU,EAAE,GACjCE,IAAO,KAAK,MAAMF,IAAU,EAAE;AACpC,WAAO,GAAGwL,CAAO,IAAItL,EAAK,WAAW,SAAS,GAAG,GAAG,CAAC;AAAA,EACvD,CAAC,GAGD,WAAW,eAAe,MAAM,CAACqF,GAAQC,MAChCD,MAAMC,CACd;AACH;AAMA,MAAM,KAAK,QAAQ,MAAM;AACvB,EAAAjH,EAAO,KAAK,uCAAuC,GACnDkN,GAAA,GACAF,GAAA;AACF,CAAC;AAED,MAAM,KAAK,SAAS,YAAY;Af/GhC,MAAA7M;AegHE,QAAM2M,MAAO3M,IAAA,KAAK,SAAL,gBAAAA,EAAW,SAAQ;AAChC,EAAAH,EAAO,KAAK,mCAAmC8M,IAAO,OAAO,QAAQ,MAAM,GAE3EF,IAAgB,IAAIxI,EAAA,GAEhB0I,IACF,MAAMK,GAAA,IAEN,MAAMC,GAAA,GAGR,OAAO,MAAM;AAAA,IACX,MAAAN;AAAA,IACA,MAAAA;AAAA,IACA,WAAWA,IAAOO,IAAcC;AAAA,IAChC,aAAa,MAAMR,KAAQO,EAAY,SAAS;AAAA,IAChD,QAAQP,IAAON,KAAY,SAAYE,KAAgB;AAAA,IACvD,QAAQE,KAAiB;AAAA,IACzB,SAASE,IAAOrC,KAAkB,SAAY;AAAA,EAAA,GAGhD8C,GAAA,GAEAvN,EAAO,KAAK,6BAA6B;AAC3C,CAAC;AAED,eAAemN,KAA8B;AAC3C,EAAA1C,IAAiB,IAAIqB,GAAA,GACrBU,IAAW,IAAI/J,EAAA,GACfmK,EAAe,eAAeJ,CAAQ,GAEtC,MAAMA,EAAS,eAAA;AACjB;AAEA,eAAeY,KAAkC;AAC/C,EAAAV,IAAe,IAAIjJ,EAAA,GACnBmJ,EAAe,mBAAmBF,CAAY;AAG9C,QAAMc,IAAcnI,EAAkB,gBAAA;AACtC,EAAAqH,EAAa,eAAec,CAAW;AACzC;AAMA,SAASH,EAAYI,IAA2B,SAAe;AAC7D,EAAI,CAACjB,KAAY,CAACI,KAAiB,CAACnC,MAEhCgC,KAAWA,EAAQ,WACrBA,EAAQ,WAAA,KAIRA,IAAU,IAAIjC,GAAuBgC,GAAUI,GAAenC,CAAc,GAC5EgC,EAAQ,OAAO,EAAI;AAEvB;AAEA,SAASa,KAAwB;AAC/B,EAAKZ,MAEDC,KAAeA,EAAY,WAC7BA,EAAY,WAAA,KAEZA,IAAc,IAAItH,EAAkBqH,CAAY,GAChDC,EAAY,OAAO,EAAI;AAE3B;AAaA,SAASY,KAA6B;AACpC,QAAMG,IAAc,MAAM;AACxB,IAAAlB,KAAA,QAAAA,EAAU,UACVE,KAAA,QAAAA,EAAc;AAAA,EAChB;AAEA,WAAS,iBAAiB,SAASgB,GAAa,EAAE,MAAM,IAAM,GAC9D,SAAS,iBAAiB,WAAWA,GAAa,EAAE,MAAM,IAAM,GAEhE,MAAM,KAAK,eAAeA,CAAW;AACvC;AAMA,SAASR,KAAyB;AAChC,OAAK,SAAS,SAAS3K,GAAW,cAAc;AAAA,IAC9C,MAAM;AAAA,IACN,MAAM;AAAA,IACN,OAAO;AAAA,IACP,QAAQ;AAAA,IACR,MAAM;AAAA,IACN,SAAS;AAAA,EAAA,CACV,GAED,KAAK,SAAS,SAASA,GAAW,yBAAyB;AAAA,IACzD,MAAM;AAAA,IACN,MAAM;AAAA,IACN,OAAO;AAAA,IACP,QAAQ;AAAA,IACR,MAAM;AAAA,IACN,SAAS;AAAA,IACT,OAAO;AAAA,MACL,KAAK;AAAA,MACL,KAAK;AAAA,MACL,MAAM;AAAA,IAAA;AAAA,EACR,CACD,GAED,KAAK,SAAS,SAASA,GAAW,gBAAgB;AAAA,IAChD,MAAM;AAAA,IACN,MAAM;AAAA,IACN,OAAO;AAAA,IACP,QAAQ;AAAA,IACR,MAAM;AAAA,IACN,SAAS;AAAA,EAAA,CACV;AACH;AAMA,MAAM,KAAK,aAAa,MAAM;AAC5B,EAAAkK,KAAA,QAAAA,EAAS,SACTE,KAAA,QAAAA,EAAa,SACbC,KAAA,QAAAA,EAAe,WACfJ,KAAA,QAAAA,EAAU,WACVE,KAAA,QAAAA,EAAc,WACdjC,KAAA,QAAAA,EAAgB;AAClB,CAAC;"}